{% extends "base.html" %}

{% block title %}Material de Apoio PNSB{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header da p√°gina -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="page-header">
                <h1 class="h3 mb-3">
                    <i class="fas fa-book-open text-primary me-2"></i>
                    Material de Apoio PNSB
                </h1>
                <p class="text-muted">Central de conhecimento e recursos para a Pesquisa Nacional de Saneamento B√°sico 2024</p>
            </div>
        </div>
    </div>

    <!-- Cards de navega√ß√£o principal -->
    <div class="row mb-4">
        <div class="col-lg-6 col-md-6 mb-3">
            <div class="card h-100 border-0 shadow-sm hover-card" onclick="openChatIA()">
                <div class="card-body text-center py-4">
                    <div class="feature-icon bg-primary bg-gradient mb-3">
                        <i class="fas fa-robot text-white fa-2x"></i>
                    </div>
                    <h5 class="card-title text-primary">Chat IA PNSB</h5>
                    <p class="card-text text-muted">Assistente inteligente especializado em PNSB com acesso ao manual oficial e materiais t√©cnicos</p>
                    <span class="badge bg-success">Alta Prioridade</span>
                </div>
            </div>
        </div>
        <div class="col-lg-6 col-md-6 mb-3">
            <div class="card h-100 border-0 shadow-sm hover-card" onclick="openBiblioteca()">
                <div class="card-body text-center py-4">
                    <div class="feature-icon bg-info bg-gradient mb-3">
                        <i class="fas fa-library text-white fa-2x"></i>
                    </div>
                    <h5 class="card-title text-info">Biblioteca Digital</h5>
                    <p class="card-text text-muted">Acesso aos documentos oficiais, manuais, question√°rios e legisla√ß√£o do PNSB</p>
                    <span class="badge bg-success">Alta Prioridade</span>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-lg-6 col-md-6 mb-3">
            <div class="card h-100 border-0 shadow-sm hover-card" onclick="openBusca()">
                <div class="card-body text-center py-4">
                    <div class="feature-icon bg-warning bg-gradient mb-3">
                        <i class="fas fa-search text-white fa-2x"></i>
                    </div>
                    <h5 class="card-title text-warning">Busca Inteligente</h5>
                    <p class="card-text text-muted">Pesquisa unificada em todos os materiais com filtros avan√ßados e tags tem√°ticas</p>
                    <span class="badge bg-warning">M√©dia Prioridade</span>
                </div>
            </div>
        </div>
        <div class="col-lg-6 col-md-6 mb-3">
            <div class="card h-100 border-0 shadow-sm hover-card" onclick="openRecursos()">
                <div class="card-body text-center py-4">
                    <div class="feature-icon bg-success bg-gradient mb-3">
                        <i class="fas fa-tools text-white fa-2x"></i>
                    </div>
                    <h5 class="card-title text-success">Recursos Pr√°ticos</h5>
                    <p class="card-text text-muted">Calculadoras, tabelas de refer√™ncia, modelos de documentos e gloss√°rio PNSB</p>
                    <span class="badge bg-warning">M√©dia Prioridade</span>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-lg-6 col-md-6 mb-3">
            <div class="card h-100 border-0 shadow-sm hover-card" onclick="openTreinamento()">
                <div class="card-body text-center py-4">
                    <div class="feature-icon bg-secondary bg-gradient mb-3">
                        <i class="fas fa-graduation-cap text-white fa-2x"></i>
                    </div>
                    <h5 class="card-title text-secondary">Centro de Treinamento</h5>
                    <p class="card-text text-muted">Tutoriais, v√≠deos explicativos, simuladores e checklists de prepara√ß√£o</p>
                    <span class="badge bg-secondary">Baixa Prioridade</span>
                </div>
            </div>
        </div>
        <div class="col-lg-6 col-md-6 mb-3">
            <div class="card h-100 border-0 shadow-sm hover-card" onclick="openComunidade()">
                <div class="card-body text-center py-4">
                    <div class="feature-icon bg-purple bg-gradient mb-3">
                        <i class="fas fa-users text-white fa-2x"></i>
                    </div>
                    <h5 class="card-title text-purple">Comunidade</h5>
                    <p class="card-text text-muted">F√≥rum de d√∫vidas, casos de sucesso e base de conhecimento colaborativa</p>
                    <span class="badge bg-secondary">Baixa Prioridade</span>
                </div>
            </div>
        </div>
    </div>

    <!-- √Årea de conte√∫do din√¢mico -->
    <div class="row">
        <div class="col-12">
            <div id="content-area" class="card border-0 shadow-sm" style="display: none;">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0" id="content-title">Carregando...</h5>
                        <button type="button" class="btn-close" onclick="closeContent()"></button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="content-body">
                        <!-- Conte√∫do ser√° carregado aqui -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal do Chat IA -->
<div class="modal fade" id="chatModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-robot me-2"></i>
                    Chat IA PNSB Especializado
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Chat ser√° implementado aqui -->
                <div id="chat-area">
                    <div class="chat-container">
                        <div class="chat-header">
                            <div class="d-flex align-items-center mb-3">
                                <div class="avatar bg-primary rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                    <i class="fas fa-robot text-white"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0">Assistente PNSB</h6>
                                    <small class="text-muted">Especializado no Manual PNSB 2024</small>
                                </div>
                                <div class="ms-auto">
                                    <span class="badge bg-success" id="chat-status">üü¢ Online</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chat-messages" id="chat-messages" style="height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; background: #f8f9fa; color: #333333;">
                            <div class="message ai-message" style="color: #1976d2;">
                                <div class="message-content" style="color: inherit;">
                                    <strong>ü§ñ Assistente PNSB:</strong><br>
                                    Ol√°! Sou seu assistente especializado na Pesquisa Nacional de Saneamento B√°sico 2024. 
                                    Posso ajud√°-lo com d√∫vidas sobre:
                                    <ul class="mt-2 mb-0" style="color: inherit;">
                                        <li>Manual e procedimentos PNSB</li>
                                        <li>Preenchimento de question√°rios</li>
                                        <li>Legisla√ß√£o de saneamento</li>
                                        <li>T√©cnicas de coleta de dados</li>
                                        <li>Interpreta√ß√£o de resultados</li>
                                    </ul>
                                    Como posso ajud√°-lo hoje?
                                </div>
                                <small class="text-muted" style="color: #6c757d;">Agora mesmo</small>
                            </div>
                        </div>
                        
                        <div class="chat-input mt-3">
                            <div class="input-group">
                                <input type="text" class="form-control" id="chat-input" placeholder="Digite sua pergunta sobre PNSB..." onkeypress="handleChatKeyPress(event)">
                                <button class="btn btn-primary" type="button" onclick="sendChatMessage()">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">
                                    üí° Exemplos: "Como preencher o question√°rio de res√≠duos s√≥lidos?", "Qual a legisla√ß√£o sobre coleta seletiva?"
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.feature-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
}

.hover-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    cursor: pointer;
}

.hover-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
}

.bg-purple {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.text-purple {
    color: #667eea;
}

.page-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    border-radius: 15px;
    margin-bottom: 2rem;
}

.chat-container {
    background: white;
    border-radius: 10px;
}

.message {
    margin-bottom: 15px;
    padding: 12px;
    border-radius: 10px;
    background: white;
    border: 1px solid #e9ecef;
    color: #333333; /* Texto escuro leg√≠vel */
}

.ai-message {
    background: #e3f2fd;
    border-color: #2196f3;
    color: #1976d2; /* Azul escuro para contraste */
}

.user-message {
    background: #f3e5f5;
    border-color: #9c27b0;
    margin-left: 20%;
    color: #7b1fa2; /* Roxo escuro para contraste */
}

.message-content {
    margin-bottom: 5px;
    color: inherit;
}

.message-content strong {
    color: inherit;
}

#chat-messages {
    background: #f8f9fa;
    color: #333333;
}

.badge {
    font-size: 0.75em;
}

/* Estilos para Recursos Pr√°ticos */
.calculadora-card, .tabela-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    cursor: pointer;
    border: 1px solid #dee2e6;
}

.calculadora-card:hover, .tabela-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.nav-tabs .nav-link {
    color: #495057;
    border: none;
    background: transparent;
}

.nav-tabs .nav-link.active {
    background-color: #007bff;
    color: white;
    border-radius: 5px;
}

.nav-tabs .nav-link:hover:not(.active) {
    background-color: #f8f9fa;
    border-radius: 5px;
}

#resultado-calculo .card {
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.table-responsive {
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.table thead th {
    border-top: none;
    font-weight: 600;
}

/* Responsividade */
@media (max-width: 768px) {
    .page-header {
        padding: 1.5rem;
    }
    
    .feature-icon {
        width: 50px;
        height: 50px;
    }
    
    .modal-dialog {
        margin: 0.5rem;
    }
    
    .chat-messages {
        height: 300px;
    }
    
    .calculadora-card, .tabela-card {
        margin-bottom: 1rem;
    }
    
    .nav-tabs {
        font-size: 0.9rem;
    }
    
    .nav-tabs .nav-link {
        padding: 0.5rem 0.75rem;
    }
}
</style>

<script>
// Fun√ß√µes de navega√ß√£o
function openChatIA() {
    const modal = new bootstrap.Modal(document.getElementById('chatModal'));
    modal.show();
}

function openBiblioteca() {
    showContent('Biblioteca Digital', 'biblioteca');
}

function openBusca() {
    showContent('Busca Inteligente', 'busca');
}

function openRecursos() {
    showContent('Recursos Pr√°ticos', 'recursos');
}

function openTreinamento() {
    showContent('Centro de Treinamento', 'treinamento');
}

function openComunidade() {
    showContent('Comunidade de Pr√°tica', 'comunidade');
}

function showContent(title, type) {
    document.getElementById('content-title').textContent = title;
    document.getElementById('content-area').style.display = 'block';
    
    // Scroll para a √°rea de conte√∫do
    document.getElementById('content-area').scrollIntoView({ behavior: 'smooth' });
    
    // Carregar conte√∫do espec√≠fico
    loadContentByType(type);
}

function closeContent() {
    document.getElementById('content-area').style.display = 'none';
}

function loadContentByType(type) {
    const contentBody = document.getElementById('content-body');
    
    // Mostrar loading
    contentBody.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-2 text-muted">Carregando ${type}...</p>
        </div>
    `;
    
    // Simular carregamento e mostrar conte√∫do
    setTimeout(() => {
        switch(type) {
            case 'biblioteca':
                loadBibliotecaContent();
                break;
            case 'busca':
                loadBuscaContent();
                break;
            case 'recursos':
                loadRecursosContent();
                break;
            case 'treinamento':
                loadTreinamentoContent();
                break;
            case 'comunidade':
                loadComunidadeContent();
                break;
            default:
                contentBody.innerHTML = '<p class="text-center text-muted">Conte√∫do em desenvolvimento...</p>';
        }
    }, 1000);
}

// Chat IA Functions
function sendChatMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Adicionar mensagem do usu√°rio
    addChatMessage(message, 'user');
    input.value = '';
    
    // Mostrar indicador de digita√ß√£o
    showTypingIndicator();
    
    // Simular resposta da IA
    setTimeout(() => {
        hideTypingIndicator();
        processAIResponse(message);
    }, 2000);
}

function handleChatKeyPress(event) {
    if (event.key === 'Enter') {
        sendChatMessage();
    }
}

function addChatMessage(message, sender) {
    const chatMessages = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;
    
    const now = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    
    if (sender === 'user') {
        messageDiv.style.color = '#7b1fa2';
        messageDiv.innerHTML = `
            <div class="message-content" style="color: inherit;">
                <strong>üë§ Voc√™:</strong><br>
                ${message}
            </div>
            <small class="text-muted" style="color: #6c757d;">${now}</small>
        `;
    } else {
        messageDiv.style.color = '#1976d2';
        messageDiv.innerHTML = `
            <div class="message-content" style="color: inherit;">
                <strong>ü§ñ Assistente PNSB:</strong><br>
                ${message}
            </div>
            <small class="text-muted" style="color: #6c757d;">${now}</small>
        `;
    }
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function showTypingIndicator() {
    const chatMessages = document.getElementById('chat-messages');
    const typingDiv = document.createElement('div');
    typingDiv.id = 'typing-indicator';
    typingDiv.className = 'message ai-message';
    typingDiv.innerHTML = `
        <div class="message-content">
            <strong>ü§ñ Assistente PNSB:</strong><br>
            <span class="typing-dots">
                <span>.</span><span>.</span><span>.</span>
            </span>
            <em class="text-muted">digitando...</em>
        </div>
    `;
    
    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

async function processAIResponse(userMessage) {
    try {
        // Construir contexto PNSB espec√≠fico
        const context = buildPNSBManualContext(userMessage);
        
        const response = await fetch('/api/material-apoio/chat/manual', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: userMessage,
                context: context
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            addChatMessage(result.data.response, 'ai');
        } else {
            // Fallback para resposta local
            const fallbackResponse = generatePNSBFallbackResponse(userMessage);
            addChatMessage(fallbackResponse, 'ai');
        }
        
    } catch (error) {
        console.error('Erro no chat:', error);
        const errorResponse = 'Desculpe, estou com dificuldades t√©cnicas. Posso ajud√°-lo com informa√ß√µes b√°sicas sobre PNSB ou tente novamente em alguns instantes.';
        addChatMessage(errorResponse, 'ai');
    }
}

function buildPNSBManualContext(userMessage) {
    return `Voc√™ √© um assistente especializado na Pesquisa Nacional de Saneamento B√°sico (PNSB) 2024 do IBGE.

CONTEXTO ESPEC√çFICO:
- Manual PNSB 2024: Pesquisa sobre saneamento b√°sico nos munic√≠pios brasileiros
- Foco principal: Manejo de res√≠duos s√≥lidos e √°guas pluviais urbanas
- P√∫blico-alvo: Pesquisadores, t√©cnicos e gestores municipais
- Metodologia: Entrevistas presenciais com informantes qualificados
- √Çmbito: Munic√≠pios brasileiros, especialmente regi√£o Sul

TEMAS PRINCIPAIS DO MANUAL:
1. Res√≠duos S√≥lidos: coleta, tratamento, disposi√ß√£o final
2. √Åguas Pluviais: drenagem urbana, manejo de √°guas de chuva
3. Question√°rios: preenchimento correto e t√©cnicas de entrevista
4. Legisla√ß√£o: Marco Legal do Saneamento, PNRS
5. Indicadores: c√°lculos e interpreta√ß√£o de dados

PERGUNTA DO USU√ÅRIO: ${userMessage}

Forne√ßa uma resposta t√©cnica, precisa e baseada nas diretrizes do PNSB 2024. Use linguagem profissional mas acess√≠vel.`;
}

function generatePNSBFallbackResponse(userMessage) {
    const messageLower = userMessage.toLowerCase();
    
    if (messageLower.includes('residuo') || messageLower.includes('lixo') || messageLower.includes('coleta')) {
        return 'Sobre res√≠duos s√≥lidos no PNSB 2024: A pesquisa abrange coleta domiciliar, coleta seletiva, tratamento e disposi√ß√£o final. √â importante verificar se o munic√≠pio possui Plano Municipal de Gest√£o Integrada de Res√≠duos S√≥lidos e qual a cobertura dos servi√ßos de coleta.';
    }
    
    if (messageLower.includes('agua') || messageLower.includes('pluvial') || messageLower.includes('drenagem')) {
        return 'Sobre √°guas pluviais no PNSB 2024: Investiga-se o manejo de √°guas de chuva, sistemas de drenagem urbana, problemas de alagamentos e medidas de controle. Verificar se h√° Plano Municipal de Drenagem e Manejo das √Åguas Pluviais Urbanas.';
    }
    
    if (messageLower.includes('questionario') || messageLower.includes('entrevista')) {
        return 'Sobre question√°rios PNSB: Devem ser preenchidos durante entrevista presencial com informante qualificado da prefeitura. Aten√ß√£o aos c√≥digos de resposta, consist√™ncia dos dados e documenta√ß√£o de apoio necess√°ria.';
    }
    
    if (messageLower.includes('legisla') || messageLower.includes('marco') || messageLower.includes('lei')) {
        return 'Legisla√ß√£o PNSB: Baseia-se no Marco Legal do Saneamento (Lei 14.026/2020), Pol√≠tica Nacional de Res√≠duos S√≥lidos (Lei 12.305/2010) e diretrizes nacionais para saneamento b√°sico (Lei 11.445/2007).';
    }
    
    return 'Para informa√ß√µes espec√≠ficas sobre PNSB 2024, recomendo consultar o manual oficial ou entrar em contato com a coordena√ß√£o da pesquisa. Posso ajudar com d√∫vidas sobre procedimentos gerais, question√°rios e metodologia da pesquisa.';
}

// Placeholder functions para conte√∫dos futuros
async function loadBibliotecaContent() {
    const contentBody = document.getElementById('content-body');
    
    try {
        // Carregar lista de documentos da API
        const response = await fetch('/api/material-apoio/biblioteca/documentos');
        const result = await response.json();
        
        if (result.success) {
            const docs = result.data;
            
            contentBody.innerHTML = `
                <div class="biblioteca-header mb-4">
                    <h5>üìö Biblioteca Digital PNSB</h5>
                    <p class="text-muted">Documentos oficiais, manuais, question√°rios e legisla√ß√£o</p>
                    
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Buscar documentos..." id="search-docs">
                                <button class="btn btn-outline-secondary" type="button" onclick="searchDocuments()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="filter-category">
                                <option value="">Todas as categorias</option>
                                <option value="Manual Oficial">Manuais</option>
                                <option value="Question√°rio">Question√°rios</option>
                                <option value="Legisla√ß√£o">Legisla√ß√£o</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <h6>üìã Documentos Oficiais</h6>
                        <div class="document-list">
                            ${renderDocumentList(docs.manuais)}
                        </div>
                        
                        <h6 class="mt-4">üìù Question√°rios</h6>
                        <div class="document-list">
                            ${renderDocumentList(docs.questionarios)}
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <h6>‚öñÔ∏è Legisla√ß√£o</h6>
                        <div class="document-list">
                            ${renderDocumentList(docs.legislacao)}
                        </div>
                        
                        <h6 class="mt-4">üìä Tabelas de Refer√™ncia</h6>
                        <div class="document-list">
                            <div class="list-group-item">
                                <i class="fas fa-table text-info me-2"></i>
                                <span>C√≥digos IBGE Municipais</span>
                                <span class="badge bg-info ms-auto">Em breve</span>
                            </div>
                            <div class="list-group-item">
                                <i class="fas fa-list text-info me-2"></i>
                                <span>Classifica√ß√£o de Res√≠duos</span>
                                <span class="badge bg-info ms-auto">Em breve</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <h6>üéì Material de Treinamento</h6>
                        <div class="document-list">
                            <div class="list-group-item">
                                <i class="fas fa-video text-warning me-2"></i>
                                <span>V√≠deo: Como realizar entrevistas</span>
                                <span class="badge bg-warning ms-auto">Em breve</span>
                            </div>
                            <div class="list-group-item">
                                <i class="fas fa-file-powerpoint text-warning me-2"></i>
                                <span>Apresenta√ß√£o PNSB 2024</span>
                                <span class="badge bg-warning ms-auto">Em breve</span>
                            </div>
                        </div>
                        
                        <h6 class="mt-4">üìã Modelos</h6>
                        <div class="document-list">
                            <div class="list-group-item">
                                <i class="fas fa-file-word text-primary me-2"></i>
                                <span>Modelo de Relat√≥rio</span>
                                <span class="badge bg-primary ms-auto">Em breve</span>
                            </div>
                            <div class="list-group-item">
                                <i class="fas fa-file-excel text-success me-2"></i>
                                <span>Planilha de Controle</span>
                                <span class="badge bg-success ms-auto">Em breve</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="biblioteca-stats mt-4 p-3 bg-light rounded">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <h5 class="text-primary">${docs.manuais.length}</h5>
                            <small class="text-muted">Manuais</small>
                        </div>
                        <div class="col-md-3">
                            <h5 class="text-warning">${docs.questionarios.length}</h5>
                            <small class="text-muted">Question√°rios</small>
                        </div>
                        <div class="col-md-3">
                            <h5 class="text-info">${docs.legislacao.length}</h5>
                            <small class="text-muted">Leis</small>
                        </div>
                        <div class="col-md-3">
                            <h5 class="text-success">15</h5>
                            <small class="text-muted">Total Planejado</small>
                        </div>
                    </div>
                </div>
            `;
        } else {
            contentBody.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Erro ao carregar biblioteca: ${result.message}
                </div>
            `;
        }
        
    } catch (error) {
        console.error('Erro ao carregar biblioteca:', error);
        contentBody.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-times-circle me-2"></i>
                Erro ao conectar com a biblioteca digital.
            </div>
        `;
    }
}

function renderDocumentList(documents) {
    return documents.map(doc => {
        const statusColor = doc.status === 'disponivel' ? 'success' : 'warning';
        const statusText = doc.status === 'disponivel' ? 'Dispon√≠vel' : 'Em breve';
        const icon = getDocumentIcon(doc.formato);
        
        return `
            <div class="list-group-item list-group-item-action document-item" 
                 data-doc-id="${doc.id}" 
                 onclick="${doc.status === 'disponivel' ? `downloadDocument('${doc.id}')` : 'void(0)'}">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="${icon} me-2"></i>
                        <div>
                            <div class="document-title">${doc.titulo}</div>
                            <small class="text-muted">${doc.categoria} ‚Ä¢ ${doc.tamanho}</small>
                        </div>
                    </div>
                    <span class="badge bg-${statusColor}">${statusText}</span>
                </div>
            </div>
        `;
    }).join('');
}

function getDocumentIcon(formato) {
    switch(formato) {
        case 'PDF': return 'fas fa-file-pdf text-danger';
        case 'DOC': return 'fas fa-file-word text-primary';
        case 'XLS': return 'fas fa-file-excel text-success';
        case 'PPT': return 'fas fa-file-powerpoint text-warning';
        case 'VIDEO': return 'fas fa-video text-info';
        default: return 'fas fa-file text-secondary';
    }
}

function downloadDocument(docId) {
    // Simular download
    showToast(`Iniciando download do documento...`, 'info');
    
    // Na implementa√ß√£o real, fazer requisi√ß√£o para o endpoint de download
    fetch(`/api/material-apoio/biblioteca/download/${docId}`)
        .then(response => {
            if (response.ok) {
                showToast('Download conclu√≠do!', 'success');
            } else {
                showToast('Download ainda n√£o dispon√≠vel', 'warning');
            }
        })
        .catch(error => {
            console.error('Erro no download:', error);
            showToast('Erro no download', 'error');
        });
}

function searchDocuments() {
    const searchTerm = document.getElementById('search-docs').value.toLowerCase();
    const categoryFilter = document.getElementById('filter-category').value;
    
    const documentItems = document.querySelectorAll('.document-item');
    
    documentItems.forEach(item => {
        const title = item.querySelector('.document-title').textContent.toLowerCase();
        const category = item.querySelector('.text-muted').textContent;
        
        const matchesSearch = title.includes(searchTerm);
        const matchesCategory = !categoryFilter || category.includes(categoryFilter);
        
        if (matchesSearch && matchesCategory) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

function showToast(message, type = 'info') {
    // Implementa√ß√£o simples de toast notification
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type} position-fixed`;
    toast.style.cssText = `
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        opacity: 0;
        transition: opacity 0.3s;
    `;
    toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'info'}-circle me-2"></i>
        ${message}
    `;
    
    document.body.appendChild(toast);
    
    // Fade in
    setTimeout(() => toast.style.opacity = '1', 100);
    
    // Remove after delay
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => document.body.removeChild(toast), 300);
    }, 3000);
}

function loadBuscaContent() {
    document.getElementById('content-body').innerHTML = `
        <div class="search-interface">
            <div class="search-header mb-4">
                <h5>üîç Busca Inteligente PNSB</h5>
                <p class="text-muted">Pesquisa unificada em documentos, manuais, legisla√ß√£o e base de conhecimento</p>
            </div>
            
            <div class="search-main mb-4">
                <div class="row">
                    <div class="col-md-8">
                        <div class="input-group input-group-lg">
                            <input type="text" class="form-control" 
                                   placeholder="Digite sua pergunta ou termo de pesquisa..." 
                                   id="main-search-input"
                                   onkeypress="handleMainSearchKeyPress(event)">
                            <button class="btn btn-primary" type="button" onclick="performMainSearch()">
                                <i class="fas fa-search me-2"></i>Buscar
                            </button>
                        </div>
                        <div class="search-suggestions mt-2">
                            <small class="text-muted">
                                üí° Exemplos: "coleta seletiva", "plano municipal", "√°guas pluviais", "Lei 12.305"
                            </small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select form-select-lg" id="search-type">
                            <option value="all">üåê Busca Geral</option>
                            <option value="documents">üìÑ Documentos</option>
                            <option value="legislation">‚öñÔ∏è Legisla√ß√£o</option>
                            <option value="procedures">üìã Procedimentos</option>
                            <option value="qa">‚ùì Perguntas Frequentes</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="search-filters mb-4" style="display: none;" id="advanced-filters">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">üîß Filtros Avan√ßados</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">Categoria</label>
                                <select class="form-select" id="filter-category-search">
                                    <option value="">Todas</option>
                                    <option value="residuos">Res√≠duos S√≥lidos</option>
                                    <option value="aguas">√Åguas Pluviais</option>
                                    <option value="legislacao">Legisla√ß√£o</option>
                                    <option value="metodologia">Metodologia</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Tipo de Documento</label>
                                <select class="form-select" id="filter-doc-type">
                                    <option value="">Todos</option>
                                    <option value="manual">Manual</option>
                                    <option value="questionario">Question√°rio</option>
                                    <option value="lei">Legisla√ß√£o</option>
                                    <option value="tutorial">Tutorial</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Data</label>
                                <select class="form-select" id="filter-date">
                                    <option value="">Qualquer per√≠odo</option>
                                    <option value="2024">2024</option>
                                    <option value="2023">2023</option>
                                    <option value="2022">2022 ou anterior</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Relev√¢ncia</label>
                                <select class="form-select" id="filter-relevance">
                                    <option value="high">Alta</option>
                                    <option value="medium">M√©dia</option>
                                    <option value="all">Todas</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="search-actions mb-3">
                <button class="btn btn-outline-secondary btn-sm" onclick="toggleAdvancedFilters()">
                    <i class="fas fa-sliders-h me-1"></i>Filtros Avan√ßados
                </button>
                <button class="btn btn-outline-primary btn-sm" onclick="clearSearchFilters()">
                    <i class="fas fa-eraser me-1"></i>Limpar
                </button>
                <button class="btn btn-outline-success btn-sm" onclick="searchWithAI()">
                    <i class="fas fa-robot me-1"></i>Buscar com IA
                </button>
            </div>
            
            <div id="search-results">
                <div class="search-welcome text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Digite algo para pesquisar</h5>
                    <p class="text-muted">Busque por termos t√©cnicos, procedimentos, legisla√ß√£o ou fa√ßa perguntas espec√≠ficas sobre PNSB</p>
                    
                    <div class="quick-searches mt-4">
                        <h6 class="text-muted mb-3">üî• Buscas Populares:</h6>
                        <div class="d-flex flex-wrap justify-content-center gap-2">
                            <button class="btn btn-outline-primary btn-sm" onclick="quickSearch('coleta seletiva')">Coleta Seletiva</button>
                            <button class="btn btn-outline-primary btn-sm" onclick="quickSearch('PMGIRS')">PMGIRS</button>
                            <button class="btn btn-outline-primary btn-sm" onclick="quickSearch('drenagem urbana')">Drenagem Urbana</button>
                            <button class="btn btn-outline-primary btn-sm" onclick="quickSearch('question√°rio')">Question√°rio</button>
                            <button class="btn btn-outline-primary btn-sm" onclick="quickSearch('marco legal')">Marco Legal</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function handleMainSearchKeyPress(event) {
    if (event.key === 'Enter') {
        performMainSearch();
    }
}

async function performMainSearch() {
    const searchTerm = document.getElementById('main-search-input').value.trim();
    const searchType = document.getElementById('search-type').value;
    
    if (!searchTerm) {
        showToast('Digite algo para pesquisar', 'warning');
        return;
    }
    
    const resultsContainer = document.getElementById('search-results');
    
    // Mostrar loading
    resultsContainer.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Pesquisando...</span>
            </div>
            <p class="mt-2 text-muted">üîç Pesquisando "${searchTerm}"...</p>
        </div>
    `;
    
    try {
        // Construir filtros
        const filtros = {
            categoria: document.getElementById('filter-category-search')?.value || '',
            tipo_documento: document.getElementById('filter-doc-type')?.value || '',
            data: document.getElementById('filter-date')?.value || '',
            relevancia: document.getElementById('filter-relevance')?.value || 'high'
        };
        
        const response = await fetch('/api/material-apoio/busca', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                query: searchTerm,
                type: searchType,
                filtros: filtros
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            displaySearchResults(result.data, searchTerm);
        } else {
            resultsContainer.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Erro na pesquisa: ${result.message}
                </div>
            `;
        }
        
    } catch (error) {
        console.error('Erro na busca:', error);
        resultsContainer.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-times-circle me-2"></i>
                Erro ao realizar pesquisa. Tente novamente.
            </div>
        `;
    }
}

function displaySearchResults(data, searchTerm) {
    const resultsContainer = document.getElementById('search-results');
    
    if (data.status === 'em_desenvolvimento') {
        // Sistema de busca em desenvolvimento - n√£o usar dados simulados
        resultsContainer.innerHTML = `
            <div class="search-results-header mb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h6>Busca: <strong>"${searchTerm}"</strong></h6>
                    <span class="badge bg-warning">Sistema em desenvolvimento</span>
                </div>
                <small class="text-muted">‚ö†Ô∏è Funcionalidade de busca ser√° implementada em breve</small>
            </div>
            
            <div class="alert alert-info">
                <h6><i class="fas fa-info-circle me-2"></i>Sistema de Busca em Desenvolvimento</h6>
                <p class="mb-2">A funcionalidade de busca est√° sendo implementada e estar√° dispon√≠vel em breve.</p>
                <p class="mb-0"><strong>Alternativas:</strong></p>
                <ul class="mb-0">
                    <li>Use o Chat IA PNSB para perguntas espec√≠ficas</li>
                    <li>Navegue pelas se√ß√µes da Biblioteca Digital</li>
                    <li>Consulte os Tutoriais Pr√°ticos dispon√≠veis</li>
                </ul>
            </div>`;
    } else {
        resultsContainer.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Nenhum resultado encontrado para "${searchTerm}". Tente termos diferentes ou use a busca com IA.
            </div>
        `;
    }
}

// Fun√ß√£o removida: generateMockSearchResults() - sistema n√£o usa dados simulados

function quickSearch(term) {
    document.getElementById('main-search-input').value = term;
    performMainSearch();
}

function toggleAdvancedFilters() {
    const filters = document.getElementById('advanced-filters');
    if (filters.style.display === 'none') {
        filters.style.display = 'block';
    } else {
        filters.style.display = 'none';
    }
}

function clearSearchFilters() {
    document.getElementById('main-search-input').value = '';
    document.getElementById('search-type').value = 'all';
    
    const filters = ['filter-category-search', 'filter-doc-type', 'filter-date'];
    filters.forEach(id => {
        const element = document.getElementById(id);
        if (element) element.value = '';
    });
    
    document.getElementById('filter-relevance').value = 'high';
    document.getElementById('search-results').innerHTML = `
        <div class="search-welcome text-center py-5">
            <i class="fas fa-search fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">Digite algo para pesquisar</h5>
        </div>
    `;
}

async function searchWithAI() {
    const searchTerm = document.getElementById('main-search-input').value.trim();
    
    if (!searchTerm) {
        showToast('Digite uma pergunta para a IA', 'warning');
        return;
    }
    
    // Redirecionar para o chat IA com a pergunta
    const modal = new bootstrap.Modal(document.getElementById('chatModal'));
    modal.show();
    
    // Aguardar modal abrir e enviar pergunta
    setTimeout(() => {
        document.getElementById('chat-input').value = searchTerm;
        sendChatMessage();
    }, 500);
}

function openResult(resultId) {
    showToast('Abrindo resultado...', 'info');
    // Implementar abertura do resultado espec√≠fico
}

function saveResult(resultId) {
    showToast('Resultado salvo nos favoritos', 'success');
    // Implementar salvamento do resultado
}

function loadRecursosContent() {
    document.getElementById('content-body').innerHTML = `
        <div class="recursos-praticos">
            <div class="recursos-header mb-4">
                <h5>üõ†Ô∏è Recursos Pr√°ticos PNSB</h5>
                <p class="text-muted">Calculadoras especializadas, gloss√°rio t√©cnico e tabelas de refer√™ncia</p>
            </div>
            
            <!-- Navega√ß√£o por categorias -->
            <ul class="nav nav-tabs mb-4" id="recursos-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="calculadoras-tab" data-bs-toggle="tab" data-bs-target="#calculadoras" type="button" role="tab">
                        <i class="fas fa-calculator me-2"></i>Calculadoras
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="glossario-tab" data-bs-toggle="tab" data-bs-target="#glossario" type="button" role="tab">
                        <i class="fas fa-book me-2"></i>Gloss√°rio
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tabelas-tab" data-bs-toggle="tab" data-bs-target="#tabelas" type="button" role="tab">
                        <i class="fas fa-table me-2"></i>Tabelas
                    </button>
                </li>
            </ul>
            
            <!-- Conte√∫do das abas -->
            <div class="tab-content" id="recursos-tab-content">
                <!-- Calculadoras -->
                <div class="tab-pane fade show active" id="calculadoras" role="tabpanel">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="card h-100 calculadora-card" onclick="openCalculadora('cobertura_coleta')">
                                <div class="card-body text-center">
                                    <i class="fas fa-percentage fa-2x text-primary mb-3"></i>
                                    <h6>Cobertura de Coleta</h6>
                                    <p class="text-muted small">Calcula percentual de cobertura do servi√ßo de coleta domiciliar</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card h-100 calculadora-card" onclick="openCalculadora('geracao_per_capita')">
                                <div class="card-body text-center">
                                    <i class="fas fa-weight-hanging fa-2x text-success mb-3"></i>
                                    <h6>Gera√ß√£o Per Capita</h6>
                                    <p class="text-muted small">Calcula gera√ß√£o de res√≠duos por habitante por dia</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card h-100 calculadora-card" onclick="openCalculadora('taxa_reciclagem')">
                                <div class="card-body text-center">
                                    <i class="fas fa-recycle fa-2x text-warning mb-3"></i>
                                    <h6>Taxa de Reciclagem</h6>
                                    <p class="text-muted small">Calcula percentual de materiais reciclados</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card h-100 calculadora-card" onclick="openCalculadora('densidade_drenagem')">
                                <div class="card-body text-center">
                                    <i class="fas fa-tint fa-2x text-info mb-3"></i>
                                    <h6>Densidade de Drenagem</h6>
                                    <p class="text-muted small">Calcula densidade da rede de drenagem urbana</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card h-100 calculadora-card" onclick="openCalculadora('custo_per_capita')">
                                <div class="card-body text-center">
                                    <i class="fas fa-dollar-sign fa-2x text-danger mb-3"></i>
                                    <h6>Custo Per Capita</h6>
                                    <p class="text-muted small">Calcula custo do servi√ßo por habitante</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Gloss√°rio -->
                <div class="tab-pane fade" id="glossario" role="tabpanel">
                    <div class="glossario-container">
                        <div class="search-box mb-4">
                            <div class="input-group">
                                <input type="text" class="form-control" id="glossario-search" placeholder="Buscar termo t√©cnico...">
                                <button class="btn btn-outline-secondary" onclick="searchGlossario()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div id="glossario-results">
                            <p class="text-muted text-center">Digite um termo para buscar ou clique em "Carregar Gloss√°rio Completo"</p>
                            <div class="text-center">
                                <button class="btn btn-primary" onclick="loadGlossarioCompleto()">
                                    <i class="fas fa-book me-2"></i>Carregar Gloss√°rio Completo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tabelas -->
                <div class="tab-pane fade" id="tabelas" role="tabpanel">
                    <div class="tabelas-container">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="card tabela-card" onclick="loadTabela('municipios')">
                                    <div class="card-body text-center">
                                        <i class="fas fa-map-marker-alt fa-2x text-primary mb-3"></i>
                                        <h6>Munic√≠pios PNSB</h6>
                                        <p class="text-muted small">Lista dos munic√≠pios da pesquisa em SC</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card tabela-card" onclick="loadTabela('classificacao_residuos')">
                                    <div class="card-body text-center">
                                        <i class="fas fa-trash-alt fa-2x text-success mb-3"></i>
                                        <h6>Classifica√ß√£o Res√≠duos</h6>
                                        <p class="text-muted small">Tipos e classifica√ß√µes de res√≠duos s√≥lidos</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card tabela-card" onclick="loadTabela('indicadores')">
                                    <div class="card-body text-center">
                                        <i class="fas fa-chart-line fa-2x text-warning mb-3"></i>
                                        <h6>Indicadores PNSB</h6>
                                        <p class="text-muted small">Principais indicadores e f√≥rmulas</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="tabela-resultado"></div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function loadTreinamentoContent() {
    document.getElementById('content-body').innerHTML = `
        <div class="training-center">
            <h6>üéì Centro de Treinamento</h6>
            <p class="text-muted">Em desenvolvimento - Tutoriais e materiais de treinamento</p>
        </div>
    `;
}

function loadComunidadeContent() {
    document.getElementById('content-body').innerHTML = `
        <div class="community-hub">
            <h6>üë• Comunidade de Pr√°tica</h6>
            <p class="text-muted">Em desenvolvimento - F√≥rum e base de conhecimento colaborativa</p>
        </div>
    `;
}

// Novas fun√ß√µes para Recursos Pr√°ticos

async function openCalculadora(tipo) {
    const calculadoraConfig = {
        'cobertura_coleta': {
            titulo: 'Calculadora de Cobertura de Coleta',
            campos: [
                { id: 'populacao_total', label: 'Popula√ß√£o Total', tipo: 'number', placeholder: 'Ex: 100000' },
                { id: 'populacao_atendida', label: 'Popula√ß√£o Atendida', tipo: 'number', placeholder: 'Ex: 95000' }
            ]
        },
        'geracao_per_capita': {
            titulo: 'Calculadora de Gera√ß√£o Per Capita',
            campos: [
                { id: 'total_residuos_kg_dia', label: 'Total de Res√≠duos (kg/dia)', tipo: 'number', placeholder: 'Ex: 50000' },
                { id: 'populacao', label: 'Popula√ß√£o', tipo: 'number', placeholder: 'Ex: 100000' }
            ]
        },
        'taxa_reciclagem': {
            titulo: 'Calculadora de Taxa de Reciclagem',
            campos: [
                { id: 'total_coletado', label: 'Total Coletado (kg)', tipo: 'number', placeholder: 'Ex: 1000000' },
                { id: 'total_reciclado', label: 'Total Reciclado (kg)', tipo: 'number', placeholder: 'Ex: 150000' }
            ]
        },
        'densidade_drenagem': {
            titulo: 'Calculadora de Densidade de Drenagem',
            campos: [
                { id: 'extensao_rede_km', label: 'Extens√£o da Rede (km)', tipo: 'number', placeholder: 'Ex: 120' },
                { id: 'area_urbana_km2', label: '√Årea Urbana (km¬≤)', tipo: 'number', placeholder: 'Ex: 15' }
            ]
        },
        'custo_per_capita': {
            titulo: 'Calculadora de Custo Per Capita',
            campos: [
                { id: 'custo_total_anual', label: 'Custo Total Anual (R$)', tipo: 'number', placeholder: 'Ex: 5000000' },
                { id: 'populacao', label: 'Popula√ß√£o', tipo: 'number', placeholder: 'Ex: 100000' }
            ]
        }
    };
    
    const config = calculadoraConfig[tipo];
    if (!config) return;
    
    // Criar modal da calculadora
    const modalHtml = `
        <div class="modal fade" id="calculadoraModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-calculator me-2"></i>
                            ${config.titulo}
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="calculadora-form">
                            ${config.campos.map(campo => `
                                <div class="mb-3">
                                    <label for="${campo.id}" class="form-label">${campo.label}</label>
                                    <input type="${campo.tipo}" class="form-control" id="${campo.id}" 
                                           placeholder="${campo.placeholder}" required>
                                </div>
                            `).join('')}
                            
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-calculator me-2"></i>Calcular
                                </button>
                            </div>
                        </form>
                        
                        <div id="resultado-calculo" style="display: none;" class="mt-4">
                            <!-- Resultado ser√° inserido aqui -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remover modal anterior se existir
    const existingModal = document.getElementById('calculadoraModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Adicionar novo modal
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Configurar event listener do formul√°rio
    document.getElementById('calculadora-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const dados = {};
        config.campos.forEach(campo => {
            dados[campo.id] = document.getElementById(campo.id).value;
        });
        
        try {
            const response = await fetch('/api/material-apoio/recursos/calculadora', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    tipo: tipo,
                    dados: dados
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                displayCalculoResultado(result.data);
            } else {
                showToast(result.message || 'Erro no c√°lculo', 'error');
            }
            
        } catch (error) {
            console.error('Erro na calculadora:', error);
            showToast('Erro ao processar c√°lculo', 'error');
        }
    });
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('calculadoraModal'));
    modal.show();
}

function displayCalculoResultado(resultado) {
    const resultadoDiv = document.getElementById('resultado-calculo');
    
    resultadoDiv.innerHTML = `
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0">üìä Resultado do C√°lculo</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h4 class="text-success">${resultado.resultado} ${resultado.unidade}</h4>
                        <p class="text-muted mb-0">${resultado.tipo}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>üìã Interpreta√ß√£o:</h6>
                        <p class="text-muted">${resultado.interpretacao}</p>
                    </div>
                </div>
                
                <hr>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6>üî¢ F√≥rmula:</h6>
                        <code>${resultado.formula}</code>
                    </div>
                    <div class="col-md-6">
                        <h6>üì• Dados de Entrada:</h6>
                        <ul class="list-unstyled small">
                            ${Object.entries(resultado.dados_entrada).map(([key, value]) => 
                                `<li><strong>${key}:</strong> ${value}</li>`
                            ).join('')}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    resultadoDiv.style.display = 'block';
}

async function searchGlossario() {
    const termo = document.getElementById('glossario-search').value.trim();
    
    if (!termo) {
        showToast('Digite um termo para buscar', 'warning');
        return;
    }
    
    try {
        const response = await fetch(`/api/material-apoio/recursos/glossario?termo=${encodeURIComponent(termo)}`);
        const result = await response.json();
        
        if (result.success) {
            displayGlossarioResultado(result.data, termo);
        } else {
            showToast('Erro ao buscar termo', 'error');
        }
        
    } catch (error) {
        console.error('Erro na busca do gloss√°rio:', error);
        showToast('Erro ao buscar termo', 'error');
    }
}

async function loadGlossarioCompleto() {
    try {
        const response = await fetch('/api/material-apoio/recursos/glossario');
        const result = await response.json();
        
        if (result.success) {
            displayGlossarioCompleto(result.data.glossario_completo);
        } else {
            showToast('Erro ao carregar gloss√°rio', 'error');
        }
        
    } catch (error) {
        console.error('Erro ao carregar gloss√°rio:', error);
        showToast('Erro ao carregar gloss√°rio', 'error');
    }
}

function displayGlossarioResultado(data, termo) {
    const resultsDiv = document.getElementById('glossario-results');
    
    if (data.termo) {
        // Resultado √∫nico
        resultsDiv.innerHTML = `
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">${data.termo}</h6>
                </div>
                <div class="card-body">
                    <p><strong>Defini√ß√£o:</strong> ${data.definicao}</p>
                    <p><strong>Descri√ß√£o:</strong> ${data.descricao}</p>
                    <div class="row">
                        <div class="col-md-6">
                            <span class="badge bg-secondary">${data.categoria}</span>
                        </div>
                        <div class="col-md-6 text-end">
                            <small class="text-muted">${data.base_legal}</small>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else if (data.resultados) {
        // M√∫ltiplos resultados
        const resultados = Object.entries(data.resultados);
        
        if (resultados.length === 0) {
            resultsDiv.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Nenhum termo encontrado para "${termo}"
                </div>
            `;
        } else {
            resultsDiv.innerHTML = `
                <h6>Resultados para "${termo}":</h6>
                ${resultados.map(([key, item]) => `
                    <div class="card mb-2">
                        <div class="card-body">
                            <h6 class="card-title">${item.termo}</h6>
                            <p class="card-text">${item.definicao}</p>
                            <span class="badge bg-secondary">${item.categoria}</span>
                        </div>
                    </div>
                `).join('')}
            `;
        }
    }
}

function displayGlossarioCompleto(glossario) {
    const resultsDiv = document.getElementById('glossario-results');
    const termos = Object.entries(glossario);
    
    resultsDiv.innerHTML = `
        <h6>Gloss√°rio Completo PNSB (${termos.length} termos):</h6>
        <div class="row">
            ${termos.map(([key, item]) => `
                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h6 class="card-title">${item.termo}</h6>
                            <p class="card-text small">${item.definicao}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge bg-secondary">${item.categoria}</span>
                                <small class="text-muted">${item.base_legal}</small>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

async function loadTabela(tipo) {
    try {
        const response = await fetch(`/api/material-apoio/recursos/tabelas?tipo=${tipo}`);
        const result = await response.json();
        
        if (result.success) {
            displayTabela(result.data);
        } else {
            showToast('Erro ao carregar tabela', 'error');
        }
        
    } catch (error) {
        console.error('Erro ao carregar tabela:', error);
        showToast('Erro ao carregar tabela', 'error');
    }
}

function displayTabela(tabela) {
    const resultadoDiv = document.getElementById('tabela-resultado');
    
    resultadoDiv.innerHTML = `
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">${tabela.titulo}</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                ${tabela.colunas.map(coluna => `<th>${coluna}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${tabela.dados.map(linha => `
                                <tr>
                                    ${linha.map(celula => `<td>${celula}</td>`).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="text-end">
                    <small class="text-muted">Fonte: ${tabela.fonte}</small>
                </div>
            </div>
        </div>
    `;
}

// Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìö Material de Apoio PNSB carregado');
});
</script>
{% endblock %}