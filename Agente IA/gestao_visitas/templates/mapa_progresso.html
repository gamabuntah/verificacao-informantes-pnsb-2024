{% extends "base.html" %}

{% block title %}Mapa de Progresso - Sistema PNSB{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
.map-container {
    background: #23263B;
    border-radius: 16px;
    overflow: hidden;
    position: relative;
}

#mapa-progresso {
    height: 600px;
    width: 100%;
    border-radius: 16px;
}

.legend-container {
    background: #23263B;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}

.legend-item {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
}

.legend-color {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    margin-right: 10px;
}

.progress-card {
    background: #23263B;
    border: 2px solid #2D3142;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 15px;
    transition: all 0.3s ease;
}

.progress-card:hover {
    border-color: #5F5CFF;
    transform: translateY(-2px);
}

.progress-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 15px;
}

.municipality-name {
    font-size: 18px;
    font-weight: 600;
    color: #F1F1F1;
}

.progress-status {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
}

.status-completed { background: #28a745; color: white; }
.status-in-progress { background: #ffc107; color: #212529; }
.status-pending { background: #6c757d; color: white; }
.status-blocked { background: #dc3545; color: white; }

/* Intelligent Status Styles */
.intelligent-status {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
}

.intelligent-status-badge {
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.intelligent-status-badge.aguardando-agendamento { background: #6c757d; color: white; }
.intelligent-status-badge.em-preparacao { background: #17a2b8; color: white; }
.intelligent-status-badge.pronto-para-visita { background: #20c997; color: white; }
.intelligent-status-badge.visita-realizada { background: #007bff; color: white; }
.intelligent-status-badge.questionarios-respondidos { background: #fd7e14; color: white; }
.intelligent-status-badge.questionarios-validados { background: #28a745; color: white; }
.intelligent-status-badge.processo-finalizado { background: #6f42c1; color: white; }

.dual-status {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px;
}

.questionnaire-status {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-top: 10px;
}

.questionnaire-item {
    background: rgba(45, 49, 66, 0.5);
    border-radius: 8px;
    padding: 8px;
    text-align: center;
}

.questionnaire-type {
    font-size: 10px;
    font-weight: 600;
    color: #B8BCC8;
    margin-bottom: 4px;
}

.questionnaire-progress {
    display: flex;
    justify-content: space-between;
    font-size: 10px;
}

.questionnaire-progress .responded {
    color: #ffc107;
}

.questionnaire-progress .validated {
    color: #28a745;
}

.checklist-progress {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
    gap: 5px;
}

.checklist-phase {
    flex: 1;
    background: rgba(45, 49, 66, 0.5);
    border-radius: 8px;
    padding: 8px;
    text-align: center;
}

.checklist-phase-title {
    font-size: 10px;
    font-weight: 600;
    color: #B8BCC8;
    margin-bottom: 4px;
}

.checklist-phase-value {
    font-size: 14px;
    font-weight: bold;
    color: #5F5CFF;
}

.next-action {
    background: rgba(110, 231, 183, 0.1);
    border: 1px solid #6EE7B7;
    border-radius: 8px;
    padding: 8px;
    margin-top: 10px;
    text-align: center;
}

.next-action-title {
    font-size: 10px;
    font-weight: 600;
    color: #6EE7B7;
    margin-bottom: 4px;
}

.next-action-text {
    font-size: 12px;
    color: #F1F1F1;
}

.error-message {
    background: rgba(220, 53, 69, 0.1);
    border: 1px solid #dc3545;
    color: #dc3545;
    padding: 8px;
    border-radius: 8px;
    text-align: center;
    font-size: 12px;
    margin-top: 10px;
}

.loading-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    color: #B8BCC8;
    font-size: 12px;
    padding: 10px;
}

.loading-spinner {
    width: 16px;
    height: 16px;
    border: 2px solid #2D3142;
    border-top: 2px solid #5F5CFF;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.progress-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
}

.detail-item {
    text-align: center;
}

.detail-value {
    font-size: 24px;
    font-weight: bold;
    color: #5F5CFF;
}

.detail-label {
    font-size: 12px;
    color: #B8BCC8;
    margin-top: 4px;
}

.progress-bar-container {
    background: #2D3142;
    border-radius: 10px;
    height: 20px;
    overflow: hidden;
    margin-bottom: 10px;
}

.progress-bar-fill {
    height: 100%;
    border-radius: 10px;
    transition: width 0.5s ease;
    background: linear-gradient(90deg, #5F5CFF 0%, #6EE7B7 100%);
}

.municipality-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.action-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-view { background: #17a2b8; color: white; }
.btn-edit { background: #28a745; color: white; }
.btn-contact { background: #ffc107; color: #212529; }
.btn-report { background: #6f42c1; color: white; }

.action-btn:hover {
    transform: translateY(-1px);
    opacity: 0.9;
}

.filters-container {
    background: #23263B;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}

.map-controls {
    position: absolute;
    top: 20px;
    right: 20px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.control-btn {
    background: #5F5CFF;
    color: white;
    border: none;
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.control-btn:hover {
    background: #6EE7B7;
}

.popup-content {
    max-width: 300px;
}

.popup-title {
    font-weight: bold;
    font-size: 16px;
    margin-bottom: 10px;
    color: #2D3142;
}

.popup-detail {
    margin-bottom: 5px;
    font-size: 14px;
}

.popup-progress {
    margin-top: 10px;
}

.popup-progress-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    margin-bottom: 4px;
}

.popup-progress-item span {
    font-weight: 500;
    color: #B8BCC8;
}

.popup-progress-bar {
    background: #e9ecef;
    border-radius: 10px;
    height: 8px;
    overflow: hidden;
}

.popup-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #5F5CFF 0%, #6EE7B7 100%);
    border-radius: 10px;
}

/* Estilos para Heatmap Avançado */
.heatmap-legend {
    position: absolute;
    bottom: 20px;
    left: 20px;
    background: rgba(35, 38, 59, 0.95);
    padding: 15px;
    border-radius: 12px;
    border: 1px solid #2D3142;
    backdrop-filter: blur(10px);
    z-index: 1000;
}

.heatmap-legend h6 {
    color: #F1F1F1;
    margin-bottom: 10px;
    font-size: 14px;
    font-weight: 600;
}

.legend-scale {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

.legend-color-gradient {
    width: 100px;
    height: 20px;
    border-radius: 10px;
    background: linear-gradient(90deg, 
        #dc3545 0%,    /* Crítico */
        #fd7e14 25%,   /* Baixo */
        #ffc107 50%,   /* Médio */
        #20c997 75%,   /* Alto */
        #28a745 100%   /* Completo */
    );
    border: 1px solid #fff;
}

.legend-labels {
    display: flex;
    justify-content: space-between;
    font-size: 10px;
    color: #B8BCC8;
    margin-top: 5px;
}

.marker-pulse {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.7; }
    100% { transform: scale(1); opacity: 1; }
}

.marker-priority-alta {
    box-shadow: 0 0 20px rgba(220, 53, 69, 0.6);
}

.marker-priority-media {
    box-shadow: 0 0 15px rgba(255, 193, 7, 0.4);
}

.marker-priority-baixa {
    box-shadow: 0 0 10px rgba(108, 117, 125, 0.3);
}

/* Filtros Essenciais */
.filters-essential {
    background: linear-gradient(135deg, #23263B 0%, #2D3142 100%);
    border: 1px solid #5F5CFF;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 20px;
    box-shadow: 0 8px 32px rgba(95, 92, 255, 0.1);
}

.filters-essential .form-select {
    border: 1px solid #5F5CFF;
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 14px;
    transition: all 0.3s ease;
}

.filters-essential .form-select:focus {
    border-color: #6EE7B7;
    box-shadow: 0 0 0 0.2rem rgba(110, 231, 183, 0.25);
}

.filters-essential .form-select option {
    background: #2D3142;
    color: #F1F1F1;
}

/* CSS dos filtros de range removido - desnecessário com filtros simplificados */

/* Estilos para Popup Detalhado */
.popup-custom .leaflet-popup-content-wrapper {
    background: #23263B;
    border: 1px solid #5F5CFF;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
}

.popup-custom .leaflet-popup-content {
    margin: 0;
    color: #F1F1F1;
}

.popup-section {
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #2D3142;
}

.popup-section:last-child {
    border-bottom: none;
}

.popup-section h6 {
    color: #6EE7B7;
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 8px;
}

.stat-box {
    background: #2D3142;
    border-radius: 8px;
    padding: 8px;
    text-align: center;
}

.stat-number {
    font-size: 18px;
    font-weight: bold;
    color: #5F5CFF;
}

.stat-label {
    font-size: 11px;
    color: #B8BCC8;
    margin-top: 2px;
}

.mini-progress {
    background: #2D3142;
    border-radius: 4px;
    height: 6px;
    overflow: hidden;
    margin-top: 4px;
}

.mini-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #5F5CFF 0%, #6EE7B7 100%);
    border-radius: 4px;
    transition: width 0.3s ease;
}

.analysis-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
}

.analysis-label {
    font-size: 12px;
    color: #B8BCC8;
}

.next-action {
    background: #2D3142;
    padding: 10px;
    border-radius: 8px;
    font-size: 13px;
    color: #F1F1F1;
    border-left: 3px solid #6EE7B7;
}

.popup-actions {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
}

.popup-actions .btn {
    font-size: 11px;
    padding: 4px 8px;
}

/* Estilos para Painel de Predição */
.prediction-panel {
    background: linear-gradient(135deg, #23263B 0%, #2D3142 100%);
    border: 2px solid #5F5CFF;
    border-radius: 20px;
    padding: 25px;
    box-shadow: 0 12px 48px rgba(95, 92, 255, 0.15);
    position: relative;
    overflow: hidden;
}

.prediction-panel::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #5F5CFF 0%, #6EE7B7 50%, #5F5CFF 100%);
    animation: shimmer 3s infinite;
}

@keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
}

.prediction-card {
    background: rgba(45, 49, 66, 0.8);
    border: 1px solid #5F5CFF;
    border-radius: 16px;
    padding: 20px;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.prediction-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(95, 92, 255, 0.3);
    border-color: #6EE7B7;
}

.prediction-icon {
    font-size: 2.5rem;
    color: #6EE7B7;
    margin-bottom: 15px;
    text-align: center;
}

.prediction-value {
    font-size: 2rem;
    font-weight: 900;
    color: #F1F1F1;
    text-align: center;
    margin-bottom: 8px;
    background: linear-gradient(90deg, #5F5CFF 0%, #6EE7B7 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.prediction-label {
    font-size: 14px;
    font-weight: 600;
    color: #F1F1F1;
    text-align: center;
    margin-bottom: 5px;
}

.prediction-sublabel {
    font-size: 11px;
    color: #B8BCC8;
    text-align: center;
}

.prediction-confidence {
    font-size: 12px;
    text-align: center;
    padding: 4px 8px;
    border-radius: 20px;
    margin-top: 8px;
}

.confidence-alta { background: #28a745; color: white; }
.confidence-media { background: #ffc107; color: #212529; }
.confidence-baixa { background: #dc3545; color: white; }

/* Cenários de Simulação */
.simulation-scenarios {
    background: rgba(13, 16, 23, 0.3);
    border-radius: 16px;
    padding: 20px;
    border: 1px solid rgba(95, 92, 255, 0.2);
}

.scenario-card {
    background: rgba(45, 49, 66, 0.6);
    border-radius: 12px;
    padding: 15px;
    transition: all 0.3s ease;
    border: 1px solid transparent;
}

.scenario-optimistic {
    border-color: #28a745;
}

.scenario-optimistic:hover {
    background: rgba(40, 167, 69, 0.1);
    transform: translateY(-3px);
}

.scenario-realistic {
    border-color: #ffc107;
}

.scenario-realistic:hover {
    background: rgba(255, 193, 7, 0.1);
    transform: translateY(-3px);
}

.scenario-pessimistic {
    border-color: #dc3545;
}

.scenario-pessimistic:hover {
    background: rgba(220, 53, 69, 0.1);
    transform: translateY(-3px);
}

.scenario-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
    font-weight: 600;
    color: #F1F1F1;
}

.scenario-date {
    font-size: 18px;
    font-weight: bold;
    color: #6EE7B7;
    margin-bottom: 5px;
}

.scenario-description {
    font-size: 12px;
    color: #B8BCC8;
}

/* Recomendações */
.recommendations {
    background: rgba(13, 16, 23, 0.3);
    border-radius: 16px;
    padding: 20px;
    border: 1px solid rgba(110, 231, 183, 0.2);
}

.recommendation-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px;
    margin-bottom: 10px;
    background: rgba(45, 49, 66, 0.4);
    border-radius: 10px;
    border-left: 4px solid #6EE7B7;
    transition: all 0.3s ease;
}

.recommendation-item:hover {
    background: rgba(45, 49, 66, 0.7);
    transform: translateX(5px);
}

.recommendation-icon {
    color: #6EE7B7;
    font-size: 16px;
    margin-top: 2px;
}

.recommendation-content {
    flex: 1;
}

.recommendation-title {
    font-weight: 600;
    color: #F1F1F1;
    font-size: 14px;
    margin-bottom: 4px;
}

.recommendation-description {
    font-size: 12px;
    color: #B8BCC8;
    line-height: 1.4;
}

.recommendation-priority {
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
    margin-left: auto;
}

.priority-critica { background: #dc3545; color: white; }
.priority-alta { background: #fd7e14; color: white; }
.priority-media { background: #ffc107; color: #212529; }
.priority-baixa { background: #6c757d; color: white; }

/* Estilos para Otimização de Rotas */
.route-optimizer-panel {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 350px;
    max-height: calc(100vh - 40px);
    background: linear-gradient(135deg, #23263B 0%, #2D3142 100%);
    border: 2px solid #6EE7B7;
    border-radius: 16px;
    padding: 20px;
    z-index: 1001;
    backdrop-filter: blur(10px);
    box-shadow: 0 15px 35px rgba(0,0,0,0.4);
    overflow-y: auto;
}

.route-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid #5F5CFF;
}

.route-panel-header h6 {
    color: #6EE7B7;
    margin: 0;
    font-weight: 600;
}

.route-configuration .form-label {
    color: #F1F1F1;
    font-weight: 500;
    font-size: 12px;
}

.municipalities-grid {
    max-height: 200px;
    overflow-y: auto;
    background: rgba(13, 16, 23, 0.3);
    border-radius: 8px;
    padding: 10px;
}

.municipality-checkbox {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    margin-bottom: 5px;
    background: rgba(45, 49, 66, 0.5);
    border-radius: 6px;
    transition: all 0.3s ease;
}

.municipality-checkbox:hover {
    background: rgba(95, 92, 255, 0.2);
    transform: translateX(3px);
}

.municipality-checkbox input[type="checkbox"] {
    margin-right: 8px;
}

.municipality-name {
    color: #F1F1F1;
    font-size: 13px;
    flex: 1;
}

.municipality-status {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 10px;
    font-weight: 600;
}

.status-alta { background: #dc3545; color: white; }
.status-media { background: #ffc107; color: #212529; }
.status-baixa { background: #28a745; color: white; }

.route-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.route-actions .btn {
    font-size: 12px;
    padding: 6px 12px;
    flex: 1;
}

.route-result {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #5F5CFF;
}

.route-summary {
    background: rgba(13, 16, 23, 0.3);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
}

.route-stat {
    text-align: center;
}

.route-stat-value {
    font-size: 18px;
    font-weight: bold;
    color: #6EE7B7;
    margin-bottom: 4px;
}

.route-stat-label {
    font-size: 11px;
    color: #B8BCC8;
}

.sequence-list {
    background: rgba(13, 16, 23, 0.3);
    border-radius: 10px;
    padding: 15px;
}

.sequence-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px;
    margin-bottom: 8px;
    background: rgba(45, 49, 66, 0.5);
    border-radius: 8px;
    transition: all 0.3s ease;
}

.sequence-item:hover {
    background: rgba(95, 92, 255, 0.2);
}

.sequence-number {
    width: 25px;
    height: 25px;
    background: #5F5CFF;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 12px;
}

.sequence-content {
    flex: 1;
}

.sequence-municipality {
    color: #F1F1F1;
    font-weight: 600;
    font-size: 14px;
}

.sequence-details {
    color: #B8BCC8;
    font-size: 11px;
    margin-top: 2px;
}

.sequence-time {
    color: #6EE7B7;
    font-size: 12px;
    font-weight: 600;
}

/* Rota no Mapa */
.route-line {
    stroke: #6EE7B7;
    stroke-width: 4;
    stroke-opacity: 0.8;
    fill: none;
    stroke-dasharray: 10, 5;
    animation: route-flow 2s linear infinite;
}

@keyframes route-flow {
    0% { stroke-dashoffset: 0; }
    100% { stroke-dashoffset: 15; }
}

.route-marker {
    border: 3px solid #6EE7B7 !important;
    box-shadow: 0 0 15px rgba(110, 231, 183, 0.6) !important;
}

.route-start-marker {
    border: 3px solid #28a745 !important;
    box-shadow: 0 0 20px rgba(40, 167, 69, 0.8) !important;
}

.route-end-marker {
    border: 3px solid #dc3545 !important;
    box-shadow: 0 0 20px rgba(220, 53, 69, 0.8) !important;
}

/* ===========================================
   INTELLIGENT CRITERIA GRID STYLES
   =========================================== */

.intelligent-criteria-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 8px;
    margin-bottom: 15px;
}

.criteria-option {
    background: rgba(13, 16, 23, 0.3);
    border: 1px solid #2D3142;
    border-radius: 8px;
    padding: 8px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.criteria-option:hover {
    background: rgba(95, 92, 255, 0.1);
    border-color: #5F5CFF;
    transform: translateY(-1px);
}

.criteria-option .form-check {
    margin-bottom: 0;
}

.criteria-option .form-check-input {
    margin-top: 0;
}

.criteria-option .form-check-label {
    cursor: pointer;
    width: 100%;
    margin-bottom: 0;
}

.criteria-option .form-check-input:checked ~ .form-check-label {
    color: #6EE7B7;
}

.criteria-option .form-check-input:checked ~ .form-check-label .criteria-header {
    color: #6EE7B7;
}

.criteria-option .form-check-input:checked ~ .form-check-label .criteria-header i {
    color: #5F5CFF;
}

.criteria-header {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 4px;
    transition: all 0.3s ease;
}

.criteria-header i {
    font-size: 12px;
    color: #B8BCC8;
    transition: all 0.3s ease;
}

.criteria-title {
    font-size: 11px;
    font-weight: 600;
    color: #F1F1F1;
    transition: all 0.3s ease;
}

.criteria-description {
    font-size: 9px;
    color: #B8BCC8;
    line-height: 1.2;
    margin-left: 18px;
}

.route-options {
    background: rgba(13, 16, 23, 0.2);
    border-radius: 10px;
    padding: 12px;
    border: 1px solid #2D3142;
}

.route-options h6 {
    color: #6EE7B7;
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 6px;
}

/* Route Result Enhanced Styling */
.route-result {
    background: rgba(13, 16, 23, 0.4);
    border-radius: 12px;
    padding: 15px;
    margin-top: 15px;
    border: 1px solid #5F5CFF;
}

.route-result h6 {
    color: #6EE7B7;
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.route-result .route-summary {
    background: rgba(45, 49, 66, 0.3);
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 10px;
}

.route-result .route-stat-value {
    font-size: 16px;
    font-weight: bold;
    color: #6EE7B7;
}

.route-result .route-stat-label {
    font-size: 10px;
    color: #B8BCC8;
}

.route-result .sequence-list {
    max-height: 200px;
    overflow-y: auto;
    background: rgba(45, 49, 66, 0.2);
    border-radius: 8px;
    padding: 8px;
}

.route-result .sequence-item {
    padding: 6px 8px;
    margin-bottom: 4px;
    background: rgba(95, 92, 255, 0.1);
    border-radius: 6px;
    font-size: 11px;
}

.route-result .sequence-municipality {
    color: #F1F1F1;
    font-weight: 600;
    font-size: 11px;
}

.route-result .sequence-details {
    color: #B8BCC8;
    font-size: 9px;
    margin-top: 1px;
}

.route-result .sequence-time {
    color: #6EE7B7;
    font-size: 10px;
    font-weight: 600;
}

/* ===========================================
   ROUTE RESULT ENHANCED STYLES
   =========================================== */

.route-info-header {
    background: rgba(13, 16, 23, 0.4);
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 15px;
    border: 1px solid #5F5CFF;
}

.start-point-info {
    color: #F1F1F1;
    font-size: 12px;
}

.start-point-info i {
    color: #28a745;
    margin-right: 8px;
}

.details-row {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    margin-bottom: 6px;
}

.detail-badge {
    font-size: 9px;
    padding: 2px 6px;
    border-radius: 10px;
    font-weight: 500;
}

.detail-badge.badge-danger {
    background: #dc3545;
    color: white;
}

.detail-badge.badge-info {
    background: #17a2b8;
    color: white;
}

.detail-badge.badge-warning {
    background: #ffc107;
    color: #212529;
}

.detail-badge.badge-secondary {
    background: #6c757d;
    color: white;
}

.reasons-list {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
    margin-top: 4px;
}

.reason-tag {
    font-size: 8px;
    background: rgba(95, 92, 255, 0.2);
    color: #6EE7B7;
    padding: 2px 5px;
    border-radius: 8px;
    border: 1px solid #5F5CFF;
}

.sequence-item.never-visited {
    background: rgba(220, 53, 69, 0.1) !important;
    border: 1px solid #dc3545;
}

.sequence-item.start-point {
    background: rgba(40, 167, 69, 0.1);
    border: 1px solid #28a745;
}

.sequence-item.end-point {
    background: rgba(40, 167, 69, 0.1);
    border: 1px solid #28a745;
}

.route-start-container,
.route-end-container {
    background: transparent !important;
}

.route-popup {
    min-width: 200px;
}

.route-popup h6 {
    color: #2D3142;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.route-popup p {
    margin-bottom: 4px;
    font-size: 12px;
    color: #2D3142;
}

/* Marcadores no mapa */
.route-marker-urgent {
    border: 3px solid #dc3545 !important;
    box-shadow: 0 0 15px rgba(220, 53, 69, 0.6) !important;
    animation: pulse 2s infinite;
}

.route-marker-normal {
    border: 3px solid #6EE7B7 !important;
    box-shadow: 0 0 10px rgba(110, 231, 183, 0.4) !important;
}

/* Schedule Information Styles */
.schedule-info-row {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
    margin: 4px 0;
}

.schedule-badge {
    font-size: 8px;
    padding: 2px 4px;
    border-radius: 8px;
    font-weight: 500;
    border: 1px solid transparent;
}

.schedule-badge.badge-success {
    background: #28a745;
    color: white;
}

.schedule-badge.badge-danger {
    background: #dc3545;
    color: white;
}

.schedule-badge.badge-info {
    background: #17a2b8;
    color: white;
}

.schedule-badge.badge-light {
    background: #f8f9fa;
    color: #495057;
    border-color: #dee2e6;
}

.reason-tag.schedule-optimized {
    background: rgba(40, 167, 69, 0.2);
    color: #28a745;
    border-color: #28a745;
}

/* Business Hours Indicator */
.business-hours-indicator {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 10px;
    background: rgba(13, 16, 23, 0.3);
    border: 1px solid #5F5CFF;
    color: #F1F1F1;
}

.business-hours-indicator.open {
    background: rgba(40, 167, 69, 0.2);
    border-color: #28a745;
    color: #28a745;
}

.business-hours-indicator.closed {
    background: rgba(220, 53, 69, 0.2);
    border-color: #dc3545;
    color: #dc3545;
}

/* Schedule Efficiency Bar */
.schedule-efficiency {
    width: 100%;
    height: 4px;
    background: #2D3142;
    border-radius: 2px;
    overflow: hidden;
    margin: 2px 0;
}

.schedule-efficiency-fill {
    height: 100%;
    background: linear-gradient(90deg, #dc3545 0%, #ffc107 50%, #28a745 100%);
    border-radius: 2px;
    transition: width 0.3s ease;
}

/* ===========================================
   DASHBOARD EXECUTIVO STYLES
   =========================================== */

.executive-dashboard {
    background: linear-gradient(135deg, #23263B 0%, #2D3142 100%);
    border: 2px solid #5F5CFF;
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
}

.dashboard-controls {
    display: flex;
    gap: 10px;
}

/* KPI Cards */
.kpi-card {
    background: linear-gradient(135deg, #2D3142 0%, #23263B 100%);
    border-radius: 16px;
    padding: 20px;
    border: 2px solid transparent;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.kpi-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--kpi-color);
    border-radius: 16px 16px 0 0;
}

.kpi-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 30px rgba(0,0,0,0.4);
}

.kpi-primary { --kpi-color: #5F5CFF; }
.kpi-success { --kpi-color: #28a745; }
.kpi-warning { --kpi-color: #ffc107; }
.kpi-info { --kpi-color: #17a2b8; }
.kpi-danger { --kpi-color: #dc3545; }
.kpi-secondary { --kpi-color: #6c757d; }

.kpi-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 50px;
    height: 50px;
    background: var(--kpi-color);
    border-radius: 12px;
    margin-bottom: 15px;
    font-size: 20px;
    color: white;
}

.kpi-value {
    font-size: 28px;
    font-weight: bold;
    color: #F1F1F1;
    margin-bottom: 5px;
}

.kpi-label {
    font-size: 12px;
    color: #B8BCC8;
    margin-bottom: 5px;
}

.kpi-trend {
    font-size: 11px;
    color: var(--kpi-color);
    font-weight: 600;
}

/* Chart Containers */
.chart-container {
    background: rgba(13, 16, 23, 0.5);
    border-radius: 16px;
    padding: 20px;
    border: 1px solid #2D3142;
}

.chart-title {
    color: #F1F1F1;
    margin-bottom: 15px;
    font-weight: 600;
}

/* Metrics Detailed */
.metrics-detailed {
    background: rgba(13, 16, 23, 0.5);
    border-radius: 16px;
    padding: 20px;
    border: 1px solid #2D3142;
}

.metrics-title {
    color: #5F5CFF;
    margin-bottom: 20px;
    font-weight: 600;
    padding-bottom: 10px;
    border-bottom: 1px solid #2D3142;
}

.metric-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid rgba(45, 49, 66, 0.3);
}

.metric-item:last-child {
    border-bottom: none;
}

.metric-label {
    color: #B8BCC8;
    font-size: 13px;
}

.metric-value {
    color: #6EE7B7;
    font-weight: 600;
    font-size: 14px;
}

/* Status Distribution */
.status-distribution {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.status-item {
    display: flex;
    align-items: center;
    gap: 10px;
}

.status-bar {
    flex: 1;
    height: 8px;
    background: rgba(45, 49, 66, 0.5);
    border-radius: 4px;
    overflow: hidden;
}

.status-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.8s ease;
}

.status-completed { background: #28a745; }
.status-progress { background: #ffc107; }
.status-pending { background: #6c757d; }
.status-blocked { background: #dc3545; }

.status-label {
    color: #F1F1F1;
    font-size: 12px;
    min-width: 80px;
}

.status-percent {
    color: #6EE7B7;
    font-weight: 600;
    font-size: 12px;
    min-width: 35px;
    text-align: right;
}

/* Goals and Objectives */
.goal-item {
    margin-bottom: 20px;
    padding: 15px;
    background: rgba(45, 49, 66, 0.3);
    border-radius: 10px;
    border-left: 4px solid #5F5CFF;
}

.goal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.goal-title {
    color: #F1F1F1;
    font-weight: 600;
    font-size: 13px;
}

.goal-percentage {
    color: #6EE7B7;
    font-weight: bold;
    font-size: 14px;
}

.goal-progress {
    margin-bottom: 8px;
}

.goal-bar {
    height: 6px;
    background: rgba(45, 49, 66, 0.5);
    border-radius: 3px;
    overflow: hidden;
}

.goal-fill {
    height: 100%;
    background: linear-gradient(90deg, #5F5CFF 0%, #6EE7B7 100%);
    border-radius: 3px;
    transition: width 0.8s ease;
}

.goal-details {
    color: #B8BCC8;
    font-size: 11px;
}

/* Executive Alerts */
.executive-alerts, .executive-recommendations {
    background: rgba(13, 16, 23, 0.5);
    border-radius: 16px;
    padding: 20px;
    border: 1px solid #2D3142;
    height: 300px;
    overflow-y: auto;
}

.alerts-title, .recommendations-title {
    color: #5F5CFF;
    margin-bottom: 15px;
    font-weight: 600;
    padding-bottom: 10px;
    border-bottom: 1px solid #2D3142;
}

.alert-item, .recommendation-item-exec {
    padding: 12px;
    margin-bottom: 10px;
    border-radius: 8px;
    border-left: 4px solid var(--alert-color);
    background: rgba(45, 49, 66, 0.3);
    transition: all 0.3s ease;
}

.alert-item:hover, .recommendation-item-exec:hover {
    background: rgba(45, 49, 66, 0.5);
    transform: translateX(3px);
}

.alert-critical { --alert-color: #dc3545; }
.alert-high { --alert-color: #fd7e14; }
.alert-medium { --alert-color: #ffc107; }
.alert-low { --alert-color: #28a745; }

.alert-header, .rec-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
}

.alert-title, .rec-title {
    color: #F1F1F1;
    font-weight: 600;
    font-size: 13px;
}

.alert-priority, .rec-impact {
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 600;
    color: white;
}

.alert-description, .rec-description {
    color: #B8BCC8;
    font-size: 12px;
    line-height: 1.4;
}

/* Dashboard animations */
@keyframes kpiPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.kpi-card.highlight {
    animation: kpiPulse 2s infinite;
}

/* Responsive design */
@media (max-width: 768px) {
    .kpi-card {
        margin-bottom: 15px;
    }
    
    .executive-dashboard {
        padding: 20px;
    }
    
    .dashboard-controls {
        flex-direction: column;
        gap: 5px;
    }
}

/* ===========================================
   SISTEMA DE ALERTAS INTELIGENTES
   =========================================== */

.intelligent-alerts-system {
    position: fixed;
    top: 0;
    right: 0;
    z-index: 10000;
    pointer-events: none;
}

.intelligent-alerts-system * {
    pointer-events: auto;
}

/* Botão Flutuante de Alertas */
.alerts-floating-button {
    position: fixed;
    top: 20px;
    right: 20px;
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 8px 25px rgba(220, 53, 69, 0.4);
    z-index: 10001;
}

.alerts-floating-button:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 35px rgba(220, 53, 69, 0.6);
}

.alerts-floating-button i {
    color: white;
    font-size: 20px;
    z-index: 2;
}

.alert-count {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #fff;
    color: #dc3545;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
    border: 2px solid #dc3545;
    z-index: 3;
}

/* Animação de Pulso */
.pulse-ring {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 60px;
    height: 60px;
    border: 3px solid rgba(220, 53, 69, 0.6);
    border-radius: 50%;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
    }
    70% {
        transform: translate(-50%, -50%) scale(1.4);
        opacity: 0;
    }
    100% {
        transform: translate(-50%, -50%) scale(1.4);
        opacity: 0;
    }
}

/* Painel de Notificações */
.notifications-panel {
    position: fixed;
    top: 20px;
    right: 90px;
    width: 380px;
    max-height: 500px;
    background: linear-gradient(135deg, #23263B 0%, #2D3142 100%);
    border: 2px solid #dc3545;
    border-radius: 16px;
    overflow: hidden;
    transform: translateX(500px);
    transition: all 0.3s ease;
    box-shadow: 0 20px 40px rgba(0,0,0,0.4);
    z-index: 10000;
}

.notifications-panel.show {
    transform: translateX(0);
}

.panel-header {
    background: rgba(220, 53, 69, 0.1);
    padding: 15px 20px;
    border-bottom: 1px solid #dc3545;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.panel-header h6 {
    color: #F1F1F1;
    margin: 0;
    font-weight: 600;
}

.panel-controls {
    display: flex;
    gap: 8px;
}

.btn-mini {
    background: transparent;
    border: 1px solid rgba(241, 241, 241, 0.3);
    color: #F1F1F1;
    width: 32px;
    height: 32px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-mini:hover {
    background: rgba(220, 53, 69, 0.2);
    border-color: #dc3545;
}

.notifications-list {
    max-height: 350px;
    overflow-y: auto;
    padding: 10px;
}

.notification-item {
    background: rgba(45, 49, 66, 0.3);
    border-left: 4px solid var(--notification-color);
    border-radius: 8px;
    padding: 12px 15px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.notification-item:hover {
    background: rgba(45, 49, 66, 0.5);
    transform: translateX(5px);
}

.notification-item.unread {
    border-left-width: 6px;
    box-shadow: 0 2px 8px rgba(var(--notification-rgb), 0.3);
}

.notification-critical { 
    --notification-color: #dc3545; 
    --notification-rgb: 220, 53, 69;
}
.notification-high { 
    --notification-color: #fd7e14; 
    --notification-rgb: 253, 126, 20;
}
.notification-medium { 
    --notification-color: #ffc107; 
    --notification-rgb: 255, 193, 7;
}
.notification-low { 
    --notification-color: #28a745; 
    --notification-rgb: 40, 167, 69;
}

.notification-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.notification-title {
    color: #F1F1F1;
    font-weight: 600;
    font-size: 14px;
}

.notification-time {
    color: #B8BCC8;
    font-size: 11px;
}

.notification-message {
    color: #B8BCC8;
    font-size: 13px;
    line-height: 1.4;
    margin-bottom: 8px;
}

.notification-actions {
    display: flex;
    gap: 8px;
}

.notification-action {
    background: var(--notification-color);
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.notification-action:hover {
    opacity: 0.8;
    transform: translateY(-1px);
}

.panel-footer {
    background: rgba(220, 53, 69, 0.1);
    padding: 15px 20px;
    border-top: 1px solid #dc3545;
}

/* Configuração de Alertas */
.alert-config-section {
    margin-bottom: 20px;
}

.alert-config-section h6 {
    border-left: 4px solid #5F5CFF;
    padding-left: 12px;
}

/* Animações para novos alertas */
@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.notification-item.new {
    animation: slideInRight 0.5s ease-out;
}

/* Toast de Notificação */
.alert-toast {
    position: fixed;
    top: 100px;
    right: 20px;
    background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
    color: white;
    padding: 15px 20px;
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(220, 53, 69, 0.4);
    z-index: 10002;
    max-width: 350px;
    animation: slideInRight 0.5s ease-out;
}

.alert-toast.fade-out {
    animation: slideOutRight 0.5s ease-out forwards;
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

/* Responsive para alertas */
@media (max-width: 768px) {
    .notifications-panel {
        width: calc(100vw - 40px);
        right: 20px;
    }
    
    .alerts-floating-button {
        width: 50px;
        height: 50px;
    }
    
    .alert-count {
        width: 20px;
        height: 20px;
        font-size: 10px;
    }
}

/* Estados de alerta no botão flutuante */
.alerts-floating-button.critical {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    animation: criticalPulse 1s infinite;
}

.alerts-floating-button.high {
    background: linear-gradient(135deg, #fd7e14 0%, #e55a00 100%);
}

.alerts-floating-button.medium {
    background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
}

.alerts-floating-button.normal {
    background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
}

@keyframes criticalPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

/* Som visual para alertas críticos */
.visual-bell {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(220, 53, 69, 0.1);
    z-index: 9999;
    pointer-events: none;
    animation: flashAlert 0.5s ease-out;
}

@keyframes flashAlert {
    0%, 100% { opacity: 0; }
    50% { opacity: 1; }
}

/* ===========================================
   SISTEMA SIMPLIFICADO PNSB 2024
   =========================================== */

.simple-report {
    background: #23263B;
    border-radius: 16px;
    padding: 24px;
    border: 2px solid #2D3142;
}

.report-controls .btn {
    margin-left: 8px;
}

.stat-card {
    background: #2D3142;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    border: 1px solid #3A3F56;
    transition: all 0.3s ease;
}

.stat-card:hover {
    border-color: #5F5CFF;
    transform: translateY(-2px);
}

.stat-value {
    font-size: 32px;
    font-weight: bold;
    color: #6EE7B7;
    margin-bottom: 8px;
}

.stat-label {
    font-size: 14px;
    color: #B8BCC8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.simple-status-panel {
    background: #23263B;
    border-radius: 16px;
    padding: 24px;
    border: 2px solid #2D3142;
}

.municipios-status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 16px;
    margin-top: 20px;
}

.municipalities-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
    margin-top: 15px;
}

.municipality-item {
    background: rgba(45, 49, 66, 0.3);
    border-radius: 8px;
    padding: 8px;
    border: 1px solid transparent;
    transition: all 0.3s ease;
}

.municipality-item:hover {
    border-color: #5F5CFF;
    background: rgba(95, 92, 255, 0.1);
}

.municipality-checkbox {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    color: #F1F1F1;
    font-size: 14px;
}

.municipality-checkbox input[type="checkbox"] {
    accent-color: #5F5CFF;
}

.sequence-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 12px;
    background: rgba(45, 49, 66, 0.3);
    border-radius: 6px;
    margin-bottom: 8px;
}

.sequence-number {
    background: #5F5CFF;
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
}

.sequence-municipality {
    color: #F1F1F1;
    font-weight: 500;
}

/* Cards de Prioridade P1/P2/P3 */
.priority-card {
    background: #2D3142;
    border-radius: 12px;
    padding: 20px;
    border: 2px solid transparent;
    transition: all 0.3s ease;
}

.priority-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
}

.priority-p1 {
    border-color: #dc3545;
    background: linear-gradient(135deg, #2D3142 0%, #3d1a1a 100%);
}

.priority-p1:hover {
    border-color: #ff4757;
    box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3);
}

.priority-p2 {
    border-color: #ffc107;
    background: linear-gradient(135deg, #2D3142 0%, #3d3d1a 100%);
}

.priority-p2:hover {
    border-color: #ffda44;
    box-shadow: 0 8px 25px rgba(255, 193, 7, 0.3);
}

.priority-p3 {
    border-color: #6c757d;
    background: linear-gradient(135deg, #2D3142 0%, #2a2a2a 100%);
}

.priority-p3:hover {
    border-color: #adb5bd;
    box-shadow: 0 8px 25px rgba(108, 117, 125, 0.3);
}

.priority-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.priority-title {
    color: #F1F1F1;
    font-weight: 600;
    margin: 0;
    font-size: 16px;
}

.priority-progress {
    font-size: 18px;
    font-weight: bold;
    color: #6EE7B7;
}

.priority-description {
    color: #B8BCC8;
    font-size: 12px;
    margin-bottom: 15px;
}

.priority-stats {
    display: flex;
    justify-content: space-between;
    gap: 10px;
}

.priority-stats .stat-item {
    text-align: center;
    flex: 1;
}

.priority-stats .stat-value {
    font-size: 16px;
    font-weight: bold;
    color: #F1F1F1;
    display: block;
}

.priority-stats .stat-label {
    font-size: 11px;
    color: #B8BCC8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.priority-badge {
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.priority-content {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.priority-progress {
    text-align: center;
    padding: 10px;
    background: rgba(95, 92, 255, 0.1);
    border-radius: 8px;
    border: 1px solid rgba(95, 92, 255, 0.3);
}

.progress-value {
    font-size: 24px;
    font-weight: bold;
    color: #5F5CFF;
    display: block;
}

.progress-label {
    font-size: 12px;
    color: #B8BCC8;
    margin-top: 4px;
}

.algorithm-metrics {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}

.algorithm-metrics .metric {
    color: #B8BCC8;
    font-size: 12px;
}

.algorithm-metrics .metric strong {
    color: #6EE7B7;
}

/* Pattern Analysis */
.pattern-analysis {
    background: rgba(255, 193, 7, 0.05);
    border: 1px solid rgba(255, 193, 7, 0.2);
    border-radius: 16px;
    padding: 20px;
}

.patterns-list {
    background: rgba(13, 16, 23, 0.3);
    border-radius: 10px;
    padding: 15px;
    border: 1px solid #2D3142;
    min-height: 200px;
    overflow-y: auto;
}

.pattern-item {
    background: rgba(255, 193, 7, 0.1);
    border-left: 4px solid #ffc107;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 8px;
}

.pattern-title {
    color: #F1F1F1;
    font-weight: 600;
    font-size: 13px;
    margin-bottom: 4px;
}

.pattern-description {
    color: #B8BCC8;
    font-size: 11px;
    line-height: 1.4;
}

.pattern-confidence {
    color: #ffc107;
    font-size: 10px;
    font-weight: 600;
    margin-top: 4px;
}

/* Prediction Models */
.prediction-models {
    background: rgba(220, 53, 69, 0.05);
    border: 1px solid rgba(220, 53, 69, 0.2);
    border-radius: 16px;
    padding: 20px;
}

.model-performance {
    background: rgba(13, 16, 23, 0.3);
    border-radius: 10px;
    padding: 15px;
    border: 1px solid #2D3142;
}

.model-metric {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
}

.metric-label {
    color: #F1F1F1;
    font-size: 12px;
    min-width: 80px;
}

.metric-bar {
    flex: 1;
    height: 6px;
    background: rgba(45, 49, 66, 0.5);
    border-radius: 3px;
    overflow: hidden;
}

.metric-fill {
    height: 100%;
    background: linear-gradient(90deg, #dc3545 0%, #ffc107 50%, #28a745 100%);
    border-radius: 3px;
    transition: width 1s ease;
    animation: metricGlow 2s infinite alternate;
}

@keyframes metricGlow {
    0% { box-shadow: 0 0 5px rgba(220, 53, 69, 0.3); }
    100% { box-shadow: 0 0 15px rgba(40, 167, 69, 0.5); }
}

.metric-value {
    color: #6EE7B7;
    font-weight: 600;
    font-size: 12px;
    min-width: 35px;
    text-align: right;
}

/* Learning Insights */
.learning-insights {
    background: rgba(110, 231, 183, 0.05);
    border: 1px solid rgba(110, 231, 183, 0.2);
    border-radius: 16px;
    padding: 20px;
}

.insights-list {
    background: rgba(13, 16, 23, 0.3);
    border-radius: 10px;
    padding: 15px;
    border: 1px solid #2D3142;
    min-height: 200px;
    overflow-y: auto;
}

.insight-item {
    background: rgba(110, 231, 183, 0.1);
    border-left: 4px solid #6EE7B7;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 8px;
    transition: all 0.3s ease;
}

.insight-item:hover {
    background: rgba(110, 231, 183, 0.2);
    transform: translateX(3px);
}

.insight-title {
    color: #F1F1F1;
    font-weight: 600;
    font-size: 13px;
    margin-bottom: 4px;
}

.insight-description {
    color: #B8BCC8;
    font-size: 11px;
    line-height: 1.4;
}

.insight-impact {
    color: #6EE7B7;
    font-size: 10px;
    font-weight: 600;
    margin-top: 4px;
}

/* Personalized Recommendations */
.personalized-recommendations {
    background: rgba(0, 212, 255, 0.05);
    border: 1px solid rgba(0, 212, 255, 0.2);
    border-radius: 16px;
    padding: 25px;
}

.recommendations-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

.municipality-recommendation {
    background: rgba(13, 16, 23, 0.3);
    border: 1px solid #2D3142;
    border-radius: 12px;
    padding: 20px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.municipality-recommendation::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--recommendation-color, #00d4ff);
    border-radius: 12px 12px 0 0;
}

.municipality-recommendation:hover {
    border-color: var(--recommendation-color, #00d4ff);
    box-shadow: 0 8px 25px rgba(0, 212, 255, 0.1);
    transform: translateY(-3px);
}

.municipality-recommendation.high-priority {
    --recommendation-color: #dc3545;
}

.municipality-recommendation.medium-priority {
    --recommendation-color: #ffc107;
}

.municipality-recommendation.low-priority {
    --recommendation-color: #28a745;
}

.recommendation-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.municipality-name-rec {
    color: #F1F1F1;
    font-weight: 600;
    font-size: 16px;
}

.recommendation-score {
    background: var(--recommendation-color, #00d4ff);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
}

.recommendation-content {
    margin-bottom: 15px;
}

.recommendation-strategy {
    color: #F1F1F1;
    font-weight: 500;
    font-size: 14px;
    margin-bottom: 8px;
}

.recommendation-details {
    color: #B8BCC8;
    font-size: 12px;
    line-height: 1.4;
    margin-bottom: 10px;
}

.recommendation-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.recommendation-action {
    background: var(--recommendation-color, #00d4ff);
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.recommendation-action:hover {
    opacity: 0.8;
    transform: translateY(-1px);
}

/* Responsive ML Panel */
@media (max-width: 768px) {
    .ml-system-panel {
        padding: 20px;
    }
    
    .ml-controls {
        flex-direction: column;
        gap: 5px;
    }
    
    .recommendations-grid {
        grid-template-columns: 1fr;
    }
    
    .algorithm-metrics {
        flex-direction: column;
        gap: 8px;
    }
}

/* AI Thinking Animation */
.ai-thinking {
    display: inline-block;
    animation: aiThinking 1.5s infinite;
}

@keyframes aiThinking {
    0%, 80%, 100% { opacity: 0.3; }
    40% { opacity: 1; }
}

/* ========================================
   MOBILE APP NATIVO - PWA
   ======================================== */

/* Mobile App Container */
.mobile-app-container {
    background: linear-gradient(145deg, #1a1d2e 0%, #16213e 100%);
    border: 2px solid #2d4a75;
    border-radius: 20px;
    margin-bottom: 25px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    min-height: 400px;
}

/* Mobile Header */
.mobile-header {
    background: rgba(13, 16, 23, 0.8);
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #2D3142;
}

.status-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

.status-indicator.online .status-dot {
    background: #28a745;
    box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
}

.status-indicator.offline .status-dot {
    background: #dc3545;
    box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
}

.status-text {
    color: #F1F1F1;
    font-size: 12px;
    font-weight: 600;
}

.install-btn {
    background: linear-gradient(135deg, #5F5CFF 0%, #7B68EE 100%);
    border: none;
    color: white;
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(95, 92, 255, 0.3);
}

.install-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(95, 92, 255, 0.5);
}

/* Mobile Navigation */
.mobile-navigation {
    display: flex;
    background: rgba(13, 16, 23, 0.9);
    border-bottom: 1px solid #2D3142;
}

.nav-btn {
    flex: 1;
    background: transparent;
    border: none;
    color: #B8BCC8;
    padding: 12px 8px;
    font-size: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    border-bottom: 3px solid transparent;
}

.nav-btn:hover {
    background: rgba(95, 92, 255, 0.1);
    color: #F1F1F1;
}

.nav-btn.active {
    color: #5F5CFF;
    border-bottom-color: #5F5CFF;
    background: rgba(95, 92, 255, 0.05);
}

/* Mobile Content */
.mobile-content {
    padding: 20px;
    min-height: 300px;
}

.mobile-view {
    display: none;
}

.mobile-view.active {
    display: block;
}

/* Quick Actions */
.quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
}

.quick-action {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    border: none;
    color: white;
    padding: 12px 16px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
}

.quick-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(40, 167, 69, 0.5);
}

/* Offline Cards */
.offline-visit-card, .offline-contact-card {
    background: rgba(13, 16, 23, 0.6);
    border: 1px solid #2D3142;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
}

.offline-visit-card:hover, .offline-contact-card:hover {
    background: rgba(13, 16, 23, 0.8);
    border-color: #5F5CFF;
    transform: translateY(-1px);
}

.offline-visit-card.pending-sync {
    border-left: 4px solid #ffc107;
}

.visit-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.visit-header h4 {
    color: #F1F1F1;
    font-size: 14px;
    margin: 0;
}

.visit-status {
    background: #6c757d;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
}

.visit-details p {
    color: #B8BCC8;
    font-size: 11px;
    margin: 4px 0;
}

.sync-pending {
    color: #ffc107 !important;
    font-weight: 600;
}

/* Sync Status */
.sync-status {
    text-align: center;
    padding: 20px;
}

.sync-status h3 {
    color: #F1F1F1;
    margin-bottom: 15px;
}

.sync-queue-count {
    background: rgba(95, 92, 255, 0.1);
    border: 1px solid #5F5CFF;
    border-radius: 15px;
    padding: 15px;
    margin-bottom: 15px;
}

.queue-number {
    display: inline-block;
    background: #5F5CFF;
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    line-height: 30px;
    font-weight: bold;
    margin-right: 10px;
}

.sync-now-btn {
    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
    border: none;
    color: white;
    padding: 12px 20px;
    border-radius: 25px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(23, 162, 184, 0.3);
}

.sync-now-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(23, 162, 184, 0.5);
}

/* Mobile Notification */
.mobile-notification {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: rgba(13, 16, 23, 0.95);
    color: #F1F1F1;
    padding: 12px 20px;
    border-radius: 25px;
    border: 1px solid #5F5CFF;
    font-size: 12px;
    font-weight: 600;
    z-index: 10000;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    transition: all 0.3s ease;
    opacity: 0;
    max-width: 300px;
    text-align: center;
}

.mobile-notification.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
}

/* Offline Data Modal */
.offline-data-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
}

.modal-content {
    background: #23263B;
    border: 2px solid #2D3142;
    border-radius: 16px;
    padding: 25px;
    max-width: 400px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.modal-header h3 {
    color: #F1F1F1;
    margin: 0;
}

.close-modal {
    background: #dc3545;
    border: none;
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.data-summary {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-bottom: 20px;
}

.summary-item {
    text-align: center;
    padding: 15px;
    background: rgba(13, 16, 23, 0.5);
    border-radius: 10px;
    border: 1px solid #2D3142;
}

.summary-item .count {
    display: block;
    font-size: 24px;
    font-weight: bold;
    color: #5F5CFF;
    margin-bottom: 5px;
}

.summary-item .label {
    color: #B8BCC8;
    font-size: 12px;
}

.storage-info p {
    color: #B8BCC8;
    font-size: 12px;
    margin: 8px 0;
    text-align: center;
}

/* Responsive Design */
@media (max-width: 768px) {
    .mobile-app-container {
        border-radius: 0;
        margin: 0 -15px 25px -15px;
    }
    
    .mobile-content {
        padding: 15px;
    }
    
    .quick-actions {
        grid-template-columns: 1fr;
    }
    
    .nav-btn {
        padding: 15px 8px;
        font-size: 11px;
    }
}

/* PWA Specific Styles */
@media (display-mode: standalone) {
    .mobile-app-container {
        border-radius: 0;
        margin: 0;
        min-height: 100vh;
    }
    
    .mobile-header {
        padding-top: 25px; /* Account for status bar */
    }
}

/* ========================================
   API INTEGRATION PANEL
   ======================================== */

/* API Integration Container */
.api-integration-panel {
    background: linear-gradient(145deg, #1a1d2e 0%, #16213e 100%);
    border: 2px solid #2d4a75;
    border-radius: 20px;
    padding: 25px;
    margin-bottom: 25px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
}

.api-integration-panel::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
        radial-gradient(circle at 20% 20%, rgba(0, 212, 255, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(95, 92, 255, 0.05) 0%, transparent 50%);
    z-index: 1;
    pointer-events: none;
}

.api-integration-panel > * {
    position: relative;
    z-index: 2;
}

/* API Header */
.api-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid #2D3142;
}

.api-header h3 {
    color: #F1F1F1;
    margin: 0;
    font-size: 20px;
    font-weight: 700;
}

.api-controls {
    display: flex;
    gap: 10px;
}

.api-btn {
    background: linear-gradient(135deg, #5F5CFF 0%, #7B68EE 100%);
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 25px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(95, 92, 255, 0.3);
}

.api-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(95, 92, 255, 0.5);
}

.demographics-btn {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
}

.economic-btn {
    background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
}

/* API Status */
.api-status {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
    padding: 15px;
    background: rgba(13, 16, 23, 0.4);
    border-radius: 12px;
    border: 1px solid #2D3142;
}

.status-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.status-label {
    color: #B8BCC8;
    font-size: 12px;
    font-weight: 500;
}

.status-value {
    color: #F1F1F1;
    font-size: 12px;
    font-weight: 600;
}

/* API Data Tabs */
.api-data-tabs {
    display: flex;
    background: rgba(13, 16, 23, 0.6);
    border-radius: 12px;
    padding: 4px;
    margin-bottom: 20px;
    border: 1px solid #2D3142;
}

.tab-btn {
    flex: 1;
    background: transparent;
    border: none;
    color: #B8BCC8;
    padding: 10px 15px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.tab-btn:hover {
    background: rgba(95, 92, 255, 0.1);
    color: #F1F1F1;
}

.tab-btn.active {
    background: linear-gradient(135deg, #5F5CFF 0%, #7B68EE 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(95, 92, 255, 0.3);
}

/* Tab Content */
.api-data-content {
    min-height: 400px;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

/* Municipal Data Grid */
.municipal-data-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

.data-card {
    background: rgba(13, 16, 23, 0.6);
    border: 1px solid #2D3142;
    border-radius: 12px;
    padding: 20px;
    transition: all 0.3s ease;
}

.data-card:hover {
    background: rgba(13, 16, 23, 0.8);
    border-color: #5F5CFF;
    transform: translateY(-2px);
}

.data-card h4 {
    color: #F1F1F1;
    margin: 0 0 15px 0;
    font-size: 16px;
    font-weight: 600;
}

/* Municipal Items */
.municipal-item {
    background: rgba(95, 92, 255, 0.05);
    border: 1px solid rgba(95, 92, 255, 0.2);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
}

.municipal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.municipal-header strong {
    color: #F1F1F1;
    font-size: 14px;
}

.municipal-id {
    background: #5F5CFF;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
}

.municipal-details p {
    color: #B8BCC8;
    font-size: 11px;
    margin: 4px 0;
}

/* Admin Structure */
.admin-summary {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-bottom: 15px;
}

.admin-stat {
    text-align: center;
    padding: 12px;
    background: rgba(95, 92, 255, 0.1);
    border-radius: 8px;
    border: 1px solid rgba(95, 92, 255, 0.2);
}

.stat-number {
    display: block;
    font-size: 24px;
    font-weight: bold;
    color: #5F5CFF;
    margin-bottom: 4px;
}

.stat-label {
    color: #B8BCC8;
    font-size: 11px;
}

.admin-details h5 {
    color: #F1F1F1;
    margin: 10px 0 5px 0;
    font-size: 13px;
}

.admin-details ul {
    list-style: none;
    padding: 0;
    margin: 0 0 15px 0;
}

.admin-details li {
    color: #B8BCC8;
    font-size: 11px;
    padding: 2px 0;
    border-left: 3px solid #5F5CFF;
    padding-left: 8px;
    margin-bottom: 4px;
}

/* Demographic Charts */
.demographic-charts {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.chart-container {
    background: rgba(13, 16, 23, 0.6);
    border: 1px solid #2D3142;
    border-radius: 12px;
    padding: 20px;
    height: 300px;
}

.demographic-stats {
    background: rgba(13, 16, 23, 0.6);
    border: 1px solid #2D3142;
    border-radius: 12px;
    padding: 20px;
}

/* Demographic Summary */
.demographic-summary {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin-bottom: 20px;
}

.demo-stat {
    text-align: center;
    padding: 15px;
    background: rgba(40, 167, 69, 0.1);
    border-radius: 8px;
    border: 1px solid rgba(40, 167, 69, 0.2);
}

.demo-stat .stat-number {
    color: #28a745;
}

/* Population List */
.population-list h5 {
    color: #F1F1F1;
    margin: 0 0 10px 0;
    font-size: 14px;
}

.pop-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #2D3142;
}

.pop-name {
    color: #B8BCC8;
    font-size: 11px;
}

.pop-value {
    color: #28a745;
    font-size: 11px;
    font-weight: 600;
}

/* Economic Indicators */
.economic-indicators {
    background: rgba(13, 16, 23, 0.6);
    border: 1px solid #2D3142;
    border-radius: 12px;
    padding: 20px;
}

.economic-summary {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin-bottom: 20px;
}

.econ-stat {
    text-align: center;
    padding: 15px;
    background: rgba(255, 193, 7, 0.1);
    border-radius: 8px;
    border: 1px solid rgba(255, 193, 7, 0.2);
}

.econ-stat .stat-number {
    color: #ffc107;
}

/* PIB Ranking */
.pib-ranking h5 {
    color: #F1F1F1;
    margin: 0 0 15px 0;
    font-size: 14px;
}

.pib-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    border-bottom: 1px solid #2D3142;
}

.rank {
    background: #ffc107;
    color: #212529;
    width: 25px;
    height: 25px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: bold;
}

.pib-name {
    flex: 1;
    color: #B8BCC8;
    font-size: 11px;
}

.pib-value {
    color: #ffc107;
    font-size: 11px;
    font-weight: 600;
}

/* Geographic Info */
.geographic-info {
    background: rgba(13, 16, 23, 0.6);
    border: 1px solid #2D3142;
    border-radius: 12px;
    padding: 20px;
}

.geo-summary h4 {
    color: #F1F1F1;
    margin: 0 0 15px 0;
    font-size: 16px;
}

.density-list {
    max-height: 300px;
    overflow-y: auto;
}

.density-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #2D3142;
}

.density-name {
    color: #B8BCC8;
    font-size: 11px;
}

.density-value {
    color: #17a2b8;
    font-size: 11px;
    font-weight: 600;
}

/* PIB Per Capita */
.pib-per-capita {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 2px solid #2D3142;
}

.pib-per-capita h5 {
    color: #F1F1F1;
    margin: 0 0 15px 0;
    font-size: 14px;
}

.pib-pc-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #2D3142;
}

.pc-name {
    color: #B8BCC8;
    font-size: 11px;
}

.pc-value {
    color: #ffc107;
    font-size: 11px;
    font-weight: 600;
}

/* API Error Notification */
.api-error-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(220, 53, 69, 0.95);
    border: 2px solid #dc3545;
    border-radius: 12px;
    padding: 0;
    z-index: 10000;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    animation: slideInRight 0.3s ease;
    max-width: 350px;
}

.error-content {
    padding: 15px;
}

.error-content h4 {
    color: white;
    margin: 0 0 8px 0;
    font-size: 14px;
}

.error-content p {
    color: rgba(255, 255, 255, 0.9);
    margin: 0 0 10px 0;
    font-size: 12px;
}

.error-content button {
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 11px;
    cursor: pointer;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Responsive Design */
@media (max-width: 768px) {
    .api-integration-panel {
        padding: 15px;
        margin: 0 -15px 25px -15px;
        border-radius: 0;
    }
    
    .api-header {
        flex-direction: column;
        gap: 15px;
    }
    
    .api-controls {
        width: 100%;
        justify-content: center;
    }
    
    .api-status {
        grid-template-columns: 1fr;
    }
    
    .municipal-data-grid {
        grid-template-columns: 1fr;
    }
    
    .demographic-charts {
        grid-template-columns: 1fr;
    }
    
    .chart-container {
        height: 250px;
    }
}

/* ========================================
   CALENDÁRIO DE VISITAS PNSB
   ======================================== */

.calendar-panel {
    background: #23263B;
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 25px;
    border: 2px solid #2D3142;
}

.calendar-container {
    background: #2D3142;
    border-radius: 12px;
    padding: 20px;
}

.calendar-navigation {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #3A3F56;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    margin-top: 10px;
}

.calendar-day-header {
    background: #3A3F56;
    color: #B8BCC8;
    text-align: center;
    padding: 10px 5px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.calendar-day {
    background: #23263B;
    border: 1px solid #3A3F56;
    min-height: 80px;
    padding: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.calendar-day:hover {
    background: #2D3142;
    border-color: #5F5CFF;
}

.calendar-day.selected {
    background: #5F5CFF;
    border-color: #7C78FF;
}

.calendar-day.other-month {
    opacity: 0.3;
}

.calendar-day.today {
    border: 2px solid #6EE7B7;
}

.day-number {
    font-size: 14px;
    font-weight: 600;
    color: #F1F1F1;
    margin-bottom: 5px;
}

.day-visits {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.visit-indicator {
    background: #5F5CFF;
    color: white;
    font-size: 10px;
    padding: 2px 4px;
    border-radius: 3px;
    text-overflow: ellipsis;
    overflow: hidden;
    white-space: nowrap;
}

.visit-indicator.status-agendada { background: #6c757d; }
.visit-indicator.status-em-andamento { background: #ffc107; }
.visit-indicator.status-realizada { background: #17a2b8; }
.visit-indicator.status-finalizada { background: #28a745; }

.day-details-panel {
    background: #2D3142;
    border-radius: 12px;
    padding: 20px;
}

.visits-list {
    max-height: 300px;
    overflow-y: auto;
}

.visit-item {
    background: #23263B;
    border: 1px solid #3A3F56;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
}

.visit-item:hover {
    border-color: #5F5CFF;
    transform: translateY(-1px);
}

.visit-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 8px;
}

.visit-time {
    font-size: 14px;
    font-weight: 600;
    color: #6EE7B7;
}

.visit-status {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 12px;
    color: white;
}

.visit-municipality {
    font-size: 13px;
    color: #F1F1F1;
    font-weight: 500;
}

.visit-local {
    font-size: 11px;
    color: #B8BCC8;
    margin-top: 4px;
}

.month-stats {
    background: #23263B;
    border-radius: 8px;
    padding: 15px;
    border: 1px solid #3A3F56;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin-top: 10px;
}

.stat-item {
    text-align: center;
}

.stat-item .stat-value {
    font-size: 18px;
    font-weight: bold;
    color: #5F5CFF;
}

.stat-item .stat-label {
    font-size: 11px;
    color: #B8BCC8;
    text-transform: uppercase;
}

.empty-state {
    color: #6c757d;
}

/* Modal customizado */
.modal-content.bg-dark {
    background-color: #23263B !important;
    border: 1px solid #2D3142;
}

.btn-close-white {
    filter: invert(1) grayscale(100%) brightness(200%);
}

/* Responsive */
@media (max-width: 768px) {
    .calendar-panel {
        padding: 15px;
    }
    
    .calendar-day {
        min-height: 60px;
        padding: 5px;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
        gap: 10px;
    }
}

/* ========================================
   ANÁLISE PREDITIVA AVANÇADA
   ======================================== */

/* Predictive Analysis Container */
.predictive-analysis-panel {
    background: linear-gradient(145deg, #1a1d2e 0%, #16213e 100%);
    border: 2px solid #2d4a75;
    border-radius: 20px;
    padding: 25px;
    margin-bottom: 25px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
}

.predictive-analysis-panel::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
        radial-gradient(circle at 20% 20%, rgba(255, 99, 132, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(54, 162, 235, 0.05) 0%, transparent 50%);
    z-index: 1;
    pointer-events: none;
}

.predictive-analysis-panel > * {
    position: relative;
    z-index: 2;
}

/* Predictive Header */
.predictive-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid #2D3142;
}

.predictive-header h3 {
    color: #F1F1F1;
    margin: 0;
    font-size: 20px;
    font-weight: 700;
}

.predictive-controls {
    display: flex;
    gap: 10px;
}

.pred-btn {
    background: linear-gradient(135deg, #ff6384 0%, #ff8a9b 100%);
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 25px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(255, 99, 132, 0.3);
}

.pred-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(255, 99, 132, 0.5);
}

.forecast-btn {
    background: linear-gradient(135deg, #36a2eb 0%, #4bc0c0 100%);
}

.simulation-btn {
    background: linear-gradient(135deg, #ffce56 0%, #ff9f40 100%);
}

/* Scenario Builder */
.scenario-builder {
    background: rgba(13, 16, 23, 0.8);
    border: 2px solid #2D3142;
    border-radius: 16px;
    padding: 25px;
    margin-bottom: 25px;
}

.scenario-builder h4 {
    color: #F1F1F1;
    margin: 0 0 20px 0;
    font-size: 18px;
}

.scenario-form {
    display: grid;
    gap: 15px;
}

.form-row {
    display: grid;
    grid-template-columns: 150px 1fr auto;
    gap: 15px;
    align-items: center;
}

.form-row label {
    color: #B8BCC8;
    font-size: 12px;
    font-weight: 600;
}

.form-row input, .form-row select {
    background: rgba(13, 16, 23, 0.6);
    border: 1px solid #2D3142;
    border-radius: 8px;
    color: #F1F1F1;
    padding: 8px 12px;
    font-size: 12px;
}

.form-row input[type="range"] {
    background: transparent;
}

#success-rate-value {
    background: #5F5CFF;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    min-width: 40px;
    text-align: center;
}

.form-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 15px;
}

.create-btn {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
}

.cancel-btn {
    background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
}

/* Forecast Section */
.forecast-section {
    margin-bottom: 30px;
}

.forecast-section h4 {
    color: #F1F1F1;
    margin: 0 0 20px 0;
    font-size: 16px;
}

.forecast-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.forecast-card {
    background: rgba(13, 16, 23, 0.6);
    border: 1px solid #2D3142;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    transition: all 0.3s ease;
}

.forecast-card:hover {
    background: rgba(13, 16, 23, 0.8);
    border-color: #ff6384;
    transform: translateY(-2px);
}

.forecast-title {
    color: #B8BCC8;
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 10px;
}

.forecast-value {
    color: #F1F1F1;
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 8px;
}

.forecast-trend {
    font-size: 11px;
    font-weight: 600;
    color: #28a745;
}

/* Scenarios Section */
.scenarios-section {
    margin-bottom: 30px;
}

.scenarios-section h4 {
    color: #F1F1F1;
    margin: 0 0 20px 0;
    font-size: 16px;
}

.scenarios-tabs {
    display: flex;
    background: rgba(13, 16, 23, 0.6);
    border-radius: 12px;
    padding: 4px;
    margin-bottom: 20px;
    border: 1px solid #2D3142;
}

.scenario-tab {
    flex: 1;
    background: transparent;
    border: none;
    color: #B8BCC8;
    padding: 10px 15px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.scenario-tab:hover {
    background: rgba(255, 99, 132, 0.1);
    color: #F1F1F1;
}

.scenario-tab.active {
    background: linear-gradient(135deg, #ff6384 0%, #ff8a9b 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(255, 99, 132, 0.3);
}

.scenario-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.scenario-chart-container {
    background: rgba(13, 16, 23, 0.6);
    border: 1px solid #2D3142;
    border-radius: 12px;
    padding: 20px;
    height: 300px;
}

.scenario-insights {
    background: rgba(13, 16, 23, 0.6);
    border: 1px solid #2D3142;
    border-radius: 12px;
    padding: 20px;
}

.insight-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    border-bottom: 1px solid #2D3142;
}

.insight-icon {
    font-size: 16px;
}

.insight-text {
    color: #B8BCC8;
    font-size: 12px;
    line-height: 1.4;
}

/* Monte Carlo Section */
.monte-carlo-section {
    margin-bottom: 30px;
}

.monte-carlo-section h4 {
    color: #F1F1F1;
    margin: 0 0 20px 0;
    font-size: 16px;
}

.monte-carlo-controls {
    display: flex;
    gap: 20px;
    align-items: center;
    margin-bottom: 20px;
    padding: 15px;
    background: rgba(13, 16, 23, 0.4);
    border-radius: 12px;
    border: 1px solid #2D3142;
}

.control-group {
    display: flex;
    align-items: center;
    gap: 8px;
}

.control-group label {
    color: #B8BCC8;
    font-size: 12px;
    font-weight: 600;
}

.control-group select {
    background: rgba(13, 16, 23, 0.6);
    border: 1px solid #2D3142;
    border-radius: 8px;
    color: #F1F1F1;
    padding: 6px 10px;
    font-size: 11px;
}

.run-mc-btn {
    background: linear-gradient(135deg, #ffce56 0%, #ff9f40 100%);
}

.monte-carlo-results {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 20px;
}

.mc-chart-container {
    background: rgba(13, 16, 23, 0.6);
    border: 1px solid #2D3142;
    border-radius: 12px;
    padding: 20px;
    height: 300px;
}

.mc-statistics {
    background: rgba(13, 16, 23, 0.6);
    border: 1px solid #2D3142;
    border-radius: 12px;
    padding: 20px;
}

.mc-stat {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #2D3142;
}

.mc-label {
    color: #B8BCC8;
    font-size: 12px;
}

.mc-value {
    color: #ffce56;
    font-size: 12px;
    font-weight: 600;
}

/* Recommendations Section */
.recommendations-section h4 {
    color: #F1F1F1;
    margin: 0 0 20px 0;
    font-size: 16px;
}

.recommendations-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 15px;
}

.rec-card {
    background: rgba(13, 16, 23, 0.6);
    border: 1px solid #2D3142;
    border-radius: 12px;
    padding: 20px;
    transition: all 0.3s ease;
}

.rec-card:hover {
    background: rgba(13, 16, 23, 0.8);
    transform: translateY(-2px);
}

.rec-card.priority-high {
    border-left: 4px solid #dc3545;
}

.rec-card.priority-medium {
    border-left: 4px solid #ffc107;
}

.rec-card.priority-low {
    border-left: 4px solid #28a745;
}

.rec-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.rec-priority {
    background: rgba(220, 53, 69, 0.2);
    color: #dc3545;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
}

.rec-card.priority-medium .rec-priority {
    background: rgba(255, 193, 7, 0.2);
    color: #ffc107;
}

.rec-card.priority-low .rec-priority {
    background: rgba(40, 167, 69, 0.2);
    color: #28a745;
}

.rec-impact {
    color: #B8BCC8;
    font-size: 10px;
    font-weight: 600;
}

.rec-title {
    color: #F1F1F1;
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 8px;
}

.rec-description {
    color: #B8BCC8;
    font-size: 12px;
    line-height: 1.4;
    margin-bottom: 10px;
}

.rec-timeline {
    color: #36a2eb;
    font-size: 11px;
    font-weight: 600;
}

/* Responsive Design */
@media (max-width: 768px) {
    .predictive-analysis-panel {
        padding: 15px;
        margin: 0 -15px 25px -15px;
        border-radius: 0;
    }
    
    .predictive-header {
        flex-direction: column;
        gap: 15px;
    }
    
    .predictive-controls {
        width: 100%;
        justify-content: center;
    }
    
    .form-row {
        grid-template-columns: 1fr;
        gap: 8px;
    }
    
    .forecast-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .scenario-content {
        grid-template-columns: 1fr;
    }
    
    .monte-carlo-results {
        grid-template-columns: 1fr;
    }
    
    .recommendations-grid {
        grid-template-columns: 1fr;
    }
}

/* Neural Network Background */
.ml-system-panel::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: 
        radial-gradient(circle at 20% 50%, rgba(0, 212, 255, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(95, 92, 255, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(110, 231, 183, 0.03) 0%, transparent 50%);
    pointer-events: none;
    z-index: 1;
}

.ml-system-panel > * {
    position: relative;
    z-index: 2;
}

/* ESTILOS PNSB FOCUSED - TRABALHO DE CAMPO */
.pnsb-focused {
    border-left: 4px solid #5F5CFF;
    background: linear-gradient(90deg, #5F5CFF10, transparent);
}

.municipio-urgente {
    border-left: 4px solid #dc3545;
    background: linear-gradient(90deg, #dc354520, transparent);
    animation: pulse-urgent 2s infinite;
}

@keyframes pulse-urgent {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
}

.status-validado {
    border: 2px solid #28a745;
    background: linear-gradient(135deg, #28a74520, #007bff10);
}

.pnsb-actions {
    position: sticky;
    bottom: 20px;
    z-index: 100;
    text-align: center;
    margin-top: 20px;
}

.btn-pnsb {
    background: linear-gradient(90deg, #5F5CFF, #6EE7B7);
    border: none;
    color: white;
    padding: 12px 24px;
    border-radius: 25px;
    font-weight: 600;
    margin: 0 8px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(95, 92, 255, 0.3);
}

.btn-pnsb:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(95, 92, 255, 0.4);
    color: white;
}

.info-rapida {
    background: #23263B;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    border-left: 4px solid #17a2b8;
}

.info-rapida h6 {
    color: #17a2b8;
    margin-bottom: 8px;
    font-weight: 600;
}

.progresso-visual {
    height: 8px;
    background: #2D3142;
    border-radius: 4px;
    overflow: hidden;
    margin: 8px 0;
}

.progresso-barra {
    height: 100%;
    background: linear-gradient(90deg, #5F5CFF, #6EE7B7);
    transition: width 0.5s ease;
}

.contato-rapido {
    background: #2D3142;
    border-radius: 6px;
    padding: 8px 12px;
    margin: 5px 0;
    border-left: 3px solid #ffc107;
    font-size: 14px;
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex flex-wrap align-items-center justify-content-between mb-4">
    <h2 class="fw-bold mb-0">🗺️ Mapa de Progresso PNSB</h2>
    <div class="d-flex gap-2">
        <button class="btn-primary-custom" onclick="atualizarDados()">
            <i class="fas fa-sync"></i> Atualizar
        </button>
        <button class="btn-success-custom" onclick="exportarMapa()">
            <i class="fas fa-download"></i> Exportar
        </button>
        <button class="btn-info-custom" onclick="alternarVista()">
            <i class="fas fa-layer-group"></i> <span id="view-toggle-text">Vista Lista</span>
        </button>
        <button class="btn-success-custom" onclick="alternarCalendario()">
            <i class="fas fa-calendar-alt"></i> Calendário
        </button>
    </div>
</div>

<!-- Filtros Essenciais -->
<div class="filters-essential">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="text-light mb-0"><i class="fas fa-filter"></i> Filtros</h6>
        <button class="btn btn-sm btn-outline-light" onclick="limparFiltros()">
            <i class="fas fa-eraser"></i> Limpar
        </button>
    </div>
    
    <div class="row g-3 mb-3">
        <div class="col-md-4">
            <select class="form-select bg-dark text-light" id="filtro-tipo" onchange="aplicarFiltros()">
                <option value="">📋 Todos os Tipos</option>
                <option value="MRS">🗑️ MRS - Manejo de Resíduos Sólidos</option>
                <option value="MAP">🌧️ MAP - Manejo de Águas Pluviais</option>
            </select>
        </div>
        <div class="col-md-4">
            <select class="form-select bg-dark text-light" id="filtro-municipio" onchange="aplicarFiltros()">
                <option value="">🏛️ Todos os Municípios</option>
                <option value="Balneário Camboriú">Balneário Camboriú</option>
                <option value="Balneário Piçarras">Balneário Piçarras</option>
                <option value="Bombinhas">Bombinhas</option>
                <option value="Camboriú">Camboriú</option>
                <option value="Itajaí">Itajaí</option>
                <option value="Itapema">Itapema</option>
                <option value="Luiz Alves">Luiz Alves</option>
                <option value="Navegantes">Navegantes</option>
                <option value="Penha">Penha</option>
                <option value="Porto Belo">Porto Belo</option>
                <option value="Ilhota">Ilhota</option>
            </select>
        </div>
        <div class="col-md-4">
            <select class="form-select bg-dark text-light" id="filtro-status" onchange="aplicarFiltros()">
                <option value="">📊 Todos os Status</option>
                <option value="pending">⏳ Pendentes</option>
                <option value="in-progress">🔄 Em Progresso</option>
                <option value="completed">✅ Finalizados</option>
                <option value="blocked">🚫 Bloqueados</option>
            </select>
        </div>
    </div>
</div>

<!-- Legenda -->
<div class="legend-container">
    <h6 class="text-light mb-3">Legenda do Progresso</h6>
    <div class="row">
        <div class="col-md-3">
            <div class="legend-item">
                <div class="legend-color" style="background: #28a745;"></div>
                <span class="text-light">Completo (100%)</span>
            </div>
        </div>
        <div class="col-md-3">
            <div class="legend-item">
                <div class="legend-color" style="background: #ffc107;"></div>
                <span class="text-light">Em Progresso (50-99%)</span>
            </div>
        </div>
        <div class="col-md-3">
            <div class="legend-item">
                <div class="legend-color" style="background: #17a2b8;"></div>
                <span class="text-light">Iniciado (1-49%)</span>
            </div>
        </div>
        <div class="col-md-3">
            <div class="legend-item">
                <div class="legend-color" style="background: #6c757d;"></div>
                <span class="text-light">Não Iniciado (0%)</span>
            </div>
        </div>
    </div>
</div>

<!-- Container do Mapa -->
<div class="map-container" id="map-view">
    <div id="mapa-progresso"></div>
    
    <!-- Controles do Mapa -->
    <div class="map-controls">
        <button class="control-btn" onclick="centralizarMapa()" title="Centralizar">
            <i class="fas fa-crosshairs"></i>
        </button>
        <button class="control-btn" onclick="toggleFullscreen()" title="Tela Cheia">
            <i class="fas fa-expand"></i>
        </button>
        <button class="control-btn" onclick="exportarImagem()" title="Exportar Imagem">
            <i class="fas fa-camera"></i>
        </button>
        <button class="control-btn" onclick="toggleMeasureMode()" title="Medir Distância">
            <i class="fas fa-ruler"></i>
        </button>
        <button class="control-btn" onclick="toggleRouteOptimizer()" title="Otimizar Rotas">
            <i class="fas fa-route"></i>
        </button>
    </div>
    
    <!-- Legenda do Heatmap -->
    <div class="heatmap-legend" id="heatmap-legend">
        <h6><i class="fas fa-fire"></i> Intensidade do Progresso</h6>
        <div class="legend-scale">
            <div class="legend-color-gradient"></div>
        </div>
        <div class="legend-labels">
            <span>Crítico</span>
            <span>Baixo</span>
            <span>Médio</span>
            <span>Alto</span>
            <span>Completo</span>
        </div>
        <div class="mt-2">
            <small class="text-muted">
                <i class="fas fa-circle text-danger"></i> Alta Prioridade
                <i class="fas fa-circle text-warning ms-2"></i> Média Prioridade
                <i class="fas fa-circle text-secondary ms-2"></i> Baixa Prioridade
            </small>
        </div>
    </div>
    
    <!-- Painel de Otimização de Rotas -->
    <div class="route-optimizer-panel" id="route-optimizer-panel" style="display: none;">
        <div class="route-panel-header">
            <h6><i class="fas fa-route"></i> Otimização de Rotas Inteligente</h6>
            <button class="btn btn-sm btn-outline-light" onclick="toggleRouteOptimizer()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="route-configuration">
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label class="form-label">Data da Rota</label>
                    <input type="date" class="form-control bg-dark text-light" id="route-date" value="">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Origem</label>
                    <select class="form-select bg-dark text-light" id="route-origin">
                        <option value="Itajaí">Itajaí (Base IBGE)</option>
                        <option value="Balneário Camboriú">Balneário Camboriú</option>
                        <option value="Navegantes">Navegantes</option>
                    </select>
                </div>
            </div>
            
            <div class="route-options mb-3">
                <h6 class="text-light">🧠 Critérios de Otimização Inteligente</h6>
                <div class="intelligent-criteria-grid">
                    <div class="criteria-option">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="route-criteria" value="intelligent" id="criteria-intelligent" checked>
                            <label class="form-check-label" for="criteria-intelligent">
                                <div class="criteria-header">
                                    <i class="fas fa-brain"></i>
                                    <span class="criteria-title">Inteligente</span>
                                </div>
                                <div class="criteria-description">
                                    Considera visitas passadas, urgência, progresso e proximidade
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="criteria-option">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="route-criteria" value="urgent_visits" id="criteria-urgent">
                            <label class="form-check-label" for="criteria-urgent">
                                <div class="criteria-header">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <span class="criteria-title">Urgência</span>
                                </div>
                                <div class="criteria-description">
                                    Prioriza visitas atrasadas e municípios nunca visitados
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="criteria-option">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="route-criteria" value="completion_focus" id="criteria-completion">
                            <label class="form-check-label" for="criteria-completion">
                                <div class="criteria-header">
                                    <i class="fas fa-tasks"></i>
                                    <span class="criteria-title">Finalização</span>
                                </div>
                                <div class="criteria-description">
                                    Foca em completar questionários pendentes e progresso baixo
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="criteria-option">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="route-criteria" value="visit_sequence" id="criteria-sequence">
                            <label class="form-check-label" for="criteria-sequence">
                                <div class="criteria-header">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span class="criteria-title">Sequencial</span>
                                </div>
                                <div class="criteria-description">
                                    Baseado no histórico e agenda de visitas
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="criteria-option">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="route-criteria" value="balanced" id="criteria-balanced">
                            <label class="form-check-label" for="criteria-balanced">
                                <div class="criteria-header">
                                    <i class="fas fa-balance-scale"></i>
                                    <span class="criteria-title">Balanceado</span>
                                </div>
                                <div class="criteria-description">
                                    Equilibra urgência, progresso, distância e complexidade
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="criteria-option">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="route-criteria" value="distance" id="criteria-distance">
                            <label class="form-check-label" for="criteria-distance">
                                <div class="criteria-header">
                                    <i class="fas fa-route"></i>
                                    <span class="criteria-title">Distância</span>
                                </div>
                                <div class="criteria-description">
                                    Otimização geográfica tradicional (menor distância)
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="municipalities-selection">
                <h6 class="text-light">Municípios para Visitar</h6>
                <div class="municipalities-grid" id="municipalities-grid">
                    <!-- Será populado dinamicamente -->
                </div>
            </div>
            
            <div class="route-actions mt-3">
                <button class="btn btn-primary" onclick="calcularRotaOtimizada()">
                    <i class="fas fa-calculator"></i> Calcular Rota
                </button>
                <button class="btn btn-success" onclick="exportarRota()">
                    <i class="fas fa-download"></i> Exportar
                </button>
                <button class="btn btn-info" onclick="simularTempo()">
                    <i class="fas fa-clock"></i> Simular Tempo
                </button>
            </div>
        </div>
        
        <!-- Resultado da Otimização -->
        <div class="route-result" id="route-result" style="display: none;">
            <h6 class="text-light"><i class="fas fa-check-circle"></i> Rota Otimizada</h6>
            <div class="route-summary">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="route-stat">
                            <div class="route-stat-value" id="route-distance">--</div>
                            <div class="route-stat-label">Distância Total</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="route-stat">
                            <div class="route-stat-value" id="route-duration">--</div>
                            <div class="route-stat-label">Tempo Estimado</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="route-stat">
                            <div class="route-stat-value" id="route-municipalities">--</div>
                            <div class="route-stat-label">Municípios</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="route-stat">
                            <div class="route-stat-value" id="route-efficiency">--</div>
                            <div class="route-stat-label">Eficiência</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="route-sequence mt-3">
                <h6 class="text-light">Sequência Sugerida</h6>
                <div class="sequence-list" id="sequence-list">
                    <!-- Será populado dinamicamente -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Vista em Lista (inicialmente oculta) -->
<div class="row g-3" id="list-view" style="display: none;">
    <!-- Será populado dinamicamente -->
</div>

<!-- Painel de Calendário com Visitas e Rotas -->
<div class="calendar-panel" id="calendar-panel" style="display: none;">
    <div class="calendar-header">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="text-light mb-0">
                <i class="fas fa-calendar-alt"></i> Calendário de Visitas PNSB 2024
            </h5>
            <div class="calendar-controls">
                <button class="btn btn-outline-light btn-sm me-2" onclick="toggleCalendarView()">
                    <i class="fas fa-table"></i> Vista Mensal
                </button>
                <button class="btn btn-primary btn-sm me-2" onclick="carregarVisitasCalendario()">
                    <i class="fas fa-sync"></i> Atualizar
                </button>
                <button class="btn btn-success btn-sm" onclick="otimizarRotasDia()">
                    <i class="fas fa-route"></i> Otimizar Rotas do Dia
                </button>
            </div>
        </div>
    </div>
    
    <div class="row g-4">
        <!-- Calendário Principal -->
        <div class="col-md-8">
            <div class="calendar-container">
                <div class="calendar-navigation">
                    <button class="btn btn-sm btn-outline-light" onclick="navegarMes(-1)">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <h6 class="text-light mx-3 mb-0" id="calendar-month-year">Janeiro 2024</h6>
                    <button class="btn btn-sm btn-outline-light" onclick="navegarMes(1)">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                
                <div class="calendar-grid" id="calendar-grid">
                    <!-- Será gerado dinamicamente -->
                </div>
            </div>
        </div>
        
        <!-- Painel Lateral - Detalhes do Dia -->
        <div class="col-md-4">
            <div class="day-details-panel">
                <h6 class="text-light">
                    <i class="fas fa-calendar-day"></i> Visitas de <span id="selected-date">Hoje</span>
                </h6>
                
                <div class="visits-list" id="visits-list">
                    <div class="empty-state text-center text-muted py-4">
                        <i class="fas fa-calendar-plus fa-2x mb-2"></i>
                        <p>Selecione uma data para ver as visitas</p>
                    </div>
                </div>
                
                <div class="day-actions mt-3" id="day-actions" style="display: none;">
                    <button class="btn btn-primary btn-sm w-100 mb-2" onclick="adicionarVisitaDia()">
                        <i class="fas fa-plus"></i> Nova Visita
                    </button>
                    <button class="btn btn-success btn-sm w-100 mb-2" onclick="otimizarRotaDia()">
                        <i class="fas fa-route"></i> Otimizar Rota
                    </button>
                    <button class="btn btn-info btn-sm w-100" onclick="exportarRotaDia()">
                        <i class="fas fa-download"></i> Exportar Agenda
                    </button>
                </div>
                
                <!-- Estatísticas do Mês -->
                <div class="month-stats mt-4">
                    <h6 class="text-light">
                        <i class="fas fa-chart-pie"></i> Estatísticas do Mês
                    </h6>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="total-visits-month">0</div>
                            <div class="stat-label">Visitas Agendadas</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="completed-visits-month">0</div>
                            <div class="stat-label">Concluídas</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="municipalities-month">0</div>
                            <div class="stat-label">Municípios</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="efficiency-month">0%</div>
                            <div class="stat-label">Eficiência</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Rota Otimizada -->
    <div class="modal fade" id="route-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark">
                <div class="modal-header">
                    <h5 class="modal-title text-light">
                        <i class="fas fa-route"></i> Rota Otimizada
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="route-details" id="route-details">
                        <!-- Será populado dinamicamente -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-success" onclick="aplicarRotaOtimizada()">
                        <i class="fas fa-check"></i> Aplicar Rota
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Painel de Predição Inteligente -->
<div class="row g-4 mt-4 mb-4">
    <div class="col-12">
        <div class="prediction-panel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="text-light mb-0">
                    <i class="fas fa-map-marked-alt"></i> Status dos 11 Municípios - Santa Catarina
                </h5>
                <button class="btn btn-outline-light btn-sm" onclick="atualizarRelatorio()">
                    <i class="fas fa-chart-line"></i> Recalcular
                </button>
            </div>
            
            <div class="row g-3">
                <div class="col-md-3">
                    <div class="prediction-card">
                        <div class="prediction-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="prediction-content">
                            <div class="prediction-value" id="data-conclusao-prevista">--</div>
                            <div class="prediction-label">Data Prevista de Conclusão</div>
                            <div class="prediction-confidence" id="confianca-previsao">--</div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="prediction-card">
                        <div class="prediction-icon">
                            <i class="fas fa-tachometer-alt"></i>
                        </div>
                        <div class="prediction-content">
                            <div class="prediction-value" id="velocidade-atual">--</div>
                            <div class="prediction-label">Velocidade Atual</div>
                            <div class="prediction-sublabel">municípios/semana</div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="prediction-card">
                        <div class="prediction-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="prediction-content">
                            <div class="prediction-value" id="municipios-risco">--</div>
                            <div class="prediction-label">Municípios em Risco</div>
                            <div class="prediction-sublabel">alta probabilidade de atraso</div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="prediction-card">
                        <div class="prediction-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="prediction-content">
                            <div class="prediction-value" id="recursos-necessarios">--</div>
                            <div class="prediction-label">Recursos Necessários</div>
                            <div class="prediction-sublabel">pesquisadores adicionais</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Cenários de Simulação -->
            <div class="simulation-scenarios mt-4">
                <h6 class="text-light mb-3">
                    <i class="fas fa-flask"></i> Simulação de Cenários
                </h6>
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="scenario-card scenario-optimistic">
                            <div class="scenario-header">
                                <i class="fas fa-rocket"></i>
                                <span>Cenário Otimista</span>
                            </div>
                            <div class="scenario-content">
                                <div class="scenario-date" id="cenario-otimista">--</div>
                                <div class="scenario-description">
                                    +20% eficiência, sem bloqueios
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="scenario-card scenario-realistic">
                            <div class="scenario-header">
                                <i class="fas fa-balance-scale"></i>
                                <span>Cenário Realista</span>
                            </div>
                            <div class="scenario-content">
                                <div class="scenario-date" id="cenario-realista">--</div>
                                <div class="scenario-description">
                                    Mantendo ritmo atual
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="scenario-card scenario-pessimistic">
                            <div class="scenario-header">
                                <i class="fas fa-exclamation-circle"></i>
                                <span>Cenário Pessimista</span>
                            </div>
                            <div class="scenario-content">
                                <div class="scenario-date" id="cenario-pessimista">--</div>
                                <div class="scenario-description">
                                    Com bloqueios e resistências
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recomendações Inteligentes -->
            <div class="recommendations mt-4">
                <h6 class="text-light mb-3">
                    <i class="fas fa-lightbulb"></i> Recomendações Estratégicas
                </h6>
                <div class="recommendations-list" id="recomendacoes-lista">
                    <!-- Será populado dinamicamente -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Estatísticas Resumidas -->
<div class="row g-4 mt-4">
    <div class="col-md-3">
        <div class="progress-card">
            <div class="detail-item">
                <div class="detail-value" id="total-municipios">11</div>
                <div class="detail-label">Total de Municípios</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="progress-card">
            <div class="detail-item">
                <div class="detail-value" id="municipios-completos">0</div>
                <div class="detail-label">Completos</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="progress-card">
            <div class="detail-item">
                <div class="detail-value" id="municipios-progresso">0</div>
                <div class="detail-label">Em Progresso</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="progress-card">
            <div class="detail-item">
                <div class="detail-value" id="progresso-geral">0%</div>
                <div class="detail-label">Progresso Geral</div>
            </div>
        </div>
    </div>
</div>

<!-- Cards de Prioridade P1/P2/P3 -->
<div class="row g-4 mt-4">
    <div class="col-12">
        <h5 class="text-light mb-3">
            <i class="fas fa-flag"></i> Entidades por Prioridade PNSB
        </h5>
    </div>
    <div class="col-md-4">
        <div class="priority-card" id="prioridade-p1">
            <div class="priority-header">
                <h6 class="priority-title">P1 - CRÍTICAS</h6>
                <div class="priority-badge bg-danger">Obrigatórias</div>
            </div>
            <div class="priority-content">
                <div class="priority-progress">
                    <div class="progress-value">0%</div>
                    <div class="progress-label">Concluídas</div>
                </div>
                <div class="priority-stats">
                    <div class="stat-item">
                        <span class="stat-value">0</span>
                        <span class="stat-label">Total</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">0</span>
                        <span class="stat-label">MRS</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">0</span>
                        <span class="stat-label">MAP</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="priority-card" id="prioridade-p2">
            <div class="priority-header">
                <h6 class="priority-title">P2 - IMPORTANTES</h6>
                <div class="priority-badge bg-warning text-dark">Campo</div>
            </div>
            <div class="priority-content">
                <div class="priority-progress">
                    <div class="progress-value">0%</div>
                    <div class="progress-label">Concluídas</div>
                </div>
                <div class="priority-stats">
                    <div class="stat-item">
                        <span class="stat-value">0</span>
                        <span class="stat-label">Total</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">0</span>
                        <span class="stat-label">MRS</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">0</span>
                        <span class="stat-label">MAP</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="priority-card" id="prioridade-p3">
            <div class="priority-header">
                <h6 class="priority-title">P3 - OPCIONAIS</h6>
                <div class="priority-badge bg-secondary">Referência</div>
            </div>
            <div class="priority-content">
                <div class="priority-progress">
                    <div class="progress-value">0%</div>
                    <div class="progress-label">Concluídas</div>
                </div>
                <div class="priority-stats">
                    <div class="stat-item">
                        <span class="stat-value">0</span>
                        <span class="stat-label">Total</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">0</span>
                        <span class="stat-label">MRS</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">0</span>
                        <span class="stat-label">MAP</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Relatório PNSB Simplificado -->
<div class="row g-4 mt-5 mb-4">
    <div class="col-12">
        <div class="simple-report">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="text-light mb-0">
                    <i class="fas fa-clipboard-list"></i> Relatório PNSB 2024 - Santa Catarina
                </h4>
                <div class="dashboard-controls">
                    <button class="btn btn-outline-light btn-sm" onclick="toggleDashboardView()">
                        <i class="fas fa-expand-arrows-alt"></i> <span id="dashboard-view-text">Expandir</span>
                    </button>
                    <button class="btn btn-outline-light btn-sm" onclick="exportarDashboard()">
                        <i class="fas fa-file-export"></i> Exportar
                    </button>
                    <button class="btn btn-outline-light btn-sm" onclick="atualizarDashboard()">
                        <i class="fas fa-sync"></i> Atualizar
                    </button>
                </div>
            </div>
            
            <!-- KPIs Principais -->
            <div class="row g-3 mb-4">
                <div class="col-md-2">
                    <div class="kpi-card kpi-primary">
                        <div class="kpi-icon">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-value" id="kpi-progresso-total">0%</div>
                            <div class="kpi-label">Progresso Total</div>
                            <div class="kpi-trend" id="kpi-progresso-trend">+0%</div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-2">
                    <div class="kpi-card kpi-success">
                        <div class="kpi-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-value" id="kpi-conclusoes">0</div>
                            <div class="kpi-label">Conclusões</div>
                            <div class="kpi-trend" id="kpi-conclusoes-trend">+0</div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-2">
                    <div class="kpi-card kpi-warning">
                        <div class="kpi-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-value" id="kpi-dias-restantes">--</div>
                            <div class="kpi-label">Dias Restantes</div>
                            <div class="kpi-trend" id="kpi-dias-trend">--</div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-2">
                    <div class="kpi-card kpi-info">
                        <div class="kpi-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-value" id="kpi-pesquisadores">5</div>
                            <div class="kpi-label">Pesquisadores</div>
                            <div class="kpi-trend" id="kpi-pesquisadores-eficiencia">85%</div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-2">
                    <div class="kpi-card kpi-danger">
                        <div class="kpi-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-value" id="kpi-alertas">0</div>
                            <div class="kpi-label">Alertas Ativos</div>
                            <div class="kpi-trend" id="kpi-alertas-trend">+0</div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-2">
                    <div class="kpi-card kpi-secondary">
                        <div class="kpi-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-value" id="kpi-performance">A</div>
                            <div class="kpi-label">Performance</div>
                            <div class="kpi-trend" id="kpi-performance-score">92%</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Gráficos e Métricas Avançadas -->
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="chart-container">
                        <h6 class="chart-title">
                            <i class="fas fa-chart-bar"></i> Progresso por Município
                        </h6>
                        <canvas id="progressChart" width="400" height="300"></canvas>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="chart-container">
                        <h6 class="chart-title">
                            <i class="fas fa-chart-line"></i> Tendência Temporal
                        </h6>
                        <canvas id="timelineChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Métricas Detalhadas -->
            <div class="row g-4 mt-3">
                <div class="col-md-4">
                    <div class="metrics-detailed">
                        <h6 class="metrics-title">
                            <i class="fas fa-tachometer-alt"></i> Indicadores de Velocidade
                        </h6>
                        <div class="metric-item">
                            <span class="metric-label">Municípios/Semana:</span>
                            <span class="metric-value" id="velocidade-municipios">1.8</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">Visitas/Dia:</span>
                            <span class="metric-value" id="velocidade-visitas">3.2</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">Taxa de Sucesso:</span>
                            <span class="metric-value" id="taxa-sucesso">78%</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">Tempo Médio/Município:</span>
                            <span class="metric-value" id="tempo-medio">4.2 dias</span>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="metrics-detailed">
                        <h6 class="metrics-title">
                            <i class="fas fa-chart-pie"></i> Distribuição de Status
                        </h6>
                        <div class="status-distribution">
                            <div class="status-item">
                                <div class="status-bar">
                                    <div class="status-fill status-completed" id="bar-completed" style="width: 0%"></div>
                                </div>
                                <span class="status-label">Completos</span>
                                <span class="status-percent" id="percent-completed">0%</span>
                            </div>
                            <div class="status-item">
                                <div class="status-bar">
                                    <div class="status-fill status-progress" id="bar-progress" style="width: 0%"></div>
                                </div>
                                <span class="status-label">Em Progresso</span>
                                <span class="status-percent" id="percent-progress">0%</span>
                            </div>
                            <div class="status-item">
                                <div class="status-bar">
                                    <div class="status-fill status-pending" id="bar-pending" style="width: 0%"></div>
                                </div>
                                <span class="status-label">Pendentes</span>
                                <span class="status-percent" id="percent-pending">0%</span>
                            </div>
                            <div class="status-item">
                                <div class="status-bar">
                                    <div class="status-fill status-blocked" id="bar-blocked" style="width: 0%"></div>
                                </div>
                                <span class="status-label">Bloqueados</span>
                                <span class="status-percent" id="percent-blocked">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="metrics-detailed">
                        <h6 class="metrics-title">
                            <i class="fas fa-bullseye"></i> Metas e Objetivos
                        </h6>
                        <div class="goal-item">
                            <div class="goal-header">
                                <span class="goal-title">Meta Mensal</span>
                                <span class="goal-percentage" id="meta-mensal">0%</span>
                            </div>
                            <div class="goal-progress">
                                <div class="goal-bar">
                                    <div class="goal-fill" id="meta-mensal-bar" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="goal-details" id="meta-mensal-detalhes">0/0 municípios</div>
                        </div>
                        
                        <div class="goal-item">
                            <div class="goal-header">
                                <span class="goal-title">Meta Trimestral</span>
                                <span class="goal-percentage" id="meta-trimestral">0%</span>
                            </div>
                            <div class="goal-progress">
                                <div class="goal-bar">
                                    <div class="goal-fill" id="meta-trimestral-bar" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="goal-details" id="meta-trimestral-detalhes">0/0 municípios</div>
                        </div>
                        
                        <div class="goal-item">
                            <div class="goal-header">
                                <span class="goal-title">Meta Projeto</span>
                                <span class="goal-percentage" id="meta-projeto">0%</span>
                            </div>
                            <div class="goal-progress">
                                <div class="goal-bar">
                                    <div class="goal-fill" id="meta-projeto-bar" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="goal-details" id="meta-projeto-detalhes">0/11 municípios</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Alertas e Recomendações Executivas -->
            <div class="row g-4 mt-3">
                <div class="col-md-6">
                    <div class="executive-alerts">
                        <h6 class="alerts-title">
                            <i class="fas fa-bell"></i> Alertas Executivos
                        </h6>
                        <div class="alerts-list" id="executive-alerts-list">
                            <!-- Será populado dinamicamente -->
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="executive-recommendations">
                        <h6 class="recommendations-title">
                            <i class="fas fa-lightbulb"></i> Recomendações Estratégicas
                        </h6>
                        <div class="recommendations-list" id="executive-recommendations-list">
                            <!-- Será populado dinamicamente -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- PNSB 2024 - Sistema Simplificado para 11 Municípios de Santa Catarina -->

<!-- Sistema de Alertas Inteligentes -->
<div class="intelligent-alerts-system" id="alerts-system">
    <!-- Painel de Notificações -->
    <div class="notifications-panel" id="notifications-panel">
        <div class="panel-header">
            <h6><i class="fas fa-bell"></i> Alertas Ativos</h6>
            <div class="panel-controls">
                <button class="btn-mini" onclick="markAllAsRead()" title="Marcar todas como lidas">
                    <i class="fas fa-check-double"></i>
                </button>
                <button class="btn-mini" onclick="toggleNotificationsPanel()" title="Minimizar">
                    <i class="fas fa-minus"></i>
                </button>
            </div>
        </div>
        <div class="notifications-list" id="notifications-list">
            <!-- Notificações serão inseridas aqui -->
        </div>
        <div class="panel-footer">
            <button class="btn btn-sm btn-outline-light w-100" onclick="configureAlerts()">
                <i class="fas fa-cog"></i> Configurar Alertas
            </button>
        </div>
    </div>
    
    <!-- Botão Flutuante de Alertas -->
    <div class="alerts-floating-button" id="alerts-floating-btn" onclick="toggleNotificationsPanel()">
        <i class="fas fa-bell"></i>
        <span class="alert-count" id="alert-count">0</span>
        <div class="pulse-ring"></div>
    </div>
</div>

<!-- Modal de Configuração de Alertas -->
<div class="modal fade" id="alertsConfigModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-light">
                    <i class="fas fa-cog"></i> Configuração de Alertas Inteligentes
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Configurações de Alertas -->
                <div class="alert-config-section">
                    <h6 class="text-light mb-3">
                        <i class="fas fa-exclamation-triangle"></i> Alertas de Progresso
                    </h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="alert-slow-progress" checked>
                                <label class="form-check-label text-light" for="alert-slow-progress">
                                    Progresso Lento (< 2% por dia)
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="alert-stalled-municipalities" checked>
                                <label class="form-check-label text-light" for="alert-stalled-municipalities">
                                    Municípios Parados (> 7 dias sem atividade)
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="alert-deadline-risk" checked>
                                <label class="form-check-label text-light" for="alert-deadline-risk">
                                    Risco de Prazo (atraso > 10%)
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="alert-low-performance" checked>
                                <label class="form-check-label text-light" for="alert-low-performance">
                                    Performance Baixa (Score < 70%)
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <hr class="border-secondary my-4">
                
                <div class="alert-config-section">
                    <h6 class="text-light mb-3">
                        <i class="fas fa-chart-line"></i> Alertas de Tendências
                    </h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="alert-negative-trend" checked>
                                <label class="form-check-label text-light" for="alert-negative-trend">
                                    Tendência Negativa (3 dias consecutivos)
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="alert-resource-overload" checked>
                                <label class="form-check-label text-light" for="alert-resource-overload">
                                    Sobrecarga de Recursos (> 80% capacidade)
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="alert-quality-issues">
                                <label class="form-check-label text-light" for="alert-quality-issues">
                                    Problemas de Qualidade (retrabalho > 15%)
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="alert-milestone-approaching" checked>
                                <label class="form-check-label text-light" for="alert-milestone-approaching">
                                    Marco Próximo (< 5 dias)
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <hr class="border-secondary my-4">
                
                <div class="alert-config-section">
                    <h6 class="text-light mb-3">
                        <i class="fas fa-clock"></i> Frequência de Verificação
                    </h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label text-light">Verificação Automática:</label>
                            <select class="form-select bg-dark text-light" id="alert-frequency">
                                <option value="5">A cada 5 minutos</option>
                                <option value="15" selected>A cada 15 minutos</option>
                                <option value="30">A cada 30 minutos</option>
                                <option value="60">A cada 1 hora</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-light">Prioridade Mínima:</label>
                            <select class="form-select bg-dark text-light" id="min-priority">
                                <option value="low">Baixa</option>
                                <option value="medium" selected>Média</option>
                                <option value="high">Alta</option>
                                <option value="critical">Crítica</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-light">Som de Notificação:</label>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="enable-sound" checked>
                                <label class="form-check-label text-light" for="enable-sound">
                                    Ativar Som
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <hr class="border-secondary my-4">
                
                <div class="alert-config-section">
                    <h6 class="text-light mb-3">
                        <i class="fas fa-envelope"></i> Canais de Notificação
                    </h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="notify-browser" checked>
                                <label class="form-check-label text-light" for="notify-browser">
                                    Notificações do Navegador
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="notify-email">
                                <label class="form-check-label text-light" for="notify-email">
                                    E-mail (funcionalidade futura)
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="notify-slack">
                                <label class="form-check-label text-light" for="notify-slack">
                                    Slack (funcionalidade futura)
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="notify-whatsapp">
                                <label class="form-check-label text-light" for="notify-whatsapp">
                                    WhatsApp (funcionalidade futura)
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveAlertsConfig()">
                    <i class="fas fa-save"></i> Salvar Configurações
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ====================================
// SISTEMA PNSB 2024 - VERSÃO SIMPLIFICADA
// Foco: 11 Municípios de Santa Catarina
// ====================================

// Variáveis essenciais
let mapa;
let dadosProgresso = {};
let marcadores = {};
let currentView = 'map';
let entidadesIdentificadas = []; // Inicializar como array vazio

// Configuração básica
const API_ENDPOINTS = {
    PROGRESSO_MAPA: '/api/visitas/progresso-mapa',
    DASHBOARD_INTELIGENTE: '/api/visitas/dashboard-inteligente',
    STATUS_INTELIGENTE: '/api/visitas/{id}/status-inteligente',
    QUESTIONARIOS_OBRIGATORIOS: '/api/questionarios/questionarios-obrigatorios',
    ENTIDADES_IDENTIFICADAS: '/api/questionarios/entidades-identificadas',
    // NOVO: Endpoints de visitas obrigatórias
    VISITAS_OBRIGATORIAS: '/api/visitas-obrigatorias/visitas-obrigatorias',
    STATUS_VISITAS_OBRIGATORIAS: '/api/visitas-obrigatorias/status-visitas-obrigatorias',
    DASHBOARD_INTEGRADO: '/api/visitas-obrigatorias/dashboard-integrado/{municipio}'
};

// Municípios PNSB 2024 - Santa Catarina
const MUNICIPIOS_PNSB = [
    'Balneário Camboriú', 'Balneário Piçarras', 'Bombinhas', 
    'Camboriú', 'Itajaí', 'Itapema', 'Luiz Alves', 
    'Navegantes', 'Penha', 'Porto Belo', 'Ilhota'
];

// Alternar para vista de calendário (declarada cedo para hoisting)
function alternarCalendario() {
    const mapView = document.getElementById('map-view');
    const listView = document.getElementById('list-view');
    const calendarPanel = document.getElementById('calendar-panel');
    const toggleButton = document.getElementById('view-toggle-text');
    
    // Verificar se elementos existem antes de acessar suas propriedades
    if (!mapView || !listView || !calendarPanel || !toggleButton) {
        console.error('Elementos necessários para alternar calendário não encontrados');
        return;
    }
    
    if (window.calendarData && window.calendarData.currentView === 'calendar') {
        // Voltar para mapa
        mapView.style.display = 'block';
        listView.style.display = 'none';
        calendarPanel.style.display = 'none';
        window.calendarData.currentView = 'map';
        toggleButton.textContent = 'Vista Lista';
    } else {
        // Mostrar calendário
        mapView.style.display = 'none';
        listView.style.display = 'none';
        calendarPanel.style.display = 'block';
        
        // Inicializar calendarData se não existir
        if (!window.calendarData) {
            window.calendarData = {
                currentMonth: new Date().getMonth(),
                currentYear: new Date().getFullYear(),
                selectedDate: null,
                visitas: {},
                currentView: 'calendar'
            };
        } else {
            window.calendarData.currentView = 'calendar';
        }
        
        toggleButton.textContent = 'Vista Mapa';
        
        // Inicializar calendário
        if (typeof inicializarCalendario === 'function') {
            inicializarCalendario();
            carregarVisitasCalendario();
        }
    }
}

// Inicialização do sistema
function inicializarSistemaPNSB() {
    console.log('🏛️ Inicializando Sistema PNSB 2024 - Santa Catarina');
    
    inicializarMapa();
    carregarDadosProgresso();
    carregarQuestionariosObrigatorios();
    carregarEntidadesIdentificadas();
    atualizarEstatisticas();
    popularGridMunicipios();
    inicializarFiltros();
}

// Popular grid de municípios para seleção de rotas
function popularGridMunicipios() {
    const grid = document.getElementById('municipalities-grid');
    if (!grid) return;
    
    const html = MUNICIPIOS_PNSB.map(municipio => `
        <div class="municipality-item">
            <label class="municipality-checkbox">
                <input type="checkbox" value="${municipio}">
                <span class="checkmark"></span>
                <span class="municipality-name">${municipio}</span>
            </label>
        </div>
    `).join('');
    
    grid.innerHTML = html;
}

// Inicialização do mapa
function inicializarMapa() {
    try {
        // Coordenadas do centro de Santa Catarina
        mapa = L.map('mapa-progresso').setView([-26.9194, -49.0661], 9);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(mapa);
        
        console.log('✅ Mapa inicializado');
    } catch (error) {
        console.error('❌ Erro ao inicializar mapa:', error);
    }
}

// Carregar dados de progresso
async function carregarDadosProgresso() {
    // Mostrar indicador de carregamento
    mostrarIndicadorCarregamento(true);
    
    try {
        // Carregar dados básicos primeiro
        const responseBasico = await fetch(API_ENDPOINTS.PROGRESSO_MAPA);
        if (responseBasico.ok) {
            dadosProgresso = await responseBasico.json();
        }
        
        // Carregar dados inteligentes
        const responseInteligente = await fetch(API_ENDPOINTS.DASHBOARD_INTELIGENTE);
        if (responseInteligente.ok) {
            const dadosInteligentes = await responseInteligente.json();
            
            // Integrar dados inteligentes com os dados básicos
            dadosProgresso.estatisticas_inteligentes = dadosInteligentes.estatisticas;
            dadosProgresso.timestamp_inteligente = dadosInteligentes.timestamp;
            
            // NOVO: Integrar dados de visitas obrigatórias
            if (dadosInteligentes.visitas_obrigatorias) {
                dadosProgresso.visitas_obrigatorias = dadosInteligentes.visitas_obrigatorias;
                console.log('✅ Dados de visitas obrigatórias integrados');
            }
            
            console.log('✅ Dados inteligentes carregados');
        }
        
        // NOVO: Carregar status consolidado de visitas obrigatórias
        try {
            const responseVisitasObrigatorias = await fetch(API_ENDPOINTS.STATUS_VISITAS_OBRIGATORIAS);
            if (responseVisitasObrigatorias.ok) {
                const statusVisitasObrigatorias = await responseVisitasObrigatorias.json();
                dadosProgresso.status_visitas_obrigatorias = statusVisitasObrigatorias;
                console.log('✅ Status de visitas obrigatórias carregado');
            }
        } catch (error) {
            console.warn('⚠️ Erro ao carregar status de visitas obrigatórias:', error);
        }
        
        // Carregar dados detalhados de visitas individuais
        await carregarDadosVisitasIndividuais();
        
        atualizarMapa();
        atualizarEstatisticas();
        
        // Após carregar dados básicos, atualizar com P1/P2/P3
        if (typeof atualizarVisualizacaoP123 === 'function') {
            await atualizarVisualizacaoP123();
        }
        
        console.log('✅ Dados carregados');
    } catch (error) {
        console.error('❌ Erro ao carregar dados:', error);
        // Dados de exemplo para desenvolvimento
        dadosProgresso = {
            municipios: {},
            estatisticas: {
                total: 11,
                finalizados: 0,
                progresso: 0
            },
            estatisticas_inteligentes: {
                total_visitas: 0,
                por_status: {},
                por_status_inteligente: {},
                progresso_medio: 0,
                questionnaire_completion: {
                    mrs: { respondido: 0, validado: 0 },
                    map: { respondido: 0, validado: 0 }
                },
                checklist_progress: {
                    preparacao: 0,
                    execucao: 0,
                    finalizacao: 0
                },
                proximas_acoes: {}
            }
        };
        
        // Mesmo com dados de exemplo, atualizar P1/P2/P3
        if (typeof atualizarVisualizacaoP123 === 'function') {
            await atualizarVisualizacaoP123();
        }
    } finally {
        // Ocultar indicador de carregamento
        mostrarIndicadorCarregamento(false);
    }
}

// Mostrar/ocultar indicador de carregamento
function mostrarIndicadorCarregamento(mostrar) {
    const indicadores = document.querySelectorAll('.loading-indicator');
    indicadores.forEach(indicador => {
        indicador.style.display = mostrar ? 'flex' : 'none';
    });
    
    // Mostrar/ocultar conteúdo principal
    const containers = document.querySelectorAll('#map-container, #list-view, .progress-card');
    containers.forEach(container => {
        if (mostrar) {
            container.style.opacity = '0.5';
        } else {
            container.style.opacity = '1';
        }
    });
}

// Carregar dados detalhados de visitas individuais
async function carregarDadosVisitasIndividuais() {
    try {
        // Primeiro obter todas as visitas
        const responseVisitas = await fetch('/api/visitas');
        if (!responseVisitas.ok) {
            console.warn('⚠️ Não foi possível carregar visitas, usando dados em cache');
            return;
        }
        
        const visitas = await responseVisitas.json();
        
        // Limitar número de requisições simultâneas para evitar sobrecarga
        const BATCH_SIZE = 5;
        const statusResults = [];
        
        for (let i = 0; i < visitas.length; i += BATCH_SIZE) {
            const batch = visitas.slice(i, i + BATCH_SIZE);
            
            const batchPromises = batch.map(async (visita) => {
                try {
                    const statusUrl = API_ENDPOINTS.STATUS_INTELIGENTE.replace('{id}', visita.id);
                    const statusResponse = await fetch(statusUrl);
                    if (statusResponse.ok) {
                        return await statusResponse.json();
                    }
                } catch (error) {
                    console.warn(`Erro ao carregar status inteligente da visita ${visita.id}:`, error);
                }
                return null;
            });
            
            const batchResults = await Promise.all(batchPromises);
            statusResults.push(...batchResults);
        }
        
        // Organizar dados por município
        if (!dadosProgresso.visitas_detalhadas) {
            dadosProgresso.visitas_detalhadas = {};
        }
        
        statusResults.forEach((statusData, index) => {
            if (statusData) {
                const municipio = statusData.municipio;
                if (!dadosProgresso.visitas_detalhadas[municipio]) {
                    dadosProgresso.visitas_detalhadas[municipio] = [];
                }
                dadosProgresso.visitas_detalhadas[municipio].push(statusData);
            }
        });
        
        console.log(`✅ Dados detalhados de visitas carregados (${statusResults.filter(r => r !== null).length}/${visitas.length})`);
    } catch (error) {
        console.error('❌ Erro ao carregar dados detalhados de visitas:', error);
        // Garantir que a estrutura existe mesmo com erro
        if (!dadosProgresso.visitas_detalhadas) {
            dadosProgresso.visitas_detalhadas = {};
        }
    }
}

// Obter dados inteligentes consolidados para um município
function obterDadosInteligentes(municipio) {
    const visitasDoMunicipio = dadosProgresso.visitas_detalhadas?.[municipio] || [];
    
    if (visitasDoMunicipio.length === 0) {
        return {
            status_inteligente: 'aguardando-agendamento',
            progresso_checklist: { preparacao: 0, execucao: 0, finalizacao: 0 },
            status_questionarios: { mrs: { respondido: 0, validado: 0 }, map: { respondido: 0, validado: 0 } },
            proximas_acoes: 'Agendar primeira visita',
            total_visitas: 0
        };
    }
    
    // Calcular estatísticas consolidadas
    let totalPreparacao = 0, totalExecucao = 0, totalFinalizacao = 0;
    let totalMrsRespondido = 0, totalMrsValidado = 0;
    let totalMapRespondido = 0, totalMapValidado = 0;
    let proximasAcoes = new Set();
    
    // Status inteligente mais avançado
    const statusPrioridade = {
        'aguardando-agendamento': 0,
        'em-preparacao': 1,
        'pronto-para-visita': 2,
        'visita-realizada': 3,
        'questionarios-respondidos': 4,
        'questionarios-validados': 5,
        'processo-finalizado': 6
    };
    
    let statusMaisAvancado = 'aguardando-agendamento';
    
    visitasDoMunicipio.forEach(visita => {
        // Status inteligente mais avançado
        if (statusPrioridade[visita.status_inteligente] > statusPrioridade[statusMaisAvancado]) {
            statusMaisAvancado = visita.status_inteligente;
        }
        
        // Progresso checklist
        totalPreparacao += visita.progresso_checklist.preparacao || 0;
        totalExecucao += visita.progresso_checklist.execucao || 0;
        totalFinalizacao += visita.progresso_checklist.finalizacao || 0;
        
        // Status questionários
        totalMrsRespondido += visita.status_questionarios.mrs.respondido ? 1 : 0;
        totalMrsValidado += visita.status_questionarios.mrs.validado_concluido ? 1 : 0;
        totalMapRespondido += visita.status_questionarios.map.respondido ? 1 : 0;
        totalMapValidado += visita.status_questionarios.map.validado_concluido ? 1 : 0;
        
        // Próximas ações
        proximasAcoes.add(visita.proxima_acao);
    });
    
    const totalVisitas = visitasDoMunicipio.length;
    
    return {
        status_inteligente: statusMaisAvancado,
        progresso_checklist: {
            preparacao: Math.round(totalPreparacao / totalVisitas),
            execucao: Math.round(totalExecucao / totalVisitas),
            finalizacao: Math.round(totalFinalizacao / totalVisitas)
        },
        status_questionarios: {
            mrs: { respondido: totalMrsRespondido, validado: totalMrsValidado },
            map: { respondido: totalMapRespondido, validado: totalMapValidado }
        },
        proximas_acoes: Array.from(proximasAcoes).join(', '),
        total_visitas: totalVisitas
    };
}

// Gerar HTML para status inteligente
function gerarHtmlStatusInteligente(dadosInteligentes) {
    try {
        const statusClass = (dadosInteligentes.status_inteligente || 'aguardando-agendamento').replace(/\s+/g, '-').toLowerCase();
        const statusLabel = (dadosInteligentes.status_inteligente || 'aguardando-agendamento').replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        
        const mrsStatus = dadosInteligentes.status_questionarios?.mrs || { respondido: 0, validado: 0 };
        const mapStatus = dadosInteligentes.status_questionarios?.map || { respondido: 0, validado: 0 };
        const checklistStatus = dadosInteligentes.progresso_checklist || { preparacao: 0, execucao: 0, finalizacao: 0 };
        
        return `
            <div class="intelligent-status">
                <span class="intelligent-status-badge ${statusClass}">
                    ${statusLabel}
                </span>
            </div>
            <div class="questionnaire-status">
                <div class="questionnaire-item">
                    <div class="questionnaire-type">MRS</div>
                    <div class="questionnaire-progress">
                        <span class="responded">${mrsStatus.respondido}</span>
                        <span class="validated">${mrsStatus.validado}</span>
                    </div>
                </div>
                <div class="questionnaire-item">
                    <div class="questionnaire-type">MAP</div>
                    <div class="questionnaire-progress">
                        <span class="responded">${mapStatus.respondido}</span>
                        <span class="validated">${mapStatus.validado}</span>
                    </div>
                </div>
            </div>
            <div class="checklist-progress">
                <div class="checklist-phase">
                    <div class="checklist-phase-title">Prep</div>
                    <div class="checklist-phase-value">${checklistStatus.preparacao}%</div>
                </div>
                <div class="checklist-phase">
                    <div class="checklist-phase-title">Exec</div>
                    <div class="checklist-phase-value">${checklistStatus.execucao}%</div>
                </div>
                <div class="checklist-phase">
                    <div class="checklist-phase-title">Fin</div>
                    <div class="checklist-phase-value">${checklistStatus.finalizacao}%</div>
                </div>
            </div>
            <div class="next-action">
                <div class="next-action-title">Próxima Ação</div>
                <div class="next-action-text">${dadosInteligentes.proximas_acoes || 'Nenhuma ação definida'}</div>
            </div>
        `;
    } catch (error) {
        console.error('Erro ao gerar HTML status inteligente:', error);
        return '<div class="error-message">Erro ao carregar status inteligente</div>';
    }
}

// Carregar questionários obrigatórios por município
async function carregarQuestionariosObrigatorios() {
    try {
        const response = await fetch('/api/questionarios/entidades-por-municipio');
        if (response.ok) {
            const data = await response.json();
            // Disponibilizar globalmente para integração
            window.entidadesQuestionarios = data;
            console.log('✅ Questionários obrigatórios carregados');
        } else {
            console.warn('⚠️ API de questionários não disponível, usando dados locais');
            window.entidadesQuestionarios = {};
        }
    } catch (error) {
        console.warn('⚠️ Erro ao carregar questionários obrigatórios:', error);
        window.entidadesQuestionarios = {};
    }
}

// Carregar entidades identificadas (dados base)
async function carregarEntidadesIdentificadas() {
    try {
        const response = await fetch('/api/questionarios/entidades-identificadas');
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                entidadesIdentificadas = data.entidades || [];
                console.log('✅ Entidades identificadas carregadas:', entidadesIdentificadas.length);
            } else {
                entidadesIdentificadas = [];
            }
        } else {
            console.warn('⚠️ API de entidades não disponível, usando dados de exemplo');
            carregarDadosExemplo();
        }
    } catch (error) {
        console.warn('⚠️ Erro ao carregar entidades identificadas, usando dados de exemplo:', error);
        carregarDadosExemplo();
    }
}

// Carregar dados de exemplo para desenvolvimento
function carregarDadosExemplo() {
    entidadesIdentificadas = [
        {
            municipio: 'Itajaí',
            categoria_prioridade: 'p1',
            mrs_obrigatorio: true,
            map_obrigatorio: true,
            status_mrs: 'nao_iniciado',
            status_map: 'nao_iniciado',
            nome_entidade: 'Prefeitura de Itajaí'
        },
        {
            municipio: 'Balneário Camboriú',
            categoria_prioridade: 'p1',
            mrs_obrigatorio: true,
            map_obrigatorio: true,
            status_mrs: 'validado_concluido',
            status_map: 'respondido',
            nome_entidade: 'Prefeitura de Balneário Camboriú'
        },
        {
            municipio: 'Navegantes',
            categoria_prioridade: 'p2',
            mrs_obrigatorio: true,
            map_obrigatorio: false,
            status_mrs: 'respondido',
            status_map: 'nao_aplicavel',
            nome_entidade: 'Empresa de Coleta Norte'
        },
        {
            municipio: 'Bombinhas',
            categoria_prioridade: 'p3',
            mrs_obrigatorio: false,
            map_obrigatorio: true,
            status_mrs: 'nao_aplicavel',
            status_map: 'nao_iniciado',
            nome_entidade: 'Cooperativa Local'
        }
    ];
    console.log('✅ Dados de exemplo carregados:', entidadesIdentificadas.length);
}

// Atualizar mapa com marcadores
function atualizarMapa() {
    if (!mapa) return;
    
    // Limpar marcadores existentes
    Object.values(marcadores).forEach(marker => mapa.removeLayer(marker));
    marcadores = {};
    
    // Adicionar marcadores para cada município
    MUNICIPIOS_PNSB.forEach(municipio => {
        const dados = dadosProgresso.municipios?.[municipio];
        if (dados?.latitude && dados?.longitude) {
            const dadosInteligentes = obterDadosInteligentes(municipio);
            
            // Criar popup com informações inteligentes
            const popupContent = `
                <div class="popup-content">
                    <h6 class="popup-title">${municipio}</h6>
                    <div class="popup-section">
                        <div class="popup-detail">
                            <strong>Status Atual:</strong> ${dados.status || 'Pendente'}
                        </div>
                        <div class="popup-detail">
                            <strong>Status Inteligente:</strong> 
                            <span class="intelligent-status-badge ${dadosInteligentes.status_inteligente.replace(/\s+/g, '-').toLowerCase()}">
                                ${dadosInteligentes.status_inteligente.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                            </span>
                        </div>
                        <div class="popup-detail">
                            <strong>Progresso:</strong> ${dados.progresso || 0}%
                        </div>
                        <div class="popup-detail">
                            <strong>Visitas:</strong> ${dadosInteligentes.total_visitas}
                        </div>
                    </div>
                    <div class="popup-section">
                        <h6>Questionários</h6>
                        <div class="popup-detail">
                            <strong>MRS:</strong> ${dadosInteligentes.status_questionarios.mrs.respondido} respondido, ${dadosInteligentes.status_questionarios.mrs.validado} validado
                        </div>
                        <div class="popup-detail">
                            <strong>MAP:</strong> ${dadosInteligentes.status_questionarios.map.respondido} respondido, ${dadosInteligentes.status_questionarios.map.validado} validado
                        </div>
                    </div>
                    <div class="popup-section">
                        <h6>Checklist</h6>
                        <div class="popup-progress">
                            <div class="popup-progress-item">
                                <span>Preparação:</span> ${dadosInteligentes.progresso_checklist.preparacao}%
                            </div>
                            <div class="popup-progress-item">
                                <span>Execução:</span> ${dadosInteligentes.progresso_checklist.execucao}%
                            </div>
                            <div class="popup-progress-item">
                                <span>Finalização:</span> ${dadosInteligentes.progresso_checklist.finalizacao}%
                            </div>
                        </div>
                    </div>
                    <div class="popup-section">
                        <h6>Próxima Ação</h6>
                        <div class="popup-detail">
                            ${dadosInteligentes.proximas_acoes}
                        </div>
                    </div>
                </div>
            `;
            
            const marker = L.marker([dados.latitude, dados.longitude])
                .bindPopup(popupContent, {
                    className: 'popup-custom',
                    maxWidth: 350,
                    minWidth: 300
                })
                .addTo(mapa);
            
            marcadores[municipio] = marker;
        }
    });
}

// Atualizar estatísticas
function atualizarEstatisticas() {
    const stats = calcularEstatisticas();
    
    // Atualizar elementos HTML básicos
    const elementos = {
        'total-municipios': stats.total,
        'municipios-finalizados': stats.finalizados,
        'progresso-geral': `${stats.progresso}%`,
        'questionarios-mrs': stats.mrs,
        'questionarios-map': stats.map,
        'municipios-visitados': stats.visitados,
        'progresso-geral-relatorio': `${stats.progresso}%`
    };
    
    Object.entries(elementos).forEach(([id, valor]) => {
        const elemento = document.getElementById(id);
        if (elemento) elemento.textContent = valor;
    });
    
    // Atualizar estatísticas inteligentes
    atualizarEstatisticasInteligentes();
}

// Atualizar estatísticas inteligentes
function atualizarEstatisticasInteligentes() {
    const estatisticasInteligentes = dadosProgresso.estatisticas_inteligentes;
    if (!estatisticasInteligentes) return;
    
    // Atualizar elementos de estatísticas inteligentes se existirem
    const elementosInteligentes = {
        'total-visitas-inteligentes': estatisticasInteligentes.total_visitas || 0,
        'progresso-medio-inteligente': `${Math.round(estatisticasInteligentes.progresso_medio || 0)}%`,
        'mrs-respondidos': estatisticasInteligentes.questionnaire_completion?.mrs?.respondido || 0,
        'mrs-validados': estatisticasInteligentes.questionnaire_completion?.mrs?.validado || 0,
        'map-respondidos': estatisticasInteligentes.questionnaire_completion?.map?.respondido || 0,
        'map-validados': estatisticasInteligentes.questionnaire_completion?.map?.validado || 0,
        'checklist-preparacao': `${Math.round(estatisticasInteligentes.checklist_progress?.preparacao || 0)}%`,
        'checklist-execucao': `${Math.round(estatisticasInteligentes.checklist_progress?.execucao || 0)}%`,
        'checklist-finalizacao': `${Math.round(estatisticasInteligentes.checklist_progress?.finalizacao || 0)}%`
    };
    
    Object.entries(elementosInteligentes).forEach(([id, valor]) => {
        const elemento = document.getElementById(id);
        if (elemento) {
            elemento.textContent = valor;
        }
    });
    
    // Atualizar distribuição de status inteligente
    atualizarDistribuicaoStatusInteligente();
}

// Atualizar distribuição de status inteligente
function atualizarDistribuicaoStatusInteligente() {
    const container = document.getElementById('intelligent-status-distribution');
    if (!container) return;
    
    const estatisticasInteligentes = dadosProgresso.estatisticas_inteligentes;
    if (!estatisticasInteligentes?.por_status_inteligente) return;
    
    const statusInteligente = estatisticasInteligentes.por_status_inteligente;
    const total = estatisticasInteligentes.total_visitas || 1;
    
    const statusColors = {
        'aguardando-agendamento': '#6c757d',
        'em-preparacao': '#17a2b8',
        'pronto-para-visita': '#20c997',
        'visita-realizada': '#007bff',
        'questionarios-respondidos': '#fd7e14',
        'questionarios-validados': '#28a745',
        'processo-finalizado': '#6f42c1'
    };
    
    let html = '';
    Object.entries(statusInteligente).forEach(([status, count]) => {
        const percent = Math.round((count / total) * 100);
        const color = statusColors[status] || '#6c757d';
        const label = status.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        
        html += `
            <div class="status-item">
                <span class="status-label">${label}</span>
                <div class="status-bar">
                    <div class="status-fill" style="width: ${percent}%; background: ${color}"></div>
                </div>
                <span class="status-percent">${percent}%</span>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Calcular estatísticas dos municípios
function calcularEstatisticas() {
    const municipios = dadosProgresso.municipios || {};
    
    let finalizados = 0;
    let mrs = 0;
    let map = 0;
    let visitados = 0;
    let progressoTotal = 0;
    
    MUNICIPIOS_PNSB.forEach(municipio => {
        const dados = municipios[municipio];
        if (dados) {
            if (dados.status === 'finalizada') finalizados++;
            if (dados.status !== 'agendada') visitados++;
            if (dados.mrs_coletado) mrs++;
            if (dados.map_coletado) map++;
            progressoTotal += dados.progresso || 0;
        }
    });
    
    return {
        total: MUNICIPIOS_PNSB.length,
        finalizados,
        mrs,
        map,
        visitados,
        progresso: Math.round(progressoTotal / MUNICIPIOS_PNSB.length)
    };
}

// Alternar entre vista mapa e lista
function alternarVista() {
    currentView = currentView === 'map' ? 'list' : 'map';
    
    const mapaElement = document.getElementById('map-view');
    const listaElement = document.getElementById('list-view');
    const toggleButton = document.getElementById('view-toggle-text');
    
    // Verificar se elementos existem antes de acessar suas propriedades
    if (!mapaElement || !listaElement || !toggleButton) {
        console.error('Elementos necessários para alternar vista não encontrados');
        return;
    }
    
    if (currentView === 'map') {
        mapaElement.style.display = 'block';
        listaElement.style.display = 'none';
        toggleButton.textContent = 'Vista Lista';
    } else {
        mapaElement.style.display = 'none';
        listaElement.style.display = 'block';
        toggleButton.textContent = 'Vista Mapa';
        atualizarVistaLista();
    }
}

// Atualizar vista em lista
function atualizarVistaLista() {
    const container = document.getElementById('list-view');
    if (!container) return;
    
    let html = '';
    MUNICIPIOS_PNSB.forEach(municipio => {
        const dados = dadosProgresso.municipios?.[municipio] || {};
        const dadosInteligentes = obterDadosInteligentes(municipio);
        
        html += `
            <div class="col-md-6 mb-3">
                <div class="progress-card">
                    <div class="progress-header">
                        <div class="municipality-name">${municipio}</div>
                        <div class="dual-status">
                            <span class="progress-status status-${dados.status || 'pending'}">
                                ${dados.status || 'Pendente'}
                            </span>
                            <span class="intelligent-status-badge ${dadosInteligentes.status_inteligente.replace(/\s+/g, '-').toLowerCase()}">
                                ${dadosInteligentes.status_inteligente.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                            </span>
                        </div>
                    </div>
                    <div class="progress-details">
                        <div class="detail-item">
                            <div class="detail-value">${dados.progresso || 0}%</div>
                            <div class="detail-label">Progresso</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-value">${dadosInteligentes.total_visitas}</div>
                            <div class="detail-label">Visitas</div>
                        </div>
                    </div>
                    ${gerarHtmlStatusInteligente(dadosInteligentes)}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Exportar relatório
function exportarRelatorio() {
    const stats = calcularEstatisticas();
    const relatorio = `
RELATÓRIO PNSB 2024 - SANTA CATARINA
=====================================

Total de Municípios: ${stats.total}
Municípios Finalizados: ${stats.finalizados}
Progresso Geral: ${stats.progresso}%

Questionários MRS: ${stats.mrs}
Questionários MAP: ${stats.map}
Municípios Visitados: ${stats.visitados}

Gerado em: ${new Date().toLocaleString('pt-BR')}
    `;
    
    const blob = new Blob([relatorio], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `relatorio_pnsb_${new Date().toISOString().split('T')[0]}.txt`;
    a.click();
    URL.revokeObjectURL(url);
}

// Atualizar relatório
function atualizarRelatorio() {
    carregarDadosProgresso();
}

// Atualizar status dos municípios
function atualizarStatusMunicipios() {
    carregarDadosProgresso();
}

// Atualizar dados (função principal de refresh)
function atualizarDados() {
    console.log('🔄 Atualizando todos os dados...');
    carregarDadosProgresso();
    carregarQuestionariosObrigatorios();
    carregarEntidadesIdentificadas();
    atualizarEstatisticas();
}

// Exportar mapa como imagem
function exportarMapa() {
    try {
        console.log('📥 Exportando mapa...');
        
        // Verificar se leaflet-image está disponível
        if (typeof leafletImage !== 'undefined' && mapa) {
            leafletImage(mapa, function(err, canvas) {
                if (err) {
                    console.error('Erro ao gerar imagem do mapa:', err);
                    alert('Erro ao exportar mapa. Tente novamente.');
                    return;
                }
                
                // Converter canvas para download
                const link = document.createElement('a');
                link.download = `mapa_progresso_pnsb_${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        } else {
            // Fallback: exportar dados como JSON
            const dados = {
                timestamp: new Date().toISOString(),
                municipios: MUNICIPIOS_PNSB,
                progresso: dadosProgresso,
                entidades: entidadesIdentificadas
            };
            
            const blob = new Blob([JSON.stringify(dados, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = `dados_progresso_pnsb_${new Date().toISOString().split('T')[0]}.json`;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
        }
    } catch (error) {
        console.error('Erro ao exportar:', error);
        alert('Erro ao exportar. Verifique o console para mais detalhes.');
    }
}

// ====================================
// SISTEMA DE ROTA INTELIGENTE - 3 NÍVEIS
// ====================================

class RouteOptimizerIntelligent {
    constructor() {
        this.visitasData = null;
        this.entidadesData = null;
        this.progressoData = null;
        this.googleMapsLoaded = false;
        this.currentLevel = 3;
        
        // PONTO DE PARTIDA FIXO: Agência IBGE Itajaí
        this.startPoint = {
            name: 'Agência IBGE Itajaí',
            address: 'Rua Camboriú 26, Centro, Itajaí, SC',
            lat: -26.9031,
            lng: -48.6596
        };
        
        // Coordenadas precisas dos 11 municípios PNSB Santa Catarina
        this.coordinates = {
            'Balneário Camboriú': { lat: -26.9977, lng: -48.6354 },
            'Balneário Piçarras': { lat: -26.7677, lng: -48.6704 },
            'Bombinhas': { lat: -27.1394, lng: -48.4814 },
            'Camboriú': { lat: -27.0253, lng: -48.6548 },
            'Itajaí': { lat: -26.9077, lng: -48.6612 },
            'Itapema': { lat: -27.0901, lng: -48.6113 },
            'Luiz Alves': { lat: -26.7186, lng: -48.9367 },
            'Navegantes': { lat: -26.8977, lng: -48.6532 },
            'Penha': { lat: -26.7703, lng: -48.6470 },
            'Porto Belo': { lat: -27.1589, lng: -48.5547 },
            'Ilhota': { lat: -26.8985, lng: -48.8235 }
        };
        
        // Cache para horários de funcionamento das prefeituras
        this.businessHoursCache = new Map();
        this.placesService = null;
        
        // Configurações padrão de horário para prefeituras (fallback)
        this.defaultBusinessHours = {
            monday: { open: '08:00', close: '17:00' },
            tuesday: { open: '08:00', close: '17:00' },
            wednesday: { open: '08:00', close: '17:00' },
            thursday: { open: '08:00', close: '17:00' },
            friday: { open: '08:00', close: '17:00' },
            saturday: { open: null, close: null }, // Fechado
            sunday: { open: null, close: null }    // Fechado
        };
        
        this.init();
    }

    async init() {
        try {
            await this.loadRealData();
            this.checkGoogleMapsAPI();
            await this.initPlacesService();
            console.log('🚀 RouteOptimizer inicializado com dados reais e Google Places');
        } catch (error) {
            console.error('❌ Erro ao inicializar RouteOptimizer:', error);
        }
    }

    async initPlacesService() {
        if (this.googleMapsLoaded && window.google?.maps?.places) {
            this.placesService = new google.maps.places.PlacesService(document.createElement('div'));
            console.log('🏢 Google Places Service inicializado');
        } else {
            console.warn('⚠️ Google Places API não disponível');
        }
    }

    async loadRealData() {
        try {
            console.log('📊 Carregando dados reais do sistema...');
            
            const [visitasResponse, entidadesResponse, progressoResponse] = await Promise.all([
                fetch('/api/visitas'),
                fetch('/api/questionarios/entidades-identificadas'),
                fetch('/api/questionarios/progresso-questionarios')
            ]);

            if (visitasResponse.ok) {
                const visitasData = await visitasResponse.json();
                this.visitasData = visitasData.data || [];
            } else {
                this.visitasData = [];
            }

            if (entidadesResponse.ok) {
                const entidadesData = await entidadesResponse.json();
                this.entidadesData = entidadesData.entidades || [];
            } else {
                this.entidadesData = [];
            }

            if (progressoResponse.ok) {
                const progressoData = await progressoResponse.json();
                this.progressoData = progressoData.data || [];
            } else {
                this.progressoData = [];
            }

            console.log('✅ Dados carregados:', {
                visitas: this.visitasData.length,
                entidades: this.entidadesData.length,
                progresso: this.progressoData.length
            });

        } catch (error) {
            console.error('❌ Erro ao carregar dados:', error);
            this.visitasData = [];
            this.entidadesData = [];
            this.progressoData = [];
        }
    }

    checkGoogleMapsAPI() {
        this.googleMapsLoaded = typeof google !== 'undefined' && 
                               google.maps && 
                               google.maps.DirectionsService;
        
        if (this.googleMapsLoaded) {
            this.currentLevel = 1;
            console.log('✅ Google Maps API disponível - Nível 1 ativo');
        } else {
            this.currentLevel = 3;
            console.log('⚠️ Google Maps API não disponível - Nível 3 ativo');
        }
    }

    // Buscar horários de funcionamento da prefeitura via Google Places API
    async getBusinessHours(municipio) {
        const cacheKey = `business_hours_${municipio}`;
        
        // Verificar cache primeiro
        if (this.businessHoursCache.has(cacheKey)) {
            return this.businessHoursCache.get(cacheKey);
        }

        if (!this.placesService) {
            console.warn(`⚠️ Places Service não disponível para ${municipio}`);
            return this.getDefaultBusinessHours();
        }

        try {
            const coordinates = this.coordinates[municipio];
            if (!coordinates) {
                return this.getDefaultBusinessHours();
            }

            const businessHours = await this.findPrefeituraBusinessHours(municipio, coordinates);
            
            // Cache por 24 horas
            this.businessHoursCache.set(cacheKey, businessHours);
            
            return businessHours;
            
        } catch (error) {
            console.error(`❌ Erro ao buscar horários para ${municipio}:`, error);
            return this.getDefaultBusinessHours();
        }
    }

    async findPrefeituraBusinessHours(municipio, coordinates) {
        return new Promise((resolve) => {
            const request = {
                location: new google.maps.LatLng(coordinates.lat, coordinates.lng),
                radius: 2000, // 2km de raio
                query: `Prefeitura Municipal de ${municipio}`,
                type: 'local_government_office'
            };

            this.placesService.textSearch(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && results.length > 0) {
                    const place = results[0];
                    
                    // Buscar detalhes do local incluindo horários
                    this.placesService.getDetails({
                        placeId: place.place_id,
                        fields: ['opening_hours', 'name', 'formatted_address']
                    }, (details, detailsStatus) => {
                        if (detailsStatus === google.maps.places.PlacesServiceStatus.OK && details.opening_hours) {
                            const businessHours = this.parseGoogleOpeningHours(details.opening_hours);
                            console.log(`🏢 Horários encontrados para ${municipio}:`, businessHours);
                            resolve(businessHours);
                        } else {
                            console.warn(`⚠️ Horários não encontrados para ${municipio}, usando padrão`);
                            resolve(this.getDefaultBusinessHours());
                        }
                    });
                } else {
                    console.warn(`⚠️ Prefeitura não encontrada para ${municipio}, usando horários padrão`);
                    resolve(this.getDefaultBusinessHours());
                }
            });
        });
    }

    parseGoogleOpeningHours(openingHours) {
        const weekdays = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        const businessHours = {};

        if (openingHours.periods) {
            weekdays.forEach((day, index) => {
                businessHours[day] = { open: null, close: null };
            });

            openingHours.periods.forEach(period => {
                const dayIndex = period.open.day;
                const dayName = weekdays[dayIndex];
                
                if (period.open && period.close) {
                    businessHours[dayName] = {
                        open: this.formatTime(period.open.time),
                        close: this.formatTime(period.close.time)
                    };
                }
            });
        } else {
            // Fallback para horários padrão
            return this.getDefaultBusinessHours();
        }

        return businessHours;
    }

    formatTime(timeString) {
        // timeString vem como "0800" ou "1730"
        if (timeString && timeString.length === 4) {
            const hours = timeString.substring(0, 2);
            const minutes = timeString.substring(2, 4);
            return `${hours}:${minutes}`;
        }
        return timeString;
    }

    getDefaultBusinessHours() {
        return { ...this.defaultBusinessHours };
    }

    // Verificar se um horário está dentro do funcionamento
    isWithinBusinessHours(municipio, targetTime, businessHours = null) {
        if (!businessHours) {
            businessHours = this.getDefaultBusinessHours();
        }

        const targetDate = new Date(targetTime);
        const dayOfWeek = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'][targetDate.getDay()];
        const dayHours = businessHours[dayOfWeek];

        if (!dayHours || !dayHours.open || !dayHours.close) {
            return false; // Fechado neste dia
        }

        const targetTimeStr = `${String(targetDate.getHours()).padStart(2, '0')}:${String(targetDate.getMinutes()).padStart(2, '0')}`;
        
        return targetTimeStr >= dayHours.open && targetTimeStr <= dayHours.close;
    }

    // Calcular próximo horário de abertura
    getNextOpenTime(municipio, fromTime, businessHours = null) {
        if (!businessHours) {
            businessHours = this.getDefaultBusinessHours();
        }

        const date = new Date(fromTime);
        const weekdays = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        
        // Tentar nos próximos 7 dias
        for (let daysAhead = 0; daysAhead < 7; daysAhead++) {
            const checkDate = new Date(date.getTime() + (daysAhead * 24 * 60 * 60 * 1000));
            const dayName = weekdays[checkDate.getDay()];
            const dayHours = businessHours[dayName];
            
            if (dayHours && dayHours.open) {
                const [hours, minutes] = dayHours.open.split(':');
                const openTime = new Date(checkDate);
                openTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                
                if (daysAhead === 0) {
                    // Mesmo dia - verificar se ainda não passou
                    if (openTime > date) {
                        return openTime;
                    }
                } else {
                    // Dias futuros
                    return openTime;
                }
            }
        }
        
        // Fallback: próxima segunda-feira 8:00
        const nextMonday = new Date(date);
        nextMonday.setDate(date.getDate() + (1 + 7 - date.getDay()) % 7);
        nextMonday.setHours(8, 0, 0, 0);
        return nextMonday;
    }

    async calculateOptimalRoute(selectedMunicipalities, criteria = 'intelligent') {
        if (!selectedMunicipalities || selectedMunicipalities.length < 2) {
            throw new Error('Selecione pelo menos 2 municípios');
        }

        console.log(`🔄 Calculando rota - Nível ${this.currentLevel}, Critério: ${criteria}`);
        
        try {
            // Tentar Nível 1: Google Maps Directions API
            if (this.currentLevel === 1) {
                return await this.level1GoogleDirections(selectedMunicipalities, criteria);
            }
        } catch (error) {
            console.warn('Nível 1 falhou, tentando Nível 2:', error);
            this.currentLevel = 2;
        }

        try {
            // Tentar Nível 2: Google Maps Distance Matrix
            if (this.currentLevel === 2) {
                return await this.level2DistanceMatrix(selectedMunicipalities, criteria);
            }
        } catch (error) {
            console.warn('Nível 2 falhou, usando Nível 3:', error);
            this.currentLevel = 3;
        }

        // Nível 3: Cálculo local inteligente
        return await this.level3LocalIntelligent(selectedMunicipalities, criteria);
    }

    // NÍVEL 1: Google Maps Directions API
    async level1GoogleDirections(municipalities, criteria) {
        if (!this.googleMapsLoaded) throw new Error('Google Maps não disponível');
        
        const directionsService = new google.maps.DirectionsService();
        const waypoints = municipalities.slice(1, -1).map(name => ({
            location: new google.maps.LatLng(this.coordinates[name].lat, this.coordinates[name].lng),
            stopover: true
        }));

        const request = {
            origin: new google.maps.LatLng(
                this.coordinates[municipalities[0]].lat,
                this.coordinates[municipalities[0]].lng
            ),
            destination: new google.maps.LatLng(
                this.coordinates[municipalities[municipalities.length - 1]].lat,
                this.coordinates[municipalities[municipalities.length - 1]].lng
            ),
            waypoints: waypoints,
            optimizeWaypoints: true,
            travelMode: google.maps.TravelMode.DRIVING
        };

        return new Promise((resolve, reject) => {
            directionsService.route(request, (result, status) => {
                if (status === google.maps.DirectionsStatus.OK) {
                    const optimizedRoute = this.processDirectionsResult(result, municipalities, criteria);
                    resolve({
                        success: true,
                        route: optimizedRoute,
                        level: 1,
                        apiUsed: 'google_directions'
                    });
                } else {
                    reject(new Error(`Directions API failed: ${status}`));
                }
            });
        });
    }

    // NÍVEL 2: Distance Matrix API
    async level2DistanceMatrix(municipalities, criteria) {
        if (!this.googleMapsLoaded) throw new Error('Google Maps não disponível');
        
        const service = new google.maps.DistanceMatrixService();
        const locations = municipalities.map(name => 
            new google.maps.LatLng(this.coordinates[name].lat, this.coordinates[name].lng)
        );

        return new Promise((resolve, reject) => {
            service.getDistanceMatrix({
                origins: locations,
                destinations: locations,
                travelMode: google.maps.TravelMode.DRIVING,
                unitSystem: google.maps.UnitSystem.METRIC
            }, (response, status) => {
                if (status === google.maps.DistanceMatrixStatus.OK) {
                    const distanceMatrix = this.parseDistanceMatrix(response);
                    const optimizedRoute = this.solveTSPWithMatrix(municipalities, distanceMatrix, criteria);
                    resolve({
                        success: true,
                        route: optimizedRoute,
                        level: 2,
                        apiUsed: 'distance_matrix'
                    });
                } else {
                    reject(new Error(`Distance Matrix failed: ${status}`));
                }
            });
        });
    }

    // NÍVEL 3: Cálculo local inteligente com dados reais
    async level3LocalIntelligent(municipalities, criteria) {
        console.log('🧠 Nível 3: Otimização local inteligente iniciada');
        
        // Buscar horários de funcionamento para todos os municípios
        const businessHoursPromises = municipalities.map(municipio => 
            this.getBusinessHours(municipio)
        );
        const businessHoursList = await Promise.all(businessHoursPromises);
        
        // Enriquecer municípios com dados REAIS + horários de funcionamento
        const enrichedMunicipalities = municipalities.map((municipio, index) => {
            const visitasDoMunicipio = this.getVisitasByMunicipio(municipio);
            const entidadesDoMunicipio = this.getEntidadesByMunicipio(municipio);
            const progressoDoMunicipio = this.getProgressoByMunicipio(municipio);
            const businessHours = businessHoursList[index];
            
            return {
                name: municipio,
                coordinates: this.coordinates[municipio],
                visitData: this.analyzeVisitData(visitasDoMunicipio),
                entityData: this.analyzeEntityData(entidadesDoMunicipio),
                progressData: this.analyzeProgressData(progressoDoMunicipio),
                businessHours: businessHours,
                urgency: this.calculateUrgency(visitasDoMunicipio, entidadesDoMunicipio, progressoDoMunicipio),
                complexity: this.calculateComplexity(entidadesDoMunicipio, progressoDoMunicipio),
                priority: this.calculateDynamicPriority(visitasDoMunicipio, entidadesDoMunicipio, progressoDoMunicipio),
                scheduleOptimization: this.calculateScheduleOptimization(businessHours)
            };
        });

        // Aplicar algoritmo baseado no critério
        let optimizedSequence;
        switch (criteria) {
            case 'urgent_visits':
                optimizedSequence = this.optimizeByUrgentVisits(enrichedMunicipalities);
                break;
            case 'completion_focus':
                optimizedSequence = this.optimizeByCompletion(enrichedMunicipalities);
                break;
            case 'visit_sequence':
                optimizedSequence = this.optimizeByVisitSequence(enrichedMunicipalities);
                break;
            case 'balanced':
                optimizedSequence = this.optimizeBalanced(enrichedMunicipalities);
                break;
            case 'intelligent':
            default:
                optimizedSequence = this.optimizeIntelligent(enrichedMunicipalities);
                break;
        }

        // Aplicar otimização de cronograma considerando horários de funcionamento
        const scheduleOptimizedSequence = this.optimizeScheduleSequence(optimizedSequence);

        return {
            success: true,
            route: this.formatIntelligentRoute(scheduleOptimizedSequence, criteria),
            level: 3,
            apiUsed: 'local_intelligent'
        };
    }

    // Calcular otimização de cronograma baseada nos horários de funcionamento
    calculateScheduleOptimization(businessHours) {
        const today = new Date();
        const currentTime = today.getHours() * 60 + today.getMinutes(); // minutos desde meia-noite
        
        let scheduleScore = 0;
        let bestVisitTime = null;
        let timeWindow = null;
        
        // Analisar horários para cada dia da semana
        const weekdays = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        const dayNames = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
        
        weekdays.forEach((day, index) => {
            const dayHours = businessHours[day];
            if (dayHours && dayHours.open && dayHours.close) {
                const openTime = this.timeToMinutes(dayHours.open);
                const closeTime = this.timeToMinutes(dayHours.close);
                const workingHours = closeTime - openTime;
                
                // Pontuação baseada em janela de tempo disponível
                const timeScore = Math.min(workingHours / 60, 8); // máximo 8 horas
                
                // Bonus para dias úteis
                const dayBonus = (index >= 1 && index <= 5) ? 1.5 : 1.0;
                
                const totalScore = timeScore * dayBonus;
                
                if (totalScore > scheduleScore) {
                    scheduleScore = totalScore;
                    bestVisitTime = {
                        day: dayNames[index],
                        openTime: dayHours.open,
                        closeTime: dayHours.close,
                        workingHours: workingHours / 60
                    };
                    timeWindow = `${dayHours.open} - ${dayHours.close}`;
                }
            }
        });
        
        return {
            scheduleScore: Math.round(scheduleScore * 10) / 10,
            bestVisitTime: bestVisitTime,
            timeWindow: timeWindow,
            isOpenToday: this.isOpenToday(businessHours),
            nextOpenTime: this.getNextOpenTime('', today, businessHours)
        };
    }

    timeToMinutes(timeString) {
        const [hours, minutes] = timeString.split(':').map(Number);
        return hours * 60 + minutes;
    }

    isOpenToday(businessHours) {
        const today = new Date();
        const dayOfWeek = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'][today.getDay()];
        const dayHours = businessHours[dayOfWeek];
        
        if (!dayHours || !dayHours.open || !dayHours.close) {
            return false;
        }
        
        const now = today.getHours() * 60 + today.getMinutes();
        const openTime = this.timeToMinutes(dayHours.open);
        const closeTime = this.timeToMinutes(dayHours.close);
        
        return now >= openTime && now <= closeTime;
    }

    // Otimizar sequência considerando horários de funcionamento
    optimizeScheduleSequence(municipalities) {
        const departureTime = new Date();
        departureTime.setHours(8, 0, 0, 0); // Partida 8:00
        
        let currentTime = new Date(departureTime);
        
        // Calcular horário estimado de chegada em cada município
        const scheduledMunicipalities = municipalities.map((municipality, index) => {
            // Tempo de viagem estimado (30-60 min entre municípios)
            const travelTime = index === 0 ? 30 : 45; // Do IBGE ao primeiro = 30min, entre municípios = 45min
            currentTime = new Date(currentTime.getTime() + (travelTime * 60 * 1000));
            
            const arrivalTime = new Date(currentTime);
            const isOpen = this.isWithinBusinessHours(municipality.name, arrivalTime, municipality.businessHours);
            
            // Se chegou quando está fechado, ajustar para próximo horário de abertura
            if (!isOpen) {
                const nextOpenTime = this.getNextOpenTime(municipality.name, arrivalTime, municipality.businessHours);
                currentTime = new Date(nextOpenTime);
            }
            
            // Tempo de trabalho no município (baseado na complexidade)
            const workTime = (municipality.complexity || 2) * 60; // minutos
            currentTime = new Date(currentTime.getTime() + (workTime * 60 * 1000));
            
            return {
                ...municipality,
                scheduledArrival: new Date(currentTime.getTime() - (workTime * 60 * 1000)),
                scheduledDeparture: new Date(currentTime),
                isOpenOnArrival: isOpen,
                estimatedWorkTime: workTime,
                scheduleEfficiency: isOpen ? 1.0 : 0.5 // Penalidade se chegar fora do horário
            };
        });
        
        // Reordenar para maximizar eficiência do cronograma
        return scheduledMunicipalities.sort((a, b) => {
            // Priorizar municípios que estarão abertos na chegada
            const openDiff = b.scheduleEfficiency - a.scheduleEfficiency;
            if (Math.abs(openDiff) > 0.1) return openDiff;
            
            // Manter ordenação por urgência/prioridade original
            return (b.urgency || 0) - (a.urgency || 0);
        });
    }

    // Análise de dados de visitas
    analyzeVisitData(visitas) {
        const agora = new Date();
        
        return {
            total: visitas.length,
            realizadas: visitas.filter(v => v.status === 'realizada').length,
            agendadas: visitas.filter(v => v.status === 'agendada').length,
            atrasadas: visitas.filter(v => 
                v.status === 'agendada' && new Date(v.data_agendada) < agora
            ).length,
            ultimaVisita: this.getUltimaVisita(visitas),
            proximaVisita: this.getProximaVisita(visitas),
            diasSemVisita: this.getDiasSemVisita(visitas),
            frequenciaVisitas: this.calculateFrequenciaVisitas(visitas)
        };
    }

    // Análise de dados de entidades
    analyzeEntityData(entidades) {
        return {
            total: entidades.length,
            p1: entidades.filter(e => e.prioridade === 1).length,
            p2: entidades.filter(e => e.prioridade === 2).length,
            p3: entidades.filter(e => e.prioridade === 3).length,
            mrsPendentes: entidades.filter(e => 
                e.mrs_obrigatorio && e.status_mrs !== 'validado_concluido'
            ).length,
            mapPendentes: entidades.filter(e => 
                e.map_obrigatorio && e.status_map !== 'validado_concluido'
            ).length,
            questionariosConcluidos: entidades.filter(e => 
                e.status_mrs === 'validado_concluido' && e.status_map === 'validado_concluido'
            ).length
        };
    }

    // Cálculo de urgência baseado em dados reais
    calculateUrgency(visitas, entidades, progresso) {
        let urgency = 0;
        
        // Visitas atrasadas (peso alto)
        const visitasAtrasadas = visitas.filter(v => 
            v.status === 'agendada' && new Date(v.data_agendada) < new Date()
        );
        urgency += visitasAtrasadas.length * 25;
        
        // Tempo sem visita
        const diasSemVisita = this.getDiasSemVisita(visitas);
        if (diasSemVisita > 30) {
            urgency += Math.min(diasSemVisita / 7, 30);
        }
        
        // Entidades P1 pendentes
        const p1Pendentes = entidades.filter(e => 
            e.prioridade === 1 && 
            (e.status_mrs !== 'validado_concluido' || e.status_map !== 'validado_concluido')
        );
        urgency += p1Pendentes.length * 20;
        
        // Progresso baixo
        const percentualProgresso = progresso?.percentual_geral || 0;
        if (percentualProgresso < 25) {
            urgency += (25 - percentualProgresso);
        }
        
        return Math.min(urgency, 100);
    }

    // Otimização inteligente principal
    optimizeIntelligent(municipalities) {
        return municipalities.sort((a, b) => {
            // 1. Urgência extrema tem prioridade absoluta
            const urgencyDiff = b.urgency - a.urgency;
            if (Math.abs(urgencyDiff) > 15) return urgencyDiff;
            
            // 2. Visitas agendadas nunca visitadas
            const aNeverVisited = a.visitData.realizadas === 0;
            const bNeverVisited = b.visitData.realizadas === 0;
            if (aNeverVisited !== bNeverVisited) {
                return bNeverVisited ? 1 : -1;
            }
            
            // 3. Visitas atrasadas
            const delayedDiff = b.visitData.atrasadas - a.visitData.atrasadas;
            if (delayedDiff !== 0) return delayedDiff;
            
            // 4. Entidades P1 pendentes
            const p1Diff = b.entityData.p1 - a.entityData.p1;
            if (p1Diff !== 0) return p1Diff;
            
            // 5. Progresso baixo
            const progressDiff = a.progressData.percentual_geral - b.progressData.percentual_geral;
            if (Math.abs(progressDiff) > 10) return progressDiff;
            
            // 6. Proximidade geográfica
            const distanceA = this.haversineDistance(municipalities[0].coordinates, a.coordinates);
            const distanceB = this.haversineDistance(municipalities[0].coordinates, b.coordinates);
            return distanceA - distanceB;
        });
    }

    // Otimização por visitas urgentes
    optimizeByUrgentVisits(municipalities) {
        return municipalities.sort((a, b) => {
            // Priorizar visitas atrasadas
            const delayedDiff = b.visitData.atrasadas - a.visitData.atrasadas;
            if (delayedDiff !== 0) return delayedDiff;
            
            // Depois por dias sem visita
            const daysDiff = b.visitData.diasSemVisita - a.visitData.diasSemVisita;
            if (Math.abs(daysDiff) > 7) return daysDiff;
            
            // Por último, urgência geral
            return b.urgency - a.urgency;
        });
    }

    // Utilitários
    getVisitasByMunicipio(municipio) {
        return this.visitasData.filter(v => v.municipio === municipio);
    }

    getEntidadesByMunicipio(municipio) {
        return this.entidadesData.filter(e => e.municipio === municipio);
    }

    getProgressoByMunicipio(municipio) {
        return this.progressoData.find(p => p.municipio === municipio) || {};
    }

    getDiasSemVisita(visitas) {
        const ultimaVisita = this.getUltimaVisita(visitas);
        if (!ultimaVisita) return 999; // Nunca visitado
        
        const hoje = new Date();
        const dataUltima = new Date(ultimaVisita.data_agendada);
        return Math.ceil((hoje - dataUltima) / (1000 * 60 * 60 * 24));
    }

    getUltimaVisita(visitas) {
        const realizadas = visitas.filter(v => v.status === 'realizada');
        if (realizadas.length === 0) return null;
        
        return realizadas.reduce((latest, current) => {
            const latestDate = new Date(latest.data_agendada);
            const currentDate = new Date(current.data_agendada);
            return currentDate > latestDate ? current : latest;
        });
    }

    haversineDistance(coord1, coord2) {
        const R = 6371; // Raio da Terra em km
        const dLat = this.toRad(coord2.lat - coord1.lat);
        const dLng = this.toRad(coord2.lng - coord1.lng);
        
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(this.toRad(coord1.lat)) * Math.cos(this.toRad(coord2.lat)) *
                  Math.sin(dLng / 2) * Math.sin(dLng / 2);
        
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    toRad(deg) {
        return deg * (Math.PI / 180);
    }

    formatIntelligentRoute(sequence, criteria) {
        // Incluir ponto de partida/retorno no cálculo da rota
        const fullRoute = [this.startPoint, ...sequence, this.startPoint];
        const totalDistance = this.calculateRouteDistanceWithStart(sequence);
        const totalTime = this.calculateRouteTimeWithStart(sequence);
        
        return {
            startPoint: this.startPoint,
            sequence: sequence.map(m => m.name),
            fullSequence: fullRoute.map(point => point.name || point.address),
            municipalities: sequence.map((m, index) => ({
                name: m.name,
                coordinates: m.coordinates,
                order: index + 1,
                distanceFromStart: Math.round(this.haversineDistance(this.startPoint, m.coordinates) * 10) / 10,
                visitSummary: {
                    totalVisitas: m.visitData?.total || 0,
                    realizadas: m.visitData?.realizadas || 0,
                    atrasadas: m.visitData?.atrasadas || 0,
                    diasSemVisita: m.visitData?.diasSemVisita || 0,
                    proximaVisita: m.visitData?.proximaVisita || 'Não agendada'
                },
                entitySummary: {
                    total: m.entityData?.total || 0,
                    p1Pendentes: m.entityData?.p1 || 0,
                    p2Pendentes: m.entityData?.p2 || 0,
                    p3Pendentes: m.entityData?.p3 || 0,
                    mrsPendentes: m.entityData?.mrsPendentes || 0,
                    mapPendentes: m.entityData?.mapPendentes || 0,
                    questionariosConcluidos: m.entityData?.questionariosConcluidos || 0
                },
                progressSummary: {
                    percentualGeral: m.progressData?.percentual_geral || 0,
                    mrsConcluido: m.progressData?.mrs_concluido || false,
                    mapConcluido: m.progressData?.map_concluido || false
                },
                metrics: {
                    urgency: Math.round(m.urgency || 0),
                    complexity: Math.round((m.complexity || 0) * 10) / 10,
                    priority: Math.round((m.priority || 0) * 10) / 10
                },
                businessHours: m.businessHours,
                scheduleInfo: {
                    isOpenToday: m.scheduleOptimization?.isOpenToday || false,
                    bestVisitTime: m.scheduleOptimization?.bestVisitTime || null,
                    timeWindow: m.scheduleOptimization?.timeWindow || 'Não disponível',
                    scheduleScore: m.scheduleOptimization?.scheduleScore || 0,
                    scheduledArrival: m.scheduledArrival ? m.scheduledArrival.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : null,
                    scheduledDeparture: m.scheduledDeparture ? m.scheduledDeparture.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : null,
                    isOpenOnArrival: m.isOpenOnArrival || false,
                    scheduleEfficiency: Math.round((m.scheduleEfficiency || 0) * 100)
                },
                reasons: this.getOptimizationReasons(m, criteria)
            })),
            summary: {
                totalDistance: Math.round(totalDistance * 10) / 10,
                estimatedTime: Math.round(totalTime),
                totalMunicipalities: sequence.length,
                neverVisited: sequence.filter(m => (m.visitData?.realizadas || 0) === 0).length,
                withDelayedVisits: sequence.filter(m => (m.visitData?.atrasadas || 0) > 0).length,
                avgUrgency: Math.round(sequence.reduce((sum, m) => sum + (m.urgency || 0), 0) / sequence.length),
                departureTime: '08:00',
                estimatedReturn: this.calculateReturnTime(totalTime),
                fuelEstimate: Math.round(totalDistance * 0.15) // Estimativa consumo: 6.7km/L
            },
            criteria: criteria,
            criteriaDescription: this.getCriteriaDescription(criteria),
            timestamp: new Date().toISOString()
        };
    }

    calculateRouteDistance(sequence) {
        let total = 0;
        for (let i = 0; i < sequence.length - 1; i++) {
            total += this.haversineDistance(sequence[i].coordinates, sequence[i + 1].coordinates);
        }
        return total;
    }

    calculateRouteTime(sequence) {
        return sequence.reduce((total, m) => total + (m.complexity * 60) + 30, 0); // tempo base + deslocamento
    }

    // Calcular distância considerando ponto de partida/retorno
    calculateRouteDistanceWithStart(sequence) {
        let total = 0;
        
        // Do IBGE ao primeiro município
        if (sequence.length > 0) {
            total += this.haversineDistance(this.startPoint, sequence[0].coordinates);
        }
        
        // Entre municípios
        for (let i = 0; i < sequence.length - 1; i++) {
            total += this.haversineDistance(sequence[i].coordinates, sequence[i + 1].coordinates);
        }
        
        // Do último município de volta ao IBGE
        if (sequence.length > 0) {
            total += this.haversineDistance(sequence[sequence.length - 1].coordinates, this.startPoint);
        }
        
        return total;
    }

    // Calcular tempo considerando ponto de partida/retorno
    calculateRouteTimeWithStart(sequence) {
        let totalTime = 0;
        
        // Tempo base para cada município (2h de trabalho + 30min deslocamento)
        totalTime += sequence.reduce((total, m) => total + ((m.complexity || 2) * 60) + 30, 0);
        
        // Tempo adicional de ida e volta ao IBGE (30min cada)
        totalTime += 60;
        
        return totalTime;
    }

    // Calcular horário estimado de retorno
    calculateReturnTime(totalTimeMinutes) {
        const startHour = 8; // 08:00
        const endHour = startHour + (totalTimeMinutes / 60);
        const hours = Math.floor(endHour);
        const minutes = Math.round((endHour - hours) * 60);
        
        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
    }

    // Obter descrição do critério
    getCriteriaDescription(criteria) {
        const descriptions = {
            'intelligent': 'Otimização inteligente considerando urgência, progresso e proximidade geográfica',
            'urgent_visits': 'Prioriza visitas atrasadas e municípios nunca visitados',
            'completion_focus': 'Foca em completar questionários pendentes e progresso baixo',
            'visit_sequence': 'Baseado no histórico e agenda de visitas existentes',
            'balanced': 'Equilibra urgência, progresso, distância e complexidade',
            'distance': 'Otimização geográfica tradicional por menor distância'
        };
        return descriptions[criteria] || 'Critério não especificado';
    }

    // Obter razões da otimização para cada município
    getOptimizationReasons(municipio, criteria) {
        const reasons = [];
        
        if ((municipio.visitData?.realizadas || 0) === 0) {
            reasons.push('🚨 Município nunca visitado');
        }
        
        if ((municipio.visitData?.atrasadas || 0) > 0) {
            reasons.push(`⏰ ${municipio.visitData.atrasadas} visitas atrasadas`);
        }
        
        if ((municipio.entityData?.p1 || 0) > 0) {
            reasons.push(`🔴 ${municipio.entityData.p1} entidades P1 pendentes`);
        }
        
        if ((municipio.progressData?.percentual_geral || 0) < 25) {
            reasons.push('📊 Progresso muito baixo');
        }
        
        if ((municipio.urgency || 0) > 70) {
            reasons.push('🚨 Urgência alta');
        }
        
        if ((municipio.visitData?.diasSemVisita || 0) > 30) {
            reasons.push(`📅 ${municipio.visitData.diasSemVisita} dias sem visita`);
        }
        
        return reasons.length > 0 ? reasons : ['✅ Município em dia'];
    }

    // Funções auxiliares faltantes
    analyzeProgressData(progresso) {
        return {
            percentual_geral: progresso?.percentual_geral || 0,
            status_p1: progresso?.status_p1 || 'nao_iniciado',
            status_p2: progresso?.status_p2 || 'nao_iniciado',
            questionarios_obrigatorios: progresso?.total_questionarios_obrigatorios || 0,
            questionarios_concluidos: progresso?.questionarios_concluidos || 0,
            entidades_p1: progresso?.p1_total_entidades || 0,
            entidades_p2: progresso?.p2_total_entidades || 0
        };
    }

    calculateComplexity(entidades, progresso) {
        let complexity = 1;
        
        // Número de entidades aumenta complexidade
        complexity += Math.min(entidades.length / 10, 2);
        
        // Entidades P1 são mais complexas
        const p1Count = entidades.filter(e => e.prioridade === 1).length;
        complexity += p1Count * 0.5;
        
        // Questionários pendentes aumentam complexidade
        const pendentes = entidades.filter(e => 
            e.status_mrs === 'nao_iniciado' || e.status_map === 'nao_iniciado'
        ).length;
        complexity += pendentes * 0.3;
        
        // Baixo progresso = maior complexidade
        const percentualProgresso = progresso?.percentual_geral || 0;
        if (percentualProgresso < 50) {
            complexity += (50 - percentualProgresso) / 25;
        }
        
        return Math.min(complexity, 8);
    }

    calculateDynamicPriority(visitas, entidades, progresso) {
        let priority = 1;
        
        // Visitas atrasadas aumentam prioridade
        const atrasadas = visitas.filter(v => 
            v.status === 'agendada' && new Date(v.data_agendada) < new Date()
        ).length;
        priority += atrasadas * 2;
        
        // Nunca visitado tem prioridade alta
        const nuncaVisitado = visitas.filter(v => v.status === 'realizada').length === 0;
        if (nuncaVisitado) priority += 3;
        
        // Entidades P1 pendentes
        const p1Pendentes = entidades.filter(e => 
            e.prioridade === 1 && 
            (e.status_mrs !== 'validado_concluido' || e.status_map !== 'validado_concluido')
        ).length;
        priority += p1Pendentes * 1.5;
        
        // Progresso baixo
        const percentualProgresso = progresso?.percentual_geral || 0;
        if (percentualProgresso < 30) {
            priority += (30 - percentualProgresso) / 10;
        }
        
        return Math.min(priority, 10);
    }

    getProximaVisita(visitas) {
        const agendadas = visitas.filter(v => v.status === 'agendada');
        if (agendadas.length === 0) return null;
        
        return agendadas.reduce((nearest, current) => {
            const nearestDate = new Date(nearest.data_agendada);
            const currentDate = new Date(current.data_agendada);
            return currentDate < nearestDate ? current : nearest;
        });
    }

    calculateFrequenciaVisitas(visitas) {
        const realizadas = visitas.filter(v => v.status === 'realizada');
        if (realizadas.length < 2) return 0;
        
        const datas = realizadas.map(v => new Date(v.data_agendada)).sort((a, b) => a - b);
        const intervalos = [];
        
        for (let i = 1; i < datas.length; i++) {
            const dias = (datas[i] - datas[i-1]) / (1000 * 60 * 60 * 24);
            intervalos.push(dias);
        }
        
        return intervalos.reduce((sum, dias) => sum + dias, 0) / intervalos.length;
    }

    // Algoritmos de otimização por outros critérios
    optimizeByCompletion(municipalities) {
        return municipalities.sort((a, b) => {
            // Priorizar baixo progresso
            const progressDiff = a.progressData.percentual_geral - b.progressData.percentual_geral;
            if (Math.abs(progressDiff) > 5) return progressDiff;
            
            // Depois por questionários pendentes
            const pendentesA = a.entityData.mrsPendentes + a.entityData.mapPendentes;
            const pendentesB = b.entityData.mrsPendentes + b.entityData.mapPendentes;
            const pendentesDiff = pendentesB - pendentesA;
            if (pendentesDiff !== 0) return pendentesDiff;
            
            // Por último, entidades P1
            return b.entityData.p1 - a.entityData.p1;
        });
    }

    optimizeByVisitSequence(municipalities) {
        const nuncaVisitados = municipalities.filter(m => m.visitData.realizadas === 0);
        const atrasadas = municipalities.filter(m => m.visitData.atrasadas > 0);
        const normais = municipalities.filter(m => m.visitData.realizadas > 0 && m.visitData.atrasadas === 0);
        
        // Ordenar cada grupo
        const nuncaOrdenados = nuncaVisitados.sort((a, b) => b.urgency - a.urgency);
        const atrasadasOrdenadas = atrasadas.sort((a, b) => b.visitData.atrasadas - a.visitData.atrasadas);
        const normaisOrdenados = normais.sort((a, b) => a.visitData.diasSemVisita - b.visitData.diasSemVisita);
        
        return [...atrasadasOrdenadas, ...nuncaOrdenados, ...normaisOrdenados];
    }

    optimizeBalanced(municipalities) {
        const weights = { urgency: 0.3, progress: 0.25, distance: 0.25, complexity: 0.2 };
        
        return municipalities.sort((a, b) => {
            const scoreA = this.calculateBalancedScore(a, municipalities, weights);
            const scoreB = this.calculateBalancedScore(b, municipalities, weights);
            return scoreB - scoreA;
        });
    }

    calculateBalancedScore(municipality, allMunicipalities, weights) {
        const urgencyScore = municipality.urgency / 100;
        const progressScore = (100 - municipality.progressData.percentual_geral) / 100;
        const complexityScore = municipality.complexity / 8;
        
        // Calcular score de distância média
        const avgDistance = allMunicipalities.reduce((sum, m) => {
            if (m.name === municipality.name) return sum;
            return sum + this.haversineDistance(municipality.coordinates, m.coordinates);
        }, 0) / (allMunicipalities.length - 1);
        
        const distanceScore = Math.max(0, 1 - (avgDistance / 100));
        
        return (
            weights.urgency * urgencyScore +
            weights.progress * progressScore +
            weights.distance * distanceScore +
            weights.complexity * complexityScore
        );
    }

    // Processamento de resultados do Google Maps
    processDirectionsResult(result, municipalities, criteria) {
        const route = result.routes[0];
        const optimizedOrder = route.waypoint_order || [];
        
        // Reordenar municípios conforme otimização do Google Maps
        const optimizedSequence = [municipalities[0]]; // origem
        optimizedOrder.forEach(index => {
            optimizedSequence.push(municipalities[index + 1]); // +1 porque waypoints começam do índice 1
        });
        optimizedSequence.push(municipalities[municipalities.length - 1]); // destino
        
        // Enriquecer com dados locais
        const enrichedSequence = optimizedSequence.map(municipio => {
            const visitasDoMunicipio = this.getVisitasByMunicipio(municipio);
            const entidadesDoMunicipio = this.getEntidadesByMunicipio(municipio);
            const progressoDoMunicipio = this.getProgressoByMunicipio(municipio);
            
            return {
                name: municipio,
                coordinates: this.coordinates[municipio],
                visitData: this.analyzeVisitData(visitasDoMunicipio),
                entityData: this.analyzeEntityData(entidadesDoMunicipio),
                progressData: this.analyzeProgressData(progressoDoMunicipio),
                urgency: this.calculateUrgency(visitasDoMunicipio, entidadesDoMunicipio, progressoDoMunicipio),
                complexity: this.calculateComplexity(entidadesDoMunicipio, progressoDoMunicipio),
                priority: this.calculateDynamicPriority(visitasDoMunicipio, entidadesDoMunicipio, progressoDoMunicipio),
                googleMapsData: {
                    distance: route.legs[optimizedSequence.indexOf(municipio)]?.distance?.value || 0,
                    duration: route.legs[optimizedSequence.indexOf(municipio)]?.duration?.value || 0
                }
            };
        });
        
        return this.formatIntelligentRoute(enrichedSequence, criteria);
    }

    // Parsing da Distance Matrix
    parseDistanceMatrix(response) {
        const matrix = { distances: [], durations: [] };
        
        response.rows.forEach((row, i) => {
            matrix.distances[i] = [];
            matrix.durations[i] = [];
            
            row.elements.forEach((element, j) => {
                if (element.status === 'OK') {
                    matrix.distances[i][j] = element.distance.value / 1000; // metros para km
                    matrix.durations[i][j] = element.duration.value / 60; // segundos para minutos
                } else {
                    // Fallback para cálculo haversine
                    const municipioA = Object.keys(this.coordinates)[i];
                    const municipioB = Object.keys(this.coordinates)[j];
                    const distance = this.haversineDistance(
                        this.coordinates[municipioA],
                        this.coordinates[municipioB]
                    );
                    matrix.distances[i][j] = distance;
                    matrix.durations[i][j] = distance * 1.5; // Estimativa
                }
            });
        });
        
        return matrix;
    }

    // Solver TSP com matriz de distâncias
    solveTSPWithMatrix(municipalities, matrix, criteria) {
        const n = municipalities.length;
        const costMatrix = criteria === 'time' ? matrix.durations : matrix.distances;
        
        if (n <= 6) {
            // Solução exata para poucos municípios
            return this.exactTSPWithMatrix(municipalities, costMatrix);
        } else {
            // Heurística para muitos municípios
            return this.heuristicTSPWithMatrix(municipalities, costMatrix);
        }
    }

    exactTSPWithMatrix(municipalities, costMatrix) {
        const n = municipalities.length;
        const dp = Array(1 << n).fill().map(() => Array(n).fill(Infinity));
        const parent = Array(1 << n).fill().map(() => Array(n).fill(-1));
        
        dp[1][0] = 0;
        
        for (let mask = 1; mask < (1 << n); mask++) {
            for (let u = 0; u < n; u++) {
                if (!(mask & (1 << u)) || dp[mask][u] === Infinity) continue;
                
                for (let v = 0; v < n; v++) {
                    if (mask & (1 << v)) continue;
                    
                    const newMask = mask | (1 << v);
                    const newCost = dp[mask][u] + costMatrix[u][v];
                    
                    if (newCost < dp[newMask][v]) {
                        dp[newMask][v] = newCost;
                        parent[newMask][v] = u;
                    }
                }
            }
        }
        
        // Reconstruir caminho
        const finalMask = (1 << n) - 1;
        let minCost = Infinity;
        let lastCity = -1;
        
        for (let i = 1; i < n; i++) {
            const totalCost = dp[finalMask][i] + costMatrix[i][0];
            if (totalCost < minCost) {
                minCost = totalCost;
                lastCity = i;
            }
        }
        
        const path = this.reconstructTSPPath(parent, finalMask, lastCity, n);
        return path.map(index => municipalities[index]);
    }

    reconstructTSPPath(parent, mask, lastCity, n) {
        const path = [];
        let current = lastCity;
        let currentMask = mask;
        
        while (current !== -1) {
            path.unshift(current);
            const prev = parent[currentMask][current];
            currentMask ^= (1 << current);
            current = prev;
        }
        
        return path;
    }

    heuristicTSPWithMatrix(municipalities, costMatrix) {
        const n = municipalities.length;
        const visited = new Array(n).fill(false);
        const path = [0];
        visited[0] = true;
        
        for (let i = 1; i < n; i++) {
            let minCost = Infinity;
            let nextCity = -1;
            
            for (let j = 0; j < n; j++) {
                if (!visited[j] && costMatrix[path[path.length - 1]][j] < minCost) {
                    minCost = costMatrix[path[path.length - 1]][j];
                    nextCity = j;
                }
            }
            
            if (nextCity !== -1) {
                path.push(nextCity);
                visited[nextCity] = true;
            }
        }
        
        return path.map(index => municipalities[index]);
    }
}

// Instância global do otimizador
let routeOptimizer = null;

// Função principal para calcular rota
async function calculateIntelligentRoute() {
    try {
        if (!routeOptimizer) {
            routeOptimizer = new RouteOptimizerIntelligent();
            await routeOptimizer.init();
        }

        const selectedMunicipalities = getSelectedMunicipalities();
        if (selectedMunicipalities.length < 2) {
            showToast('Selecione pelo menos 2 municípios para calcular a rota', 'warning');
            return;
        }

        const criteria = document.querySelector('input[name="route-criteria"]:checked')?.value || 'intelligent';
        
        showToast('Calculando rota inteligente...', 'info');
        
        const result = await routeOptimizer.calculateOptimalRoute(selectedMunicipalities, criteria);
        
        if (result.success) {
            // Armazenar resultado globalmente para export/share
            window.currentRouteResult = result;
            
            displayRouteResult(result);
            drawRouteOnMap(result.route);
            showToast(`Rota calculada com sucesso! (Nível ${result.level})`, 'success');
        } else {
            showToast('Erro ao calcular rota', 'error');
        }
        
    } catch (error) {
        console.error('Erro ao calcular rota:', error);
        showToast('Erro ao calcular rota: ' + error.message, 'error');
    }
}

function getSelectedMunicipalities() {
    const checkboxes = document.querySelectorAll('#municipalities-grid input[type="checkbox"]:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

function displayRouteResult(result) {
    const container = document.getElementById('route-result');
    if (!container) return;
    
    const route = result.route;
    
    container.innerHTML = `
        <h6><i class="fas fa-route"></i> ${route.criteriaDescription}</h6>
        
        <div class="route-info-header">
            <div class="start-point-info">
                <i class="fas fa-home"></i>
                <strong>Partida/Retorno:</strong> ${route.startPoint.name}<br>
                <small>${route.startPoint.address}</small>
            </div>
        </div>
        
        <div class="route-summary row">
            <div class="col-6">
                <div class="route-stat">
                    <div class="route-stat-value">${route.summary.totalDistance} km</div>
                    <div class="route-stat-label">Distância Total</div>
                </div>
            </div>
            <div class="col-6">
                <div class="route-stat">
                    <div class="route-stat-value">${Math.round(route.summary.estimatedTime / 60)}h ${route.summary.estimatedTime % 60}min</div>
                    <div class="route-stat-label">Tempo Estimado</div>
                </div>
            </div>
            <div class="col-6">
                <div class="route-stat">
                    <div class="route-stat-value">${route.summary.departureTime}</div>
                    <div class="route-stat-label">Saída</div>
                </div>
            </div>
            <div class="col-6">
                <div class="route-stat">
                    <div class="route-stat-value">${route.summary.estimatedReturn}</div>
                    <div class="route-stat-label">Retorno</div>
                </div>
            </div>
            <div class="col-6">
                <div class="route-stat">
                    <div class="route-stat-value">${route.summary.neverVisited}</div>
                    <div class="route-stat-label">Não Visitados</div>
                </div>
            </div>
            <div class="col-6">
                <div class="route-stat">
                    <div class="route-stat-value">${route.summary.fuelEstimate}L</div>
                    <div class="route-stat-label">Combustível</div>
                </div>
            </div>
        </div>
        
        <div class="sequence-list">
            <h6><i class="fas fa-list-ol"></i> Sequência da Visita</h6>
            
            <!-- Início da rota -->
            <div class="sequence-item start-point">
                <div class="sequence-number">🏠</div>
                <div class="sequence-content">
                    <div class="sequence-municipality">${route.startPoint.name}</div>
                    <div class="sequence-details">Ponto de partida - ${route.summary.departureTime}</div>
                </div>
                <div class="sequence-time">0km</div>
            </div>
            
            ${route.municipalities.map((m, index) => `
                <div class="sequence-item ${m.visitSummary.realizadas === 0 ? 'never-visited' : ''}">
                    <div class="sequence-number">${index + 1}</div>
                    <div class="sequence-content">
                        <div class="sequence-municipality">${m.name}</div>
                        <div class="sequence-details">
                            <div class="details-row">
                                <span class="detail-badge ${m.visitSummary.realizadas === 0 ? 'badge-danger' : 'badge-info'}">
                                    Visitas: ${m.visitSummary.realizadas}/${m.visitSummary.totalVisitas}
                                </span>
                                <span class="detail-badge badge-warning">
                                    P1: ${m.entitySummary.p1Pendentes}
                                </span>
                                <span class="detail-badge badge-secondary">
                                    Urgência: ${m.metrics.urgency}
                                </span>
                            </div>
                            
                            <div class="schedule-info-row" style="margin: 4px 0;">
                                <span class="schedule-badge ${m.scheduleInfo.isOpenOnArrival ? 'badge-success' : 'badge-danger'}">
                                    ${m.scheduleInfo.isOpenOnArrival ? '🟢 Aberto' : '🔴 Fechado'} na chegada
                                </span>
                                ${m.scheduleInfo.scheduledArrival ? `
                                    <span class="schedule-badge badge-info">
                                        📅 ${m.scheduleInfo.scheduledArrival} - ${m.scheduleInfo.scheduledDeparture}
                                    </span>
                                ` : ''}
                                <span class="schedule-badge badge-light">
                                    🏢 ${m.scheduleInfo.timeWindow}
                                </span>
                            </div>
                            
                            <div class="reasons-list">
                                ${m.reasons.map(reason => `<span class="reason-tag">${reason}</span>`).join('')}
                                ${m.scheduleInfo.bestVisitTime ? `
                                    <span class="reason-tag schedule-optimized">
                                        🕐 Melhor dia: ${m.scheduleInfo.bestVisitTime.day} (${m.scheduleInfo.bestVisitTime.openTime} - ${m.scheduleInfo.bestVisitTime.closeTime})
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="sequence-time">
                        ${m.distanceFromStart}km<br>
                        <small>${Math.round((m.complexity || 2) * 60 + 30)}min</small>
                    </div>
                </div>
            `).join('')}
            
            <!-- Retorno -->
            <div class="sequence-item end-point">
                <div class="sequence-number">🏠</div>
                <div class="sequence-content">
                    <div class="sequence-municipality">${route.startPoint.name}</div>
                    <div class="sequence-details">Retorno - ${route.summary.estimatedReturn}</div>
                </div>
                <div class="sequence-time">${route.summary.totalDistance}km</div>
            </div>
        </div>
        
        <div class="route-actions mt-3">
            <button class="btn btn-success btn-sm" onclick="exportRoute()" title="Exportar rota">
                <i class="fas fa-download"></i> Exportar
            </button>
            <button class="btn btn-primary btn-sm" onclick="shareRoute()" title="Compartilhar rota">
                <i class="fas fa-share"></i> Compartilhar
            </button>
            <button class="btn btn-info btn-sm" onclick="addToCalendar()" title="Adicionar ao calendário">
                <i class="fas fa-calendar-plus"></i> Calendário
            </button>
        </div>
    `;
    
    container.style.display = 'block';
}

// Desenhar rota no mapa
function drawRouteOnMap(route) {
    if (!mapa) return;
    
    // Limpar rotas anteriores
    mapa.eachLayer(layer => {
        if (layer instanceof L.Polyline || (layer instanceof L.Marker && layer.options.isRouteMarker)) {
            mapa.removeLayer(layer);
        }
    });
    
    // Adicionar marcador do ponto de partida/retorno (IBGE)
    const startIcon = L.divIcon({
        html: `
            <div class="route-start-marker" style="background: #28a745; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 0 20px rgba(40, 167, 69, 0.8);">
                🏠
            </div>
        `,
        className: 'route-start-container',
        iconSize: [40, 40],
        iconAnchor: [20, 20]
    });
    
    L.marker([route.startPoint.lat, route.startPoint.lng], { 
        icon: startIcon,
        isRouteMarker: true
    }).addTo(mapa)
    .bindPopup(`
        <div class="route-popup">
            <h6><i class="fas fa-home"></i> ${route.startPoint.name}</h6>
            <p><strong>Endereço:</strong> ${route.startPoint.address}</p>
            <p><strong>Saída:</strong> ${route.summary.departureTime}</p>
            <p><strong>Retorno:</strong> ${route.summary.estimatedReturn}</p>
        </div>
    `);
    
    // Criar coordenadas da rota COMPLETA (incluindo partida e retorno)
    const fullRouteCoordinates = [
        [route.startPoint.lat, route.startPoint.lng], // Partida do IBGE
        ...route.municipalities.map(m => [m.coordinates.lat, m.coordinates.lng]), // Municípios
        [route.startPoint.lat, route.startPoint.lng] // Retorno ao IBGE
    ];
    
    // Desenhar linha da rota completa
    const routeLine = L.polyline(fullRouteCoordinates, {
        color: '#6EE7B7',
        weight: 4,
        opacity: 0.8,
        dashArray: '10, 5'
    }).addTo(mapa);
    
    // Adicionar marcadores numerados
    route.municipalities.forEach((municipality, index) => {
        const icon = L.divIcon({
            html: `
                <div class="route-marker ${municipality.visitSummary.realizadas === 0 ? 'never-visited' : ''}" 
                     style="background-color: ${getUrgencyColor(municipality.metrics.urgency)}">
                    <span class="route-number">${index + 1}</span>
                    <div class="route-tooltip">
                        <strong>${municipality.name}</strong><br>
                        Urgência: ${municipality.metrics.urgency}<br>
                        Visitas: ${municipality.visitSummary.realizadas}/${municipality.visitSummary.totalVisitas}<br>
                        P1 Pendentes: ${municipality.entitySummary.p1Pendentes}
                    </div>
                </div>
            `,
            className: 'route-marker-container',
            iconSize: [40, 40],
            iconAnchor: [20, 20]
        });
        
        L.marker([municipality.coordinates.lat, municipality.coordinates.lng], { icon })
            .addTo(mapa)
            .bindPopup(`
                <div class="route-popup">
                    <h6>${municipality.name}</h6>
                    <div class="route-popup-stats">
                        <div class="stat-item">
                            <span class="stat-label">Visitas:</span>
                            <span class="stat-value">${municipality.visitSummary.realizadas}/${municipality.visitSummary.totalVisitas}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Urgência:</span>
                            <span class="stat-value urgency-${Math.round(municipality.metrics.urgency / 25)}">${municipality.metrics.urgency}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">P1 Pendentes:</span>
                            <span class="stat-value">${municipality.entitySummary.p1Pendentes}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Dias sem visita:</span>
                            <span class="stat-value">${municipality.visitSummary.diasSemVisita === 999 ? 'Nunca' : municipality.visitSummary.diasSemVisita}</span>
                        </div>
                    </div>
                </div>
            `);
    });
    
    // Ajustar zoom para mostrar toda a rota
    mapa.fitBounds(routeLine.getBounds(), { padding: [20, 20] });
}

function getUrgencyColor(urgency) {
    if (urgency >= 75) return '#dc3545'; // Vermelho - Urgência crítica
    if (urgency >= 50) return '#fd7e14'; // Laranja - Urgência alta
    if (urgency >= 25) return '#ffc107'; // Amarelo - Urgência média
    return '#28a745'; // Verde - Urgência baixa
}

// Exportar rota
function exportRoute() {
    const result = window.currentRouteResult;
    if (!result) {
        showToast('Nenhuma rota para exportar', 'warning');
        return;
    }
    
    const exportData = {
        timestamp: new Date().toISOString(),
        metadata: {
            level: result.level,
            apiUsed: result.apiUsed,
            criteria: result.route.criteria,
            calculatedAt: result.route.timestamp
        },
        route: {
            sequence: result.route.sequence,
            summary: result.route.summary,
            municipalities: result.route.municipalities.map(m => ({
                name: m.name,
                coordinates: m.coordinates,
                visitSummary: m.visitSummary,
                entitySummary: m.entitySummary,
                metrics: m.metrics
            }))
        }
    };
    
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.download = `rota_pnsb_${new Date().toISOString().split('T')[0]}.json`;
    link.href = url;
    link.click();
    URL.revokeObjectURL(url);
    
    showToast('Rota exportada com sucesso!', 'success');
}

// Compartilhar rota
function shareRoute() {
    const result = window.currentRouteResult;
    if (!result) {
        showToast('Nenhuma rota para compartilhar', 'warning');
        return;
    }
    
    const shareText = `🗺️ Rota PNSB Otimizada (Nível ${result.level})
    
📊 Resumo:
• ${result.route.summary.totalMunicipalities} municípios
• ${result.route.summary.totalDistance} km
• ${Math.round(result.route.summary.estimatedTime / 60)}h estimadas
• ${result.route.summary.neverVisited} nunca visitados
• Urgência média: ${result.route.summary.avgUrgency}

📍 Sequência:
${result.route.sequence.map((m, i) => `${i + 1}. ${m}`).join('\n')}

🔧 Critério: ${result.route.criteria}
⏰ Calculado: ${new Date(result.route.timestamp).toLocaleString()}`;
    
    if (navigator.share) {
        navigator.share({
            title: 'Rota PNSB Otimizada',
            text: shareText,
            url: window.location.href
        });
    } else {
        navigator.clipboard.writeText(shareText).then(() => {
            showToast('Rota copiada para área de transferência!', 'success');
        });
    }
}

// Adicionar ao calendário
function addToCalendar() {
    const result = window.currentRouteResult;
    if (!result) {
        showToast('Nenhuma rota para adicionar ao calendário', 'warning');
        return;
    }
    
    const route = result.route;
    const today = new Date();
    const eventDate = new Date(today.getTime() + (24 * 60 * 60 * 1000)); // Amanhã
    
    // Formato para Google Calendar
    const startDate = eventDate.toISOString().split('T')[0].replace(/-/g, '');
    const startTime = route.summary.departureTime.replace(':', '');
    const endTime = route.summary.estimatedReturn.replace(':', '');
    
    const title = `Visita PNSB - ${route.summary.totalMunicipalities} Municípios`;
    const description = `🗺️ Rota Otimizada PNSB

📍 Ponto de Partida: ${route.startPoint.name}
${route.startPoint.address}

📊 Resumo da Rota:
• Distância Total: ${route.summary.totalDistance} km
• Tempo Estimado: ${Math.round(route.summary.estimatedTime / 60)}h ${route.summary.estimatedTime % 60}min
• Combustível: ~${route.summary.fuelEstimate}L
• Municípios Nunca Visitados: ${route.summary.neverVisited}

📍 Sequência de Visitas:
${route.municipalities.map((m, i) => 
    `${i + 1}. ${m.name}
   • Visitas: ${m.visitSummary.realizadas}/${m.visitSummary.totalVisitas}
   • P1 Pendentes: ${m.entitySummary.p1Pendentes}
   • Urgência: ${m.metrics.urgency}
   • Razões: ${m.reasons.join(', ')}`
).join('\n\n')}

🔧 Critério de Otimização: ${route.criteriaDescription}
⏰ Calculado em: ${new Date(route.timestamp).toLocaleString()}

📞 Contatos e informações no sistema PNSB.`;
    
    const location = route.startPoint.address;
    
    // URL para Google Calendar
    const googleCalUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${startDate}T${startTime}00/${startDate}T${endTime}00&details=${encodeURIComponent(description)}&location=${encodeURIComponent(location)}`;
    
    // Abrir Google Calendar
    window.open(googleCalUrl, '_blank');
    
    showToast('Evento de calendário criado!', 'success');
}

// Sistema de notificações (toast)
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    
    const icons = {
        success: 'fas fa-check-circle',
        error: 'fas fa-exclamation-triangle',
        warning: 'fas fa-exclamation-circle',
        info: 'fas fa-info-circle'
    };
    
    toast.innerHTML = `
        <i class="${icons[type]}"></i>
        <span>${message}</span>
    `;
    
    document.body.appendChild(toast);
    
    // Animação de entrada
    setTimeout(() => toast.classList.add('show'), 100);
    
    // Remover após 4 segundos
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => document.body.removeChild(toast), 300);
    }, 4000);
}

// Atualizar seleção de municípios
function updateMunicipalitySelection() {
    const checkboxes = document.querySelectorAll('#municipalities-grid input[type="checkbox"]:checked');
    const count = checkboxes.length;
    
    const button = document.getElementById('calculate-route-btn');
    if (button) {
        button.textContent = `Calcular Rota Inteligente (${count} selecionados)`;
        button.disabled = count < 2;
    }
    
    // Atualizar preview da seleção
    const preview = document.getElementById('selection-preview');
    if (preview) {
        if (count === 0) {
            preview.innerHTML = '<small class="text-muted">Nenhum município selecionado</small>';
        } else {
            const selected = Array.from(checkboxes).map(cb => cb.value);
            preview.innerHTML = `<small class="text-light">Selecionados: ${selected.join(', ')}</small>`;
        }
    }
}

// Inicialização quando o DOM estiver pronto
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 DOM carregado - Iniciando Sistema PNSB');
    inicializarSistemaPNSB();
    
    // Inicializar otimizador de rotas
    setTimeout(() => {
        routeOptimizer = new RouteOptimizerIntelligent();
    }, 2000);
});

// ====================================
// FUNCIONALIDADES DE ROTAS OTIMIZADAS
// ====================================

// Calcular rota otimizada usando Google Maps API
async function calcularRotaOtimizada() {
    const checkboxes = document.querySelectorAll('#municipalities-grid input[type="checkbox"]:checked');
    const municipiosSelecionados = Array.from(checkboxes).map(cb => cb.value);
    
    if (municipiosSelecionados.length < 2) {
        showToast('Selecione pelo menos 2 municípios para calcular a rota', 'warning');
        return;
    }
    
    const pontoOrigem = document.getElementById('route-origin')?.value || 'Florianópolis, SC';
    const dataVisita = document.getElementById('route-date')?.value;
    const criterio = document.querySelector('input[name="optimization-criteria"]:checked')?.value || 'distance';
    
    showToast('Calculando rota otimizada...', 'info');
    
    try {
        // Chamar API real do Google Maps em produção
        const rota = await simularCalculoRota(municipiosSelecionados, pontoOrigem, criterio);
        
        if (rota) {
            exibirRotaCalculada(rota);
            desenharRotaNoMapa(rota);
            showToast('Rota otimizada calculada com sucesso!', 'success');
        }
        
    } catch (error) {
        console.error('Erro ao calcular rota:', error);
        showToast('Erro ao calcular rota. Tente novamente.', 'error');
    }
}

// Simulação de cálculo de rota (substituir por Google Maps API)
async function simularCalculoRota(municipios, origem, criterio) {
    return new Promise((resolve) => {
        setTimeout(() => {
            const rotaOtimizada = otimizarSequenciaMunicipios(municipios, criterio);
            const distanciaTotal = calcularDistanciaTotal(rotaOtimizada);
            const tempoTotal = Math.floor(distanciaTotal * 1.2); // ~1.2 min por km
            const eficiencia = calcularEficienciaRota(rotaOtimizada);
            
            resolve({
                sequencia: rotaOtimizada,
                distancia: distanciaTotal,
                tempo: tempoTotal,
                eficiencia: eficiencia,
                criterio: criterio,
                origem: origem,
                data: new Date().toISOString()
            });
        }, 2000);
    });
}

// Otimizar sequência de municípios
function otimizarSequenciaMunicipios(municipios, criterio) {
    // Coordenadas aproximadas dos municípios de SC
    const coordenadas = {
        'Balneário Camboriú': {lat: -26.9908, lng: -48.6354},
        'Balneário Piçarras': {lat: -26.7544, lng: -48.6719},
        'Bombinhas': {lat: -27.1486, lng: -48.4814},
        'Camboriú': {lat: -27.0231, lng: -48.6556},
        'Itajaí': {lat: -26.9076, lng: -48.6646},
        'Itapema': {lat: -27.0897, lng: -48.6131},
        'Luiz Alves': {lat: -26.7139, lng: -48.9331},
        'Navegantes': {lat: -26.8986, lng: -48.6558},
        'Penha': {lat: -26.7711, lng: -48.6467},
        'Porto Belo': {lat: -27.1581, lng: -48.5503},
        'Ilhota': {lat: -26.8983, lng: -48.8322}
    };
    
    // Algoritmo simples de vizinho mais próximo
    let rotaFinal = [];
    let municipiosRestantes = [...municipios];
    let atual = municipiosRestantes.shift(); // Começar pelo primeiro
    rotaFinal.push(atual);
    
    while (municipiosRestantes.length > 0) {
        let proximo = null;
        let menorDistancia = Infinity;
        
        municipiosRestantes.forEach(municipio => {
            const distancia = calcularDistancia(
                coordenadas[atual], 
                coordenadas[municipio]
            );
            
            if (distancia < menorDistancia) {
                menorDistancia = distancia;
                proximo = municipio;
            }
        });
        
        rotaFinal.push(proximo);
        municipiosRestantes = municipiosRestantes.filter(m => m !== proximo);
        atual = proximo;
    }
    
    return rotaFinal;
}

// Calcular distância entre dois pontos (fórmula de Haversine)
function calcularDistancia(ponto1, ponto2) {
    const R = 6371; // Raio da Terra em km
    const dLat = (ponto2.lat - ponto1.lat) * Math.PI / 180;
    const dLng = (ponto2.lng - ponto1.lng) * Math.PI / 180;
    
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(ponto1.lat * Math.PI / 180) * Math.cos(ponto2.lat * Math.PI / 180) *
              Math.sin(dLng/2) * Math.sin(dLng/2);
    
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

// Calcular distância total da rota
function calcularDistanciaTotal(rota) {
    // Simplificação: estimar baseado no número de municípios
    return rota.length * 25; // ~25km média entre municípios
}

// Calcular eficiência da rota
function calcularEficienciaRota(rota) {
    return Math.min(95, 60 + (rota.length * 5)); // Eficiência baseada na otimização
}

// Exibir rota calculada
function exibirRotaCalculada(rota) {
    const resultContainer = document.getElementById('route-result');
    if (!resultContainer) return;
    
    // Atualizar estatísticas
    document.getElementById('route-distance').textContent = `${rota.distancia} km`;
    document.getElementById('route-duration').textContent = `${Math.floor(rota.tempo / 60)}h ${rota.tempo % 60}min`;
    document.getElementById('route-municipalities').textContent = rota.sequencia.length;
    document.getElementById('route-efficiency').textContent = `${rota.eficiencia}%`;
    
    // Atualizar sequência
    const sequenceContainer = document.getElementById('sequence-list');
    if (sequenceContainer) {
        sequenceContainer.innerHTML = rota.sequencia.map((municipio, index) => `
            <div class="sequence-item">
                <span class="sequence-number">${index + 1}</span>
                <span class="sequence-municipality">${municipio}</span>
            </div>
        `).join('');
    }
    
    resultContainer.style.display = 'block';
}

// Desenhar rota no mapa
function desenharRotaNoMapa(rota) {
    if (!mapa) return;
    
    // Coordenadas dos municípios
    const coordenadas = {
        'Balneário Camboriú': [-26.9908, -48.6354],
        'Balneário Piçarras': [-26.7544, -48.6719],
        'Bombinhas': [-27.1486, -48.4814],
        'Camboriú': [-27.0231, -48.6556],
        'Itajaí': [-26.9076, -48.6646],
        'Itapema': [-27.0897, -48.6131],
        'Luiz Alves': [-26.7139, -48.9331],
        'Navegantes': [-26.8986, -48.6558],
        'Penha': [-26.7711, -48.6467],
        'Porto Belo': [-27.1581, -48.5503],
        'Ilhota': [-26.8983, -48.8322]
    };
    
    // Criar linha da rota
    const pontos = rota.sequencia.map(municipio => coordenadas[municipio]);
    
    if (window.rotaLine) {
        mapa.removeLayer(window.rotaLine);
    }
    
    window.rotaLine = L.polyline(pontos, {
        color: '#5F5CFF',
        weight: 4,
        opacity: 0.8
    }).addTo(mapa);
    
    // Ajustar visualização do mapa
    mapa.fitBounds(window.rotaLine.getBounds(), {padding: [20, 20]});
}

// Exportar rota
function exportarRota() {
    showToast('Exportando rota...', 'info');
    // Implementar exportação da rota
}

// Simular tempo
function simularTempo() {
    showToast('Simulando tempo de viagem...', 'info');
    // Implementar simulação de tempo
}

// Alternar otimizador de rotas
function toggleRouteOptimizer() {
    const panel = document.getElementById('route-optimizer-panel');
    if (panel) {
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }
}

// Função de toast para feedback
function showToast(message, type = 'info') {
    console.log(`[${type.toUpperCase()}] ${message}`);
    // Em produção, mostrar toast visual
}

// ====================================
// SISTEMA DE FILTROS AVANÇADOS
// ====================================

// Alternar visualização dos filtros
// Filtros simplificados - funções de range e toggle removidas por serem desnecessárias

// Aplicar filtros aos dados
function aplicarFiltros() {
    console.log('🔍 Aplicando filtros...');
    
    const filtros = obterFiltrosAtivos();
    const dadosFiltrados = filtrarDados(dadosProgresso.municipios || {}, filtros);
    
    // Atualizar visualização com dados filtrados
    atualizarVisualizacaoComFiltros(dadosFiltrados);
    
    showToast('Filtros aplicados', 'info');
}

// Obter filtros ativos (apenas os 3 essenciais)
function obterFiltrosAtivos() {
    return {
        tipo: document.getElementById('filtro-tipo')?.value || '',
        status: document.getElementById('filtro-status')?.value || '',
        municipio: document.getElementById('filtro-municipio')?.value || ''
    };
}

// Filtrar dados segundo critérios
function filtrarDados(municipios, filtros) {
    const resultado = {};
    
    MUNICIPIOS_PNSB.forEach(municipio => {
        const dados = municipios[municipio] || {
            status: 'agendada',
            progresso: 0,
            tipo_pesquisa: ['MRS', 'MAP'],
            prioridade: 'media',
            visitas: 0
        };
        
        // Aplicar filtros
        if (!passaNofiltro(municipio, dados, filtros)) return;
        
        resultado[municipio] = dados;
    });
    
    return resultado;
}

// Verificar se município passa nos filtros (apenas os 3 essenciais)
function passaNofiltro(municipio, dados, filtros) {
    // Filtro por tipo de pesquisa
    if (filtros.tipo && !dados.tipo_pesquisa?.includes(filtros.tipo)) return false;
    
    // Filtro por status
    if (filtros.status && dados.status !== filtros.status) return false;
    
    // Filtro por município específico
    if (filtros.municipio && municipio !== filtros.municipio) return false;
    
    return true;
}

// Atualizar visualização com dados filtrados
function atualizarVisualizacaoComFiltros(dadosFiltrados) {
    // Atualizar mapa
    if (mapa) {
        // Limpar marcadores existentes
        Object.values(marcadores).forEach(marker => mapa.removeLayer(marker));
        marcadores = {};
        
        // Adicionar apenas municípios filtrados
        Object.entries(dadosFiltrados).forEach(([municipio, dados]) => {
            if (dados.latitude && dados.longitude) {
                const marker = L.marker([dados.latitude, dados.longitude])
                    .bindPopup(`
                        <strong>${municipio}</strong><br>
                        Status: ${dados.status || 'Pendente'}<br>
                        Progresso: ${dados.progresso || 0}%
                    `)
                    .addTo(mapa);
                
                marcadores[municipio] = marker;
            }
        });
    }
    
    // Atualizar vista em lista se ativa
    if (currentView === 'list') {
        atualizarVistaListaFiltrada(dadosFiltrados);
    }
    
    // Atualizar estatísticas
    atualizarEstatisticasFiltradas(dadosFiltrados);
}

// Atualizar vista lista com filtros
function atualizarVistaListaFiltrada(dadosFiltrados) {
    const container = document.getElementById('list-view');
    if (!container) return;
    
    let html = '';
    Object.entries(dadosFiltrados).forEach(([municipio, dados]) => {
        const dadosInteligentes = obterDadosInteligentes(municipio);
        
        html += `
            <div class="col-md-6 mb-3">
                <div class="progress-card">
                    <div class="progress-header">
                        <div class="municipality-name">${municipio}</div>
                        <div class="dual-status">
                            <span class="progress-status status-${dados.status || 'pending'}">
                                ${dados.status || 'Pendente'}
                            </span>
                            <span class="intelligent-status-badge ${dadosInteligentes.status_inteligente.replace(/\s+/g, '-').toLowerCase()}">
                                ${dadosInteligentes.status_inteligente.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                            </span>
                        </div>
                    </div>
                    <div class="progress-details">
                        <div class="detail-item">
                            <div class="detail-value">${dados.progresso || 0}%</div>
                            <div class="detail-label">Progresso</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-value">${dadosInteligentes.total_visitas}</div>
                            <div class="detail-label">Visitas</div>
                        </div>
                    </div>
                    ${gerarHtmlStatusInteligente(dadosInteligentes)}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html || '<p class="text-center text-light">Nenhum município encontrado com os filtros aplicados.</p>';
}

// Atualizar estatísticas considerando filtros
function atualizarEstatisticasFiltradas(dadosFiltrados) {
    let finalizados = 0;
    let mrs = 0;
    let map = 0;
    let visitados = 0;
    let progressoTotal = 0;
    
    Object.values(dadosFiltrados).forEach(dados => {
        if (dados.status === 'finalizada') finalizados++;
        if (dados.status !== 'agendada') visitados++;
        if (dados.mrs_coletado) mrs++;
        if (dados.map_coletado) map++;
        progressoTotal += dados.progresso || 0;
    });
    
    const total = Object.keys(dadosFiltrados).length;
    const progresso = total > 0 ? Math.round(progressoTotal / total) : 0;
    
    // Atualizar elementos com sufixo para indicar filtros ativos
    const sufixo = total < MUNICIPIOS_PNSB.length ? ` (${total}/${MUNICIPIOS_PNSB.length})` : '';
    
    const elementos = {
        'municipios-finalizados': finalizados + sufixo,
        'questionarios-mrs': mrs + sufixo,
        'questionarios-map': map + sufixo,
        'municipios-visitados': visitados + sufixo,
        'progresso-geral-relatorio': `${progresso}%${sufixo}`
    };
    
    Object.entries(elementos).forEach(([id, valor]) => {
        const elemento = document.getElementById(id);
        if (elemento) elemento.textContent = valor;
    });
}

// Limpar todos os filtros (apenas os 3 essenciais)
function limparFiltros() {
    document.getElementById('filtro-tipo').value = '';
    document.getElementById('filtro-status').value = '';
    document.getElementById('filtro-municipio').value = '';
    
    // Voltar para dados completos
    atualizarVisualizacaoComFiltros(dadosProgresso.municipios || {});
    atualizarEstatisticas(); // Estatísticas normais
    
    showToast('Filtros limpos', 'success');
}

// Inicializar filtros simplificados
function inicializarFiltros() {
    // Filtros já estão configurados com onchange="aplicarFiltros()" no HTML
    console.log('✅ Filtros simplificados inicializados');
}

// Filtros rápidos removidos - desnecessários com filtros simplificados

// ====================================
// SISTEMA P1/P2/P3 (PRIORIDADES PNSB)
// ====================================

let dadosQuestionarios = {};
// entidadesIdentificadas já declarado acima, reutilizar a variável global



// Gerar dados de exemplo para questionários obrigatórios
function gerarDadosQuestionariosExemplo() {
    const dados = {};
    MUNICIPIOS_PNSB.forEach(municipio => {
        dados[municipio] = {
            prefeitura: {
                mrs_obrigatorio: true,
                map_obrigatorio: true,
                prioridade: 'p1' // Prefeituras são sempre P1
            },
            empresa_terceirizada: {
                mrs_obrigatorio: true,
                map_obrigatorio: false,
                prioridade: 'p2'
            },
            entidade_catadores: {
                mrs_obrigatorio: true,
                map_obrigatorio: false,
                prioridade: 'p2'
            }
        };
    });
    return dados;
}

// Gerar dados de exemplo para entidades identificadas
function gerarDadosEntidadesExemplo() {
    const entidades = [];
    MUNICIPIOS_PNSB.forEach(municipio => {
        // Prefeitura (P1)
        entidades.push({
            municipio: municipio,
            nome_entidade: `Prefeitura Municipal de ${municipio}`,
            tipo_entidade: 'prefeitura',
            categoria_prioridade: 'p1',
            prioridade: 1,
            mrs_obrigatorio: true,
            map_obrigatorio: true,
            status_mrs: 'nao_iniciado',
            status_map: 'nao_iniciado'
        });
        
        // Algumas entidades P2 (exemplo)
        if (Math.random() > 0.5) {
            entidades.push({
                municipio: municipio,
                nome_entidade: `Empresa de Limpeza ${municipio}`,
                tipo_entidade: 'empresa_terceirizada',
                categoria_prioridade: 'p2',
                prioridade: 2,
                mrs_obrigatorio: true,
                map_obrigatorio: false,
                status_mrs: 'nao_iniciado',
                status_map: 'nao_aplicavel'
            });
        }
    });
    return entidades;
}

// Calcular estatísticas P1/P2/P3
function calcularEstatisticasPrioridades() {
    const stats = {
        p1: { total: 0, concluidos: 0, mrs: 0, map: 0 },
        p2: { total: 0, concluidos: 0, mrs: 0, map: 0 },
        p3: { total: 0, concluidos: 0, mrs: 0, map: 0 }
    };
    
    // Verificar se entidadesIdentificadas é um array válido
    if (!Array.isArray(entidadesIdentificadas)) {
        console.warn('⚠️ entidadesIdentificadas não está definido ou não é um array');
        return stats;
    }
    
    entidadesIdentificadas.forEach(entidade => {
        const prioridade = entidade.categoria_prioridade;
        if (stats[prioridade]) {
            stats[prioridade].total++;
            
            if (entidade.status_mrs === 'validado_concluido') {
                stats[prioridade].mrs++;
            }
            if (entidade.status_map === 'validado_concluido') {
                stats[prioridade].map++;
            }
            
            // Considerar concluído se todos os questionários obrigatórios estão validados
            if ((entidade.mrs_obrigatorio ? entidade.status_mrs === 'validado_concluido' : true) &&
                (entidade.map_obrigatorio ? entidade.status_map === 'validado_concluido' : true)) {
                stats[prioridade].concluidos++;
            }
        }
    });
    
    return stats;
}

// Obter entidades por município e prioridade
function getEntidadesPorMunicipio(municipio) {
    // INTEGRAÇÃO COM API REAL DOS QUESTIONÁRIOS OBRIGATÓRIOS
    if (window.entidadesQuestionarios && window.entidadesQuestionarios[municipio]) {
        return window.entidadesQuestionarios[municipio];
    }
    
    // Fallback para dados locais
    if (!Array.isArray(entidadesIdentificadas)) {
        return [];
    }
    return entidadesIdentificadas.filter(e => e.municipio === municipio);
}

// Verificar se município tem todas as entidades P1 concluídas
function isMunicipioP1Concluido(municipio) {
    if (!Array.isArray(entidadesIdentificadas)) {
        return false;
    }
    
    const entidadesP1 = entidadesIdentificadas.filter(e => 
        e.municipio === municipio && e.categoria_prioridade === 'p1'
    );
    
    return entidadesP1.every(entidade =>
        (entidade.mrs_obrigatorio ? entidade.status_mrs === 'validado_concluido' : true) &&
        (entidade.map_obrigatorio ? entidade.status_map === 'validado_concluido' : true)
    );
}

// Calcular progresso PNSB considerando prioridades (INTEGRADO COM QUESTIONÁRIOS OBRIGATÓRIOS)
async function calcularProgressoPNSB(municipio) {
    try {
        // USAR API PARA OBTER DADOS REAIS DOS QUESTIONÁRIOS OBRIGATÓRIOS
        const response = await fetch(`/api/questionarios/progresso-municipio/${municipio}`);
        const data = await response.json();
        
        if (data.success) {
            return data.percentual_geral || 0;
        }
        return calcularProgressoPNSBLocal(municipio);
    } catch (error) {
        console.error(`Erro ao buscar progresso de ${municipio}:`, error);
        return calcularProgressoPNSBLocal(municipio);
    }
}

// Fallback para cálculo local (mantido para compatibilidade)
function calcularProgressoPNSBLocal(municipio) {
    try {
        const entidades = getEntidadesPorMunicipio(municipio);
        
        if (!Array.isArray(entidades) || entidades.length === 0) {
            return 0;
        }
        
        // LÓGICA ALINHADA COM EntidadeIdentificada.calcular_progresso_municipio()
        let totalObrigatorios = 0;
        let concluidos = 0;
        
        entidades.forEach(entidade => {
            // Contar apenas P1 (críticas) + P2 (importantes) como obrigatórias
            const isObrigatoria = entidade.categoria_prioridade === 'p1' || entidade.categoria_prioridade === 'p2';
            
            if (isObrigatoria) {
                if (entidade.mrs_obrigatorio) {
                    totalObrigatorios++;
                    if (entidade.status_mrs === 'validado_concluido') {
                        concluidos++;
                    }
                }
                
                if (entidade.map_obrigatorio) {
                    totalObrigatorios++;
                    if (entidade.status_map === 'validado_concluido') {
                        concluidos++;
                    }
                }
            }
        });
        
        return totalObrigatorios > 0 ? Math.round((concluidos / totalObrigatorios) * 100) : 0;
    } catch (error) {
        console.error(`Erro ao calcular progresso local para ${municipio}:`, error);
        return 0;
    }
}

// Atualizar visualização com dados P1/P2/P3
async function atualizarVisualizacaoP123() {
    const stats = calcularEstatisticasPrioridades();
    
    // Atualizar cards de prioridade (se existirem)
    Object.entries(stats).forEach(([prioridade, dados]) => {
        const card = document.getElementById(`prioridade-${prioridade}`);
        if (card) {
            const progresso = dados.total > 0 ? Math.round((dados.concluidos / dados.total) * 100) : 0;
            
            // Atualizar apenas os valores, mantendo a estrutura HTML
            const progressValue = card.querySelector('.progress-value');
            if (progressValue) progressValue.textContent = `${progresso}%`;
            
            const statValues = card.querySelectorAll('.stat-value');
            if (statValues.length >= 3) {
                statValues[0].textContent = dados.total; // Total
                statValues[1].textContent = dados.mrs;   // MRS
                statValues[2].textContent = dados.map;   // MAP
            }
            
            // Adicionar classe de prioridade se não existir
            if (!card.classList.contains(`priority-${prioridade}`)) {
                card.classList.add(`priority-${prioridade}`);
            }
        }
    });
    
    // Atualizar progresso dos municípios usando cálculo PNSB (async)
    for (const municipio of MUNICIPIOS_PNSB) {
        try {
            const progressoPNSB = await calcularProgressoPNSB(municipio);
            
            // Atualizar dados de progresso
            if (!dadosProgresso.municipios) dadosProgresso.municipios = {};
            if (!dadosProgresso.municipios[municipio]) dadosProgresso.municipios[municipio] = {};
            
            dadosProgresso.municipios[municipio].progresso_pnsb = progressoPNSB;
            dadosProgresso.municipios[municipio].p1_concluido = isMunicipioP1Concluido(municipio);
            dadosProgresso.municipios[municipio].entidades_count = getEntidadesPorMunicipio(municipio).length;
        } catch (error) {
            console.error(`Erro ao atualizar progresso de ${municipio}:`, error);
        }
    }
}

// Atualizar dados a cada 5 minutos
setInterval(carregarDadosProgresso, 5 * 60 * 1000);

// ====================================
// STATUS REAL DAS VISITAS (WORKFLOW COMPLETO)
// ====================================

// Workflow completo de status das visitas PNSB
const STATUS_WORKFLOW_PNSB = [
    'agendada',
    'em andamento',
    'realizada', 
    'questionários concluídos',
    'questionários validados',
    'finalizada',
    'remarcada',
    'não realizada'
];

// Cores por status
const STATUS_COLORS = {
    'agendada': '#6c757d',
    'em andamento': '#007bff', 
    'realizada': '#28a745',
    'questionários concluídos': '#ffc107',
    'questionários validados': '#28a745',
    'finalizada': '#198754',
    'remarcada': '#fd7e14',
    'não realizada': '#dc3545'
};

// Obter progresso baseado no status
function calcularProgressoPorStatus(status) {
    const index = STATUS_WORKFLOW_PNSB.indexOf(status);
    if (index === -1) return 0;
    
    // Finalizada = 100%, outros proporcionais
    if (status === 'finalizada') return 100;
    if (status === 'questionários validados') return 85;
    if (status === 'questionários concluídos') return 70;
    if (status === 'realizada') return 55;
    if (status === 'em andamento') return 25;
    if (status === 'agendada') return 10;
    if (status === 'remarcada') return 5;
    if (status === 'não realizada') return 0;
    
    return 0;
}

// Atualizar marcadores no mapa com cores por status
function atualizarMarcadoresComStatus() {
    if (!mapa) return;
    
    // Limpar marcadores existentes
    Object.values(marcadores).forEach(marker => mapa.removeLayer(marker));
    marcadores = {};
    
    // Coordenadas dos municípios
    const coordenadas = {
        'Balneário Camboriú': [-26.9908, -48.6354],
        'Balneário Piçarras': [-26.7544, -48.6719],
        'Bombinhas': [-27.1486, -48.4814],
        'Camboriú': [-27.0231, -48.6556],
        'Itajaí': [-26.9076, -48.6646],
        'Itapema': [-27.0897, -48.6131],
        'Luiz Alves': [-26.7139, -48.9331],
        'Navegantes': [-26.8986, -48.6558],
        'Penha': [-26.7711, -48.6467],
        'Porto Belo': [-27.1581, -48.5503],
        'Ilhota': [-26.8983, -48.8322]
    };
    
    // Adicionar marcadores coloridos por status
    MUNICIPIOS_PNSB.forEach(municipio => {
        const coords = coordenadas[municipio];
        if (coords) {
            const dados = dadosProgresso.municipios?.[municipio] || {};
            const status = dados.status || 'agendada';
            const cor = STATUS_COLORS[status] || '#6c757d';
            const progresso = calcularProgressoPorStatus(status);
            
            // Criar ícone customizado por status
            const icon = L.divIcon({
                className: 'custom-marker',
                html: `<div style="
                    background-color: ${cor};
                    width: 20px;
                    height: 20px;
                    border-radius: 50%;
                    border: 2px solid white;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                "></div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            
            const marker = L.marker(coords, { icon })
                .bindPopup(`
                    <div class="marker-popup">
                        <strong>${municipio}</strong><br>
                        <span style="color: ${cor}">● ${status}</span><br>
                        Progresso: ${progresso}%<br>
                        ${dados.entidades_count ? `Entidades: ${dados.entidades_count}` : ''}
                        ${dados.p1_concluido ? '<br>✅ P1 Concluído' : '<br>⏳ P1 Pendente'}
                    </div>
                `)
                .addTo(mapa);
            
            marcadores[municipio] = marker;
        }
    });
}

// Calcular estatísticas detalhadas por status
function calcularEstatisticasDetalhadas() {
    const municipios = dadosProgresso.municipios || {};
    const estatisticas = {
        porStatus: {},
        progressoMedio: 0,
        p1Concluidos: 0,
        totalEntidades: 0
    };
    
    // Inicializar contadores de status
    STATUS_WORKFLOW_PNSB.forEach(status => {
        estatisticas.porStatus[status] = 0;
    });
    
    let totalProgresso = 0;
    let municipiosComDados = 0;
    
    MUNICIPIOS_PNSB.forEach(municipio => {
        const dados = municipios[municipio] || { status: 'agendada' };
        const status = dados.status || 'agendada';
        
        // Contar status
        if (estatisticas.porStatus[status] !== undefined) {
            estatisticas.porStatus[status]++;
        }
        
        // Calcular progresso médio
        const progresso = dados.progresso_pnsb || calcularProgressoPorStatus(status);
        totalProgresso += progresso;
        municipiosComDados++;
        
        // Contar P1 concluídos
        if (dados.p1_concluido) {
            estatisticas.p1Concluidos++;
        }
        
        // Contar entidades
        if (dados.entidades_count) {
            estatisticas.totalEntidades += dados.entidades_count;
        }
    });
    
    estatisticas.progressoMedio = municipiosComDados > 0 ? 
        Math.round(totalProgresso / municipiosComDados) : 0;
    
    return estatisticas;
}

// Atualizar estatísticas com workflow completo
function atualizarEstatisticasWorkflow() {
    const stats = calcularEstatisticasDetalhadas();
    
    // Atualizar elementos se existirem
    const elementos = {
        'municipios-finalizados': stats.porStatus['finalizada'] || 0,
        'municipios-visitados': (stats.porStatus['realizada'] || 0) + (stats.porStatus['questionários concluídos'] || 0) + (stats.porStatus['questionários validados'] || 0) + (stats.porStatus['finalizada'] || 0),
        'progresso-geral': `${stats.progressoMedio}%`,
        'p1-concluidos': stats.p1Concluidos,
        'total-entidades': stats.totalEntidades
    };
    
    Object.entries(elementos).forEach(([id, valor]) => {
        const elemento = document.getElementById(id);
        if (elemento) elemento.textContent = valor;
    });
    
    // Atualizar indicadores visuais por status (se existirem)
    Object.entries(stats.porStatus).forEach(([status, count]) => {
        const elemento = document.getElementById(`status-${status.replace(/\s+/g, '-')}`);
        if (elemento) elemento.textContent = count;
    });
}

// Atualizar lista com status detalhados
function atualizarVistaListaComStatus() {
    if (currentView !== 'list') return;
    
    const container = document.getElementById('list-view');
    if (!container) return;
    
    let html = '';
    MUNICIPIOS_PNSB.forEach(municipio => {
        const dados = dadosProgresso.municipios?.[municipio] || {};
        const status = dados.status || 'agendada';
        const cor = STATUS_COLORS[status] || '#6c757d';
        const progresso = dados.progresso_pnsb || calcularProgressoPorStatus(status);
        
        html += `
            <div class="col-md-6 mb-3">
                <div class="progress-card" style="border-left: 4px solid ${cor}">
                    <div class="progress-header">
                        <div class="municipality-name">${municipio}</div>
                        <span class="progress-status" style="background-color: ${cor}">
                            ${status}
                        </span>
                    </div>
                    <div class="progress-details">
                        <div class="detail-item">
                            <div class="detail-value">${progresso}%</div>
                            <div class="detail-label">Progresso PNSB</div>
                        </div>
                        ${dados.entidades_count ? `
                            <div class="detail-item">
                                <div class="detail-value">${dados.entidades_count}</div>
                                <div class="detail-label">Entidades</div>
                            </div>
                        ` : ''}
                        <div class="detail-item">
                            <div class="detail-value">${dados.p1_concluido ? '✅' : '⏳'}</div>
                            <div class="detail-label">P1 Status</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Sobrescrever função de atualização principal
const atualizarMapaOriginal = atualizarMapa;
atualizarMapa = function() {
    atualizarMarcadoresComStatus();
};

const atualizarVistaListaOriginal = atualizarVistaLista;
atualizarVistaLista = function() {
    atualizarVistaListaComStatus();
};

console.log('🎆 Sistema PNSB 2024 - Versão Completa: Rotas + Filtros + P1/P2/P3 + Status Workflow carregado!');

// ====================================
// SISTEMA DE CALENDÁRIO COM VISITAS E ROTAS OTIMIZADAS
// ====================================

// calendarData agora é uma propriedade global do window para evitar conflitos de escopo
window.calendarData = {
    currentMonth: new Date().getMonth(),
    currentYear: new Date().getFullYear(),
    selectedDate: null,
    visitas: {},
    currentView: 'map' // 'map', 'list', 'calendar'
};

// Função alternarCalendario já declarada acima - removendo duplicata

// Inicializar calendário
function inicializarCalendario() {
    // Garantir que calendarData existe
    if (!window.calendarData) {
        window.calendarData = {
            currentMonth: new Date().getMonth(),
            currentYear: new Date().getFullYear(),
            selectedDate: null,
            visitas: {},
            currentView: 'calendar'
        };
    }
    
    atualizarTituloMes();
    gerarGridCalendario();
    definirDataHoje();
}

// Atualizar título do mês
function atualizarTituloMes() {
    const meses = [
        'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
    ];
    
    const titulo = document.getElementById('calendar-month-year');
    if (titulo) {
        titulo.textContent = `${meses[window.calendarData.currentMonth]} ${window.calendarData.currentYear}`;
    }
}

// Gerar grid do calendário
function gerarGridCalendario() {
    const grid = document.getElementById('calendar-grid');
    if (!grid) return;
    
    // Cabeçalhos dos dias da semana
    const diasSemana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
    let html = '';
    
    diasSemana.forEach(dia => {
        html += `<div class="calendar-day-header">${dia}</div>`;
    });
    
    // Dias do mês
    const primeiroDia = new Date(window.calendarData.currentYear, window.calendarData.currentMonth, 1);
    const ultimoDia = new Date(window.calendarData.currentYear, window.calendarData.currentMonth + 1, 0);
    const diasNoMes = ultimoDia.getDate();
    const diaSemanaInicio = primeiroDia.getDay();
    
    // Dias do mês anterior (cinza)
    for (let i = diaSemanaInicio - 1; i >= 0; i--) {
        const diaAnterior = new Date(window.calendarData.currentYear, window.calendarData.currentMonth, -i);
        html += gerarDiaCalendario(diaAnterior, true);
    }
    
    // Dias do mês atual
    for (let dia = 1; dia <= diasNoMes; dia++) {
        const data = new Date(window.calendarData.currentYear, window.calendarData.currentMonth, dia);
        html += gerarDiaCalendario(data, false);
    }
    
    // Dias do próximo mês (cinza)
    const totalCelulas = Math.ceil((diasNoMes + diaSemanaInicio) / 7) * 7;
    const diasProximos = totalCelulas - diasNoMes - diaSemanaInicio;
    for (let dia = 1; dia <= diasProximos; dia++) {
        const proximaData = new Date(window.calendarData.currentYear, window.calendarData.currentMonth + 1, dia);
        html += gerarDiaCalendario(proximaData, true);
    }
    
    grid.innerHTML = html;
}

// Gerar HTML de um dia do calendário
function gerarDiaCalendario(data, outroMes) {
    const hoje = new Date();
    const isHoje = data.toDateString() === hoje.toDateString();
    const isSelected = window.calendarData.selectedDate && data.toDateString() === window.calendarData.selectedDate.toDateString();
    const dataKey = formatarDataChave(data);
    const visitasDia = window.calendarData.visitas[dataKey] || [];
    
    let classes = 'calendar-day';
    if (outroMes) classes += ' other-month';
    if (isHoje) classes += ' today';
    if (isSelected) classes += ' selected';
    
    let visitasHtml = '';
    visitasDia.slice(0, 3).forEach(visita => {
        visitasHtml += `<div class="visit-indicator status-${visita.status}">${visita.municipio}</div>`;
    });
    
    if (visitasDia.length > 3) {
        visitasHtml += `<div class="visit-indicator">+${visitasDia.length - 3}</div>`;
    }
    
    return `
        <div class="${classes}" onclick="selecionarDia('${data.toISOString()}')">
            <div class="day-number">${data.getDate()}</div>
            <div class="day-visits">${visitasHtml}</div>
        </div>
    `;
}

// Selecionar dia no calendário
function selecionarDia(dataISO) {
    window.calendarData.selectedDate = new Date(dataISO);
    const dataKey = formatarDataChave(window.calendarData.selectedDate);
    
    // Atualizar visual do calendário
    gerarGridCalendario();
    
    // Atualizar painel lateral
    atualizarPainelDia(dataKey);
}

// Atualizar painel lateral com visitas do dia
function atualizarPainelDia(dataKey) {
    const visitasDia = window.calendarData.visitas[dataKey] || [];
    const selectedDateElement = document.getElementById('selected-date');
    const visitsList = document.getElementById('visits-list');
    const dayActions = document.getElementById('day-actions');
    
    if (selectedDateElement) {
        selectedDateElement.textContent = window.calendarData.selectedDate.toLocaleDateString('pt-BR');
    }
    
    if (visitsList) {
        if (visitasDia.length === 0) {
            visitsList.innerHTML = `
                <div class="empty-state text-center text-muted py-4">
                    <i class="fas fa-calendar-plus fa-2x mb-2"></i>
                    <p>Nenhuma visita agendada para este dia</p>
                </div>
            `;
        } else {
            let html = '';
            visitasDia.forEach(visita => {
                const cor = STATUS_COLORS[visita.status] || '#6c757d';
                html += `
                    <div class="visit-item">
                        <div class="visit-header">
                            <div class="visit-time">${visita.hora_inicio}</div>
                            <div class="visit-status" style="background-color: ${cor}">
                                ${visita.status}
                            </div>
                        </div>
                        <div class="visit-municipality">${visita.municipio}</div>
                        <div class="visit-local">${visita.local}</div>
                    </div>
                `;
            });
            visitsList.innerHTML = html;
        }
    }
    
    if (dayActions) {
        dayActions.style.display = visitasDia.length > 0 ? 'block' : 'none';
    }
}

// Navegar entre meses
function navegarMes(direcao) {
    window.calendarData.currentMonth += direcao;
    if (window.calendarData.currentMonth > 11) {
        window.calendarData.currentMonth = 0;
        window.calendarData.currentYear++;
    } else if (window.calendarData.currentMonth < 0) {
        window.calendarData.currentMonth = 11;
        window.calendarData.currentYear--;
    }
    
    atualizarTituloMes();
    gerarGridCalendario();
    carregarVisitasCalendario();
}

// Carregar visitas do calendário
async function carregarVisitasCalendario() {
    try {
        const response = await fetch('/api/visitas');
        if (response.ok) {
            const data = await response.json();
            const visitas = data.data || data;
            
            // Organizar visitas por data
            window.calendarData.visitas = {};
            visitas.forEach(visita => {
                const dataKey = visita.data.split('/').reverse().join('-'); // DD/MM/YYYY -> YYYY-MM-DD
                if (!window.calendarData.visitas[dataKey]) {
                    window.calendarData.visitas[dataKey] = [];
                }
                window.calendarData.visitas[dataKey].push(visita);
            });
            
            // Atualizar calendário
            gerarGridCalendario();
            atualizarEstatisticasMes();
            
            console.log('✅ Visitas do calendário carregadas');
        }
    } catch (error) {
        console.error('❌ Erro ao carregar visitas do calendário:', error);
    }
}

// Atualizar estatísticas do mês
function atualizarEstatisticasMes() {
    const inicioMes = new Date(window.calendarData.currentYear, window.calendarData.currentMonth, 1);
    const fimMes = new Date(window.calendarData.currentYear, window.calendarData.currentMonth + 1, 0);
    
    let totalVisitas = 0;
    let visitasConcluidas = 0;
    let municipiosUnicos = new Set();
    
    Object.entries(window.calendarData.visitas).forEach(([dataKey, visitas]) => {
        const data = new Date(dataKey);
        if (data >= inicioMes && data <= fimMes) {
            totalVisitas += visitas.length;
            visitas.forEach(visita => {
                municipiosUnicos.add(visita.municipio);
                if (['finalizada', 'questionários validados'].includes(visita.status)) {
                    visitasConcluidas++;
                }
            });
        }
    });
    
    const eficiencia = totalVisitas > 0 ? Math.round((visitasConcluidas / totalVisitas) * 100) : 0;
    
    // Atualizar elementos
    const elementos = {
        'total-visits-month': totalVisitas,
        'completed-visits-month': visitasConcluidas,
        'municipalities-month': municipiosUnicos.size,
        'efficiency-month': `${eficiencia}%`
    };
    
    Object.entries(elementos).forEach(([id, valor]) => {
        const elemento = document.getElementById(id);
        if (elemento) elemento.textContent = valor;
    });
}

// Otimizar rota do dia selecionado
async function otimizarRotaDia() {
    if (!window.calendarData.selectedDate) {
        showToast('Selecione uma data primeiro', 'warning');
        return;
    }
    
    const dataKey = formatarDataChave(window.calendarData.selectedDate);
    const visitasDia = window.calendarData.visitas[dataKey] || [];
    
    if (visitasDia.length < 2) {
        showToast('Necessário pelo menos 2 visitas para otimizar rota', 'warning');
        return;
    }
    
    // Otimizar usando Google Maps API (simulação)
    const municipios = visitasDia.map(v => v.municipio);
    const rotaOtimizada = await simularCalculoRota(municipios, 'Itajaí', 'distance');
    
    // Mostrar resultado em modal
    mostrarModalRota(rotaOtimizada, visitasDia);
}

// Mostrar modal com rota otimizada
function mostrarModalRota(rota, visitas) {
    const routeDetails = document.getElementById('route-details');
    if (!routeDetails) return;
    
    let html = `
        <div class="mb-3">
            <h6 class="text-light">Resumo da Rota</h6>
            <div class="row g-3">
                <div class="col-md-3">
                    <div class="text-center">
                        <div class="fs-4 text-primary">${rota.distancia} km</div>
                        <small class="text-muted">Distância Total</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <div class="fs-4 text-success">${Math.floor(rota.tempo / 60)}h ${rota.tempo % 60}min</div>
                        <small class="text-muted">Tempo Estimado</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <div class="fs-4 text-info">${rota.sequencia.length}</div>
                        <small class="text-muted">Municípios</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <div class="fs-4 text-warning">${rota.eficiencia}%</div>
                        <small class="text-muted">Eficiência</small>
                    </div>
                </div>
            </div>
        </div>
        
        <h6 class="text-light">Sequência Otimizada</h6>
        <div class="sequence-optimized">
    `;
    
    rota.sequencia.forEach((municipio, index) => {
        const visita = visitas.find(v => v.municipio === municipio);
        html += `
            <div class="d-flex align-items-center mb-2 p-2 bg-dark rounded">
                <div class="me-3 text-primary fw-bold">${index + 1}</div>
                <div class="flex-grow-1">
                    <div class="text-light">${municipio}</div>
                    <small class="text-muted">${visita?.local || 'Local não especificado'}</small>
                </div>
                <div class="text-success">${visita?.hora_inicio || '--:--'}</div>
            </div>
        `;
    });
    
    html += '</div>';
    routeDetails.innerHTML = html;
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('route-modal'));
    modal.show();
}

// Utilitário para formatar data como chave
function formatarDataChave(data) {
    return data.toISOString().split('T')[0]; // YYYY-MM-DD
}

// Definir data de hoje
function definirDataHoje() {
    const hoje = new Date();
    const inputData = document.getElementById('route-date');
    if (inputData && !inputData.value) {
        inputData.value = formatarDataChave(hoje);
    }
}

// Funções auxiliares do calendário
function toggleCalendarView() {
    // Implementar vista mensal/semanal se necessário
    console.log('Toggle calendar view');
}

function adicionarVisitaDia() {
    // Redirecionar para formulário de nova visita
    window.location.href = '/visitas?data=' + formatarDataChave(window.calendarData.selectedDate);
}

function exportarRotaDia() {
    if (!window.calendarData.selectedDate) return;
    
    const dataKey = formatarDataChave(window.calendarData.selectedDate);
    const visitasDia = window.calendarData.visitas[dataKey] || [];
    
    const conteudo = `
AGENDA PNSB 2024 - ${window.calendarData.selectedDate.toLocaleDateString('pt-BR')}
${'='.repeat(50)}

${visitasDia.map((visita, index) => `
${index + 1}. ${visita.hora_inicio} - ${visita.municipio}
   Local: ${visita.local}
   Status: ${visita.status}
   Tipo: ${visita.tipo_pesquisa}
`).join('\n')}

Total de visitas: ${visitasDia.length}
Gerado em: ${new Date().toLocaleString('pt-BR')}
    `.trim();
    
    const blob = new Blob([conteudo], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `agenda_pnsb_${formatarDataChave(window.calendarData.selectedDate)}.txt`;
    a.click();
    URL.revokeObjectURL(url);
}

function aplicarRotaOtimizada() {
    // Implementar aplicação da rota otimizada
    showToast('Rota aplicada com sucesso!', 'success');
    const modal = bootstrap.Modal.getInstance(document.getElementById('route-modal'));
    modal.hide();
}

console.log('📅 Sistema de Calendário com Rotas Otimizadas carregado!');
</script>
{% endblock %}
