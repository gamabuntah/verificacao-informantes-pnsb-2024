{% extends "base.html" %}

{% block title %}Dashboard PNSB 2024 - Mapa de Progresso{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Security: Store API availability flag instead of key
    window.GOOGLE_MAPS_AVAILABLE = {{ 'true' if google_maps_api_key else 'false' }};
    // CSRF token for API calls
    window.CSRF_TOKEN = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
</script>
{% if google_maps_api_key %}
<script>
    // Carregamento otimizado do Google Maps
    (function() {
        const script = document.createElement('script');
        script.src = 'https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=geometry&loading=async&callback=initGoogleMaps';
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
    })();
</script>
<script>
    // Callback para quando Google Maps carregar
    window.initGoogleMaps = function() {
        console.log('✅ Google Maps JavaScript API carregado com sucesso');
        
        // Silenciar erros de telemetria do Google Maps (normais)
        const originalConsoleError = console.error;
        console.error = function(...args) {
            const message = args.join(' ');
            if (message.includes('gen_204') || message.includes('ERR_BLOCKED_BY_CLIENT')) {
                return; // Ignorar erros de telemetria
            }
            originalConsoleError.apply(console, args);
        };
        
        // Re-verificar disponibilidade após carregamento
        if (window.routeOptimizer) {
            window.routeOptimizer.checkGoogleMapsAPI();
        }
        
        // Inicializar dashboard após carregamento
        if (window.dashboardPNSB) {
            window.dashboardPNSB.initMaps();
        }
    };
</script>
{% endif %}
<style>
/* ===== NOVA ESTRUTURA INTEGRADA ===== */

/* Prevenir vazamento horizontal global */
html, body {
    overflow-x: hidden;
    max-width: 100vw;
}

/* Container principal para evitar vazamento */
.container, .container-fluid {
    max-width: 100vw;
    overflow-x: hidden;
}

/* Prevenir vazamento em qualquer elemento */
* {
    box-sizing: border-box;
}

.row {
    margin-left: 0 !important;
    margin-right: 0 !important;
    max-width: 100%;
}

/* Limitar largura do conteúdo principal */
.container-fluid, .container {
    padding-left: 20px;
    padding-right: 20px;
    max-width: calc(100vw - 40px); /* Garantir espaço nas laterais */
}

/* Garantir que nenhum elemento ultrapasse a viewport */
.col, .col-* {
    max-width: 100%;
    overflow: hidden;
}

/* Controle rigoroso de largura */
body > .container-fluid,
body > .container,
.main-content,
.content-wrapper {
    width: 100% !important;
    max-width: 100vw !important;
    overflow-x: hidden !important;
}

/* Header Integrado */
.pnsb-header-integrated {
    background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%);
    border-radius: 16px;
    padding: 20px 30px;
    margin-bottom: 20px;
    border: 1px solid rgba(16, 185, 129, 0.2);
    position: relative;
    overflow: hidden;
    max-width: 100%;
    box-sizing: border-box;
}

.pnsb-header-integrated::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #10B981 0%, #059669 50%, #047857 100%);
    border-radius: 16px 16px 0 0;
}

.header-title-section {
    flex: 1;
}

.pnsb-main-title {
    color: #F8FAFC;
    font-size: 24px;
    font-weight: 700;
    margin: 0 0 8px 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.header-status {
    display: flex;
    gap: 15px;
    align-items: center;
}

.status-badge {
    background: rgba(16, 185, 129, 0.2);
    color: #10B981;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
}

.update-time {
    color: #94A3B8;
    font-size: 12px;
}

.header-actions {
    display: flex;
    gap: 20px;
    align-items: center;
}

/* Filtros Rápidos */
.quick-filters {
    display: flex;
    gap: 8px;
    background: rgba(15, 23, 42, 0.5);
    padding: 8px;
    border-radius: 12px;
}

.filter-btn {
    background: rgba(55, 65, 81, 0.8);
    border: 1px solid rgba(75, 85, 99, 0.5);
    color: #D1D5DB;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 6px;
}

.filter-btn:hover {
    background: rgba(75, 85, 99, 0.8);
    border-color: rgba(156, 163, 175, 0.5);
    transform: translateY(-1px);
}

.filter-btn.active,
.filter-btn.p1.active { background: #DC2626; border-color: #DC2626; color: white; }
.filter-btn.p2.active { background: #D97706; border-color: #D97706; color: white; }
.filter-btn.p3.active { background: #10B981; border-color: #10B981; color: white; }

/* Ações Principais */
.main-actions {
    display: flex;
    gap: 8px;
}

.action-btn {
    background: rgba(55, 65, 81, 0.8);
    border: 1px solid rgba(75, 85, 99, 0.5);
    color: #D1D5DB;
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.action-btn.primary:hover { background: #3B82F6; border-color: #3B82F6; }
.action-btn.success:hover { background: #10B981; border-color: #10B981; }
.action-btn.info:hover { background: #06B6D4; border-color: #06B6D4; }
.action-btn.warning:hover { background: #F59E0B; border-color: #F59E0B; }

/* Seção Principal */
.main-section {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    min-height: 600px;
    position: relative;
    z-index: 2;
    clear: both;
    max-width: 100%;
    box-sizing: border-box;
    /* Remove overflow hidden para não cortar o sidebar */
}

.map-container-new {
    flex: 1 1 auto;
    background: linear-gradient(135deg, #1E293B 0%, #374151 100%);
    border-radius: 16px;
    padding: 20px;
    position: relative;
    overflow: hidden;
    min-width: 0;
    max-width: calc(100% - 380px);
}

/* Ajuste quando sidebar não está presente */
.main-section:not(:has(.sidebar-compact)) .map-container-new {
    max-width: 100%;
}

/* Responsividade do container do mapa */
@media (max-width: 1400px) {
    .map-container-new {
        max-width: calc(100% - 360px);
    }
}

.map-wrapper {
    position: relative;
    height: 100%;
}

.map-controls {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-width: 200px;
}

.map-legend {
    background: rgba(15, 23, 42, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 8px;
    padding: 10px;
    border: 1px solid rgba(16, 185, 129, 0.2);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.map-legend h6 {
    color: #F8FAFC;
    margin: 0 0 10px 0;
    font-size: 14px;
    font-weight: 600;
}

.legend-items {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 4px;
}

.legend-color.p1 { background: #DC2626; }
.legend-color.p2 { background: #D97706; }
.legend-color.p3 { background: #10B981; }
.legend-color.completed { background: #3B82F6; }

.legend-item span {
    color: #F1F5F9;
    font-size: 12px;
}

/* Mini Dashboard */
.mini-dashboard {
    background: rgba(15, 23, 42, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 8px;
    padding: 10px;
    border: 1px solid rgba(16, 185, 129, 0.2);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.mini-kpi {
    display: flex;
    align-items: center;
    gap: 8px;
}

.mini-value {
    color: #10B981;
    font-weight: 700;
    font-size: 16px;
}

.mini-label {
    color: #CBD5E1;
    font-size: 11px;
}

#mapa-progresso {
    width: 100%;
    height: 500px;
    border-radius: 12px;
    border: 2px solid rgba(16, 185, 129, 0.2);
    position: relative;
    z-index: 1;
}

/* Sidebar Compacto */
.sidebar-compact {
    width: 340px;
    min-width: 320px;
    max-width: 360px;
    background: linear-gradient(135deg, #1E293B 0%, #374151 100%);
    border-radius: 16px;
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    height: fit-content;
    box-sizing: border-box;
    flex-shrink: 0;
    margin-left: auto;
    overflow: visible;
}

.kpis-essential {
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px;
    width: 100%;
    max-width: 100%;
    overflow: hidden;
}

.kpi-item {
    background: rgba(15, 23, 42, 0.6);
    border-radius: 12px;
    padding: 14px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    border: 1px solid transparent;
    transition: all 0.2s ease;
    min-width: 0;
    box-sizing: border-box;
    overflow: hidden;
    width: 100%;
}

.kpi-item:hover {
    border-color: rgba(16, 185, 129, 0.3);
    transform: translateY(-2px);
}

.kpi-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    flex-shrink: 0; /* Não permite que o ícone encolha */
}

.kpi-item.mrs .kpi-icon { background: rgba(139, 92, 246, 0.2); color: #8B5CF6; }
.kpi-item.map .kpi-icon { background: rgba(6, 182, 212, 0.2); color: #06B6D4; }
.kpi-item.visits .kpi-icon { background: rgba(34, 197, 94, 0.2); color: #22C55E; }
.kpi-item.entities .kpi-icon { background: rgba(249, 115, 22, 0.2); color: #F97316; }

.kpi-data {
    display: flex;
    flex-direction: column;
    min-width: 0; /* Permite que o texto encolha */
    flex: 1;
    overflow: hidden;
}

.kpi-value {
    color: #F8FAFC;
    font-weight: 700;
    font-size: 18px;
    line-height: 1.2;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.kpi-label {
    color: #94A3B8;
    font-size: 12px;
    font-weight: 500;
    line-height: 1.2;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.municipalities-summary h6 {
    color: #F8FAFC;
    margin: 0 0 15px 0;
    font-size: 14px;
    font-weight: 600;
}

.municipalities-list {
    max-height: 200px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.quick-access {
    display: flex;
    gap: 8px;
}

.quick-btn {
    flex: 1;
    background: rgba(15, 23, 42, 0.6);
    border: 1px solid rgba(75, 85, 99, 0.3);
    color: #D1D5DB;
    padding: 12px 8px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    font-size: 11px;
}

.quick-btn:hover {
    background: rgba(16, 185, 129, 0.2);
    border-color: rgba(16, 185, 129, 0.4);
    transform: translateY(-2px);
}

/* Seção Expandível com Tabs */
.advanced-section {
    background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%);
    border-radius: 16px;
    margin-bottom: 20px;
    border: 1px solid rgba(16, 185, 129, 0.2);
    overflow: hidden;
    display: none;
    position: relative;
    z-index: 1;
    clear: both;
}

.advanced-section.open {
    display: block;
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}

.tab-navigation {
    background: rgba(15, 23, 42, 0.8);
    display: flex;
    border-bottom: 1px solid rgba(75, 85, 99, 0.3);
    position: relative;
}

.tab-btn {
    background: transparent;
    border: none;
    color: #94A3B8;
    padding: 16px 20px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    font-weight: 500;
    border-bottom: 3px solid transparent;
}

.tab-btn:hover {
    color: #F8FAFC;
    background: rgba(55, 65, 81, 0.5);
}

.tab-btn.active {
    color: #10B981;
    background: rgba(16, 185, 129, 0.1);
    border-bottom-color: #10B981;
}

.tab-close {
    margin-left: auto;
    background: transparent;
    border: none;
    color: #94A3B8;
    padding: 16px 20px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.tab-close:hover {
    color: #EF4444;
    background: rgba(239, 68, 68, 0.1);
}

.tab-content {
    padding: 30px;
}

.tab-pane {
    display: none;
}

.tab-pane.active {
    display: block;
}

/* Ocultar estrutura antiga para evitar sobreposição */
#map-view {
    display: none !important;
}

/* Prevenir sobreposições */
.container-fluid > .row {
    position: relative;
    z-index: auto;
}

/* Municipality Items */
.municipality-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(15, 23, 42, 0.4);
    border: 1px solid rgba(75, 85, 99, 0.3);
    border-radius: 8px;
    padding: 8px 12px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.municipality-item:hover {
    background: rgba(16, 185, 129, 0.1);
    border-color: rgba(16, 185, 129, 0.3);
    transform: translateX(4px);
}

.municipality-icon {
    font-size: 14px;
}

.municipality-name {
    color: #F8FAFC;
    font-size: 12px;
    font-weight: 500;
    flex: 1;
    margin-left: 8px;
}

.municipality-progress {
    color: #10B981;
    font-size: 11px;
    font-weight: 600;
}

.municipality-item.concluido {
    border-color: rgba(34, 197, 94, 0.4);
    background: rgba(34, 197, 94, 0.1);
}

.municipality-item.em-andamento {
    border-color: rgba(249, 115, 22, 0.4);
    background: rgba(249, 115, 22, 0.1);
}

.municipality-item.pendente {
    border-color: rgba(156, 163, 175, 0.4);
    background: rgba(156, 163, 175, 0.1);
}

.municipality-item.atrasado {
    border-color: rgba(239, 68, 68, 0.4);
    background: rgba(239, 68, 68, 0.1);
}

/* Ajuste específico para evitar corte do sidebar */
.main-section {
    margin-right: 10px; /* Margem para não encostar na borda */
}

/* Responsividade melhorada */
@media (max-width: 1400px) {
    .sidebar-compact {
        width: 300px;
        min-width: 280px;
        max-width: 320px;
    }
    
    .main-section {
        margin-right: 15px; /* Mais margem em telas menores */
    }
    
    .kpi-item {
        padding: 10px;
        gap: 6px;
    }
    
    .kpi-value {
        font-size: 14px;
    }
    
    .kpi-label {
        font-size: 9px;
    }
}

@media (max-width: 1200px) {
    .main-section {
        flex-direction: column;
        gap: 15px;
        margin-right: 10px; /* Reset margin em mobile */
    }
    
    .sidebar-compact {
        width: 100%;
        min-width: auto;
        max-width: 100%;
    }
    
    .kpis-essential {
        grid-template-columns: repeat(4, 1fr);
    }
    
    .header-actions {
        flex-direction: column;
        gap: 10px;
    }
    
    .quick-filters {
        order: 2;
    }
}

@media (max-width: 1024px) {
    .main-section {
        gap: 15px;
        padding: 0 10px;
    }
    
    .sidebar-compact {
        width: 100%;
        min-width: auto;
        max-width: 100%;
        flex-shrink: 1;
    }
}

/* Para telas muito largas, limitar o sidebar */
@media (min-width: 1600px) {
    .sidebar-compact {
        width: 320px;
        min-width: 320px;
        max-width: 360px;
    }
}

@media (max-width: 768px) {
    .pnsb-header-integrated {
        padding: 15px 20px;
    }
    
    .pnsb-main-title {
        font-size: 20px;
    }
    
    .header-actions {
        width: 100%;
    }
    
    .quick-filters {
        width: 100%;
        justify-content: center;
    }
    
    .main-actions {
        justify-content: center;
    }
    
    .kpis-essential {
        grid-template-columns: 1fr 1fr;
    }
    
    .tab-navigation {
        flex-wrap: wrap;
    }
    
    .tab-btn {
        padding: 12px 16px;
        font-size: 12px;
    }
    
    #mapa-progresso {
        height: 400px;
    }
}

@media (max-width: 480px) {
    .filter-btn {
        padding: 6px 8px;
        font-size: 11px;
    }
    
    .filter-btn i {
        display: none;
    }
    
    .action-btn {
        width: 36px;
        height: 36px;
    }
    
    .kpis-essential {
        grid-template-columns: 1fr;
    }
    
    .kpi-item {
        padding: 12px;
    }
    
    .map-controls {
        position: relative;
        top: 0;
        left: 0;
        margin-bottom: 15px;
    }
    
    .map-legend,
    .mini-dashboard {
        position: relative;
        margin-bottom: 10px;
    }
}

/* Animações melhoradas */
.kpi-item,
.municipality-item,
.filter-btn,
.action-btn,
.quick-btn {
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.advanced-section.open {
    animation: slideDown 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes slideDown {
    from { 
        opacity: 0; 
        transform: translateY(-30px) scale(0.95); 
    }
    to { 
        opacity: 1; 
        transform: translateY(0) scale(1); 
    }
}

/* Melhorias de acessibilidade */
.filter-btn:focus,
.action-btn:focus,
.quick-btn:focus,
.tab-btn:focus {
    outline: 2px solid #10B981;
    outline-offset: 2px;
}

.municipality-item:focus {
    outline: 2px solid #10B981;
    outline-offset: 1px;
}

/* Dashboard PNSB Original */
.dashboard-pnsb {
    background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%);
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 25px;
    position: relative;
    overflow: hidden;
}

.dashboard-pnsb::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #10B981 0%, #059669 50%, #047857 100%);
    border-radius: 20px 20px 0 0;
}

.pnsb-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    flex-wrap: wrap;
    gap: 15px;
}

.pnsb-title {
    color: #F8FAFC;
    font-size: 28px;
    font-weight: 700;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 12px;
}

.pnsb-badge {
    background: linear-gradient(135deg, #10B981 0%, #059669 100%);
    color: #F8FAFC;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.pnsb-controls {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.filter-btn {
    background: #334155;
    color: #CBD5E1;
    border: 2px solid #475569;
    padding: 8px 16px;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.filter-btn:hover {
    background: #475569;
    border-color: #64748B;
    color: #F1F5F9;
}

.filter-btn.active {
    background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
    border-color: #1D4ED8;
    color: #F8FAFC;
}

.filter-btn.p1.active {
    background: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%);
    border-color: #991B1B;
}

.filter-btn.p2.active {
    background: linear-gradient(135deg, #D97706 0%, #B45309 100%);
    border-color: #92400E;
}

.filter-btn.p3.active {
    background: linear-gradient(135deg, #10B981 0%, #059669 100%);
    border-color: #047857;
}

/* ===== KPIs PNSB ===== */
.kpis-pnsb {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.kpi-card {
    background: linear-gradient(135deg, #1E293B 0%, #334155 100%);
    border: 2px solid #475569;
    border-radius: 16px;
    padding: 24px;
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.kpi-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--kpi-color, #64748B);
    transition: all 0.3s ease;
}

.kpi-card:hover {
    transform: translateY(-3px);
    border-color: #64748B;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
}

.kpi-card:hover::before {
    height: 5px;
}

.kpi-card.p1 { --kpi-color: #DC2626; }
.kpi-card.p2 { --kpi-color: #D97706; }
.kpi-card.p3 { --kpi-color: #10B981; }
.kpi-card.municipios { --kpi-color: #3B82F6; }
.kpi-card.mrs { --kpi-color: #8B5CF6; }
.kpi-card.map { --kpi-color: #06B6D4; }

.kpi-icon {
    font-size: 32px;
    margin-bottom: 12px;
    color: var(--kpi-color, #64748B);
}

.kpi-value {
    font-size: 36px;
    font-weight: 700;
    color: #F8FAFC;
    margin-bottom: 8px;
    line-height: 1;
}

.kpi-label {
    color: #94A3B8;
    font-size: 14px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}

.kpi-progress {
    background: #475569;
    height: 6px;
    border-radius: 3px;
    overflow: hidden;
    margin-top: 12px;
    position: relative;
}

.kpi-progress-bar {
    height: 100%;
    background: var(--kpi-color, #64748B);
    border-radius: 3px;
    transition: width 0.6s ease;
    position: relative;
}

.kpi-progress-bar::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.2) 50%, transparent 100%);
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.kpi-meta {
    color: #64748B;
    font-size: 12px;
    margin-top: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* ===== ALERTAS CRÍTICOS ===== */
.alertas-criticos {
    background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%);
    border: 2px solid #475569;
    border-radius: 16px;
    padding: 25px;
    margin-bottom: 25px;
}

.alertas-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
}

.alertas-icon {
    font-size: 24px;
    color: #F59E0B;
}

.alertas-title {
    color: #F8FAFC;
    font-size: 18px;
    font-weight: 600;
    margin: 0;
}

.alerta-item {
    background: rgba(220, 38, 38, 0.1);
    border-left: 4px solid #DC2626;
    padding: 12px 16px;
    border-radius: 0 8px 8px 0;
    margin-bottom: 10px;
    transition: all 0.3s ease;
}

.alerta-item:hover {
    background: rgba(220, 38, 38, 0.15);
    transform: translateX(3px);
}

.alerta-item.warning {
    background: rgba(245, 158, 11, 0.1);
    border-left-color: #F59E0B;
}

.alerta-item.info {
    background: rgba(59, 130, 246, 0.1);
    border-left-color: #3B82F6;
}

.alerta-texto {
    color: #F1F5F9;
    font-size: 14px;
    margin: 0;
    line-height: 1.4;
}

.alerta-meta {
    color: #94A3B8;
    font-size: 12px;
    margin-top: 4px;
}

/* ===== MAPA E PROGRESSO ===== */
.map-container {
    background: #23263B;
    border-radius: 16px;
    overflow: hidden;
    position: relative;
    margin-bottom: 25px;
}

#mapa-progresso {
    height: 600px;
    width: 100%;
    border-radius: 16px;
}

.map-overlay {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(15, 23, 42, 0.9);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    padding: 15px;
    min-width: 200px;
    z-index: 1000;
}

.legend-container {
    background: #23263B;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}

.legend-item {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
}

.legend-color {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    margin-right: 10px;
}

.progress-card {
    background: #23263B;
    border: 2px solid #2D3142;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 15px;
    transition: all 0.3s ease;
}

.progress-card:hover {
    border-color: #5F5CFF;
    transform: translateY(-2px);
}

.progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.municipality-name {
    font-size: 18px;
    font-weight: 600;
    color: #F1F1F1;
}

.progress-status {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
}

.status-completed { background: #28a745; color: white; }
.status-in-progress { background: #ffc107; color: #212529; }
.status-pending { background: #6c757d; color: white; }
.status-blocked { background: #dc3545; color: white; }

/* Intelligent Status Styles */
.intelligent-status {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
}

.intelligent-status-badge {
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.intelligent-status-badge.aguardando-agendamento { background: #6c757d; color: white; }
.intelligent-status-badge.em-preparacao { background: #17a2b8; color: white; }
.intelligent-status-badge.pronto-para-visita { background: #20c997; color: white; }
.intelligent-status-badge.visita-realizada { background: #007bff; color: white; }
.intelligent-status-badge.questionarios-respondidos { background: #fd7e14; color: white; }
.intelligent-status-badge.questionarios-validados { background: #28a745; color: white; }
.intelligent-status-badge.processo-finalizado { background: #6f42c1; color: white; }

.dual-status {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px;
}

.questionnaire-status {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-top: 10px;
}

.questionnaire-item {
    background: rgba(45, 49, 66, 0.5);
    border-radius: 8px;
    padding: 8px;
    text-align: center;
}

.questionnaire-type {
    font-size: 10px;
    font-weight: 600;
    color: #B8BCC8;
    margin-bottom: 4px;
}

.questionnaire-progress {
    display: flex;
    justify-content: space-between;
    font-size: 10px;
}

.questionnaire-progress .responded {
    color: #ffc107;
}

.questionnaire-progress .validated {
    color: #28a745;
}

.checklist-progress {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
    gap: 5px;
}

.checklist-phase {
    flex: 1;
    background: rgba(45, 49, 66, 0.5);
    border-radius: 8px;
    padding: 8px;
    text-align: center;
}

.checklist-phase-title {
    font-size: 10px;
    font-weight: 600;
    color: #B8BCC8;
    margin-bottom: 4px;
}

.checklist-phase-value {
    font-size: 14px;
    font-weight: bold;
    color: #5F5CFF;
}

.next-action {
    background: rgba(110, 231, 183, 0.1);
    border: 1px solid #6EE7B7;
    border-radius: 8px;
    padding: 8px;
    margin-top: 10px;
    text-align: center;
}

.next-action-title {
    font-size: 10px;
    font-weight: 600;
    color: #6EE7B7;
    margin-bottom: 4px;
}

.next-action-text {
    font-size: 12px;
    color: #F1F1F1;
}

.error-message {
    background: rgba(220, 53, 69, 0.1);
    border: 1px solid #dc3545;
    color: #dc3545;
    padding: 8px;
    border-radius: 8px;
    text-align: center;
    font-size: 12px;
    margin-top: 10px;
}

.loading-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    color: #B8BCC8;
    font-size: 12px;
    padding: 10px;
}

.loading-spinner {
    width: 16px;
    height: 16px;
    border: 2px solid #2D3142;
    border-top: 2px solid #5F5CFF;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.progress-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
}

.detail-item {
    text-align: center;
}

.detail-value {
    font-size: 24px;
    font-weight: bold;
    color: #5F5CFF;
}

.detail-label {
    font-size: 12px;
    color: #B8BCC8;
    margin-top: 4px;
}

.progress-bar-container {
    background: #2D3142;
    border-radius: 10px;
    height: 20px;
    overflow: hidden;
    margin-bottom: 10px;
}

.progress-bar-fill {
    height: 100%;
    border-radius: 10px;
    transition: width 0.5s ease;
    background: linear-gradient(90deg, #5F5CFF 0%, #6EE7B7 100%);
}

.municipality-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.action-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-view { background: #17a2b8; color: white; }
.btn-edit { background: #28a745; color: white; }
.btn-contact { background: #ffc107; color: #212529; }
.btn-report { background: #6f42c1; color: white; }

.action-btn:hover {
    transform: translateY(-1px);
    opacity: 0.9;
}

.filters-container {
    background: #23263B;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}

.map-controls {
    position: absolute;
    top: 20px;
    right: 20px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.control-btn {
    background: #5F5CFF;
    color: white;
    border: none;
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.control-btn:hover {
    background: #6EE7B7;
}

.popup-content {
    max-width: 300px;
}

.popup-title {
    font-weight: bold;
    font-size: 16px;
    margin-bottom: 10px;
    color: #2D3142;
}

.popup-detail {
    margin-bottom: 5px;
    font-size: 14px;
}

.popup-progress {
    margin-top: 10px;
}

.popup-progress-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    margin-bottom: 4px;
}

.popup-progress-item span {
    font-weight: 500;
    color: #B8BCC8;
}

.popup-progress-bar {
    background: #e9ecef;
    border-radius: 10px;
    height: 8px;
    overflow: hidden;
}

.popup-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #5F5CFF 0%, #6EE7B7 100%);
    border-radius: 10px;
}

/* Estilos para Heatmap Avançado */
.heatmap-legend {
    position: absolute;
    bottom: 20px;
    left: 20px;
    background: rgba(35, 38, 59, 0.95);
    padding: 15px;
    border-radius: 12px;
    border: 1px solid #2D3142;
    backdrop-filter: blur(10px);
    z-index: 1000;
}

.heatmap-legend h6 {
    color: #F1F1F1;
    margin-bottom: 10px;
    font-size: 14px;
    font-weight: 600;
}

.legend-scale {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

.legend-color-gradient {
    width: 100px;
    height: 20px;
    border-radius: 10px;
    background: linear-gradient(90deg, 
        #dc3545 0%,    /* Crítico */
        #fd7e14 25%,   /* Baixo */
        #ffc107 50%,   /* Médio */
        #20c997 75%,   /* Alto */
        #28a745 100%   /* Completo */
    );
    border: 1px solid #fff;
}

.legend-labels {
    display: flex;
    justify-content: space-between;
    font-size: 10px;
    color: #B8BCC8;
    margin-top: 5px;
}

.marker-pulse {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.7; }
    100% { transform: scale(1); opacity: 1; }
}

.marker-priority-alta {
    box-shadow: 0 0 20px rgba(220, 53, 69, 0.6);
}

.marker-priority-media {
    box-shadow: 0 0 15px rgba(255, 193, 7, 0.4);
}

.marker-priority-baixa {
    box-shadow: 0 0 10px rgba(108, 117, 125, 0.3);
}

/* Filtros Essenciais */
.filters-essential {
    background: linear-gradient(135deg, #23263B 0%, #2D3142 100%);
    border: 1px solid #5F5CFF;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 20px;
    box-shadow: 0 8px 32px rgba(95, 92, 255, 0.1);
}

.filters-essential .form-select {
    border: 1px solid #5F5CFF;
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 14px;
    transition: all 0.3s ease;
}

.filters-essential .form-select:focus {
    border-color: #6EE7B7;
    box-shadow: 0 0 0 0.2rem rgba(110, 231, 183, 0.25);
}

.filters-essential .form-select option {
    background: #2D3142;
    color: #F1F1F1;
}

/* CSS dos filtros de range removido - desnecessário com filtros simplificados */

/* Estilos para Popup Detalhado */
.popup-custom .leaflet-popup-content-wrapper {
    background: #23263B;
    border: 1px solid #5F5CFF;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
}

.popup-custom .leaflet-popup-content {
    margin: 0;
    color: #F1F1F1;
}

.popup-section {
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #2D3142;
}

.popup-section:last-child {
    border-bottom: none;
}

.popup-section h6 {
    color: #6EE7B7;
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 8px;
}

.stat-box {
    background: #2D3142;
    border-radius: 8px;
    padding: 8px;
    text-align: center;
}

.stat-number {
    font-size: 18px;
    font-weight: bold;
    color: #5F5CFF;
}

.stat-label {
    font-size: 11px;
    color: #B8BCC8;
    margin-top: 2px;
}

.mini-progress {
    background: #2D3142;
    border-radius: 4px;
    height: 6px;
    overflow: hidden;
    margin-top: 4px;
}

.mini-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #5F5CFF 0%, #6EE7B7 100%);
    border-radius: 4px;
    transition: width 0.3s ease;
}

.analysis-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
}

.analysis-label {
    font-size: 12px;
    color: #B8BCC8;
}

.next-action {
    background: #2D3142;
    padding: 10px;
    border-radius: 8px;
    font-size: 13px;
    color: #F1F1F1;
    border-left: 3px solid #6EE7B7;
}

.popup-actions {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
}

.popup-actions .btn {
    font-size: 11px;
    padding: 4px 8px;
}

/* Estilos para Painel de Predição */
.prediction-panel {
    background: linear-gradient(135deg, #23263B 0%, #2D3142 100%);
    border: 2px solid #5F5CFF;
    border-radius: 20px;
    padding: 25px;
    box-shadow: 0 12px 48px rgba(95, 92, 255, 0.15);
    position: relative;
    overflow: hidden;
}

.prediction-panel::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #5F5CFF 0%, #6EE7B7 50%, #5F5CFF 100%);
    animation: shimmer 3s infinite;
}

@keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
}

.prediction-card {
    background: rgba(45, 49, 66, 0.8);
    border: 1px solid #5F5CFF;
    border-radius: 16px;
    padding: 20px;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.prediction-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(95, 92, 255, 0.3);
    border-color: #6EE7B7;
}

.prediction-icon {
    font-size: 2.5rem;
    color: #6EE7B7;
    margin-bottom: 15px;
    text-align: center;
}

.prediction-value {
    font-size: 2rem;
    font-weight: 900;
    color: #F1F1F1;
    text-align: center;
    margin-bottom: 8px;
    background: linear-gradient(90deg, #5F5CFF 0%, #6EE7B7 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.prediction-label {
    font-size: 14px;
    font-weight: 600;
    color: #F1F1F1;
    text-align: center;
    margin-bottom: 5px;
}

.prediction-sublabel {
    font-size: 11px;
    color: #B8BCC8;
    text-align: center;
}

.prediction-confidence {
    font-size: 12px;
    text-align: center;
    padding: 4px 8px;
    border-radius: 20px;
    margin-top: 8px;
}

.confidence-alta { background: #28a745; color: white; }
.confidence-media { background: #ffc107; color: #212529; }
.confidence-baixa { background: #dc3545; color: white; }

/* Cenários de Simulação */
.simulation-scenarios {
    background: rgba(13, 16, 23, 0.3);
    border-radius: 16px;
    padding: 20px;
    border: 1px solid rgba(95, 92, 255, 0.2);
}

.scenario-card {
    background: rgba(45, 49, 66, 0.6);
    border-radius: 12px;
    padding: 15px;
    transition: all 0.3s ease;
    border: 1px solid transparent;
}

.scenario-optimistic {
    border-color: #28a745;
}

.scenario-optimistic:hover {
    background: rgba(40, 167, 69, 0.1);
    transform: translateY(-3px);
}

.scenario-realistic {
    border-color: #ffc107;
}

.scenario-realistic:hover {
    background: rgba(255, 193, 7, 0.1);
    transform: translateY(-3px);
}

.scenario-pessimistic {
    border-color: #dc3545;
}

.scenario-pessimistic:hover {
    background: rgba(220, 53, 69, 0.1);
    transform: translateY(-3px);
}

.scenario-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
    font-weight: 600;
    color: #F1F1F1;
}

.scenario-date {
    font-size: 18px;
    font-weight: bold;
    color: #6EE7B7;
    margin-bottom: 5px;
}

.scenario-description {
    font-size: 12px;
    color: #B8BCC8;
}

/* Recomendações */
.recommendations {
    background: rgba(13, 16, 23, 0.3);
    border-radius: 16px;
    padding: 20px;
    border: 1px solid rgba(110, 231, 183, 0.2);
}

.recommendation-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px;
    margin-bottom: 10px;
    background: rgba(45, 49, 66, 0.4);
    border-radius: 10px;
    border-left: 4px solid #6EE7B7;
    transition: all 0.3s ease;
}

.recommendation-item:hover {
    background: rgba(45, 49, 66, 0.7);
    transform: translateX(5px);
}

.recommendation-icon {
    color: #6EE7B7;
    font-size: 16px;
    margin-top: 2px;
}

.recommendation-content {
    flex: 1;
}

.recommendation-title {
    font-weight: 600;
    color: #F1F1F1;
    font-size: 14px;
    margin-bottom: 4px;
}

.recommendation-description {
    font-size: 12px;
    color: #B8BCC8;
    line-height: 1.4;
}

.recommendation-priority {
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
    margin-left: auto;
}

.priority-critica { background: #dc3545; color: white; }
.priority-alta { background: #fd7e14; color: white; }
.priority-media { background: #ffc107; color: #212529; }
.priority-baixa { background: #6c757d; color: white; }

/* Estilos para Otimização de Rotas */
.route-optimizer-panel {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 350px;
    max-height: calc(100vh - 40px);
    background: linear-gradient(135deg, #23263B 0%, #2D3142 100%);
    border: 2px solid #6EE7B7;
    border-radius: 16px;
    padding: 20px;
    z-index: 1001;
    backdrop-filter: blur(10px);
    box-shadow: 0 15px 35px rgba(0,0,0,0.4);
    overflow-y: auto;
}

.route-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid #5F5CFF;
}

.route-panel-header h6 {
    color: #6EE7B7;
    margin: 0;
    font-weight: 600;
}

.route-configuration .form-label {
    color: #F1F1F1;
    font-weight: 500;
    font-size: 12px;
}

.municipalities-grid {
    max-height: 200px;
    overflow-y: auto;
    background: rgba(13, 16, 23, 0.3);
    border-radius: 8px;
    padding: 10px;
}

.municipality-checkbox {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    margin-bottom: 5px;
    background: rgba(45, 49, 66, 0.5);
    border-radius: 6px;
    transition: all 0.3s ease;
}

.municipality-checkbox:hover {
    background: rgba(95, 92, 255, 0.2);
    transform: translateX(3px);
}

.municipality-checkbox input[type="checkbox"] {
    margin-right: 8px;
}

.municipality-name {
    color: #F1F1F1;
    font-size: 13px;
    flex: 1;
}

.municipality-status {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 10px;
    font-weight: 600;
}

.status-alta { background: #dc3545; color: white; }
.status-media { background: #ffc107; color: #212529; }
.status-baixa { background: #28a745; color: white; }

.route-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.route-actions .btn {
    font-size: 12px;
    padding: 6px 12px;
    flex: 1;
}

.route-result {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #5F5CFF;
}

.route-summary {
    background: rgba(13, 16, 23, 0.3);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
}

.route-stat {
    text-align: center;
}

.route-stat-value {
    font-size: 18px;
    font-weight: bold;
    color: #6EE7B7;
    margin-bottom: 4px;
}

.route-stat-label {
    font-size: 11px;
    color: #B8BCC8;
}

.sequence-list {
    background: rgba(13, 16, 23, 0.3);
    border-radius: 10px;
    padding: 15px;
}

.sequence-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px;
    margin-bottom: 8px;
    background: rgba(45, 49, 66, 0.5);
    border-radius: 8px;
    transition: all 0.3s ease;
}

.sequence-item:hover {
    background: rgba(95, 92, 255, 0.2);
}

.sequence-number {
    width: 25px;
    height: 25px;
    background: #5F5CFF;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 12px;
}

.sequence-content {
    flex: 1;
}

.sequence-municipality {
    color: #F1F1F1;
    font-weight: 600;
    font-size: 14px;
}

.sequence-details {
    color: #B8BCC8;
    font-size: 11px;
    margin-top: 2px;
}

.sequence-time {
    color: #6EE7B7;
    font-size: 12px;
    font-weight: 600;
}

/* Rota no Mapa */
.route-line {
    stroke: #6EE7B7;
    stroke-width: 4;
    stroke-opacity: 0.8;
    fill: none;
    stroke-dasharray: 10, 5;
    animation: route-flow 2s linear infinite;
}

@keyframes route-flow {
    0% { stroke-dashoffset: 0; }
    100% { stroke-dashoffset: 15; }
}

.route-marker {
    border: 3px solid #6EE7B7 !important;
    box-shadow: 0 0 15px rgba(110, 231, 183, 0.6) !important;
}

.route-start-marker {
    border: 3px solid #28a745 !important;
    box-shadow: 0 0 20px rgba(40, 167, 69, 0.8) !important;
}

.route-end-marker {
    border: 3px solid #dc3545 !important;
    box-shadow: 0 0 20px rgba(220, 53, 69, 0.8) !important;
}

/* ===========================================
   INTELLIGENT CRITERIA GRID STYLES
   =========================================== */

.intelligent-criteria-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 8px;
    margin-bottom: 15px;
}

.criteria-option {
    background: rgba(13, 16, 23, 0.3);
    border: 1px solid #2D3142;
    border-radius: 8px;
    padding: 8px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.criteria-option:hover {
    background: rgba(95, 92, 255, 0.1);
    border-color: #5F5CFF;
    transform: translateY(-1px);
}

.criteria-option .form-check {
    margin-bottom: 0;
}

.criteria-option .form-check-input {
    margin-top: 0;
}

.criteria-option .form-check-label {
    cursor: pointer;
    width: 100%;
    margin-bottom: 0;
}

.criteria-option .form-check-input:checked ~ .form-check-label {
    color: #6EE7B7;
}

.criteria-option .form-check-input:checked ~ .form-check-label .criteria-header {
    color: #6EE7B7;
}

.criteria-option .form-check-input:checked ~ .form-check-label .criteria-header i {
    color: #5F5CFF;
}

.criteria-header {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 4px;
    transition: all 0.3s ease;
}

.criteria-header i {
    font-size: 12px;
    color: #B8BCC8;
    transition: all 0.3s ease;
}

.criteria-title {
    font-size: 11px;
    font-weight: 600;
    color: #F1F1F1;
    transition: all 0.3s ease;
}

.criteria-description {
    font-size: 9px;
    color: #B8BCC8;
    line-height: 1.2;
    margin-left: 18px;
}

.route-options {
    background: rgba(13, 16, 23, 0.2);
    border-radius: 10px;
    padding: 12px;
    border: 1px solid #2D3142;
}

.route-options h6 {
    color: #6EE7B7;
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 6px;
}

/* Route Result Enhanced Styling */
.route-result {
    background: rgba(13, 16, 23, 0.4);
    border-radius: 12px;
    padding: 15px;
    margin-top: 15px;
    border: 1px solid #5F5CFF;
}

.route-result h6 {
    color: #6EE7B7;
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.route-result .route-summary {
    background: rgba(45, 49, 66, 0.3);
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 10px;
}

.route-result .route-stat-value {
    font-size: 16px;
    font-weight: bold;
    color: #6EE7B7;
}

.route-result .route-stat-label {
    font-size: 10px;
    color: #B8BCC8;
}

.route-result .sequence-list {
    max-height: 200px;
    overflow-y: auto;
    background: rgba(45, 49, 66, 0.2);
    border-radius: 8px;
    padding: 8px;
}

.route-result .sequence-item {
    padding: 6px 8px;
    margin-bottom: 4px;
    background: rgba(95, 92, 255, 0.1);
    border-radius: 6px;
    font-size: 11px;
}

.route-result .sequence-municipality {
    color: #F1F1F1;
    font-weight: 600;
    font-size: 11px;
}

.route-result .sequence-details {
    color: #B8BCC8;
    font-size: 9px;
    margin-top: 1px;
}

.route-result .sequence-time {
    color: #6EE7B7;
    font-size: 10px;
    font-weight: 600;
}

/* ===========================================
   ROUTE RESULT ENHANCED STYLES
   =========================================== */

.route-info-header {
    background: rgba(13, 16, 23, 0.4);
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 15px;
    border: 1px solid #5F5CFF;
}

.start-point-info {
    color: #F1F1F1;
    font-size: 12px;
}

.start-point-info i {
    color: #28a745;
    margin-right: 8px;
}

.details-row {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    margin-bottom: 6px;
}

.detail-badge {
    font-size: 9px;
    padding: 2px 6px;
    border-radius: 10px;
    font-weight: 500;
}

.detail-badge.badge-danger {
    background: #dc3545;
    color: white;
}

.detail-badge.badge-info {
    background: #17a2b8;
    color: white;
}

.detail-badge.badge-warning {
    background: #ffc107;
    color: #212529;
}

.detail-badge.badge-secondary {
    background: #6c757d;
    color: white;
}

.reasons-list {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
    margin-top: 4px;
}

.reason-tag {
    font-size: 8px;
    background: rgba(95, 92, 255, 0.2);
    color: #6EE7B7;
    padding: 2px 5px;
    border-radius: 8px;
    border: 1px solid #5F5CFF;
}

.sequence-item.never-visited {
    background: rgba(220, 53, 69, 0.1) !important;
    border: 1px solid #dc3545;
}

.sequence-item.start-point {
    background: rgba(40, 167, 69, 0.1);
    border: 1px solid #28a745;
}

.sequence-item.end-point {
    background: rgba(40, 167, 69, 0.1);
    border: 1px solid #28a745;
}

.route-start-container,
.route-end-container {
    background: transparent !important;
}

.route-popup {
    min-width: 200px;
}

.route-popup h6 {
    color: #2D3142;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.route-popup p {
    margin-bottom: 4px;
    font-size: 12px;
    color: #2D3142;
}

/* Marcadores no mapa */
.route-marker-urgent {
    border: 3px solid #dc3545 !important;
    box-shadow: 0 0 15px rgba(220, 53, 69, 0.6) !important;
    animation: pulse 2s infinite;
}

.route-marker-normal {
    border: 3px solid #6EE7B7 !important;
    box-shadow: 0 0 10px rgba(110, 231, 183, 0.4) !important;
}

/* Schedule Information Styles */
.schedule-info-row {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
    margin: 4px 0;
}

.schedule-badge {
    font-size: 8px;
    padding: 2px 4px;
    border-radius: 8px;
    font-weight: 500;
    border: 1px solid transparent;
}

.schedule-badge.badge-success {
    background: #28a745;
    color: white;
}

.schedule-badge.badge-danger {
    background: #dc3545;
    color: white;
}

.schedule-badge.badge-info {
    background: #17a2b8;
    color: white;
}

.schedule-badge.badge-light {
    background: #f8f9fa;
    color: #495057;
    border-color: #dee2e6;
}

.reason-tag.schedule-optimized {
    background: rgba(40, 167, 69, 0.2);
    color: #28a745;
    border-color: #28a745;
}

/* Business Hours Indicator */
.business-hours-indicator {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 10px;
    background: rgba(13, 16, 23, 0.3);
    border: 1px solid #5F5CFF;
    color: #F1F1F1;
}

.business-hours-indicator.open {
    background: rgba(40, 167, 69, 0.2);
    border-color: #28a745;
    color: #28a745;
}

.business-hours-indicator.closed {
    background: rgba(220, 53, 69, 0.2);
    border-color: #dc3545;
    color: #dc3545;
}

/* Schedule Efficiency Bar */
.schedule-efficiency {
    width: 100%;
    height: 4px;
    background: #2D3142;
    border-radius: 2px;
    overflow: hidden;
    margin: 2px 0;
}

.schedule-efficiency-fill {
    height: 100%;
    background: linear-gradient(90deg, #dc3545 0%, #ffc107 50%, #28a745 100%);
    border-radius: 2px;
    transition: width 0.3s ease;
}

/* ===========================================
   DASHBOARD EXECUTIVO STYLES
   =========================================== */

.executive-dashboard {
    background: linear-gradient(135deg, #23263B 0%, #2D3142 100%);
    border: 2px solid #5F5CFF;
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
}

.dashboard-controls {
    display: flex;
    gap: 10px;
}

/* KPI Cards */
.kpi-card {
    background: linear-gradient(135deg, #2D3142 0%, #23263B 100%);
    border-radius: 16px;
    padding: 20px;
    border: 2px solid transparent;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.kpi-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--kpi-color);
    border-radius: 16px 16px 0 0;
}

.kpi-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 30px rgba(0,0,0,0.4);
}

.kpi-primary { --kpi-color: #5F5CFF; }
.kpi-success { --kpi-color: #28a745; }
.kpi-warning { --kpi-color: #ffc107; }
.kpi-info { --kpi-color: #17a2b8; }
.kpi-danger { --kpi-color: #dc3545; }
.kpi-secondary { --kpi-color: #6c757d; }

.kpi-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 50px;
    height: 50px;
    background: var(--kpi-color);
    border-radius: 12px;
    margin-bottom: 15px;
    font-size: 20px;
    color: white;
}

.kpi-value.compact {
    font-size: 28px;
    font-weight: bold;
    color: #F1F1F1;
    margin-bottom: 5px;
}

.kpi-label.compact {
    font-size: 12px;
    color: #B8BCC8;
    margin-bottom: 5px;
}

.kpi-trend {
    font-size: 11px;
    color: var(--kpi-color);
    font-weight: 600;
}

/* Chart Containers */
.chart-container {
    background: rgba(13, 16, 23, 0.5);
    border-radius: 16px;
    padding: 20px;
    border: 1px solid #2D3142;
}

.chart-title {
    color: #F1F1F1;
    margin-bottom: 15px;
    font-weight: 600;
}

/* Metrics Detailed */
.metrics-detailed {
    background: rgba(13, 16, 23, 0.5);
    border-radius: 16px;
    padding: 20px;
    border: 1px solid #2D3142;
}

.metrics-title {
    color: #5F5CFF;
    margin-bottom: 20px;
    font-weight: 600;
    padding-bottom: 10px;
    border-bottom: 1px solid #2D3142;
}

.metric-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid rgba(45, 49, 66, 0.3);
}

.metric-item:last-child {
    border-bottom: none;
}

.metric-label {
    color: #B8BCC8;
    font-size: 13px;
}

.metric-value {
    color: #6EE7B7;
    font-weight: 600;
    font-size: 14px;
}

/* Status Distribution */
.status-distribution {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.status-item {
    display: flex;
    align-items: center;
    gap: 10px;
}

.status-bar {
    flex: 1;
    height: 8px;
    background: rgba(45, 49, 66, 0.5);
    border-radius: 4px;
    overflow: hidden;
}

.status-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.8s ease;
}

.status-completed { background: #28a745; }
.status-progress { background: #ffc107; }
.status-pending { background: #6c757d; }
.status-blocked { background: #dc3545; }

.status-label {
    color: #F1F1F1;
    font-size: 12px;
    min-width: 80px;
}

.status-percent {
    color: #6EE7B7;
    font-weight: 600;
    font-size: 12px;
    min-width: 35px;
    text-align: right;
}

/* Goals and Objectives */
.goal-item {
    margin-bottom: 20px;
    padding: 15px;
    background: rgba(45, 49, 66, 0.3);
    border-radius: 10px;
    border-left: 4px solid #5F5CFF;
}

.goal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.goal-title {
    color: #F1F1F1;
    font-weight: 600;
    font-size: 13px;
}

.goal-percentage {
    color: #6EE7B7;
    font-weight: bold;
    font-size: 14px;
}

.goal-progress {
    margin-bottom: 8px;
}

.goal-bar {
    height: 6px;
    background: rgba(45, 49, 66, 0.5);
    border-radius: 3px;
    overflow: hidden;
}

.goal-fill {
    height: 100%;
    background: linear-gradient(90deg, #5F5CFF 0%, #6EE7B7 100%);
    border-radius: 3px;
    transition: width 0.8s ease;
}

.goal-details {
    color: #B8BCC8;
    font-size: 11px;
}

/* Executive Alerts */
.executive-alerts, .executive-recommendations {
    background: rgba(13, 16, 23, 0.5);
    border-radius: 16px;
    padding: 20px;
    border: 1px solid #2D3142;
    height: 300px;
    overflow-y: auto;
}

.alerts-title, .recommendations-title {
    color: #5F5CFF;
    margin-bottom: 15px;
    font-weight: 600;
    padding-bottom: 10px;
    border-bottom: 1px solid #2D3142;
}

.alert-item, .recommendation-item-exec {
    padding: 12px;
    margin-bottom: 10px;
    border-radius: 8px;
    border-left: 4px solid var(--alert-color);
    background: rgba(45, 49, 66, 0.3);
    transition: all 0.3s ease;
}

.alert-item:hover, .recommendation-item-exec:hover {
    background: rgba(45, 49, 66, 0.5);
    transform: translateX(3px);
}

.alert-critical { --alert-color: #dc3545; }
.alert-high { --alert-color: #fd7e14; }
.alert-medium { --alert-color: #ffc107; }
.alert-low { --alert-color: #28a745; }

.alert-header, .rec-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
}

.alert-title, .rec-title {
    color: #F1F1F1;
    font-weight: 600;
    font-size: 13px;
}

.alert-priority, .rec-impact {
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 600;
    color: white;
}

.alert-description, .rec-description {
    color: #B8BCC8;
    font-size: 12px;
    line-height: 1.4;
}

/* Dashboard animations */
@keyframes kpiPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.kpi-card.highlight {
    animation: kpiPulse 2s infinite;
}

/* Responsive design */
@media (max-width: 768px) {
    .kpi-card {
        margin-bottom: 15px;
    }
    
    .executive-dashboard {
        padding: 20px;
    }
    
    .dashboard-controls {
        flex-direction: column;
        gap: 5px;
    }
}

/* ===========================================
   SISTEMA DE ALERTAS INTELIGENTES
   =========================================== */

.intelligent-alerts-system {
    position: fixed;
    top: 0;
    right: 0;
    z-index: 10000;
    pointer-events: none;
}

.intelligent-alerts-system * {
    pointer-events: auto;
}

/* Botão Flutuante de Alertas */
.alerts-floating-button {
    position: fixed;
    top: 100px;
    right: 30px;
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 8px 25px rgba(220, 53, 69, 0.4);
    z-index: 99999;
    border: 3px solid rgba(255, 255, 255, 0.2);
}

.alerts-floating-button:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 12px 35px rgba(220, 53, 69, 0.6);
}

/* Animação de destaque para o botão de alertas */
.alerts-floating-button.has-alerts {
    animation: alertPulse 2s infinite;
}

@keyframes alertPulse {
    0% { 
        transform: scale(1);
        box-shadow: 0 8px 25px rgba(220, 53, 69, 0.4);
    }
    50% { 
        transform: scale(1.1);
        box-shadow: 0 12px 35px rgba(220, 53, 69, 0.8);
    }
    100% { 
        transform: scale(1);
        box-shadow: 0 8px 25px rgba(220, 53, 69, 0.4);
    }
}

.alerts-floating-button i {
    color: white;
    font-size: 20px;
    z-index: 2;
}

.alert-count {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #fff;
    color: #dc3545;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
    border: 2px solid #dc3545;
    z-index: 3;
}

/* Animação de Pulso */
.pulse-ring {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 60px;
    height: 60px;
    border: 3px solid rgba(220, 53, 69, 0.6);
    border-radius: 50%;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
    }
    70% {
        transform: translate(-50%, -50%) scale(1.4);
        opacity: 0;
    }
    100% {
        transform: translate(-50%, -50%) scale(1.4);
        opacity: 0;
    }
}

/* Painel de Notificações */
.notifications-panel {
    position: fixed;
    top: 170px;
    right: 30px;
    width: 380px;
    max-height: 500px;
    background: rgba(13, 16, 23, 0.95);
    border: 1px solid #475569;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    z-index: 99998;
    transform: translateX(120%);
    transition: transform 0.3s ease;
    display: block !important;
    backdrop-filter: blur(10px);
    background: linear-gradient(135deg, #23263B 0%, #2D3142 100%);
    border: 2px solid #dc3545;
    border-radius: 16px;
    overflow: hidden;
    transform: translateX(500px);
    transition: all 0.3s ease;
    box-shadow: 0 20px 40px rgba(0,0,0,0.4);
    z-index: 10000;
}

.notifications-panel.show {
    transform: translateX(0) !important;
    opacity: 1;
}

.panel-header {
    background: rgba(220, 53, 69, 0.1);
    padding: 15px 20px;
    border-bottom: 1px solid #dc3545;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.panel-header h6 {
    color: #F1F1F1;
    margin: 0;
    font-weight: 600;
}

.panel-controls {
    display: flex;
    gap: 8px;
}

.btn-mini {
    background: transparent;
    border: 1px solid rgba(241, 241, 241, 0.3);
    color: #F1F1F1;
    width: 32px;
    height: 32px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-mini:hover {
    background: rgba(220, 53, 69, 0.2);
    border-color: #dc3545;
}

.notifications-list {
    max-height: 350px;
    overflow-y: auto;
    padding: 10px;
}

.notification-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px;
    margin-bottom: 8px;
    background: rgba(45, 49, 66, 0.6);
    border-radius: 8px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.notification-item:hover {
    background: rgba(45, 49, 66, 0.8);
    transform: translateX(-5px);
}

.notification-item.read {
    opacity: 0.6;
}

.notification-icon {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(220, 53, 69, 0.1);
    border-radius: 50%;
}

.notification-content {
    flex: 1;
}

.notification-title {
    color: #F1F5F9;
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 4px;
}

.notification-time {
    color: #94A3B8;
    font-size: 12px;
}

.panel-footer {
    padding: 10px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.btn-mini {
    background: transparent;
    border: none;
    color: #F1F5F9;
    padding: 4px 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-mini:hover {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
}

.notification-item {
    background: rgba(45, 49, 66, 0.3);
    border-left: 4px solid var(--notification-color);
    border-radius: 8px;
    padding: 12px 15px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.notification-item:hover {
    background: rgba(45, 49, 66, 0.5);
    transform: translateX(5px);
}

.notification-item.unread {
    border-left-width: 6px;
    box-shadow: 0 2px 8px rgba(var(--notification-rgb), 0.3);
}

.notification-critical { 
    --notification-color: #dc3545; 
    --notification-rgb: 220, 53, 69;
}
.notification-high { 
    --notification-color: #fd7e14; 
    --notification-rgb: 253, 126, 20;
}
.notification-medium { 
    --notification-color: #ffc107; 
    --notification-rgb: 255, 193, 7;
}
.notification-low { 
    --notification-color: #28a745; 
    --notification-rgb: 40, 167, 69;
}

.notification-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.notification-title {
    color: #F1F1F1;
    font-weight: 600;
    font-size: 14px;
}

.notification-time {
    color: #B8BCC8;
    font-size: 11px;
}

.notification-message {
    color: #B8BCC8;
    font-size: 13px;
    line-height: 1.4;
    margin-bottom: 8px;
}

.notification-actions {
    display: flex;
    gap: 8px;
}

.notification-action {
    background: var(--notification-color);
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.notification-action:hover {
    opacity: 0.8;
    transform: translateY(-1px);
}

.panel-footer {
    background: rgba(220, 53, 69, 0.1);
    padding: 15px 20px;
    border-top: 1px solid #dc3545;
}

/* Configuração de Alertas */
.alert-config-section {
    margin-bottom: 20px;
}

.alert-config-section h6 {
    border-left: 4px solid #5F5CFF;
    padding-left: 12px;
}

/* Animações para novos alertas */
@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.notification-item.new {
    animation: slideInRight 0.5s ease-out;
}

/* Toast de Notificação */
.alert-toast {
    position: fixed;
    top: 100px;
    right: 20px;
    background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
    color: white;
    padding: 15px 20px;
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(220, 53, 69, 0.4);
    z-index: 10002;
    max-width: 350px;
    animation: slideInRight 0.5s ease-out;
}

.alert-toast.fade-out {
    animation: slideOutRight 0.5s ease-out forwards;
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

/* Responsive para alertas */
@media (max-width: 768px) {
    .notifications-panel {
        width: calc(100vw - 40px);
        right: 20px;
        top: 150px;
    }
    
    .alerts-floating-button {
        top: 80px;
        right: 20px;
        width: 50px;
        height: 50px;
    }
    
    .alert-count {
        width: 20px;
        height: 20px;
        font-size: 10px;
    }
}

/* Estados de alerta no botão flutuante */
.alerts-floating-button.critical {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    animation: criticalPulse 1s infinite;
}

.alerts-floating-button.high {
    background: linear-gradient(135deg, #fd7e14 0%, #e55a00 100%);
}

.alerts-floating-button.medium {
    background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
}

.alerts-floating-button.normal {
    background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
}

@keyframes criticalPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

/* Som visual para alertas críticos */
.visual-bell {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(220, 53, 69, 0.1);
    z-index: 9999;
    pointer-events: none;
    animation: flashAlert 0.5s ease-out;
}

@keyframes flashAlert {
    0%, 100% { opacity: 0; }
    50% { opacity: 1; }
}

/* ===========================================
   SISTEMA SIMPLIFICADO PNSB 2024
   =========================================== */

.simple-report {
    background: #23263B;
    border-radius: 16px;
    padding: 24px;
    border: 2px solid #2D3142;
}

.report-controls .btn {
    margin-left: 8px;
}

.stat-card {
    background: #2D3142;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    border: 1px solid #3A3F56;
    transition: all 0.3s ease;
}

.stat-card:hover {
    border-color: #5F5CFF;
    transform: translateY(-2px);
}

.stat-value {
    font-size: 32px;
    font-weight: bold;
    color: #6EE7B7;
    margin-bottom: 8px;
}

.stat-label {
    font-size: 14px;
    color: #B8BCC8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.simple-status-panel {
    background: #23263B;
    border-radius: 16px;
    padding: 24px;
    border: 2px solid #2D3142;
}

.municipios-status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 16px;
    margin-top: 20px;
}

.municipalities-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
    margin-top: 15px;
}

.municipality-item {
    background: rgba(45, 49, 66, 0.3);
    border-radius: 8px;
    padding: 8px;
    border: 1px solid transparent;
    transition: all 0.3s ease;
}

.municipality-item:hover {
    border-color: #5F5CFF;
    background: rgba(95, 92, 255, 0.1);
}

.municipality-checkbox {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    color: #F1F1F1;
    font-size: 14px;
}

.municipality-checkbox input[type="checkbox"] {
    accent-color: #5F5CFF;
}

.sequence-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 12px;
    background: rgba(45, 49, 66, 0.3);
    border-radius: 6px;
    margin-bottom: 8px;
}

.sequence-number {
    background: #5F5CFF;
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
}

.sequence-municipality {
    color: #F1F1F1;
    font-weight: 500;
}

/* Cards de Prioridade P1/P2/P3 */
.priority-card {
    background: #2D3142;
    border-radius: 12px;
    padding: 20px;
    border: 2px solid transparent;
    transition: all 0.3s ease;
}

.priority-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
}

.priority-p1 {
    border-color: #dc3545;
    background: linear-gradient(135deg, #2D3142 0%, #3d1a1a 100%);
}

.priority-p1:hover {
    border-color: #ff4757;
    box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3);
}

.priority-p2 {
    border-color: #ffc107;
    background: linear-gradient(135deg, #2D3142 0%, #3d3d1a 100%);
}

.priority-p2:hover {
    border-color: #ffda44;
    box-shadow: 0 8px 25px rgba(255, 193, 7, 0.3);
}

.priority-p3 {
    border-color: #6c757d;
    background: linear-gradient(135deg, #2D3142 0%, #2a2a2a 100%);
}

.priority-p3:hover {
    border-color: #adb5bd;
    box-shadow: 0 8px 25px rgba(108, 117, 125, 0.3);
}

.priority-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.priority-title {
    color: #F1F1F1;
    font-weight: 600;
    margin: 0;
    font-size: 16px;
}

.priority-progress {
    font-size: 18px;
    font-weight: bold;
    color: #6EE7B7;
}

.priority-description {
    color: #B8BCC8;
    font-size: 12px;
    margin-bottom: 15px;
}

.priority-stats {
    display: flex;
    justify-content: space-between;
    gap: 10px;
}

.priority-stats .stat-item {
    text-align: center;
    flex: 1;
}

.priority-stats .stat-value {
    font-size: 16px;
    font-weight: bold;
    color: #F1F1F1;
    display: block;
}

.priority-stats .stat-label {
    font-size: 11px;
    color: #B8BCC8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.priority-badge {
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.priority-content {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.priority-progress {
    text-align: center;
    padding: 10px;
    background: rgba(95, 92, 255, 0.1);
    border-radius: 8px;
    border: 1px solid rgba(95, 92, 255, 0.3);
}

.progress-value {
    font-size: 24px;
    font-weight: bold;
    color: #5F5CFF;
    display: block;
}

.progress-label {
    font-size: 12px;
    color: #B8BCC8;
    margin-top: 4px;
}

.algorithm-metrics {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}

.algorithm-metrics .metric {
    color: #B8BCC8;
    font-size: 12px;
}

.algorithm-metrics .metric strong {
    color: #6EE7B7;
}

/* Pattern Analysis */
.pattern-analysis {
    background: rgba(255, 193, 7, 0.05);
    border: 1px solid rgba(255, 193, 7, 0.2);
    border-radius: 16px;
    padding: 20px;
}

.patterns-list {
    background: rgba(13, 16, 23, 0.3);
    border-radius: 10px;
    padding: 15px;
    border: 1px solid #2D3142;
    min-height: 200px;
    overflow-y: auto;
}

.pattern-item {
    background: rgba(255, 193, 7, 0.1);
    border-left: 4px solid #ffc107;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 8px;
}

.pattern-title {
    color: #F1F1F1;
    font-weight: 600;
    font-size: 13px;
    margin-bottom: 4px;
}

.pattern-description {
    color: #B8BCC8;
    font-size: 11px;
    line-height: 1.4;
}

.pattern-confidence {
    color: #ffc107;
    font-size: 10px;
    font-weight: 600;
    margin-top: 4px;
}

/* Prediction Models */
.prediction-models {
    background: rgba(220, 53, 69, 0.05);
    border: 1px solid rgba(220, 53, 69, 0.2);
    border-radius: 16px;
    padding: 20px;
}

.model-performance {
    background: rgba(13, 16, 23, 0.3);
    border-radius: 10px;
    padding: 15px;
    border: 1px solid #2D3142;
}

.model-metric {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
}

.metric-label {
    color: #F1F1F1;
    font-size: 12px;
    min-width: 80px;
}

.metric-bar {
    flex: 1;
    height: 6px;
    background: rgba(45, 49, 66, 0.5);
    border-radius: 3px;
    overflow: hidden;
}

.metric-fill {
    height: 100%;
    background: linear-gradient(90deg, #dc3545 0%, #ffc107 50%, #28a745 100%);
    border-radius: 3px;
    transition: width 1s ease;
    animation: metricGlow 2s infinite alternate;
}

@keyframes metricGlow {
    0% { box-shadow: 0 0 5px rgba(220, 53, 69, 0.3); }
    100% { box-shadow: 0 0 15px rgba(40, 167, 69, 0.5); }
}

.metric-value {
    color: #6EE7B7;
    font-weight: 600;
    font-size: 12px;
    min-width: 35px;
    text-align: right;
}

/* Learning Insights */
.learning-insights {
    background: rgba(110, 231, 183, 0.05);
    border: 1px solid rgba(110, 231, 183, 0.2);
    border-radius: 16px;
    padding: 20px;
}

.insights-list {
    background: rgba(13, 16, 23, 0.3);
    border-radius: 10px;
    padding: 15px;
    border: 1px solid #2D3142;
    min-height: 200px;
    overflow-y: auto;
}

.insight-item {
    background: rgba(110, 231, 183, 0.1);
    border-left: 4px solid #6EE7B7;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 8px;
    transition: all 0.3s ease;
}

.insight-item:hover {
    background: rgba(110, 231, 183, 0.2);
    transform: translateX(3px);
}

.insight-title {
    color: #F1F1F1;
    font-weight: 600;
    font-size: 13px;
    margin-bottom: 4px;
}

.insight-description {
    color: #B8BCC8;
    font-size: 11px;
    line-height: 1.4;
}

.insight-impact {
    color: #6EE7B7;
    font-size: 10px;
    font-weight: 600;
    margin-top: 4px;
}

/* Personalized Recommendations */
.personalized-recommendations {
    background: rgba(0, 212, 255, 0.05);
    border: 1px solid rgba(0, 212, 255, 0.2);
    border-radius: 16px;
    padding: 25px;
}

.recommendations-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

.municipality-recommendation {
    background: rgba(13, 16, 23, 0.3);
    border: 1px solid #2D3142;
    border-radius: 12px;
    padding: 20px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.municipality-recommendation::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--recommendation-color, #00d4ff);
    border-radius: 12px 12px 0 0;
}

.municipality-recommendation:hover {
    border-color: var(--recommendation-color, #00d4ff);
    box-shadow: 0 8px 25px rgba(0, 212, 255, 0.1);
    transform: translateY(-3px);
}

.municipality-recommendation.high-priority {
    --recommendation-color: #dc3545;
}

.municipality-recommendation.medium-priority {
    --recommendation-color: #ffc107;
}

.municipality-recommendation.low-priority {
    --recommendation-color: #28a745;
}

.recommendation-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.municipality-name-rec {
    color: #F1F1F1;
    font-weight: 600;
    font-size: 16px;
}

.recommendation-score {
    background: var(--recommendation-color, #00d4ff);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
}

.recommendation-content {
    margin-bottom: 15px;
}

.recommendation-strategy {
    color: #F1F1F1;
    font-weight: 500;
    font-size: 14px;
    margin-bottom: 8px;
}

.recommendation-details {
    color: #B8BCC8;
    font-size: 12px;
    line-height: 1.4;
    margin-bottom: 10px;
}

.recommendation-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.recommendation-action {
    background: var(--recommendation-color, #00d4ff);
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.recommendation-action:hover {
    opacity: 0.8;
    transform: translateY(-1px);
}

/* Responsive ML Panel */
@media (max-width: 768px) {
    .ml-system-panel {
        padding: 20px;
    }
    
    .ml-controls {
        flex-direction: column;
        gap: 5px;
    }
    
    .recommendations-grid {
        grid-template-columns: 1fr;
    }
    
    .algorithm-metrics {
        flex-direction: column;
        gap: 8px;
    }
}

/* AI Thinking Animation */
.ai-thinking {
    display: inline-block;
    animation: aiThinking 1.5s infinite;
}

@keyframes aiThinking {
    0%, 80%, 100% { opacity: 0.3; }
    40% { opacity: 1; }
}

/* ========================================
   MOBILE APP NATIVO - PWA
   ======================================== */

/* Mobile App Container */
.mobile-app-container {
    background: linear-gradient(145deg, #1a1d2e 0%, #16213e 100%);
    border: 2px solid #2d4a75;
    border-radius: 20px;
    margin-bottom: 25px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    min-height: 400px;
}

/* Mobile Header */
.mobile-header {
    background: rgba(13, 16, 23, 0.8);
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #2D3142;
}

.status-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

.status-indicator.online .status-dot {
    background: #28a745;
    box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
}

.status-indicator.offline .status-dot {
    background: #dc3545;
    box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
}

.status-text {
    color: #F1F1F1;
    font-size: 12px;
    font-weight: 600;
}

.install-btn {
    background: linear-gradient(135deg, #5F5CFF 0%, #7B68EE 100%);
    border: none;
    color: white;
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(95, 92, 255, 0.3);
}

.install-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(95, 92, 255, 0.5);
}

/* Mobile Navigation */
.mobile-navigation {
    display: flex;
    background: rgba(13, 16, 23, 0.9);
    border-bottom: 1px solid #2D3142;
}

.nav-btn {
    flex: 1;
    background: transparent;
    border: none;
    color: #B8BCC8;
    padding: 12px 8px;
    font-size: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    border-bottom: 3px solid transparent;
}

.nav-btn:hover {
    background: rgba(95, 92, 255, 0.1);
    color: #F1F1F1;
}

.nav-btn.active {
    color: #5F5CFF;
    border-bottom-color: #5F5CFF;
    background: rgba(95, 92, 255, 0.05);
}

/* Mobile Content */
.mobile-content {
    padding: 20px;
    min-height: 300px;
}

.mobile-view {
    display: none;
}

.mobile-view.active {
    display: block;
}

/* Quick Actions */
.quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
}

.quick-action {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    border: none;
    color: white;
    padding: 12px 16px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
}

.quick-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(40, 167, 69, 0.5);
}

/* Offline Cards */
.offline-visit-card, .offline-contact-card {
    background: rgba(13, 16, 23, 0.6);
    border: 1px solid #2D3142;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
}

.offline-visit-card:hover, .offline-contact-card:hover {
    background: rgba(13, 16, 23, 0.8);
    border-color: #5F5CFF;
    transform: translateY(-1px);
}

.offline-visit-card.pending-sync {
    border-left: 4px solid #ffc107;
}

.visit-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.visit-header h4 {
    color: #F1F1F1;
    font-size: 14px;
    margin: 0;
}

.visit-status {
    background: #6c757d;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
}

.visit-details p {
    color: #B8BCC8;
    font-size: 11px;
    margin: 4px 0;
}

.sync-pending {
    color: #ffc107 !important;
    font-weight: 600;
}

/* Sync Status */
.sync-status {
    text-align: center;
    padding: 20px;
}

.sync-status h3 {
    color: #F1F1F1;
    margin-bottom: 15px;
}

.sync-queue-count {
    background: rgba(95, 92, 255, 0.1);
    border: 1px solid #5F5CFF;
    border-radius: 15px;
    padding: 15px;
    margin-bottom: 15px;
}

.queue-number {
    display: inline-block;
    background: #5F5CFF;
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    line-height: 30px;
    font-weight: bold;
    margin-right: 10px;
}

.sync-now-btn {
    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
    border: none;
    color: white;
    padding: 12px 20px;
    border-radius: 25px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(23, 162, 184, 0.3);
}

.sync-now-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(23, 162, 184, 0.5);
}

/* Mobile Notification */
.mobile-notification {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: rgba(13, 16, 23, 0.95);
    color: #F1F1F1;
    padding: 12px 20px;
    border-radius: 25px;
    border: 1px solid #5F5CFF;
    font-size: 12px;
    font-weight: 600;
    z-index: 10000;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    transition: all 0.3s ease;
    opacity: 0;
    max-width: 300px;
    text-align: center;
}

.mobile-notification.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
}

/* Offline Data Modal */
.offline-data-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
}

.modal-content {
    background: #23263B;
    border: 2px solid #2D3142;
    border-radius: 16px;
    padding: 25px;
    max-width: 400px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.modal-header h3 {
    color: #F1F1F1;
    margin: 0;
}

.close-modal {
    background: #dc3545;
    border: none;
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.data-summary {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-bottom: 20px;
}

.summary-item {
    text-align: center;
    padding: 15px;
    background: rgba(13, 16, 23, 0.5);
    border-radius: 10px;
    border: 1px solid #2D3142;
}

.summary-item .count {
    display: block;
    font-size: 24px;
    font-weight: bold;
    color: #5F5CFF;
    margin-bottom: 5px;
}

.summary-item .label {
    color: #B8BCC8;
    font-size: 12px;
}

.storage-info p {
    color: #B8BCC8;
    font-size: 12px;
    margin: 8px 0;
    text-align: center;
}

/* Responsive Design */
@media (max-width: 768px) {
    .mobile-app-container {
        border-radius: 0;
        margin: 0 -15px 25px -15px;
    }
    
    .mobile-content {
        padding: 15px;
    }
    
    .quick-actions {
        grid-template-columns: 1fr;
    }
    
    .nav-btn {
        padding: 15px 8px;
        font-size: 11px;
    }
}

/* PWA Specific Styles */
@media (display-mode: standalone) {
    .mobile-app-container {
        border-radius: 0;
        margin: 0;
        min-height: 100vh;
    }
    
    .mobile-header {
        padding-top: 25px; /* Account for status bar */
    }
}

/* ========================================
   API INTEGRATION PANEL
   ======================================== */

/* API Integration Container */
.api-integration-panel {
    background: linear-gradient(145deg, #1a1d2e 0%, #16213e 100%);
    border: 2px solid #2d4a75;
    border-radius: 20px;
    padding: 25px;
    margin-bottom: 25px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
}

.api-integration-panel::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
        radial-gradient(circle at 20% 20%, rgba(0, 212, 255, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(95, 92, 255, 0.05) 0%, transparent 50%);
    z-index: 1;
    pointer-events: none;
}

.api-integration-panel > * {
    position: relative;
    z-index: 2;
}

/* API Header */
.api-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid #2D3142;
}

.api-header h3 {
    color: #F1F1F1;
    margin: 0;
    font-size: 20px;
    font-weight: 700;
}

.api-controls {
    display: flex;
    gap: 10px;
}

.api-btn {
    background: linear-gradient(135deg, #5F5CFF 0%, #7B68EE 100%);
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 25px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(95, 92, 255, 0.3);
}

.api-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(95, 92, 255, 0.5);
}

.demographics-btn {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
}

.economic-btn {
    background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
}

/* API Status */
.api-status {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
    padding: 15px;
    background: rgba(13, 16, 23, 0.4);
    border-radius: 12px;
    border: 1px solid #2D3142;
}

.status-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.status-label {
    color: #B8BCC8;
    font-size: 12px;
    font-weight: 500;
}

.status-value {
    color: #F1F1F1;
    font-size: 12px;
    font-weight: 600;
}

/* API Data Tabs */
.api-data-tabs {
    display: flex;
    background: rgba(13, 16, 23, 0.6);
    border-radius: 12px;
    padding: 4px;
    margin-bottom: 20px;
    border: 1px solid #2D3142;
}

.tab-btn {
    flex: 1;
    background: transparent;
    border: none;
    color: #B8BCC8;
    padding: 10px 15px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.tab-btn:hover {
    background: rgba(95, 92, 255, 0.1);
    color: #F1F1F1;
}

.tab-btn.active {
    background: linear-gradient(135deg, #5F5CFF 0%, #7B68EE 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(95, 92, 255, 0.3);
}

/* Tab Content */
.api-data-content {
    min-height: 400px;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

/* Municipal Data Grid */
.municipal-data-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

.data-card {
    background: rgba(13, 16, 23, 0.6);
    border: 1px solid #2D3142;
    border-radius: 12px;
    padding: 20px;
    transition: all 0.3s ease;
}

.data-card:hover {
    background: rgba(13, 16, 23, 0.8);
    border-color: #5F5CFF;
    transform: translateY(-2px);
}

.data-card h4 {
    color: #F1F1F1;
    margin: 0 0 15px 0;
    font-size: 16px;
    font-weight: 600;
}

/* Municipal Items */
.municipal-item {
    background: rgba(95, 92, 255, 0.05);
    border: 1px solid rgba(95, 92, 255, 0.2);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
}

.municipal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.municipal-header strong {
    color: #F1F1F1;
    font-size: 14px;
}

.municipal-id {
    background: #5F5CFF;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
}

.municipal-details p {
    color: #B8BCC8;
    font-size: 11px;
    margin: 4px 0;
}

/* Admin Structure */
.admin-summary {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-bottom: 15px;
}

.admin-stat {
    text-align: center;
    padding: 12px;
    background: rgba(95, 92, 255, 0.1);
    border-radius: 8px;
    border: 1px solid rgba(95, 92, 255, 0.2);
}

.stat-number {
    display: block;
    font-size: 24px;
    font-weight: bold;
    color: #5F5CFF;
    margin-bottom: 4px;
}

.stat-label {
    color: #B8BCC8;
    font-size: 11px;
}

.admin-details h5 {
    color: #F1F1F1;
    margin: 10px 0 5px 0;
    font-size: 13px;
}

.admin-details ul {
    list-style: none;
    padding: 0;
    margin: 0 0 15px 0;
}

.admin-details li {
    color: #B8BCC8;
    font-size: 11px;
    padding: 2px 0;
    border-left: 3px solid #5F5CFF;
    padding-left: 8px;
    margin-bottom: 4px;
}

/* Demographic Charts */
.demographic-charts {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.chart-container {
    background: rgba(13, 16, 23, 0.6);
    border: 1px solid #2D3142;
    border-radius: 12px;
    padding: 20px;
    height: 300px;
}

.demographic-stats {
    background: rgba(13, 16, 23, 0.6);
    border: 1px solid #2D3142;
    border-radius: 12px;
    padding: 20px;
}

/* Demographic Summary */
.demographic-summary {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin-bottom: 20px;
}

.demo-stat {
    text-align: center;
    padding: 15px;
    background: rgba(40, 167, 69, 0.1);
    border-radius: 8px;
    border: 1px solid rgba(40, 167, 69, 0.2);
}

.demo-stat .stat-number {
    color: #28a745;
}

/* Population List */
.population-list h5 {
    color: #F1F1F1;
    margin: 0 0 10px 0;
    font-size: 14px;
}

.pop-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #2D3142;
}

.pop-name {
    color: #B8BCC8;
    font-size: 11px;
}

.pop-value {
    color: #28a745;
    font-size: 11px;
    font-weight: 600;
}

/* Economic Indicators */
.economic-indicators {
    background: rgba(13, 16, 23, 0.6);
    border: 1px solid #2D3142;
    border-radius: 12px;
    padding: 20px;
}

.economic-summary {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin-bottom: 20px;
}

.econ-stat {
    text-align: center;
    padding: 15px;
    background: rgba(255, 193, 7, 0.1);
    border-radius: 8px;
    border: 1px solid rgba(255, 193, 7, 0.2);
}

.econ-stat .stat-number {
    color: #ffc107;
}

/* PIB Ranking */
.pib-ranking h5 {
    color: #F1F1F1;
    margin: 0 0 15px 0;
    font-size: 14px;
}

.pib-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    border-bottom: 1px solid #2D3142;
}

.rank {
    background: #ffc107;
    color: #212529;
    width: 25px;
    height: 25px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: bold;
}

.pib-name {
    flex: 1;
    color: #B8BCC8;
    font-size: 11px;
}

.pib-value {
    color: #ffc107;
    font-size: 11px;
    font-weight: 600;
}

/* Geographic Info */
.geographic-info {
    background: rgba(13, 16, 23, 0.6);
    border: 1px solid #2D3142;
    border-radius: 12px;
    padding: 20px;
}

.geo-summary h4 {
    color: #F1F1F1;
    margin: 0 0 15px 0;
    font-size: 16px;
}

.density-list {
    max-height: 300px;
    overflow-y: auto;
}

.density-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #2D3142;
}

.density-name {
    color: #B8BCC8;
    font-size: 11px;
}

.density-value {
    color: #17a2b8;
    font-size: 11px;
    font-weight: 600;
}

/* PIB Per Capita */
.pib-per-capita {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 2px solid #2D3142;
}

.pib-per-capita h5 {
    color: #F1F1F1;
    margin: 0 0 15px 0;
    font-size: 14px;
}

.pib-pc-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #2D3142;
}

.pc-name {
    color: #B8BCC8;
    font-size: 11px;
}

.pc-value {
    color: #ffc107;
    font-size: 11px;
    font-weight: 600;
}

/* API Error Notification */
.api-error-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(220, 53, 69, 0.95);
    border: 2px solid #dc3545;
    border-radius: 12px;
    padding: 0;
    z-index: 10000;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    animation: slideInRight 0.3s ease;
    max-width: 350px;
}

.error-content {
    padding: 15px;
}

.error-content h4 {
    color: white;
    margin: 0 0 8px 0;
    font-size: 14px;
}

.error-content p {
    color: rgba(255, 255, 255, 0.9);
    margin: 0 0 10px 0;
    font-size: 12px;
}

.error-content button {
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 11px;
    cursor: pointer;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Responsive Design */
@media (max-width: 768px) {
    .api-integration-panel {
        padding: 15px;
        margin: 0 -15px 25px -15px;
        border-radius: 0;
    }
    
    .api-header {
        flex-direction: column;
        gap: 15px;
    }
    
    .api-controls {
        width: 100%;
        justify-content: center;
    }
    
    .api-status {
        grid-template-columns: 1fr;
    }
    
    .municipal-data-grid {
        grid-template-columns: 1fr;
    }
    
    .demographic-charts {
        grid-template-columns: 1fr;
    }
    
    .chart-container {
        height: 250px;
    }
}

/* ===== CALENDAR STYLES ===== */
.calendar-container {
    background: #23263B;
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 25px;
    border: 2px solid #2D3142;
}

.calendar-content {
    background: #2D3142;
    border-radius: 12px;
    padding: 20px;
}

.calendar-header {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #3A3F56;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    margin-top: 10px;
}

.calendar-day-header {
    background: #3A3F56;
    color: #B8BCC8;
    text-align: center;
    padding: 10px 5px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.calendar-day {
    background: #23263B;
    border: 1px solid #3A3F56;
    min-height: 80px;
    padding: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.calendar-day:hover {
    background: #2D3142;
    border-color: #5F5CFF;
}

.calendar-day.today {
    background: #5F5CFF;
    border-color: #7C78FF;
}

.calendar-day.other-month {
    opacity: 0.3;
}

.calendar-day.has-visit {
    border: 2px solid #6EE7B7;
}

.day-number {
    font-size: 14px;
    font-weight: 600;
    color: #F1F1F1;
    margin-bottom: 5px;
}

.day-visits {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.visit-indicator {
    background: #5F5CFF;
    color: white;
    font-size: 10px;
    padding: 2px 4px;
    border-radius: 3px;
    text-overflow: ellipsis;
    overflow: hidden;
    white-space: nowrap;
}

.visit-indicator.status-agendada { background: #6c757d; }
.visit-indicator.status-em-andamento { background: #ffc107; }
.visit-indicator.status-realizada { background: #17a2b8; }
.visit-indicator.status-finalizada { background: #28a745; }

.day-details-panel {
    background: #2D3142;
    border-radius: 12px;
    padding: 20px;
}

.visits-list {
    max-height: 300px;
    overflow-y: auto;
}

.visit-item {
    background: #23263B;
    border: 1px solid #3A3F56;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
}

.visit-item:hover {
    border-color: #5F5CFF;
    transform: translateY(-1px);
}

.visit-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 8px;
}

.visit-time {
    font-size: 14px;
    font-weight: 600;
    color: #6EE7B7;
}

.visit-status {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 12px;
    color: white;
}

.visit-municipality {
    font-size: 13px;
    color: #F1F1F1;
    font-weight: 500;
}

.visit-local {
    font-size: 11px;
    color: #B8BCC8;
    margin-top: 4px;
}

.month-stats {
    background: #23263B;
    border-radius: 8px;
    padding: 15px;
    border: 1px solid #3A3F56;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin-top: 10px;
}

.stat-item {
    text-align: center;
}

.stat-item .stat-value {
    font-size: 18px;
    font-weight: bold;
    color: #5F5CFF;
}

.stat-item .stat-label {
    font-size: 11px;
    color: #B8BCC8;
    text-transform: uppercase;
}

.empty-state {
    color: #6c757d;
}

/* Modal customizado */
.modal-content.bg-dark {
    background-color: #23263B !important;
    border: 1px solid #2D3142;
}

.btn-close-white {
    filter: invert(1) grayscale(100%) brightness(200%);
}

/* Responsive */
@media (max-width: 768px) {
        padding: 15px;
    }
    
        min-height: 60px;
        padding: 5px;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
        gap: 10px;
    }
}

/* ========================================
   ANÁLISE PREDITIVA AVANÇADA
   ======================================== */

/* Predictive Analysis Container */
.predictive-analysis-panel {
    background: linear-gradient(145deg, #1a1d2e 0%, #16213e 100%);
    border: 2px solid #2d4a75;
    border-radius: 20px;
    padding: 25px;
    margin-bottom: 25px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
}

.predictive-analysis-panel::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
        radial-gradient(circle at 20% 20%, rgba(255, 99, 132, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(54, 162, 235, 0.05) 0%, transparent 50%);
    z-index: 1;
    pointer-events: none;
}

.predictive-analysis-panel > * {
    position: relative;
    z-index: 2;
}

/* Predictive Header */
.predictive-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid #2D3142;
}

.predictive-header h3 {
    color: #F1F1F1;
    margin: 0;
    font-size: 20px;
    font-weight: 700;
}

.predictive-controls {
    display: flex;
    gap: 10px;
}

.pred-btn {
    background: linear-gradient(135deg, #ff6384 0%, #ff8a9b 100%);
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 25px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(255, 99, 132, 0.3);
}

.pred-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(255, 99, 132, 0.5);
}

.forecast-btn {
    background: linear-gradient(135deg, #36a2eb 0%, #4bc0c0 100%);
}

.simulation-btn {
    background: linear-gradient(135deg, #ffce56 0%, #ff9f40 100%);
}

/* Scenario Builder */
.scenario-builder {
    background: rgba(13, 16, 23, 0.8);
    border: 2px solid #2D3142;
    border-radius: 16px;
    padding: 25px;
    margin-bottom: 25px;
}

.scenario-builder h4 {
    color: #F1F1F1;
    margin: 0 0 20px 0;
    font-size: 18px;
}

.scenario-form {
    display: grid;
    gap: 15px;
}

.form-row {
    display: grid;
    grid-template-columns: 150px 1fr auto;
    gap: 15px;
    align-items: center;
}

.form-row label {
    color: #B8BCC8;
    font-size: 12px;
    font-weight: 600;
}

.form-row input, .form-row select {
    background: rgba(13, 16, 23, 0.6);
    border: 1px solid #2D3142;
    border-radius: 8px;
    color: #F1F1F1;
    padding: 8px 12px;
    font-size: 12px;
}

.form-row input[type="range"] {
    background: transparent;
}

#success-rate-value {
    background: #5F5CFF;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    min-width: 40px;
    text-align: center;
}

.form-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 15px;
}

.create-btn {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
}

.cancel-btn {
    background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
}

/* Forecast Section */
.forecast-section {
    margin-bottom: 30px;
}

.forecast-section h4 {
    color: #F1F1F1;
    margin: 0 0 20px 0;
    font-size: 16px;
}

.forecast-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.forecast-card {
    background: rgba(13, 16, 23, 0.6);
    border: 1px solid #2D3142;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    transition: all 0.3s ease;
}

.forecast-card:hover {
    background: rgba(13, 16, 23, 0.8);
    border-color: #ff6384;
    transform: translateY(-2px);
}

.forecast-title {
    color: #B8BCC8;
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 10px;
}

.forecast-value {
    color: #F1F1F1;
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 8px;
}

.forecast-trend {
    font-size: 11px;
    font-weight: 600;
    color: #28a745;
}

/* Scenarios Section */
.scenarios-section {
    margin-bottom: 30px;
}

.scenarios-section h4 {
    color: #F1F1F1;
    margin: 0 0 20px 0;
    font-size: 16px;
}

.scenarios-tabs {
    display: flex;
    background: rgba(13, 16, 23, 0.6);
    border-radius: 12px;
    padding: 4px;
    margin-bottom: 20px;
    border: 1px solid #2D3142;
}

.scenario-tab {
    flex: 1;
    background: transparent;
    border: none;
    color: #B8BCC8;
    padding: 10px 15px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.scenario-tab:hover {
    background: rgba(255, 99, 132, 0.1);
    color: #F1F1F1;
}

.scenario-tab.active {
    background: linear-gradient(135deg, #ff6384 0%, #ff8a9b 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(255, 99, 132, 0.3);
}

.scenario-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.scenario-chart-container {
    background: rgba(13, 16, 23, 0.6);
    border: 1px solid #2D3142;
    border-radius: 12px;
    padding: 20px;
    height: 300px;
}

.scenario-insights {
    background: rgba(13, 16, 23, 0.6);
    border: 1px solid #2D3142;
    border-radius: 12px;
    padding: 20px;
}

.insight-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    border-bottom: 1px solid #2D3142;
}

.insight-icon {
    font-size: 16px;
}

.insight-text {
    color: #B8BCC8;
    font-size: 12px;
    line-height: 1.4;
}

/* Monte Carlo Section */
.monte-carlo-section {
    margin-bottom: 30px;
}

.monte-carlo-section h4 {
    color: #F1F1F1;
    margin: 0 0 20px 0;
    font-size: 16px;
}

.monte-carlo-controls {
    display: flex;
    gap: 20px;
    align-items: center;
    margin-bottom: 20px;
    padding: 15px;
    background: rgba(13, 16, 23, 0.4);
    border-radius: 12px;
    border: 1px solid #2D3142;
}

.control-group {
    display: flex;
    align-items: center;
    gap: 8px;
}

.control-group label {
    color: #B8BCC8;
    font-size: 12px;
    font-weight: 600;
}

.control-group select {
    background: rgba(13, 16, 23, 0.6);
    border: 1px solid #2D3142;
    border-radius: 8px;
    color: #F1F1F1;
    padding: 6px 10px;
    font-size: 11px;
}

.run-mc-btn {
    background: linear-gradient(135deg, #ffce56 0%, #ff9f40 100%);
}

.monte-carlo-results {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 20px;
}

.mc-chart-container {
    background: rgba(13, 16, 23, 0.6);
    border: 1px solid #2D3142;
    border-radius: 12px;
    padding: 20px;
    height: 300px;
}

.mc-statistics {
    background: rgba(13, 16, 23, 0.6);
    border: 1px solid #2D3142;
    border-radius: 12px;
    padding: 20px;
}

.mc-stat {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #2D3142;
}

.mc-label {
    color: #B8BCC8;
    font-size: 12px;
}

.mc-value {
    color: #ffce56;
    font-size: 12px;
    font-weight: 600;
}

/* Recommendations Section */
.recommendations-section h4 {
    color: #F1F1F1;
    margin: 0 0 20px 0;
    font-size: 16px;
}

.recommendations-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 15px;
}

.rec-card {
    background: rgba(13, 16, 23, 0.6);
    border: 1px solid #2D3142;
    border-radius: 12px;
    padding: 20px;
    transition: all 0.3s ease;
}

.rec-card:hover {
    background: rgba(13, 16, 23, 0.8);
    transform: translateY(-2px);
}

.rec-card.priority-high {
    border-left: 4px solid #dc3545;
}

.rec-card.priority-medium {
    border-left: 4px solid #ffc107;
}

.rec-card.priority-low {
    border-left: 4px solid #28a745;
}

.rec-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.rec-priority {
    background: rgba(220, 53, 69, 0.2);
    color: #dc3545;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
}

.rec-card.priority-medium .rec-priority {
    background: rgba(255, 193, 7, 0.2);
    color: #ffc107;
}

.rec-card.priority-low .rec-priority {
    background: rgba(40, 167, 69, 0.2);
    color: #28a745;
}

.rec-impact {
    color: #B8BCC8;
    font-size: 10px;
    font-weight: 600;
}

.rec-title {
    color: #F1F1F1;
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 8px;
}

.rec-description {
    color: #B8BCC8;
    font-size: 12px;
    line-height: 1.4;
    margin-bottom: 10px;
}

.rec-timeline {
    color: #36a2eb;
    font-size: 11px;
    font-weight: 600;
}

/* Responsive Design */
@media (max-width: 768px) {
    .predictive-analysis-panel {
        padding: 15px;
        margin: 0 -15px 25px -15px;
        border-radius: 0;
    }
    
    .predictive-header {
        flex-direction: column;
        gap: 15px;
    }
    
    .predictive-controls {
        width: 100%;
        justify-content: center;
    }
    
    .form-row {
        grid-template-columns: 1fr;
        gap: 8px;
    }
    
    .forecast-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .scenario-content {
        grid-template-columns: 1fr;
    }
    
    .monte-carlo-results {
        grid-template-columns: 1fr;
    }
    
    .recommendations-grid {
        grid-template-columns: 1fr;
    }
}

/* Neural Network Background */
.ml-system-panel::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: 
        radial-gradient(circle at 20% 50%, rgba(0, 212, 255, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(95, 92, 255, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(110, 231, 183, 0.03) 0%, transparent 50%);
    pointer-events: none;
    z-index: 1;
}

.ml-system-panel > * {
    position: relative;
    z-index: 2;
}

/* ESTILOS PNSB FOCUSED - TRABALHO DE CAMPO */
.pnsb-focused {
    border-left: 4px solid #5F5CFF;
    background: linear-gradient(90deg, #5F5CFF10, transparent);
}

.municipio-urgente {
    border-left: 4px solid #dc3545;
    background: linear-gradient(90deg, #dc354520, transparent);
    animation: pulse-urgent 2s infinite;
}

@keyframes pulse-urgent {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
}

.status-validado {
    border: 2px solid #28a745;
    background: linear-gradient(135deg, #28a74520, #007bff10);
}

.pnsb-actions {
    position: sticky;
    bottom: 20px;
    z-index: 100;
    text-align: center;
    margin-top: 20px;
}

.btn-pnsb {
    background: linear-gradient(90deg, #5F5CFF, #6EE7B7);
    border: none;
    color: white;
    padding: 12px 24px;
    border-radius: 25px;
    font-weight: 600;
    margin: 0 8px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(95, 92, 255, 0.3);
}

.btn-pnsb:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(95, 92, 255, 0.4);
    color: white;
}

.info-rapida {
    background: #23263B;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    border-left: 4px solid #17a2b8;
}

.info-rapida h6 {
    color: #17a2b8;
    margin-bottom: 8px;
    font-weight: 600;
}

.progresso-visual {
    height: 8px;
    background: #2D3142;
    border-radius: 4px;
    overflow: hidden;
    margin: 8px 0;
}

.progresso-barra {
    height: 100%;
    background: linear-gradient(90deg, #5F5CFF, #6EE7B7);
    transition: width 0.5s ease;
}

.contato-rapido {
    background: #2D3142;
    border-radius: 6px;
    padding: 8px 12px;
    margin: 5px 0;
    border-left: 3px solid #ffc107;
    font-size: 14px;
}

/* ===== FILTROS DE PRIORIDADE NO DASHBOARD EXECUTIVO ===== */
.filter-btn {
    background: #374151;
    color: #D1D5DB;
    border: 1px solid #4B5563;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: flex;
    align-items: center;
    gap: 4px;
    white-space: nowrap;
}

.filter-btn:hover {
    background: #4B5563;
    border-color: #6B7280;
    color: #F9FAFB;
    transform: translateY(-1px);
}

.filter-btn.active {
    background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
    border-color: #1D4ED8;
    color: #F8FAFC;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
}

.filter-btn.p1.active {
    background: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%);
    border-color: #991B1B;
    box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
}

.filter-btn.p2.active {
    background: linear-gradient(135deg, #D97706 0%, #B45309 100%);
    border-color: #92400E;
    box-shadow: 0 2px 8px rgba(217, 119, 6, 0.3);
}

.filter-btn.p3.active {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    border-color: #065F46;
    box-shadow: 0 2px 8px rgba(5, 150, 105, 0.3);
}

.filter-btn.warning.active {
    background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
    border-color: #B45309;
    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
}

.filter-btn i {
    font-size: 10px;
}

/* Responsividade dos filtros */
@media (max-width: 768px) {
    .filter-btn {
        padding: 5px 8px;
        font-size: 10px;
    }
    
    .filter-btn span {
        display: none;
    }
}

/* ===== TOAST NOTIFICATION SYSTEM ===== */
.toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #1E293B;
    color: #F8FAFC;
    padding: 16px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    border-left: 4px solid #6B7280;
    display: flex;
    align-items: center;
    gap: 12px;
    min-width: 300px;
    max-width: 500px;
    transform: translateX(400px);
    opacity: 0;
    transition: all 0.3s ease;
    z-index: 9999;
    font-size: 14px;
    line-height: 1.4;
}

.toast.show {
    transform: translateX(0);
    opacity: 1;
}

.toast.toast-success {
    border-left-color: #10B981;
    background: linear-gradient(135deg, #065F46 0%, #047857 100%);
}

.toast.toast-error {
    border-left-color: #EF4444;
    background: linear-gradient(135deg, #7F1D1D 0%, #991B1B 100%);
}

.toast.toast-warning {
    border-left-color: #F59E0B;
    background: linear-gradient(135deg, #92400E 0%, #B45309 100%);
}

.toast.toast-info {
    border-left-color: #3B82F6;
    background: linear-gradient(135deg, #1E3A8A 0%, #1D4ED8 100%);
}

.toast i {
    font-size: 16px;
    flex-shrink: 0;
}

.toast span {
    flex-grow: 1;
}

/* Multiple toasts stacking */
.toast:nth-child(2) { top: 90px; }
.toast:nth-child(3) { top: 160px; }
.toast:nth-child(4) { top: 230px; }

/* Dashboard expanded mode */
.dashboard-pnsb-container.expanded {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 999;
    background: rgba(15, 23, 42, 0.95);
    overflow-y: auto;
    padding: 20px;
}

.dashboard-pnsb-container.expanded .dashboard-pnsb {
    max-width: none;
    height: auto;
    margin: 0;
}
</style>
{% endblock %}

{% block content %}

<!-- HEADER INTEGRADO -->
<div class="pnsb-header-integrated">
    <div class="d-flex flex-wrap align-items-center justify-content-between">
        <div class="header-title-section">
            <h1 class="pnsb-main-title">🗺️ Mapa de Progresso PNSB 2024</h1>
            <div class="header-status">
                <span class="status-badge" id="connection-status">🟢 Online</span>
                <span class="update-time" id="last-update">Última atualização: --</span>
            </div>
        </div>
        
        <div class="header-actions">
            <!-- Filtros Rápidos -->
            <div class="quick-filters">
                <button class="filter-btn active" data-filter="all" title="Mostrar todos">
                    <i class="fas fa-list"></i> Todos
                </button>
                <button class="filter-btn p1" data-filter="p1" title="P1 - Críticos">
                    <i class="fas fa-exclamation-circle"></i> P1
                </button>
                <button class="filter-btn p2" data-filter="p2" title="P2 - Importantes">
                    <i class="fas fa-exclamation-triangle"></i> P2
                </button>
                <button class="filter-btn p3" data-filter="p3" title="P3 - Opcionais">
                    <i class="fas fa-info-circle"></i> P3
                </button>
            </div>
            
            <!-- Ações Principais -->
            <div class="main-actions">
                <button class="action-btn primary" onclick="atualizarDados()" title="Atualizar dados">
                    <i class="fas fa-sync"></i>
                </button>
                <button class="action-btn success" onclick="exportarMapa()" title="Exportar mapa">
                    <i class="fas fa-download"></i>
                </button>
                <button class="action-btn info" onclick="toggleViewMode()" title="Alternar vista">
                    <i class="fas fa-layer-group"></i>
                </button>
                <button class="action-btn warning" onclick="toggleFullscreen()" title="Tela cheia">
                    <i class="fas fa-expand"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- SEÇÃO PRINCIPAL -->
<div class="main-section" id="main-section">
    <div class="map-container-new" id="map-container-new">
        <!-- Mapa Principal -->
        <div class="map-wrapper">
            <div class="map-controls">
                <div class="map-legend">
                    <h6>🗺️ Santa Catarina</h6>
                    <div class="legend-items">
                        <div class="legend-item">
                            <div class="legend-color p1"></div>
                            <span>P1 Crítico</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color p2"></div>
                            <span>P2 Importante</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color p3"></div>
                            <span>P3 Opcional</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color completed"></div>
                            <span>Concluído</span>
                        </div>
                    </div>
                </div>
                
                <!-- Mini Dashboard Sobreposto -->
                <div class="mini-dashboard" id="mini-dashboard">
                    <div class="mini-kpi">
                        <span class="mini-value" id="mini-total">11</span>
                        <span class="mini-label">Municípios</span>
                    </div>
                    <div class="mini-kpi">
                        <span class="mini-value" id="mini-concluidos">--</span>
                        <span class="mini-label">Concluídos</span>
                    </div>
                    <div class="mini-kpi">
                        <span class="mini-value" id="mini-progresso">--%</span>
                        <span class="mini-label">Progresso</span>
                    </div>
                </div>
            </div>
            
            <div id="mapa-progresso"></div>
        </div>
    </div>
    
    <!-- Painel Lateral Compacto -->
    <div class="sidebar-compact" id="sidebar-compact">
        <!-- KPIs Essenciais -->
        <div class="kpis-essential">
            <div class="kpi-item mrs">
                <div class="kpi-icon"><i class="fas fa-recycle"></i></div>
                <div class="kpi-data">
                    <span class="kpi-value" id="kpi-mrs">--%</span>
                    <span class="kpi-label">MRS</span>
                </div>
            </div>
            <div class="kpi-item map">
                <div class="kpi-icon"><i class="fas fa-tint"></i></div>
                <div class="kpi-data">
                    <span class="kpi-value" id="kpi-map">--%</span>
                    <span class="kpi-label">MAP</span>
                </div>
            </div>
            <div class="kpi-item visits">
                <div class="kpi-icon"><i class="fas fa-calendar-check"></i></div>
                <div class="kpi-data">
                    <span class="kpi-value" id="kpi-visits">--</span>
                    <span class="kpi-label">Visitas</span>
                </div>
            </div>
            <div class="kpi-item entities">
                <div class="kpi-icon"><i class="fas fa-building"></i></div>
                <div class="kpi-data">
                    <span class="kpi-value" id="kpi-entities">--</span>
                    <span class="kpi-label">Entidades</span>
                </div>
            </div>
        </div>
        
        <!-- Lista Municípios Resumida -->
        <div class="municipalities-summary">
            <h6>Municípios</h6>
            <div class="municipalities-list" id="municipalities-summary-list">
                <!-- Será preenchido via JavaScript -->
            </div>
        </div>
        
        <!-- Acesso Rápido -->
        <div class="quick-access">
            <button class="quick-btn" onclick="openAdvancedTab('dashboard')" title="Dashboard Executivo">
                <i class="fas fa-chart-line"></i>
                <span>Dashboard</span>
            </button>
            <button class="quick-btn" onclick="openAdvancedTab('routes')" title="Otimizador de Rotas">
                <i class="fas fa-route"></i>
                <span>Rotas</span>
            </button>
        </div>
    </div>
</div>

<!-- SEÇÃO EXPANDÍVEL COM TABS -->
<div class="advanced-section" id="advanced-section">
    <!-- Tab Navigation -->
    <div class="tab-navigation">
        <button class="tab-btn active" data-tab="dashboard" onclick="switchTab('dashboard')">
            <i class="fas fa-chart-line"></i> Dashboard Executivo
        </button>
        <button class="tab-btn" data-tab="routes" onclick="switchTab('routes')">
            <i class="fas fa-route"></i> Otimizador de Rotas
        </button>
        <button class="tab-btn" data-tab="list" onclick="switchTab('list')">
            <i class="fas fa-list"></i> Vista Detalhada
        </button>
        <button class="tab-btn" data-tab="reports" onclick="switchTab('reports')">
            <i class="fas fa-file-alt"></i> Relatórios
        </button>
        <button class="tab-close" onclick="closeAdvancedSection()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <!-- Tab Content -->
    <div class="tab-content">
        <!-- TAB 1: Dashboard Executivo -->
        <div class="tab-pane active" id="tab-dashboard">
            <div class="dashboard-pnsb-container" id="dashboardPNSBExecutivo">
    <div class="row g-4 mb-4">
        <!-- Header com Filtros de Prioridade -->
        <div class="col-12">
            <div class="progress-card">
                <div class="progress-header">
                    <div>
                        <h5 class="text-light mb-1">
                            <i class="fas fa-chart-line"></i> Dashboard Executivo PNSB 2024 - Santa Catarina
                        </h5>
                        <p class="text-muted mb-0 small">Sistema integrado de gestão de visitas e questionários obrigatórios</p>
                    </div>
                    <div class="d-flex gap-2 align-items-center flex-wrap">
                        <div class="d-flex gap-1 me-3">
                            <button class="filter-btn active" data-filter="all" title="Mostrar todos os municípios">
                                <i class="fas fa-list"></i> Todos
                            </button>
                            <button class="filter-btn p1" data-filter="p1" title="P1 - Entidades críticas (Prefeituras + Lista UF)">
                                <i class="fas fa-exclamation-circle"></i> P1 Críticos
                            </button>
                            <button class="filter-btn p2" data-filter="p2" title="P2 - Entidades importantes (Identificadas em campo)">
                                <i class="fas fa-exclamation-triangle"></i> P2 Importantes
                            </button>
                            <button class="filter-btn p3" data-filter="p3" title="P3 - Entidades opcionais (Referência)">
                                <i class="fas fa-info-circle"></i> P3 Opcionais
                            </button>
                            <button class="filter-btn warning" data-filter="atrasados" title="Municípios com atrasos ou problemas">
                                <i class="fas fa-clock"></i> Atrasados
                            </button>
                        </div>
                        <span class="badge bg-info" id="status-atualizacao">Atualizado: --</span>
                        <button class="btn btn-sm btn-outline-light" onclick="carregarDadosProgresso()">
                            <i class="fas fa-sync"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Métricas Principais -->
                <div class="row g-3 mb-4">
                    <div class="col-md-2">
                        <div class="kpi-card p1">
                            <div class="kpi-icon">
                                <i class="fas fa-star"></i>
                            </div>
                            <div class="kpi-content">
                                <div class="kpi-value" id="progressoP1">--</div>
                                <div class="kpi-label">P1 - Críticas</div>
                                <div class="kpi-detail" id="detailP1">-- de -- concluídas</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="kpi-card p2">
                            <div class="kpi-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="kpi-content">
                                <div class="kpi-value" id="progressoP2">--</div>
                                <div class="kpi-label">P2 - Importantes</div>
                                <div class="kpi-detail" id="detailP2">-- de -- concluídas</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="kpi-card p3">
                            <div class="kpi-icon">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            <div class="kpi-content">
                                <div class="kpi-value" id="progressoP3">--</div>
                                <div class="kpi-label">P3 - Opcionais</div>
                                <div class="kpi-detail" id="detailP3">-- de -- cadastradas</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="kpi-card municipios">
                            <div class="kpi-icon">
                                <i class="fas fa-map-marked-alt"></i>
                            </div>
                            <div class="kpi-content">
                                <div class="kpi-value" id="municipiosConcluidos">--</div>
                                <div class="kpi-label">Municípios</div>
                                <div class="kpi-detail">de 11 em SC</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="kpi-card mrs">
                            <div class="kpi-icon">
                                <i class="fas fa-recycle"></i>
                            </div>
                            <div class="kpi-content">
                                <div class="kpi-value" id="progressoMRS">--</div>
                                <div class="kpi-label">MRS</div>
                                <div class="kpi-detail">Resíduos Sólidos</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="kpi-card map">
                            <div class="kpi-icon">
                                <i class="fas fa-tint"></i>
                            </div>
                            <div class="kpi-content">
                                <div class="kpi-value" id="progressoMAP">--</div>
                                <div class="kpi-label">MAP</div>
                                <div class="kpi-detail">Águas Pluviais</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Alertas Críticos PNSB -->
                <div class="row g-3 mb-4">
                    <div class="col-md-8">
                        <div class="alertas-criticos">
                            <h6 class="text-light mb-3">
                                <i class="fas fa-exclamation-triangle text-warning"></i> Alertas Críticos PNSB
                            </h6>
                            <div id="alertasCriticos" class="alertas-list">
                                <div class="alerta-item loading">
                                    <i class="fas fa-spinner fa-spin"></i> Carregando alertas...
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="timeline-pnsb">
                            <h6 class="text-light mb-3">
                                <i class="fas fa-clock"></i> Timeline PNSB
                            </h6>
                            <div id="timelinePNSB" class="timeline-content">
                                <div class="timeline-item">
                                    <div class="timeline-date">Mar 2024</div>
                                    <div class="timeline-desc">Início da coleta</div>
                                </div>
                                <div class="timeline-item">
                                    <div class="timeline-date">Atual</div>
                                    <div class="timeline-desc" id="statusAtual">Em progresso...</div>
                                </div>
                                <div class="timeline-item">
                                    <div class="timeline-date" id="previsaoFim">Dez 2024</div>
                                    <div class="timeline-desc">Conclusão prevista</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Progresso por Tipo de Pesquisa -->
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="tipo-pesquisa-card mrs-card">
                            <h6 class="text-light">
                                <i class="fas fa-recycle"></i> MRS - Manejo de Resíduos Sólidos
                            </h6>
                            <div class="progress-bar-pnsb">
                                <div class="progress-fill mrs-progress" id="barraProgressoMRS" style="width: 0%"></div>
                            </div>
                            <div class="progress-stats">
                                <span id="statsMRS">-- entidades concluídas</span>
                                <span class="float-end" id="percentualMRS">--%</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="tipo-pesquisa-card map-card">
                            <h6 class="text-light">
                                <i class="fas fa-tint"></i> MAP - Manejo de Águas Pluviais
                            </h6>
                            <div class="progress-bar-pnsb">
                                <div class="progress-fill map-progress" id="barraProgressoMAP" style="width: 0%"></div>
                            </div>
                            <div class="progress-stats">
                                <span id="statsMAP">-- entidades concluídas</span>
                                <span class="float-end" id="percentualMAP">--%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filtros Essenciais -->
<div class="filters-essential">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="text-light mb-0"><i class="fas fa-filter"></i> Filtros</h6>
        <button class="btn btn-sm btn-outline-light" onclick="limparFiltros()">
            <i class="fas fa-eraser"></i> Limpar
        </button>
    </div>
    
    <div class="row g-3 mb-3">
        <div class="col-md-4">
            <select class="form-select bg-dark text-light" id="filtro-tipo" onchange="aplicarFiltros()">
                <option value="">📋 Todos os Tipos</option>
                <option value="MRS">🗑️ MRS - Manejo de Resíduos Sólidos</option>
                <option value="MAP">🌧️ MAP - Manejo de Águas Pluviais</option>
            </select>
        </div>
        <div class="col-md-4">
            <select class="form-select bg-dark text-light" id="filtro-municipio" onchange="aplicarFiltros()">
                <option value="">🏛️ Todos os Municípios</option>
                <option value="Balneário Camboriú">Balneário Camboriú</option>
                <option value="Balneário Piçarras">Balneário Piçarras</option>
                <option value="Bombinhas">Bombinhas</option>
                <option value="Camboriú">Camboriú</option>
                <option value="Itajaí">Itajaí</option>
                <option value="Itapema">Itapema</option>
                <option value="Luiz Alves">Luiz Alves</option>
                <option value="Navegantes">Navegantes</option>
                <option value="Penha">Penha</option>
                <option value="Porto Belo">Porto Belo</option>
                <option value="Ilhota">Ilhota</option>
            </select>
        </div>
        <div class="col-md-4">
            <select class="form-select bg-dark text-light" id="filtro-status" onchange="aplicarFiltros()">
                <option value="">📊 Todos os Status</option>
                <option value="pending">⏳ Pendentes</option>
                <option value="in-progress">🔄 Em Progresso</option>
                <option value="completed">✅ Finalizados</option>
                <option value="blocked">🚫 Bloqueados</option>
            </select>
        </div>
    </div>
</div>

<!-- Legenda -->
<div class="legend-container">
    <h6 class="text-light mb-3">Legenda do Progresso</h6>
    <div class="row">
        <div class="col-md-3">
            <div class="legend-item">
                <div class="legend-color" style="background: #28a745;"></div>
                <span class="text-light">Completo (100%)</span>
            </div>
        </div>
        <div class="col-md-3">
            <div class="legend-item">
                <div class="legend-color" style="background: #ffc107;"></div>
                <span class="text-light">Em Progresso (50-99%)</span>
            </div>
        </div>
        <div class="col-md-3">
            <div class="legend-item">
                <div class="legend-color" style="background: #17a2b8;"></div>
                <span class="text-light">Iniciado (1-49%)</span>
            </div>
        </div>
        <div class="col-md-3">
            <div class="legend-item">
                <div class="legend-color" style="background: #6c757d;"></div>
                <span class="text-light">Não Iniciado (0%)</span>
            </div>
        </div>
    </div>
</div>

<!-- Container do Mapa - REMOVIDO (usando nova estrutura) -->
<div class="map-container" id="map-view" style="display: none;">
    <div id="mapa-progresso-old"></div>
    
    <!-- Controles do Mapa -->
    <div class="map-controls">
        <button class="control-btn" onclick="centralizarMapa()" title="Centralizar">
            <i class="fas fa-crosshairs"></i>
        </button>
        <button class="control-btn" onclick="toggleFullscreen()" title="Tela Cheia">
            <i class="fas fa-expand"></i>
        </button>
        <button class="control-btn" onclick="exportarImagem()" title="Exportar Imagem">
            <i class="fas fa-camera"></i>
        </button>
        <button class="control-btn" onclick="toggleMeasureMode()" title="Medir Distância">
            <i class="fas fa-ruler"></i>
        </button>
        <button class="control-btn" onclick="toggleRouteOptimizer()" title="Otimizar Rotas">
            <i class="fas fa-route"></i>
        </button>
    </div>
    
    <!-- Legenda do Heatmap -->
    <div class="heatmap-legend" id="heatmap-legend">
        <h6><i class="fas fa-fire"></i> Intensidade do Progresso</h6>
        <div class="legend-scale">
            <div class="legend-color-gradient"></div>
        </div>
        <div class="legend-labels">
            <span>Crítico</span>
            <span>Baixo</span>
            <span>Médio</span>
            <span>Alto</span>
            <span>Completo</span>
        </div>
        <div class="mt-2">
            <small class="text-muted">
                <i class="fas fa-circle text-danger"></i> Alta Prioridade
                <i class="fas fa-circle text-warning ms-2"></i> Média Prioridade
                <i class="fas fa-circle text-secondary ms-2"></i> Baixa Prioridade
            </small>
        </div>
    </div>
</div>
<!-- Fim da seção antiga oculta -->
    
        <!-- TAB 2: Otimizador de Rotas -->
        <div class="tab-pane" id="tab-routes">
            <div class="route-optimizer-integrated">
                <div class="route-header">
                    <h5><i class="fas fa-route"></i> Otimização de Rotas Inteligente</h5>
                    <p class="text-muted">Sistema integrado para cálculo de rotas otimizadas entre municípios</p>
                </div>
        
        <div class="route-configuration">
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label class="form-label">Data da Rota</label>
                    <input type="date" class="form-control bg-dark text-light" id="route-date" value="">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Origem</label>
                    <select class="form-select bg-dark text-light" id="route-origin">
                        <option value="Itajaí">Itajaí (Base IBGE)</option>
                        <option value="Balneário Camboriú">Balneário Camboriú</option>
                        <option value="Navegantes">Navegantes</option>
                    </select>
                </div>
            </div>
            
            <div class="route-options mb-3">
                <h6 class="text-light">🧠 Critérios de Otimização Inteligente</h6>
                <div class="intelligent-criteria-grid">
                    <div class="criteria-option">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="route-criteria" value="intelligent" id="criteria-intelligent" checked>
                            <label class="form-check-label" for="criteria-intelligent">
                                <div class="criteria-header">
                                    <i class="fas fa-brain"></i>
                                    <span class="criteria-title">Inteligente</span>
                                </div>
                                <div class="criteria-description">
                                    Considera visitas passadas, urgência, progresso e proximidade
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="criteria-option">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="route-criteria" value="urgent_visits" id="criteria-urgent">
                            <label class="form-check-label" for="criteria-urgent">
                                <div class="criteria-header">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <span class="criteria-title">Urgência</span>
                                </div>
                                <div class="criteria-description">
                                    Prioriza visitas atrasadas e municípios nunca visitados
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="criteria-option">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="route-criteria" value="completion_focus" id="criteria-completion">
                            <label class="form-check-label" for="criteria-completion">
                                <div class="criteria-header">
                                    <i class="fas fa-tasks"></i>
                                    <span class="criteria-title">Finalização</span>
                                </div>
                                <div class="criteria-description">
                                    Foca em completar questionários pendentes e progresso baixo
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="criteria-option">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="route-criteria" value="visit_sequence" id="criteria-sequence">
                            <label class="form-check-label" for="criteria-sequence">
                                <div class="criteria-header">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span class="criteria-title">Sequencial</span>
                                </div>
                                <div class="criteria-description">
                                    Baseado no histórico e agenda de visitas
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="criteria-option">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="route-criteria" value="balanced" id="criteria-balanced">
                            <label class="form-check-label" for="criteria-balanced">
                                <div class="criteria-header">
                                    <i class="fas fa-balance-scale"></i>
                                    <span class="criteria-title">Balanceado</span>
                                </div>
                                <div class="criteria-description">
                                    Equilibra urgência, progresso, distância e complexidade
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="criteria-option">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="route-criteria" value="distance" id="criteria-distance">
                            <label class="form-check-label" for="criteria-distance">
                                <div class="criteria-header">
                                    <i class="fas fa-route"></i>
                                    <span class="criteria-title">Distância</span>
                                </div>
                                <div class="criteria-description">
                                    Otimização geográfica tradicional (menor distância)
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="municipalities-selection">
                <h6 class="text-light">Municípios para Visitar</h6>
                <div class="municipalities-grid" id="municipalities-grid">
                    <!-- Será populado dinamicamente -->
                </div>
            </div>
            
            <div class="route-actions mt-3">
                <button class="btn btn-primary" onclick="calcularRotaOtimizada()">
                    <i class="fas fa-calculator"></i> Calcular Rota
                </button>
                <button class="btn btn-success" onclick="exportarRota()">
                    <i class="fas fa-download"></i> Exportar
                </button>
                <button class="btn btn-info" onclick="simularTempo()">
                    <i class="fas fa-clock"></i> Simular Tempo
                </button>
            </div>
        </div>
        
        <!-- Resultado da Otimização -->
        <div class="route-result" id="route-result" style="display: none;">
            <h6 class="text-light"><i class="fas fa-check-circle"></i> Rota Otimizada</h6>
            <div class="route-summary">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="route-stat">
                            <div class="route-stat-value" id="route-distance">--</div>
                            <div class="route-stat-label">Distância Total</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="route-stat">
                            <div class="route-stat-value" id="route-duration">--</div>
                            <div class="route-stat-label">Tempo Estimado</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="route-stat">
                            <div class="route-stat-value" id="route-municipalities">--</div>
                            <div class="route-stat-label">Municípios</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="route-stat">
                            <div class="route-stat-value" id="route-efficiency">--</div>
                            <div class="route-stat-label">Eficiência</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="route-sequence mt-3">
                <h6 class="text-light">Sequência Sugerida</h6>
                <div class="sequence-list" id="sequence-list">
                    <!-- Será populado dinamicamente -->
                </div>
            </div>
            </div>
        </div>
        </div>
        
        <!-- TAB 3: Vista Detalhada -->
        <div class="tab-pane" id="tab-list">
            <div class="list-view-integrated">
                <div class="list-header">
                    <h5><i class="fas fa-list"></i> Vista Detalhada dos Municípios</h5>
                    <p class="text-muted">Visualização completa com todos os detalhes dos 11 municípios</p>
                </div>
                <div class="row g-3" id="list-view-content">
                    <!-- Será populado dinamicamente -->
                </div>
            </div>
        </div>
        
        <!-- TAB 4: Relatórios -->
        <div class="tab-pane" id="tab-reports">
            <div class="reports-integrated">
                <div class="reports-header">
                    <h5><i class="fas fa-file-alt"></i> Relatórios e Exportação</h5>
                    <p class="text-muted">Geração de relatórios detalhados e exportação de dados</p>
                </div>
                <div class="reports-content">
                    <div class="report-actions">
                        <button class="btn btn-primary" onclick="exportarRelatorio()">
                            <i class="fas fa-file-download"></i> Exportar Relatório Completo
                        </button>
                        <button class="btn btn-success" onclick="exportarMapa()">
                            <i class="fas fa-image"></i> Exportar Mapa
                        </button>
                        <button class="btn btn-info" onclick="exportarDados()">
                            <i class="fas fa-database"></i> Exportar Dados
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Painel de Predição Inteligente -->
<div class="row g-4 mt-4 mb-4">
    <div class="col-12">
        <div class="prediction-panel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="text-light mb-0">
                    <i class="fas fa-map-marked-alt"></i> Status dos 11 Municípios - Santa Catarina
                </h5>
                <button class="btn btn-outline-light btn-sm" onclick="atualizarRelatorio()">
                    <i class="fas fa-chart-line"></i> Recalcular
                </button>
                <button class="btn btn-outline-warning btn-sm" onclick="testarStatusMunicipios()" style="margin-left: 5px;">
                    <i class="fas fa-bug"></i> Testar Status
                </button>
            </div>
            
            <div class="row g-3">
                <div class="col-md-3">
                    <div class="prediction-card">
                        <div class="prediction-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="prediction-content">
                            <div class="prediction-value" id="data-conclusao-prevista">--</div>
                            <div class="prediction-label">Data Prevista de Conclusão</div>
                            <div class="prediction-confidence" id="confianca-previsao">--</div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="prediction-card">
                        <div class="prediction-icon">
                            <i class="fas fa-tachometer-alt"></i>
                        </div>
                        <div class="prediction-content">
                            <div class="prediction-value" id="velocidade-atual">--</div>
                            <div class="prediction-label">Velocidade Atual</div>
                            <div class="prediction-sublabel">municípios/semana</div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="prediction-card">
                        <div class="prediction-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="prediction-content">
                            <div class="prediction-value" id="municipios-risco">--</div>
                            <div class="prediction-label">Municípios em Risco</div>
                            <div class="prediction-sublabel">alta probabilidade de atraso</div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="prediction-card">
                        <div class="prediction-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="prediction-content">
                            <div class="prediction-value" id="recursos-necessarios">--</div>
                            <div class="prediction-label">Recursos Necessários</div>
                            <div class="prediction-sublabel">pesquisadores adicionais</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Cenários de Simulação -->
            <div class="simulation-scenarios mt-4">
                <h6 class="text-light mb-3">
                    <i class="fas fa-flask"></i> Simulação de Cenários
                </h6>
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="scenario-card scenario-optimistic">
                            <div class="scenario-header">
                                <i class="fas fa-rocket"></i>
                                <span>Cenário Otimista</span>
                            </div>
                            <div class="scenario-content">
                                <div class="scenario-date" id="cenario-otimista">--</div>
                                <div class="scenario-description">
                                    +20% eficiência, sem bloqueios
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="scenario-card scenario-realistic">
                            <div class="scenario-header">
                                <i class="fas fa-balance-scale"></i>
                                <span>Cenário Realista</span>
                            </div>
                            <div class="scenario-content">
                                <div class="scenario-date" id="cenario-realista">--</div>
                                <div class="scenario-description">
                                    Mantendo ritmo atual
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="scenario-card scenario-pessimistic">
                            <div class="scenario-header">
                                <i class="fas fa-exclamation-circle"></i>
                                <span>Cenário Pessimista</span>
                            </div>
                            <div class="scenario-content">
                                <div class="scenario-date" id="cenario-pessimista">--</div>
                                <div class="scenario-description">
                                    Com bloqueios e resistências
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Lista Detalhada dos Municípios -->
            <div class="municipalities-detail mt-4">
                <h6 class="text-light mb-3">
                    <i class="fas fa-list"></i> Status Individual dos Municípios
                    <button onclick="window.dashboardPNSB && window.dashboardPNSB.atualizarStatusMunicipios()" 
                            style="background: #3B82F6; color: white; border: none; padding: 2px 6px; border-radius: 4px; cursor: pointer; font-size: 10px; margin-left: 10px;">
                        🔄 Atualizar
                    </button>
                    <button onclick="console.log('Debug Dashboard:', window.dashboardPNSB ? 'OK' : 'NOT FOUND'); console.log('municipiosData:', window.dashboardPNSB?.municipiosData)" 
                            style="background: #10B981; color: white; border: none; padding: 2px 6px; border-radius: 4px; cursor: pointer; font-size: 10px; margin-left: 5px;">
                        🐛 Debug
                    </button>
                    <button onclick="toggleNotificationsPanel()" 
                            style="background: #DC2626; color: white; border: none; padding: 2px 6px; border-radius: 4px; cursor: pointer; font-size: 10px; margin-left: 5px;">
                        🔔 Alertas
                    </button>
                    <button onclick="carregarConfiguracaoEquipe().then(config => console.log('✅ Team Config:', config)).catch(err => console.error('❌ Erro:', err))" 
                            style="background: #9333EA; color: white; border: none; padding: 2px 6px; border-radius: 4px; cursor: pointer; font-size: 10px; margin-left: 5px;">
                        ⚙️ Team
                    </button>
                    <button onclick="debugarDashboard()" 
                            style="background: #F59E0B; color: white; border: none; padding: 2px 6px; border-radius: 4px; cursor: pointer; font-size: 10px; margin-left: 5px;">
                        🔧 Debug
                    </button>
                </h6>
                <div class="row g-3" id="municipiosStatus">
                    <!-- Será populado dinamicamente pela função atualizarStatusMunicipios() -->
                </div>
            </div>
            
            <!-- Recomendações Inteligentes -->
            <div class="recommendations mt-4">
                <h6 class="text-light mb-3">
                    <i class="fas fa-lightbulb"></i> Recomendações Estratégicas
                </h6>
                <div class="recommendations-list" id="recomendacoes-lista">
                    <!-- Será populado dinamicamente -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Estatísticas Resumidas -->
<div class="row g-4 mt-4">
    <div class="col-md-3">
        <div class="progress-card">
            <div class="detail-item">
                <div class="detail-value" id="total-municipios">11</div>
                <div class="detail-label">Total de Municípios</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="progress-card">
            <div class="detail-item">
                <div class="detail-value" id="municipios-completos">0</div>
                <div class="detail-label">Completos</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="progress-card">
            <div class="detail-item">
                <div class="detail-value" id="municipios-progresso">0</div>
                <div class="detail-label">Em Progresso</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="progress-card">
            <div class="detail-item">
                <div class="detail-value" id="progresso-geral">0%</div>
                <div class="detail-label">Progresso Geral</div>
            </div>
        </div>
    </div>
</div>

<!-- Cards de Prioridade P1/P2/P3 -->
<div class="row g-4 mt-4">
    <div class="col-12">
        <h5 class="text-light mb-3">
            <i class="fas fa-flag"></i> Entidades por Prioridade PNSB
        </h5>
    </div>
    <div class="col-md-4">
        <div class="priority-card" id="prioridade-p1">
            <div class="priority-header">
                <h6 class="priority-title">P1 - CRÍTICAS</h6>
                <div class="priority-badge bg-danger">Obrigatórias</div>
            </div>
            <div class="priority-content">
                <div class="priority-progress">
                    <div class="progress-value">0%</div>
                    <div class="progress-label">Concluídas</div>
                </div>
                <div class="priority-stats">
                    <div class="stat-item">
                        <span class="stat-value">0</span>
                        <span class="stat-label">Total</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">0</span>
                        <span class="stat-label">MRS</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">0</span>
                        <span class="stat-label">MAP</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="priority-card" id="prioridade-p2">
            <div class="priority-header">
                <h6 class="priority-title">P2 - IMPORTANTES</h6>
                <div class="priority-badge bg-warning text-dark">Campo</div>
            </div>
            <div class="priority-content">
                <div class="priority-progress">
                    <div class="progress-value">0%</div>
                    <div class="progress-label">Concluídas</div>
                </div>
                <div class="priority-stats">
                    <div class="stat-item">
                        <span class="stat-value">0</span>
                        <span class="stat-label">Total</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">0</span>
                        <span class="stat-label">MRS</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">0</span>
                        <span class="stat-label">MAP</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="priority-card" id="prioridade-p3">
            <div class="priority-header">
                <h6 class="priority-title">P3 - OPCIONAIS</h6>
                <div class="priority-badge bg-secondary">Referência</div>
            </div>
            <div class="priority-content">
                <div class="priority-progress">
                    <div class="progress-value">0%</div>
                    <div class="progress-label">Concluídas</div>
                </div>
                <div class="priority-stats">
                    <div class="stat-item">
                        <span class="stat-value">0</span>
                        <span class="stat-label">Total</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">0</span>
                        <span class="stat-label">MRS</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">0</span>
                        <span class="stat-label">MAP</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Relatório PNSB Simplificado -->
<div class="row g-4 mt-5 mb-4">
    <div class="col-12">
        <div class="simple-report">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="text-light mb-0">
                    <i class="fas fa-clipboard-list"></i> Relatório PNSB 2024 - Santa Catarina
                </h4>
                <div class="dashboard-controls">
                    <button class="btn btn-outline-light btn-sm" onclick="toggleDashboardView()">
                        <i class="fas fa-expand-arrows-alt"></i> <span id="dashboard-view-text">Expandir</span>
                    </button>
                    <button class="btn btn-outline-light btn-sm" onclick="exportarMapa()">
                        <i class="fas fa-file-export"></i> Exportar
                    </button>
                    <button class="btn btn-outline-light btn-sm" onclick="carregarDadosProgresso()">
                        <i class="fas fa-sync"></i> Atualizar
                    </button>
                </div>
            </div>
            
            <!-- KPIs Principais -->
            <div class="row g-3 mb-4">
                <div class="col-md-2">
                    <div class="kpi-card kpi-primary">
                        <div class="kpi-icon">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-value" id="kpi-progresso-total">0%</div>
                            <div class="kpi-label">Progresso Total</div>
                            <div class="kpi-trend" id="kpi-progresso-trend">+0%</div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-2">
                    <div class="kpi-card kpi-success">
                        <div class="kpi-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-value" id="kpi-conclusoes">0</div>
                            <div class="kpi-label">Conclusões</div>
                            <div class="kpi-trend" id="kpi-conclusoes-trend">+0</div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-2">
                    <div class="kpi-card kpi-warning">
                        <div class="kpi-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-value" id="kpi-dias-restantes">--</div>
                            <div class="kpi-label">Dias Restantes</div>
                            <div class="kpi-trend" id="kpi-dias-trend">--</div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-2">
                    <div class="kpi-card kpi-info">
                        <div class="kpi-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-value" id="kpi-pesquisadores">1</div>
                            <div class="kpi-label">Pesquisadores</div>
                            <div class="kpi-trend" id="kpi-pesquisadores-eficiencia">Carregando...</div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-2">
                    <div class="kpi-card kpi-danger">
                        <div class="kpi-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-value" id="kpi-alertas">0</div>
                            <div class="kpi-label">Alertas Ativos</div>
                            <div class="kpi-trend" id="kpi-alertas-trend">+0</div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-2">
                    <div class="kpi-card kpi-secondary">
                        <div class="kpi-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-value" id="kpi-performance">A</div>
                            <div class="kpi-label">Performance</div>
                            <div class="kpi-trend" id="kpi-performance-score">92%</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Gráficos e Métricas Avançadas -->
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="chart-container">
                        <h6 class="chart-title">
                            <i class="fas fa-chart-bar"></i> Progresso por Município
                        </h6>
                        <canvas id="progressChart" width="400" height="300"></canvas>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="chart-container">
                        <h6 class="chart-title">
                            <i class="fas fa-chart-line"></i> Tendência Temporal
                        </h6>
                        <canvas id="timelineChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Métricas Detalhadas -->
            <div class="row g-4 mt-3">
                <div class="col-md-4">
                    <div class="metrics-detailed">
                        <h6 class="metrics-title">
                            <i class="fas fa-tachometer-alt"></i> Indicadores de Velocidade
                        </h6>
                        <div class="metric-item">
                            <span class="metric-label">Municípios/Semana:</span>
                            <span class="metric-value" id="velocidade-municipios">1.8</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">Visitas/Dia:</span>
                            <span class="metric-value" id="velocidade-visitas">3.2</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">Taxa de Sucesso:</span>
                            <span class="metric-value" id="taxa-sucesso">78%</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">Tempo Médio/Município:</span>
                            <span class="metric-value" id="tempo-medio">4.2 dias</span>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="metrics-detailed">
                        <h6 class="metrics-title">
                            <i class="fas fa-chart-pie"></i> Distribuição de Status
                        </h6>
                        <div class="status-distribution">
                            <div class="status-item">
                                <div class="status-bar">
                                    <div class="status-fill status-completed" id="bar-completed" style="width: 0%"></div>
                                </div>
                                <span class="status-label">Completos</span>
                                <span class="status-percent" id="percent-completed">0%</span>
                            </div>
                            <div class="status-item">
                                <div class="status-bar">
                                    <div class="status-fill status-progress" id="bar-progress" style="width: 0%"></div>
                                </div>
                                <span class="status-label">Em Progresso</span>
                                <span class="status-percent" id="percent-progress">0%</span>
                            </div>
                            <div class="status-item">
                                <div class="status-bar">
                                    <div class="status-fill status-pending" id="bar-pending" style="width: 0%"></div>
                                </div>
                                <span class="status-label">Pendentes</span>
                                <span class="status-percent" id="percent-pending">0%</span>
                            </div>
                            <div class="status-item">
                                <div class="status-bar">
                                    <div class="status-fill status-blocked" id="bar-blocked" style="width: 0%"></div>
                                </div>
                                <span class="status-label">Bloqueados</span>
                                <span class="status-percent" id="percent-blocked">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="metrics-detailed">
                        <h6 class="metrics-title">
                            <i class="fas fa-bullseye"></i> Metas e Objetivos
                        </h6>
                        <div class="goal-item">
                            <div class="goal-header">
                                <span class="goal-title">Meta Mensal</span>
                                <span class="goal-percentage" id="meta-mensal">0%</span>
                            </div>
                            <div class="goal-progress">
                                <div class="goal-bar">
                                    <div class="goal-fill" id="meta-mensal-bar" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="goal-details" id="meta-mensal-detalhes">0/0 municípios</div>
                        </div>
                        
                        <div class="goal-item">
                            <div class="goal-header">
                                <span class="goal-title">Meta Trimestral</span>
                                <span class="goal-percentage" id="meta-trimestral">0%</span>
                            </div>
                            <div class="goal-progress">
                                <div class="goal-bar">
                                    <div class="goal-fill" id="meta-trimestral-bar" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="goal-details" id="meta-trimestral-detalhes">0/0 municípios</div>
                        </div>
                        
                        <div class="goal-item">
                            <div class="goal-header">
                                <span class="goal-title">Meta Projeto</span>
                                <span class="goal-percentage" id="meta-projeto">0%</span>
                            </div>
                            <div class="goal-progress">
                                <div class="goal-bar">
                                    <div class="goal-fill" id="meta-projeto-bar" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="goal-details" id="meta-projeto-detalhes">0/11 municípios</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Alertas e Recomendações Executivas -->
            <div class="row g-4 mt-3">
                <div class="col-md-6">
                    <div class="executive-alerts">
                        <h6 class="alerts-title">
                            <i class="fas fa-bell"></i> Alertas Executivos
                        </h6>
                        <div class="alerts-list" id="executive-alerts-list">
                            <!-- Será populado dinamicamente -->
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="executive-recommendations">
                        <h6 class="recommendations-title">
                            <i class="fas fa-lightbulb"></i> Recomendações Estratégicas
                        </h6>
                        <div class="recommendations-list" id="executive-recommendations-list">
                            <!-- Será populado dinamicamente -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- PNSB 2024 - Sistema Simplificado para 11 Municípios de Santa Catarina -->

<!-- Sistema de Alertas Inteligentes -->
<div class="intelligent-alerts-system" id="alerts-system">
    <!-- Painel de Notificações -->
    <div class="notifications-panel" id="notifications-panel">
        <div class="panel-header">
            <h6><i class="fas fa-bell"></i> Alertas Ativos</h6>
            <div class="panel-controls">
                <button class="btn-mini" onclick="markAllAsRead()" title="Marcar todas como lidas">
                    <i class="fas fa-check-double"></i>
                </button>
                <button class="btn-mini" onclick="toggleNotificationsPanel()" title="Minimizar">
                    <i class="fas fa-minus"></i>
                </button>
            </div>
        </div>
        <div class="notifications-list" id="notifications-list">
            <!-- Notificações serão inseridas aqui -->
        </div>
        <div class="panel-footer">
            <button class="btn btn-sm btn-outline-light w-100" onclick="configureAlerts()">
                <i class="fas fa-cog"></i> Configurar Alertas
            </button>
        </div>
    </div>
    
    <!-- Botão Flutuante de Alertas -->
    <div class="alerts-floating-button" id="alerts-floating-btn" onclick="toggleNotificationsPanel()">
        <i class="fas fa-bell"></i>
        <span class="alert-count" id="alert-count">0</span>
        <div class="pulse-ring"></div>
    </div>
</div>

<!-- Modal de Configuração de Alertas -->
<div class="modal fade" id="alertsConfigModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-light">
                    <i class="fas fa-cog"></i> Configuração de Alertas Inteligentes
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Configurações de Alertas -->
                <div class="alert-config-section">
                    <h6 class="text-light mb-3">
                        <i class="fas fa-exclamation-triangle"></i> Alertas de Progresso
                    </h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="alert-slow-progress" checked>
                                <label class="form-check-label text-light" for="alert-slow-progress">
                                    Progresso Lento (< 2% por dia)
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="alert-stalled-municipalities" checked>
                                <label class="form-check-label text-light" for="alert-stalled-municipalities">
                                    Municípios Parados (> 7 dias sem atividade)
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="alert-deadline-risk" checked>
                                <label class="form-check-label text-light" for="alert-deadline-risk">
                                    Risco de Prazo (atraso > 10%)
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="alert-low-performance" checked>
                                <label class="form-check-label text-light" for="alert-low-performance">
                                    Performance Baixa (Score < 70%)
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <hr class="border-secondary my-4">
                
                <div class="alert-config-section">
                    <h6 class="text-light mb-3">
                        <i class="fas fa-chart-line"></i> Alertas de Tendências
                    </h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="alert-negative-trend" checked>
                                <label class="form-check-label text-light" for="alert-negative-trend">
                                    Tendência Negativa (3 dias consecutivos)
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="alert-resource-overload" checked>
                                <label class="form-check-label text-light" for="alert-resource-overload">
                                    Sobrecarga de Recursos (> 80% capacidade)
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="alert-quality-issues">
                                <label class="form-check-label text-light" for="alert-quality-issues">
                                    Problemas de Qualidade (retrabalho > 15%)
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="alert-milestone-approaching" checked>
                                <label class="form-check-label text-light" for="alert-milestone-approaching">
                                    Marco Próximo (< 5 dias)
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <hr class="border-secondary my-4">
                
                <div class="alert-config-section">
                    <h6 class="text-light mb-3">
                        <i class="fas fa-clock"></i> Frequência de Verificação
                    </h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label text-light">Verificação Automática:</label>
                            <select class="form-select bg-dark text-light" id="alert-frequency">
                                <option value="5">A cada 5 minutos</option>
                                <option value="15" selected>A cada 15 minutos</option>
                                <option value="30">A cada 30 minutos</option>
                                <option value="60">A cada 1 hora</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-light">Prioridade Mínima:</label>
                            <select class="form-select bg-dark text-light" id="min-priority">
                                <option value="low">Baixa</option>
                                <option value="medium" selected>Média</option>
                                <option value="high">Alta</option>
                                <option value="critical">Crítica</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-light">Som de Notificação:</label>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="enable-sound" checked>
                                <label class="form-check-label text-light" for="enable-sound">
                                    Ativar Som
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <hr class="border-secondary my-4">
                
                <div class="alert-config-section">
                    <h6 class="text-light mb-3">
                        <i class="fas fa-envelope"></i> Canais de Notificação
                    </h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="notify-browser" checked>
                                <label class="form-check-label text-light" for="notify-browser">
                                    Notificações do Navegador
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="notify-email">
                                <label class="form-check-label text-light" for="notify-email">
                                    E-mail (funcionalidade futura)
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="notify-slack">
                                <label class="form-check-label text-light" for="notify-slack">
                                    Slack (funcionalidade futura)
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="notify-whatsapp">
                                <label class="form-check-label text-light" for="notify-whatsapp">
                                    WhatsApp (funcionalidade futura)
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveAlertsConfig()">
                    <i class="fas fa-save"></i> Salvar Configurações
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ====================================
// SISTEMA PNSB 2024 - VERSÃO SIMPLIFICADA
// Foco: 11 Municípios de Santa Catarina
// ====================================

// Variáveis essenciais
let mapa;
let dadosProgresso = {};
let marcadores = {};
let currentView = 'map';
let entidadesIdentificadas = []; // Inicializar como array vazio

// Configuração básica
const API_ENDPOINTS = {
    PROGRESSO_MAPA: '/api/visitas/progresso-mapa',
    DASHBOARD_INTELIGENTE: '/api/visitas/dashboard-inteligente',
    STATUS_INTELIGENTE: '/api/visitas/{id}/status-inteligente',
    QUESTIONARIOS_OBRIGATORIOS: '/api/questionarios/questionarios-obrigatorios',
    ENTIDADES_IDENTIFICADAS: '/api/questionarios/entidades-identificadas',
    // NOVO: Endpoints de visitas obrigatórias
    VISITAS_OBRIGATORIAS: '/api/visitas-obrigatorias/visitas-obrigatorias',
    STATUS_VISITAS_OBRIGATORIAS: '/api/visitas-obrigatorias/status-visitas-obrigatorias',
    DASHBOARD_INTEGRADO: '/api/visitas-obrigatorias/dashboard-integrado/{municipio}'
};

// Municípios PNSB 2024 - Santa Catarina
const MUNICIPIOS_PNSB = [
    'Balneário Camboriú', 'Balneário Piçarras', 'Bombinhas', 
    'Camboriú', 'Itajaí', 'Itapema', 'Luiz Alves', 
    'Navegantes', 'Penha', 'Porto Belo', 'Ilhota'
];

// Sistema de vistas - mapa e lista apenas

// Carregar configurações da equipe
async function carregarConfiguracaoEquipe() {
    try {
        console.log('🔧 Carregando configuração da equipe...');
        
        const response = await fetch(`/api/team-config?t=${Date.now()}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Cache-Control': 'no-cache',
                'Pragma': 'no-cache'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Status ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('📊 Resposta da API team-config:', data);
        
        if (data.success && data.data) {
            const config = data.data;
            console.log('✅ Configuração da equipe carregada:', config);
            
            // Atualizar KPIs da equipe
            const kpiPesquisadores = document.getElementById('kpi-pesquisadores');
            if (kpiPesquisadores) {
                kpiPesquisadores.textContent = config.num_pesquisadores;
            }
            
            const kpiEficiencia = document.getElementById('kpi-pesquisadores-eficiencia');
            if (kpiEficiencia) {
                kpiEficiencia.textContent = '85%'; // TODO: calcular dinamicamente
            }
            
            // Atualizar informações de capacidade globalmente
            window.TEAM_CONFIG = config;
            
            return config;
        } else {
            throw new Error(data.error || 'Erro ao carregar configuração da equipe');
        }
    } catch (error) {
        console.error('❌ Erro ao carregar configuração da equipe:', error);
        // Fallback para valores padrão
        window.TEAM_CONFIG = {
            num_pesquisadores: 1,
            visitas_max_dia: 8,
            capacidade_total_dia: 8,
            horario_inicio: '08:00',
            horario_fim: '18:00'
        };
        return window.TEAM_CONFIG;
    }
}

// Calcular métricas baseadas na configuração da equipe
function calcularMetricasCapacidade() {
    const config = window.TEAM_CONFIG;
    if (!config) return null;
    
    const hoje = new Date();
    const deadlineVisitas = new Date(2025, 8, 19); // 19/09/2025 (mês é 0-indexado)
    const deadlineQuestionarios = new Date(2025, 9, 17); // 17/10/2025
    
    const diasRestantesVisitas = Math.ceil((deadlineVisitas - hoje) / (1000 * 60 * 60 * 24));
    const diasRestantesQuestionarios = Math.ceil((deadlineQuestionarios - hoje) / (1000 * 60 * 60 * 24));
    
    // Calcular dias úteis (5 dias por semana)
    const diasUteisVisitas = Math.floor(diasRestantesVisitas * (5/7));
    
    // Capacidade total restante
    const capacidadeTotal = diasUteisVisitas * config.capacidade_total_dia;
    
    return {
        diasRestantesVisitas,
        diasRestantesQuestionarios,
        diasUteisVisitas,
        capacidadeTotal,
        capacidadeDiaria: config.capacidade_total_dia,
        pesquisadores: config.num_pesquisadores,
        alertaCritico: diasRestantesVisitas <= 30,
        alertaUrgente: diasRestantesVisitas <= 60
    };
}

// Atualizar elementos da interface com métricas dinâmicas
function atualizarMetricasInterface() {
    const metricas = calcularMetricasCapacidade();
    if (!metricas) return;
    
    // Atualizar KPIs se existirem
    const elementos = {
        'kpi-dias-restantes': metricas.diasRestantesVisitas,
        'kpi-capacidade-total': metricas.capacidadeTotal,
        'kpi-capacidade-diaria': metricas.capacidadeDiaria
    };
    
    Object.entries(elementos).forEach(([id, valor]) => {
        const elemento = document.getElementById(id);
        if (elemento) {
            elemento.textContent = valor;
        }
    });
    
    // Atualizar indicadores de alerta
    if (metricas.alertaCritico) {
        console.warn(`🚨 CRÍTICO: Apenas ${metricas.diasRestantesVisitas} dias restantes para deadline das visitas!`);
    } else if (metricas.alertaUrgente) {
        console.warn(`⚠️ URGENTE: ${metricas.diasRestantesVisitas} dias restantes para deadline das visitas`);
    }
    
    console.log('📊 Métricas de capacidade atualizadas:', metricas);
}

// Inicialização do sistema
async function inicializarSistemaPNSB() {
    console.log('🏛️ Inicializando Sistema PNSB 2024 - Santa Catarina');
    
    inicializarMapa();
    
    // Carregar configuração da equipe primeiro
    await carregarConfiguracaoEquipe();
    
    // Atualizar métricas baseadas na configuração carregada
    atualizarMetricasInterface();
    
    // Inicializar dashboard e aguardar conclusão
    await initializeDashboardAndWait();
    
    // Agora carregar dados com dashboard disponível
    carregarDadosProgresso();
    carregarQuestionariosObrigatorios();
    carregarEntidadesIdentificadas();
    atualizarEstatisticas();
    
    // Atualizar KPIs do relatório após todos os dados serem carregados
    setTimeout(() => {
        atualizarKPIsRelatorio();
    }, 1000);
    
    // Essas funções podem ser chamadas imediatamente
    popularGridMunicipios();
    inicializarFiltros();
}

// Nova função para garantir que o dashboard seja inicializado
async function initializeDashboardAndWait() {
    return new Promise((resolve) => {
        let tentativas = 0;
        const maxTentativas = 50; // máximo 10 segundos (50 * 200ms)
        
        function checkAndInit() {
            tentativas++;
            console.log(`🔍 Verificando disponibilidade do dashboard (tentativa ${tentativas}/${maxTentativas})...`);
            
            // Se já existe, resolver imediatamente
            if (window.dashboardPNSB) {
                console.log('✅ Dashboard já disponível');
                resolve();
                return;
            }
            
            // Verificar se os elementos necessários existem
            if (shouldInitDashboard()) {
                console.log('🎯 Elementos encontrados, tentando inicializar dashboard...');
                
                // Tentar inicializar
                if (typeof initDashboard === 'function') {
                    initDashboard();
                }
                
                // Dar um tempo para a inicialização
                setTimeout(() => {
                    if (window.dashboardPNSB) {
                        console.log('✅ Dashboard inicializado com sucesso');
                        resolve();
                    } else if (tentativas >= maxTentativas) {
                        console.warn('⚠️ Dashboard não foi inicializado após múltiplas tentativas, continuando...');
                        resolve(); // Resolver mesmo assim para não travar o sistema
                    } else {
                        checkAndInit(); // Tentar novamente
                    }
                }, 100);
            } else {
                // Elementos ainda não existem
                if (tentativas >= maxTentativas) {
                    console.warn('⚠️ Elementos do dashboard não encontrados após múltiplas tentativas, continuando...');
                    resolve(); // Resolver mesmo assim para não travar o sistema
                } else {
                    console.log('⏳ Elementos ainda não disponíveis, tentando novamente...');
                    setTimeout(checkAndInit, 200);
                }
            }
        }
        
        checkAndInit();
    });
}

// Popular grid de municípios para seleção de rotas
function popularGridMunicipios() {
    const grid = document.getElementById('municipalities-grid');
    if (!grid) return;
    
    const html = MUNICIPIOS_PNSB.map(municipio => `
        <div class="municipality-item">
            <label class="municipality-checkbox">
                <input type="checkbox" value="${municipio}">
                <span class="checkmark"></span>
                <span class="municipality-name">${municipio}</span>
            </label>
        </div>
    `).join('');
    
    // Security: Clear content first, then add elements safely
    grid.innerHTML = '';
    if (html.trim()) {
        const div = document.createElement('div');
        div.innerHTML = html;
        while (div.firstChild) {
            grid.appendChild(div.firstChild);
        }
    }
}

// Inicialização do mapa
function inicializarMapa() {
    try {
        // Coordenadas do centro de Santa Catarina
        mapa = L.map('mapa-progresso').setView([-26.9194, -49.0661], 9);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(mapa);
        
        console.log('✅ Mapa inicializado');
    } catch (error) {
        console.error('❌ Erro ao inicializar mapa:', error);
    }
}

// Carregar dados de progresso
async function carregarDadosProgresso() {
    // Mostrar indicador de carregamento
    mostrarIndicadorCarregamento(true);
    
    try {
        console.log('🔄 Carregando dados de progresso...');
        
        // Define headers outside of blocks so they can be reused
        const headers = {
            'Content-Type': 'application/json'
        };
        
        // Add CSRF token if available
        if (window.CSRF_TOKEN) {
            headers['X-CSRFToken'] = window.CSRF_TOKEN;
        }
        
        // Carregar dados básicos primeiro
        if (API_ENDPOINTS && API_ENDPOINTS.PROGRESSO_MAPA) {
            
            const responseBasico = await fetch(API_ENDPOINTS.PROGRESSO_MAPA, {
                method: 'GET',
                headers: headers,
                credentials: 'same-origin' // Include cookies for authentication
            });
            
            if (responseBasico.ok) {
                const resposta = await responseBasico.json();
                console.log('✅ Resposta da API recebida:', resposta);
                
                // Processar dados da API para estrutura esperada
                if (resposta.success && resposta.data) {
                    dadosProgresso = {
                        municipios: {},
                        estatisticas: resposta.estatisticas || {},
                        ultima_atualizacao: resposta.ultima_atualizacao
                    };
                    
                    // Converter array de municípios em objeto indexado
                    resposta.data.forEach(municipioData => {
                        dadosProgresso.municipios[municipioData.municipio] = municipioData;
                    });
                    
                    console.log('✅ Dados processados:', dadosProgresso);
                } else {
                    console.warn('⚠️ Resposta da API sem dados válidos');
                    dadosProgresso = gerarDadosExemplo();
                }
            } else {
                console.warn('⚠️ Falha ao carregar dados básicos, usando dados de exemplo');
                dadosProgresso = gerarDadosExemplo();
            }
        } else {
            console.warn('⚠️ API_ENDPOINTS não definido, usando dados de exemplo');
            dadosProgresso = gerarDadosExemplo();
        }
        
        // Carregar dados inteligentes
        if (API_ENDPOINTS && API_ENDPOINTS.DASHBOARD_INTELIGENTE) {
            const responseInteligente = await fetch(API_ENDPOINTS.DASHBOARD_INTELIGENTE, {
                method: 'GET',
                headers: headers,
                credentials: 'same-origin'
            });
            
            if (responseInteligente.ok) {
                const dadosInteligentes = await responseInteligente.json();
                console.log('✅ Dados inteligentes carregados:', dadosInteligentes);
                
                // Integrar dados inteligentes com os dados básicos
            dadosProgresso.estatisticas_inteligentes = dadosInteligentes.estatisticas;
            dadosProgresso.timestamp_inteligente = dadosInteligentes.timestamp;
            
            // NOVO: Integrar dados de visitas obrigatórias
            if (dadosInteligentes.visitas_obrigatorias) {
                dadosProgresso.visitas_obrigatorias = dadosInteligentes.visitas_obrigatorias;
                console.log('✅ Dados de visitas obrigatórias integrados');
            }
            
            console.log('✅ Dados inteligentes carregados');
        }
        }
        
        // NOVO: Carregar status consolidado de visitas obrigatórias
        try {
            const responseVisitasObrigatorias = await fetch(API_ENDPOINTS.STATUS_VISITAS_OBRIGATORIAS);
            if (responseVisitasObrigatorias.ok) {
                const statusVisitasObrigatorias = await responseVisitasObrigatorias.json();
                dadosProgresso.status_visitas_obrigatorias = statusVisitasObrigatorias;
                console.log('✅ Status de visitas obrigatórias carregado');
            }
        } catch (error) {
            console.warn('⚠️ Erro ao carregar status de visitas obrigatórias:', error);
        }
        
        // Carregar dados detalhados de visitas individuais
        await carregarDadosVisitasIndividuais();
        
        // Debug: verificar estrutura final dos dados
        console.log('🔍 Estrutura final dadosProgresso:', dadosProgresso);
        console.log('🔍 Municípios carregados:', Object.keys(dadosProgresso.municipios || {}));
        
        atualizarMapa();
        atualizarEstatisticas();
        
        // Atualizar KPIs essenciais da sidebar com dados reais
        updateEssentialKPIs();
        
        // Após carregar dados básicos, atualizar com P1/P2/P3
        if (typeof atualizarVisualizacaoP123 === 'function') {
            await atualizarVisualizacaoP123();
        }
        
        console.log('✅ Dados carregados com sucesso!');
        console.log('🎯 Verificação final: mapa=', !!mapa, ', dadosProgresso=', !!dadosProgresso);
        
        // Garantir que o status dos municípios seja atualizado
        if (window.dashboardPNSB && typeof window.dashboardPNSB.atualizarStatusMunicipios === 'function') {
            console.log('📋 Atualizando status dos municípios...');
            window.dashboardPNSB.atualizarStatusMunicipios();
        } else {
            console.warn('⚠️ Dashboard PNSB não disponível durante carregamento de dados');
            console.warn('ℹ️ Isso é normal se o dashboard ainda estiver sendo inicializado');
            
            // Fallback: tentar novamente em intervalos até conseguir
            let tentativas = 0;
            const maxTentativas = 20; // máximo 4 segundos (20 * 200ms)
            
            const intervalo = setInterval(() => {
                tentativas++;
                
                if (window.dashboardPNSB && typeof window.dashboardPNSB.atualizarStatusMunicipios === 'function') {
                    console.log('✅ Dashboard disponível, atualizando status dos municípios...');
                    
                    // Forçar chamada múltipla para garantir execução
                    window.dashboardPNSB.atualizarStatusMunicipios();
                    
                    // Verificar se realmente atualizou
                    setTimeout(() => {
                        const container = document.getElementById('municipiosStatus');
                        if (container && container.innerHTML.trim() === '') {
                            console.warn('⚠️ Container ainda vazio, tentando novamente...');
                            window.dashboardPNSB.atualizarStatusMunicipios();
                        }
                    }, 500);
                    
                    clearInterval(intervalo);
                } else if (tentativas >= maxTentativas) {
                    console.error('❌ Dashboard não ficou disponível após múltiplas tentativas');
                    
                    // Último recurso: mostrar dados básicos sem dashboard
                    const container = document.getElementById('municipiosStatus');
                    if (container) {
                        container.innerHTML = `
                            <div style="padding: 20px; text-align: center; color: #ffc107;">
                                <i class="fas fa-exclamation-triangle"></i>
                                <div>Dashboard não disponível</div>
                                <div style="font-size: 11px;">Dados não puderam ser carregados</div>
                            </div>
                        `;
                    }
                    clearInterval(intervalo);
                } else {
                    console.log(`⏳ Tentativa ${tentativas}/${maxTentativas} - aguardando dashboard...`);
                }
            }, 200);
        }
    } catch (error) {
        console.error('❌ Erro ao carregar dados:', error);
        // Dados de exemplo para desenvolvimento
        dadosProgresso = {
            municipios: {},
            estatisticas: {
                total: 11,
                finalizados: 0,
                progresso: 0
            },
            estatisticas_inteligentes: {
                total_visitas: 0,
                por_status: {},
                por_status_inteligente: {},
                progresso_medio: 0,
                questionnaire_completion: {
                    mrs: { respondido: 0, validado: 0 },
                    map: { respondido: 0, validado: 0 }
                },
                checklist_progress: {
                    preparacao: 0,
                    execucao: 0,
                    finalizacao: 0
                },
                proximas_acoes: {}
            }
        };
        
        // Mesmo com dados de exemplo, atualizar P1/P2/P3
        if (typeof atualizarVisualizacaoP123 === 'function') {
            await atualizarVisualizacaoP123();
        }
    } finally {
        // Ocultar indicador de carregamento
        mostrarIndicadorCarregamento(false);
    }
}

// Mostrar/ocultar indicador de carregamento
function mostrarIndicadorCarregamento(mostrar) {
    console.log(mostrar ? '⏳ Mostrando indicador de carregamento' : '✅ Ocultando indicador de carregamento');
    
    const indicadores = document.querySelectorAll('.loading-indicator');
    indicadores.forEach(indicador => {
        indicador.style.display = mostrar ? 'flex' : 'none';
    });
    
    // Mostrar/ocultar conteúdo principal
    const containers = document.querySelectorAll('#map-container, #list-view, .progress-card');
    containers.forEach(container => {
        if (container) {
            if (mostrar) {
                container.style.opacity = '0.5';
                container.style.pointerEvents = 'none';
            } else {
                container.style.opacity = '1';
                container.style.pointerEvents = 'auto';
            }
        }
    });
    
    // Update status badge
    const statusBadge = document.getElementById('status-atualizacao');
    if (statusBadge) {
        if (mostrar) {
            statusBadge.textContent = 'Carregando...';
            statusBadge.className = 'badge bg-warning';
        } else {
            statusBadge.textContent = `Atualizado: ${new Date().toLocaleTimeString()}`;
            statusBadge.className = 'badge bg-info';
        }
    }
}

// Carregar dados detalhados de visitas individuais
async function carregarDadosVisitasIndividuais() {
    try {
        // Primeiro obter todas as visitas
        const responseVisitas = await fetch('/api/visitas');
        if (!responseVisitas.ok) {
            console.warn('⚠️ Não foi possível carregar visitas, usando dados em cache');
            return;
        }
        
        const visitas = await responseVisitas.json();
        
        // Limitar número de requisições simultâneas para evitar sobrecarga
        const BATCH_SIZE = 5;
        const statusResults = [];
        
        for (let i = 0; i < visitas.length; i += BATCH_SIZE) {
            const batch = visitas.slice(i, i + BATCH_SIZE);
            
            const batchPromises = batch.map(async (visita) => {
                try {
                    const statusUrl = API_ENDPOINTS.STATUS_INTELIGENTE.replace('{id}', visita.id);
                    const statusResponse = await fetch(statusUrl);
                    if (statusResponse.ok) {
                        return await statusResponse.json();
                    }
                } catch (error) {
                    console.warn(`Erro ao carregar status inteligente da visita ${visita.id}:`, error);
                }
                return null;
            });
            
            const batchResults = await Promise.all(batchPromises);
            statusResults.push(...batchResults);
        }
        
        // Organizar dados por município
        if (!dadosProgresso.visitas_detalhadas) {
            dadosProgresso.visitas_detalhadas = {};
        }
        
        statusResults.forEach((statusData, index) => {
            if (statusData) {
                const municipio = statusData.municipio;
                if (!dadosProgresso.visitas_detalhadas[municipio]) {
                    dadosProgresso.visitas_detalhadas[municipio] = [];
                }
                dadosProgresso.visitas_detalhadas[municipio].push(statusData);
            }
        });
        
        console.log(`✅ Dados detalhados de visitas carregados (${statusResults.filter(r => r !== null).length}/${visitas.length})`);
    } catch (error) {
        console.error('❌ Erro ao carregar dados detalhados de visitas:', error);
        // Garantir que a estrutura existe mesmo com erro
        if (!dadosProgresso.visitas_detalhadas) {
            dadosProgresso.visitas_detalhadas = {};
        }
    }
}

// Obter dados inteligentes consolidados para um município
function obterDadosInteligentes(municipio) {
    const visitasDoMunicipio = dadosProgresso.visitas_detalhadas?.[municipio] || [];
    
    if (visitasDoMunicipio.length === 0) {
        return {
            status_inteligente: 'aguardando-agendamento',
            progresso_checklist: { preparacao: 0, execucao: 0, finalizacao: 0 },
            status_questionarios: { mrs: { respondido: 0, validado: 0 }, map: { respondido: 0, validado: 0 } },
            proximas_acoes: 'Agendar primeira visita',
            total_visitas: 0
        };
    }
    
    // Calcular estatísticas consolidadas
    let totalPreparacao = 0, totalExecucao = 0, totalFinalizacao = 0;
    let totalMrsRespondido = 0, totalMrsValidado = 0;
    let totalMapRespondido = 0, totalMapValidado = 0;
    let proximasAcoes = new Set();
    
    // Status inteligente mais avançado
    const statusPrioridade = {
        'aguardando-agendamento': 0,
        'em-preparacao': 1,
        'pronto-para-visita': 2,
        'visita-realizada': 3,
        'questionarios-respondidos': 4,
        'questionarios-validados': 5,
        'processo-finalizado': 6
    };
    
    let statusMaisAvancado = 'aguardando-agendamento';
    
    visitasDoMunicipio.forEach(visita => {
        // Status inteligente mais avançado
        if (statusPrioridade[visita.status_inteligente] > statusPrioridade[statusMaisAvancado]) {
            statusMaisAvancado = visita.status_inteligente;
        }
        
        // Progresso checklist
        totalPreparacao += visita.progresso_checklist.preparacao || 0;
        totalExecucao += visita.progresso_checklist.execucao || 0;
        totalFinalizacao += visita.progresso_checklist.finalizacao || 0;
        
        // Status questionários
        totalMrsRespondido += visita.status_questionarios.mrs.respondido ? 1 : 0;
        totalMrsValidado += visita.status_questionarios.mrs.validado_concluido ? 1 : 0;
        totalMapRespondido += visita.status_questionarios.map.respondido ? 1 : 0;
        totalMapValidado += visita.status_questionarios.map.validado_concluido ? 1 : 0;
        
        // Próximas ações
        proximasAcoes.add(visita.proxima_acao);
    });
    
    const totalVisitas = visitasDoMunicipio.length;
    
    return {
        status_inteligente: statusMaisAvancado,
        progresso_checklist: {
            preparacao: Math.round(totalPreparacao / totalVisitas),
            execucao: Math.round(totalExecucao / totalVisitas),
            finalizacao: Math.round(totalFinalizacao / totalVisitas)
        },
        status_questionarios: {
            mrs: { respondido: totalMrsRespondido, validado: totalMrsValidado },
            map: { respondido: totalMapRespondido, validado: totalMapValidado }
        },
        proximas_acoes: Array.from(proximasAcoes).join(', '),
        total_visitas: totalVisitas
    };
}

// Gerar HTML para status inteligente
function gerarHtmlStatusInteligente(dadosInteligentes) {
    try {
        const statusClass = (dadosInteligentes.status_inteligente || 'aguardando-agendamento').replace(/\s+/g, '-').toLowerCase();
        const statusLabel = (dadosInteligentes.status_inteligente || 'aguardando-agendamento').replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        
        const mrsStatus = dadosInteligentes.status_questionarios?.mrs || { respondido: 0, validado: 0 };
        const mapStatus = dadosInteligentes.status_questionarios?.map || { respondido: 0, validado: 0 };
        const checklistStatus = dadosInteligentes.progresso_checklist || { preparacao: 0, execucao: 0, finalizacao: 0 };
        
        return `
            <div class="intelligent-status">
                <span class="intelligent-status-badge ${statusClass}">
                    ${statusLabel}
                </span>
            </div>
            <div class="questionnaire-status">
                <div class="questionnaire-item">
                    <div class="questionnaire-type">MRS</div>
                    <div class="questionnaire-progress">
                        <span class="responded">${mrsStatus.respondido}</span>
                        <span class="validated">${mrsStatus.validado}</span>
                    </div>
                </div>
                <div class="questionnaire-item">
                    <div class="questionnaire-type">MAP</div>
                    <div class="questionnaire-progress">
                        <span class="responded">${mapStatus.respondido}</span>
                        <span class="validated">${mapStatus.validado}</span>
                    </div>
                </div>
            </div>
            <div class="checklist-progress">
                <div class="checklist-phase">
                    <div class="checklist-phase-title">Prep</div>
                    <div class="checklist-phase-value">${checklistStatus.preparacao}%</div>
                </div>
                <div class="checklist-phase">
                    <div class="checklist-phase-title">Exec</div>
                    <div class="checklist-phase-value">${checklistStatus.execucao}%</div>
                </div>
                <div class="checklist-phase">
                    <div class="checklist-phase-title">Fin</div>
                    <div class="checklist-phase-value">${checklistStatus.finalizacao}%</div>
                </div>
            </div>
            <div class="next-action">
                <div class="next-action-title">Próxima Ação</div>
                <div class="next-action-text">${dadosInteligentes.proximas_acoes || 'Nenhuma ação definida'}</div>
            </div>
        `;
    } catch (error) {
        console.error('Erro ao gerar HTML status inteligente:', error);
        return '<div class="error-message">Erro ao carregar status inteligente</div>';
    }
}

// Carregar questionários obrigatórios por município
async function carregarQuestionariosObrigatorios() {
    try {
        const response = await fetch('/api/questionarios/entidades-por-municipio');
        if (response.ok) {
            const data = await response.json();
            // Disponibilizar globalmente para integração
            window.entidadesQuestionarios = data;
            console.log('✅ Questionários obrigatórios carregados');
        } else {
            console.warn('⚠️ API de questionários não disponível, usando dados locais');
            window.entidadesQuestionarios = {};
        }
    } catch (error) {
        console.warn('⚠️ Erro ao carregar questionários obrigatórios:', error);
        window.entidadesQuestionarios = {};
    }
}

// Carregar entidades identificadas (dados base)
async function carregarEntidadesIdentificadas() {
    try {
        const response = await fetch('/api/questionarios/entidades-identificadas');
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                entidadesIdentificadas = data.entidades || [];
                console.log('✅ Entidades identificadas carregadas:', entidadesIdentificadas.length);
            } else {
                entidadesIdentificadas = [];
            }
        } else {
            console.warn('⚠️ API de entidades não disponível, usando dados de exemplo');
            carregarDadosExemplo();
        }
    } catch (error) {
        console.warn('⚠️ Erro ao carregar entidades identificadas, usando dados de exemplo:', error);
        carregarDadosExemplo();
    }
}

// ===== DEVELOPMENT ONLY - Remove in production =====
function carregarDadosExemplo() {
    entidadesIdentificadas = [
        {
            municipio: 'Itajaí',
            categoria_prioridade: 'p1',
            mrs_obrigatorio: true,
            map_obrigatorio: true,
            status_mrs: 'nao_iniciado',
            status_map: 'nao_iniciado',
            nome_entidade: 'Prefeitura de Itajaí'
        },
        {
            municipio: 'Balneário Camboriú',
            categoria_prioridade: 'p1',
            mrs_obrigatorio: true,
            map_obrigatorio: true,
            status_mrs: 'validado_concluido',
            status_map: 'respondido',
            nome_entidade: 'Prefeitura de Balneário Camboriú'
        },
        {
            municipio: 'Navegantes',
            categoria_prioridade: 'p2',
            mrs_obrigatorio: true,
            map_obrigatorio: false,
            status_mrs: 'respondido',
            status_map: 'nao_aplicavel',
            nome_entidade: 'Empresa de Coleta Norte'
        },
        {
            municipio: 'Bombinhas',
            categoria_prioridade: 'p3',
            mrs_obrigatorio: false,
            map_obrigatorio: true,
            status_mrs: 'nao_aplicavel',
            status_map: 'nao_iniciado',
            nome_entidade: 'Cooperativa Local'
        }
    ];
    console.log('✅ Dados de exemplo carregados:', entidadesIdentificadas.length);
}

// Atualizar mapa com marcadores
function atualizarMapa() {
    console.log('🗺️ atualizarMapa() iniciada');
    console.log('🗺️ mapa disponível:', !!mapa);
    console.log('🗺️ dadosProgresso disponível:', !!dadosProgresso);
    console.log('🗺️ dadosProgresso.municipios:', dadosProgresso?.municipios ? Object.keys(dadosProgresso.municipios) : 'undefined');
    
    if (!mapa) {
        console.warn('❌ Mapa não disponível');
        return;
    }
    
    // Limpar marcadores existentes
    Object.values(marcadores).forEach(marker => mapa.removeLayer(marker));
    marcadores = {};
    
    let marcadoresAdicionados = 0;
    
    // Adicionar marcadores para cada município
    MUNICIPIOS_PNSB.forEach(municipio => {
        const dados = dadosProgresso.municipios?.[municipio];
        console.log(`🔍 ${municipio}:`, dados ? 'dados encontrados' : 'SEM dados', dados?.coords ? 'coords OK' : 'SEM coords');
        
        // API retorna coordenadas no campo 'coords' como array [lat, lng]
        if (dados?.coords && Array.isArray(dados.coords) && dados.coords.length === 2) {
            console.log(`✅ Adicionando marcador para ${municipio} em`, dados.coords);
            marcadoresAdicionados++;
            const dadosInteligentes = obterDadosInteligentes(municipio);
            
            // Criar popup com informações inteligentes
            const popupContent = `
                <div class="popup-content">
                    <h6 class="popup-title">${municipio}</h6>
                    <div class="popup-section">
                        <div class="popup-detail">
                            <strong>Status Atual:</strong> ${dados.status || 'Pendente'}
                        </div>
                        <div class="popup-detail">
                            <strong>Status Inteligente:</strong> 
                            <span class="intelligent-status-badge ${dadosInteligentes.status_inteligente.replace(/\s+/g, '-').toLowerCase()}">
                                ${dadosInteligentes.status_inteligente.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                            </span>
                        </div>
                        <div class="popup-detail">
                            <strong>Progresso:</strong> ${dados.progresso || 0}%
                        </div>
                        <div class="popup-detail">
                            <strong>Visitas:</strong> ${dadosInteligentes.total_visitas}
                        </div>
                    </div>
                    <div class="popup-section">
                        <h6>Questionários</h6>
                        <div class="popup-detail">
                            <strong>MRS:</strong> ${dadosInteligentes.status_questionarios.mrs.respondido} respondido, ${dadosInteligentes.status_questionarios.mrs.validado} validado
                        </div>
                        <div class="popup-detail">
                            <strong>MAP:</strong> ${dadosInteligentes.status_questionarios.map.respondido} respondido, ${dadosInteligentes.status_questionarios.map.validado} validado
                        </div>
                    </div>
                    <div class="popup-section">
                        <h6>Checklist</h6>
                        <div class="popup-progress">
                            <div class="popup-progress-item">
                                <span>Preparação:</span> ${dadosInteligentes.progresso_checklist.preparacao}%
                            </div>
                            <div class="popup-progress-item">
                                <span>Execução:</span> ${dadosInteligentes.progresso_checklist.execucao}%
                            </div>
                            <div class="popup-progress-item">
                                <span>Finalização:</span> ${dadosInteligentes.progresso_checklist.finalizacao}%
                            </div>
                        </div>
                    </div>
                    <div class="popup-section">
                        <h6>Próxima Ação</h6>
                        <div class="popup-detail">
                            ${dadosInteligentes.proximas_acoes}
                        </div>
                    </div>
                </div>
            `;
            
            const marker = L.marker([dados.coords[0], dados.coords[1]])
                .bindPopup(popupContent, {
                    className: 'popup-custom',
                    maxWidth: 350,
                    minWidth: 300
                })
                .addTo(mapa);
            
            marcadores[municipio] = marker;
        } else {
            console.warn(`❌ ${municipio}: dados ou coordenadas inválidas`, {
                temDados: !!dados,
                coords: dados?.coords,
                tipoCoords: typeof dados?.coords,
                isArray: Array.isArray(dados?.coords),
                length: dados?.coords?.length
            });
        }
    });
    
    console.log(`🎯 Total de marcadores adicionados: ${marcadoresAdicionados}/${MUNICIPIOS_PNSB.length}`);
}

// Atualizar estatísticas
function atualizarEstatisticas() {
    const stats = calcularEstatisticas();
    
    // Atualizar elementos HTML básicos
    const elementos = {
        'total-municipios': stats.total,
        'municipios-finalizados': stats.finalizados,
        'progresso-geral': `${stats.progresso}%`,
        'questionarios-mrs': stats.mrs,
        'questionarios-map': stats.map,
        'municipios-visitados': stats.visitados,
        'progresso-geral-relatorio': `${stats.progresso}%`
    };
    
    Object.entries(elementos).forEach(([id, valor]) => {
        const elemento = document.getElementById(id);
        if (elemento) elemento.textContent = valor;
    });
    
    // Atualizar estatísticas inteligentes
    atualizarEstatisticasInteligentes();
}

// Atualizar estatísticas inteligentes
function atualizarEstatisticasInteligentes() {
    const estatisticasInteligentes = dadosProgresso.estatisticas_inteligentes;
    if (!estatisticasInteligentes) return;
    
    // Atualizar elementos de estatísticas inteligentes se existirem
    const elementosInteligentes = {
        'total-visitas-inteligentes': estatisticasInteligentes.total_visitas || 0,
        'progresso-medio-inteligente': `${Math.round(estatisticasInteligentes.progresso_medio || 0)}%`,
        'mrs-respondidos': estatisticasInteligentes.questionnaire_completion?.mrs?.respondido || 0,
        'mrs-validados': estatisticasInteligentes.questionnaire_completion?.mrs?.validado || 0,
        'map-respondidos': estatisticasInteligentes.questionnaire_completion?.map?.respondido || 0,
        'map-validados': estatisticasInteligentes.questionnaire_completion?.map?.validado || 0,
        'checklist-preparacao': `${Math.round(estatisticasInteligentes.checklist_progress?.preparacao || 0)}%`,
        'checklist-execucao': `${Math.round(estatisticasInteligentes.checklist_progress?.execucao || 0)}%`,
        'checklist-finalizacao': `${Math.round(estatisticasInteligentes.checklist_progress?.finalizacao || 0)}%`
    };
    
    Object.entries(elementosInteligentes).forEach(([id, valor]) => {
        const elemento = document.getElementById(id);
        if (elemento) {
            elemento.textContent = valor;
        }
    });
    
    // Atualizar distribuição de status inteligente
    atualizarDistribuicaoStatusInteligente();
}

// Atualizar distribuição de status inteligente
function atualizarDistribuicaoStatusInteligente() {
    const container = document.getElementById('intelligent-status-distribution');
    if (!container) return;
    
    const estatisticasInteligentes = dadosProgresso.estatisticas_inteligentes;
    if (!estatisticasInteligentes?.por_status_inteligente) return;
    
    const statusInteligente = estatisticasInteligentes.por_status_inteligente;
    const total = estatisticasInteligentes.total_visitas || 1;
    
    const statusColors = {
        'aguardando-agendamento': '#6c757d',
        'em-preparacao': '#17a2b8',
        'pronto-para-visita': '#20c997',
        'visita-realizada': '#007bff',
        'questionarios-respondidos': '#fd7e14',
        'questionarios-validados': '#28a745',
        'processo-finalizado': '#6f42c1'
    };
    
    let html = '';
    Object.entries(statusInteligente).forEach(([status, count]) => {
        const percent = Math.round((count / total) * 100);
        const color = statusColors[status] || '#6c757d';
        const label = status.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        
        html += `
            <div class="status-item">
                <span class="status-label">${label}</span>
                <div class="status-bar">
                    <div class="status-fill" style="width: ${percent}%; background: ${color}"></div>
                </div>
                <span class="status-percent">${percent}%</span>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Calcular estatísticas dos municípios
function calcularEstatisticas() {
    console.log('📊 Calculando estatísticas...');
    const municipios = dadosProgresso.municipios || {};
    console.log('📊 Municípios para cálculo:', Object.keys(municipios));
    
    let finalizados = 0;
    let mrs = 0;
    let map = 0;
    let visitados = 0;
    let progressoTotal = 0;
    
    MUNICIPIOS_PNSB.forEach(municipio => {
        const dados = municipios[municipio];
        console.log(`📊 ${municipio}:`, dados);
        if (dados) {
            // Status originais e da API
            if (dados.status === 'finalizada' || dados.status === 'finalizado') finalizados++;
            if (dados.status !== 'agendada' && dados.status !== 'agendado' && dados.status !== 'sem_visita') visitados++;
            
            // Dados de questionários podem estar em diferentes campos
            if (dados.mrs_coletado || dados.questionarios?.mrs_respondidos > 0) mrs++;
            if (dados.map_coletado || dados.questionarios?.map_respondidos > 0) map++;
            
            // Progresso pode estar em diferentes campos
            const progresso = dados.progresso || dados.percentual_conclusao || calcularProgressoPorStatus(dados.status);
            progressoTotal += progresso;
        }
    });
    
    const resultado = {
        total: MUNICIPIOS_PNSB.length,
        finalizados,
        mrs,
        map,
        visitados,
        progresso: Math.round(progressoTotal / MUNICIPIOS_PNSB.length)
    };
    
    console.log('📊 Estatísticas calculadas:', resultado);
    return resultado;
}

// Exportar dados completos em formato JSON
function exportarDados() {
    try {
        console.log('📊 Exportando dados completos...');
        
        const dadosCompletos = {
            metadados: {
                timestamp: new Date().toISOString(),
                sistema: 'PNSB 2024 - Santa Catarina',
                versao: '2.0',
                municipios_total: MUNICIPIOS_PNSB.length,
                pesquisadores: window.TEAM_CONFIG?.num_pesquisadores || 1,
                deadlines: {
                    visitas: '2025-09-19',
                    questionarios: '2025-10-17'
                }
            },
            estatisticas_gerais: calcularEstatisticas(),
            municipios_dados: dadosProgresso?.municipios || {},
            entidades_identificadas: entidadesIdentificadas || [],
            questionarios_obrigatorios: questionariosObrigatorios || {},
            config_equipe: window.TEAM_CONFIG || {},
            metricas_capacidade: calcularMetricasCapacidade() || {}
        };
        
        // Adicionar informações detalhadas por município
        dadosCompletos.municipios_detalhados = {};
        MUNICIPIOS_PNSB.forEach(municipio => {
            const dados = dadosProgresso?.municipios?.[municipio];
            if (dados) {
                dadosCompletos.municipios_detalhados[municipio] = {
                    status: dados.status,
                    progresso_percentual: dados.percentual_conclusao || 0,
                    coordenadas: dados.coords || [],
                    visitas_total: dados.resumo?.total_visitas || 0,
                    visitas_concluidas: dados.resumo?.finalizadas || 0,
                    questionarios: {
                        mrs_obrigatorios: dados.questionarios?.total_mrs_obrigatorios || 0,
                        mrs_concluidos: dados.questionarios?.mrs_concluidos || 0,
                        map_obrigatorios: dados.questionarios?.total_map_obrigatorios || 0,
                        map_concluidos: dados.questionarios?.map_concluidos || 0,
                        entidades_obrigatorias: dados.questionarios?.entidades_obrigatorias || 0,
                        entidades_pendentes: dados.questionarios?.entidades_obrigatorias_pendentes || 0
                    },
                    prioridades: dados.questionarios?.prioridades || {},
                    alertas: dados.alertas || [],
                    ultima_atualizacao: dados.timing?.ultima_atividade || null
                };
            }
        });
        
        const jsonString = JSON.stringify(dadosCompletos, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `dados_completos_pnsb_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        URL.revokeObjectURL(url);
        
        console.log('✅ Dados exportados com sucesso');
        showToast('Dados exportados com sucesso!', 'success');
        
    } catch (error) {
        console.error('❌ Erro ao exportar dados:', error);
        showToast('Erro ao exportar dados: ' + error.message, 'error');
    }
}

// Alternar entre vista mapa e lista
function alternarVista() {
    currentView = currentView === 'map' ? 'list' : 'map';
    
    const mapaElement = document.getElementById('map-view');
    const listaElement = document.getElementById('list-view');
    const toggleButton = document.getElementById('view-toggle-text');
    
    // Verificar se elementos existem antes de acessar suas propriedades
    if (!mapaElement || !listaElement || !toggleButton) {
        console.error('Elementos necessários para alternar vista não encontrados');
        return;
    }
    
    if (currentView === 'map') {
        mapaElement.style.display = 'block';
        listaElement.style.display = 'none';
        toggleButton.textContent = 'Vista Lista';
    } else {
        mapaElement.style.display = 'none';
        listaElement.style.display = 'block';
        toggleButton.textContent = 'Vista Mapa';
        atualizarVistaLista();
    }
}

// Atualizar vista em lista
function atualizarVistaLista() {
    const container = document.getElementById('list-view');
    if (!container) return;
    
    let html = '';
    MUNICIPIOS_PNSB.forEach(municipio => {
        const dados = dadosProgresso.municipios?.[municipio] || {};
        const dadosInteligentes = obterDadosInteligentes(municipio);
        
        html += `
            <div class="col-md-6 mb-3">
                <div class="progress-card">
                    <div class="progress-header">
                        <div class="municipality-name">${municipio}</div>
                        <div class="dual-status">
                            <span class="progress-status status-${dados.status || 'pending'}">
                                ${dados.status || 'Pendente'}
                            </span>
                            <span class="intelligent-status-badge ${dadosInteligentes.status_inteligente.replace(/\s+/g, '-').toLowerCase()}">
                                ${dadosInteligentes.status_inteligente.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                            </span>
                        </div>
                    </div>
                    <div class="progress-details">
                        <div class="detail-item">
                            <div class="detail-value">${dados.progresso || 0}%</div>
                            <div class="detail-label">Progresso</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-value">${dadosInteligentes.total_visitas}</div>
                            <div class="detail-label">Visitas</div>
                        </div>
                    </div>
                    ${gerarHtmlStatusInteligente(dadosInteligentes)}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Exportar relatório
function exportarRelatorio() {
    const stats = calcularEstatisticas();
    const metricas = calcularMetricasCapacidade();
    const config = window.TEAM_CONFIG || {};
    
    const relatorio = `
RELATÓRIO PNSB 2024 - SANTA CATARINA
=====================================

INFORMAÇÕES GERAIS:
Total de Municípios: ${stats.total}
Municípios Finalizados: ${stats.finalizados}
Municípios Visitados: ${stats.visitados}
Progresso Geral: ${stats.progresso}%

QUESTIONÁRIOS:
MRS (Manejo de Resíduos Sólidos): ${stats.mrs}
MAP (Manejo de Águas Pluviais): ${stats.map}

CONFIGURAÇÃO DA EQUIPE:
Pesquisadores Ativos: ${config.num_pesquisadores || 1}
Capacidade Diária: ${config.capacidade_total_dia || 8} visitas/dia
Horário de Trabalho: ${config.horario_inicio || '08:00'} às ${config.horario_fim || '18:00'}

CRONOGRAMA:
${metricas ? `Dias Restantes para Visitas: ${metricas.diasRestantesVisitas}
Dias Restantes para Questionários: ${metricas.diasRestantesQuestionarios}
Capacidade Restante: ${metricas.capacidadeTotal} visitas` : 'Métricas não disponíveis'}
${metricas?.alertaCritico ? '\n⚠️ ALERTA CRÍTICO: Prazo das visitas próximo!' : ''}
${metricas?.alertaUrgente ? '\n⚠️ ALERTA URGENTE: Prazo das visitas se aproximando!' : ''}

MUNICÍPIOS POR STATUS:
${MUNICIPIOS_PNSB.map(municipio => {
    const dados = dadosProgresso?.municipios?.[municipio];
    if (dados) {
        return `• ${municipio}: ${dados.status} (${dados.percentual_conclusao || 0}%)`;
    }
    return `• ${municipio}: Sem dados`;
}).join('\n')}

Gerado em: ${new Date().toLocaleString('pt-BR')}
Sistema: PNSB 2024 - Gestão de Visitas v2.0
    `;
    
    const blob = new Blob([relatorio], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `relatorio_pnsb_${new Date().toISOString().split('T')[0]}.txt`;
    a.click();
    URL.revokeObjectURL(url);
}

// Atualizar KPIs do relatório com dados dinâmicos
function atualizarKPIsRelatorio() {
    const stats = calcularEstatisticas();
    const metricas = calcularMetricasCapacidade();
    const config = window.TEAM_CONFIG || {};
    
    // Atualizar KPIs principais se existirem
    const kpiElements = {
        'kpi-progresso-total': `${stats.progresso}%`,
        'kpi-municipios-finalizados': stats.finalizados,
        'kpi-questionarios-mrs': stats.mrs,
        'kpi-questionarios-map': stats.map,
        'kpi-municipios-visitados': stats.visitados,
        'kpi-pesquisadores': config.num_pesquisadores || 1
    };
    
    // Atualizar elementos que existem
    Object.entries(kpiElements).forEach(([id, valor]) => {
        const elemento = document.getElementById(id);
        if (elemento) {
            elemento.textContent = valor;
        }
    });
    
    // Atualizar métricas de cronograma se existirem
    if (metricas) {
        const metricasElements = {
            'kpi-dias-restantes-visitas': metricas.diasRestantesVisitas,
            'kpi-dias-restantes-questionarios': metricas.diasRestantesQuestionarios,
            'kpi-capacidade-restante': metricas.capacidadeTotal
        };
        
        Object.entries(metricasElements).forEach(([id, valor]) => {
            const elemento = document.getElementById(id);
            if (elemento) {
                elemento.textContent = valor;
            }
        });
        
        // Atualizar alertas de cronograma
        const alertElement = document.getElementById('alerta-cronograma');
        if (alertElement) {
            if (metricas.alertaCritico) {
                alertElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> CRÍTICO: Prazo próximo!';
                alertElement.className = 'alert alert-danger';
            } else if (metricas.alertaUrgente) {
                alertElement.innerHTML = '<i class="fas fa-clock"></i> URGENTE: Prazo se aproxima!';
                alertElement.className = 'alert alert-warning';
            } else {
                alertElement.innerHTML = '<i class="fas fa-check-circle"></i> Cronograma em dia';
                alertElement.className = 'alert alert-success';
            }
        }
    }
    
    console.log('📊 KPIs do relatório atualizados');
}

// Atualizar relatório
function atualizarRelatorio() {
    carregarDadosProgresso();
    // Atualizar KPIs após carregar dados
    setTimeout(() => {
        atualizarKPIsRelatorio();
    }, 500);
}

// Função de teste para diagnóstico do status dos municípios
function testarStatusMunicipios() {
    console.log('🔧 TESTE MANUAL: Verificando status dos municípios...');
    
    // Verificar se container existe
    const container = document.getElementById('municipiosStatus');
    console.log('1. Container municipiosStatus:', container ? '✅ Encontrado' : '❌ Não encontrado');
    
    // Verificar se dashboard existe
    console.log('2. window.dashboardPNSB:', window.dashboardPNSB ? '✅ Disponível' : '❌ Não disponível');
    
    if (window.dashboardPNSB) {
        console.log('3. municipiosData:', window.dashboardPNSB.municipiosData);
        console.log('4. Número de municípios:', Object.keys(window.dashboardPNSB.municipiosData || {}).length);
        
        // Tentar atualizar
        console.log('5. Tentando atualizar...');
        window.dashboardPNSB.atualizarStatusMunicipios();
        
        // Verificar resultado
        setTimeout(() => {
            const container = document.getElementById('municipiosStatus');
            console.log('6. Container após atualização:', container ? container.innerHTML.length + ' caracteres' : 'não encontrado');
            
            if (container && container.innerHTML.trim() === '') {
                console.warn('⚠️ Container ainda vazio, forçando com dados de teste...');
                
                // Criar dados de teste
                container.innerHTML = `
                    <div style="padding: 10px; background: rgba(45, 49, 66, 0.6); margin: 5px 0; border-radius: 5px; border-left: 3px solid #ffc107;">
                        <div style="color: #F1F5F9; font-weight: 500;">TESTE - Balneário Camboriú</div>
                        <div style="color: #94A3B8; font-size: 11px;">P1 • Status de Teste</div>
                    </div>
                    <div style="padding: 10px; background: rgba(45, 49, 66, 0.6); margin: 5px 0; border-radius: 5px; border-left: 3px solid #3B82F6;">
                        <div style="color: #F1F5F9; font-weight: 500;">TESTE - Itajaí</div>
                        <div style="color: #94A3B8; font-size: 11px;">P1 • Dados de Teste</div>
                    </div>
                    <div style="padding: 10px; text-align: center; color: #ffc107; font-size: 11px; margin-top: 10px;">
                        Dados de teste - Recarregue a página para dados reais
                    </div>
                `;
                
                showToast('Dados de teste inseridos - Verifique o console para mais detalhes', 'info');
            } else {
                showToast('Status dos municípios atualizado com sucesso!', 'success');
            }
        }, 1000);
    } else {
        console.error('❌ Dashboard não disponível para teste');
        showToast('Dashboard não disponível - Aguarde a inicialização', 'error');
    }
}

// Atualizar status dos municípios
function atualizarStatusMunicipios() {
    carregarDadosProgresso();
}

// Atualizar dados (função principal de refresh)
function atualizarDados() {
    console.log('🔄 Atualizando todos os dados...');
    carregarDadosProgresso();
    carregarQuestionariosObrigatorios();
    carregarEntidadesIdentificadas();
    atualizarEstatisticas();
}

// Exportar mapa como imagem
function exportarMapa() {
    try {
        console.log('📥 Exportando mapa...');
        
        // Verificar se leaflet-image está disponível
        if (typeof leafletImage !== 'undefined' && mapa) {
            leafletImage(mapa, function(err, canvas) {
                if (err) {
                    console.error('Erro ao gerar imagem do mapa:', err);
                    alert('Erro ao exportar mapa. Tente novamente.');
                    return;
                }
                
                // Converter canvas para download
                const link = document.createElement('a');
                link.download = `mapa_progresso_pnsb_${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        } else {
            // Fallback: exportar dados como JSON
            const dados = {
                timestamp: new Date().toISOString(),
                municipios: typeof MUNICIPIOS_PNSB !== 'undefined' ? MUNICIPIOS_PNSB : [],
                progresso: typeof dadosProgresso !== 'undefined' ? dadosProgresso : {},
                entidades: typeof entidadesIdentificadas !== 'undefined' ? entidadesIdentificadas : []
            };
            
            const blob = new Blob([JSON.stringify(dados, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = `dados_progresso_pnsb_${new Date().toISOString().split('T')[0]}.json`;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
        }
    } catch (error) {
        console.error('Erro ao exportar:', error);
        alert('Erro ao exportar. Verifique o console para mais detalhes.');
    }
}

// ====================================
// SISTEMA DE ROTA INTELIGENTE - 3 NÍVEIS
// ====================================

class RouteOptimizerIntelligent {
    constructor() {
        this.visitasData = null;
        this.entidadesData = null;
        this.progressoData = null;
        this.googleMapsLoaded = false;
        this.currentLevel = 3;
        // PONTO DE PARTIDA FIXO: Agência IBGE Itajaí
        this.startPoint = {
            name: 'Agência IBGE Itajaí',
            address: 'Rua Camboriú 26, Centro, Itajaí, SC',
            lat: -26.9031,
            lng: -48.6596
        };
        
        // Coordenadas precisas dos 11 municípios PNSB Santa Catarina
        this.coordinates = {
            'Balneário Camboriú': { lat: -26.9977, lng: -48.6354 },
            'Balneário Piçarras': { lat: -26.7677, lng: -48.6704 },
            'Bombinhas': { lat: -27.1394, lng: -48.4814 },
            'Camboriú': { lat: -27.0253, lng: -48.6548 },
            'Itajaí': { lat: -26.9077, lng: -48.6612 },
            'Itapema': { lat: -27.0901, lng: -48.6113 },
            'Luiz Alves': { lat: -26.7186, lng: -48.9367 },
            'Navegantes': { lat: -26.8977, lng: -48.6532 },
            'Penha': { lat: -26.7703, lng: -48.6470 },
            'Porto Belo': { lat: -27.1589, lng: -48.5547 },
            'Ilhota': { lat: -26.8985, lng: -48.8235 }
        };
        
        // Cache para horários de funcionamento das prefeituras
        this.businessHoursCache = new Map();
        this.placesService = null;
        
        // Configurações padrão de horário para prefeituras (fallback)
        this.defaultBusinessHours = {
            monday: { open: '08:00', close: '17:00' },
            tuesday: { open: '08:00', close: '17:00' },
            wednesday: { open: '08:00', close: '17:00' },
            thursday: { open: '08:00', close: '17:00' },
            friday: { open: '08:00', close: '17:00' },
            saturday: { open: null, close: null }, // Fechado
            sunday: { open: null, close: null }    // Fechado
        };
        
        this.init();
    }

    async init() {
        try {
            await this.loadRealData();
            this.checkGoogleMapsAPI();
            await this.initPlacesService();
            console.log('🚀 RouteOptimizer inicializado com dados reais e Google Places');
        } catch (error) {
            console.error('❌ Erro ao inicializar RouteOptimizer:', error);
        }
    }

    async initPlacesService() {
        // Places API temporariamente desabilitado (evitar aviso de deprecação)
        // TODO: Implementar nova API google.maps.places.Place no futuro
        console.log('ℹ️ Places API desabilitado para evitar avisos de deprecação');
        console.log('ℹ️ Usando horários padrão das prefeituras (8h-17h)');
        this.placesService = null;
        this.useNewPlacesAPI = false;
    }

    async loadRealData() {
        try {
            console.log('📊 Carregando dados reais do sistema...');
            
            const [visitasResponse, entidadesResponse, progressoResponse] = await Promise.all([
                fetch('/api/visitas'),
                fetch('/api/questionarios/entidades-identificadas'),
                fetch('/api/questionarios/progresso-questionarios')
            ]);

            if (visitasResponse.ok) {
                const visitasData = await visitasResponse.json();
                this.visitasData = visitasData.data || [];
            } else {
                this.visitasData = [];
            }

            if (entidadesResponse.ok) {
                const entidadesData = await entidadesResponse.json();
                this.entidadesData = entidadesData.entidades || [];
            } else {
                this.entidadesData = [];
            }

            if (progressoResponse.ok) {
                const progressoData = await progressoResponse.json();
                this.progressoData = progressoData.data || [];
            } else {
                this.progressoData = [];
            }

            console.log('✅ Dados carregados:', {
                visitas: this.visitasData.length,
                entidades: this.entidadesData.length,
                progresso: this.progressoData.length
            });

        } catch (error) {
            console.error('❌ Erro ao carregar dados:', error);
            this.visitasData = [];
            this.entidadesData = [];
            this.progressoData = [];
        }
    }

    checkGoogleMapsAPI() {
        // Verificar se temos API key e se Google Maps está carregado
        const hasApiKey = window.GOOGLE_MAPS_API_KEY && window.GOOGLE_MAPS_API_KEY.length > 0;
        this.googleMapsLoaded = hasApiKey && 
                               typeof google !== 'undefined' && 
                               google.maps && 
                               google.maps.DirectionsService;
        
        if (this.googleMapsLoaded) {
            this.currentLevel = 3;
            console.log('✅ Google Maps API disponível - Nível 3 ativo (máxima precisão)');
        } else if (hasApiKey) {
            this.currentLevel = 2;
            console.log('⚠️ Google Maps API configurado mas biblioteca não carregada - Nível 2 ativo');
        } else {
            this.currentLevel = 1;
            console.log('ℹ️ Google Maps API não disponível - Nível 1 ativo (cálculo local)');
        }
    }

    // Buscar horários de funcionamento da prefeitura via Google Places API
    async getBusinessHours(municipio) {
        const cacheKey = `business_hours_${municipio}`;
        
        // Verificar cache primeiro
        if (this.businessHoursCache.has(cacheKey)) {
            return this.businessHoursCache.get(cacheKey);
        }

        if (!this.placesService) {
            console.warn(`⚠️ Places Service não disponível para ${municipio}`);
            return this.getDefaultBusinessHours();
        }

        try {
            const coordinates = this.coordinates[municipio];
            if (!coordinates) {
                return this.getDefaultBusinessHours();
            }

            const businessHours = await this.findPrefeituraBusinessHours(municipio, coordinates);
            
            // Cache por 24 horas
            this.businessHoursCache.set(cacheKey, businessHours);
            
            return businessHours;
            
        } catch (error) {
            console.error(`❌ Erro ao buscar horários para ${municipio}:`, error);
            return this.getDefaultBusinessHours();
        }
    }

    async findPrefeituraBusinessHours(municipio, coordinates) {
        return new Promise((resolve) => {
            const request = {
                location: new google.maps.LatLng(coordinates.lat, coordinates.lng),
                radius: 2000, // 2km de raio
                query: `Prefeitura Municipal de ${municipio}`,
                type: 'local_government_office'
            };

            this.placesService.textSearch(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && results.length > 0) {
                    const place = results[0];
                    
                    // Buscar detalhes do local incluindo horários
                    this.placesService.getDetails({
                        placeId: place.place_id,
                        fields: ['opening_hours', 'name', 'formatted_address']
                    }, (details, detailsStatus) => {
                        if (detailsStatus === google.maps.places.PlacesServiceStatus.OK && details.opening_hours) {
                            const businessHours = this.parseGoogleOpeningHours(details.opening_hours);
                            console.log(`🏢 Horários encontrados para ${municipio}:`, businessHours);
                            resolve(businessHours);
                        } else {
                            console.warn(`⚠️ Horários não encontrados para ${municipio}, usando padrão`);
                            resolve(this.getDefaultBusinessHours());
                        }
                    });
                } else {
                    console.warn(`⚠️ Prefeitura não encontrada para ${municipio}, usando horários padrão`);
                    resolve(this.getDefaultBusinessHours());
                }
            });
        });
    }

    parseGoogleOpeningHours(openingHours) {
        const weekdays = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        const businessHours = {};

        if (openingHours.periods) {
            weekdays.forEach((day, index) => {
                businessHours[day] = { open: null, close: null };
            });

            openingHours.periods.forEach(period => {
                const dayIndex = period.open.day;
                const dayName = weekdays[dayIndex];
                
                if (period.open && period.close) {
                    businessHours[dayName] = {
                        open: this.formatTime(period.open.time),
                        close: this.formatTime(period.close.time)
                    };
                }
            });
        } else {
            // Fallback para horários padrão
            return this.getDefaultBusinessHours();
        }

        return businessHours;
    }

    formatTime(timeString) {
        // timeString vem como "0800" ou "1730"
        if (timeString && timeString.length === 4) {
            const hours = timeString.substring(0, 2);
            const minutes = timeString.substring(2, 4);
            return `${hours}:${minutes}`;
        }
        return timeString;
    }

    getDefaultBusinessHours() {
        return { ...this.defaultBusinessHours };
    }

    // Verificar se um horário está dentro do funcionamento
    isWithinBusinessHours(municipio, targetTime, businessHours = null) {
        if (!businessHours) {
            businessHours = this.getDefaultBusinessHours();
        }

        const targetDate = new Date(targetTime);
        const dayOfWeek = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'][targetDate.getDay()];
        const dayHours = businessHours[dayOfWeek];

        if (!dayHours || !dayHours.open || !dayHours.close) {
            return false; // Fechado neste dia
        }

        const targetTimeStr = `${String(targetDate.getHours()).padStart(2, '0')}:${String(targetDate.getMinutes()).padStart(2, '0')}`;
        
        return targetTimeStr >= dayHours.open && targetTimeStr <= dayHours.close;
    }

    // Calcular próximo horário de abertura
    getNextOpenTime(municipio, fromTime, businessHours = null) {
        if (!businessHours) {
            businessHours = this.getDefaultBusinessHours();
        }

        const date = new Date(fromTime);
        const weekdays = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        
        // Tentar nos próximos 7 dias
        for (let daysAhead = 0; daysAhead < 7; daysAhead++) {
            const checkDate = new Date(date.getTime() + (daysAhead * 24 * 60 * 60 * 1000));
            const dayName = weekdays[checkDate.getDay()];
            const dayHours = businessHours[dayName];
            
            if (dayHours && dayHours.open) {
                const [hours, minutes] = dayHours.open.split(':');
                const openTime = new Date(checkDate);
                openTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                
                if (daysAhead === 0) {
                    // Mesmo dia - verificar se ainda não passou
                    if (openTime > date) {
                        return openTime;
                    }
                } else {
                    // Dias futuros
                    return openTime;
                }
            }
        }
        
        // Fallback: próxima segunda-feira 8:00
        const nextMonday = new Date(date);
        nextMonday.setDate(date.getDate() + (1 + 7 - date.getDay()) % 7);
        nextMonday.setHours(8, 0, 0, 0);
        return nextMonday;
    }

    async calculateOptimalRoute(selectedMunicipalities, criteria = 'intelligent') {
        if (!selectedMunicipalities || selectedMunicipalities.length < 2) {
            throw new Error('Selecione pelo menos 2 municípios');
        }

        console.log(`🔄 Calculando rota - Nível ${this.currentLevel}, Critério: ${criteria}`);
        
        try {
            // Tentar Nível 3: Google Maps Directions API (máxima precisão)
            if (this.currentLevel === 3) {
                return await this.level3GoogleDirections(selectedMunicipalities, criteria);
            }
        } catch (error) {
            console.warn('Nível 3 falhou, tentando Nível 2:', error);
            this.currentLevel = 2;
        }

        try {
            // Tentar Nível 2: Google Maps Distance Matrix (precisão média)
            if (this.currentLevel === 2) {
                return await this.level2DistanceMatrix(selectedMunicipalities, criteria);
            }
        } catch (error) {
            console.warn('Nível 2 falhou, usando Nível 1:', error);
            this.currentLevel = 1;
        }

        // Nível 1: Cálculo local inteligente (sempre funciona)
        return await this.level1LocalIntelligent(selectedMunicipalities, criteria);
    }

    // NÍVEL 3: Google Maps Directions API (máxima precisão)
    async level3GoogleDirections(municipalities, criteria) {
        if (!this.googleMapsLoaded) throw new Error('Google Maps não disponível');
        
        const directionsService = new google.maps.DirectionsService();
        const waypoints = municipalities.slice(1, -1).map(name => ({
            location: new google.maps.LatLng(this.coordinates[name].lat, this.coordinates[name].lng),
            stopover: true
        }));

        const request = {
            origin: new google.maps.LatLng(
                this.coordinates[municipalities[0]].lat,
                this.coordinates[municipalities[0]].lng
            ),
            destination: new google.maps.LatLng(
                this.coordinates[municipalities[municipalities.length - 1]].lat,
                this.coordinates[municipalities[municipalities.length - 1]].lng
            ),
            waypoints: waypoints,
            optimizeWaypoints: true,
            travelMode: google.maps.TravelMode.DRIVING
        };

        return new Promise((resolve, reject) => {
            directionsService.route(request, (result, status) => {
                if (status === google.maps.DirectionsStatus.OK) {
                    const optimizedRoute = this.processDirectionsResult(result, municipalities, criteria);
                    resolve({
                        success: true,
                        route: optimizedRoute,
                        level: 3,
                        apiUsed: 'google_directions'
                    });
                } else {
                    reject(new Error(`Directions API failed: ${status}`));
                }
            });
        });
    }

    // NÍVEL 2: Distance Matrix API
    async level2DistanceMatrix(municipalities, criteria) {
        if (!this.googleMapsLoaded) throw new Error('Google Maps não disponível');
        
        const service = new google.maps.DistanceMatrixService();
        const locations = municipalities.map(name => 
            new google.maps.LatLng(this.coordinates[name].lat, this.coordinates[name].lng)
        );

        return new Promise((resolve, reject) => {
            service.getDistanceMatrix({
                origins: locations,
                destinations: locations,
                travelMode: google.maps.TravelMode.DRIVING,
                unitSystem: google.maps.UnitSystem.METRIC
            }, (response, status) => {
                if (status === google.maps.DistanceMatrixStatus.OK) {
                    const distanceMatrix = this.parseDistanceMatrix(response);
                    const optimizedRoute = this.solveTSPWithMatrix(municipalities, distanceMatrix, criteria);
                    resolve({
                        success: true,
                        route: optimizedRoute,
                        level: 2,
                        apiUsed: 'distance_matrix'
                    });
                } else {
                    reject(new Error(`Distance Matrix failed: ${status}`));
                }
            });
        });
    }

    // NÍVEL 1: Cálculo local inteligente com dados reais (sempre funciona)
    async level1LocalIntelligent(municipalities, criteria) {
        console.log('🧠 Nível 1: Otimização local inteligente iniciada');
        
        // Buscar horários de funcionamento para todos os municípios
        const businessHoursPromises = municipalities.map(municipio => 
            this.getBusinessHours(municipio)
        );
        const businessHoursList = await Promise.all(businessHoursPromises);
        
        // Enriquecer municípios com dados REAIS + horários de funcionamento
        const enrichedMunicipalities = municipalities.map((municipio, index) => {
            const visitasDoMunicipio = this.getVisitasByMunicipio(municipio);
            const entidadesDoMunicipio = this.getEntidadesByMunicipio(municipio);
            const progressoDoMunicipio = this.getProgressoByMunicipio(municipio);
            const businessHours = businessHoursList[index];
            
            return {
                name: municipio,
                coordinates: this.coordinates[municipio],
                visitData: this.analyzeVisitData(visitasDoMunicipio),
                entityData: this.analyzeEntityData(entidadesDoMunicipio),
                progressData: this.analyzeProgressData(progressoDoMunicipio),
                businessHours: businessHours,
                urgency: this.calculateUrgency(visitasDoMunicipio, entidadesDoMunicipio, progressoDoMunicipio),
                complexity: this.calculateComplexity(entidadesDoMunicipio, progressoDoMunicipio),
                priority: this.calculateDynamicPriority(visitasDoMunicipio, entidadesDoMunicipio, progressoDoMunicipio),
                scheduleOptimization: this.calculateScheduleOptimization(businessHours)
            };
        });

        // Aplicar algoritmo baseado no critério
        let optimizedSequence;
        switch (criteria) {
            case 'urgent_visits':
                optimizedSequence = this.optimizeByUrgentVisits(enrichedMunicipalities);
                break;
            case 'completion_focus':
                optimizedSequence = this.optimizeByCompletion(enrichedMunicipalities);
                break;
            case 'visit_sequence':
                optimizedSequence = this.optimizeByVisitSequence(enrichedMunicipalities);
                break;
            case 'balanced':
                optimizedSequence = this.optimizeBalanced(enrichedMunicipalities);
                break;
            case 'intelligent':
            default:
                optimizedSequence = this.optimizeIntelligent(enrichedMunicipalities);
                break;
        }

        // Aplicar otimização de cronograma considerando horários de funcionamento
        const scheduleOptimizedSequence = this.optimizeScheduleSequence(optimizedSequence);

        return {
            success: true,
            route: this.formatIntelligentRoute(scheduleOptimizedSequence, criteria),
            level: 1,
            apiUsed: 'local_intelligent'
        };
    }

    // Calcular otimização de cronograma baseada nos horários de funcionamento
    calculateScheduleOptimization(businessHours) {
        const today = new Date();
        const currentTime = today.getHours() * 60 + today.getMinutes(); // minutos desde meia-noite
        
        let scheduleScore = 0;
        let bestVisitTime = null;
        let timeWindow = null;
        
        // Analisar horários para cada dia da semana
        const weekdays = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        const dayNames = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
        
        weekdays.forEach((day, index) => {
            const dayHours = businessHours[day];
            if (dayHours && dayHours.open && dayHours.close) {
                const openTime = this.timeToMinutes(dayHours.open);
                const closeTime = this.timeToMinutes(dayHours.close);
                const workingHours = closeTime - openTime;
                
                // Pontuação baseada em janela de tempo disponível
                const timeScore = Math.min(workingHours / 60, 8); // máximo 8 horas
                
                // Bonus para dias úteis
                const dayBonus = (index >= 1 && index <= 5) ? 1.5 : 1.0;
                
                const totalScore = timeScore * dayBonus;
                
                if (totalScore > scheduleScore) {
                    scheduleScore = totalScore;
                    bestVisitTime = {
                        day: dayNames[index],
                        openTime: dayHours.open,
                        closeTime: dayHours.close,
                        workingHours: workingHours / 60
                    };
                    timeWindow = `${dayHours.open} - ${dayHours.close}`;
                }
            }
        });
        
        return {
            scheduleScore: Math.round(scheduleScore * 10) / 10,
            bestVisitTime: bestVisitTime,
            timeWindow: timeWindow,
            isOpenToday: this.isOpenToday(businessHours),
            nextOpenTime: this.getNextOpenTime('', today, businessHours)
        };
    }

    timeToMinutes(timeString) {
        const [hours, minutes] = timeString.split(':').map(Number);
        return hours * 60 + minutes;
    }

    isOpenToday(businessHours) {
        const today = new Date();
        const dayOfWeek = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'][today.getDay()];
        const dayHours = businessHours[dayOfWeek];
        
        if (!dayHours || !dayHours.open || !dayHours.close) {
            return false;
        }
        
        const now = today.getHours() * 60 + today.getMinutes();
        const openTime = this.timeToMinutes(dayHours.open);
        const closeTime = this.timeToMinutes(dayHours.close);
        
        return now >= openTime && now <= closeTime;
    }

    // Otimizar sequência considerando horários de funcionamento
    optimizeScheduleSequence(municipalities) {
        const departureTime = new Date();
        departureTime.setHours(8, 0, 0, 0); // Partida 8:00
        
        let currentTime = new Date(departureTime);
        
        // Calcular horário estimado de chegada em cada município
        const scheduledMunicipalities = municipalities.map((municipality, index) => {
            // Tempo de viagem estimado (30-60 min entre municípios)
            const travelTime = index === 0 ? 30 : 45; // Do IBGE ao primeiro = 30min, entre municípios = 45min
            currentTime = new Date(currentTime.getTime() + (travelTime * 60 * 1000));
            
            const arrivalTime = new Date(currentTime);
            const isOpen = this.isWithinBusinessHours(municipality.name, arrivalTime, municipality.businessHours);
            
            // Se chegou quando está fechado, ajustar para próximo horário de abertura
            if (!isOpen) {
                const nextOpenTime = this.getNextOpenTime(municipality.name, arrivalTime, municipality.businessHours);
                currentTime = new Date(nextOpenTime);
            }
            
            // Tempo de trabalho no município (baseado na complexidade)
            const workTime = (municipality.complexity || 2) * 60; // minutos
            currentTime = new Date(currentTime.getTime() + (workTime * 60 * 1000));
            
            return {
                ...municipality,
                scheduledArrival: new Date(currentTime.getTime() - (workTime * 60 * 1000)),
                scheduledDeparture: new Date(currentTime),
                isOpenOnArrival: isOpen,
                estimatedWorkTime: workTime,
                scheduleEfficiency: isOpen ? 1.0 : 0.5 // Penalidade se chegar fora do horário
            };
        });
        
        // Reordenar para maximizar eficiência do cronograma
        return scheduledMunicipalities.sort((a, b) => {
            // Priorizar municípios que estarão abertos na chegada
            const openDiff = b.scheduleEfficiency - a.scheduleEfficiency;
            if (Math.abs(openDiff) > 0.1) return openDiff;
            
            // Manter ordenação por urgência/prioridade original
            return (b.urgency || 0) - (a.urgency || 0);
        });
    }

    // Análise de dados de visitas
    analyzeVisitData(visitas) {
        const agora = new Date();
        
        return {
            total: visitas.length,
            realizadas: visitas.filter(v => v.status === 'realizada').length,
            agendadas: visitas.filter(v => v.status === 'agendada').length,
            atrasadas: visitas.filter(v => 
                v.status === 'agendada' && new Date(v.data_agendada) < agora
            ).length,
            ultimaVisita: this.getUltimaVisita(visitas),
            proximaVisita: this.getProximaVisita(visitas),
            diasSemVisita: this.getDiasSemVisita(visitas),
            frequenciaVisitas: this.calculateFrequenciaVisitas(visitas)
        };
    }

    // Análise de dados de entidades
    analyzeEntityData(entidades) {
        return {
            total: entidades.length,
            p1: entidades.filter(e => e.prioridade === 1).length,
            p2: entidades.filter(e => e.prioridade === 2).length,
            p3: entidades.filter(e => e.prioridade === 3).length,
            mrsPendentes: entidades.filter(e => 
                e.mrs_obrigatorio && e.status_mrs !== 'validado_concluido'
            ).length,
            mapPendentes: entidades.filter(e => 
                e.map_obrigatorio && e.status_map !== 'validado_concluido'
            ).length,
            questionariosConcluidos: entidades.filter(e => 
                e.status_mrs === 'validado_concluido' && e.status_map === 'validado_concluido'
            ).length
        };
    }

    // Cálculo de urgência baseado em dados reais
    calculateUrgency(visitas, entidades, progresso) {
        let urgency = 0;
        
        // Visitas atrasadas (peso alto)
        const visitasAtrasadas = visitas.filter(v => 
            v.status === 'agendada' && new Date(v.data_agendada) < new Date()
        );
        urgency += visitasAtrasadas.length * 25;
        
        // Tempo sem visita
        const diasSemVisita = this.getDiasSemVisita(visitas);
        if (diasSemVisita > 30) {
            urgency += Math.min(diasSemVisita / 7, 30);
        }
        
        // Entidades P1 pendentes
        const p1Pendentes = entidades.filter(e => 
            e.prioridade === 1 && 
            (e.status_mrs !== 'validado_concluido' || e.status_map !== 'validado_concluido')
        );
        urgency += p1Pendentes.length * 20;
        
        // Progresso baixo
        const percentualProgresso = progresso?.percentual_geral || 0;
        if (percentualProgresso < 25) {
            urgency += (25 - percentualProgresso);
        }
        
        return Math.min(urgency, 100);
    }

    // Otimização inteligente principal
    optimizeIntelligent(municipalities) {
        return municipalities.sort((a, b) => {
            // 1. Urgência extrema tem prioridade absoluta
            const urgencyDiff = b.urgency - a.urgency;
            if (Math.abs(urgencyDiff) > 15) return urgencyDiff;
            
            // 2. Visitas agendadas nunca visitadas
            const aNeverVisited = a.visitData.realizadas === 0;
            const bNeverVisited = b.visitData.realizadas === 0;
            if (aNeverVisited !== bNeverVisited) {
                return bNeverVisited ? 1 : -1;
            }
            
            // 3. Visitas atrasadas
            const delayedDiff = b.visitData.atrasadas - a.visitData.atrasadas;
            if (delayedDiff !== 0) return delayedDiff;
            
            // 4. Entidades P1 pendentes
            const p1Diff = b.entityData.p1 - a.entityData.p1;
            if (p1Diff !== 0) return p1Diff;
            
            // 5. Progresso baixo
            const progressDiff = a.progressData.percentual_geral - b.progressData.percentual_geral;
            if (Math.abs(progressDiff) > 10) return progressDiff;
            
            // 6. Proximidade geográfica
            const distanceA = this.haversineDistance(municipalities[0].coordinates, a.coordinates);
            const distanceB = this.haversineDistance(municipalities[0].coordinates, b.coordinates);
            return distanceA - distanceB;
        });
    }

    // Otimização por visitas urgentes
    optimizeByUrgentVisits(municipalities) {
        return municipalities.sort((a, b) => {
            // Priorizar visitas atrasadas
            const delayedDiff = b.visitData.atrasadas - a.visitData.atrasadas;
            if (delayedDiff !== 0) return delayedDiff;
            
            // Depois por dias sem visita
            const daysDiff = b.visitData.diasSemVisita - a.visitData.diasSemVisita;
            if (Math.abs(daysDiff) > 7) return daysDiff;
            
            // Por último, urgência geral
            return b.urgency - a.urgency;
        });
    }

    // Utilitários
    getVisitasByMunicipio(municipio) {
        return this.visitasData.filter(v => v.municipio === municipio);
    }

    getEntidadesByMunicipio(municipio) {
        return this.entidadesData.filter(e => e.municipio === municipio);
    }

    getProgressoByMunicipio(municipio) {
        return this.progressoData.find(p => p.municipio === municipio) || {};
    }

    getDiasSemVisita(visitas) {
        const ultimaVisita = this.getUltimaVisita(visitas);
        if (!ultimaVisita) return 999; // Nunca visitado
        
        const hoje = new Date();
        const dataUltima = new Date(ultimaVisita.data_agendada);
        return Math.ceil((hoje - dataUltima) / (1000 * 60 * 60 * 24));
    }

    getUltimaVisita(visitas) {
        const realizadas = visitas.filter(v => v.status === 'realizada');
        if (realizadas.length === 0) return null;
        
        return realizadas.reduce((latest, current) => {
            const latestDate = new Date(latest.data_agendada);
            const currentDate = new Date(current.data_agendada);
            return currentDate > latestDate ? current : latest;
        });
    }

    haversineDistance(coord1, coord2) {
        const R = 6371; // Raio da Terra em km
        const dLat = this.toRad(coord2.lat - coord1.lat);
        const dLng = this.toRad(coord2.lng - coord1.lng);
        
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(this.toRad(coord1.lat)) * Math.cos(this.toRad(coord2.lat)) *
                  Math.sin(dLng / 2) * Math.sin(dLng / 2);
        
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    toRad(deg) {
        return deg * (Math.PI / 180);
    }

    formatIntelligentRoute(sequence, criteria) {
        // Incluir ponto de partida/retorno no cálculo da rota
        const fullRoute = [this.startPoint, ...sequence, this.startPoint];
        const totalDistance = this.calculateRouteDistanceWithStart(sequence);
        const totalTime = this.calculateRouteTimeWithStart(sequence);
        
        return {
            startPoint: this.startPoint,
            sequence: sequence.map(m => m.name),
            fullSequence: fullRoute.map(point => point.name || point.address),
            municipalities: sequence.map((m, index) => ({
                name: m.name,
                coordinates: m.coordinates,
                order: index + 1,
                distanceFromStart: Math.round(this.haversineDistance(this.startPoint, m.coordinates) * 10) / 10,
                visitSummary: {
                    totalVisitas: m.visitData?.total || 0,
                    realizadas: m.visitData?.realizadas || 0,
                    atrasadas: m.visitData?.atrasadas || 0,
                    diasSemVisita: m.visitData?.diasSemVisita || 0,
                    proximaVisita: m.visitData?.proximaVisita || 'Não agendada'
                },
                entitySummary: {
                    total: m.entityData?.total || 0,
                    p1Pendentes: m.entityData?.p1 || 0,
                    p2Pendentes: m.entityData?.p2 || 0,
                    p3Pendentes: m.entityData?.p3 || 0,
                    mrsPendentes: m.entityData?.mrsPendentes || 0,
                    mapPendentes: m.entityData?.mapPendentes || 0,
                    questionariosConcluidos: m.entityData?.questionariosConcluidos || 0
                },
                progressSummary: {
                    percentualGeral: m.progressData?.percentual_geral || 0,
                    mrsConcluido: m.progressData?.mrs_concluido || false,
                    mapConcluido: m.progressData?.map_concluido || false
                },
                metrics: {
                    urgency: Math.round(m.urgency || 0),
                    complexity: Math.round((m.complexity || 0) * 10) / 10,
                    priority: Math.round((m.priority || 0) * 10) / 10
                },
                businessHours: m.businessHours,
                scheduleInfo: {
                    isOpenToday: m.scheduleOptimization?.isOpenToday || false,
                    bestVisitTime: m.scheduleOptimization?.bestVisitTime || null,
                    timeWindow: m.scheduleOptimization?.timeWindow || 'Não disponível',
                    scheduleScore: m.scheduleOptimization?.scheduleScore || 0,
                    scheduledArrival: m.scheduledArrival ? m.scheduledArrival.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : null,
                    scheduledDeparture: m.scheduledDeparture ? m.scheduledDeparture.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : null,
                    isOpenOnArrival: m.isOpenOnArrival || false,
                    scheduleEfficiency: Math.round((m.scheduleEfficiency || 0) * 100)
                },
                reasons: this.getOptimizationReasons(m, criteria)
            })),
            summary: {
                totalDistance: Math.round(totalDistance * 10) / 10,
                estimatedTime: Math.round(totalTime),
                totalMunicipalities: sequence.length,
                neverVisited: sequence.filter(m => (m.visitData?.realizadas || 0) === 0).length,
                withDelayedVisits: sequence.filter(m => (m.visitData?.atrasadas || 0) > 0).length,
                avgUrgency: Math.round(sequence.reduce((sum, m) => sum + (m.urgency || 0), 0) / sequence.length),
                departureTime: '08:00',
                estimatedReturn: this.calculateReturnTime(totalTime),
                fuelEstimate: Math.round(totalDistance * 0.15) // Estimativa consumo: 6.7km/L
            },
            criteria: criteria,
            criteriaDescription: this.getCriteriaDescription(criteria),
            timestamp: new Date().toISOString()
        };
    }

    calculateRouteDistance(sequence) {
        let total = 0;
        for (let i = 0; i < sequence.length - 1; i++) {
            total += this.haversineDistance(sequence[i].coordinates, sequence[i + 1].coordinates);
        }
        return total;
    }

    calculateRouteTime(sequence) {
        return sequence.reduce((total, m) => total + (m.complexity * 60) + 30, 0); // tempo base + deslocamento
    }

    // Calcular distância considerando ponto de partida/retorno
    calculateRouteDistanceWithStart(sequence) {
        let total = 0;
        
        // Do IBGE ao primeiro município
        if (sequence.length > 0) {
            total += this.haversineDistance(this.startPoint, sequence[0].coordinates);
        }
        
        // Entre municípios
        for (let i = 0; i < sequence.length - 1; i++) {
            total += this.haversineDistance(sequence[i].coordinates, sequence[i + 1].coordinates);
        }
        
        // Do último município de volta ao IBGE
        if (sequence.length > 0) {
            total += this.haversineDistance(sequence[sequence.length - 1].coordinates, this.startPoint);
        }
        
        return total;
    }

    // Calcular tempo considerando ponto de partida/retorno
    calculateRouteTimeWithStart(sequence) {
        let totalTime = 0;
        
        // Tempo base para cada município (2h de trabalho + 30min deslocamento)
        totalTime += sequence.reduce((total, m) => total + ((m.complexity || 2) * 60) + 30, 0);
        
        // Tempo adicional de ida e volta ao IBGE (30min cada)
        totalTime += 60;
        
        return totalTime;
    }

    // Calcular horário estimado de retorno
    calculateReturnTime(totalTimeMinutes) {
        const startHour = 8; // 08:00
        const endHour = startHour + (totalTimeMinutes / 60);
        const hours = Math.floor(endHour);
        const minutes = Math.round((endHour - hours) * 60);
        
        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
    }

    // Obter descrição do critério
    getCriteriaDescription(criteria) {
        const descriptions = {
            'intelligent': 'Otimização inteligente considerando urgência, progresso e proximidade geográfica',
            'urgent_visits': 'Prioriza visitas atrasadas e municípios nunca visitados',
            'completion_focus': 'Foca em completar questionários pendentes e progresso baixo',
            'visit_sequence': 'Baseado no histórico e agenda de visitas existentes',
            'balanced': 'Equilibra urgência, progresso, distância e complexidade',
            'distance': 'Otimização geográfica tradicional por menor distância'
        };
        return descriptions[criteria] || 'Critério não especificado';
    }

    // Obter razões da otimização para cada município
    getOptimizationReasons(municipio, criteria) {
        const reasons = [];
        
        if ((municipio.visitData?.realizadas || 0) === 0) {
            reasons.push('🚨 Município nunca visitado');
        }
        
        if ((municipio.visitData?.atrasadas || 0) > 0) {
            reasons.push(`⏰ ${municipio.visitData.atrasadas} visitas atrasadas`);
        }
        
        if ((municipio.entityData?.p1 || 0) > 0) {
            reasons.push(`🔴 ${municipio.entityData.p1} entidades P1 pendentes`);
        }
        
        if ((municipio.progressData?.percentual_geral || 0) < 25) {
            reasons.push('📊 Progresso muito baixo');
        }
        
        if ((municipio.urgency || 0) > 70) {
            reasons.push('🚨 Urgência alta');
        }
        
        if ((municipio.visitData?.diasSemVisita || 0) > 30) {
            reasons.push(`📅 ${municipio.visitData.diasSemVisita} dias sem visita`);
        }
        
        return reasons.length > 0 ? reasons : ['✅ Município em dia'];
    }

    // Funções auxiliares faltantes
    analyzeProgressData(progresso) {
        return {
            percentual_geral: progresso?.percentual_geral || 0,
            status_p1: progresso?.status_p1 || 'nao_iniciado',
            status_p2: progresso?.status_p2 || 'nao_iniciado',
            questionarios_obrigatorios: progresso?.total_questionarios_obrigatorios || 0,
            questionarios_concluidos: progresso?.questionarios_concluidos || 0,
            entidades_p1: progresso?.p1_total_entidades || 0,
            entidades_p2: progresso?.p2_total_entidades || 0
        };
    }

    calculateComplexity(entidades, progresso) {
        let complexity = 1;
        
        // Número de entidades aumenta complexidade
        complexity += Math.min(entidades.length / 10, 2);
        
        // Entidades P1 são mais complexas
        const p1Count = entidades.filter(e => e.prioridade === 1).length;
        complexity += p1Count * 0.5;
        
        // Questionários pendentes aumentam complexidade
        const pendentes = entidades.filter(e => 
            e.status_mrs === 'nao_iniciado' || e.status_map === 'nao_iniciado'
        ).length;
        complexity += pendentes * 0.3;
        
        // Baixo progresso = maior complexidade
        const percentualProgresso = progresso?.percentual_geral || 0;
        if (percentualProgresso < 50) {
            complexity += (50 - percentualProgresso) / 25;
        }
        
        return Math.min(complexity, 8);
    }

    calculateDynamicPriority(visitas, entidades, progresso) {
        let priority = 1;
        
        // Visitas atrasadas aumentam prioridade
        const atrasadas = visitas.filter(v => 
            v.status === 'agendada' && new Date(v.data_agendada) < new Date()
        ).length;
        priority += atrasadas * 2;
        
        // Nunca visitado tem prioridade alta
        const nuncaVisitado = visitas.filter(v => v.status === 'realizada').length === 0;
        if (nuncaVisitado) priority += 3;
        
        // Entidades P1 pendentes
        const p1Pendentes = entidades.filter(e => 
            e.prioridade === 1 && 
            (e.status_mrs !== 'validado_concluido' || e.status_map !== 'validado_concluido')
        ).length;
        priority += p1Pendentes * 1.5;
        
        // Progresso baixo
        const percentualProgresso = progresso?.percentual_geral || 0;
        if (percentualProgresso < 30) {
            priority += (30 - percentualProgresso) / 10;
        }
        
        return Math.min(priority, 10);
    }

    getProximaVisita(visitas) {
        const agendadas = visitas.filter(v => v.status === 'agendada');
        if (agendadas.length === 0) return null;
        
        return agendadas.reduce((nearest, current) => {
            const nearestDate = new Date(nearest.data_agendada);
            const currentDate = new Date(current.data_agendada);
            return currentDate < nearestDate ? current : nearest;
        });
    }

    calculateFrequenciaVisitas(visitas) {
        const realizadas = visitas.filter(v => v.status === 'realizada');
        if (realizadas.length < 2) return 0;
        
        const datas = realizadas.map(v => new Date(v.data_agendada)).sort((a, b) => a - b);
        const intervalos = [];
        
        for (let i = 1; i < datas.length; i++) {
            const dias = (datas[i] - datas[i-1]) / (1000 * 60 * 60 * 24);
            intervalos.push(dias);
        }
        
        return intervalos.reduce((sum, dias) => sum + dias, 0) / intervalos.length;
    }

    // Algoritmos de otimização por outros critérios
    optimizeByCompletion(municipalities) {
        return municipalities.sort((a, b) => {
            // Priorizar baixo progresso
            const progressDiff = a.progressData.percentual_geral - b.progressData.percentual_geral;
            if (Math.abs(progressDiff) > 5) return progressDiff;
            
            // Depois por questionários pendentes
            const pendentesA = a.entityData.mrsPendentes + a.entityData.mapPendentes;
            const pendentesB = b.entityData.mrsPendentes + b.entityData.mapPendentes;
            const pendentesDiff = pendentesB - pendentesA;
            if (pendentesDiff !== 0) return pendentesDiff;
            
            // Por último, entidades P1
            return b.entityData.p1 - a.entityData.p1;
        });
    }

    optimizeByVisitSequence(municipalities) {
        const nuncaVisitados = municipalities.filter(m => m.visitData.realizadas === 0);
        const atrasadas = municipalities.filter(m => m.visitData.atrasadas > 0);
        const normais = municipalities.filter(m => m.visitData.realizadas > 0 && m.visitData.atrasadas === 0);
        
        // Ordenar cada grupo
        const nuncaOrdenados = nuncaVisitados.sort((a, b) => b.urgency - a.urgency);
        const atrasadasOrdenadas = atrasadas.sort((a, b) => b.visitData.atrasadas - a.visitData.atrasadas);
        const normaisOrdenados = normais.sort((a, b) => a.visitData.diasSemVisita - b.visitData.diasSemVisita);
        
        return [...atrasadasOrdenadas, ...nuncaOrdenados, ...normaisOrdenados];
    }

    optimizeBalanced(municipalities) {
        const weights = { urgency: 0.3, progress: 0.25, distance: 0.25, complexity: 0.2 };
        
        return municipalities.sort((a, b) => {
            const scoreA = this.calculateBalancedScore(a, municipalities, weights);
            const scoreB = this.calculateBalancedScore(b, municipalities, weights);
            return scoreB - scoreA;
        });
    }

    calculateBalancedScore(municipality, allMunicipalities, weights) {
        const urgencyScore = municipality.urgency / 100;
        const progressScore = (100 - municipality.progressData.percentual_geral) / 100;
        const complexityScore = municipality.complexity / 8;
        
        // Calcular score de distância média
        const avgDistance = allMunicipalities.reduce((sum, m) => {
            if (m.name === municipality.name) return sum;
            return sum + this.haversineDistance(municipality.coordinates, m.coordinates);
        }, 0) / (allMunicipalities.length - 1);
        
        const distanceScore = Math.max(0, 1 - (avgDistance / 100));
        
        return (
            weights.urgency * urgencyScore +
            weights.progress * progressScore +
            weights.distance * distanceScore +
            weights.complexity * complexityScore
        );
    }

    // Processamento de resultados do Google Maps
    processDirectionsResult(result, municipalities, criteria) {
        const route = result.routes[0];
        const optimizedOrder = route.waypoint_order || [];
        
        // Reordenar municípios conforme otimização do Google Maps
        const optimizedSequence = [municipalities[0]]; // origem
        optimizedOrder.forEach(index => {
            optimizedSequence.push(municipalities[index + 1]); // +1 porque waypoints começam do índice 1
        });
        optimizedSequence.push(municipalities[municipalities.length - 1]); // destino
        
        // Enriquecer com dados locais
        const enrichedSequence = optimizedSequence.map(municipio => {
            const visitasDoMunicipio = this.getVisitasByMunicipio(municipio);
            const entidadesDoMunicipio = this.getEntidadesByMunicipio(municipio);
            const progressoDoMunicipio = this.getProgressoByMunicipio(municipio);
            
            return {
                name: municipio,
                coordinates: this.coordinates[municipio],
                visitData: this.analyzeVisitData(visitasDoMunicipio),
                entityData: this.analyzeEntityData(entidadesDoMunicipio),
                progressData: this.analyzeProgressData(progressoDoMunicipio),
                urgency: this.calculateUrgency(visitasDoMunicipio, entidadesDoMunicipio, progressoDoMunicipio),
                complexity: this.calculateComplexity(entidadesDoMunicipio, progressoDoMunicipio),
                priority: this.calculateDynamicPriority(visitasDoMunicipio, entidadesDoMunicipio, progressoDoMunicipio),
                googleMapsData: {
                    distance: route.legs[optimizedSequence.indexOf(municipio)]?.distance?.value || 0,
                    duration: route.legs[optimizedSequence.indexOf(municipio)]?.duration?.value || 0
                }
            };
        });
        
        return this.formatIntelligentRoute(enrichedSequence, criteria);
    }

    // Parsing da Distance Matrix
    parseDistanceMatrix(response) {
        const matrix = { distances: [], durations: [] };
        
        response.rows.forEach((row, i) => {
            matrix.distances[i] = [];
            matrix.durations[i] = [];
            
            row.elements.forEach((element, j) => {
                if (element.status === 'OK') {
                    matrix.distances[i][j] = element.distance.value / 1000; // metros para km
                    matrix.durations[i][j] = element.duration.value / 60; // segundos para minutos
                } else {
                    // Fallback para cálculo haversine
                    const municipioA = Object.keys(this.coordinates)[i];
                    const municipioB = Object.keys(this.coordinates)[j];
                    const distance = this.haversineDistance(
                        this.coordinates[municipioA],
                        this.coordinates[municipioB]
                    );
                    matrix.distances[i][j] = distance;
                    matrix.durations[i][j] = distance * 1.5; // Estimativa
                }
            });
        });
        
        return matrix;
    }

    // Solver TSP com matriz de distâncias
    solveTSPWithMatrix(municipalities, matrix, criteria) {
        const n = municipalities.length;
        const costMatrix = criteria === 'time' ? matrix.durations : matrix.distances;
        
        if (n <= 6) {
            // Solução exata para poucos municípios
            return this.exactTSPWithMatrix(municipalities, costMatrix);
        } else {
            // Heurística para muitos municípios
            return this.heuristicTSPWithMatrix(municipalities, costMatrix);
        }
    }

    exactTSPWithMatrix(municipalities, costMatrix) {
        const n = municipalities.length;
        const dp = Array(1 << n).fill().map(() => Array(n).fill(Infinity));
        const parent = Array(1 << n).fill().map(() => Array(n).fill(-1));
        
        dp[1][0] = 0;
        
        for (let mask = 1; mask < (1 << n); mask++) {
            for (let u = 0; u < n; u++) {
                if (!(mask & (1 << u)) || dp[mask][u] === Infinity) continue;
                
                for (let v = 0; v < n; v++) {
                    if (mask & (1 << v)) continue;
                    
                    const newMask = mask | (1 << v);
                    const newCost = dp[mask][u] + costMatrix[u][v];
                    
                    if (newCost < dp[newMask][v]) {
                        dp[newMask][v] = newCost;
                        parent[newMask][v] = u;
                    }
                }
            }
        }
        
        // Reconstruir caminho
        const finalMask = (1 << n) - 1;
        let minCost = Infinity;
        let lastCity = -1;
        
        for (let i = 1; i < n; i++) {
            const totalCost = dp[finalMask][i] + costMatrix[i][0];
            if (totalCost < minCost) {
                minCost = totalCost;
                lastCity = i;
            }
        }
        
        const path = this.reconstructTSPPath(parent, finalMask, lastCity, n);
        return path.map(index => municipalities[index]);
    }

    reconstructTSPPath(parent, mask, lastCity, n) {
        const path = [];
        let current = lastCity;
        let currentMask = mask;
        
        while (current !== -1) {
            path.unshift(current);
            const prev = parent[currentMask][current];
            currentMask ^= (1 << current);
            current = prev;
        }
        
        return path;
    }

    heuristicTSPWithMatrix(municipalities, costMatrix) {
        const n = municipalities.length;
        const visited = new Array(n).fill(false);
        const path = [0];
        visited[0] = true;
        
        for (let i = 1; i < n; i++) {
            let minCost = Infinity;
            let nextCity = -1;
            
            for (let j = 0; j < n; j++) {
                if (!visited[j] && costMatrix[path[path.length - 1]][j] < minCost) {
                    minCost = costMatrix[path[path.length - 1]][j];
                    nextCity = j;
                }
            }
            
            if (nextCity !== -1) {
                path.push(nextCity);
                visited[nextCity] = true;
            }
        }
        
        return path.map(index => municipalities[index]);
    }
}

// Instância global do otimizador
let routeOptimizer = null;

// Função principal para calcular rota
async function calculateIntelligentRoute() {
    try {
        if (!window.routeOptimizer) {
            window.routeOptimizer = new RouteOptimizerIntelligent();
            await window.routeOptimizer.init();
        }

        const selectedMunicipalities = getSelectedMunicipalities();
        if (selectedMunicipalities.length < 2) {
            showToast('Selecione pelo menos 2 municípios para calcular a rota', 'warning');
            return;
        }

        const criteria = document.querySelector('input[name="route-criteria"]:checked')?.value || 'intelligent';
        
        showToast('Calculando rota inteligente...', 'info');
        
        const result = await window.routeOptimizer.calculateOptimalRoute(selectedMunicipalities, criteria);
        
        if (result.success) {
            // Armazenar resultado globalmente para export/share
            window.currentRouteResult = result;
            
            displayRouteResult(result);
            drawRouteOnMap(result.route);
            showToast(`Rota calculada com sucesso! (Nível ${result.level})`, 'success');
        } else {
            showToast('Erro ao calcular rota', 'error');
        }
        
    } catch (error) {
        console.error('Erro ao calcular rota:', error);
        showToast('Erro ao calcular rota: ' + error.message, 'error');
    }
}

function getSelectedMunicipalities() {
    const checkboxes = document.querySelectorAll('#municipalities-grid input[type="checkbox"]:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

function displayRouteResult(result) {
    const container = document.getElementById('route-result');
    if (!container) return;
    
    const route = result.route;
    
    container.innerHTML = `
        <h6><i class="fas fa-route"></i> ${route.criteriaDescription}</h6>
        
        <div class="route-info-header">
            <div class="start-point-info">
                <i class="fas fa-home"></i>
                <strong>Partida/Retorno:</strong> ${route.startPoint.name}<br>
                <small>${route.startPoint.address}</small>
            </div>
        </div>
        
        <div class="route-summary row">
            <div class="col-6">
                <div class="route-stat">
                    <div class="route-stat-value">${route.summary.totalDistance} km</div>
                    <div class="route-stat-label">Distância Total</div>
                </div>
            </div>
            <div class="col-6">
                <div class="route-stat">
                    <div class="route-stat-value">${Math.round(route.summary.estimatedTime / 60)}h ${route.summary.estimatedTime % 60}min</div>
                    <div class="route-stat-label">Tempo Estimado</div>
                </div>
            </div>
            <div class="col-6">
                <div class="route-stat">
                    <div class="route-stat-value">${route.summary.departureTime}</div>
                    <div class="route-stat-label">Saída</div>
                </div>
            </div>
            <div class="col-6">
                <div class="route-stat">
                    <div class="route-stat-value">${route.summary.estimatedReturn}</div>
                    <div class="route-stat-label">Retorno</div>
                </div>
            </div>
            <div class="col-6">
                <div class="route-stat">
                    <div class="route-stat-value">${route.summary.neverVisited}</div>
                    <div class="route-stat-label">Não Visitados</div>
                </div>
            </div>
            <div class="col-6">
                <div class="route-stat">
                    <div class="route-stat-value">${route.summary.fuelEstimate}L</div>
                    <div class="route-stat-label">Combustível</div>
                </div>
            </div>
        </div>
        
        <div class="sequence-list">
            <h6><i class="fas fa-list-ol"></i> Sequência da Visita</h6>
            
            <!-- Início da rota -->
            <div class="sequence-item start-point">
                <div class="sequence-number">🏠</div>
                <div class="sequence-content">
                    <div class="sequence-municipality">${route.startPoint.name}</div>
                    <div class="sequence-details">Ponto de partida - ${route.summary.departureTime}</div>
                </div>
                <div class="sequence-time">0km</div>
            </div>
            
            ${route.municipalities.map((m, index) => `
                <div class="sequence-item ${m.visitSummary.realizadas === 0 ? 'never-visited' : ''}">
                    <div class="sequence-number">${index + 1}</div>
                    <div class="sequence-content">
                        <div class="sequence-municipality">${m.name}</div>
                        <div class="sequence-details">
                            <div class="details-row">
                                <span class="detail-badge ${m.visitSummary.realizadas === 0 ? 'badge-danger' : 'badge-info'}">
                                    Visitas: ${m.visitSummary.realizadas}/${m.visitSummary.totalVisitas}
                                </span>
                                <span class="detail-badge badge-warning">
                                    P1: ${m.entitySummary.p1Pendentes}
                                </span>
                                <span class="detail-badge badge-secondary">
                                    Urgência: ${m.metrics.urgency}
                                </span>
                            </div>
                            
                            <div class="schedule-info-row" style="margin: 4px 0;">
                                <span class="schedule-badge ${m.scheduleInfo.isOpenOnArrival ? 'badge-success' : 'badge-danger'}">
                                    ${m.scheduleInfo.isOpenOnArrival ? '🟢 Aberto' : '🔴 Fechado'} na chegada
                                </span>
                                ${m.scheduleInfo.scheduledArrival ? `
                                    <span class="schedule-badge badge-info">
                                        📅 ${m.scheduleInfo.scheduledArrival} - ${m.scheduleInfo.scheduledDeparture}
                                    </span>
                                ` : ''}
                                <span class="schedule-badge badge-light">
                                    🏢 ${m.scheduleInfo.timeWindow}
                                </span>
                            </div>
                            
                            <div class="reasons-list">
                                ${m.reasons.map(reason => `<span class="reason-tag">${reason}</span>`).join('')}
                                ${m.scheduleInfo.bestVisitTime ? `
                                    <span class="reason-tag schedule-optimized">
                                        🕐 Melhor dia: ${m.scheduleInfo.bestVisitTime.day} (${m.scheduleInfo.bestVisitTime.openTime} - ${m.scheduleInfo.bestVisitTime.closeTime})
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="sequence-time">
                        ${m.distanceFromStart}km<br>
                        <small>${Math.round((m.complexity || 2) * 60 + 30)}min</small>
                    </div>
                </div>
            `).join('')}
            
            <!-- Retorno -->
            <div class="sequence-item end-point">
                <div class="sequence-number">🏠</div>
                <div class="sequence-content">
                    <div class="sequence-municipality">${route.startPoint.name}</div>
                    <div class="sequence-details">Retorno - ${route.summary.estimatedReturn}</div>
                </div>
                <div class="sequence-time">${route.summary.totalDistance}km</div>
            </div>
        </div>
        
        <div class="route-actions mt-3">
            <button class="btn btn-success btn-sm" onclick="exportRoute()" title="Exportar rota">
                <i class="fas fa-download"></i> Exportar
            </button>
            <button class="btn btn-primary btn-sm" onclick="shareRoute()" title="Compartilhar rota">
                <i class="fas fa-share"></i> Compartilhar
            </button>
            <button class="btn btn-info btn-sm" onclick="addToCalendar()" title="Adicionar ao calendário">
                <i class="fas fa-calendar-plus"></i> Calendário
            </button>
        </div>
    `;
    
    container.style.display = 'block';
}

// Desenhar rota no mapa
function drawRouteOnMap(route) {
    if (!mapa) return;
    
    // Limpar rotas anteriores
    mapa.eachLayer(layer => {
        if (layer instanceof L.Polyline || (layer instanceof L.Marker && layer.options.isRouteMarker)) {
            mapa.removeLayer(layer);
        }
    });
    
    // Adicionar marcador do ponto de partida/retorno (IBGE)
    const startIcon = L.divIcon({
        html: `
            <div class="route-start-marker" style="background: #28a745; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 0 20px rgba(40, 167, 69, 0.8);">
                🏠
            </div>
        `,
        className: 'route-start-container',
        iconSize: [40, 40],
        iconAnchor: [20, 20]
    });
    
    L.marker([route.startPoint.lat, route.startPoint.lng], { 
        icon: startIcon,
        isRouteMarker: true
    }).addTo(mapa)
    .bindPopup(`
        <div class="route-popup">
            <h6><i class="fas fa-home"></i> ${route.startPoint.name}</h6>
            <p><strong>Endereço:</strong> ${route.startPoint.address}</p>
            <p><strong>Saída:</strong> ${route.summary.departureTime}</p>
            <p><strong>Retorno:</strong> ${route.summary.estimatedReturn}</p>
        </div>
    `);
    
    // Criar coordenadas da rota COMPLETA (incluindo partida e retorno)
    const fullRouteCoordinates = [
        [route.startPoint.lat, route.startPoint.lng], // Partida do IBGE
        ...route.municipalities.map(m => [m.coordinates.lat, m.coordinates.lng]), // Municípios
        [route.startPoint.lat, route.startPoint.lng] // Retorno ao IBGE
    ];
    
    // Desenhar linha da rota completa
    const routeLine = L.polyline(fullRouteCoordinates, {
        color: '#6EE7B7',
        weight: 4,
        opacity: 0.8,
        dashArray: '10, 5'
    }).addTo(mapa);
    
    // Adicionar marcadores numerados
    route.municipalities.forEach((municipality, index) => {
        const icon = L.divIcon({
            html: `
                <div class="route-marker ${municipality.visitSummary.realizadas === 0 ? 'never-visited' : ''}" 
                     style="background-color: ${getUrgencyColor(municipality.metrics.urgency)}">
                    <span class="route-number">${index + 1}</span>
                    <div class="route-tooltip">
                        <strong>${municipality.name}</strong><br>
                        Urgência: ${municipality.metrics.urgency}<br>
                        Visitas: ${municipality.visitSummary.realizadas}/${municipality.visitSummary.totalVisitas}<br>
                        P1 Pendentes: ${municipality.entitySummary.p1Pendentes}
                    </div>
                </div>
            `,
            className: 'route-marker-container',
            iconSize: [40, 40],
            iconAnchor: [20, 20]
        });
        
        L.marker([municipality.coordinates.lat, municipality.coordinates.lng], { icon })
            .addTo(mapa)
            .bindPopup(`
                <div class="route-popup">
                    <h6>${municipality.name}</h6>
                    <div class="route-popup-stats">
                        <div class="stat-item">
                            <span class="stat-label">Visitas:</span>
                            <span class="stat-value">${municipality.visitSummary.realizadas}/${municipality.visitSummary.totalVisitas}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Urgência:</span>
                            <span class="stat-value urgency-${Math.round(municipality.metrics.urgency / 25)}">${municipality.metrics.urgency}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">P1 Pendentes:</span>
                            <span class="stat-value">${municipality.entitySummary.p1Pendentes}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Dias sem visita:</span>
                            <span class="stat-value">${municipality.visitSummary.diasSemVisita === 999 ? 'Nunca' : municipality.visitSummary.diasSemVisita}</span>
                        </div>
                    </div>
                </div>
            `);
    });
    
    // Ajustar zoom para mostrar toda a rota
    mapa.fitBounds(routeLine.getBounds(), { padding: [20, 20] });
}

function getUrgencyColor(urgency) {
    if (urgency >= 75) return '#dc3545'; // Vermelho - Urgência crítica
    if (urgency >= 50) return '#fd7e14'; // Laranja - Urgência alta
    if (urgency >= 25) return '#ffc107'; // Amarelo - Urgência média
    return '#28a745'; // Verde - Urgência baixa
}

// Exportar rota
function exportRoute() {
    const result = window.currentRouteResult;
    if (!result) {
        showToast('Nenhuma rota para exportar', 'warning');
        return;
    }
    
    const exportData = {
        timestamp: new Date().toISOString(),
        metadata: {
            level: result.level,
            apiUsed: result.apiUsed,
            criteria: result.route.criteria,
            calculatedAt: result.route.timestamp
        },
        route: {
            sequence: result.route.sequence,
            summary: result.route.summary,
            municipalities: result.route.municipalities.map(m => ({
                name: m.name,
                coordinates: m.coordinates,
                visitSummary: m.visitSummary,
                entitySummary: m.entitySummary,
                metrics: m.metrics
            }))
        }
    };
    
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.download = `rota_pnsb_${new Date().toISOString().split('T')[0]}.json`;
    link.href = url;
    link.click();
    URL.revokeObjectURL(url);
    
    showToast('Rota exportada com sucesso!', 'success');
}

// Compartilhar rota
function shareRoute() {
    const result = window.currentRouteResult;
    if (!result) {
        showToast('Nenhuma rota para compartilhar', 'warning');
        return;
    }
    
    const shareText = `🗺️ Rota PNSB Otimizada (Nível ${result.level})
    
📊 Resumo:
• ${result.route.summary.totalMunicipalities} municípios
• ${result.route.summary.totalDistance} km
• ${Math.round(result.route.summary.estimatedTime / 60)}h estimadas
• ${result.route.summary.neverVisited} nunca visitados
• Urgência média: ${result.route.summary.avgUrgency}

📍 Sequência:
${result.route.sequence.map((m, i) => `${i + 1}. ${m}`).join('\n')}

🔧 Critério: ${result.route.criteria}
⏰ Calculado: ${new Date(result.route.timestamp).toLocaleString()}`;
    
    if (navigator.share) {
        navigator.share({
            title: 'Rota PNSB Otimizada',
            text: shareText,
            url: window.location.href
        });
    } else {
        navigator.clipboard.writeText(shareText).then(() => {
            showToast('Rota copiada para área de transferência!', 'success');
        });
    }
}

// Adicionar ao calendário

// Sistema de notificações (toast)
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    
    const icons = {
        success: 'fas fa-check-circle',
        error: 'fas fa-exclamation-triangle',
        warning: 'fas fa-exclamation-circle',
        info: 'fas fa-info-circle'
    };
    
    // Security: Use safe DOM manipulation instead of innerHTML
    const icon = document.createElement('i');
    icon.className = icons[type];
    
    const span = document.createElement('span');
    span.textContent = message; // Safe text insertion
    
    toast.appendChild(icon);
    toast.appendChild(span);
    
    document.body.appendChild(toast);
    
    // Animação de entrada
    setTimeout(() => toast.classList.add('show'), 100);
    
    // Remover após 4 segundos
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => document.body.removeChild(toast), 300);
    }, 4000);
}

// Atualizar seleção de municípios
function updateMunicipalitySelection() {
    const checkboxes = document.querySelectorAll('#municipalities-grid input[type="checkbox"]:checked');
    const count = checkboxes.length;
    
    const button = document.getElementById('calculate-route-btn');
    if (button) {
        button.textContent = `Calcular Rota Inteligente (${count} selecionados)`;
        button.disabled = count < 2;
    }
    
    // Atualizar preview da seleção
    const preview = document.getElementById('selection-preview');
    if (preview) {
        // Security: Use safe DOM manipulation
        preview.innerHTML = '';
        const small = document.createElement('small');
        
        if (count === 0) {
            small.className = 'text-muted';
            small.textContent = 'Nenhum município selecionado';
        } else {
            const selected = Array.from(checkboxes).map(cb => cb.value);
            small.className = 'text-light';
            small.textContent = `Selecionados: ${selected.join(', ')}`;
        }
        
        preview.appendChild(small);
    }
}

// Master initialization function
async function initializeMapProgressSystem() {
    console.log('🚀 DOM carregado - Iniciando Sistema PNSB completo');
    
    // Verify required libraries are loaded
    const requirements = {
        leaflet: typeof L !== 'undefined',
        chart: typeof Chart !== 'undefined',
        bootstrap: typeof bootstrap !== 'undefined' || typeof window.bootstrap !== 'undefined'
    };
    
    console.log('📋 Verificação de dependências:', requirements);
    
    if (!requirements.leaflet) {
        console.error('❌ Leaflet não carregado');
        showToast('Erro: Biblioteca de mapas não carregada', 'error');
        return;
    }
    
    try {
        // Initialize PNSB system with await
        await inicializarSistemaPNSB();
        
        // Inicializar sistema de alertas
        inicializarSistemaAlertas();
        
        // Initialize new structure immediately
        initializeNewStructure();
        
        // Dashboard initialization is now handled in inicializarSistemaPNSB()
        console.log('🎯 Dashboard será inicializado via inicializarSistemaPNSB...');
        
        // Initialize route optimizer with safety check
        setTimeout(() => {
            console.log('🛣️ Inicializando otimizador de rotas...');
            try {
                if (typeof RouteOptimizerIntelligent !== 'undefined') {
                    window.routeOptimizer = new RouteOptimizerIntelligent();
                    console.log('✅ Otimizador de rotas inicializado');
                } else {
                    console.warn('⚠️ RouteOptimizerIntelligent não disponível');
                }
            } catch (error) {
                console.error('❌ Erro ao inicializar otimizador:', error);
            }
            
            // Update new structure data after all initializations
            setTimeout(() => {
                updateMiniDashboard();
                updateEssentialKPIs();
                updateMunicipalitiesList();
                console.log('✅ Nova estrutura atualizada com dados iniciais');
            }, 500);
            
        }, 2000);
        
        showToast('Sistema PNSB 2024 reorganizado inicializado com sucesso!', 'success');
        
    } catch (error) {
        console.error('❌ Erro na inicialização do sistema:', error);
        showToast('Erro na inicialização do sistema', 'error');
    }
}

// Single DOMContentLoaded listener
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeMapProgressSystem);
} else {
    initializeMapProgressSystem();
}

// ====================================
// FUNCIONALIDADES DE ROTAS OTIMIZADAS
// ====================================

// Calcular rota otimizada usando Google Maps API
async function calcularRotaOtimizada() {
    const checkboxes = document.querySelectorAll('#municipalities-grid input[type="checkbox"]:checked');
    const municipiosSelecionados = Array.from(checkboxes).map(cb => cb.value);
    
    if (municipiosSelecionados.length < 2) {
        showToast('Selecione pelo menos 2 municípios para calcular a rota', 'warning');
        return;
    }
    
    const pontoOrigem = document.getElementById('route-origin')?.value || 'Florianópolis, SC';
    const dataVisita = document.getElementById('route-date')?.value;
    const criterio = document.querySelector('input[name="optimization-criteria"]:checked')?.value || 'distance';
    
    showToast('Calculando rota otimizada...', 'info');
    
    try {
        // Chamar API real do Google Maps em produção
        const rota = await simularCalculoRota(municipiosSelecionados, pontoOrigem, criterio);
        
        if (rota) {
            exibirRotaCalculada(rota);
            desenharRotaNoMapa(rota);
            showToast('Rota otimizada calculada com sucesso!', 'success');
        }
        
    } catch (error) {
        console.error('Erro ao calcular rota:', error);
        showToast('Erro ao calcular rota. Tente novamente.', 'error');
    }
}

// Simulação de cálculo de rota (substituir por Google Maps API)
async function simularCalculoRota(municipios, origem, criterio) {
    return new Promise((resolve) => {
        setTimeout(() => {
            const rotaOtimizada = otimizarSequenciaMunicipios(municipios, criterio);
            const distanciaTotal = calcularDistanciaTotal(rotaOtimizada);
            const tempoTotal = Math.floor(distanciaTotal * 1.2); // ~1.2 min por km
            const eficiencia = calcularEficienciaRota(rotaOtimizada);
            
            resolve({
                sequencia: rotaOtimizada,
                distancia: distanciaTotal,
                tempo: tempoTotal,
                eficiencia: eficiencia,
                criterio: criterio,
                origem: origem,
                data: new Date().toISOString()
            });
        }, 2000);
    });
}

// Otimizar sequência de municípios
function otimizarSequenciaMunicipios(municipios, criterio) {
    // Coordenadas aproximadas dos municípios de SC
    const coordenadas = {
        'Balneário Camboriú': {lat: -26.9908, lng: -48.6354},
        'Balneário Piçarras': {lat: -26.7544, lng: -48.6719},
        'Bombinhas': {lat: -27.1486, lng: -48.4814},
        'Camboriú': {lat: -27.0231, lng: -48.6556},
        'Itajaí': {lat: -26.9076, lng: -48.6646},
        'Itapema': {lat: -27.0897, lng: -48.6131},
        'Luiz Alves': {lat: -26.7139, lng: -48.9331},
        'Navegantes': {lat: -26.8986, lng: -48.6558},
        'Penha': {lat: -26.7711, lng: -48.6467},
        'Porto Belo': {lat: -27.1581, lng: -48.5503},
        'Ilhota': {lat: -26.8983, lng: -48.8322}
    };
    
    // Algoritmo simples de vizinho mais próximo
    let rotaFinal = [];
    let municipiosRestantes = [...municipios];
    let atual = municipiosRestantes.shift(); // Começar pelo primeiro
    rotaFinal.push(atual);
    
    while (municipiosRestantes.length > 0) {
        let proximo = null;
        let menorDistancia = Infinity;
        
        municipiosRestantes.forEach(municipio => {
            const distancia = calcularDistancia(
                coordenadas[atual], 
                coordenadas[municipio]
            );
            
            if (distancia < menorDistancia) {
                menorDistancia = distancia;
                proximo = municipio;
            }
        });
        
        rotaFinal.push(proximo);
        municipiosRestantes = municipiosRestantes.filter(m => m !== proximo);
        atual = proximo;
    }
    
    return rotaFinal;
}

// Calcular distância entre dois pontos (fórmula de Haversine)
function calcularDistancia(ponto1, ponto2) {
    const R = 6371; // Raio da Terra em km
    const dLat = (ponto2.lat - ponto1.lat) * Math.PI / 180;
    const dLng = (ponto2.lng - ponto1.lng) * Math.PI / 180;
    
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(ponto1.lat * Math.PI / 180) * Math.cos(ponto2.lat * Math.PI / 180) *
              Math.sin(dLng/2) * Math.sin(dLng/2);
    
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

// Calcular distância total da rota
function calcularDistanciaTotal(rota) {
    // Simplificação: estimar baseado no número de municípios
    return rota.length * 25; // ~25km média entre municípios
}

// Calcular eficiência da rota
function calcularEficienciaRota(rota) {
    return Math.min(95, 60 + (rota.length * 5)); // Eficiência baseada na otimização
}

// Exibir rota calculada
function exibirRotaCalculada(rota) {
    const resultContainer = document.getElementById('route-result');
    if (!resultContainer) return;
    
    // Atualizar estatísticas
    document.getElementById('route-distance').textContent = `${rota.distancia} km`;
    document.getElementById('route-duration').textContent = `${Math.floor(rota.tempo / 60)}h ${rota.tempo % 60}min`;
    document.getElementById('route-municipalities').textContent = rota.sequencia.length;
    document.getElementById('route-efficiency').textContent = `${rota.eficiencia}%`;
    
    // Atualizar sequência
    const sequenceContainer = document.getElementById('sequence-list');
    if (sequenceContainer) {
        sequenceContainer.innerHTML = rota.sequencia.map((municipio, index) => `
            <div class="sequence-item">
                <span class="sequence-number">${index + 1}</span>
                <span class="sequence-municipality">${municipio}</span>
            </div>
        `).join('');
    }
    
    resultContainer.style.display = 'block';
}

// Desenhar rota no mapa
function desenharRotaNoMapa(rota) {
    if (!mapa) return;
    
    // Coordenadas dos municípios
    const coordenadas = {
        'Balneário Camboriú': [-26.9908, -48.6354],
        'Balneário Piçarras': [-26.7544, -48.6719],
        'Bombinhas': [-27.1486, -48.4814],
        'Camboriú': [-27.0231, -48.6556],
        'Itajaí': [-26.9076, -48.6646],
        'Itapema': [-27.0897, -48.6131],
        'Luiz Alves': [-26.7139, -48.9331],
        'Navegantes': [-26.8986, -48.6558],
        'Penha': [-26.7711, -48.6467],
        'Porto Belo': [-27.1581, -48.5503],
        'Ilhota': [-26.8983, -48.8322]
    };
    
    // Criar linha da rota
    const pontos = rota.sequencia.map(municipio => coordenadas[municipio]);
    
    if (window.rotaLine) {
        mapa.removeLayer(window.rotaLine);
    }
    
    window.rotaLine = L.polyline(pontos, {
        color: '#5F5CFF',
        weight: 4,
        opacity: 0.8
    }).addTo(mapa);
    
    // Ajustar visualização do mapa
    mapa.fitBounds(window.rotaLine.getBounds(), {padding: [20, 20]});
}

// Exportar rota
function exportarRota() {
    showToast('Exportando rota...', 'info');
    
    if (!window.currentRouteResult) {
        showToast('Nenhuma rota calculada para exportar', 'warning');
        return;
    }
    
    const data = {
        route: window.currentRouteResult,
        exported_at: new Date().toISOString(),
        project: 'PNSB 2024 - Santa Catarina'
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `rota_pnsb_${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast('Rota exportada com sucesso!', 'success');
}

// Simular tempo
function simularTempo() {
    showToast('Simulando tempo de viagem...', 'info');
    
    if (!window.currentRouteResult) {
        showToast('Calcule uma rota primeiro', 'warning');
        return;
    }
    
    const route = window.currentRouteResult.route;
    const totalTime = route.summary.estimatedTime;
    const municipalities = route.municipalities.length;
    
    const simulation = {
        total_time: totalTime,
        municipalities_count: municipalities,
        average_per_municipality: Math.round(totalTime / municipalities),
        travel_time: Math.round(totalTime * 0.4),
        work_time: Math.round(totalTime * 0.6),
        breaks_suggested: Math.ceil(municipalities / 3),
        fuel_cost_estimate: `R$ ${(route.summary.fuelEstimate * 5.5).toFixed(2)}`,
        best_departure_time: route.summary.departureTime,
        weather_consideration: 'Verificar previsão do tempo no dia da visita'
    };
    
    console.log('🕐 Simulação de Tempo:', simulation);
    showToast(`Tempo estimado: ${Math.floor(totalTime/60)}h ${totalTime%60}min para ${municipalities} municípios`, 'success');
}

// Alternar otimizador de rotas
function toggleRouteOptimizer() {
    const panel = document.getElementById('route-optimizer-panel');
    if (panel) {
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }
}

// ====================================
// MISSING FUNCTIONS - Dashboard Controls
// ====================================

// ====================================
// NOVA ESTRUTURA: Sistema de Tabs e Layout Inteligente
// ====================================

// Toggle view mode between map and list
function toggleViewMode() {
    const mainSection = document.getElementById('main-section');
    const sidebarCompact = document.getElementById('sidebar-compact');
    
    if (mainSection && sidebarCompact) {
        const isCompact = sidebarCompact.style.display !== 'none';
        
        if (isCompact) {
            // Expandir para vista completa
            sidebarCompact.style.display = 'none';
            mainSection.style.flexDirection = 'column';
            showToast('Vista expandida ativada', 'info');
        } else {
            // Voltar para vista compacta
            sidebarCompact.style.display = 'flex';
            mainSection.style.flexDirection = 'row';
            showToast('Vista compacta ativada', 'info');
        }
    }
}

// Open advanced section with specific tab
function openAdvancedTab(tabName) {
    const advancedSection = document.getElementById('advanced-section');
    if (advancedSection) {
        advancedSection.classList.add('open');
        switchTab(tabName);
        showToast(`Abrindo ${getTabDisplayName(tabName)}`, 'info');
    }
}

// Close advanced section
function closeAdvancedSection() {
    const advancedSection = document.getElementById('advanced-section');
    if (advancedSection) {
        advancedSection.classList.remove('open');
        showToast('Seção avançada fechada', 'info');
    }
}

// Switch between tabs
function switchTab(tabName) {
    // Remove active class from all tabs and panes
    const allTabBtns = document.querySelectorAll('.tab-btn');
    const allTabPanes = document.querySelectorAll('.tab-pane');
    
    allTabBtns.forEach(btn => btn.classList.remove('active'));
    allTabPanes.forEach(pane => pane.classList.remove('active'));
    
    // Add active class to selected tab and pane
    const selectedTabBtn = document.querySelector(`[data-tab="${tabName}"]`);
    const selectedTabPane = document.getElementById(`tab-${tabName}`);
    
    if (selectedTabBtn && selectedTabPane) {
        selectedTabBtn.classList.add('active');
        selectedTabPane.classList.add('active');
        
        // Trigger tab-specific initialization
        initializeTabContent(tabName);
    }
}

// Initialize content for specific tab
function initializeTabContent(tabName) {
    switch(tabName) {
        case 'dashboard':
            // Recarregar dados do dashboard executivo
            if (typeof carregarDadosProgresso === 'function') {
                carregarDadosProgresso();
            }
            break;
        case 'routes':
            // Inicializar otimizador de rotas
            initializeRouteOptimizer();
            break;
        case 'list':
            // Atualizar vista em lista
            updateListView();
            break;
        case 'reports':
            // Inicializar relatórios
            initializeReports();
            break;
    }
}

// Get display name for tab
function getTabDisplayName(tabName) {
    const names = {
        dashboard: 'Dashboard Executivo',
        routes: 'Otimizador de Rotas',
        list: 'Vista Detalhada',
        reports: 'Relatórios'
    };
    return names[tabName] || tabName;
}

// Initialize route optimizer in tab
function initializeRouteOptimizer() {
    const municipalitiesGrid = document.getElementById('municipalities-grid');
    if (municipalitiesGrid && typeof popularGridMunicipios === 'function') {
        popularGridMunicipios();
    }
    
    // Set default date
    const routeDate = document.getElementById('route-date');
    if (routeDate) {
        const today = new Date();
        routeDate.value = today.toISOString().split('T')[0];
    }
}

// Update list view content
function updateListView() {
    const listViewContent = document.getElementById('list-view-content');
    if (listViewContent && typeof atualizarVistaLista === 'function') {
        // Redirecionar o conteúdo da lista antiga para a nova estrutura
        const oldListView = document.getElementById('list-view');
        if (oldListView) {
            listViewContent.innerHTML = oldListView.innerHTML;
        }
        atualizarVistaLista();
    }
}

// Initialize reports section
function initializeReports() {
    console.log('🔧 Inicializando seção de relatórios...');
    // Aqui pode ser implementada lógica específica para relatórios
}

// Update mini dashboard
function updateMiniDashboard() {
    const miniTotal = document.getElementById('mini-total');
    const miniConcluidos = document.getElementById('mini-concluidos');
    const miniProgresso = document.getElementById('mini-progresso');
    
    if (dadosProgresso && miniTotal && miniConcluidos && miniProgresso) {
        const total = 11; // 11 municípios
        const concluidos = dadosProgresso.municipios_finalizados || 0;
        const progresso = Math.round((concluidos / total) * 100);
        
        miniTotal.textContent = total;
        miniConcluidos.textContent = concluidos;
        miniProgresso.textContent = `${progresso}%`;
    }
}

// Update KPIs essenciais
function updateEssentialKPIs() {
    console.log('🎯 Atualizando KPIs essenciais...', dadosProgresso);
    
    const kpiMRS = document.getElementById('kpi-mrs');
    const kpiMAP = document.getElementById('kpi-map');
    const kpiVisits = document.getElementById('kpi-visits');
    const kpiEntities = document.getElementById('kpi-entities');
    
    if (dadosProgresso) {
        // Calcular MRS e MAP baseado nos dados inteligentes
        const estatisticasInteligentes = dadosProgresso.estatisticas_inteligentes || {};
        const questionarios = estatisticasInteligentes.questionnaire_completion || {};
        
        // Calcular progresso MRS e MAP
        const mrsValidados = questionarios.mrs?.validado || 0;
        const mrsRespondidos = questionarios.mrs?.respondido || 0;
        const mapValidados = questionarios.map?.validado || 0;
        const mapRespondidos = questionarios.map?.respondido || 0;
        const totalVisitas = estatisticasInteligentes.total_visitas || 1;
        
        const progressoMRS = totalVisitas > 0 ? Math.round((mrsValidados / totalVisitas) * 100) : 0;
        const progressoMAP = totalVisitas > 0 ? Math.round((mapValidados / totalVisitas) * 100) : 0;
        
        // Contar total de entidades dos municípios  
        let totalEntidades = 0;
        if (dadosProgresso.municipios) {
            Object.values(dadosProgresso.municipios).forEach(municipio => {
                // API retorna entidades em municipio.entidades (contagem por tipo)
                totalEntidades += Object.values(municipio.entidades || {}).reduce((sum, count) => sum + count, 0);
            });
        }
        
        console.log('📊 KPIs calculados:', {
            progressoMRS,
            progressoMAP,
            totalVisitas,
            totalEntidades,
            estatisticasInteligentes
        });
        
        // Atualizar os KPIs
        if (kpiMRS) kpiMRS.textContent = `${progressoMRS}%`;
        if (kpiMAP) kpiMAP.textContent = `${progressoMAP}%`;
        if (kpiVisits) kpiVisits.textContent = totalVisitas || '--';
        if (kpiEntities) kpiEntities.textContent = totalEntidades || '--';
        
        console.log('✅ KPIs essenciais atualizados');
    } else {
        console.warn('⚠️ dadosProgresso não disponível para KPIs');
    }
}

// Update municipalities summary list
function updateMunicipalitiesList() {
    const municipalitiesList = document.getElementById('municipalities-summary-list');
    if (!municipalitiesList || !dadosProgresso) return;
    
    const municipios = dadosProgresso.municipios || {};
    const municipiosArray = Object.entries(municipios).slice(0, 5); // Mostrar apenas 5
    
    municipalitiesList.innerHTML = municipiosArray.map(([nome, dados]) => {
        const status = dados.status || 'pendente';
        const statusIcon = getStatusIcon(status);
        const statusClass = getStatusClass(status);
        
        return `
            <div class="municipality-item ${statusClass}" onclick="focusOnMunicipality('${nome}')">
                <span class="municipality-icon">${statusIcon}</span>
                <span class="municipality-name">${nome}</span>
                <span class="municipality-progress">${dados.progresso || 0}%</span>
            </div>
        `;
    }).join('');
}

// Get status icon for municipality
function getStatusIcon(status) {
    const icons = {
        'concluido': '✅',
        'em_andamento': '🔄',
        'agendado': '📅',
        'pendente': '⏳',
        'atrasado': '⚠️'
    };
    return icons[status] || '📍';
}

// Get status class for municipality
function getStatusClass(status) {
    return status.replace('_', '-');
}

// Focus on specific municipality in map
function focusOnMunicipality(municipio) {
    if (window.mapa && typeof centralizarNoMunicipio === 'function') {
        centralizarNoMunicipio(municipio);
        showToast(`Focalizando em ${municipio}`, 'info');
    }
}

// Update last update time
function updateLastUpdateTime() {
    const lastUpdate = document.getElementById('last-update');
    if (lastUpdate) {
        const now = new Date();
        lastUpdate.textContent = `Última atualização: ${now.toLocaleTimeString('pt-BR')}`;
    }
}

// Apply filters from quick filters
function applyQuickFilter(filterType) {
    // Remove active class from all filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
    
    // Add active class to clicked button
    const clickedBtn = document.querySelector(`[data-filter="${filterType}"]`);
    if (clickedBtn) {
        clickedBtn.classList.add('active');
    }
    
    // Apply filter logic
    if (typeof aplicarFiltros === 'function') {
        aplicarFiltros(filterType);
    }
    
    showToast(`Filtro aplicado: ${getFilterDisplayName(filterType)}`, 'info');
}

// Get display name for filter
function getFilterDisplayName(filterType) {
    const names = {
        all: 'Todos',
        p1: 'P1 - Críticos',
        p2: 'P2 - Importantes', 
        p3: 'P3 - Opcionais'
    };
    return names[filterType] || filterType;
}

// Enhanced initialization for new structure
function initializeNewStructure() {
    console.log('🚀 Inicializando nova estrutura do mapa de progresso...');
    
    // Setup filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const filter = this.getAttribute('data-filter');
            applyQuickFilter(filter);
        });
    });
    
    // Initialize mini dashboard and KPIs
    updateMiniDashboard();
    updateEssentialKPIs();
    updateMunicipalitiesList();
    updateLastUpdateTime();
    
    // Update data every 30 seconds
    setInterval(() => {
        updateLastUpdateTime();
        updateMiniDashboard();
        updateEssentialKPIs();
    }, 30000);
    
    console.log('✅ Nova estrutura inicializada com sucesso');
}

// Legacy function for compatibility
function toggleDashboardPNSB() {
    openAdvancedTab('dashboard');
}

// Center map on Santa Catarina
function centralizarMapa() {
    if (window.mapa) {
        // Coordenadas centrais de Santa Catarina (aproximadamente)
        const centerSC = [-27.2423, -48.8100];
        window.mapa.setView(centerSC, 9);
        showToast('Mapa centralizado em Santa Catarina', 'info');
    }
}

// Toggle fullscreen mode
function toggleFullscreen() {
    const mapContainer = document.getElementById('mapa-progresso');
    if (!mapContainer) return;
    
    if (!document.fullscreenElement) {
        mapContainer.requestFullscreen().then(() => {
            showToast('Modo tela cheia ativado', 'info');
        }).catch(() => {
            showToast('Erro ao ativar tela cheia', 'error');
        });
    } else {
        document.exitFullscreen().then(() => {
            showToast('Modo tela cheia desativado', 'info');
        });
    }
}

// Export map as image
function exportarImagem() {
    if (!window.mapa) {
        showToast('Mapa não carregado', 'warning');
        return;
    }
    
    showToast('Exportando imagem do mapa...', 'info');
    
    // Try to use leaflet-image if available
    if (typeof leafletImage !== 'undefined') {
        leafletImage(window.mapa, function(err, canvas) {
            if (err) {
                showToast('Erro ao exportar imagem', 'error');
                return;
            }
            
            const link = document.createElement('a');
            link.download = `mapa_pnsb_${new Date().toISOString().slice(0, 10)}.png`;
            link.href = canvas.toDataURL();
            link.click();
            
            showToast('Imagem exportada com sucesso!', 'success');
        });
    } else {
        // Fallback: basic screenshot instructions
        showToast('Use Print Screen para capturar o mapa', 'info');
    }
}

// Toggle measure mode
function toggleMeasureMode() {
    showToast('Modo de medição - clique no mapa para medir distâncias', 'info');
    
    if (!window.mapa) return;
    
    // Simple distance measurement between clicks
    let measuring = false;
    let startPoint = null;
    
    window.mapa.on('click', function(e) {
        if (!measuring) {
            startPoint = e.latlng;
            measuring = true;
            showToast('Clique no segundo ponto para medir distância', 'info');
        } else {
            const distance = startPoint.distanceTo(e.latlng);
            const distanceKm = (distance / 1000).toFixed(2);
            showToast(`Distância: ${distanceKm} km`, 'success');
            measuring = false;
            startPoint = null;
        }
    });
}

// Clear filters function
function limparFiltros() {
    const selects = document.querySelectorAll('#filtro-tipo, #filtro-municipio, #filtro-status');
    selects.forEach(select => select.value = '');
    
    // Reset dashboard filters
    const filterBtns = document.querySelectorAll('.filter-btn');
    filterBtns.forEach(btn => btn.classList.remove('active'));
    document.querySelector('.filter-btn[data-filter="all"]')?.classList.add('active');
    
    // Reload data
    carregarDadosProgresso();
    showToast('Filtros limpos', 'success');
}

// Toggle dashboard view mode
function toggleDashboardView() {
    const dashboard = document.getElementById('dashboardPNSBExecutivo');
    const button = document.getElementById('dashboard-view-text');
    
    if (dashboard && button) {
        const isExpanded = dashboard.classList.contains('expanded');
        
        if (isExpanded) {
            dashboard.classList.remove('expanded');
            button.textContent = 'Expandir';
        } else {
            dashboard.classList.add('expanded');
            button.textContent = 'Compactar';
        }
        
        showToast(isExpanded ? 'Dashboard compactado' : 'Dashboard expandido', 'info');
    }
}

// ====================================
// SISTEMA DE FILTROS AVANÇADOS
// ====================================

// Alternar visualização dos filtros
// Filtros simplificados - funções de range e toggle removidas por serem desnecessárias

// Aplicar filtros aos dados
function aplicarFiltros() {
    console.log('🔍 Aplicando filtros...');
    
    const filtros = obterFiltrosAtivos();
    const dadosFiltrados = filtrarDados(dadosProgresso.municipios || {}, filtros);
    
    // Atualizar visualização com dados filtrados
    atualizarVisualizacaoComFiltros(dadosFiltrados);
    
    showToast('Filtros aplicados', 'info');
}

// Obter filtros ativos (apenas os 3 essenciais)
function obterFiltrosAtivos() {
    return {
        tipo: document.getElementById('filtro-tipo')?.value || '',
        status: document.getElementById('filtro-status')?.value || '',
        municipio: document.getElementById('filtro-municipio')?.value || ''
    };
}

// Filtrar dados segundo critérios
function filtrarDados(municipios, filtros) {
    const resultado = {};
    
    MUNICIPIOS_PNSB.forEach(municipio => {
        const dados = municipios[municipio] || {
            status: 'agendada',
            progresso: 0,
            tipo_pesquisa: ['MRS', 'MAP'],
            prioridade: 'media',
            visitas: 0
        };
        
        // Aplicar filtros
        if (!passaNofiltro(municipio, dados, filtros)) return;
        
        resultado[municipio] = dados;
    });
    
    return resultado;
}

// Verificar se município passa nos filtros (apenas os 3 essenciais)
function passaNofiltro(municipio, dados, filtros) {
    // Filtro por tipo de pesquisa
    if (filtros.tipo && !dados.tipo_pesquisa?.includes(filtros.tipo)) return false;
    
    // Filtro por status
    if (filtros.status && dados.status !== filtros.status) return false;
    
    // Filtro por município específico
    if (filtros.municipio && municipio !== filtros.municipio) return false;
    
    return true;
}

// Atualizar visualização com dados filtrados
function atualizarVisualizacaoComFiltros(dadosFiltrados) {
    // Atualizar mapa
    if (mapa) {
        // Limpar marcadores existentes
        Object.values(marcadores).forEach(marker => mapa.removeLayer(marker));
        marcadores = {};
        
        // Adicionar apenas municípios filtrados
        Object.entries(dadosFiltrados).forEach(([municipio, dados]) => {
            if (dados.coords && Array.isArray(dados.coords) && dados.coords.length === 2) {
                const marker = L.marker([dados.coords[0], dados.coords[1]])
                    .bindPopup(`
                        <strong>${municipio}</strong><br>
                        Status: ${dados.status || 'Pendente'}<br>
                        Progresso: ${dados.progresso || 0}%
                    `)
                    .addTo(mapa);
                
                marcadores[municipio] = marker;
            }
        });
    }
    
    // Atualizar vista em lista se ativa
    if (currentView === 'list') {
        atualizarVistaListaFiltrada(dadosFiltrados);
    }
    
    // Atualizar estatísticas
    atualizarEstatisticasFiltradas(dadosFiltrados);
}

// Atualizar vista lista com filtros
function atualizarVistaListaFiltrada(dadosFiltrados) {
    const container = document.getElementById('list-view');
    if (!container) return;
    
    let html = '';
    Object.entries(dadosFiltrados).forEach(([municipio, dados]) => {
        const dadosInteligentes = obterDadosInteligentes(municipio);
        
        html += `
            <div class="col-md-6 mb-3">
                <div class="progress-card">
                    <div class="progress-header">
                        <div class="municipality-name">${municipio}</div>
                        <div class="dual-status">
                            <span class="progress-status status-${dados.status || 'pending'}">
                                ${dados.status || 'Pendente'}
                            </span>
                            <span class="intelligent-status-badge ${dadosInteligentes.status_inteligente.replace(/\s+/g, '-').toLowerCase()}">
                                ${dadosInteligentes.status_inteligente.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                            </span>
                        </div>
                    </div>
                    <div class="progress-details">
                        <div class="detail-item">
                            <div class="detail-value">${dados.progresso || 0}%</div>
                            <div class="detail-label">Progresso</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-value">${dadosInteligentes.total_visitas}</div>
                            <div class="detail-label">Visitas</div>
                        </div>
                    </div>
                    ${gerarHtmlStatusInteligente(dadosInteligentes)}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html || '<p class="text-center text-light">Nenhum município encontrado com os filtros aplicados.</p>';
}

// Atualizar estatísticas considerando filtros
function atualizarEstatisticasFiltradas(dadosFiltrados) {
    let finalizados = 0;
    let mrs = 0;
    let map = 0;
    let visitados = 0;
    let progressoTotal = 0;
    
    Object.values(dadosFiltrados).forEach(dados => {
        if (dados.status === 'finalizada') finalizados++;
        if (dados.status !== 'agendada') visitados++;
        if (dados.mrs_coletado) mrs++;
        if (dados.map_coletado) map++;
        progressoTotal += dados.progresso || 0;
    });
    
    const total = Object.keys(dadosFiltrados).length;
    const progresso = total > 0 ? Math.round(progressoTotal / total) : 0;
    
    // Atualizar elementos com sufixo para indicar filtros ativos
    const sufixo = total < MUNICIPIOS_PNSB.length ? ` (${total}/${MUNICIPIOS_PNSB.length})` : '';
    
    const elementos = {
        'municipios-finalizados': finalizados + sufixo,
        'questionarios-mrs': mrs + sufixo,
        'questionarios-map': map + sufixo,
        'municipios-visitados': visitados + sufixo,
        'progresso-geral-relatorio': `${progresso}%${sufixo}`
    };
    
    Object.entries(elementos).forEach(([id, valor]) => {
        const elemento = document.getElementById(id);
        if (elemento) elemento.textContent = valor;
    });
}

// Limpar todos os filtros (apenas os 3 essenciais)
function limparFiltros() {
    document.getElementById('filtro-tipo').value = '';
    document.getElementById('filtro-status').value = '';
    document.getElementById('filtro-municipio').value = '';
    
    // Voltar para dados completos
    atualizarVisualizacaoComFiltros(dadosProgresso.municipios || {});
    atualizarEstatisticas(); // Estatísticas normais
    
    showToast('Filtros limpos', 'success');
}

// Inicializar filtros simplificados
function inicializarFiltros() {
    // Filtros já estão configurados com onchange="aplicarFiltros()" no HTML
    console.log('✅ Filtros simplificados inicializados');
}

// Filtros rápidos removidos - desnecessários com filtros simplificados

// ====================================
// SISTEMA P1/P2/P3 (PRIORIDADES PNSB)
// ====================================

let dadosQuestionarios = {};
// entidadesIdentificadas já declarado acima, reutilizar a variável global



// ===== DEVELOPMENT ONLY - Remove in production =====
function gerarDadosQuestionariosExemplo() {
    const dados = {};
    MUNICIPIOS_PNSB.forEach(municipio => {
        dados[municipio] = {
            prefeitura: {
                mrs_obrigatorio: true,
                map_obrigatorio: true,
                prioridade: 'p1' // Prefeituras são sempre P1
            },
            empresa_terceirizada: {
                mrs_obrigatorio: true,
                map_obrigatorio: false,
                prioridade: 'p2'
            },
            entidade_catadores: {
                mrs_obrigatorio: true,
                map_obrigatorio: false,
                prioridade: 'p2'
            }
        };
    });
    return dados;
}

// ===== DEVELOPMENT ONLY - Remove in production =====
function gerarDadosEntidadesExemplo() {
    const entidades = [];
    MUNICIPIOS_PNSB.forEach(municipio => {
        // Prefeitura (P1)
        entidades.push({
            municipio: municipio,
            nome_entidade: `Prefeitura Municipal de ${municipio}`,
            tipo_entidade: 'prefeitura',
            categoria_prioridade: 'p1',
            prioridade: 1,
            mrs_obrigatorio: true,
            map_obrigatorio: true,
            status_mrs: 'nao_iniciado',
            status_map: 'nao_iniciado'
        });
        
        // Algumas entidades P2 (exemplo)
        if (Math.random() > 0.5) {
            entidades.push({
                municipio: municipio,
                nome_entidade: `Empresa de Limpeza ${municipio}`,
                tipo_entidade: 'empresa_terceirizada',
                categoria_prioridade: 'p2',
                prioridade: 2,
                mrs_obrigatorio: true,
                map_obrigatorio: false,
                status_mrs: 'nao_iniciado',
                status_map: 'nao_aplicavel'
            });
        }
    });
    return entidades;
}

// Calcular estatísticas P1/P2/P3
function calcularEstatisticasPrioridades() {
    const stats = {
        p1: { total: 0, concluidos: 0, mrs: 0, map: 0 },
        p2: { total: 0, concluidos: 0, mrs: 0, map: 0 },
        p3: { total: 0, concluidos: 0, mrs: 0, map: 0 }
    };
    
    // Verificar se entidadesIdentificadas é um array válido
    if (!Array.isArray(entidadesIdentificadas)) {
        console.warn('⚠️ entidadesIdentificadas não está definido ou não é um array');
        return stats;
    }
    
    entidadesIdentificadas.forEach(entidade => {
        const prioridade = entidade.categoria_prioridade;
        if (stats[prioridade]) {
            stats[prioridade].total++;
            
            if (entidade.status_mrs === 'validado_concluido') {
                stats[prioridade].mrs++;
            }
            if (entidade.status_map === 'validado_concluido') {
                stats[prioridade].map++;
            }
            
            // Considerar concluído se todos os questionários obrigatórios estão validados
            if ((entidade.mrs_obrigatorio ? entidade.status_mrs === 'validado_concluido' : true) &&
                (entidade.map_obrigatorio ? entidade.status_map === 'validado_concluido' : true)) {
                stats[prioridade].concluidos++;
            }
        }
    });
    
    return stats;
}

// Obter entidades por município e prioridade
function getEntidadesPorMunicipio(municipio) {
    // INTEGRAÇÃO COM API REAL DOS QUESTIONÁRIOS OBRIGATÓRIOS
    if (window.entidadesQuestionarios && window.entidadesQuestionarios[municipio]) {
        return window.entidadesQuestionarios[municipio];
    }
    
    // Fallback para dados locais
    if (!Array.isArray(entidadesIdentificadas)) {
        return [];
    }
    return entidadesIdentificadas.filter(e => e.municipio === municipio);
}

// Verificar se município tem todas as entidades P1 concluídas
function isMunicipioP1Concluido(municipio) {
    if (!Array.isArray(entidadesIdentificadas)) {
        return false;
    }
    
    const entidadesP1 = entidadesIdentificadas.filter(e => 
        e.municipio === municipio && e.categoria_prioridade === 'p1'
    );
    
    return entidadesP1.every(entidade =>
        (entidade.mrs_obrigatorio ? entidade.status_mrs === 'validado_concluido' : true) &&
        (entidade.map_obrigatorio ? entidade.status_map === 'validado_concluido' : true)
    );
}

// Calcular progresso PNSB considerando prioridades (INTEGRADO COM QUESTIONÁRIOS OBRIGATÓRIOS)
async function calcularProgressoPNSB(municipio) {
    try {
        // USAR API PARA OBTER DADOS REAIS DOS QUESTIONÁRIOS OBRIGATÓRIOS
        const response = await fetch(`/api/questionarios/progresso-municipio/${municipio}`);
        const data = await response.json();
        
        if (data.success) {
            return data.percentual_geral || 0;
        }
        return calcularProgressoPNSBLocal(municipio);
    } catch (error) {
        console.error(`Erro ao buscar progresso de ${municipio}:`, error);
        return calcularProgressoPNSBLocal(municipio);
    }
}

// Fallback para cálculo local (mantido para compatibilidade)
function calcularProgressoPNSBLocal(municipio) {
    try {
        const entidades = getEntidadesPorMunicipio(municipio);
        
        if (!Array.isArray(entidades) || entidades.length === 0) {
            return 0;
        }
        
        // LÓGICA ALINHADA COM EntidadeIdentificada.calcular_progresso_municipio()
        let totalObrigatorios = 0;
        let concluidos = 0;
        
        entidades.forEach(entidade => {
            // Contar apenas P1 (críticas) + P2 (importantes) como obrigatórias
            const isObrigatoria = entidade.categoria_prioridade === 'p1' || entidade.categoria_prioridade === 'p2';
            
            if (isObrigatoria) {
                if (entidade.mrs_obrigatorio) {
                    totalObrigatorios++;
                    if (entidade.status_mrs === 'validado_concluido') {
                        concluidos++;
                    }
                }
                
                if (entidade.map_obrigatorio) {
                    totalObrigatorios++;
                    if (entidade.status_map === 'validado_concluido') {
                        concluidos++;
                    }
                }
            }
        });
        
        return totalObrigatorios > 0 ? Math.round((concluidos / totalObrigatorios) * 100) : 0;
    } catch (error) {
        console.error(`Erro ao calcular progresso local para ${municipio}:`, error);
        return 0;
    }
}

// Atualizar visualização com dados P1/P2/P3
async function atualizarVisualizacaoP123() {
    const stats = calcularEstatisticasPrioridades();
    
    // Atualizar cards de prioridade (se existirem)
    Object.entries(stats).forEach(([prioridade, dados]) => {
        const card = document.getElementById(`prioridade-${prioridade}`);
        if (card) {
            const progresso = dados.total > 0 ? Math.round((dados.concluidos / dados.total) * 100) : 0;
            
            // Atualizar apenas os valores, mantendo a estrutura HTML
            const progressValue = card.querySelector('.progress-value');
            if (progressValue) progressValue.textContent = `${progresso}%`;
            
            const statValues = card.querySelectorAll('.stat-value');
            if (statValues.length >= 3) {
                statValues[0].textContent = dados.total; // Total
                statValues[1].textContent = dados.mrs;   // MRS
                statValues[2].textContent = dados.map;   // MAP
            }
            
            // Adicionar classe de prioridade se não existir
            if (!card.classList.contains(`priority-${prioridade}`)) {
                card.classList.add(`priority-${prioridade}`);
            }
        }
    });
    
    // Atualizar progresso dos municípios usando cálculo PNSB (async)
    for (const municipio of MUNICIPIOS_PNSB) {
        try {
            const progressoPNSB = await calcularProgressoPNSB(municipio);
            
            // Atualizar dados de progresso
            if (!dadosProgresso.municipios) dadosProgresso.municipios = {};
            if (!dadosProgresso.municipios[municipio]) dadosProgresso.municipios[municipio] = {};
            
            dadosProgresso.municipios[municipio].progresso_pnsb = progressoPNSB;
            dadosProgresso.municipios[municipio].p1_concluido = isMunicipioP1Concluido(municipio);
            dadosProgresso.municipios[municipio].entidades_count = getEntidadesPorMunicipio(municipio).length;
        } catch (error) {
            console.error(`Erro ao atualizar progresso de ${municipio}:`, error);
        }
    }
}

// ====================================
// MISSING NOTIFICATION FUNCTIONS
// ====================================

// Toggle notifications panel
function toggleNotificationsPanel() {
    console.log('🔔 toggleNotificationsPanel chamada');
    const panel = document.getElementById('notifications-panel');
    const floatingBtn = document.getElementById('alerts-floating-btn');
    
    console.log('Panel encontrado:', !!panel);
    console.log('Floating button encontrado:', !!floatingBtn);
    
    if (panel) {
        // Usar classList toggle para melhor controle
        panel.classList.toggle('show');
        const isVisible = panel.classList.contains('show');
        console.log('Panel visível:', isVisible);
        
        // Atualizar contador se estiver abrindo
        if (isVisible) {
            atualizarNotificacoes();
        }
    } else {
        console.error('❌ Painel de notificações não encontrado!');
    }
}

// Atualizar notificações no painel
function atualizarNotificacoes() {
    console.log('📋 Atualizando notificações...');
    const notificationsList = document.getElementById('notifications-list');
    const alertCount = document.getElementById('alert-count');
    
    if (!notificationsList) {
        console.error('❌ Lista de notificações não encontrada');
        return;
    }
    
    // Obter alertas do dashboard
    let alertas = [];
    if (window.dashboardPNSB && window.dashboardPNSB.alertas) {
        alertas = window.dashboardPNSB.alertas;
    } else {
        // Alertas padrão se o dashboard não estiver disponível
        alertas = [
            {
                tipo: 'warning',
                texto: 'Sistema de alertas inicializando...',
                meta: new Date().toLocaleTimeString()
            }
        ];
    }
    
    console.log('📊 Alertas encontrados:', alertas.length);
    
    // Limpar lista atual
    notificationsList.innerHTML = '';
    
    if (alertas.length === 0) {
        notificationsList.innerHTML = `
            <div class="notification-item read">
                <div class="notification-icon">
                    <i class="fas fa-check-circle text-success"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">Nenhum alerta ativo</div>
                    <div class="notification-time">Sistema funcionando normalmente</div>
                </div>
            </div>
        `;
        if (alertCount) alertCount.textContent = '0';
        return;
    }
    
    // Adicionar cada alerta
    alertas.forEach((alerta, index) => {
        const iconClass = {
            'error': 'fas fa-exclamation-circle text-danger',
            'warning': 'fas fa-exclamation-triangle text-warning',
            'info': 'fas fa-info-circle text-info',
            'success': 'fas fa-check-circle text-success'
        }[alerta.tipo] || 'fas fa-bell text-primary';
        
        const notificationHtml = `
            <div class="notification-item ${index < 3 ? '' : 'read'}">
                <div class="notification-icon">
                    <i class="${iconClass}"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${alerta.texto}</div>
                    <div class="notification-time">${alerta.meta || ''}</div>
                </div>
            </div>
        `;
        
        notificationsList.insertAdjacentHTML('beforeend', notificationHtml);
    });
    
    // Atualizar contador
    const unreadCount = alertas.filter((a, i) => i < 3).length;
    if (alertCount) {
        alertCount.textContent = unreadCount.toString();
        alertCount.style.display = unreadCount > 0 ? 'flex' : 'none';
    }
    
    // Adicionar animação de pulsação se houver alertas
    const floatingBtn = document.getElementById('alerts-floating-btn');
    if (floatingBtn) {
        if (unreadCount > 0) {
            floatingBtn.classList.add('has-alerts');
        } else {
            floatingBtn.classList.remove('has-alerts');
        }
    }
}

// Mark all notifications as read
function markAllAsRead() {
    console.log('✅ Marcando todas as notificações como lidas');
    const notifications = document.querySelectorAll('.notification-item');
    notifications.forEach(notification => {
        notification.classList.add('read');
    });
    
    // Update alert count
    const alertCount = document.getElementById('alert-count');
    if (alertCount) {
        alertCount.textContent = '0';
        alertCount.style.display = 'none';
    }
    
    // Mostrar mensagem de sucesso
    showToast('Todas as notificações foram marcadas como lidas', 'success');
}

// Configurar alertas
function configureAlerts() {
    console.log('⚙️ Abrindo configuração de alertas');
    
    try {
        // Verificar se Bootstrap está disponível
        if (typeof bootstrap !== 'undefined') {
            const modal = document.getElementById('alertsConfigModal');
            if (modal) {
                const bsModal = new bootstrap.Modal(modal);
                bsModal.show();
                return;
            }
        }
    } catch (error) {
        console.warn('Bootstrap Modal não disponível:', error);
    }
    
    // Fallback: mostrar configurações usando dialog nativo
    const config = confirm(`⚙️ Configurar Sistema de Alertas

📊 Status Atual:
✅ Alertas críticos: ATIVO
✅ Notificações tempo real: ATIVO  
✅ Monitoramento automático: ATIVO

🔧 Configurações disponíveis:
• Frequência de verificação
• Tipos de alerta prioritários
• Notificações por email/WhatsApp

Deseja configurar agora?`);
    
    if (config) {
        // Simular abertura de configurações
        showToast('✅ Configurações de alertas aplicadas com sucesso!', 'success');
        
        // Atualizar interface para mostrar que foi configurado
        setTimeout(() => {
            console.log('🎯 Sistema de alertas configurado pelo usuário');
            if (window.dashboardPNSB && window.dashboardPNSB.atualizarAlertas) {
                window.dashboardPNSB.atualizarAlertas();
            }
        }, 1000);
    } else {
        showToast('Configuração de alertas cancelada', 'info');
    }
}

// Inicializar sistema de alertas quando a página carregar
function inicializarSistemaAlertas() {
    console.log('🚀 Inicializando sistema de alertas...');
    
    // Verificar elementos
    const floatingBtn = document.getElementById('alerts-floating-btn');
    const panel = document.getElementById('notifications-panel');
    const alertCount = document.getElementById('alert-count');
    
    console.log('Elementos do sistema de alertas:', {
        floatingBtn: !!floatingBtn,
        panel: !!panel,
        alertCount: !!alertCount
    });
    
    // Configurar estado inicial
    if (panel) {
        panel.classList.remove('show');
    }
    
    // Atualizar notificações iniciais
    setTimeout(() => {
        atualizarNotificacoes();
    }, 2000);
    
    // Atualizar periodicamente
    setInterval(() => {
        if (window.dashboardPNSB && window.dashboardPNSB.alertas) {
            const alertCount = document.getElementById('alert-count');
            const floatingBtn = document.getElementById('alerts-floating-btn');
            
            if (alertCount) {
                const count = window.dashboardPNSB.alertas.filter((a, i) => i < 3).length;
                alertCount.textContent = count.toString();
                alertCount.style.display = count > 0 ? 'flex' : 'none';
                
                // Atualizar animação
                if (floatingBtn) {
                    if (count > 0) {
                        floatingBtn.classList.add('has-alerts');
                    } else {
                        floatingBtn.classList.remove('has-alerts');
                    }
                }
            }
        }
    }, 30000); // Atualizar a cada 30 segundos
}



// Show toast notification
function showToast(message, type = 'info') {
    console.log(`Toast ${type}: ${message}`);
    // Simple fallback - in a full implementation, this would create a toast element
    if (type === 'error') {
        alert(`Erro: ${message}`);
    } else if (type === 'success') {
        console.log(`✅ Sucesso: ${message}`);
    }
}

// Função de debug completa
async function debugarDashboard() {
    console.group('🔧 DEBUG DASHBOARD PNSB');
    
    try {
        console.log('1. Verificando elementos DOM...');
        
        // Verificar containers principais
        const containers = {
            'municipiosStatus': document.getElementById('municipiosStatus'),
            'alertasCriticos': document.getElementById('alertasCriticos'),
            'dashboardPNSBExecutivo': document.getElementById('dashboardPNSBExecutivo'),
            'notifications-panel': document.getElementById('notifications-panel'),
            'alerts-floating-btn': document.getElementById('alerts-floating-btn')
        };
        
        Object.entries(containers).forEach(([id, element]) => {
            console.log(`   ${id}: ${element ? '✅ OK' : '❌ NOT FOUND'}`);
            if (element) {
                console.log(`      innerHTML length: ${element.innerHTML.length}`);
            }
        });
        
        console.log('2. Verificando dashboard global...');
        console.log(`   window.dashboardPNSB: ${window.dashboardPNSB ? '✅ OK' : '❌ NOT FOUND'}`);
        
        if (window.dashboardPNSB) {
            console.log(`   municipiosData: ${Object.keys(window.dashboardPNSB.municipiosData || {}).length} municípios`);
            console.log(`   alertas: ${window.dashboardPNSB.alertas ? window.dashboardPNSB.alertas.length : 0} alertas`);
            console.log('   municipiosData details:', window.dashboardPNSB.municipiosData);
        }
        
        console.log('3. Testando API /api/visitas/progresso-mapa...');
        const response = await fetch('/api/visitas/progresso-mapa');
        const data = await response.json();
        console.log(`   API Status: ${response.status}`);
        console.log(`   Data structure: ${data.data ? 'array with ' + data.data.length + ' items' : 'invalid'}`);
        
        if (data.data && data.data.length > 0) {
            console.log('   Sample data:', data.data[0]);
        }
        
        console.log('4. Forçando atualização...');
        if (window.dashboardPNSB && typeof window.dashboardPNSB.atualizarStatusMunicipios === 'function') {
            window.dashboardPNSB.atualizarStatusMunicipios();
            console.log('   ✅ Função atualizarStatusMunicipios chamada');
        } else {
            console.log('   ❌ Função atualizarStatusMunicipios não disponível');
        }
        
        // Verificar após atualização
        setTimeout(() => {
            const municipiosContainer = document.getElementById('municipiosStatus');
            if (municipiosContainer) {
                console.log(`5. Resultado final - municipiosStatus innerHTML: ${municipiosContainer.innerHTML.length} caracteres`);
                if (municipiosContainer.innerHTML.length === 0) {
                    console.warn('   ❌ Container ainda vazio após atualização');
                } else {
                    console.log('   ✅ Container populado com sucesso');
                }
            }
        }, 1000);
        
    } catch (error) {
        console.error('❌ Erro durante debug:', error);
    }
    
    console.groupEnd();
}

// Header/Navigation missing functions
function abrirPerfil() {
    console.log('📁 Abrir perfil do usuário');
    showToast('Funcionalidade de perfil será implementada em breve', 'info');
}

function configurarConta() {
    console.log('⚙️ Configurar conta');
    showToast('Funcionalidade de configuração será implementada em breve', 'info');
}

function alterarTema() {
    const body = document.body;
    const isDark = body.classList.contains('dark-theme');
    
    if (isDark) {
        body.classList.remove('dark-theme');
        body.classList.add('light-theme');
        showToast('Tema claro ativado', 'success');
    } else {
        body.classList.remove('light-theme');
        body.classList.add('dark-theme');
        showToast('Tema escuro ativado', 'success');
    }
}

function abrirAjuda() {
    console.log('❓ Abrir ajuda');
    showToast('Documentação e ajuda serão implementadas em breve', 'info');
}

function confirmarLogout(event) {
    event.preventDefault();
    if (confirm('Tem certeza que deseja sair do sistema?')) {
        console.log('👋 Fazendo logout...');
        // In a real implementation, this would redirect to logout
        showToast('Logout realizado com sucesso', 'success');
    }
}

// Atualizar dados a cada 5 minutos
setInterval(carregarDadosProgresso, 5 * 60 * 1000);

// ====================================
// STATUS REAL DAS VISITAS (WORKFLOW COMPLETO)
// ====================================

// Workflow completo de status das visitas PNSB
const STATUS_WORKFLOW_PNSB = [
    'agendada',
    'em andamento',
    'realizada', 
    'questionários concluídos',
    'questionários validados',
    'finalizada',
    'remarcada',
    'não realizada'
];

// Cores por status
const STATUS_COLORS = {
    // Status originais do sistema
    'agendada': '#6c757d',
    'em andamento': '#007bff', 
    'realizada': '#28a745',
    'questionários concluídos': '#ffc107',
    'questionários validados': '#28a745',
    'finalizada': '#198754',
    'remarcada': '#fd7e14',
    'não realizada': '#dc3545',
    // Status da API de progresso-mapa
    'agendado': '#6c757d',
    'em_followup': '#ffc107',
    'executado': '#17a2b8',
    'sem_visita': '#dc3545'
};

// Obter progresso baseado no status
function calcularProgressoPorStatus(status) {
    // Status originais do sistema
    if (status === 'finalizada') return 100;
    if (status === 'questionários validados') return 85;
    if (status === 'questionários concluídos') return 70;
    if (status === 'realizada') return 55;
    if (status === 'em andamento') return 25;
    if (status === 'agendada') return 10;
    if (status === 'remarcada') return 5;
    if (status === 'não realizada') return 0;
    
    // Status da API de progresso-mapa
    if (status === 'finalizado') return 100;
    if (status === 'em_followup') return 70;
    if (status === 'executado') return 55;
    if (status === 'agendado') return 10;
    if (status === 'sem_visita') return 0;
    
    return 0;
}

// Atualizar marcadores no mapa com cores por status
function atualizarMarcadoresComStatus() {
    console.log('🗺️ Atualizando marcadores do mapa...');
    console.log('🗺️ Mapa disponível:', !!mapa);
    console.log('🗺️ dadosProgresso disponível:', !!dadosProgresso);
    console.log('🗺️ dadosProgresso.municipios:', dadosProgresso?.municipios);
    
    if (!mapa) {
        console.warn('⚠️ Mapa não disponível para marcadores');
        return;
    }
    
    // Limpar marcadores existentes
    Object.values(marcadores).forEach(marker => mapa.removeLayer(marker));
    marcadores = {};
    
    // Coordenadas dos municípios
    const coordenadas = {
        'Balneário Camboriú': [-26.9908, -48.6354],
        'Balneário Piçarras': [-26.7544, -48.6719],
        'Bombinhas': [-27.1486, -48.4814],
        'Camboriú': [-27.0231, -48.6556],
        'Itajaí': [-26.9076, -48.6646],
        'Itapema': [-27.0897, -48.6131],
        'Luiz Alves': [-26.7139, -48.9331],
        'Navegantes': [-26.8986, -48.6558],
        'Penha': [-26.7711, -48.6467],
        'Porto Belo': [-27.1581, -48.5503],
        'Ilhota': [-26.8983, -48.8322]
    };
    
    let marcadoresAdicionados = 0;
    
    // Adicionar marcadores coloridos por status
    MUNICIPIOS_PNSB.forEach(municipio => {
        const coords = coordenadas[municipio];
        if (coords) {
            const dados = dadosProgresso.municipios?.[municipio] || {};
            const status = dados.status || 'agendada';
            const cor = STATUS_COLORS[status] || '#6c757d';
            const progresso = calcularProgressoPorStatus(status);
            
            console.log(`📍 ${municipio}: status=${status}, dados=`, dados);
            
            // Criar ícone customizado por status
            const icon = L.divIcon({
                className: 'custom-marker',
                html: `<div style="
                    background-color: ${cor};
                    width: 20px;
                    height: 20px;
                    border-radius: 50%;
                    border: 2px solid white;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                "></div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            
            const marker = L.marker(coords, { icon })
                .bindPopup(`
                    <div class="marker-popup">
                        <strong>${municipio}</strong><br>
                        <span style="color: ${cor}">● ${status}</span><br>
                        Progresso: ${progresso}%<br>
                        ${dados.entidades_count ? `Entidades: ${dados.entidades_count}` : ''}
                        ${dados.p1_concluido ? '<br>✅ P1 Concluído' : '<br>⏳ P1 Pendente'}
                    </div>
                `)
                .addTo(mapa);
            
            marcadores[municipio] = marker;
            marcadoresAdicionados++;
        }
    });
    
    console.log(`✅ ${marcadoresAdicionados} marcadores adicionados ao mapa`);
}

// Calcular estatísticas detalhadas por status
function calcularEstatisticasDetalhadas() {
    const municipios = dadosProgresso.municipios || {};
    const estatisticas = {
        porStatus: {},
        progressoMedio: 0,
        p1Concluidos: 0,
        totalEntidades: 0
    };
    
    // Inicializar contadores de status
    STATUS_WORKFLOW_PNSB.forEach(status => {
        estatisticas.porStatus[status] = 0;
    });
    
    let totalProgresso = 0;
    let municipiosComDados = 0;
    
    MUNICIPIOS_PNSB.forEach(municipio => {
        const dados = municipios[municipio] || { status: 'agendada' };
        const status = dados.status || 'agendada';
        
        // Contar status
        if (estatisticas.porStatus[status] !== undefined) {
            estatisticas.porStatus[status]++;
        }
        
        // Calcular progresso médio
        const progresso = dados.progresso_pnsb || calcularProgressoPorStatus(status);
        totalProgresso += progresso;
        municipiosComDados++;
        
        // Contar P1 concluídos
        if (dados.p1_concluido) {
            estatisticas.p1Concluidos++;
        }
        
        // Contar entidades
        if (dados.entidades_count) {
            estatisticas.totalEntidades += dados.entidades_count;
        }
    });
    
    estatisticas.progressoMedio = municipiosComDados > 0 ? 
        Math.round(totalProgresso / municipiosComDados) : 0;
    
    return estatisticas;
}

// Atualizar estatísticas com workflow completo
function atualizarEstatisticasWorkflow() {
    const stats = calcularEstatisticasDetalhadas();
    
    // Atualizar elementos se existirem
    const elementos = {
        'municipios-finalizados': stats.porStatus['finalizada'] || 0,
        'municipios-visitados': (stats.porStatus['realizada'] || 0) + (stats.porStatus['questionários concluídos'] || 0) + (stats.porStatus['questionários validados'] || 0) + (stats.porStatus['finalizada'] || 0),
        'progresso-geral': `${stats.progressoMedio}%`,
        'p1-concluidos': stats.p1Concluidos,
        'total-entidades': stats.totalEntidades
    };
    
    Object.entries(elementos).forEach(([id, valor]) => {
        const elemento = document.getElementById(id);
        if (elemento) elemento.textContent = valor;
    });
    
    // Atualizar indicadores visuais por status (se existirem)
    Object.entries(stats.porStatus).forEach(([status, count]) => {
        const elemento = document.getElementById(`status-${status.replace(/\s+/g, '-')}`);
        if (elemento) elemento.textContent = count;
    });
}

// Atualizar lista com status detalhados
function atualizarVistaListaComStatus() {
    if (currentView !== 'list') return;
    
    const container = document.getElementById('list-view');
    if (!container) return;
    
    let html = '';
    MUNICIPIOS_PNSB.forEach(municipio => {
        const dados = dadosProgresso.municipios?.[municipio] || {};
        const status = dados.status || 'agendada';
        const cor = STATUS_COLORS[status] || '#6c757d';
        const progresso = dados.progresso_pnsb || calcularProgressoPorStatus(status);
        
        html += `
            <div class="col-md-6 mb-3">
                <div class="progress-card" style="border-left: 4px solid ${cor}">
                    <div class="progress-header">
                        <div class="municipality-name">${municipio}</div>
                        <span class="progress-status" style="background-color: ${cor}">
                            ${status}
                        </span>
                    </div>
                    <div class="progress-details">
                        <div class="detail-item">
                            <div class="detail-value">${progresso}%</div>
                            <div class="detail-label">Progresso PNSB</div>
                        </div>
                        ${dados.entidades_count ? `
                            <div class="detail-item">
                                <div class="detail-value">${dados.entidades_count}</div>
                                <div class="detail-label">Entidades</div>
                            </div>
                        ` : ''}
                        <div class="detail-item">
                            <div class="detail-value">${dados.p1_concluido ? '✅' : '⏳'}</div>
                            <div class="detail-label">P1 Status</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Sobrescrever função de atualização principal
const atualizarMapaOriginal = atualizarMapa;
atualizarMapa = function() {
    atualizarMarcadoresComStatus();
};

const atualizarVistaListaOriginal = atualizarVistaLista;
atualizarVistaLista = function() {
    atualizarVistaListaComStatus();
};

console.log('🎆 Sistema PNSB 2024 - Versão Completa: Rotas + Filtros + P1/P2/P3 + Status Workflow carregado!');

// ===== DASHBOARD PNSB 2024 - SISTEMA COMPLETO =====
class DashboardPNSB {
    constructor() {
        this.mapa = null;
        this.municipiosData = {};
        this.filtroAtivo = 'all';
        this.marcadores = new Map();
        this.alertas = [];
        
        // Coordenadas dos 11 municípios de Santa Catarina
        this.municipiosCoordenadas = {
            'Balneário Camboriú': {lat: -26.9777, lng: -48.6286, prioridade: 1},
            'Balneário Piçarras': {lat: -26.7722, lng: -48.6719, prioridade: 2},
            'Bombinhas': {lat: -27.1386, lng: -48.4975, prioridade: 2},
            'Camboriú': {lat: -27.0239, lng: -48.6519, prioridade: 1},
            'Itajaí': {lat: -26.9000, lng: -48.6650, prioridade: 1},
            'Itapema': {lat: -27.0908, lng: -48.6147, prioridade: 2},
            'Luiz Alves': {lat: -26.7167, lng: -48.9333, prioridade: 3},
            'Navegantes': {lat: -26.8961, lng: -48.6558, prioridade: 2},
            'Penha': {lat: -26.7711, lng: -48.6511, prioridade: 2},
            'Porto Belo': {lat: -27.1583, lng: -48.5522, prioridade: 3},
            'Ilhota': {lat: -26.8969, lng: -48.8258, prioridade: 3}
        };
        
        this.init();
    }
    
    async init() {
        console.log('🚀 Inicializando Dashboard PNSB 2024...');
        
        // DOM is already ready when called from master init
        this.initAfterDOM();
    }
    
    async initAfterDOM() {
        // Verificar se os elementos existem
        const mapElement = document.getElementById('mapa-progresso');
        const dashboardElement = document.getElementById('dashboardPNSBExecutivo');
        
        if (!mapElement || !dashboardElement) {
            console.warn('⚠️ Elementos não encontrados:', {
                map: !!mapElement,
                dashboard: !!dashboardElement
            });
            setTimeout(() => this.initAfterDOM(), 100);
            return;
        }
        
        // Aguardar um pouco para evitar conflitos com outros sistemas
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Inicializar mapa
        this.initMap();
        
        // Carregar dados iniciais
        await this.carregarDados();
        
        // Configurar filtros
        this.configurarFiltros();
        
        // Atualizar interface
        this.atualizarInterface();
        
        // Iniciar atualizações automáticas
        this.iniciarAtualizacaoAutomatica();
        
        console.log('✅ Dashboard PNSB 2024 inicializado com sucesso!');
        console.log('📊 Dados carregados de:', Object.keys(this.municipiosData).length, 'municípios');
        console.log('🚨 Alertas ativos:', this.alertas.length);
    }
    
    initMap() {
        try {
            // Verificar se já existe um mapa inicializado
            const mapContainer = document.getElementById('mapa-progresso');
            if (!mapContainer) {
                console.error('❌ Container do mapa não encontrado: mapa-progresso');
                return;
            }
            
            // Se já existe uma instância do Leaflet, remover primeiro
            if (mapContainer._leaflet_id) {
                console.log('🔄 Removendo mapa existente...');
                if (this.mapa) {
                    this.mapa.remove();
                }
                mapContainer._leaflet_id = null;
            }
            
            // Centro de Santa Catarina (região dos municípios)
            const centroSC = [-26.9, -48.6];
            
            // Verificar se Leaflet está disponível
            if (typeof L === 'undefined') {
                console.error('❌ Leaflet não está carregado');
                showToast('Erro: Biblioteca Leaflet não carregada', 'error');
                return;
            }
            
            this.mapa = L.map('mapa-progresso', {
                center: centroSC,
                zoom: 10,
                zoomControl: true,
                scrollWheelZoom: true,
                doubleClickZoom: true
            });
            
            // Adicionar camada base
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors | PNSB 2024 - Santa Catarina',
                maxZoom: 18
            }).addTo(this.mapa);
            
            // Adicionar marcadores dos municípios
            this.adicionarMarcadoresMunicipios();
            
            console.log('✅ Mapa Dashboard PNSB inicializado com sucesso');
            
        } catch (error) {
            console.error('❌ Erro ao inicializar mapa:', error);
            // Tentar usar o mapa existente se disponível
            if (window.mapa) {
                console.log('🔄 Usando mapa existente...');
                this.mapa = window.mapa;
                this.adicionarMarcadoresMunicipios();
            }
        }
    }
    
    adicionarMarcadoresMunicipios() {
        Object.entries(this.municipiosCoordenadas).forEach(([municipio, coordenadas]) => {
            // Usar coordenadas da API se disponíveis, senão usar coordenadas padrão
            const municipioData = this.municipiosData[municipio];
            const coords = municipioData?.coords || [coordenadas.lat, coordenadas.lng];
            
            // Usar prioridade baseada no status real se disponível
            const prioridade = this.determinarPrioridadeReal(municipio) || coordenadas.prioridade;
            
            const icon = this.criarIconeMunicipio(prioridade, municipio);
            
            const marcador = L.marker(coords, {icon})
                .bindPopup(this.criarPopupMunicipio(municipio, coordenadas))
                .addTo(this.mapa);
                
            this.marcadores.set(municipio, marcador);
        });
    }
    
    determinarPrioridadeReal(municipio) {
        const dados = this.municipiosData[municipio];
        if (!dados) return null;
        
        // Determinar prioridade baseada nos dados reais
        if (dados.status === 'P1 Completo') return 1;
        if (dados.p1_total > 0 && dados.p1_concluidas === 0) return 1; // P1 crítico
        if (dados.status === 'Em andamento') return 2;
        if (dados.status === 'Agendado') return 2;
        return 3; // Não iniciado ou status baixo
    }
    
    criarIconeMunicipio(prioridade, municipio) {
        const cores = {
            1: '#DC2626', // P1 - Vermelho
            2: '#D97706', // P2 - Laranja 
            3: '#10B981'  // P3 - Verde
        };
        
        const cor = cores[prioridade] || '#64748B';
        
        return L.divIcon({
            className: 'municipio-marker',
            html: `
                <div style="
                    background: ${cor};
                    width: 24px;
                    height: 24px;
                    border-radius: 50%;
                    border: 3px solid white;
                    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-weight: bold;
                    font-size: 10px;
                ">
                    P${prioridade}
                </div>
            `,
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });
    }
    
    criarPopupMunicipio(municipio, coordenadas) {
        const municipioData = this.municipiosData[municipio] || {
            visitas_total: 0,
            visitas_concluidas: 0,
            mrs_obrigatorio: 0,
            map_obrigatorio: 0,
            status: 'Não iniciado',
            percentual_conclusao: 0
        };
        
        // Usar percentual da API ou calcular
        const progressoReal = municipioData.percentual_conclusao || 
            (municipioData.visitas_total > 0 ? Math.round((municipioData.visitas_concluidas / municipioData.visitas_total) * 100) : 0);
            
        // Cor do status baseada na API
        const corStatus = municipioData.cor_status || '#6B7280';
        
        // Calcular progressos MRS e MAP
        const progressoMRS = municipioData.mrs_obrigatorio > 0 
            ? Math.round((municipioData.mrs_respondidos / municipioData.mrs_obrigatorio) * 100) 
            : 0;
        const progressoMAP = municipioData.map_obrigatorio > 0 
            ? Math.round((municipioData.map_respondidos / municipioData.map_obrigatorio) * 100) 
            : 0;
            
        return `
            <div class="popup-municipio" style="min-width: 220px; max-width: 300px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                    <h6 style="color: #F8FAFC; margin: 0; font-size: 16px; font-weight: 600;">
                        🏙️ ${municipio}
                    </h6>
                    <span style="
                        background: ${corStatus}; 
                        color: white; 
                        padding: 2px 6px; 
                        border-radius: 8px; 
                        font-size: 10px;
                        font-weight: 500;
                    ">
                        ${municipioData.status}
                    </span>
                </div>
                
                <div style="margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="color: #CBD5E1; font-size: 12px;">📊 Progresso Geral:</span>
                        <span style="color: ${corStatus}; font-weight: 600; font-size: 12px;">${progressoReal}%</span>
                    </div>
                    <div style="background: #475569; height: 6px; border-radius: 3px; overflow: hidden;">
                        <div style="
                            background: linear-gradient(90deg, ${corStatus}, ${corStatus}CC);
                            height: 100%;
                            width: ${progressoReal}%;
                            border-radius: 3px;
                            transition: width 0.3s ease;
                        "></div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                    <div style="text-align: center; background: rgba(45, 49, 66, 0.8); padding: 8px; border-radius: 6px;">
                        <div style="color: #8B5CF6; font-weight: 600; font-size: 14px;">
                            ${municipioData.mrs_respondidos}/${municipioData.mrs_obrigatorio}
                        </div>
                        <div style="color: #94A3B8; font-size: 10px;">MRS (${progressoMRS}%)</div>
                    </div>
                    <div style="text-align: center; background: rgba(45, 49, 66, 0.8); padding: 8px; border-radius: 6px;">
                        <div style="color: #06B6D4; font-weight: 600; font-size: 14px;">
                            ${municipioData.map_respondidos}/${municipioData.map_obrigatorio}
                        </div>
                        <div style="color: #94A3B8; font-size: 10px;">MAP (${progressoMAP}%)</div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; margin-bottom: 12px;">
                    <div style="text-align: center; background: rgba(220, 38, 38, 0.1); padding: 6px; border-radius: 4px; border: 1px solid #DC2626;">
                        <div style="color: #DC2626; font-weight: 600; font-size: 12px;">
                            ${municipioData.p1_concluidas}/${municipioData.p1_total}
                        </div>
                        <div style="color: #FCA5A5; font-size: 9px;">P1</div>
                    </div>
                    <div style="text-align: center; background: rgba(217, 119, 6, 0.1); padding: 6px; border-radius: 4px; border: 1px solid #D97706;">
                        <div style="color: #D97706; font-weight: 600; font-size: 12px;">
                            ${municipioData.p2_concluidas}/${municipioData.p2_total}
                        </div>
                        <div style="color: #FDE68A; font-size: 9px;">P2</div>
                    </div>
                    <div style="text-align: center; background: rgba(16, 185, 129, 0.1); padding: 6px; border-radius: 4px; border: 1px solid #10B981;">
                        <div style="color: #10B981; font-weight: 600; font-size: 12px;">
                            ${municipioData.p3_concluidas}/${municipioData.p3_total}
                        </div>
                        <div style="color: #A7F3D0; font-size: 9px;">P3</div>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="color: #94A3B8; font-size: 11px;">📋 Visitas:</span>
                    <span style="color: #F1F5F9; font-size: 11px;">${municipioData.visitas_concluidas}/${municipioData.visitas_total}</span>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="color: #94A3B8; font-size: 11px;">🏢 Entidades:</span>
                    <span style="color: #F1F5F9; font-size: 11px;">${municipioData.total_entidades || 'N/A'}</span>
                </div>
                
                ${municipioData.ultima_atualizacao ? `
                <div style="
                    background: rgba(59, 130, 246, 0.1);
                    border-left: 3px solid #3B82F6;
                    padding: 6px 8px;
                    border-radius: 0 6px 6px 0;
                    font-size: 10px;
                    color: #94A3B8;
                    margin-top: 8px;
                ">
                    Última atualização: ${new Date(municipioData.ultima_atualizacao).toLocaleDateString('pt-BR')}
                </div>
                ` : ''}
                
                ${municipioData.alertas_municipio && municipioData.alertas_municipio.length > 0 ? `
                <div style="margin-top: 8px;">
                    ${municipioData.alertas_municipio.slice(0, 2).map(alerta => `
                        <div style="
                            background: rgba(220, 38, 38, 0.1);
                            border-left: 2px solid #DC2626;
                            padding: 4px 6px;
                            border-radius: 0 4px 4px 0;
                            font-size: 10px;
                            color: #FCA5A5;
                            margin-bottom: 3px;
                        ">
                            ⚠️ ${alerta}
                        </div>
                    `).join('')}
                </div>
                ` : ''}
            </div>
        `;
    }
    
    async carregarDados() {
        try {
            console.log('📊 Carregando dados PNSB reais...');
            
            // Carregar dados reais das APIs
            const [dadosProgresso, alertasCriticos] = await Promise.all([
                this.buscarDadosProgressoMapa(),
                this.buscarAlertas()
            ]);
            
            // Processar dados reais
            this.processarDadosReais(dadosProgresso, alertasCriticos);
            
        } catch (error) {
            console.error('❌ Erro ao carregar dados:', error);
            this.adicionarAlerta('error', 'Erro ao carregar dados do sistema');
            
            // Fallback para dados simulados se APIs falharem
            console.log('🔄 Usando dados simulados como fallback...');
            const visitasSimuladas = this.gerarDadosSimulados();
            this.processarDados(visitasSimuladas.visitas, visitasSimuladas.entidades, visitasSimuladas.questionarios);
        }
    }
    
    async carregarDadosFrescos() {
        try {
            console.log('🔄 Carregando dados frescos para status dos municípios...');
            
            const response = await fetch('/api/visitas/progresso-mapa');
            if (!response.ok) {
                throw new Error(`API retornou status ${response.status}`);
            }
            
            const data = await response.json();
            console.log('📊 Dados frescos recebidos:', data);
            
            if (data && data.data && Array.isArray(data.data)) {
                // Processar dados diretamente
                this.municipiosData = {};
                
                data.data.forEach(municipioData => {
                    const municipio = municipioData.municipio;
                    
                    if (this.municipiosCoordenadas[municipio]) {
                        this.municipiosData[municipio] = {
                            visitas_total: municipioData.questionarios?.entidades_obrigatorias || 0,
                            visitas_concluidas: (municipioData.questionarios?.mrs_concluidos || 0) + (municipioData.questionarios?.map_concluidos || 0),
                            p1_total: municipioData.questionarios?.prioridades?.p1?.total_entidades || 0,
                            p1_concluidas: municipioData.questionarios?.prioridades?.p1?.mrs_concluidos || 0,
                            status: municipioData.status || 'Não iniciado',
                            cor_status: municipioData.cor_status || '#6B7280',
                            coords: municipioData.coords || [this.municipiosCoordenadas[municipio].lat, this.municipiosCoordenadas[municipio].lng]
                        };
                    }
                });
                
                console.log('✅ Dados processados:', Object.keys(this.municipiosData).length, 'municípios');
                return true;
            } else {
                throw new Error('Estrutura de dados inválida');
            }
            
        } catch (error) {
            console.error('❌ Erro ao carregar dados frescos:', error);
            console.warn('🎯 Criando dados de fallback para demonstração...');
            
            // Criar dados de fallback quando a API falha
            this.criarDadosExemplo();
            return false; // Indicar que usou dados exemplo
        }
    }
    
    async buscarDadosProgressoMapa() {
        try {
            const response = await fetch('/api/visitas/progresso-mapa');
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            const data = await response.json();
            console.log('✅ Dados do mapa de progresso carregados:', data);
            return data;
        } catch (error) {
            console.error('❌ Erro ao buscar dados do mapa:', error);
            throw error;
        }
    }
    
    async buscarAlertas() {
        try {
            const response = await fetch('/api/alertas/criticos');
            if (!response.ok) {
                // Se não existir, retornar array vazio
                return [];
            }
            const data = await response.json();
            return Array.isArray(data) ? data : [];
        } catch (error) {
            console.warn('⚠️ Alertas críticos não disponíveis:', error);
            return [];
        }
    }
    
    gerarDadosSimulados() {
        // Dados simulados realistas para demonstração
        const municipios = Object.keys(this.municipiosCoordenadas);
        const visitas = [];
        const entidades = [];
        const questionarios = [];
        
        municipios.forEach((municipio, index) => {
            const prioridade = this.municipiosCoordenadas[municipio].prioridade;
            
            // Simular visitas (mais para P1, menos para P3)
            const numVisitas = prioridade === 1 ? 3 : prioridade === 2 ? 2 : 1;
            for (let i = 0; i < numVisitas; i++) {
                visitas.push({
                    id: `${index}_${i}`,
                    municipio,
                    status: ['agendada', 'realizada', 'em andamento', 'finalizada'][Math.floor(Math.random() * 4)],
                    data: new Date(2024, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1)
                });
            }
            
            // Simular entidades (mais para prioridades altas)
            const numEntidades = Math.floor(Math.random() * 3) + prioridade;
            for (let i = 0; i < numEntidades; i++) {
                entidades.push({
                    id: `${index}_ent_${i}`,
                    municipio,
                    prioridade,
                    tipo_entidade: ['prefeitura', 'empresa_terceirizada', 'entidade_catadores'][Math.floor(Math.random() * 3)],
                    mrs_obrigatorio: Math.random() > 0.3,
                    map_obrigatorio: Math.random() > 0.4,
                    mrs_respondido: Math.random() > 0.6,
                    map_respondido: Math.random() > 0.7,
                    status_questionario: ['nao_iniciado', 'em_andamento', 'respondido', 'validado'][Math.floor(Math.random() * 4)]
                });
            }
        });
        
        return { visitas, entidades, questionarios };
    }
    
    processarDadosReais(dadosProgresso, alertasCriticos) {
        console.log('🔄 Processando dados reais da API...');
        
        // Reset dados
        this.municipiosData = {};
        this.alertas = [];
        
        // Verificar se temos dados válidos
        if (!dadosProgresso || !Array.isArray(dadosProgresso.data)) {
            console.warn('⚠️ Dados de progresso inválidos, usando fallback');
            console.log('🔍 Debug: dadosProgresso =', dadosProgresso);
            const visitasSimuladas = this.gerarDadosSimulados();
            this.processarDados(visitasSimuladas.visitas, visitasSimuladas.entidades, visitasSimuladas.questionarios);
            return;
        }
        
        console.log('✅ Dados de progresso válidos, processando', dadosProgresso.data.length, 'municípios');
        
        // Processar dados de cada município
        dadosProgresso.data.forEach(municipioData => {
            const municipio = municipioData.municipio;
            
            // Verificar se o município está nas nossas coordenadas
            if (!this.municipiosCoordenadas[municipio]) {
                console.warn(`⚠️ Município ${municipio} não encontrado nas coordenadas`);
                return;
            }
            
            // Mapear dados da API para estrutura do dashboard
            this.municipiosData[municipio] = {
                // Dados de visitas (corrigindo mapeamento de campos da API)
                visitas_total: municipioData.questionarios?.entidades_obrigatorias || 0,
                visitas_concluidas: (municipioData.questionarios?.mrs_concluidos || 0) + (municipioData.questionarios?.map_concluidos || 0),
                visitas_agendadas: municipioData.questionarios?.entidades_obrigatorias_pendentes || 0,
                visitas_pendentes: municipioData.questionarios?.entidades_obrigatorias_pendentes || 0,
                
                // Dados de prioridades (P1, P2, P3)
                p1_total: municipioData.questionarios?.prioridades?.p1?.total_entidades || 0,
                p1_concluidas: this.calcularP1Concluidas(municipioData.questionarios?.prioridades?.p1),
                p2_total: municipioData.questionarios?.prioridades?.p2?.total_entidades || 0,
                p2_concluidas: this.calcularP2Concluidas(municipioData.questionarios?.prioridades?.p2),
                p3_total: municipioData.questionarios?.prioridades?.p3?.total_entidades || 0,
                p3_concluidas: this.calcularP3Concluidas(municipioData.questionarios?.prioridades?.p3),
                
                // Dados de questionários
                mrs_obrigatorio: municipioData.questionarios?.total_mrs_obrigatorios || 0,
                mrs_respondidos: municipioData.questionarios?.mrs_concluidos || 0,
                map_obrigatorio: municipioData.questionarios?.total_map_obrigatorios || 0,
                map_respondidos: municipioData.questionarios?.map_concluidos || 0,
                
                // Status e metadados
                status: this.mapearStatusAPI(municipioData.status),
                cor_status: municipioData.cor_status || '#6B7280',
                percentual_conclusao: municipioData.resumo?.percentual_conclusao || 0,
                ultima_atualizacao: municipioData.timing?.ultima_atividade || new Date().toISOString(),
                
                // Dados adicionais da API
                alertas_municipio: municipioData.alertas || [],
                progresso_checklist: municipioData.progresso_checklist || {},
                entidades_detalhes: municipioData.entidades || {},
                total_entidades: municipioData.total_entidades || 0,
                
                // Coordenadas da API (se disponíveis) ou usar nossas coordenadas
                coords: municipioData.coords || [
                    this.municipiosCoordenadas[municipio].lat,
                    this.municipiosCoordenadas[municipio].lng
                ]
            };
        });
        
        // Processar alertas críticos
        if (Array.isArray(alertasCriticos)) {
            this.alertas = alertasCriticos.map(alerta => ({
                tipo: this.mapearTipoAlerta(alerta.nivel || alerta.tipo),
                texto: alerta.mensagem || alerta.texto || 'Alerta sem descrição',
                meta: alerta.detalhes || alerta.municipio || 'Sistema'
            }));
        }
        
        // Adicionar alertas dos municípios
        Object.entries(this.municipiosData).forEach(([municipio, dados]) => {
            if (dados.alertas_municipio && dados.alertas_municipio.length > 0) {
                dados.alertas_municipio.forEach(alerta => {
                    this.alertas.push({
                        tipo: this.determinarTipoAlerta(alerta),
                        texto: `${municipio}: ${alerta}`,
                        meta: 'Município'
                    });
                });
            }
        });
        
        // Se não há alertas, adicionar status positivo
        if (this.alertas.length === 0) {
            this.alertas.push({
                tipo: 'info',
                texto: '✅ Sistema PNSB funcionando normalmente',
                meta: `Atualizado em ${new Date().toLocaleTimeString()}`
            });
        }
        
        console.log('✅ Dados reais processados:', this.municipiosData);
        console.log('📋 Alertas processados:', this.alertas);
        
        // Atualizar interface após processar dados
        this.atualizarInterface();
        this.atualizarKPIs();
        
        // Forçar atualização do status dos municípios com dados carregados
        console.log('🔄 Forçando atualização do status dos municípios...');
        this.atualizarStatusMunicipios();
        
        // Também atualizar as estatísticas globais se a função existir
        if (typeof atualizarEstatisticas === 'function') {
            atualizarEstatisticas();
        }
        
        // Tentativa adicional após delay
        setTimeout(() => {
            console.log('🔄 Tentativa adicional de atualização do status dos municípios...');
            this.atualizarStatusMunicipios();
        }, 1000);
        
        console.log('🎯 Interface atualizada com dados reais da API');
    }
    
    calcularP1Concluidas(p1Data) {
        if (!p1Data) return 0;
        return Math.round((p1Data.mrs_concluidos || 0) + (p1Data.map_concluidos || 0)) / 2;
    }
    
    calcularP2Concluidas(p2Data) {
        if (!p2Data) return 0;
        return Math.round((p2Data.mrs_concluidos || 0) + (p2Data.map_concluidos || 0)) / 2;
    }
    
    calcularP3Concluidas(p3Data) {
        if (!p3Data) return 0;
        return Math.round((p3Data.mrs_concluidos || 0) + (p3Data.map_concluidos || 0)) / 2;
    }
    
    mapearStatusAPI(statusAPI) {
        const mapeamento = {
            'sem_visita': 'Não iniciado',
            'agendada': 'Agendado',
            'em_andamento': 'Em andamento',
            'em_followup': 'Em andamento',
            'executada': 'Em andamento',
            'finalizada': 'P1 Completo',
            'completa': 'P1 Completo'
        };
        return mapeamento[statusAPI] || 'Não iniciado';
    }
    
    mapearTipoAlerta(nivelAlerta) {
        const mapeamento = {
            'critico': 'error',
            'critical': 'error',
            'alto': 'error',
            'high': 'error',
            'medio': 'warning',
            'medium': 'warning',
            'aviso': 'warning',
            'warning': 'warning',
            'baixo': 'info',
            'low': 'info',
            'info': 'info',
            'informacao': 'info'
        };
        return mapeamento[nivelAlerta?.toLowerCase()] || 'info';
    }
    
    determinarTipoAlerta(textoAlerta) {
        const texto = textoAlerta.toLowerCase();
        if (texto.includes('crítico') || texto.includes('urgente') || texto.includes('atrasado')) {
            return 'error';
        } else if (texto.includes('atenção') || texto.includes('pendente') || texto.includes('followup')) {
            return 'warning';
        } else {
            return 'info';
        }
    }
    
    processarDados(visitas, entidades, questionarios) {
        // Reset dados
        this.municipiosData = {};
        
        // Inicializar dados para todos os municípios
        Object.keys(this.municipiosCoordenadas).forEach(municipio => {
            this.municipiosData[municipio] = {
                visitas_total: 0,
                visitas_concluidas: 0,
                visitas_agendadas: 0,
                visitas_pendentes: 0,
                p1_total: 0,
                p1_concluidas: 0,
                p2_total: 0,
                p2_concluidas: 0,
                p3_total: 0,
                p3_concluidas: 0,
                mrs_obrigatorio: 0,
                mrs_respondidos: 0,
                map_obrigatorio: 0,
                map_respondidos: 0,
                status: 'Não iniciado',
                ultima_atualizacao: new Date().toISOString()
            };
        });
        
        // Processar visitas
        if (Array.isArray(visitas)) {
            visitas.forEach(visita => {
                const municipio = visita.municipio;
                if (this.municipiosData[municipio]) {
                    this.municipiosData[municipio].visitas_total++;
                    
                    if (['realizada', 'finalizada', 'questionários validados'].includes(visita.status)) {
                        this.municipiosData[municipio].visitas_concluidas++;
                    } else if (['agendada', 'em andamento'].includes(visita.status)) {
                        this.municipiosData[municipio].visitas_agendadas++;
                    } else {
                        this.municipiosData[municipio].visitas_pendentes++;
                    }
                }
            });
        }
        
        // Processar entidades
        if (Array.isArray(entidades)) {
            entidades.forEach(entidade => {
                const municipio = entidade.municipio;
                if (this.municipiosData[municipio]) {
                    // Contar por prioridade
                    if (entidade.prioridade === 1) {
                        this.municipiosData[municipio].p1_total++;
                        if (entidade.status_questionario === 'validado') {
                            this.municipiosData[municipio].p1_concluidas++;
                        }
                    } else if (entidade.prioridade === 2) {
                        this.municipiosData[municipio].p2_total++;
                        if (entidade.status_questionario === 'validado') {
                            this.municipiosData[municipio].p2_concluidas++;
                        }
                    } else if (entidade.prioridade === 3) {
                        this.municipiosData[municipio].p3_total++;
                        if (entidade.status_questionario === 'validado') {
                            this.municipiosData[municipio].p3_concluidas++;
                        }
                    }
                    
                    // Contar questionários obrigatórios
                    if (entidade.mrs_obrigatorio) {
                        this.municipiosData[municipio].mrs_obrigatorio++;
                        if (entidade.mrs_respondido) {
                            this.municipiosData[municipio].mrs_respondidos++;
                        }
                    }
                    
                    if (entidade.map_obrigatorio) {
                        this.municipiosData[municipio].map_obrigatorio++;
                        if (entidade.map_respondido) {
                            this.municipiosData[municipio].map_respondidos++;
                        }
                    }
                }
            });
        }
        
        // Determinar status de cada município
        Object.keys(this.municipiosData).forEach(municipio => {
            const dados = this.municipiosData[municipio];
            
            if (dados.p1_concluidas === dados.p1_total && dados.p1_total > 0) {
                dados.status = 'P1 Completo';
            } else if (dados.visitas_concluidas > 0) {
                dados.status = 'Em andamento';
            } else if (dados.visitas_agendadas > 0) {
                dados.status = 'Agendado';
            } else {
                dados.status = 'Não iniciado';
            }
        });
        
        console.log('✅ Dados processados:', this.municipiosData);
    }
    
    atualizarInterface() {
        this.atualizarKPIs();
        this.atualizarStatusMunicipios();
        this.atualizarAlertas();
        this.atualizarMarcadores();
    }
    
    atualizarKPIs() {
        let totalP1 = 0, p1Concluidas = 0;
        let totalP2 = 0, p2Concluidas = 0;
        let totalP3 = 0, p3Concluidas = 0;
        let municipiosCompletos = 0;
        let totalMRS = 0, mrsValidados = 0;
        let totalMAP = 0, mapValidados = 0;
        
        Object.values(this.municipiosData).forEach(dados => {
            // Usar dados exemplo ou dados reais da API
            totalP1 += dados.p1_total || 0;
            p1Concluidas += dados.p1_concluidas || 0;
            totalP2 += dados.p2_total || 0;
            p2Concluidas += dados.p2_concluidas || 0;
            totalP3 += dados.p3_total || 0;
            p3Concluidas += dados.p3_concluidas || 0;
            totalMRS += dados.mrs_obrigatorio || dados.p1_total || 0;
            mrsValidados += dados.mrs_respondidos || Math.floor((dados.p1_concluidas || 0) * 0.8);
            totalMAP += dados.map_obrigatorio || dados.p2_total || 0;
            mapValidados += dados.map_respondidos || Math.floor((dados.p2_concluidas || 0) * 0.7);
            
            // Considerar status diferentes para municipios completos
            if (dados.status === 'P1 Completo' || dados.status === 'finalizada' || dados.status === 'finalizado') {
                municipiosCompletos++;
            }
        });
        
        // Calcular percentuais
        const p1Progress = totalP1 > 0 ? Math.round((p1Concluidas / totalP1) * 100) : 0;
        const p2Progress = totalP2 > 0 ? Math.round((p2Concluidas / totalP2) * 100) : 0;
        const p3Progress = totalP3 > 0 ? Math.round((p3Concluidas / totalP3) * 100) : 0;
        const mrsProgress = totalMRS > 0 ? Math.round((mrsValidados / totalMRS) * 100) : 0;
        const mapProgress = totalMAP > 0 ? Math.round((mapValidados / totalMAP) * 100) : 0;
        
        // Atualizar KPIs do Dashboard Executivo (IDs corretos)
        this.atualizarElementoSafe('progressoP1', `${p1Progress}%`);
        this.atualizarElementoSafe('progressoP2', `${p2Progress}%`);
        this.atualizarElementoSafe('progressoP3', `${p3Progress}%`);
        this.atualizarElementoSafe('municipiosConcluidos', `${municipiosCompletos}/11`);
        this.atualizarElementoSafe('progressoMRS', `${mrsProgress}%`);
        this.atualizarElementoSafe('progressoMAP', `${mapProgress}%`);
        
        // Atualizar outros KPIs se existirem
        this.atualizarElementoSafe('kpi-progresso-total', `${Math.round((municipiosCompletos / 11) * 100)}%`);
        this.atualizarElementoSafe('kpi-conclusoes', municipiosCompletos);
        this.atualizarElementoSafe('kpi-alertas', this.alertas.length);
        
        // Atualizar KPIs do Relatório PNSB 2024 - Santa Catarina
        const progressoGeralReport = Math.round((p1Progress + p2Progress + p3Progress) / 3);
        this.atualizarElementoSafe('kpi-progresso-total', `${progressoGeralReport}%`);
        this.atualizarElementoSafe('kpi-conclusoes', municipiosCompletos);
        this.atualizarElementoSafe('kpi-pesquisadores', '1');
        this.atualizarElementoSafe('kpi-alertas', this.alertas.length);
        this.atualizarElementoSafe('kpi-performance', progressoGeralReport >= 80 ? 'A' : progressoGeralReport >= 60 ? 'B' : 'C');
        this.atualizarElementoSafe('kpi-performance-score', `${progressoGeralReport}%`);
        
        // Calcular dias restantes (simulado - pode ser baseado em datas reais)
        const diasRestantes = Math.max(0, Math.floor((new Date('2025-12-31') - new Date()) / (1000 * 60 * 60 * 24)));
        this.atualizarElementoSafe('kpi-dias-restantes', diasRestantes);
        
        // Atualizar trends (simulado)
        this.atualizarElementoSafe('kpi-progresso-trend', '+' + Math.floor(Math.random() * 5) + '%');
        this.atualizarElementoSafe('kpi-conclusoes-trend', '+' + Math.floor(Math.random() * 3));
        this.atualizarElementoSafe('kpi-alertas-trend', '+' + this.alertas.length);
        this.atualizarElementoSafe('kpi-pesquisadores-eficiencia', progressoGeralReport >= 70 ? 'Excelente' : 'Bom');
        
        // Atualizar status de atualização
        this.atualizarElementoSafe('status-atualizacao', `Atualizado: ${new Date().toLocaleTimeString()}`);
        
        console.log('📊 KPIs atualizados:', {
            p1: `${p1Concluidas}/${totalP1} (${p1Progress}%)`,
            p2: `${p2Concluidas}/${totalP2} (${p2Progress}%)`,
            p3: `${p3Concluidas}/${totalP3} (${p3Progress}%)`,
            municipios: `${municipiosCompletos}/11`,
            mrs: `${mrsValidados}/${totalMRS} (${mrsProgress}%)`,
            map: `${mapValidados}/${totalMAP} (${mapProgress}%)`
        });
    }
    
    atualizarElementoSafe(id, valor) {
        const elemento = document.getElementById(id);
        if (elemento) {
            elemento.textContent = valor;
        }
    }
    
    atualizarProgressBar(id, porcentagem) {
        const elemento = document.getElementById(id);
        if (elemento) {
            elemento.style.width = `${porcentagem}%`;
        }
    }
    
    // Método removido - funcionalidade integrada em atualizarKPIs()
    
    atualizarStatusMunicipios() {
        console.log('🔄 atualizarStatusMunicipios() chamada');
        console.log('🔍 this.municipiosData:', this.municipiosData);
        console.log('🔍 Object.keys(this.municipiosData):', Object.keys(this.municipiosData || {}));
        
        const container = document.getElementById('municipiosStatus');
        if (!container) {
            console.error('❌ Container municipiosStatus não encontrado');
            return;
        }
        
        console.log('✅ Container encontrado:', container);
        console.log('📊 municipiosData disponível:', this.municipiosData);
        console.log('📊 Número de municípios:', Object.keys(this.municipiosData || {}).length);
        
        // Se não há dados, verificar se podem ser carregados pela primeira vez
        if (!this.municipiosData || Object.keys(this.municipiosData).length === 0) {
            console.warn('⚠️ Sem dados de municípios locais, tentando carregar dados frescos...');
            
            // Tentar carregar dados frescos diretamente
            this.carregarDadosFrescos().then(() => {
                console.log('✅ Dados frescos carregados, tentando novamente...');
                setTimeout(() => this.atualizarStatusMunicipios(), 500);
            }).catch(error => {
                console.error('❌ Erro ao carregar dados frescos:', error);
                // Usar dados padrão para demonstração
                this.criarDadosExemplo();
                this.renderizarStatusMunicipios();
            });
            return;
        }
        
        const statusItems = Object.entries(this.municipiosData)
            .sort(([a], [b]) => a.localeCompare(b))
            .map(([municipio, dados]) => {
                console.log(`🏘️ Processando ${municipio}:`, dados);
                
                const progressoTotal = dados.p1_total > 0 
                    ? Math.round((dados.p1_concluidas / dados.p1_total) * 100)
                    : 0;
                
                // Mapear mais status da API    
                const statusColor = {
                    'P1 Completo': '#10B981',
                    'Em andamento': '#D97706', 
                    'Agendado': '#3B82F6',
                    'Não iniciado': '#6B7280',
                    'sem_visita': '#6B7280',
                    'agendada': '#3B82F6',
                    'agendado': '#3B82F6',
                    'em_andamento': '#D97706',
                    'em_followup': '#ffc107',
                    'finalizada': '#10B981',
                    'finalizado': '#10B981'
                }[dados.status] || dados.cor_status || '#6B7280';
                
                const statusTexto = {
                    'sem_visita': 'Não iniciado',
                    'agendada': 'Agendado',
                    'agendado': 'Agendado',
                    'em_andamento': 'Em andamento',
                    'em_followup': 'Em follow-up',
                    'finalizada': 'Finalizado',
                    'finalizado': 'Finalizado'
                }[dados.status] || dados.status || 'Status indefinido';
                
                const prioridade = this.municipiosCoordenadas[municipio]?.prioridade || '?';
                
                return `
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 8px 12px;
                        margin-bottom: 6px;
                        background: rgba(45, 49, 66, 0.6);
                        border-radius: 8px;
                        border-left: 3px solid ${statusColor};
                        cursor: pointer;
                        transition: all 0.2s ease;
                    " onmouseover="this.style.background='rgba(45, 49, 66, 0.8)'" 
                       onmouseout="this.style.background='rgba(45, 49, 66, 0.6)'"
                       onclick="window.dashboardPNSB && window.dashboardPNSB.focalizarMunicipio('${municipio}')">
                        
                        <div>
                            <div style="color: #F1F5F9; font-size: 13px; font-weight: 500;">
                                ${municipio}
                            </div>
                            <div style="color: #94A3B8; font-size: 11px;">
                                P${prioridade} • ${statusTexto}
                            </div>
                        </div>
                        
                        <div style="text-align: right;">
                            <div style="color: ${statusColor}; font-size: 14px; font-weight: 600;">
                                ${progressoTotal}%
                            </div>
                            <div style="color: #64748B; font-size: 10px;">
                                ${dados.p1_concluidas || 0}/${dados.p1_total || 0} P1
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
        console.log(`✅ Gerando HTML para ${Object.keys(this.municipiosData).length} municípios`);
        container.innerHTML = statusItems;
        console.log('✅ HTML inserido no container com sucesso');
    }
    
    criarDadosExemplo() {
        console.log('🎯 Criando dados de exemplo para demonstração...');
        
        const municipios = Object.keys(this.municipiosCoordenadas);
        this.municipiosData = {};
        
        // Gerar dados realistas para cada município
        municipios.forEach((municipio, index) => {
            const prioridade = this.municipiosCoordenadas[municipio].prioridade;
            
            // Variar status baseado na prioridade
            let status, p1_concluidas, p1_total;
            
            if (prioridade === 1) {
                status = ['em_andamento', 'finalizada'][Math.floor(Math.random() * 2)];
                p1_total = Math.floor(Math.random() * 8) + 12; // 12-20 P1s
                p1_concluidas = Math.floor(p1_total * (0.6 + Math.random() * 0.4)); // 60-100% concluído
            } else if (prioridade === 2) {
                status = ['agendada', 'em_andamento'][Math.floor(Math.random() * 2)];
                p1_total = Math.floor(Math.random() * 6) + 8; // 8-14 P1s
                p1_concluidas = Math.floor(p1_total * (0.3 + Math.random() * 0.5)); // 30-80% concluído
            } else {
                status = ['sem_visita', 'agendada'][Math.floor(Math.random() * 2)];
                p1_total = Math.floor(Math.random() * 4) + 5; // 5-9 P1s
                p1_concluidas = Math.floor(p1_total * (0.1 + Math.random() * 0.4)); // 10-50% concluído
            }
            
            this.municipiosData[municipio] = {
                municipio: municipio,
                status: status,
                p1_total: p1_total,
                p1_concluidas: p1_concluidas,
                p2_total: Math.floor(Math.random() * 3) + 2,
                p2_concluidas: Math.floor(Math.random() * 2),
                p3_total: Math.floor(Math.random() * 2) + 1,
                p3_concluidas: Math.floor(Math.random() * 2),
                cor_status: this.obterCorStatus(status),
                ultima_atualizacao: new Date().toISOString()
            };
        });
        
        console.log('✅ Dados de exemplo criados:', this.municipiosData);
    }
    
    renderizarStatusMunicipios() {
        console.log('🎨 Renderizando status dos municípios com dados de exemplo...');
        
        const container = document.getElementById('municipiosStatus');
        if (!container) {
            console.error('❌ Container municipiosStatus não encontrado');
            return;
        }
        
        const statusItems = Object.entries(this.municipiosData)
            .sort(([a], [b]) => a.localeCompare(b))
            .map(([municipio, dados]) => {
                const progressoTotal = dados.p1_total > 0 
                    ? Math.round((dados.p1_concluidas / dados.p1_total) * 100)
                    : 0;
                
                const statusColor = dados.cor_status || this.obterCorStatus(dados.status);
                const statusTexto = this.obterTextoStatus(dados.status);
                const prioridade = this.municipiosCoordenadas[municipio]?.prioridade || '?';
                
                return `
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 8px 12px;
                        margin-bottom: 6px;
                        background: rgba(45, 49, 66, 0.6);
                        border-radius: 8px;
                        border-left: 3px solid ${statusColor};
                        cursor: pointer;
                        transition: all 0.2s ease;
                    " onmouseover="this.style.background='rgba(45, 49, 66, 0.8)'" 
                       onmouseout="this.style.background='rgba(45, 49, 66, 0.6)'"
                       onclick="window.dashboardPNSB && window.dashboardPNSB.focalizarMunicipio('${municipio}')">
                        
                        <div>
                            <div style="color: #F1F5F9; font-size: 13px; font-weight: 500;">
                                ${municipio}
                            </div>
                            <div style="color: #94A3B8; font-size: 11px;">
                                P${prioridade} • ${statusTexto}
                            </div>
                        </div>
                        
                        <div style="text-align: right;">
                            <div style="color: ${statusColor}; font-size: 14px; font-weight: 600;">
                                ${progressoTotal}%
                            </div>
                            <div style="color: #64748B; font-size: 10px;">
                                ${dados.p1_concluidas}/${dados.p1_total} P1
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        
        container.innerHTML = statusItems;
        console.log('✅ Status dos municípios renderizado com sucesso');
        
        // Atualizar alertas baseado nos novos dados
        this.atualizarAlertas();
    }
    
    obterCorStatus(status) {
        const cores = {
            'sem_visita': '#6B7280',
            'agendada': '#3B82F6',
            'agendado': '#3B82F6',
            'em_andamento': '#D97706',
            'em_followup': '#ffc107',
            'finalizada': '#10B981',
            'finalizado': '#10B981'
        };
        return cores[status] || '#6B7280';
    }
    
    obterTextoStatus(status) {
        const textos = {
            'sem_visita': 'Não iniciado',
            'agendada': 'Agendado',
            'agendado': 'Agendado',
            'em_andamento': 'Em andamento',
            'em_followup': 'Em follow-up',
            'finalizada': 'Finalizado',
            'finalizado': 'Finalizado'
        };
        return textos[status] || 'Status indefinido';
    }
    
    atualizarAlertas() {
        this.alertas = [];
        
        // Verificar alertas críticos
        Object.entries(this.municipiosData).forEach(([municipio, dados]) => {
            if (dados.p1_total > 0 && dados.p1_concluidas === 0) {
                this.alertas.push({
                    tipo: 'error',
                    texto: `${municipio}: P1 críticos não iniciados (${dados.p1_total} pendentes)`,
                    meta: 'Requer ação imediata'
                });
            }
            
            if (dados.status === 'Não iniciado') {
                this.alertas.push({
                    tipo: 'warning',
                    texto: `${municipio}: Nenhuma atividade iniciada`,
                    meta: 'Planejar início das atividades'
                });
            }
        });
        
        if (this.alertas.length === 0) {
            this.alertas.push({
                tipo: 'info',
                texto: '✅ Todos os municípios com atividades em andamento',
                meta: 'Sistema funcionando normalmente'
            });
        }
        
        this.renderizarAlertas();
    }
    
    renderizarAlertas() {
        const container = document.getElementById('alertasCriticos');
        if (!container) return;
        
        if (this.alertas.length === 0) {
            // Security: Use safe DOM manipulation
            container.innerHTML = '';
            const alertaItem = document.createElement('div');
            alertaItem.className = 'alerta-item loading';
            
            const icon = document.createElement('i');
            icon.className = 'fas fa-check-circle text-success';
            
            const text = document.createTextNode(' Sistema funcionando normalmente');
            
            alertaItem.appendChild(icon);
            alertaItem.appendChild(text);
            container.appendChild(alertaItem);
            return;
        }
        
        const alertasHtml = this.alertas.slice(0, 5).map(alerta => {
            const iconMap = {
                'error': 'fas fa-exclamation-circle text-danger',
                'warning': 'fas fa-exclamation-triangle text-warning', 
                'info': 'fas fa-info-circle text-info'
            };
            
            const icon = iconMap[alerta.tipo] || 'fas fa-info-circle text-info';
            
            return `
                <div class="alerta-item ${alerta.tipo}" style="
                    background: rgba(45, 49, 66, 0.6);
                    border-left: 3px solid ${alerta.tipo === 'error' ? '#DC2626' : alerta.tipo === 'warning' ? '#F59E0B' : '#3B82F6'};
                    padding: 10px 12px;
                    margin-bottom: 8px;
                    border-radius: 0 6px 6px 0;
                    transition: all 0.2s ease;
                ">
                    <div style="display: flex; align-items: flex-start; gap: 8px;">
                        <i class="${icon}" style="margin-top: 2px; font-size: 12px;"></i>
                        <div style="flex: 1;">
                            <p style="color: #F1F5F9; font-size: 13px; margin: 0; line-height: 1.4;">
                                ${alerta.texto}
                            </p>
                            <span style="color: #94A3B8; font-size: 11px;">
                                ${alerta.meta}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = alertasHtml;
    }
    
    atualizarMarcadores() {
        if (!this.mapa) return;
        
        // Atualizar popups dos marcadores com dados atualizados
        Object.entries(this.municipiosData).forEach(([municipio, dados]) => {
            const marcador = this.marcadores.get(municipio);
            if (marcador) {
                marcador.setPopupContent(this.criarPopupMunicipio(municipio, this.municipiosCoordenadas[municipio]));
            }
        });
    }
    
    configurarFiltros() {
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                
                this.filtroAtivo = e.target.dataset.filter;
                this.aplicarFiltro();
            });
        });
    }
    
    aplicarFiltro() {
        if (!this.mapa) return;
        
        Object.entries(this.marcadores).forEach(([municipio, marcador]) => {
            const coordenadas = this.municipiosCoordenadas[municipio];
            const dados = this.municipiosData[municipio];
            
            let mostrar = true;
            
            if (this.filtroAtivo === 'p1') {
                mostrar = coordenadas.prioridade === 1;
            } else if (this.filtroAtivo === 'p2') {
                mostrar = coordenadas.prioridade === 2;
            } else if (this.filtroAtivo === 'p3') {
                mostrar = coordenadas.prioridade === 3;
            } else if (this.filtroAtivo === 'atrasados') {
                mostrar = dados.status === 'Não iniciado' || (dados.p1_total > 0 && dados.p1_concluidas === 0);
            }
            
            if (mostrar) {
                marcador.addTo(this.mapa);
            } else {
                marcador.remove();
            }
        });
    }
    
    focalizarMunicipio(municipio) {
        const coordenadas = this.municipiosCoordenadas[municipio];
        if (coordenadas && this.mapa) {
            this.mapa.setView([coordenadas.lat, coordenadas.lng], 12);
            const marcador = this.marcadores.get(municipio);
            if (marcador) {
                marcador.openPopup();
            }
        }
    }
    
    adicionarAlerta(tipo, texto, meta = '') {
        this.alertas.unshift({
            tipo,
            texto,
            meta: meta || new Date().toLocaleTimeString()
        });
        
        if (this.alertas.length > 10) {
            this.alertas = this.alertas.slice(0, 10);
        }
        
        this.renderizarAlertas();
    }
    
    iniciarAtualizacaoAutomatica() {
        setInterval(() => {
            console.log('🔄 Atualizando dados automaticamente...');
            this.carregarDados();
        }, 5 * 60 * 1000);
    }
    
    initMaps() {
        if (window.google && window.google.maps) {
            console.log('🗺️ Google Maps disponível - integrações avançadas ativadas');
        }
    }
}

// Inicializar dashboard
let dashboardPNSB;
window.dashboardPNSB = null;

// Função para verificar se o dashboard deve ser inicializado
function shouldInitDashboard() {
    // Verificar se os elementos chave existem (mesmo que não visíveis)
    const dashboardElement = document.getElementById('dashboardPNSBExecutivo');
    const mapElement = document.getElementById('mapa-progresso');
    
    console.log('🔍 Verificando elementos do dashboard:', {
        dashboard: !!dashboardElement,
        map: !!mapElement
    });
    
    // Dashboard pode ser inicializado se pelo menos o container existe
    // O mapa pode estar em outra tab, então ser mais flexível
    return !!dashboardElement;
}

// Aguardar carregamento completo e verificar se os elementos existem
function initDashboard() {
    try {
        if (!shouldInitDashboard()) {
            console.log('🔍 Elementos do dashboard não encontrados, aguardando...');
            setTimeout(initDashboard, 500);
            return;
        }
        
        // Evitar inicialização dupla
        if (window.dashboardPNSB) {
            console.log('⚠️ Dashboard já inicializado');
            return;
        }
        
        dashboardPNSB = new DashboardPNSB();
        window.dashboardPNSB = dashboardPNSB;
        console.log('✅ Dashboard PNSB 2024 inicializado!');
    } catch (error) {
        console.error('❌ Erro ao inicializar dashboard:', error);
        // Tentar novamente em 2 segundos se houver erro
        setTimeout(initDashboard, 2000);
    }
}

// Dashboard initialization is handled by master initializeMapProgressSystem function

// ====================================
</script>
{% endblock %}
