{% extends "base.html" %}

{% block title %}Assistente de Abordagem - Sistema PNSB{% endblock %}

{% block head %}
<style>
.assistant-container {
    max-width: 1200px;
    margin: 0 auto;
}

.step-container {
    background: #23263B;
    border-radius: 16px;
    padding: 30px;
    margin-bottom: 20px;
    border: 2px solid #2D3142;
    transition: all 0.3s ease;
}

.step-container.active {
    border-color: #5F5CFF;
    box-shadow: 0 0 20px rgba(95, 92, 255, 0.3);
}

.step-header {
    display: flex;
    align-items: center;
    margin-bottom: 25px;
}

.step-number {
    width: 40px;
    height: 40px;
    background: linear-gradient(90deg, #5F5CFF 0%, #6EE7B7 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
    margin-right: 15px;
}

.step-title {
    font-size: 20px;
    font-weight: 600;
    color: #F1F1F1;
    margin: 0;
}

.step-description {
    color: #E9ECEF;
    margin-left: 55px;
    margin-bottom: 20px;
}

.informant-card {
    background: #2D3142;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}

.informant-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 15px;
}

.informant-name {
    font-size: 18px;
    font-weight: 600;
    color: #F1F1F1;
}

.informant-role {
    color: #6EE7B7;
    font-size: 14px;
}

.informant-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
}

.detail-item {
    display: flex;
    align-items: center;
    color: #E9ECEF;
    font-size: 14px;
}

.detail-item i {
    width: 20px;
    color: #5F5CFF;
    margin-right: 8px;
}

.personality-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 15px;
}

.personality-tag {
    background: rgba(95, 92, 255, 0.2);
    color: #5F5CFF;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
}

.script-container {
    background: #2D3142;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}

.script-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 15px;
}

.script-content {
    background: #181A20;
    border-radius: 8px;
    padding: 20px;
    border-left: 4px solid #6EE7B7;
    margin-bottom: 15px;
}

.script-text {
    color: #F1F1F1;
    line-height: 1.6;
    margin-bottom: 15px;
}

.key-points {
    background: rgba(110, 231, 183, 0.1);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
}

.key-points h6 {
    color: #6EE7B7;
    margin-bottom: 10px;
}

.key-points ul {
    color: #F1F1F1;
    margin: 0;
    padding-left: 20px;
}

.objection-card {
    background: #2D3142;
    border: 1px solid #dc3545;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
}

.objection-title {
    color: #dc3545;
    font-weight: 600;
    margin-bottom: 8px;
}

.objection-response {
    color: #F1F1F1;
    font-size: 14px;
}

.checklist-container {
    background: #2D3142;
    border-radius: 12px;
    padding: 20px;
}

.checklist-item {
    display: flex;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #3A3F54;
}

.checklist-item:last-child {
    border-bottom: none;
}

.checklist-item input[type="checkbox"] {
    width: 20px;
    height: 20px;
    margin-right: 15px;
    accent-color: #5F5CFF;
}

.checklist-item label {
    color: #F1F1F1;
    flex-grow: 1;
    cursor: pointer;
}

.checklist-item.completed label {
    text-decoration: line-through;
    color: #E9ECEF;
}

.action-buttons {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    margin-top: 20px;
}

.btn-primary-custom {
    background: linear-gradient(90deg, #5F5CFF 0%, #6EE7B7 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-primary-custom:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(95, 92, 255, 0.4);
}

.btn-secondary-custom {
    background: #B0B3C7;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-secondary-custom:hover {
    background: #5a6268;
    transform: translateY(-2px);
}

.tips-container {
    background: rgba(255, 193, 7, 0.1);
    border: 1px solid #ffc107;
    border-radius: 8px;
    padding: 15px;
    margin-top: 20px;
}

.tips-title {
    color: #ffc107;
    font-weight: 600;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
}

.tips-title i {
    margin-right: 8px;
}

.tip-item {
    color: #F1F1F1;
    font-size: 14px;
    margin-bottom: 8px;
    padding-left: 20px;
    position: relative;
}

.tip-item:before {
    content: "üí°";
    position: absolute;
    left: 0;
}

.progress-indicator {
    display: flex;
    justify-content: center;
    margin: 30px 0;
}

.progress-step {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #2D3142;
    color: #E9ECEF;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 15px;
    font-weight: bold;
    position: relative;
}

.progress-step.completed {
    background: linear-gradient(90deg, #5F5CFF 0%, #6EE7B7 100%);
    color: white;
}

.progress-step.active {
    background: #ffc107;
    color: #212529;
}

.progress-step:not(:last-child):after {
    content: '';
    position: absolute;
    top: 50%;
    left: 100%;
    width: 30px;
    height: 2px;
    background: #2D3142;
    transform: translateY(-50%);
}

.progress-step.completed:not(:last-child):after {
    background: linear-gradient(90deg, #5F5CFF 0%, #6EE7B7 100%);
}

.floating-assistant {
    position: fixed;
    bottom: 100px;
    right: 20px;
    width: 60px;
    height: 60px;
    background: linear-gradient(90deg, #5F5CFF 0%, #6EE7B7 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(95, 92, 255, 0.4);
    z-index: 1000;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 4px 15px rgba(95, 92, 255, 0.4); }
    50% { box-shadow: 0 4px 25px rgba(95, 92, 255, 0.8); }
    100% { box-shadow: 0 4px 15px rgba(95, 92, 255, 0.4); }
}
</style>
{% endblock %}

{% block content %}
<div class="assistant-container">
    <div class="d-flex flex-wrap align-items-center justify-content-between mb-4">
        <h2 class="fw-bold mb-0">ü§ù Assistente de Abordagem</h2>
        <div class="d-flex gap-2">
            <button class="btn-primary-custom" onclick="iniciarNovaAbordagem()">
                <i class="fas fa-plus"></i> Nova Abordagem
            </button>
            <button class="btn-secondary-custom" onclick="consultarHistorico()">
                <i class="fas fa-history"></i> Hist√≥rico
            </button>
        </div>
    </div>

    <!-- Indicador de Progresso -->
    <div class="progress-indicator">
        <div class="progress-step completed" id="step-1">1</div>
        <div class="progress-step active" id="step-2">2</div>
        <div class="progress-step" id="step-3">3</div>
        <div class="progress-step" id="step-4">4</div>
        <div class="progress-step" id="step-5">5</div>
    </div>

    <!-- Etapa 1: Sele√ß√£o do Informante -->
    <div class="step-container" id="etapa-1" style="display: none;">
        <div class="step-header">
            <div class="step-number">1</div>
            <h3 class="step-title">Sele√ß√£o do Informante</h3>
        </div>
        <p class="step-description">Escolha o informante e munic√≠pio para preparar a abordagem personalizada</p>
        
        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label">Munic√≠pio</label>
                <select class="form-select bg-dark text-light" id="select-municipio">
                    <option value="">Selecione o munic√≠pio</option>
                    <option>Balne√°rio Cambori√∫</option>
                    <option>Balne√°rio Pi√ßarras</option>
                    <option>Bombinhas</option>
                    <option>Cambori√∫</option>
                    <option>Itaja√≠</option>
                    <option>Itapema</option>
                    <option>Luiz Alves</option>
                    <option>Navegantes</option>
                    <option>Penha</option>
                    <option>Porto Belo</option>
                    <option>Ilhota</option>
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label">Nome do Informante</label>
                <input type="text" class="form-control bg-dark text-light" id="input-informante" placeholder="Digite o nome do informante">
            </div>
        </div>
        
        <div class="action-buttons">
            <button class="btn-primary-custom" onclick="proximaEtapa(2)">
                Pr√≥ximo <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- Etapa 2: Perfil do Informante -->
    <div class="step-container active" id="etapa-2">
        <div class="step-header">
            <div class="step-number">2</div>
            <h3 class="step-title">Perfil do Informante</h3>
        </div>
        <p class="step-description">An√°lise inteligente do perfil e hist√≥rico do informante</p>
        
        <div class="informant-card">
            <div class="informant-header">
                <div>
                    <div class="informant-name" id="profile-name">Jo√£o Silva Santos</div>
                    <div class="informant-role" id="profile-role">Secret√°rio Municipal de Meio Ambiente</div>
                </div>
                <div class="personality-tags" id="profile-tags">
                    <span class="personality-tag">Cooperativo</span>
                    <span class="personality-tag">Detalhista</span>
                    <span class="personality-tag">Formal</span>
                </div>
            </div>
            
            <div class="informant-details">
                <div class="detail-item">
                    <i class="fas fa-phone"></i>
                    <span id="profile-phone">(47) 9876-5432</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-envelope"></i>
                    <span id="profile-email">joao.silva@prefeitura.sc.gov.br</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-clock"></i>
                    <span id="profile-hours">Melhor hor√°rio: 14h-16h</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-calendar"></i>
                    <span id="profile-lastcontact">√öltimo contato: 15/12/2024</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-chart-line"></i>
                    <span id="profile-success">Taxa de sucesso: 85%</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-language"></i>
                    <span id="profile-communication">Estilo: Formal e t√©cnico</span>
                </div>
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn-secondary-custom" onclick="etapaAnterior(1)">
                <i class="fas fa-arrow-left"></i> Anterior
            </button>
            <button class="btn-primary-custom" onclick="proximaEtapa(3)">
                Pr√≥ximo <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- Etapa 3: Script Personalizado -->
    <div class="step-container" id="etapa-3" style="display: none;">
        <div class="step-header">
            <div class="step-number">3</div>
            <h3 class="step-title">Script Personalizado</h3>
        </div>
        <p class="step-description">Script de abordagem gerado pela IA baseado no perfil do informante</p>
        
        <div class="script-container">
            <div class="script-header">
                <h6 class="text-light">Script de Abertura</h6>
                <button class="btn btn-sm btn-outline-info" onclick="regenerarScript()">
                    <i class="fas fa-sync"></i> Regenerar
                </button>
            </div>
            
            <div class="script-content">
                <div class="script-text" id="script-abertura">
                    "Bom dia, Sr. Jo√£o Silva. Meu nome √© [SEU NOME], sou pesquisador do IBGE respons√°vel pela Pesquisa Nacional de Saneamento B√°sico 2024. Como conversamos anteriormente, gostaria de agendar uma visita para coletarmos as informa√ß√µes sobre o manejo de res√≠duos s√≥lidos do munic√≠pio. Sei que o senhor valoriza a precis√£o dos dados, por isso preparei um question√°rio estruturado que otimizar√° nosso tempo. Qual seria a melhor data e hor√°rio para nossa reuni√£o?"
                </div>
            </div>
            
            <div class="key-points">
                <h6><i class="fas fa-key"></i> Pontos-Chave a Mencionar</h6>
                <ul id="pontos-chave">
                    <li>Import√¢ncia nacional da pesquisa PNSB</li>
                    <li>Dados ser√£o usados para pol√≠ticas p√∫blicas</li>
                    <li>Compromisso com a confidencialidade</li>
                    <li>Dura√ß√£o estimada: 45-60 minutos</li>
                    <li>Possibilidade de visita t√©cnica √†s instala√ß√µes</li>
                </ul>
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn-secondary-custom" onclick="etapaAnterior(2)">
                <i class="fas fa-arrow-left"></i> Anterior
            </button>
            <button class="btn-primary-custom" onclick="proximaEtapa(4)">
                Pr√≥ximo <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- Etapa 4: Prepara√ß√£o para Obje√ß√µes -->
    <div class="step-container" id="etapa-4" style="display: none;">
        <div class="step-header">
            <div class="step-number">4</div>
            <h3 class="step-title">Prepara√ß√£o para Obje√ß√µes</h3>
        </div>
        <p class="step-description">Argumentos preparados para as principais obje√ß√µes esperadas</p>
        
        <div id="objections-container">
            <div class="objection-card">
                <div class="objection-title">"N√£o temos tempo para a pesquisa"</div>
                <div class="objection-response">
                    "Compreendo perfeitamente a agenda apertada. A pesquisa √© estruturada para otimizar o tempo - podemos realizar em etapas ou at√© mesmo de forma remota para algumas se√ß√µes. O importante √© que os dados do munic√≠pio sejam representados adequadamente nas pol√≠ticas nacionais de saneamento."
                </div>
            </div>
            
            <div class="objection-card">
                <div class="objection-title">"J√° fornecemos esses dados em outras pesquisas"</div>
                <div class="objection-response">
                    "A PNSB tem metodologia espec√≠fica e √© a √∫nica pesquisa oficial sobre saneamento no pa√≠s. Os dados anteriores nos ajudam a validar informa√ß√µes, mas precisamos de dados atualizados para retratar a realidade atual do munic√≠pio."
                </div>
            </div>
            
            <div class="objection-card">
                <div class="objection-title">"Alguns dados s√£o confidenciais"</div>
                <div class="objection-response">
                    "O IBGE garante total confidencialidade e sigilo estat√≠stico. Os dados individuais jamais s√£o divulgados - apenas dados agregados e estat√≠sticas gerais. Temos protocolo rigoroso de prote√ß√£o de dados seguindo a LGPD."
                </div>
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn-secondary-custom" onclick="etapaAnterior(3)">
                <i class="fas fa-arrow-left"></i> Anterior
            </button>
            <button class="btn-primary-custom" onclick="proximaEtapa(5)">
                Pr√≥ximo <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- Etapa 5: Checklist de Prepara√ß√£o -->
    <div class="step-container" id="etapa-5" style="display: none;">
        <div class="step-header">
            <div class="step-number">5</div>
            <h3 class="step-title">Checklist de Prepara√ß√£o</h3>
        </div>
        <p class="step-description">Verifica√ß√µes finais antes da abordagem</p>
        
        <div class="checklist-container">
            <div class="checklist-item">
                <input type="checkbox" id="check-1">
                <label for="check-1">Revisar perfil do informante e hist√≥rico de contatos</label>
            </div>
            <div class="checklist-item">
                <input type="checkbox" id="check-2">
                <label for="check-2">Preparar documentos oficiais (carta IBGE, credencial)</label>
            </div>
            <div class="checklist-item">
                <input type="checkbox" id="check-3">
                <label for="check-3">Verificar dados de contato atualizados</label>
            </div>
            <div class="checklist-item">
                <input type="checkbox" id="check-4">
                <label for="check-4">Definir hor√°rio preferencial baseado no perfil</label>
            </div>
            <div class="checklist-item">
                <input type="checkbox" id="check-5">
                <label for="check-5">Preparar question√°rio espec√≠fico (MRS/MAP)</label>
            </div>
            <div class="checklist-item">
                <input type="checkbox" id="check-6">
                <label for="check-6">Ensaiar script de abertura</label>
            </div>
            <div class="checklist-item">
                <input type="checkbox" id="check-7">
                <label for="check-7">Preparar respostas para obje√ß√µes comuns</label>
            </div>
            <div class="checklist-item">
                <input type="checkbox" id="check-8">
                <label for="check-8">Configurar sistema para registro da abordagem</label>
            </div>
        </div>

        <div class="tips-container">
            <div class="tips-title">
                <i class="fas fa-lightbulb"></i>
                Dicas Importantes
            </div>
            <div class="tip-item">Mantenha um tom profissional mas amig√°vel</div>
            <div class="tip-item">Seja flex√≠vel com hor√°rios e formato da reuni√£o</div>
            <div class="tip-item">Enfatize a import√¢ncia nacional da pesquisa</div>
            <div class="tip-item">Registre todas as intera√ß√µes no sistema</div>
            <div class="tip-item">Tenha sempre um plano B preparado</div>
        </div>

        <div class="action-buttons">
            <button class="btn-secondary-custom" onclick="etapaAnterior(4)">
                <i class="fas fa-arrow-left"></i> Anterior
            </button>
            <button class="btn-primary-custom" onclick="iniciarAbordagem()">
                <i class="fas fa-phone"></i> Iniciar Abordagem
            </button>
            <button class="btn-secondary-custom" onclick="salvarPreparacao()">
                <i class="fas fa-save"></i> Salvar Prepara√ß√£o
            </button>
        </div>
    </div>
</div>

<!-- Assistente Flutuante -->
<div class="floating-assistant" onclick="toggleAssistenteFlutuante()" title="Assistente IA">
    <i class="fas fa-robot"></i>
</div>
{% endblock %}

{% block scripts %}
<script>
let etapaAtual = 2;
let dadosAbordagem = {
    municipio: '',
    informante: '',
    perfil: {},
    script: '',
    checklist: []
};

document.addEventListener('DOMContentLoaded', function() {
    inicializarAssistente();
    carregarPerfilInformante();
});

function inicializarAssistente() {
    // Adicionar listeners para checkboxes
    document.querySelectorAll('#etapa-5 input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const item = this.closest('.checklist-item');
            if (this.checked) {
                item.classList.add('completed');
            } else {
                item.classList.remove('completed');
            }
            verificarProgressoChecklist();
        });
    });
}

function proximaEtapa(proxima) {
    // Ocultar etapa atual
    document.getElementById(`etapa-${etapaAtual}`).style.display = 'none';
    document.getElementById(`etapa-${etapaAtual}`).classList.remove('active');
    document.getElementById(`step-${etapaAtual}`).classList.remove('active');
    document.getElementById(`step-${etapaAtual}`).classList.add('completed');
    
    // Mostrar pr√≥xima etapa
    etapaAtual = proxima;
    document.getElementById(`etapa-${etapaAtual}`).style.display = 'block';
    document.getElementById(`etapa-${etapaAtual}`).classList.add('active');
    document.getElementById(`step-${etapaAtual}`).classList.add('active');
    
    // Carregar dados espec√≠ficos da etapa
    switch(etapaAtual) {
        case 3:
            gerarScript();
            break;
        case 4:
            carregarObjecoes();
            break;
        case 5:
            verificarPreparacao();
            break;
    }
    
    // Scroll suave para o topo
    document.querySelector('.step-container.active').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
    });
}

function etapaAnterior(anterior) {
    // Ocultar etapa atual
    document.getElementById(`etapa-${etapaAtual}`).style.display = 'none';
    document.getElementById(`etapa-${etapaAtual}`).classList.remove('active');
    document.getElementById(`step-${etapaAtual}`).classList.remove('active');
    
    // Mostrar etapa anterior
    etapaAtual = anterior;
    document.getElementById(`etapa-${etapaAtual}`).style.display = 'block';
    document.getElementById(`etapa-${etapaAtual}`).classList.add('active');
    document.getElementById(`step-${etapaAtual}`).classList.add('active');
    document.getElementById(`step-${etapaAtual}`).classList.remove('completed');
    
    // Scroll suave para o topo
    document.querySelector('.step-container.active').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
    });
}

async function carregarPerfilInformante() {
    try {
        // Simular carregamento do perfil
        showToast('Carregando perfil do informante...', 'info');
        
        // Em produ√ß√£o, buscar do endpoint real
        // const response = await fetch('/api/pnsb/perfil-informante/Jo√£o Silva Santos/Itaja√≠');
        
        // Dados simulados para demonstra√ß√£o
        const perfil = {
            nome: 'Jo√£o Silva Santos',
            cargo: 'Secret√°rio Municipal de Meio Ambiente',
            municipio: 'Itaja√≠',
            telefone: '(47) 9876-5432',
            email: 'joao.silva@prefeitura.sc.gov.br',
            melhor_horario: '14h-16h',
            ultimo_contato: '15/12/2024',
            taxa_sucesso: '85%',
            estilo_comunicacao: 'Formal e t√©cnico',
            personalidade: ['Cooperativo', 'Detalhista', 'Formal'],
            historico_abordagens: [
                { data: '15/12/2024', resultado: 'Sucesso', observacoes: 'Muito receptivo' },
                { data: '03/11/2024', resultado: 'Reagendado', observacoes: 'Solicitou nova data' }
            ]
        };
        
        dadosAbordagem.perfil = perfil;
        atualizarInterfacePerfil(perfil);
        
        showToast('Perfil carregado com sucesso!', 'success');
    } catch (error) {
        console.error('Erro ao carregar perfil:', error);
        showToast('Erro ao carregar perfil do informante', 'danger');
    }
}

function atualizarInterfacePerfil(perfil) {
    document.getElementById('profile-name').textContent = perfil.nome;
    document.getElementById('profile-role').textContent = perfil.cargo;
    document.getElementById('profile-phone').textContent = perfil.telefone;
    document.getElementById('profile-email').textContent = perfil.email;
    document.getElementById('profile-hours').textContent = `Melhor hor√°rio: ${perfil.melhor_horario}`;
    document.getElementById('profile-lastcontact').textContent = `√öltimo contato: ${perfil.ultimo_contato}`;
    document.getElementById('profile-success').textContent = `Taxa de sucesso: ${perfil.taxa_sucesso}`;
    document.getElementById('profile-communication').textContent = `Estilo: ${perfil.estilo_comunicacao}`;
    
    // Atualizar tags de personalidade
    const tagsContainer = document.getElementById('profile-tags');
    tagsContainer.innerHTML = '';
    perfil.personalidade.forEach(tag => {
        const span = document.createElement('span');
        span.className = 'personality-tag';
        span.textContent = tag;
        tagsContainer.appendChild(span);
    });
}

async function gerarScript() {
    try {
        showToast('Gerando script personalizado...', 'info');
        
        // Simular gera√ß√£o de script pela IA
        setTimeout(() => {
            const scripts = [
                {
                    abertura: `"Bom dia, ${dadosAbordagem.perfil.nome}. Meu nome √© [SEU NOME], sou pesquisador do IBGE respons√°vel pela Pesquisa Nacional de Saneamento B√°sico 2024. Como conversamos anteriormente, gostaria de agendar uma visita para coletarmos as informa√ß√µes sobre o manejo de res√≠duos s√≥lidos do munic√≠pio. Sei que o senhor valoriza a precis√£o dos dados, por isso preparei um question√°rio estruturado que otimizar√° nosso tempo. Qual seria a melhor data e hor√°rio para nossa reuni√£o?"`,
                    pontos: [
                        'Import√¢ncia nacional da pesquisa PNSB',
                        'Dados ser√£o usados para pol√≠ticas p√∫blicas',
                        'Compromisso com a confidencialidade',
                        'Dura√ß√£o estimada: 45-60 minutos',
                        'Possibilidade de visita t√©cnica √†s instala√ß√µes'
                    ]
                },
                {
                    abertura: `"Ol√°, ${dadosAbordagem.perfil.nome}. Espero que esteja bem. Sou [SEU NOME] do IBGE e gostaria de dar continuidade ao nosso processo da Pesquisa Nacional de Saneamento B√°sico. Preparei uma abordagem t√©cnica focada nos aspectos que s√£o de maior interesse para a gest√£o municipal. Quando seria conveniente para realizarmos nossa coleta de dados?"`,
                    pontos: [
                        'Foco na gest√£o t√©cnica municipal',
                        'Dados comparativos com outros munic√≠pios',
                        'Relat√≥rio t√©cnico personalizado',
                        'Flexibilidade na metodologia',
                        'Suporte t√©cnico cont√≠nuo'
                    ]
                }
            ];
            
            const scriptEscolhido = scripts[Math.floor(Math.random() * scripts.length)];
            
            document.getElementById('script-abertura').textContent = scriptEscolhido.abertura;
            
            const pontosContainer = document.getElementById('pontos-chave');
            pontosContainer.innerHTML = '';
            scriptEscolhido.pontos.forEach(ponto => {
                const li = document.createElement('li');
                li.textContent = ponto;
                pontosContainer.appendChild(li);
            });
            
            dadosAbordagem.script = scriptEscolhido;
            showToast('Script gerado com sucesso!', 'success');
        }, 1500);
        
    } catch (error) {
        console.error('Erro ao gerar script:', error);
        showToast('Erro ao gerar script', 'danger');
    }
}

function regenerarScript() {
    gerarScript();
}

function carregarObjecoes() {
    // Obje√ß√µes j√° est√£o carregadas no HTML
    // Aqui poderia buscar obje√ß√µes espec√≠ficas do perfil
    showToast('Obje√ß√µes comuns carregadas', 'info');
}

function verificarPreparacao() {
    const checkboxes = document.querySelectorAll('#etapa-5 input[type="checkbox"]');
    let totalMarcados = 0;
    
    checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
            totalMarcados++;
        }
    });
    
    const progresso = Math.round((totalMarcados / checkboxes.length) * 100);
    
    if (progresso === 100) {
        showToast('Prepara√ß√£o completa! Pronto para abordagem.', 'success');
    } else if (progresso >= 75) {
        showToast(`Prepara√ß√£o quase completa (${progresso}%)`, 'warning');
    } else {
        showToast(`Complete o checklist de prepara√ß√£o (${progresso}%)`, 'info');
    }
}

function verificarProgressoChecklist() {
    verificarPreparacao();
}

function iniciarAbordagem() {
    const checkboxes = document.querySelectorAll('#etapa-5 input[type="checkbox"]');
    const totalMarcados = Array.from(checkboxes).filter(cb => cb.checked).length;
    
    if (totalMarcados < checkboxes.length * 0.8) {
        showToast('Complete pelo menos 80% do checklist antes de iniciar', 'warning');
        return;
    }
    
    showToast('Iniciando abordagem...', 'info');
    
    setTimeout(() => {
        if (confirm('Deseja registrar esta abordagem no sistema e abrir a tela de agendamento?')) {
            // Registrar abordagem
            registrarAbordagem();
            // Redirecionar para agendamento
            window.location.href = '/visitas?informante=' + encodeURIComponent(dadosAbordagem.perfil.nome);
        }
    }, 1000);
}

async function registrarAbordagem() {
    try {
        const abordagem = {
            informante_nome: dadosAbordagem.perfil.nome,
            municipio: dadosAbordagem.perfil.municipio,
            dados_tentativa: {
                data_abordagem: new Date().toISOString(),
                tipo_abordagem: 'telefonica_assistida',
                script_utilizado: dadosAbordagem.script,
                preparacao_completa: true,
                checklist_items: Array.from(document.querySelectorAll('#etapa-5 input[type="checkbox"]'))
                    .map((cb, index) => ({
                        item: cb.nextElementSibling.textContent,
                        completed: cb.checked
                    }))
            }
        };
        
        // Em produ√ß√£o, enviar para API
        // await fetch('/api/pnsb/perfil-informante/registrar-tentativa', {
        //     method: 'POST',
        //     headers: { 'Content-Type': 'application/json' },
        //     body: JSON.stringify(abordagem)
        // });
        
        showToast('Abordagem registrada com sucesso!', 'success');
    } catch (error) {
        console.error('Erro ao registrar abordagem:', error);
        showToast('Erro ao registrar abordagem', 'danger');
    }
}

function salvarPreparacao() {
    showToast('Prepara√ß√£o salva! Voc√™ pode continuar depois.', 'success');
}

function iniciarNovaAbordagem() {
    // Reset do assistente
    etapaAtual = 1;
    
    // Ocultar todas as etapas
    for (let i = 1; i <= 5; i++) {
        document.getElementById(`etapa-${i}`).style.display = 'none';
        document.getElementById(`etapa-${i}`).classList.remove('active');
        document.getElementById(`step-${i}`).className = 'progress-step';
    }
    
    // Mostrar primeira etapa
    document.getElementById('etapa-1').style.display = 'block';
    document.getElementById('etapa-1').classList.add('active');
    document.getElementById('step-1').classList.add('active');
    
    // Limpar dados
    dadosAbordagem = {
        municipio: '',
        informante: '',
        perfil: {},
        script: '',
        checklist: []
    };
    
    showToast('Nova abordagem iniciada', 'info');
}

function consultarHistorico() {
    showToast('Abrindo hist√≥rico de abordagens...', 'info');
    // Implementar interface de hist√≥rico
}

function toggleAssistenteFlutuante() {
    showToast('Assistente IA: Como posso ajudar?', 'info');
    // Implementar chat com assistente
}

function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}
</script>
{% endblock %}