<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mapa de Progresso - Sistema PNSB</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Pesquisa Nacional de Saneamento Básico - Sistema de Gestão de Visitas">
    <meta name="theme-color" content="#5F5CFF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="PNSB 2024">
    <meta name="msapplication-TileColor" content="#5F5CFF">
    <meta name="msapplication-config" content="/static/browserconfig.xml">
    
    <!-- Web App Manifest -->
    <link rel="manifest" href="/static/manifest.json">
    
    <!-- Favicon and Icons -->
    <link rel="icon" type="image/x-icon" href="/static/icons/favicon.ico">
    <link rel="icon" type="image/svg+xml" href="/static/icons/icon-base.svg">
    <link rel="apple-touch-icon" href="/static/icons/icon-base.svg">
    
    <!-- External Resources -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/design-system.css" rel="stylesheet">
    <style>
        /* Estilos específicos da página base */
        .main-content {
            margin-top: 80px;
            margin-bottom: 32px;
            padding: var(--spacing-lg);
            transition: margin-left var(--transition-normal);
        }

        /* Chatbox Styles */
        .chatbox-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .chatbox-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(90deg, #5F5CFF 0%, #6EE7B7 100%);
            color: white;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .chatbox-window {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 350px;
            height: 500px;
            background: #23263B;
            border-radius: 16px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .chatbox-header {
            background: linear-gradient(90deg, #5F5CFF 0%, #6EE7B7 100%);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chatbox-messages {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            background: #181A20;
        }

        .message {
            margin-bottom: 10px;
            max-width: 80%;
        }

        .message.user {
            margin-left: auto;
            background: linear-gradient(90deg, #5F5CFF 0%, #6EE7B7 100%);
            color: white;
            padding: 10px;
            border-radius: 15px 15px 0 15px;
        }

        .message.bot {
            margin-right: auto;
            background: #2D3142;
            color: #F1F1F1;
            padding: 10px;
            border-radius: 15px 15px 15px 0;
        }

        .chatbox-input {
            padding: 15px;
            background: #23263B;
            border-top: 1px solid #2D3142;
            display: flex;
            gap: 10px;
        }

        .chatbox-input input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #2D3142;
            border-radius: 20px;
            background: #181A20;
            color: #F1F1F1;
        }

        .chatbox-input button {
            background: linear-gradient(90deg, #5F5CFF 0%, #6EE7B7 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
        }

        .chatbox-input button:hover {
            background: linear-gradient(90deg, #6EE7B7 0%, #5F5CFF 100%);
        }
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(24, 26, 32, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #2D3142;
            border-top: 4px solid #5F5CFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #F1F1F1;
            margin-top: 20px;
            font-size: 16px;
        }

        /* Error Toast Styling */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast-notification {
            min-width: 300px;
            max-width: 500px;
            padding: 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-notification.success {
            background-color: #28a745;
            color: white;
        }

        .toast-notification.error {
            background-color: #dc3545;
            color: white;
        }

        .toast-notification.warning {
            background-color: #ffc107;
            color: #212529;
        }

        .toast-notification.info {
            background-color: #17a2b8;
            color: white;
        }

        /* Smooth transitions */
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        /* Better focus states */
        button:focus, a:focus, input:focus, select:focus, textarea:focus {
            outline: 2px solid #5F5CFF;
            outline-offset: 2px;
        }

        /* Skeleton loader */
        .skeleton {
            background: linear-gradient(90deg, #2D3142 25%, #3A3F54 50%, #2D3142 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }
    </style>
    
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
/* =============================================================================
   MAPA DE PROGRESSO SIMPLIFICADO - VERSÃO FUNCIONAL
   Focado em funcionalidades essenciais e práticas
   Backup completo disponível em: mapa_progresso_BACKUP_COMPLETO.html
   ============================================================================= */

.map-container {
    background: #23263B;
    border-radius: 16px;
    overflow: hidden;
    position: relative;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}

#mapa-progresso {
    height: 600px;
    width: 100%;
    border-radius: 16px;
}

/* DASHBOARD LATERAL SIMPLIFICADO */
.dashboard-sidebar {
    position: fixed;
    top: 80px;
    right: 20px;
    width: 320px;
    max-height: calc(100vh - 100px);
    background: #23263B;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    z-index: 1000;
    overflow-y: auto;
    transform: translateX(340px);
    transition: transform 0.3s ease;
}

.dashboard-sidebar.open {
    transform: translateX(0);
}

.sidebar-toggle {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #5F5CFF;
    color: white;
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    font-size: 18px;
    cursor: pointer;
    z-index: 1001;
    box-shadow: 0 4px 16px rgba(95, 92, 255, 0.3);
    transition: all 0.3s ease;
}

.sidebar-toggle:hover {
    background: #4845E4;
    transform: scale(1.1);
}

/* CARDS DE TAREFAS */
.task-card {
    background: #2D3142;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
    border-left: 4px solid #5F5CFF;
    transition: all 0.3s ease;
}

.task-card:hover {
    background: #343751;
    transform: translateY(-2px);
}

.task-card.urgent {
    border-left-color: #dc3545;
    background: rgba(220, 53, 69, 0.1);
}

.task-card.warning {
    border-left-color: #ffc107;
    background: rgba(255, 193, 7, 0.1);
}

.task-card.success {
    border-left-color: #28a745;
    background: rgba(40, 167, 69, 0.1);
}

.task-title {
    color: #F1F1F1;
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 8px;
}

.task-details {
    color: #B8BCC8;
    font-size: 12px;
    margin-bottom: 10px;
}

.task-actions {
    display: flex;
    gap: 8px;
}

.btn-task {
    padding: 4px 8px;
    font-size: 11px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-primary { background: #5F5CFF; color: white; }
.btn-success { background: #28a745; color: white; }
.btn-warning { background: #ffc107; color: #212529; }

/* FILTROS SIMPLIFICADOS */
.filters-container {
    background: #23263B;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
}

.filter-group {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    align-items: center;
}

.filter-label {
    color: #F1F1F1;
    font-weight: 500;
    min-width: 80px;
}

.filter-select {
    background: #2D3142;
    color: #F1F1F1;
    border: 1px solid #5F5CFF;
    border-radius: 8px;
    padding: 8px 12px;
    outline: none;
    cursor: pointer;
}

.filter-select:focus {
    border-color: #6EE7B7;
    box-shadow: 0 0 0 2px rgba(110, 231, 183, 0.2);
}

/* MODAL DE DETALHES DO MUNICÍPIO */
.modal-municipio {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 2000;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: #23263B;
    border-radius: 16px;
    padding: 30px;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    position: relative;
    box-shadow: 0 16px 64px rgba(0,0,0,0.5);
}

.modal-close {
    position: absolute;
    top: 15px;
    right: 20px;
    background: none;
    border: none;
    color: #B8BCC8;
    font-size: 24px;
    cursor: pointer;
}

.modal-close:hover {
    color: #F1F1F1;
}

/* DASHBOARD DE PRODUTIVIDADE PNSB */
.productivity-dashboard {
    background: #23263B;
    border-radius: 16px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}

.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    border-bottom: 2px solid #2D3142;
    padding-bottom: 15px;
}

.dashboard-title {
    color: #F1F1F1;
    font-size: 24px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
}

.pnsb-badge {
    background: linear-gradient(135deg, #5F5CFF, #6EE7B7);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}

/* CONTADOR REGRESSIVO DUPLO */
.countdown-dual {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.countdown-container {
    border-radius: 12px;
    padding: 15px;
    text-align: center;
    color: white;
    box-shadow: 0 4px 16px rgba(0,0,0,0.3);
}

.countdown-container.visits {
    background: linear-gradient(135deg, #dc3545, #ff6b7a);
}

.countdown-container.questionnaires {
    background: linear-gradient(135deg, #ffc107, #ffdb4d);
    color: #212529;
}

.countdown-title {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 8px;
    opacity: 0.9;
}

.countdown-time {
    font-size: 28px;
    font-weight: 800;
    line-height: 1;
}

.countdown-unit {
    font-size: 12px;
    font-weight: 500;
    opacity: 0.8;
}

/* CARDS DE PRIORIDADE P1/P2/P3 */
.priority-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
}

.priority-card {
    background: #2D3142;
    border-radius: 16px;
    padding: 25px;
    border-left: 6px solid;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.priority-card::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 60px;
    height: 60px;
    opacity: 0.1;
    background: currentColor;
    clip-path: polygon(100% 0%, 0% 100%, 100% 100%);
}

.priority-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 40px rgba(0,0,0,0.4);
}

.priority-card.p1 {
    border-left-color: #dc3545;
    background: linear-gradient(135deg, #2D3142, rgba(220, 53, 69, 0.05));
}

.priority-card.p2 {
    border-left-color: #ffc107;
    background: linear-gradient(135deg, #2D3142, rgba(255, 193, 7, 0.05));
}

.priority-card.p3 {
    border-left-color: #28a745;
    background: linear-gradient(135deg, #2D3142, rgba(40, 167, 69, 0.05));
}

.priority-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.priority-title {
    font-size: 18px;
    font-weight: 700;
    color: #F1F1F1;
    display: flex;
    align-items: center;
    gap: 8px;
}

.priority-icon {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    font-size: 14px;
    color: white;
}

.priority-icon.p1 { background: #dc3545; }
.priority-icon.p2 { background: #ffc107; color: #212529; }
.priority-icon.p3 { background: #28a745; }

.priority-percentage {
    font-size: 32px;
    font-weight: 800;
    line-height: 1;
}

.priority-percentage.p1 { color: #dc3545; }
.priority-percentage.p2 { color: #ffc107; }
.priority-percentage.p3 { color: #28a745; }

.priority-progress {
    width: 100%;
    height: 8px;
    background: #343751;
    border-radius: 4px;
    overflow: hidden;
    margin: 15px 0;
}

.priority-progress-bar {
    height: 100%;
    border-radius: 4px;
    transition: width 0.8s ease;
    position: relative;
}

.priority-progress-bar.p1 {
    background: linear-gradient(90deg, #dc3545, #ff6b7a);
}

.priority-progress-bar.p2 {
    background: linear-gradient(90deg, #ffc107, #ffda6a);
}

.priority-progress-bar.p3 {
    background: linear-gradient(90deg, #28a745, #6bcf7f);
}

.priority-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-top: 15px;
}

.priority-stat {
    text-align: center;
}

.priority-stat-number {
    font-size: 20px;
    font-weight: 700;
    color: #F1F1F1;
    line-height: 1;
}

.priority-stat-label {
    font-size: 11px;
    color: #B8BCC8;
    text-transform: uppercase;
    font-weight: 500;
    margin-top: 4px;
}

/* MÉTRICAS DE VELOCIDADE */
.velocity-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 25px;
}

.velocity-card {
    background: #2D3142;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    border: 2px solid transparent;
    transition: all 0.3s ease;
}

.velocity-card:hover {
    border-color: #5F5CFF;
    transform: translateY(-2px);
}

.velocity-number {
    font-size: 28px;
    font-weight: bold;
    color: #5F5CFF;
    margin-bottom: 5px;
}

.velocity-label {
    color: #B8BCC8;
    font-size: 12px;
    text-transform: uppercase;
}

.velocity-trend {
    font-size: 14px;
    font-weight: 600;
    margin-top: 8px;
}

.trend-up { color: #28a745; }
.trend-down { color: #dc3545; }
.trend-stable { color: #ffc107; }

/* SISTEMA DE ALERTAS INTELIGENTES */
.smart-alerts-container {
    background: #23263B;
    border-radius: 16px;
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}

.alerts-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    border-bottom: 2px solid #2D3142;
    padding-bottom: 15px;
}

.alert-badge {
    background: linear-gradient(135deg, #dc3545, #ff6b7a);
    color: white;
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 12px;
    font-weight: 700;
    min-width: 20px;
    text-align: center;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.alerts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 15px;
    max-height: 300px;
    overflow-y: auto;
}

.alert-card {
    background: #2D3142;
    border-radius: 12px;
    padding: 20px;
    border-left: 5px solid;
    transition: all 0.3s ease;
    position: relative;
}

.alert-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.4);
}

.alert-card.critical {
    border-left-color: #dc3545;
    background: linear-gradient(135deg, #2D3142, rgba(220, 53, 69, 0.08));
}

.alert-card.warning {
    border-left-color: #ffc107;
    background: linear-gradient(135deg, #2D3142, rgba(255, 193, 7, 0.08));
}

.alert-card.info {
    border-left-color: #17a2b8;
    background: linear-gradient(135deg, #2D3142, rgba(23, 162, 184, 0.08));
}

.alert-icon {
    position: absolute;
    top: 15px;
    right: 15px;
    font-size: 24px;
    opacity: 0.3;
}

.alert-title {
    color: #F1F1F1;
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.alert-description {
    color: #B8BCC8;
    font-size: 14px;
    margin-bottom: 12px;
    line-height: 1.4;
}

.alert-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.alert-button {
    padding: 6px 12px;
    font-size: 12px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 600;
}

.alert-button.primary {
    background: #5F5CFF;
    color: white;
}

.alert-button.primary:hover {
    background: #4845E4;
}

.alert-button.secondary {
    background: #343751;
    color: #B8BCC8;
}

.alert-button.secondary:hover {
    background: #3d4258;
    color: #F1F1F1;
}

.alert-priority {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(0,0,0,0.6);
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 700;
}

.alert-priority.p1 { background: rgba(220, 53, 69, 0.8); }
.alert-priority.p2 { background: rgba(255, 193, 7, 0.8); color: #212529; }
.alert-priority.p3 { background: rgba(40, 167, 69, 0.8); }

/* TIMELINE DE PROGRESSO */
.timeline-container {
    background: #23263B;
    border-radius: 16px;
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}

.timeline-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    border-bottom: 2px solid #2D3142;
    padding-bottom: 15px;
}

.timeline-title {
    color: #F1F1F1;
    font-size: 20px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
}

.timeline-track {
    position: relative;
    height: 80px;
    background: #2D3142;
    border-radius: 40px;
    padding: 10px 20px;
    overflow: hidden;
}

.timeline-progress {
    height: 100%;
    background: linear-gradient(90deg, #5F5CFF, #6EE7B7);
    border-radius: 30px;
    transition: width 1s ease;
    position: relative;
}

.timeline-milestones {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    pointer-events: none;
}

.milestone {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #343751;
    border: 3px solid #5F5CFF;
    position: relative;
}

.milestone.completed {
    background: #28a745;
    border-color: #28a745;
}

.milestone.current {
    background: #ffc107;
    border-color: #ffc107;
    animation: pulse 2s infinite;
}

.milestone-label {
    position: absolute;
    top: 25px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 10px;
    color: #B8BCC8;
    white-space: nowrap;
    font-weight: 600;
}

/* HEATMAP DE INTENSIDADE */
.heatmap-controls {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(35, 38, 59, 0.95);
    border-radius: 12px;
    padding: 15px;
    z-index: 1000;
    box-shadow: 0 4px 16px rgba(0,0,0,0.3);
}

.heatmap-title {
    color: #F1F1F1;
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.heatmap-options {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.heatmap-option {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 6px;
    transition: background 0.2s ease;
}

.heatmap-option:hover {
    background: rgba(95, 92, 255, 0.1);
}

.heatmap-option input[type="radio"] {
    margin: 0;
}

.heatmap-option label {
    color: #B8BCC8;
    font-size: 12px;
    cursor: pointer;
    margin: 0;
}

.heatmap-legend {
    margin-top: 15px;
    border-top: 1px solid #2D3142;
    padding-top: 12px;
}

.legend-title {
    color: #F1F1F1;
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 8px;
}

.legend-items {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.legend-color {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid rgba(255,255,255,0.3);
}

.legend-text {
    color: #B8BCC8;
    font-size: 11px;
}

/* Estilos para marcadores do heatmap */
.heatmap-marker {
    border-radius: 50%;
    border: 3px solid rgba(255,255,255,0.8);
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.heatmap-marker:hover {
    transform: scale(1.2);
    border-width: 4px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.5);
}

/* Cores do heatmap por intensidade */
.intensity-very-low { 
    background: #28a745;
    border-color: rgba(40, 167, 69, 0.8);
}

.intensity-low { 
    background: #6bcf7f;
    border-color: rgba(107, 207, 127, 0.8);
}

.intensity-medium { 
    background: #ffc107;
    border-color: rgba(255, 193, 7, 0.8);
}

.intensity-high { 
    background: #fd7e14;
    border-color: rgba(253, 126, 20, 0.8);
}

.intensity-very-high { 
    background: #dc3545;
    border-color: rgba(220, 53, 69, 0.8);
}

/* Marcadores pulsantes para alta prioridade */
.intensity-very-high {
    animation: heatmapPulse 2s infinite;
}

@keyframes heatmapPulse {
    0% { 
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
    }
    50% { 
        transform: scale(1.1);
        box-shadow: 0 0 0 10px rgba(220, 53, 69, 0.3);
    }
    100% { 
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
    }
}

/* Overlay para áreas de densidade */
.density-overlay {
    position: absolute;
    border-radius: 50%;
    pointer-events: none;
    z-index: 500;
}

.density-low {
    background: radial-gradient(circle, rgba(40, 167, 69, 0.1) 0%, transparent 70%);
}

.density-medium {
    background: radial-gradient(circle, rgba(255, 193, 7, 0.15) 0%, transparent 70%);
}

.density-high {
    background: radial-gradient(circle, rgba(220, 53, 69, 0.2) 0%, transparent 70%);
}

/* ESTATÍSTICAS RÁPIDAS */
.stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.stat-card {
    background: #2D3142;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    border: 2px solid transparent;
    transition: all 0.3s ease;
}

.stat-card:hover {
    border-color: #5F5CFF;
    transform: translateY(-2px);
}

.stat-number {
    font-size: 28px;
    font-weight: bold;
    color: #5F5CFF;
    margin-bottom: 5px;
}

.stat-label {
    color: #B8BCC8;
    font-size: 12px;
    text-transform: uppercase;
}

/* CORES DE STATUS */
.status-finalizado { color: #28a745; }
.status-em-followup { color: #ffc107; }
.status-executado { color: #17a2b8; }
.status-agendado { color: #B0B3C7; }
.status-sem-visita { color: #dc3545; }

/* RESPONSIVIDADE */
@media (max-width: 768px) {
    .dashboard-sidebar {
        width: calc(100vw - 40px);
        right: 20px;
        transform: translateX(calc(100vw - 20px));
    }
    
    .dashboard-sidebar.open {
        transform: translateX(0);
    }
    
    .stats-container {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .filters-container {
        padding: 15px;
    }
    
    .filter-group {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
    }
}

/* LOADING E ESTADOS */
.loading {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 40px;
    color: #B8BCC8;
}

.error {
    color: #dc3545;
    text-align: center;
    padding: 20px;
    background: rgba(220, 53, 69, 0.1);
    border-radius: 8px;
    margin: 20px 0;
}

.success {
    color: #28a745;
    text-align: center;
    padding: 20px;
    background: rgba(40, 167, 69, 0.1);
    border-radius: 8px;
    margin: 20px 0;
}

/* =============================================================================
   CENTRAL DE PLANEJAMENTO COM CALENDÁRIO VISUAL
   ============================================================================= */

.planning-center {
    background: #23263B;
    border-radius: 16px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}

.planning-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    border-bottom: 2px solid #2D3142;
    padding-bottom: 15px;
}

.planning-title {
    color: #F1F1F1;
    font-size: 24px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
}

.planning-badge {
    background: linear-gradient(135deg, #ffc107, #ffeb3b);
    color: #212529;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}

.planning-controls {
    display: flex;
    gap: 10px;
}

.btn-planning {
    background: #5F5CFF;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
}

.btn-planning:hover {
    background: #4845E4;
    transform: translateY(-2px);
}

/* LAYOUT CALENDÁRIO + AGENDA */
.planning-layout {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 25px;
    align-items: start;
}

/* CALENDÁRIO VISUAL */
.calendar-container {
    background: #2D3142;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.calendar-nav {
    background: #5F5CFF;
    color: white;
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.calendar-nav:hover {
    background: #4845E4;
    transform: scale(1.1);
}

.calendar-title {
    color: #F1F1F1;
    font-size: 20px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
}

.calendar-grid {
    width: 100%;
}

.calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    margin-bottom: 10px;
}

.weekday {
    background: #5F5CFF;
    color: white;
    padding: 10px;
    text-align: center;
    font-weight: 600;
    font-size: 12px;
    border-radius: 6px;
}

.calendar-days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
}

.calendar-day {
    background: #23263B;
    color: #F1F1F1;
    padding: 12px;
    text-align: center;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    min-height: 60px;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: center;
}

.calendar-day:hover {
    background: #343751;
    transform: translateY(-2px);
}

.calendar-day.selected {
    background: #5F5CFF;
    color: white;
}

.calendar-day.today {
    background: #28a745;
    color: white;
    font-weight: bold;
}

.calendar-day.other-month {
    background: #1A1D2E;
    color: #666;
}

.calendar-day.has-visits {
    border: 2px solid #ffc107;
}

.calendar-day.has-visits::after {
    content: '';
    position: absolute;
    bottom: 4px;
    left: 50%;
    transform: translateX(-50%);
    width: 6px;
    height: 6px;
    background: #ffc107;
    border-radius: 50%;
}

.day-number {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 2px;
}

.day-visits {
    font-size: 10px;
    color: #B8BCC8;
    display: flex;
    gap: 2px;
    flex-wrap: wrap;
}

.visit-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #5F5CFF;
}

.visit-dot.p1 { background: #dc3545; }
.visit-dot.p2 { background: #ffc107; }
.visit-dot.p3 { background: #28a745; }

/* AGENDA LATERAL */
.agenda-lateral {
    background: #2D3142;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    height: fit-content;
    max-height: 400px;
    overflow-y: auto;
}

.agenda-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    border-bottom: 2px solid #23263B;
    padding-bottom: 15px;
}

.agenda-header h4 {
    color: #F1F1F1;
    margin: 0;
    font-size: 18px;
}

.agenda-date {
    background: #5F5CFF;
    color: white;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}

.agenda-content {
    margin-bottom: 20px;
}

.agenda-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    background: #23263B;
    border-radius: 8px;
    margin-bottom: 10px;
    border-left: 4px solid #5F5CFF;
    transition: all 0.3s ease;
}

.agenda-item:hover {
    background: #343751;
    transform: translateY(-2px);
}

.agenda-item.empty {
    border-left-color: #666;
    opacity: 0.7;
}

.agenda-item.p1 { border-left-color: #dc3545; }
.agenda-item.p2 { border-left-color: #ffc107; }
.agenda-item.p3 { border-left-color: #28a745; }

.agenda-time {
    color: #5F5CFF;
    font-weight: 600;
    font-size: 14px;
    min-width: 50px;
}

.agenda-details {
    flex: 1;
}

.agenda-title {
    color: #F1F1F1;
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 4px;
}

.agenda-subtitle {
    color: #B8BCC8;
    font-size: 12px;
}

.agenda-footer {
    border-top: 2px solid #23263B;
    padding-top: 15px;
}

.btn-agenda {
    background: #28a745;
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    width: 100%;
    justify-content: center;
}

.btn-agenda:hover {
    background: #218838;
    transform: translateY(-2px);
}

/* LAYOUT RESPONSIVO DO CALENDÁRIO */
@media (max-width: 1200px) {
    .planning-center {
        padding: 20px;
    }
    
    .planning-layout {
        gap: 20px;
    }
    
    .calendar-container {
        margin-bottom: 15px;
    }
    
    .agenda-lateral {
        max-height: 300px;
    }
}

@media (max-width: 768px) {
    .planning-header {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
    }
    
    .planning-controls {
        flex-wrap: wrap;
        width: 100%;
    }
    
    .planning-layout {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .calendar-day {
        min-height: 40px;
        padding: 8px;
    }
    
    .calendar-title {
        font-size: 18px;
    }
    
    .agenda-lateral {
        max-height: 250px;
    }
}

/* =============================================================================
   RELATÓRIOS EXECUTIVOS AUTOMATIZADOS
   ============================================================================= */

.executive-reports {
    background: #23263B;
    border-radius: 16px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}

.reports-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    border-bottom: 2px solid #2D3142;
    padding-bottom: 15px;
}

.reports-title {
    color: #F1F1F1;
    font-size: 24px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
}

.reports-badge {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}

.reports-controls {
    display: flex;
    gap: 10px;
}

.btn-report {
    background: #5F5CFF;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
}

.btn-report:hover {
    background: #4845E4;
    transform: translateY(-2px);
}

/* GRID DE RELATÓRIOS */
.reports-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
}

.report-card {
    background: #2D3142;
    border-radius: 12px;
    padding: 20px;
    border-left: 6px solid;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 15px;
    position: relative;
    overflow: hidden;
}

.report-card:hover {
    background: #343751;
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.3);
}

.report-card.performance { border-left-color: #28a745; }
.report-card.priorities { border-left-color: #dc3545; }
.report-card.questionnaires { border-left-color: #ffc107; }
.report-card.municipalities { border-left-color: #17a2b8; }
.report-card.alerts { border-left-color: #dc3545; }
.report-card.projections { border-left-color: #6f42c1; }

.report-icon {
    font-size: 32px;
    min-width: 50px;
    text-align: center;
}

.report-content {
    flex: 1;
}

.report-name {
    color: #F1F1F1;
    font-weight: 600;
    font-size: 16px;
    margin-bottom: 4px;
}

.report-description {
    color: #B8BCC8;
    font-size: 12px;
    margin-bottom: 8px;
}

.report-status {
    display: flex;
    align-items: center;
    gap: 6px;
    color: #B8BCC8;
    font-size: 11px;
}

.status-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
}

.status-indicator.updated { background: #28a745; }
.status-indicator.warning { background: #ffc107; }
.status-indicator.critical { background: #dc3545; }

.report-preview {
    text-align: center;
    min-width: 60px;
}

.preview-metric {
    background: rgba(95, 92, 255, 0.1);
    border-radius: 8px;
    padding: 10px;
}

.metric-value {
    color: #5F5CFF;
    font-size: 20px;
    font-weight: bold;
    line-height: 1;
}

.metric-label {
    color: #B8BCC8;
    font-size: 10px;
    margin-top: 4px;
}

/* AGENDAMENTO AUTOMÁTICO */
.auto-schedule {
    background: #2D3142;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
}

.schedule-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    border-bottom: 2px solid #23263B;
    padding-bottom: 15px;
}

.schedule-header h4 {
    color: #F1F1F1;
    margin: 0;
    font-size: 18px;
}

.btn-toggle {
    background: #28a745;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
}

.btn-toggle:hover {
    background: #218838;
    transform: translateY(-2px);
}

.btn-toggle.active {
    background: #dc3545;
}

.btn-toggle.active:hover {
    background: #c82333;
}

.schedule-options {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.schedule-option {
    display: flex;
    flex-direction: column;
    gap: 5px;
    padding: 12px;
    background: #23263B;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.schedule-option:hover {
    background: #343751;
}

.schedule-label {
    color: #F1F1F1;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
}

.schedule-label input[type="checkbox"] {
    width: 16px;
    height: 16px;
    accent-color: #5F5CFF;
}

.schedule-description {
    color: #B8BCC8;
    font-size: 12px;
    margin-left: 24px;
}

/* MODAL DE RELATÓRIO */
.report-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 2000;
    align-items: center;
    justify-content: center;
}

.report-modal-content {
    background: #23263B;
    border-radius: 16px;
    padding: 30px;
    max-width: 800px;
    max-height: 80vh;
    overflow-y: auto;
    position: relative;
    box-shadow: 0 16px 64px rgba(0,0,0,0.5);
    width: 90%;
}

.report-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    border-bottom: 2px solid #2D3142;
    padding-bottom: 15px;
}

.report-modal-title {
    color: #F1F1F1;
    font-size: 24px;
    font-weight: 700;
}

.report-modal-close {
    background: none;
    border: none;
    color: #B8BCC8;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.report-modal-close:hover {
    color: #F1F1F1;
    background: #343751;
    border-radius: 50%;
}

.report-content-area {
    color: #F1F1F1;
    line-height: 1.6;
}

/* LAYOUT RESPONSIVO DOS RELATÓRIOS */
@media (max-width: 1200px) {
    .executive-reports {
        padding: 20px;
    }
    
    .reports-grid {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 15px;
    }
}

@media (max-width: 768px) {
    .reports-header {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
    }
    
    .reports-controls {
        flex-wrap: wrap;
        width: 100%;
    }
    
    .reports-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .report-card {
        flex-direction: column;
        text-align: center;
        gap: 10px;
    }
    
    .schedule-header {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
    }
    
    .report-modal-content {
        width: 95%;
        padding: 20px;
    }
}

/* =============================================================================
   ASSISTENTE DE ESTRATÉGIA LOCAL
   ============================================================================= */

.strategy-assistant {
    background: #23263B;
    border-radius: 16px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}

.assistant-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    border-bottom: 2px solid #2D3142;
    padding-bottom: 15px;
}

.assistant-title {
    color: #F1F1F1;
    font-size: 24px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
}

.assistant-badge {
    background: linear-gradient(135deg, #6f42c1, #8a2be2);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}

.assistant-controls {
    display: flex;
    gap: 10px;
}

.btn-assistant {
    background: #6f42c1;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
}

.btn-assistant:hover {
    background: #5a32a3;
    transform: translateY(-2px);
}

/* SELETOR DE MUNICÍPIO */
.municipality-selector {
    background: #2D3142;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
}

.selector-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.selector-header h4 {
    color: #F1F1F1;
    margin: 0;
    font-size: 18px;
}

.selector-controls {
    display: flex;
    gap: 10px;
    align-items: center;
}

.municipality-dropdown {
    background: #23263B;
    color: #F1F1F1;
    border: 2px solid #5F5CFF;
    border-radius: 8px;
    padding: 8px 12px;
    outline: none;
    cursor: pointer;
    min-width: 200px;
    font-size: 14px;
}

.municipality-dropdown:focus {
    border-color: #6f42c1;
    box-shadow: 0 0 0 2px rgba(111, 66, 193, 0.2);
}

.btn-analyze {
    background: #6f42c1;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
}

.btn-analyze:hover {
    background: #5a32a3;
    transform: translateY(-2px);
}

/* PAINEL DE ANÁLISE */
.analysis-panel {
    background: #2D3142;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    border: 2px solid #6f42c1;
}

.analysis-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    border-bottom: 2px solid #23263B;
    padding-bottom: 15px;
}

.municipality-info h3 {
    color: #F1F1F1;
    margin: 0 0 10px 0;
    font-size: 24px;
}

.municipality-stats {
    display: flex;
    gap: 15px;
}

.stat-item {
    background: #23263B;
    color: #F1F1F1;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}

.analysis-actions {
    display: flex;
    gap: 10px;
}

.btn-action {
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 600;
}

.btn-action.success {
    background: #28a745;
    color: white;
}

.btn-action.success:hover {
    background: #218838;
}

.btn-action.primary {
    background: #5F5CFF;
    color: white;
}

.btn-action.primary:hover {
    background: #4845E4;
}

/* GRID DE ESTRATÉGIAS */
.strategies-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
}

.strategy-card {
    background: #23263B;
    border-radius: 12px;
    padding: 20px;
    border-left: 6px solid;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.strategy-card:hover {
    background: #343751;
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.3);
}

.strategy-card.contact { border-left-color: #17a2b8; }
.strategy-card.approach { border-left-color: #28a745; }
.strategy-card.timing { border-left-color: #ffc107; }
.strategy-card.followup { border-left-color: #6f42c1; }

.strategy-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.strategy-icon {
    font-size: 24px;
    margin-right: 10px;
}

.strategy-title {
    color: #F1F1F1;
    font-weight: 600;
    font-size: 16px;
    flex: 1;
}

.strategy-confidence {
    background: #6f42c1;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
}

.strategy-content {
    color: #B8BCC8;
    line-height: 1.6;
    font-size: 14px;
}

/* INSIGHTS E SEÇÕES */
.insights-section,
.success-history {
    background: #2D3142;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
}

.insights-section h4,
.success-history h4 {
    color: #F1F1F1;
    margin: 0 0 15px 0;
    font-size: 18px;
}

.insights-content {
    color: #F1F1F1;
    line-height: 1.6;
}

.success-items {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.success-item {
    background: #23263B;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #28a745;
}

.success-item-title {
    color: #F1F1F1;
    font-weight: 600;
    margin-bottom: 5px;
}

.success-item-description {
    color: #B8BCC8;
    font-size: 12px;
}

/* PAINEL DE CONFIGURAÇÃO */
.config-panel {
    background: #2D3142;
    border-radius: 12px;
    padding: 20px;
    margin-top: 20px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    border: 2px solid #6f42c1;
}

.config-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    border-bottom: 2px solid #23263B;
    padding-bottom: 15px;
}

.config-header h4 {
    color: #F1F1F1;
    margin: 0;
    font-size: 18px;
}

.btn-close-config {
    background: #dc3545;
    color: white;
    border: none;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.btn-close-config:hover {
    background: #c82333;
    transform: scale(1.1);
}

.config-options {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.config-option {
    background: #23263B;
    padding: 15px;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.config-option:hover {
    background: #343751;
}

.config-label {
    color: #F1F1F1;
    font-weight: 500;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
}

.config-label input[type="checkbox"] {
    width: 18px;
    height: 18px;
    accent-color: #6f42c1;
}

.config-label input[type="range"] {
    flex: 1;
    margin: 0 10px;
    accent-color: #6f42c1;
}

/* LAYOUT RESPONSIVO DO ASSISTENTE */
@media (max-width: 1200px) {
    .strategy-assistant {
        padding: 20px;
    }
    
    .strategies-grid {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 15px;
    }
}

@media (max-width: 768px) {
    .assistant-header {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
    }
    
    .assistant-controls {
        flex-wrap: wrap;
        width: 100%;
    }
    
    .selector-header {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
    }
    
    .selector-controls {
        flex-direction: column;
        width: 100%;
        gap: 10px;
    }
    
    .municipality-dropdown {
        width: 100%;
    }
    
    .analysis-header {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
    }
    
    .strategies-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .municipality-stats {
        flex-direction: column;
        gap: 8px;
    }
}
</style>

</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Carregando...</div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    <!-- Navegação Lateral -->
    <aside class="sidebar">
        <header class="sidebar-header">
            <a href="/" class="sidebar-logo">
                <i class="fas fa-chart-line"></i>
                PNSB 2024
            </a>
        </header>
        
        <nav class="sidebar-nav" role="navigation" aria-label="Menu principal">
            <div class="nav-section">
                <h6 class="nav-section-title">Principal</h6>
                <ul>
                    <li class="nav-item">
                        <a href="/" class="nav-link-custom ">
                            <i class="nav-icon fas fa-home"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/visitas" class="nav-link-custom ">
                            <i class="nav-icon fas fa-calendar-alt"></i>
                            <span>Visitas</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/checklist" class="nav-link-custom ">
                            <i class="nav-icon fas fa-tasks"></i>
                            <span>Checklist</span>
                        </a>
                    </li>
                </ul>
            </div>
            
            <div class="nav-section">
                <h6 class="nav-section-title">Gestão</h6>
                <ul>
                    <li class="nav-item">
                        <a href="/contatos" class="nav-link-custom ">
                            <i class="nav-icon fas fa-address-book"></i>
                            <span>Contatos</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/configuracoes" class="nav-link-custom ">
                            <i class="nav-icon fas fa-cog"></i>
                            <span>Configurações</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/relatorios" class="nav-link-custom ">
                            <i class="nav-icon fas fa-chart-bar"></i>
                            <span>Relatórios</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/whatsapp" class="nav-link-custom ">
                            <i class="nav-icon fab fa-whatsapp"></i>
                            <span>WhatsApp</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/material-apoio" class="nav-link-custom ">
                            <i class="nav-icon fas fa-book-open"></i>
                            <span>Material de Apoio</span>
                        </a>
                    </li>
                </ul>
            </div>
            
            <div class="nav-section">
                <h6 class="nav-section-title">PNSB Avançado</h6>
                <ul>
                    <li class="nav-item">
                        <a href="/api/pnsb/status/funcionalidades-pnsb" class="nav-link-custom">
                            <i class="nav-icon fas fa-cogs"></i>
                            <span>Funcionalidades</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/mapa-progresso" class="nav-link-custom active">
                            <i class="nav-icon fas fa-map"></i>
                            <span>Mapa Progresso</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/questionarios-obrigatorios" class="nav-link-custom ">
                            <i class="nav-icon fas fa-clipboard-list"></i>
                            <span>Questionários Obrigatórios</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/produtividade" class="nav-link-custom ">
                            <i class="nav-icon fas fa-chart-line"></i>
                            <span>Produtividade</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/assistente-abordagem" class="nav-link-custom ">
                            <i class="nav-icon fas fa-user-tie"></i>
                            <span>Assistente Abordagem</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/dashboard-offline" class="nav-link-custom ">
                            <i class="nav-icon fas fa-wifi"></i>
                            <span>Sistema Offline</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/otimizador-rotas" class="nav-link-custom ">
                            <i class="nav-icon fas fa-route"></i>
                            <span>Otimizador de Rotas</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/analytics-dashboard" class="nav-link-custom ">
                            <i class="nav-icon fas fa-chart-line"></i>
                            <span>Analytics Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/business-intelligence" class="nav-link-custom ">
                            <i class="nav-icon fas fa-brain"></i>
                            <span>Business Intelligence</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/analise-resistencia" class="nav-link-custom ">
                            <i class="nav-icon fas fa-shield-alt"></i>
                            <span>Análise Resistência</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/sistema-alertas" class="nav-link-custom ">
                            <i class="nav-icon fas fa-bell"></i>
                            <span>Sistema Alertas</span>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>
    </aside>
    
    <!-- Navbar Superior -->
    <nav class="navbar-custom navbar navbar-expand-lg">
        <div class="container-fluid">
            <button class="sidebar-toggle" type="button" aria-label="Toggle navigation">
                <i class="fas fa-bars"></i>
            </button>
            
            <div class="navbar-brand d-flex align-items-center">
                <span class="text-gradient">Sistema PNSB</span>
            </div>
            
            <div class="ms-auto d-flex align-items-center gap-3">
                <div class="d-none d-md-block">
                    <small class="text-muted">Pesquisa Nacional de Saneamento Básico 2024</small>
                </div>
                
                <!-- User Menu -->
                <div class="dropdown">
                    <button class="btn btn-outline-custom btn-sm dropdown-toggle" type="button" id="userMenu" data-bs-toggle="dropdown">
                        <i class="fas fa-user"></i>
                        <span class="d-none d-md-inline ms-2" id="username">Usuário</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end bg-dark" style="border: 1px solid #3A3F54;">
                        <li><h6 class="dropdown-header text-light">Conta</h6></li>
                        <li><a class="dropdown-item text-light" href="#" onclick="abrirPerfil()">
                            <i class="fas fa-user-circle me-2"></i>Meu Perfil
                        </a></li>
                        <li><a class="dropdown-item text-light" href="#" onclick="configurarConta()">
                            <i class="fas fa-cog me-2"></i>Configurações
                        </a></li>
                        <li><hr class="dropdown-divider" style="border-color: #3A3F54;"></li>
                        <li><h6 class="dropdown-header text-light">Sistema</h6></li>
                        <li><a class="dropdown-item text-light" href="#" onclick="alterarTema()">
                            <i class="fas fa-palette me-2"></i>Tema Escuro
                        </a></li>
                        <li><a class="dropdown-item text-light" href="#" onclick="abrirAjuda()">
                            <i class="fas fa-question-circle me-2"></i>Ajuda
                        </a></li>
                        <li><hr class="dropdown-divider" style="border-color: #3A3F54;"></li>
                        <li><a class="dropdown-item text-danger" href="/logout" onclick="confirmarLogout(event)">
                            <i class="fas fa-sign-out-alt me-2"></i>Sair
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>
    <!-- Layout Principal -->
    <main class="main-layout">
        <div class="container-fluid main-content">
            <!-- Breadcrumbs -->
            <div id="breadcrumb-container"></div>
            
            <!-- Conteúdo da Página -->
            
<div class="container-fluid">
    <!-- TOGGLE BUTTON PARA SIDEBAR -->
    <button class="sidebar-toggle" onclick="toggleSidebar()" title="Abrir Dashboard">
        <i class="fas fa-chart-line"></i>
    </button>

    <!-- ESTATÍSTICAS RÁPIDAS -->
    <div class="stats-container">
        <div class="stat-card" onclick="filtrarPorStatus('finalizado')">
            <div class="stat-number" id="stat-finalizados">0</div>
            <div class="stat-label">Finalizados</div>
        </div>
        <div class="stat-card" onclick="filtrarPorStatus('em_followup')">
            <div class="stat-number" id="stat-followup">0</div>
            <div class="stat-label">Em Follow-up</div>
        </div>
        <div class="stat-card" onclick="mostrarQuestionarios()">
            <div class="stat-number" id="stat-questionarios">0%</div>
            <div class="stat-label">Questionários MRS/MAP</div>
        </div>
        <div class="stat-card" onclick="mostrarPrioridades('p1')">
            <div class="stat-number" id="stat-p1">0%</div>
            <div class="stat-label">P1 Crítica</div>
        </div>
        <div class="stat-card" onclick="mostrarPrioridades('p2')">
            <div class="stat-number" id="stat-p2">0%</div>
            <div class="stat-label">P2 Importante</div>
        </div>
        <div class="stat-card" onclick="filtrarPorStatus('sem_visita')">
            <div class="stat-number" id="stat-sem-visita">0</div>
            <div class="stat-label">Sem Visita</div>
        </div>
    </div>

    <!-- FILTROS SIMPLIFICADOS -->
    <div class="filters-container">
        <div class="filter-group">
            <label class="filter-label">Status:</label>
            <select class="filter-select" id="filtro-status" onchange="aplicarFiltros()">
                <option value="">Todos</option>
                <option value="finalizado">Finalizado</option>
                <option value="em_followup">Em Follow-up</option>
                <option value="executado">Executado</option>
                <option value="agendado">Agendado</option>
                <option value="sem_visita">Sem Visita</option>
            </select>

            <label class="filter-label">Prioridades:</label>
            <select class="filter-select" id="filtro-prioridades" onchange="aplicarFiltros()">
                <option value="">Todas</option>
                <option value="p1">P1 - Crítica (Prefeituras + Lista UF)</option>
                <option value="p2">P2 - Importante (Identificadas em campo)</option>
                <option value="p3">P3 - Opcional (Recursos disponíveis)</option>
                <option value="p1_p2">P1 + P2 (Obrigatórias)</option>
            </select>

            <label class="filter-label">Questionários:</label>
            <select class="filter-select" id="filtro-questionarios" onchange="aplicarFiltros()">
                <option value="">Todos</option>
                <option value="mrs_pendente">MRS Pendente</option>
                <option value="map_pendente">MAP Pendente</option>
                <option value="ambos_completos">MRS + MAP Completos</option>
                <option value="p1_pendente">P1 Crítica Pendente</option>
                <option value="p2_pendente">P2 Importante Pendente</option>
            </select>

            <button class="btn-task btn-warning" onclick="toggleVisualizacao()" id="btn-toggle-view">
                <i class="fas fa-layer-group"></i> Modo Questionários
            </button>
            
            <button class="btn-task btn-success" onclick="toggleModoPrioridades()" id="btn-toggle-priorities">
                <i class="fas fa-sort-amount-up"></i> Modo Prioridades
            </button>
            
            <button class="btn-task btn-primary" onclick="exportarRelatorio()">
                <i class="fas fa-download"></i> Exportar
            </button>
        </div>
    </div>

    <!-- DASHBOARD DE PRODUTIVIDADE PNSB -->
    <div class="productivity-dashboard">
        <div class="dashboard-header">
            <div class="dashboard-title">
                📊 Dashboard de Produtividade
                <span class="pnsb-badge">PNSB 2024</span>
            </div>
            <div class="countdown-dual">
                <div class="countdown-container visits">
                    <div class="countdown-title">⏰ DEADLINE VISITAS</div>
                    <div class="countdown-time" id="countdown-visits">
                        <span id="countdown-visits-days">--</span>
                        <span class="countdown-unit">dias</span>
                    </div>
                    <div style="font-size: 10px; margin-top: 5px; opacity: 0.8;">
                        19/09/2025 - Visitas P1+P2
                    </div>
                </div>
                <div class="countdown-container questionnaires">
                    <div class="countdown-title">📋 DEADLINE QUESTIONÁRIOS</div>
                    <div class="countdown-time" id="countdown-questionnaires">
                        <span id="countdown-questionnaires-days">--</span>
                        <span class="countdown-unit">dias</span>
                    </div>
                    <div style="font-size: 10px; margin-top: 5px; opacity: 0.8;">
                        17/10/2025 - Todos Preenchidos
                    </div>
                </div>
            </div>
        </div>

        <!-- CARDS DE PRIORIDADE P1/P2/P3 -->
        <div class="priority-cards">
            <div class="priority-card p1">
                <div class="priority-header">
                    <div class="priority-title">
                        <div class="priority-icon p1">P1</div>
                        Crítica
                    </div>
                    <div class="priority-percentage p1" id="p1-percentage">0%</div>
                </div>
                <div class="priority-progress">
                    <div class="priority-progress-bar p1" id="p1-progress" style="width: 0%"></div>
                </div>
                <div class="priority-stats">
                    <div class="priority-stat">
                        <div class="priority-stat-number" id="p1-concluidos">0</div>
                        <div class="priority-stat-label">Concluídos</div>
                    </div>
                    <div class="priority-stat">
                        <div class="priority-stat-number" id="p1-total">0</div>
                        <div class="priority-stat-label">Total</div>
                    </div>
                </div>
                <div style="font-size: 12px; color: #B8BCC8; margin-top: 10px; text-align: center;">
                    Prefeituras + Lista UF
                </div>
            </div>

            <div class="priority-card p2">
                <div class="priority-header">
                    <div class="priority-title">
                        <div class="priority-icon p2">P2</div>
                        Importante
                    </div>
                    <div class="priority-percentage p2" id="p2-percentage">0%</div>
                </div>
                <div class="priority-progress">
                    <div class="priority-progress-bar p2" id="p2-progress" style="width: 0%"></div>
                </div>
                <div class="priority-stats">
                    <div class="priority-stat">
                        <div class="priority-stat-number" id="p2-concluidos">0</div>
                        <div class="priority-stat-label">Concluídos</div>
                    </div>
                    <div class="priority-stat">
                        <div class="priority-stat-number" id="p2-total">0</div>
                        <div class="priority-stat-label">Total</div>
                    </div>
                </div>
                <div style="font-size: 12px; color: #B8BCC8; margin-top: 10px; text-align: center;">
                    Identificadas em Campo
                </div>
            </div>

            <div class="priority-card p3">
                <div class="priority-header">
                    <div class="priority-title">
                        <div class="priority-icon p3">P3</div>
                        Opcional
                    </div>
                    <div class="priority-percentage p3" id="p3-percentage">0%</div>
                </div>
                <div class="priority-progress">
                    <div class="priority-progress-bar p3" id="p3-progress" style="width: 0%"></div>
                </div>
                <div class="priority-stats">
                    <div class="priority-stat">
                        <div class="priority-stat-number" id="p3-concluidos">0</div>
                        <div class="priority-stat-label">Concluídos</div>
                    </div>
                    <div class="priority-stat">
                        <div class="priority-stat-number" id="p3-total">0</div>
                        <div class="priority-stat-label">Total</div>
                    </div>
                </div>
                <div style="font-size: 12px; color: #B8BCC8; margin-top: 10px; text-align: center;">
                    Recursos Disponíveis
                </div>
            </div>
        </div>

        <!-- CENTRAL DE PLANEJAMENTO COM CALENDÁRIO VISUAL -->
        <div class="planning-center">
            <div class="planning-header">
                <div class="planning-title">
                    📅 Central de Planejamento
                    <span class="planning-badge">PNSB</span>
                </div>
                <div class="planning-controls">
                    <button class="btn-planning" onclick="toggleCalendarioView()" id="btn-calendario-view">
                        <i class="fas fa-calendar-alt"></i> Mensal
                    </button>
                    <button class="btn-planning" onclick="novaVisitaRapida()" id="btn-nova-visita">
                        <i class="fas fa-plus"></i> Nova Visita
                    </button>
                    <button class="btn-planning" onclick="otimizarRotas()" id="btn-otimizar-rotas">
                        <i class="fas fa-route"></i> Otimizar Rotas
                    </button>
                </div>
            </div>

            <!-- LAYOUT CALENDÁRIO + AGENDA -->
            <div class="planning-layout">
                <!-- CALENDÁRIO VISUAL -->
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button class="calendar-nav" onclick="navegarCalendario(-1)" id="btn-prev-month">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <div class="calendar-title" id="calendar-title">
                            <span id="calendar-month">Dezembro</span>
                            <span id="calendar-year">2024</span>
                        </div>
                        <button class="calendar-nav" onclick="navegarCalendario(1)" id="btn-next-month">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>

                    <div class="calendar-grid">
                        <div class="calendar-weekdays">
                            <div class="weekday">Dom</div>
                            <div class="weekday">Seg</div>
                            <div class="weekday">Ter</div>
                            <div class="weekday">Qua</div>
                            <div class="weekday">Qui</div>
                            <div class="weekday">Sex</div>
                            <div class="weekday">Sáb</div>
                        </div>
                        <div class="calendar-days" id="calendar-days">
                            <!-- Dias serão gerados dinamicamente -->
                        </div>
                    </div>
                </div>

                <!-- AGENDA LATERAL -->
                <div class="agenda-lateral">
                    <div class="agenda-header">
                        <h4>📋 Agenda do Dia</h4>
                        <div class="agenda-date" id="agenda-date">Hoje</div>
                    </div>
                    <div class="agenda-content" id="agenda-content">
                        <div class="agenda-item empty">
                            <div class="agenda-time">--:--</div>
                            <div class="agenda-details">
                                <div class="agenda-title">Nenhuma visita agendada</div>
                                <div class="agenda-subtitle">Clique em um dia para agendar</div>
                            </div>
                        </div>
                    </div>
                    <div class="agenda-footer">
                        <button class="btn-agenda" onclick="adicionarVisitaDia()" id="btn-add-visita">
                            <i class="fas fa-plus"></i> Adicionar Visita
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- RELATÓRIOS EXECUTIVOS AUTOMATIZADOS -->
        <div class="executive-reports">
            <div class="reports-header">
                <div class="reports-title">
                    📊 Relatórios Executivos
                    <span class="reports-badge">AUTO</span>
                </div>
                <div class="reports-controls">
                    <button class="btn-report" onclick="gerarRelatorioInstantaneo()" id="btn-relatorio-instantaneo">
                        <i class="fas fa-lightning-bolt"></i> Instantâneo
                    </button>
                    <button class="btn-report" onclick="agendarRelatorio()" id="btn-agendar-relatorio">
                        <i class="fas fa-clock"></i> Agendar
                    </button>
                    <button class="btn-report" onclick="exportarRelatorios()" id="btn-exportar-relatorios">
                        <i class="fas fa-download"></i> Exportar
                    </button>
                </div>
            </div>

            <!-- RELATÓRIOS DISPONÍVEIS -->
            <div class="reports-grid">
                <!-- Relatório de Performance -->
                <div class="report-card performance" onclick="visualizarRelatorio('performance')">
                    <div class="report-icon">📈</div>
                    <div class="report-content">
                        <div class="report-name">Performance Geral</div>
                        <div class="report-description">Progresso, velocidade e metas</div>
                        <div class="report-status">
                            <span class="status-indicator updated"></span>
                            Atualizado há <span id="performance-last-update">2 min</span>
                        </div>
                    </div>
                    <div class="report-preview">
                        <div class="preview-metric">
                            <div class="metric-value" id="performance-progress">78%</div>
                            <div class="metric-label">Progresso</div>
                        </div>
                    </div>
                </div>

                <!-- Relatório de Prioridades -->
                <div class="report-card priorities" onclick="visualizarRelatorio('priorities')">
                    <div class="report-icon">🎯</div>
                    <div class="report-content">
                        <div class="report-name">Análise de Prioridades</div>
                        <div class="report-description">Status P1, P2 e P3</div>
                        <div class="report-status">
                            <span class="status-indicator updated"></span>
                            Atualizado há <span id="priorities-last-update">5 min</span>
                        </div>
                    </div>
                    <div class="report-preview">
                        <div class="preview-metric">
                            <div class="metric-value" id="priorities-critical">12</div>
                            <div class="metric-label">P1 Pendentes</div>
                        </div>
                    </div>
                </div>

                <!-- Relatório de Questionários -->
                <div class="report-card questionnaires" onclick="visualizarRelatorio('questionnaires')">
                    <div class="report-icon">📋</div>
                    <div class="report-content">
                        <div class="report-name">Questionários MRS/MAP</div>
                        <div class="report-description">Completude e qualidade</div>
                        <div class="report-status">
                            <span class="status-indicator warning"></span>
                            Atualizado há <span id="questionnaires-last-update">15 min</span>
                        </div>
                    </div>
                    <div class="report-preview">
                        <div class="preview-metric">
                            <div class="metric-value" id="questionnaires-completion">64%</div>
                            <div class="metric-label">Completos</div>
                        </div>
                    </div>
                </div>

                <!-- Relatório de Municípios -->
                <div class="report-card municipalities" onclick="visualizarRelatorio('municipalities')">
                    <div class="report-icon">🏘️</div>
                    <div class="report-content">
                        <div class="report-name">Status por Município</div>
                        <div class="report-description">Progresso individual e comparativo</div>
                        <div class="report-status">
                            <span class="status-indicator updated"></span>
                            Atualizado há <span id="municipalities-last-update">1 min</span>
                        </div>
                    </div>
                    <div class="report-preview">
                        <div class="preview-metric">
                            <div class="metric-value" id="municipalities-completed">3</div>
                            <div class="metric-label">Finalizados</div>
                        </div>
                    </div>
                </div>

                <!-- Relatório de Alertas -->
                <div class="report-card alerts" onclick="visualizarRelatorio('alerts')">
                    <div class="report-icon">🚨</div>
                    <div class="report-content">
                        <div class="report-name">Alertas e Riscos</div>
                        <div class="report-description">Problemas críticos e recomendações</div>
                        <div class="report-status">
                            <span class="status-indicator critical"></span>
                            Atualizado há <span id="alerts-last-update">agora</span>
                        </div>
                    </div>
                    <div class="report-preview">
                        <div class="preview-metric">
                            <div class="metric-value" id="alerts-critical-count">5</div>
                            <div class="metric-label">Críticos</div>
                        </div>
                    </div>
                </div>

                <!-- Relatório de Projeções -->
                <div class="report-card projections" onclick="visualizarRelatorio('projections')">
                    <div class="report-icon">🔮</div>
                    <div class="report-content">
                        <div class="report-name">Projeções e Tendências</div>
                        <div class="report-description">Previsões e cenários futuros</div>
                        <div class="report-status">
                            <span class="status-indicator updated"></span>
                            Atualizado há <span id="projections-last-update">10 min</span>
                        </div>
                    </div>
                    <div class="report-preview">
                        <div class="preview-metric">
                            <div class="metric-value" id="projections-completion-date">15 Dez</div>
                            <div class="metric-label">Conclusão</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AGENDAMENTO AUTOMÁTICO -->
            <div class="auto-schedule">
                <div class="schedule-header">
                    <h4>⏰ Agendamento Automático</h4>
                    <button class="btn-toggle" onclick="toggleAutoReports()" id="btn-auto-reports">
                        <i class="fas fa-play"></i> Ativar
                    </button>
                </div>
                <div class="schedule-options">
                    <div class="schedule-option">
                        <label class="schedule-label">
                            <input type="checkbox" id="auto-daily" checked> 
                            Relatório Diário (08:00)
                        </label>
                        <span class="schedule-description">Performance e alertas críticos</span>
                    </div>
                    <div class="schedule-option">
                        <label class="schedule-label">
                            <input type="checkbox" id="auto-weekly" checked> 
                            Relatório Semanal (Segunda 09:00)
                        </label>
                        <span class="schedule-description">Análise completa e projeções</span>
                    </div>
                    <div class="schedule-option">
                        <label class="schedule-label">
                            <input type="checkbox" id="auto-monthly"> 
                            Relatório Mensal (1º do mês 10:00)
                        </label>
                        <span class="schedule-description">Relatório executivo consolidado</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ASSISTENTE DE ESTRATÉGIA LOCAL -->
        <div class="strategy-assistant">
            <div class="assistant-header">
                <div class="assistant-title">
                    🧠 Assistente de Estratégia Local
                    <span class="assistant-badge">IA</span>
                </div>
                <div class="assistant-controls">
                    <button class="btn-assistant" onclick="analisarTodosMunicipios()" id="btn-analisar-todos">
                        <i class="fas fa-search"></i> Analisar Todos
                    </button>
                    <button class="btn-assistant" onclick="gerarRelatorioEstrategias()" id="btn-relatorio-estrategias">
                        <i class="fas fa-brain"></i> Relatório IA
                    </button>
                    <button class="btn-assistant" onclick="configurarAssistente()" id="btn-configurar-assistant">
                        <i class="fas fa-cog"></i> Configurar
                    </button>
                </div>
            </div>

            <!-- SELETOR DE MUNICÍPIO -->
            <div class="municipality-selector">
                <div class="selector-header">
                    <h4>🎯 Análise Personalizada por Município</h4>
                    <div class="selector-controls">
                        <select class="municipality-dropdown" id="municipality-select" onchange="analisarMunicipio()">
                            <option value="">Selecione um município...</option>
                            <option value="itajai">Itajaí</option>
                            <option value="balneario-camboriu">Balneário Camboriú</option>
                            <option value="navegantes">Navegantes</option>
                            <option value="bombinhas">Bombinhas</option>
                            <option value="balneario-picarras">Balneário Piçarras</option>
                            <option value="camboriu">Camboriú</option>
                            <option value="itapema">Itapema</option>
                            <option value="penha">Penha</option>
                            <option value="porto-belo">Porto Belo</option>
                            <option value="luiz-alves">Luiz Alves</option>
                            <option value="ilhota">Ilhota</option>
                        </select>
                        <button class="btn-analyze" onclick="analisarMunicipio()" id="btn-analyze-municipality">
                            <i class="fas fa-magic"></i> Analisar
                        </button>
                    </div>
                </div>
            </div>

            <!-- PAINEL DE ANÁLISE -->
            <div class="analysis-panel" id="analysis-panel" style="display: none;">
                <div class="analysis-header">
                    <div class="municipality-info">
                        <h3 id="analyzed-municipality">Município</h3>
                        <div class="municipality-stats">
                            <span class="stat-item" id="municipality-priority">P1 - Crítica</span>
                            <span class="stat-item" id="municipality-progress">78% concluído</span>
                            <span class="stat-item" id="municipality-risk">Risco Baixo</span>
                        </div>
                    </div>
                    <div class="analysis-actions">
                        <button class="btn-action success" onclick="implementarEstrategia()" id="btn-implement-strategy">
                            <i class="fas fa-play"></i> Implementar
                        </button>
                        <button class="btn-action primary" onclick="salvarEstrategia()" id="btn-save-strategy">
                            <i class="fas fa-save"></i> Salvar
                        </button>
                    </div>
                </div>

                <!-- ESTRATÉGIAS RECOMENDADAS -->
                <div class="strategies-grid">
                    <!-- Estratégia de Contato -->
                    <div class="strategy-card contact">
                        <div class="strategy-header">
                            <div class="strategy-icon">📞</div>
                            <div class="strategy-title">Estratégia de Contato</div>
                            <div class="strategy-confidence" id="contact-confidence">95%</div>
                        </div>
                        <div class="strategy-content" id="contact-strategy">
                            <!-- Conteúdo será carregado dinamicamente -->
                        </div>
                    </div>

                    <!-- Estratégia de Abordagem -->
                    <div class="strategy-card approach">
                        <div class="strategy-header">
                            <div class="strategy-icon">🎯</div>
                            <div class="strategy-title">Abordagem Recomendada</div>
                            <div class="strategy-confidence" id="approach-confidence">92%</div>
                        </div>
                        <div class="strategy-content" id="approach-strategy">
                            <!-- Conteúdo será carregado dinamicamente -->
                        </div>
                    </div>

                    <!-- Estratégia de Timing -->
                    <div class="strategy-card timing">
                        <div class="strategy-header">
                            <div class="strategy-icon">⏰</div>
                            <div class="strategy-title">Melhor Timing</div>
                            <div class="strategy-confidence" id="timing-confidence">88%</div>
                        </div>
                        <div class="strategy-content" id="timing-strategy">
                            <!-- Conteúdo será carregado dinamicamente -->
                        </div>
                    </div>

                    <!-- Estratégia de Follow-up -->
                    <div class="strategy-card followup">
                        <div class="strategy-header">
                            <div class="strategy-icon">🔄</div>
                            <div class="strategy-title">Plano de Follow-up</div>
                            <div class="strategy-confidence" id="followup-confidence">90%</div>
                        </div>
                        <div class="strategy-content" id="followup-strategy">
                            <!-- Conteúdo será carregado dinamicamente -->
                        </div>
                    </div>
                </div>

                <!-- INSIGHTS E RECOMENDAÇÕES -->
                <div class="insights-section">
                    <h4>💡 Insights e Recomendações Personalizadas</h4>
                    <div class="insights-content" id="insights-content">
                        <!-- Insights serão carregados dinamicamente -->
                    </div>
                </div>

                <!-- HISTÓRICO DE SUCESSO -->
                <div class="success-history">
                    <h4>📈 Estratégias de Sucesso em Municípios Similares</h4>
                    <div class="success-items" id="success-history">
                        <!-- Histórico será carregado dinamicamente -->
                    </div>
                </div>
            </div>

            <!-- PAINEL DE CONFIGURAÇÃO -->
            <div class="config-panel" id="config-panel" style="display: none;">
                <div class="config-header">
                    <h4>⚙️ Configurações do Assistente IA</h4>
                    <button class="btn-close-config" onclick="fecharConfiguracoes()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="config-options">
                    <div class="config-option">
                        <label class="config-label">
                            <input type="checkbox" id="config-auto-analysis" checked>
                            Análise automática ao selecionar município
                        </label>
                    </div>
                    <div class="config-option">
                        <label class="config-label">
                            <input type="checkbox" id="config-success-prediction" checked>
                            Predição de taxa de sucesso
                        </label>
                    </div>
                    <div class="config-option">
                        <label class="config-label">
                            <input type="checkbox" id="config-local-insights" checked>
                            Insights baseados em características locais
                        </label>
                    </div>
                    <div class="config-option">
                        <label class="config-label">
                            <input type="range" id="config-confidence-threshold" min="50" max="95" value="80">
                            Nível mínimo de confiança: <span id="confidence-value">80%</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- MÉTRICAS DE VELOCIDADE -->
        <div class="velocity-metrics">
            <div class="velocity-card">
                <div class="velocity-number" id="velocity-daily">0</div>
                <div class="velocity-label">Questionários/Dia</div>
                <div class="velocity-trend trend-stable" id="velocity-trend">
                    ➡️ Estável
                </div>
            </div>
            <div class="velocity-card">
                <div class="velocity-number" id="projection-days">--</div>
                <div class="velocity-label">Dias p/ Conclusão</div>
                <div class="velocity-trend trend-up" id="projection-trend">
                    📈 No Prazo
                </div>
            </div>
            <div class="velocity-card">
                <div class="velocity-number" id="completion-score">85%</div>
                <div class="velocity-label">Score Progresso</div>
                <div class="velocity-trend trend-up" id="score-trend">
                    🎯 Excelente
                </div>
            </div>
            <div class="velocity-card">
                <div class="velocity-number" id="municipalities-complete">0</div>
                <div class="velocity-label">Municípios 100%</div>
                <div class="velocity-trend trend-stable" id="municipalities-trend">
                    🏆 Meta: 11
                </div>
            </div>
        </div>

        <!-- SISTEMA DE ALERTAS CRÍTICOS PNSB 2024 -->
        <div class="smart-alerts-container">
            <div class="alerts-header">
                <h3 style="color: #F1F1F1; margin: 0; display: flex; align-items: center; gap: 10px;">
                    🚨 Alertas Críticos PNSB 2024
                    <span class="alert-badge" id="alert-count">0</span>
                    <span class="deadline-badge" id="deadline-badge">--</span>
                </h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-task btn-warning" onclick="atualizarAlertas()" id="btn-refresh-alerts">
                        <i class="fas fa-sync"></i> Atualizar
                    </button>
                    <button class="btn-task btn-primary" onclick="toggleAlertas()" id="btn-toggle-alerts">
                        <i class="fas fa-eye"></i> Mostrar Todos
                    </button>
                </div>
            </div>
            <div class="alerts-grid" id="alerts-container">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> Carregando alertas críticos...
                </div>
            </div>
            
            <!-- Resumo de Prazos -->
            <div class="deadlines-summary" id="deadlines-summary" style="margin-top: 20px; padding: 15px; background: rgba(95, 92, 255, 0.1); border-radius: 8px; border-left: 4px solid #5F5CFF;">
                <h4 style="color: #5F5CFF; margin: 0 0 10px 0;">📅 Prazos Críticos</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <strong style="color: #F1F1F1;">Visitas (P1+P2):</strong><br>
                        <span id="deadline-visitas" style="color: #ffc107;">19/09/2025 (-- dias)</span>
                    </div>
                    <div>
                        <strong style="color: #F1F1F1;">Questionários:</strong><br>
                        <span id="deadline-questionarios" style="color: #17a2b8;">17/10/2025 (-- dias)</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- TIMELINE DE PROGRESSO SEMANAL -->
        <div class="timeline-container">
            <div class="timeline-header">
                <div class="timeline-title">
                    📈 Timeline de Progresso PNSB 2024
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span style="color: #B8BCC8; font-size: 14px;" id="timeline-status">Carregando...</span>
                    <button class="btn-task btn-secondary" onclick="toggleTimelineView()" id="btn-timeline-view">
                        <i class="fas fa-calendar-week"></i> Semanal
                    </button>
                </div>
            </div>
            
            <div class="timeline-track">
                <div class="timeline-progress" id="timeline-progress" style="width: 0%"></div>
                <div class="timeline-milestones">
                    <div class="milestone completed" id="milestone-start">
                        <div class="milestone-label">Início</div>
                    </div>
                    <div class="milestone" id="milestone-25">
                        <div class="milestone-label">25%</div>
                    </div>
                    <div class="milestone" id="milestone-50">
                        <div class="milestone-label">50%</div>
                    </div>
                    <div class="milestone" id="milestone-75">
                        <div class="milestone-label">75%</div>
                    </div>
                    <div class="milestone" id="milestone-100">
                        <div class="milestone-label">Meta</div>
                    </div>
                </div>
            </div>
            
            <!-- Métricas da Timeline -->
            <div class="timeline-metrics" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px;">
                <div class="timeline-metric">
                    <div style="color: #F1F1F1; font-size: 20px; font-weight: bold;" id="progresso-atual">0%</div>
                    <div style="color: #B8BCC8; font-size: 12px;">Progresso Atual</div>
                </div>
                <div class="timeline-metric">
                    <div style="color: #5F5CFF; font-size: 20px; font-weight: bold;" id="semanas-decorridas">0</div>
                    <div style="color: #B8BCC8; font-size: 12px;">Semanas Ativas</div>
                </div>
                <div class="timeline-metric">
                    <div style="color: #ffc107; font-size: 20px; font-weight: bold;" id="velocidade-semanal">0</div>
                    <div style="color: #B8BCC8; font-size: 12px;">Questionários/Semana</div>
                </div>
                <div class="timeline-metric">
                    <div style="color: #28a745; font-size: 20px; font-weight: bold;" id="previsao-conclusao">--</div>
                    <div style="color: #B8BCC8; font-size: 12px;">Previsão Conclusão</div>
                </div>
            </div>
        </div>
    </div>

    <!-- MAPA PRINCIPAL -->
    <div class="map-container">
        <div id="mapa-progresso"></div>
        
        <!-- CONTROLES DO HEATMAP -->
        <div class="heatmap-controls" id="heatmap-controls">
            <div class="heatmap-title">
                🔥 Heatmap de Intensidade
            </div>
            <div class="heatmap-options">
                <div class="heatmap-option">
                    <input type="radio" id="heatmap-off" name="heatmap" value="off" checked>
                    <label for="heatmap-off">Desligado</label>
                </div>
                <div class="heatmap-option">
                    <input type="radio" id="heatmap-progress" name="heatmap" value="progress">
                    <label for="heatmap-progress">Por Progresso</label>
                </div>
                <div class="heatmap-option">
                    <input type="radio" id="heatmap-priority" name="heatmap" value="priority">
                    <label for="heatmap-priority">Por Prioridade</label>
                </div>
                <div class="heatmap-option">
                    <input type="radio" id="heatmap-urgency" name="heatmap" value="urgency">
                    <label for="heatmap-urgency">Por Urgência</label>
                </div>
                <div class="heatmap-option">
                    <input type="radio" id="heatmap-density" name="heatmap" value="density">
                    <label for="heatmap-density">Densidade</label>
                </div>
            </div>
            
            <div class="heatmap-legend" id="heatmap-legend" style="display: none;">
                <div class="legend-title">Legenda</div>
                <div class="legend-items" id="legend-items">
                    <!-- Itens da legenda serão inseridos dinamicamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- DASHBOARD LATERAL -->
    <div class="dashboard-sidebar" id="dashboard-sidebar">
        <h5 style="color: #F1F1F1; margin-bottom: 20px;">
            <i class="fas fa-tasks"></i> Tarefas Urgentes
        </h5>
        
        <div id="tarefas-container">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i> Carregando tarefas...
            </div>
        </div>

        <hr style="border-color: #2D3142; margin: 20px 0;">

        <h6 style="color: #F1F1F1; margin-bottom: 15px;">
            <i class="fas fa-calendar"></i> Próximas Visitas
        </h6>
        
        <div id="proximas-visitas">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i> Carregando agenda...
            </div>
        </div>
    </div>
</div>

<!-- MODAL DE DETALHES DO MUNICÍPIO -->
<div class="modal-municipio" id="modal-municipio">
    <div class="modal-content">
        <button class="modal-close" onclick="fecharModal()">&times;</button>
        <div id="modal-conteudo">
            <!-- Conteúdo será inserido dinamicamente -->
        </div>
    </div>
</div>

<!-- MODAL DE RELATÓRIO -->
<div id="modal-relatorio" class="report-modal">
    <div class="report-modal-content">
        <div class="report-modal-header">
            <div class="report-modal-title" id="report-modal-title">Relatório</div>
            <button class="report-modal-close" onclick="fecharModalRelatorio()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="report-content-area" id="report-content-area">
            <!-- Conteúdo do relatório será carregado dinamicamente -->
        </div>
    </div>
</div>

        </div>
    </main>

    <!-- Chatbox HTML -->
    <div class="chatbox-container">
        <button class="chatbox-button" onclick="toggleChatbox()">
            <i class="fas fa-robot"></i>
        </button>
        <div class="chatbox-window" id="chatboxWindow">
            <div class="chatbox-header">
                <h5 class="mb-0">Assistente PNSB</h5>
                <button class="btn-close btn-close-white" onclick="toggleChatbox()"></button>
            </div>
            <div class="chatbox-messages" id="chatboxMessages">
                <div class="message bot">
                    Olá! Como posso ajudar você hoje?
                </div>
            </div>
            <div class="chatbox-input">
                <input type="text" id="chatboxInput" placeholder="Digite sua mensagem..." onkeypress="handleKeyPress(event)">
                <button onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Chatbox JavaScript -->
    <script>
        // User Authentication Functions
        function checkUserSession() {
            const sessionData = localStorage.getItem('pnsb_session') || sessionStorage.getItem('pnsb_session');
            
            if (sessionData) {
                try {
                    const session = JSON.parse(sessionData);
                    const loginTime = new Date(session.loginTime);
                    const now = new Date();
                    const hoursDiff = (now - loginTime) / (1000 * 60 * 60);
                    
                    // Sessão válida por 24 horas
                    if (hoursDiff < 24) {
                        // Atualizar interface com dados do usuário
                        document.getElementById('username').textContent = session.name || session.email;
                        return session;
                    } else {
                        // Limpar sessão expirada
                        localStorage.removeItem('pnsb_session');
                        sessionStorage.removeItem('pnsb_session');
                        window.location.href = '/login';
                    }
                } catch (e) {
                    console.error('Erro ao verificar sessão:', e);
                }
            }
            
            // Redirecionar para login apenas se não estiver em páginas públicas
            const currentPath = window.location.pathname;
            const publicPages = ['/login', '/offline', '/static/'];
            const isPublicPage = publicPages.some(page => currentPath.startsWith(page)) || currentPath.startsWith('/api/');
            
            if (!isPublicPage) {
                // Em desenvolvimento, permitir acesso sem login
                console.log('Usuário não logado, mas permitindo acesso em desenvolvimento');
                // window.location.href = '/login';
            }
            
            return null;
        }

        function abrirPerfil() {
            // Implementar modal de perfil
            showToast('Funcionalidade de perfil será implementada em breve', 'info');
        }

        function configurarConta() {
            // Redirecionar para configurações
            window.location.href = '/configuracoes';
        }

        function alterarTema() {
            // Implementar troca de tema
            showToast('Troca de tema será implementada em breve', 'info');
        }

        function abrirAjuda() {
            // Implementar sistema de ajuda
            showToast('Sistema de ajuda será implementado em breve', 'info');
        }

        function confirmarLogout(event) {
            event.preventDefault();
            
            if (confirm('Tem certeza que deseja sair do sistema?')) {
                // Limpar sessões
                localStorage.removeItem('pnsb_session');
                sessionStorage.removeItem('pnsb_session');
                
                // Redirecionar para login
                window.location.href = '/login';
            }
        }

        // Enhanced toast notification system
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast-notification ${type}`;
            
            const iconMap = {
                'success': 'check-circle',
                'error': 'exclamation-triangle',
                'danger': 'exclamation-triangle',
                'warning': 'exclamation-circle',
                'info': 'info-circle'
            };
            
            toast.innerHTML = `
                <i class="fas fa-${iconMap[type] || 'info-circle'} fa-lg"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" style="background: none; border: none; color: inherit; margin-left: auto; cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            toastContainer.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 5000);
        }

        // Loading overlay functions
        function showLoading(text = 'Carregando...') {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = overlay.querySelector('.loading-text');
            loadingText.textContent = text;
            overlay.style.display = 'flex';
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = 'none';
        }

        // Enhanced fetch with loading and error handling
        async function fetchWithLoading(url, options = {}) {
            showLoading();
            try {
                const response = await fetch(url, options);
                hideLoading();
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Check for API error response
                if (data.error || data.success === false) {
                    throw new Error(data.error || data.message || 'Erro na operação');
                }
                
                return data;
            } catch (error) {
                hideLoading();
                console.error('Fetch error:', error);
                showToast(error.message || 'Erro ao processar requisição', 'error');
                throw error;
            }
        }

        // Global error handler
        window.addEventListener('error', function(event) {
            console.error('Global error:', event.error);
            showToast('Ocorreu um erro inesperado. Por favor, recarregue a página.', 'error');
        });

        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            showToast('Erro ao processar operação. Tente novamente.', 'error');
        });

        // Chatbox Functions
        function toggleChatbox() {
            const chatboxWindow = document.getElementById('chatboxWindow');
            chatboxWindow.style.display = chatboxWindow.style.display === 'flex' ? 'none' : 'flex';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function sendMessage() {
            const input = document.getElementById('chatboxInput');
            const message = input.value.trim();
            
            if (message) {
                // Add user message to chat
                addMessage(message, 'user');
                input.value = '';

                // Send to backend
                fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                })
                .then(response => response.json())
                .then(data => {
                    // Add bot response to chat
                    addMessage(data.response, 'bot');
                })
                .catch(error => {
                    console.error('Error:', error);
                    addMessage('Desculpe, ocorreu um erro ao processar sua mensagem.', 'bot');
                });
            }
        }

        function addMessage(text, type) {
            const messagesDiv = document.getElementById('chatboxMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = text;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Initialize authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkUserSession();
            
            // Mostrar informações de debug no console
            console.log('🔧 Sistema PNSB Debug Info:');
            console.log('- Service Worker URL: /sw.js');
            console.log('- PWA Commands: clearPWACache(), debugPWA()');
            console.log('- Health Check: checkSystemHealth()');
        });
    </script>
    
    <!-- PWA JavaScript -->
    <!-- PWA JavaScript -->
    <script src="/static/js/pwa.js?v=2.0"></script>
    
    <!-- Health Check JavaScript -->
    <script src="/static/js/health-check.js?v=2.0"></script>
    
    <!-- Components JavaScript -->
    <script src="/static/js/components.js?v=2.0"></script>
    <script src="/static/js/breadcrumbs-init.js?v=2.0"></script>
    
    
<script>
// =============================================================================
// MAPA DE PROGRESSO SIMPLIFICADO - JAVASCRIPT FUNCIONAL
// Data: 2025-07-03
// Foco: Funcionalidades essenciais e práticas
// =============================================================================

// Variáveis globais essenciais
let mapa;
let dadosProgresso = {};
let marcadores = {};
let filtroAtivo = {};
let sidebarAberta = false;
let modoQuestionarios = false; // Novo modo de visualização
let modoPrioridades = false; // Novo modo de prioridades P1/P2/P3

// Função para mostrar notificações melhoradas
function showToast(message, type = 'info') {
    console.log(`${type.toUpperCase()}: ${message}`);
    
    // Definir cores e ícones por tipo
    const tipoConfig = {
        'success': { cor: '#28a745', icone: '✅' },
        'error': { cor: '#dc3545', icone: '❌' },
        'danger': { cor: '#dc3545', icone: '❌' },
        'warning': { cor: '#ffc107', icone: '⚠️' },
        'info': { cor: '#17a2b8', icone: 'ℹ️' }
    };
    
    const config = tipoConfig[type] || tipoConfig['info'];
    
    // Criar toast visual melhorado
    const toast = document.createElement('div');
    toast.className = `toast-notification toast-${type}`;
    toast.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 10000;
        padding: 16px 20px; border-radius: 12px; 
        background: ${config.cor}; color: white;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        max-width: 350px; min-width: 200px;
        animation: slideIn 0.3s ease;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 14px; font-weight: 500;
        display: flex; align-items: center; gap: 10px;
        border-left: 4px solid rgba(255,255,255,0.3);
    `;
    
    toast.innerHTML = `
        <span style="font-size: 16px;">${config.icone}</span>
        <span style="flex: 1; line-height: 1.4;">${message}</span>
        <button onclick="this.parentElement.remove()" style="
            background: rgba(255,255,255,0.2); border: none; color: white; 
            border-radius: 50%; width: 24px; height: 24px; 
            font-size: 16px; cursor: pointer; display: flex;
            align-items: center; justify-content: center;
            transition: background 0.2s ease;
        " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
           onmouseout="this.style.background='rgba(255,255,255,0.2)'">×</button>
    `;
    
    document.body.appendChild(toast);
    
    // Auto-remover com tempo baseado no tipo
    const tempo = type === 'error' || type === 'danger' ? 8000 : 5000;
    setTimeout(() => {
        if (toast.parentElement) {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }
    }, tempo);
}

// Carregar dados reais de progresso
async function carregarDadosProgresso() {
    try {
        showToast('Carregando dados de progresso...', 'info');
        
        const response = await fetch('/api/visitas/progresso-mapa');
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        const resultado = await response.json();
        if (!resultado.success) {
            throw new Error(resultado.message || 'Erro ao carregar dados');
        }
        
        // Processar dados para formato simplificado
        dadosProgresso = {
            municipios: {},
            estatisticas: resultado.estatisticas,
            ultima_atualizacao: resultado.ultima_atualizacao
        };
        
        resultado.data.forEach(municipio => {
            dadosProgresso.municipios[municipio.municipio] = {
                status: municipio.status,
                cor_status: municipio.cor_status,
                resumo: municipio.resumo,
                alertas: municipio.alertas,
                alertas_detalhes: municipio.alertas_detalhes,
                timing: municipio.timing,
                coords: municipio.coords,
                entidades: municipio.entidades || {},
                total_entidades: municipio.total_entidades || 0,
                questionarios: municipio.questionarios || {
                    percentual_mrs: 0,
                    percentual_map: 0,
                    entidades_pendentes: 0,
                    mrs_concluidos: 0,
                    map_concluidos: 0,
                    total_mrs_obrigatorios: 0,
                    total_map_obrigatorios: 0
                }
            };
        });
        
        console.log('✅ Dados carregados:', dadosProgresso);
        atualizarEstatisticas();
        atualizarTarefas();
        atualizarDashboardProdutividade(resultado.data);
        
        // Carregar visitas reais para o calendário
        carregarVisitasReaisCalendario();
        
        showToast('Dados carregados com sucesso!', 'success');
        
    } catch (error) {
        console.error('❌ Erro ao carregar dados da API:', error);
        showToast('Erro ao carregar dados. Verifique a conexão com o servidor.', 'error');
        // Não usar dados simulados - aguardar correção da API
    }
}

// Função removida: carregarDadosSimulados() - sistema usa apenas dados reais das APIs

// =============================================================================
// DASHBOARD DE PRODUTIVIDADE PNSB 2024
// =============================================================================

// Atualizar Dashboard de Produtividade com dados reais
function atualizarDashboardProdutividade(municipiosData) {
    console.log('📊 Atualizando Dashboard de Produtividade...');
    
    // Consolidar dados por prioridade
    let totaisP1 = {total: 0, concluidos: 0};
    let totaisP2 = {total: 0, concluidos: 0};
    let totaisP3 = {total: 0, concluidos: 0};
    
    let totalQuestionarios = 0;
    let questionariosConcluidos = 0;
    let municipiosCompletos = 0;
    
    municipiosData.forEach(municipio => {
        if (municipio.questionarios && municipio.questionarios.prioridades) {
            const prioridades = municipio.questionarios.prioridades;
            
            // P1 - Crítica
            if (prioridades.p1) {
                totaisP1.total += prioridades.p1.total_entidades || 0;
                totaisP1.concluidos += (prioridades.p1.mrs_concluidos || 0) + (prioridades.p1.map_concluidos || 0);
            }
            
            // P2 - Importante  
            if (prioridades.p2) {
                totaisP2.total += prioridades.p2.total_entidades || 0;
                totaisP2.concluidos += (prioridades.p2.mrs_concluidos || 0) + (prioridades.p2.map_concluidos || 0);
            }
            
            // P3 - Opcional
            if (prioridades.p3) {
                totaisP3.total += prioridades.p3.total_entidades || 0;
                totaisP3.concluidos += (prioridades.p3.mrs_concluidos || 0) + (prioridades.p3.map_concluidos || 0);
            }
            
            // Totais gerais
            totalQuestionarios += (municipio.questionarios.total_mrs_obrigatorios || 0) + (municipio.questionarios.total_map_obrigatorios || 0);
            questionariosConcluidos += (municipio.questionarios.mrs_concluidos || 0) + (municipio.questionarios.map_concluidos || 0);
            
            // Verificar se município está 100%
            if (municipio.questionarios.percentual_questionarios >= 100) {
                municipiosCompletos++;
            }
        }
    });
    
    // Atualizar cards P1/P2/P3
    atualizarCardPrioridade('p1', totaisP1);
    atualizarCardPrioridade('p2', totaisP2);
    atualizarCardPrioridade('p3', totaisP3);
    
    // Atualizar métricas de velocidade
    atualizarMetricasVelocidade(totalQuestionarios, questionariosConcluidos, municipiosCompletos);
    
    // Atualizar contador regressivo
    atualizarContadorRegressivo();
    
    // Gerar alertas inteligentes
    gerarAlertasInteligentes(municipiosData);
    
    // Atualizar timeline
    atualizarTimeline(municipiosData);
    
    console.log('✅ Dashboard de Produtividade atualizado!');
}

// Atualizar card individual de prioridade
function atualizarCardPrioridade(prioridade, dados) {
    const totalQuestionarios = dados.total * 2; // Cada entidade tem MRS + MAP
    const percentual = totalQuestionarios > 0 ? Math.round((dados.concluidos / totalQuestionarios) * 100) : 0;
    
    // Atualizar elementos com verificação de existência
    const percentageElement = document.getElementById(`${prioridade}-percentage`);
    const progressElement = document.getElementById(`${prioridade}-progress`);
    const concluidosElement = document.getElementById(`${prioridade}-concluidos`);
    const totalElement = document.getElementById(`${prioridade}-total`);
    
    if (percentageElement) percentageElement.textContent = `${percentual}%`;
    if (progressElement) progressElement.style.width = `${percentual}%`;
    if (concluidosElement) concluidosElement.textContent = dados.concluidos;
    if (totalElement) totalElement.textContent = totalQuestionarios;
    
    console.log(`📊 P${prioridade.toUpperCase()}: ${dados.concluidos}/${totalQuestionarios} (${percentual}%)`);
}

// Atualizar métricas de velocidade
function atualizarMetricasVelocidade(totalQuestionarios, questionariosConcluidos, municipiosCompletos) {
    // Calcular velocidade diária (simulada baseada em progresso)
    const diasDecorridos = Math.max(1, Math.floor((new Date() - new Date('2025-06-09')) / (1000 * 60 * 60 * 24)));
    const velocidadeDiaria = questionariosConcluidos > 0 ? Math.round(questionariosConcluidos / diasDecorridos * 30) : 0; // Média mensal
    
    // Projeção para conclusão
    const questionariosPendentes = totalQuestionarios - questionariosConcluidos;
    const diasParaConclusao = velocidadeDiaria > 0 ? Math.ceil(questionariosPendentes / (velocidadeDiaria / 30)) : '--';
    
    // Score de progresso geral
    const scoreProgresso = totalQuestionarios > 0 ? Math.round((questionariosConcluidos / totalQuestionarios) * 100) : 0;
    
    // Atualizar elementos
    document.getElementById('velocity-daily').textContent = velocidadeDiaria;
    document.getElementById('projection-days').textContent = diasParaConclusao === '--' ? '--' : diasParaConclusao;
    document.getElementById('completion-score').textContent = `${scoreProgresso}%`;
    document.getElementById('municipalities-complete').textContent = municipiosCompletos;
    
    // Atualizar trends
    atualizarTrends(velocidadeDiaria, diasParaConclusao, scoreProgresso, municipiosCompletos);
}

// Atualizar indicadores de tendência
function atualizarTrends(velocidade, diasRestantes, score, municipiosCompletos) {
    const velocityTrend = document.getElementById('velocity-trend');
    const projectionTrend = document.getElementById('projection-trend');
    const scoreTrend = document.getElementById('score-trend');
    const municipalitiesTrend = document.getElementById('municipalities-trend');
    
    // Trend de velocidade
    if (velocidade >= 20) {
        velocityTrend.textContent = '🚀 Acelerado';
        velocityTrend.className = 'velocity-trend trend-up';
    } else if (velocidade >= 10) {
        velocityTrend.textContent = '➡️ Estável';
        velocityTrend.className = 'velocity-trend trend-stable';
    } else {
        velocityTrend.textContent = '🐌 Lento';
        velocityTrend.className = 'velocity-trend trend-down';
    }
    
    // Trend de projeção
    if (diasRestantes !== '--' && diasRestantes <= 30) {
        projectionTrend.textContent = '📈 No Prazo';
        projectionTrend.className = 'velocity-trend trend-up';
    } else if (diasRestantes !== '--' && diasRestantes <= 60) {
        projectionTrend.textContent = '⚠️ Atenção';
        projectionTrend.className = 'velocity-trend trend-stable';
    } else {
        projectionTrend.textContent = '🚨 Risco';
        projectionTrend.className = 'velocity-trend trend-down';
    }
    
    // Trend de score
    if (score >= 80) {
        scoreTrend.textContent = '🎯 Excelente';
        scoreTrend.className = 'velocity-trend trend-up';
    } else if (score >= 60) {
        scoreTrend.textContent = '👍 Bom';
        scoreTrend.className = 'velocity-trend trend-stable';
    } else {
        scoreTrend.textContent = '📉 Baixo';
        scoreTrend.className = 'velocity-trend trend-down';
    }
    
    // Trend de municípios
    municipalitiesTrend.textContent = `🏆 Meta: 11 (${Math.round((municipiosCompletos/11)*100)}%)`;
    if (municipiosCompletos >= 8) {
        municipalitiesTrend.className = 'velocity-trend trend-up';
    } else if (municipiosCompletos >= 4) {
        municipalitiesTrend.className = 'velocity-trend trend-stable';
    } else {
        municipalitiesTrend.className = 'velocity-trend trend-down';
    }
}

// Contador regressivo para deadline PNSB 2024
function atualizarContadorRegressivo() {
    const dataVisitas = new Date('2025-09-19T23:59:59'); // Deadline visitas P1+P2
    const dataQuestionarios = new Date('2025-10-17T23:59:59'); // Deadline questionários
    const agora = new Date();
    
    // Calcular diferenças
    const diferencaVisitas = dataVisitas - agora;
    const diferencaQuestionarios = dataQuestionarios - agora;
    
    // Atualizar contador de visitas
    if (diferencaVisitas > 0) {
        const diasVisitas = Math.floor(diferencaVisitas / (1000 * 60 * 60 * 24));
        const elementVisitas = document.getElementById('countdown-visits-days');
        if (elementVisitas) {
            elementVisitas.textContent = diasVisitas;
        }
        
        // Alterar cor baseado na urgência (visitas)
        const visitasElement = document.querySelector('.countdown-container.visits');
        if (visitasElement) {
            if (diasVisitas <= 14) {
                visitasElement.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
            } else if (diasVisitas <= 30) {
                visitasElement.style.background = 'linear-gradient(135deg, #fd7e14, #e55a00)';
            }
        }
    } else {
        const elementVisitas = document.getElementById('countdown-visits-days');
        if (elementVisitas) {
            elementVisitas.textContent = '0';
        }
    }
    
    // Atualizar contador de questionários
    if (diferencaQuestionarios > 0) {
        const diasQuestionarios = Math.floor(diferencaQuestionarios / (1000 * 60 * 60 * 24));
        const elementQuestionarios = document.getElementById('countdown-questionnaires-days');
        if (elementQuestionarios) {
            elementQuestionarios.textContent = diasQuestionarios;
        }
        
        // Alterar cor baseado na urgência (questionários)
        const questionariosElement = document.querySelector('.countdown-container.questionnaires');
        if (questionariosElement) {
            if (diasQuestionarios <= 14) {
                questionariosElement.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
                questionariosElement.style.color = 'white';
            } else if (diasQuestionarios <= 30) {
                questionariosElement.style.background = 'linear-gradient(135deg, #fd7e14, #e55a00)';
                questionariosElement.style.color = 'white';
            }
        }
    } else {
        const elementQuestionarios = document.getElementById('countdown-questionnaires-days');
        if (elementQuestionarios) {
            elementQuestionarios.textContent = '0';
        }
    }
    
    // Calcular dias totais para referência global
    window.PNSB_DEADLINES = {
        visits: Math.max(0, Math.floor(diferencaVisitas / (1000 * 60 * 60 * 24))),
        questionnaires: Math.max(0, Math.floor(diferencaQuestionarios / (1000 * 60 * 60 * 24))),
        visitsDate: dataVisitas,
        questionnairesDate: dataQuestionarios
    };
}

// =============================================================================
// SISTEMA DE ALERTAS INTELIGENTES
// =============================================================================

let alertasAtivos = [];
let alertasVisiveisCompletos = false;

// Gerar alertas inteligentes baseados nos dados
function gerarAlertasInteligentes(municipiosData) {
    console.log('🚨 Gerando alertas inteligentes...');
    
    alertasAtivos = [];
    
    // Verificar alertas de deadline global primeiro
    const deadlines = window.PNSB_DEADLINES;
    if (deadlines) {
        // Alerta crítico se restam menos de 30 dias para visitas P1+P2
        if (deadlines.visits <= 30 && deadlines.visits > 0) {
            alertasAtivos.push({
                id: 'deadline_visits_critical',
                tipo: 'critical',
                prioridade: 'p1',
                titulo: `🚨 DEADLINE VISITAS: ${deadlines.visits} dias restantes`,
                descricao: `Prazo para concluir TODAS as visitas P1 e P2 termina em 19/09/2025. Acelerar execução imediatamente.`,
                acao: 'mostrarPrioridades("p1")',
                acaoTexto: 'Ver P1+P2',
                urgencia: 'critica',
                icone: '🚨'
            });
        }
        
        // Alerta de aviso se restam menos de 60 dias para questionários
        if (deadlines.questionnaires <= 60 && deadlines.questionnaires > 30) {
            alertasAtivos.push({
                id: 'deadline_questionnaires_warning',
                tipo: 'warning',
                prioridade: 'p2',
                titulo: `⚠️ DEADLINE QUESTIONÁRIOS: ${deadlines.questionnaires} dias restantes`,
                descricao: `Prazo para preencher todos os questionários termina em 17/10/2025. Acelerar processo de coleta.`,
                acao: 'mostrarQuestionarios()',
                acaoTexto: 'Ver Questionários',
                urgencia: 'alta',
                icone: '📋'
            });
        }
        
        // Alerta crítico se restam menos de 30 dias para questionários  
        if (deadlines.questionnaires <= 30 && deadlines.questionnaires > 0) {
            alertasAtivos.push({
                id: 'deadline_questionnaires_critical',
                tipo: 'critical',
                prioridade: 'p1',
                titulo: `🚨 DEADLINE QUESTIONÁRIOS CRÍTICO: ${deadlines.questionnaires} dias`,
                descricao: `URGENTE: Menos de 30 dias para concluir todos os questionários (17/10/2025). Ação imediata necessária.`,
                acao: 'gerarRelatorioInstantaneo()',
                acaoTexto: 'Relatório Urgente',
                urgencia: 'critica',
                icone: '🚨'
            });
        }
    }
    
    municipiosData.forEach(municipio => {
        const questionarios = municipio.questionarios;
        const municipioNome = municipio.municipio;
        
        if (!questionarios) return;
        
        // Alerta crítico: P1 com menos de 50% de progresso
        if (questionarios.percentual_p1 !== undefined && questionarios.percentual_p1 < 50) {
            alertasAtivos.push({
                id: `p1_critical_${municipioNome}`,
                tipo: 'critical',
                prioridade: 'p1',
                titulo: `🚨 P1 Crítica Atrasada: ${municipioNome}`,
                descricao: `Apenas ${questionarios.percentual_p1.toFixed(1)}% das entidades P1 concluídas. Risco alto para deadline PNSB.`,
                acao: `visualizarMunicipio('${municipioNome}')`,
                acaoTexto: 'Ver Detalhes',
                urgencia: 'alta',
                icone: '🚨'
            });
        }
        
        // Alerta de aviso: P2 com menos de 70% de progresso
        if (questionarios.percentual_p2 !== undefined && questionarios.percentual_p2 < 70) {
            alertasAtivos.push({
                id: `p2_warning_${municipioNome}`,
                tipo: 'warning',
                prioridade: 'p2',
                titulo: `⚠️ P2 Importante: ${municipioNome}`,
                descricao: `${questionarios.percentual_p2.toFixed(1)}% das entidades P2 concluídas. Atenção necessária.`,
                acao: `gerenciarQuestionarios('${municipioNome}')`,
                acaoTexto: 'Gerenciar',
                urgencia: 'media',
                icone: '⚠️'
            });
        }
        
        // Alerta de prazo: Município sem visitas agendadas
        if (municipio.resumo && municipio.resumo.agendadas === 0 && municipio.resumo.executadas === 0) {
            alertasAtivos.push({
                id: `no_visits_${municipioNome}`,
                tipo: 'warning',
                prioridade: 'geral',
                titulo: `📅 Sem Agenda: ${municipioNome}`,
                descricao: `Município sem visitas agendadas ou executadas. Agendar urgentemente.`,
                acao: `agendarVisita('${municipioNome}')`,
                acaoTexto: 'Agendar',
                urgencia: 'alta',
                icone: '📅'
            });
        }
        
        // Alerta informativo: Município próximo da conclusão
        if (questionarios.percentual_questionarios >= 80 && questionarios.percentual_questionarios < 100) {
            alertasAtivos.push({
                id: `near_completion_${municipioNome}`,
                tipo: 'info',
                prioridade: 'geral',
                titulo: `🎯 Quase Completo: ${municipioNome}`,
                descricao: `${questionarios.percentual_questionarios.toFixed(1)}% concluído. Faltam poucos questionários!`,
                acao: `finalizarMunicipio('${municipioNome}')`,
                acaoTexto: 'Finalizar',
                urgencia: 'baixa',
                icone: '🎯'
            });
        }
        
        // Alerta de sucesso: Município 100% completo
        if (questionarios.percentual_questionarios >= 100) {
            alertasAtivos.push({
                id: `completed_${municipioNome}`,
                tipo: 'info',
                prioridade: 'geral',
                titulo: `🏆 Completo: ${municipioNome}`,
                descricao: `Município 100% concluído! Parabéns pela excelência.`,
                acao: `gerarRelatorio('${municipioNome}')`,
                acaoTexto: 'Relatório',
                urgencia: 'baixa',
                icone: '🏆'
            });
        }
    });
    
    // Ordenar por urgência (alta -> média -> baixa)
    const ordemUrgencia = {'alta': 3, 'media': 2, 'baixa': 1};
    alertasAtivos.sort((a, b) => ordemUrgencia[b.urgencia] - ordemUrgencia[a.urgencia]);
    
    console.log(`✅ ${alertasAtivos.length} alertas gerados`);
    exibirAlertas();
}

// Exibir alertas na interface
function exibirAlertas() {
    const container = document.getElementById('alerts-container');
    const badge = document.getElementById('alert-count');
    
    badge.textContent = alertasAtivos.length;
    
    if (alertasAtivos.length === 0) {
        container.innerHTML = '<div class="success">🎉 Nenhum alerta ativo! Tudo funcionando perfeitamente.</div>';
        return;
    }
    
    // Mostrar apenas os 3 mais urgentes por padrão
    const alertasParaMostrar = alertasVisiveisCompletos ? alertasAtivos : alertasAtivos.slice(0, 3);
    
    container.innerHTML = alertasParaMostrar.map(alerta => `
        <div class="alert-card ${alerta.tipo}">
            <div class="alert-priority ${alerta.prioridade}">${alerta.prioridade.toUpperCase()}</div>
            <div class="alert-icon">${alerta.icone}</div>
            <div class="alert-title">${alerta.titulo}</div>
            <div class="alert-description">${alerta.descricao}</div>
            <div class="alert-actions">
                <button class="alert-button primary" onclick="${alerta.acao}">
                    ${alerta.acaoTexto}
                </button>
                <button class="alert-button secondary" onclick="dismissAlert('${alerta.id}')">
                    Dispensar
                </button>
            </div>
        </div>
    `).join('');
    
    // Atualizar botão de toggle
    const btnToggle = document.getElementById('btn-toggle-alerts');
    if (alertasAtivos.length > 3) {
        btnToggle.style.display = 'block';
        btnToggle.innerHTML = alertasVisiveisCompletos 
            ? '<i class="fas fa-eye-slash"></i> Mostrar Menos' 
            : `<i class="fas fa-eye"></i> Mostrar Todos (${alertasAtivos.length})`;
    } else {
        btnToggle.style.display = 'none';
    }
}

// Toggle entre mostrar todos os alertas ou apenas os principais
function toggleAlertas() {
    alertasVisiveisCompletos = !alertasVisiveisCompletos;
    exibirAlertas();
}

// Dispensar um alerta específico
function dismissAlert(alertId) {
    alertasAtivos = alertasAtivos.filter(alerta => alerta.id !== alertId);
    exibirAlertas();
    showToast('Alerta dispensado', 'info');
}

// Funções de ação dos alertas
function visualizarMunicipio(municipio) {
    // Implementar navegação para detalhes do município
    console.log(`Visualizando município: ${municipio}`);
    showToast(`Abrindo detalhes de ${municipio}...`, 'info');
    // Aqui você pode abrir o modal ou navegar para página específica
}

function gerenciarQuestionarios(municipio) {
    console.log(`Gerenciando questionários de: ${municipio}`);
    showToast(`Abrindo gestão de questionários para ${municipio}...`, 'info');
    // Implementar navegação para gestão de questionários
}

function agendarVisita(municipio) {
    console.log(`Agendando visita para: ${municipio}`);
    showToast(`Abrindo agendamento para ${municipio}...`, 'info');
    // Implementar navegação para agendamento
}

function finalizarMunicipio(municipio) {
    console.log(`Finalizando município: ${municipio}`);
    showToast(`Preparando finalização de ${municipio}...`, 'info');
    // Implementar processo de finalização
}

function gerarRelatorio(municipio) {
    console.log(`Gerando relatório para: ${municipio}`);
    showToast(`Gerando relatório de ${municipio}...`, 'success');
    // Implementar geração de relatório
}

// =============================================================================
// TIMELINE DE PROGRESSO SEMANAL
// =============================================================================

let timelineView = 'semanal'; // 'semanal' ou 'mensal'

// Atualizar timeline de progresso
function atualizarTimeline(municipiosData) {
    console.log('📈 Atualizando timeline de progresso...');
    
    // Calcular progresso geral
    let totalQuestionarios = 0;
    let questionariosConcluidos = 0;
    
    municipiosData.forEach(municipio => {
        if (municipio.questionarios) {
            totalQuestionarios += (municipio.questionarios.total_mrs_obrigatorios || 0) + (municipio.questionarios.total_map_obrigatorios || 0);
            questionariosConcluidos += (municipio.questionarios.mrs_concluidos || 0) + (municipio.questionarios.map_concluidos || 0);
        }
    });
    
    const progressoGeral = totalQuestionarios > 0 ? (questionariosConcluidos / totalQuestionarios) * 100 : 0;
    
    // Datas reais da pesquisa PNSB 2024/2025
    const dataInicio = new Date('2025-06-09'); // Início efetivo da pesquisa PNSB 2024
    const dataFimVisitas = new Date('2025-09-19'); // Deadline visitas P1+P2
    const dataFimQuestionarios = new Date('2025-10-17'); // Deadline questionários
    const dataAtual = new Date();
    
    // Calcular semanas (usando deadline de questionários como referência final)
    const semanasTotal = Math.ceil((dataFimQuestionarios - dataInicio) / (7 * 24 * 60 * 60 * 1000));
    const semanasDecorridas = Math.ceil((dataAtual - dataInicio) / (7 * 24 * 60 * 60 * 1000));
    const semanasRestantesVisitas = Math.max(0, Math.ceil((dataFimVisitas - dataAtual) / (7 * 24 * 60 * 60 * 1000)));
    const semanasRestantesQuestionarios = Math.max(0, Math.ceil((dataFimQuestionarios - dataAtual) / (7 * 24 * 60 * 60 * 1000)));
    
    // Velocidade semanal
    const velocidadeSemanal = semanasDecorridas > 0 ? Math.round(questionariosConcluidos / semanasDecorridas) : 0;
    
    // Previsões de conclusão
    const questionariosPendentes = totalQuestionarios - questionariosConcluidos;
    const semanasParaConclusaoQuestionarios = velocidadeSemanal > 0 ? Math.ceil(questionariosPendentes / velocidadeSemanal) : '--';
    
    // Calcular progresso específico por fase
    const progressoVisitas = (semanasDecorridas / semanasTotal) * 100; // Progresso temporal
    const progressoQuestionarios = progressoGeral; // Progresso real dos questionários
    
    // Atualizar elementos visuais
    document.getElementById('timeline-progress').style.width = `${Math.min(progressoGeral, 100)}%`;
    document.getElementById('progresso-atual').textContent = `${progressoGeral.toFixed(1)}%`;
    document.getElementById('semanas-decorridas').textContent = semanasDecorridas;
    document.getElementById('velocidade-semanal').textContent = velocidadeSemanal;
    
    // Atualizar previsão baseada na proximidade dos deadlines
    const diasParaVisitas = window.PNSB_DEADLINES ? window.PNSB_DEADLINES.visits : semanasRestantesVisitas * 7;
    const diasParaQuestionarios = window.PNSB_DEADLINES ? window.PNSB_DEADLINES.questionnaires : semanasRestantesQuestionarios * 7;
    
    if (diasParaVisitas <= 30) {
        // Foco nas visitas se estamos próximos do deadline
        document.getElementById('previsao-conclusao').textContent = `Visitas: ${diasParaVisitas}d`;
    } else if (semanasParaConclusaoQuestionarios !== '--') {
        const dataConclusaoPrevisao = new Date();
        dataConclusaoPrevisao.setDate(dataConclusaoPrevisao.getDate() + (semanasParaConclusaoQuestionarios * 7));
        document.getElementById('previsao-conclusao').textContent = dataConclusaoPrevisao.toLocaleDateString('pt-BR', {month: 'short', day: 'numeric'});
    } else {
        document.getElementById('previsao-conclusao').textContent = `Quest: ${diasParaQuestionarios}d`;
    }
    
    // Atualizar milestones
    atualizarMilestones(progressoGeral);
    
    // Atualizar status
    let statusTexto = '';
    if (progressoGeral >= 100) {
        statusTexto = '🏆 Pesquisa Concluída!';
    } else if (progressoGeral >= 75) {
        statusTexto = '🎯 Reta Final';
    } else if (progressoGeral >= 50) {
        statusTexto = '⚡ Em Ritmo Acelerado';
    } else if (progressoGeral >= 25) {
        statusTexto = '🚀 Ganhando Velocidade';
    } else {
        statusTexto = '🏁 Início da Jornada';
    }
    
    document.getElementById('timeline-status').textContent = statusTexto;
    
    console.log('✅ Timeline atualizada!');
}

// Atualizar status dos milestones
function atualizarMilestones(progresso) {
    const milestones = [
        {id: 'milestone-start', threshold: 0},
        {id: 'milestone-25', threshold: 25},
        {id: 'milestone-50', threshold: 50},
        {id: 'milestone-75', threshold: 75},
        {id: 'milestone-100', threshold: 100}
    ];
    
    milestones.forEach(milestone => {
        const elemento = document.getElementById(milestone.id);
        
        if (progresso >= milestone.threshold) {
            elemento.className = 'milestone completed';
        } else if (progresso >= milestone.threshold - 10) {
            elemento.className = 'milestone current';
        } else {
            elemento.className = 'milestone';
        }
    });
}

// Toggle entre visualização semanal e mensal
function toggleTimelineView() {
    timelineView = timelineView === 'semanal' ? 'mensal' : 'semanal';
    
    const btn = document.getElementById('btn-timeline-view');
    if (timelineView === 'semanal') {
        btn.innerHTML = '<i class="fas fa-calendar-week"></i> Semanal';
    } else {
        btn.innerHTML = '<i class="fas fa-calendar-alt"></i> Mensal';
    }
    
    // Recarregar dados se necessário
    if (dadosProgresso && dadosProgresso.municipios) {
        // Converter dados de municipios para array se necessário
        const municipiosArray = Object.values(dadosProgresso.municipios);
        atualizarTimeline(municipiosArray);
    }
    
    showToast(`Visualização alterada para ${timelineView}`, 'info');
}

// =============================================================================
// HEATMAP DE INTENSIDADE
// =============================================================================

let heatmapMode = 'off';
let heatmapOverlays = [];

// Inicializar controles do heatmap
function inicializarHeatmap() {
    console.log('🔥 Inicializando controles do heatmap...');
    
    // Adicionar event listeners para os controles
    document.querySelectorAll('input[name="heatmap"]').forEach(input => {
        input.addEventListener('change', function() {
            if (this.checked) {
                alterarModoHeatmap(this.value);
            }
        });
    });
    
    console.log('✅ Heatmap inicializado!');
}

// Alterar modo do heatmap
function alterarModoHeatmap(modo) {
    console.log(`🔥 Alterando heatmap para modo: ${modo}`);
    
    heatmapMode = modo;
    
    // Remover overlays existentes
    limparHeatmap();
    
    if (modo === 'off') {
        document.getElementById('heatmap-legend').style.display = 'none';
        // Voltar aos marcadores padrão
        atualizarMarcadoresParaPadrao();
    } else {
        document.getElementById('heatmap-legend').style.display = 'block';
        aplicarHeatmap(modo);
    }
    
    showToast(`Heatmap: ${getHeatmapModeDescription(modo)}`, 'info');
}

// Obter descrição do modo do heatmap
function getHeatmapModeDescription(modo) {
    const descriptions = {
        'off': 'Desligado',
        'progress': 'Por Progresso',
        'priority': 'Por Prioridade',
        'urgency': 'Por Urgência',
        'density': 'Densidade'
    };
    return descriptions[modo] || modo;
}

// Aplicar heatmap baseado no modo selecionado
function aplicarHeatmap(modo) {
    if (!dadosProgresso || !dadosProgresso.municipios) {
        console.warn('⚠️ Dados não disponíveis para heatmap');
        return;
    }
    
    const municipios = Object.entries(dadosProgresso.municipios);
    const legend = document.getElementById('legend-items');
    
    switch (modo) {
        case 'progress':
            aplicarHeatmapProgresso(municipios);
            atualizarLegendaProgresso(legend);
            break;
        case 'priority':
            aplicarHeatmapPrioridade(municipios);
            atualizarLegendaPrioridade(legend);
            break;
        case 'urgency':
            aplicarHeatmapUrgencia(municipios);
            atualizarLegendaUrgencia(legend);
            break;
        case 'density':
            aplicarHeatmapDensidade(municipios);
            atualizarLegendaDensidade(legend);
            break;
    }
}

// Heatmap por progresso
function aplicarHeatmapProgresso(municipios) {
    municipios.forEach(([nome, dados]) => {
        const marcador = marcadores[nome];
        if (!marcador) return;
        
        const progresso = dados.questionarios?.percentual_questionarios || 0;
        const intensidade = getIntensidadeProgresso(progresso);
        
        atualizarMarcadorHeatmap(marcador, intensidade);
    });
}

// Heatmap por prioridade
function aplicarHeatmapPrioridade(municipios) {
    municipios.forEach(([nome, dados]) => {
        const marcador = marcadores[nome];
        if (!marcador) return;
        
        const prioridades = dados.questionarios?.prioridades || {};
        const intensidade = getIntensidadePrioridade(prioridades);
        
        atualizarMarcadorHeatmap(marcador, intensidade);
    });
}

// Heatmap por urgência
function aplicarHeatmapUrgencia(municipios) {
    municipios.forEach(([nome, dados]) => {
        const marcador = marcadores[nome];
        if (!marcador) return;
        
        const urgencia = calcularUrgencia(dados);
        const intensidade = getIntensidadeUrgencia(urgencia);
        
        atualizarMarcadorHeatmap(marcador, intensidade);
    });
}

// Heatmap por densidade
function aplicarHeatmapDensidade(municipios) {
    municipios.forEach(([nome, dados]) => {
        const marcador = marcadores[nome];
        if (!marcador) return;
        
        const densidade = dados.total_entidades || 0;
        const intensidade = getIntensidadeDensidade(densidade);
        
        atualizarMarcadorHeatmap(marcador, intensidade);
        
        // Adicionar overlay de densidade
        if (densidade > 5) {
            adicionarOverlayDensidade(marcador, densidade);
        }
    });
}

// Calcular intensidade baseada no progresso
function getIntensidadeProgresso(progresso) {
    if (progresso >= 90) return 'very-low';  // Verde - muito bom
    if (progresso >= 70) return 'low';       // Verde claro
    if (progresso >= 50) return 'medium';    // Amarelo
    if (progresso >= 25) return 'high';      // Laranja
    return 'very-high';                      // Vermelho - crítico
}

// Calcular intensidade baseada nas prioridades
function getIntensidadePrioridade(prioridades) {
    const p1Progresso = prioridades.p1?.percentual_conclusao || 0;
    const p1Total = prioridades.p1?.total_entidades || 0;
    
    if (p1Total === 0) return 'very-low';
    if (p1Progresso >= 80) return 'very-low';
    if (p1Progresso >= 60) return 'low';
    if (p1Progresso >= 40) return 'medium';
    if (p1Progresso >= 20) return 'high';
    return 'very-high';
}

// Calcular urgência baseada em múltiplos fatores
function calcularUrgencia(dados) {
    let score = 0;
    
    // Progresso baixo aumenta urgência
    const progresso = dados.questionarios?.percentual_questionarios || 0;
    if (progresso < 25) score += 3;
    else if (progresso < 50) score += 2;
    else if (progresso < 75) score += 1;
    
    // Alertas aumentam urgência
    const alertas = dados.alertas?.length || 0;
    score += Math.min(alertas, 3);
    
    // Entidades P1 pendentes aumentam urgência
    const p1Progresso = dados.questionarios?.percentual_p1 || 0;
    if (p1Progresso < 50) score += 2;
    
    return score;
}

// Calcular intensidade baseada na urgência
function getIntensidadeUrgencia(urgencia) {
    if (urgencia >= 7) return 'very-high';
    if (urgencia >= 5) return 'high';
    if (urgencia >= 3) return 'medium';
    if (urgencia >= 1) return 'low';
    return 'very-low';
}

// Calcular intensidade baseada na densidade
function getIntensidadeDensidade(densidade) {
    if (densidade >= 20) return 'very-high';
    if (densidade >= 15) return 'high';
    if (densidade >= 10) return 'medium';
    if (densidade >= 5) return 'low';
    return 'very-low';
}

// Atualizar marcador com estilo do heatmap
function atualizarMarcadorHeatmap(marcador, intensidade) {
    const elemento = marcador.getElement();
    if (!elemento) return;
    
    // Remover classes de intensidade existentes
    elemento.classList.remove('intensity-very-low', 'intensity-low', 'intensity-medium', 'intensity-high', 'intensity-very-high');
    
    // Adicionar nova classe
    elemento.classList.add('heatmap-marker', `intensity-${intensidade}`);
    
    // Ajustar tamanho baseado na intensidade
    const sizes = {
        'very-low': '20px',
        'low': '25px',
        'medium': '30px',
        'high': '35px',
        'very-high': '40px'
    };
    
    elemento.style.width = sizes[intensidade];
    elemento.style.height = sizes[intensidade];
}

// Voltar aos marcadores padrão
function atualizarMarcadoresParaPadrao() {
    Object.values(marcadores).forEach(marcador => {
        const elemento = marcador.getElement();
        if (!elemento) return;
        
        elemento.classList.remove('heatmap-marker', 'intensity-very-low', 'intensity-low', 'intensity-medium', 'intensity-high', 'intensity-very-high');
        elemento.style.width = '25px';
        elemento.style.height = '25px';
    });
}

// Adicionar overlay de densidade
function adicionarOverlayDensidade(marcador, densidade) {
    const posicao = marcador.getLatLng();
    const raio = Math.min(densidade * 50, 500); // Máximo 500m
    
    let className = 'density-low';
    if (densidade >= 15) className = 'density-high';
    else if (densidade >= 10) className = 'density-medium';
    
    const overlay = L.circle(posicao, {
        radius: raio,
        className: className,
        fillOpacity: 0.3,
        stroke: false
    }).addTo(mapa);
    
    heatmapOverlays.push(overlay);
}

// Limpar overlays do heatmap
function limparHeatmap() {
    heatmapOverlays.forEach(overlay => {
        mapa.removeLayer(overlay);
    });
    heatmapOverlays = [];
}

// Atualizar legendas
function atualizarLegendaProgresso(container) {
    container.innerHTML = `
        <div class="legend-item">
            <div class="legend-color intensity-very-low"></div>
            <div class="legend-text">90%+ Concluído</div>
        </div>
        <div class="legend-item">
            <div class="legend-color intensity-low"></div>
            <div class="legend-text">70-89% Concluído</div>
        </div>
        <div class="legend-item">
            <div class="legend-color intensity-medium"></div>
            <div class="legend-text">50-69% Concluído</div>
        </div>
        <div class="legend-item">
            <div class="legend-color intensity-high"></div>
            <div class="legend-text">25-49% Concluído</div>
        </div>
        <div class="legend-item">
            <div class="legend-color intensity-very-high"></div>
            <div class="legend-text">0-24% Concluído</div>
        </div>
    `;
}

function atualizarLegendaPrioridade(container) {
    container.innerHTML = `
        <div class="legend-item">
            <div class="legend-color intensity-very-low"></div>
            <div class="legend-text">P1 80%+ Concluída</div>
        </div>
        <div class="legend-item">
            <div class="legend-color intensity-low"></div>
            <div class="legend-text">P1 60-79% Concluída</div>
        </div>
        <div class="legend-item">
            <div class="legend-color intensity-medium"></div>
            <div class="legend-text">P1 40-59% Concluída</div>
        </div>
        <div class="legend-item">
            <div class="legend-color intensity-high"></div>
            <div class="legend-text">P1 20-39% Concluída</div>
        </div>
        <div class="legend-item">
            <div class="legend-color intensity-very-high"></div>
            <div class="legend-text">P1 0-19% Concluída</div>
        </div>
    `;
}

function atualizarLegendaUrgencia(container) {
    container.innerHTML = `
        <div class="legend-item">
            <div class="legend-color intensity-very-low"></div>
            <div class="legend-text">Baixa Urgência</div>
        </div>
        <div class="legend-item">
            <div class="legend-color intensity-low"></div>
            <div class="legend-text">Urgência Leve</div>
        </div>
        <div class="legend-item">
            <div class="legend-color intensity-medium"></div>
            <div class="legend-text">Urgência Média</div>
        </div>
        <div class="legend-item">
            <div class="legend-color intensity-high"></div>
            <div class="legend-text">Alta Urgência</div>
        </div>
        <div class="legend-item">
            <div class="legend-color intensity-very-high"></div>
            <div class="legend-text">Urgência Crítica</div>
        </div>
    `;
}

function atualizarLegendaDensidade(container) {
    container.innerHTML = `
        <div class="legend-item">
            <div class="legend-color intensity-very-low"></div>
            <div class="legend-text">1-4 Entidades</div>
        </div>
        <div class="legend-item">
            <div class="legend-color intensity-low"></div>
            <div class="legend-text">5-9 Entidades</div>
        </div>
        <div class="legend-item">
            <div class="legend-color intensity-medium"></div>
            <div class="legend-text">10-14 Entidades</div>
        </div>
        <div class="legend-item">
            <div class="legend-color intensity-high"></div>
            <div class="legend-text">15-19 Entidades</div>
        </div>
        <div class="legend-item">
            <div class="legend-color intensity-very-high"></div>
            <div class="legend-text">20+ Entidades</div>
        </div>
    `;
}

// Inicializar Dashboard de Produtividade
function inicializarDashboardProdutividade() {
    console.log('🚀 Inicializando Dashboard de Produtividade PNSB...');
    
    // Configurar contador regressivo para atualizar a cada hora
    atualizarContadorRegressivo();
    setInterval(atualizarContadorRegressivo, 3600000); // 1 hora
    
    console.log('✅ Dashboard de Produtividade inicializado!');
}

// Inicializar mapa Leaflet
function inicializarMapa() {
    try {
        // Verificar se elemento existe
        const mapContainer = document.getElementById('mapa-progresso');
        if (!mapContainer) {
            console.error('❌ Container do mapa não encontrado');
            return;
        }
        
        // Verificar dimensões
        if (mapContainer.offsetWidth === 0) {
            console.warn('⚠️ Container sem dimensões, tentando novamente...');
            setTimeout(inicializarMapa, 100);
            return;
        }
        
        // Criar mapa
        mapa = L.map('mapa-progresso').setView([-26.9, -48.65], 10);
        
        // Adicionar tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 18
        }).addTo(mapa);
        
        console.log('✅ Mapa inicializado com sucesso');
        adicionarMarcadores();
        
    } catch (error) {
        console.error('❌ Erro ao inicializar mapa:', error);
        showToast('Erro ao inicializar mapa', 'error');
    }
}

// Adicionar marcadores dos municípios
function adicionarMarcadores() {
    if (!dadosProgresso.municipios) return;
    
    // Limpar marcadores existentes
    Object.values(marcadores).forEach(marker => {
        mapa.removeLayer(marker);
    });
    marcadores = {};
    
    // Adicionar novos marcadores
    Object.entries(dadosProgresso.municipios).forEach(([nome, dados]) => {
        if (!dados.coords) return;
        
        // Determinar cor baseada no modo de visualização
        let cor, iconText;
        
        if (modoPrioridades) {
            // Modo prioridades: cor baseada no progresso das prioridades P1, P2, P3
            const progressoP1 = dados.questionarios?.percentual_p1 || 0;
            const progressoP2 = dados.questionarios?.percentual_p2 || 0;
            const totalEntidadesP1 = dados.questionarios?.prioridades?.p1?.total_entidades || 0;
            const totalEntidadesP2 = dados.questionarios?.prioridades?.p2?.total_entidades || 0;
            
            // Priorizar P1 (crítica) na visualização
            if (totalEntidadesP1 > 0) {
                if (progressoP1 >= 100) {
                    cor = '#28a745'; // Verde - P1 completa
                    iconText = 'P1✓';
                } else if (progressoP1 >= 50) {
                    cor = '#ffc107'; // Amarelo - P1 em andamento
                    iconText = 'P1';
                } else {
                    cor = '#dc3545'; // Vermelho - P1 pendente
                    iconText = 'P1!';
                }
            } else if (totalEntidadesP2 > 0) {
                if (progressoP2 >= 100) {
                    cor = '#17a2b8'; // Azul - P2 completa
                    iconText = 'P2✓';
                } else {
                    cor = '#fd7e14'; // Laranja - P2 pendente
                    iconText = 'P2';
                }
            } else {
                cor = '#B0B3C7'; // Cinza - sem prioridades identificadas
                iconText = '?';
            }
        } else if (modoQuestionarios) {
            // Modo questionários: cor baseada no progresso MRS/MAP
            const progressoQuestionarios = dados.questionarios?.percentual_questionarios || 0;
            
            if (progressoQuestionarios >= 100) {
                cor = '#28a745'; // Verde - completo
                iconText = '✓';
            } else if (progressoQuestionarios >= 50) {
                cor = '#ffc107'; // Amarelo - em andamento
                iconText = Math.round(progressoQuestionarios) + '%';
            } else if (progressoQuestionarios > 0) {
                cor = '#fd7e14'; // Laranja - iniciado
                iconText = Math.round(progressoQuestionarios) + '%';
            } else {
                cor = '#dc3545'; // Vermelho - não iniciado
                iconText = '!';
            }
        } else {
            // Modo padrão: cor baseada no status da visita
            const cores = {
                'finalizado': '#28a745',
                'em_followup': '#ffc107', 
                'executado': '#17a2b8',
                'agendado': '#B0B3C7',
                'sem_visita': '#dc3545'
            };
            
            cor = cores[dados.status] || '#B0B3C7';
            iconText = dados.resumo?.total_visitas || 0;
        }
        
        // Criar ícone personalizado
        const icon = L.divIcon({
            className: 'marker-custom',
            html: `
                <div style="
                    background: ${cor}; 
                    width: 24px; height: 24px; 
                    border-radius: 50%; 
                    border: 3px solid white;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                    display: flex; align-items: center; justify-content: center;
                    color: white; font-weight: bold; font-size: 12px;
                ">
                    ${iconText}
                </div>
            `,
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });
        
        // Criar marcador
        const marker = L.marker(dados.coords, { icon }).addTo(mapa);
        
        // Tooltip adaptativo baseado no modo
        const tooltipContent = modoQuestionarios ? `
            <strong>${nome}</strong><br>
            MRS: ${dados.questionarios?.mrs_concluidos || 0}/${dados.questionarios?.total_mrs_obrigatorios || 0} (${dados.questionarios?.percentual_mrs || 0}%)<br>
            MAP: ${dados.questionarios?.map_concluidos || 0}/${dados.questionarios?.total_map_obrigatorios || 0} (${dados.questionarios?.percentual_map || 0}%)<br>
            Entidades: ${dados.questionarios?.entidades_identificadas || 0}<br>
            ${dados.questionarios?.entidades_pendentes > 0 ? `⚠️ ${dados.questionarios.entidades_pendentes} pendente(s)` : '✅ Em dia'}
        ` : `
            <strong>${nome}</strong><br>
            Status: ${getStatusText(dados.status)}<br>
            Visitas: ${dados.resumo?.total_visitas || 0}<br>
            ${dados.alertas?.length > 0 ? `⚠️ ${dados.alertas.length} alerta(s)` : ''}
        `;
        
        marker.bindTooltip(tooltipContent, { 
            permanent: false,
            direction: 'top'
        });
        
        // Click para abrir modal
        marker.on('click', () => abrirModalMunicipio(nome, dados));
        
        marcadores[nome] = marker;
    });
}

// Abrir modal com detalhes do município
function abrirModalMunicipio(nome, dados) {
    const modal = document.getElementById('modal-municipio');
    const conteudo = document.getElementById('modal-conteudo');
    
    // Gerar conteúdo do modal
    const entidadesHtml = Object.keys(dados.entidades).length > 0 
        ? `<p><strong>Entidades:</strong> ${Object.entries(dados.entidades).map(([tipo, count]) => `${tipo} (${count})`).join(', ')}</p>`
        : '<p><em>Apenas prefeitura</em></p>';
    
    const alertasHtml = dados.alertas?.length > 0
        ? `<div class="error">
             <strong>⚠️ Alertas:</strong><br>
             ${dados.alertas.join('<br>')}
           </div>`
        : '';
    
    conteudo.innerHTML = `
        <h3 style="color: #F1F1F1; margin-bottom: 20px;">
            <i class="fas fa-map-marker-alt"></i> ${nome}
        </h3>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 20px;">
            <div class="stat-card">
                <div class="stat-number">${dados.resumo?.total_visitas || 0}</div>
                <div class="stat-label">Total Visitas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${dados.resumo?.finalizadas || 0}</div>
                <div class="stat-label">Finalizadas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${dados.questionarios?.percentual_mrs || 0}%</div>
                <div class="stat-label">Progresso MRS</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${dados.questionarios?.percentual_map || 0}%</div>
                <div class="stat-label">Progresso MAP</div>
            </div>
        </div>
        
        <!-- Seção específica de questionários -->
        <div style="background: #2D3142; padding: 15px; border-radius: 8px; margin: 15px 0;">
            <h6 style="color: #F1F1F1; margin-bottom: 10px;">📋 Questionários Obrigatórios</h6>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <strong>MRS (Resíduos Sólidos):</strong><br>
                    ${dados.questionarios?.mrs_concluidos || 0}/${dados.questionarios?.total_mrs_obrigatorios || 0} concluídos
                    <div style="background: #23263B; height: 6px; border-radius: 3px; margin-top: 5px;">
                        <div style="background: #28a745; height: 100%; width: ${dados.questionarios?.percentual_mrs || 0}%; border-radius: 3px;"></div>
                    </div>
                </div>
                <div>
                    <strong>MAP (Águas Pluviais):</strong><br>
                    ${dados.questionarios?.map_concluidos || 0}/${dados.questionarios?.total_map_obrigatorios || 0} concluídos
                    <div style="background: #23263B; height: 6px; border-radius: 3px; margin-top: 5px;">
                        <div style="background: #17a2b8; height: 100%; width: ${dados.questionarios?.percentual_map || 0}%; border-radius: 3px;"></div>
                    </div>
                </div>
            </div>
            <div style="margin-top: 10px;">
                <small><strong>Entidades identificadas:</strong> ${dados.questionarios?.entidades_identificadas || 0}</small><br>
                <small><strong>Pendentes:</strong> ${dados.questionarios?.entidades_pendentes || 0}</small>
            </div>
        </div>
        
        <!-- Nova seção de prioridades -->
        ${dados.questionarios?.sistema_prioridades_ativo ? `
        <div style="background: #2D3142; padding: 15px; border-radius: 8px; margin: 15px 0;">
            <h6 style="color: #F1F1F1; margin-bottom: 15px;">🎯 Sistema de Prioridades PNSB</h6>
            
            <div style="display: grid; gap: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #23263B; border-radius: 6px; border-left: 4px solid ${dados.questionarios?.prioridades?.p1?.cor || '#dc3545'};">
                    <div>
                        <strong style="color: #F1F1F1;">P1 - Crítica</strong><br>
                        <small style="color: #B8BCC8;">${dados.questionarios?.prioridades?.p1?.descricao || 'Prefeituras + Lista UF'}</small>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 18px; font-weight: bold; color: ${dados.questionarios?.prioridades?.p1?.cor || '#dc3545'};">
                            ${dados.questionarios?.percentual_p1 || 0}%
                        </div>
                        <small style="color: #B8BCC8;">${dados.questionarios?.prioridades?.p1?.total_entidades || 0} entidades</small>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #23263B; border-radius: 6px; border-left: 4px solid ${dados.questionarios?.prioridades?.p2?.cor || '#ffc107'};">
                    <div>
                        <strong style="color: #F1F1F1;">P2 - Importante</strong><br>
                        <small style="color: #B8BCC8;">${dados.questionarios?.prioridades?.p2?.descricao || 'Identificadas em campo'}</small>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 18px; font-weight: bold; color: ${dados.questionarios?.prioridades?.p2?.cor || '#ffc107'};">
                            ${dados.questionarios?.percentual_p2 || 0}%
                        </div>
                        <small style="color: #B8BCC8;">${dados.questionarios?.prioridades?.p2?.total_entidades || 0} entidades</small>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #23263B; border-radius: 6px; border-left: 4px solid ${dados.questionarios?.prioridades?.p3?.cor || '#B0B3C7'};">
                    <div>
                        <strong style="color: #F1F1F1;">P3 - Opcional</strong><br>
                        <small style="color: #B8BCC8;">${dados.questionarios?.prioridades?.p3?.descricao || 'Recursos disponíveis'}</small>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 18px; font-weight: bold; color: ${dados.questionarios?.prioridades?.p3?.cor || '#B0B3C7'};">
                            ${dados.questionarios?.percentual_p3 || 0}%
                        </div>
                        <small style="color: #B8BCC8;">${dados.questionarios?.prioridades?.p3?.total_entidades || 0} entidades</small>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 10px; padding: 8px; background: ${dados.questionarios?.status_p1 === 'concluido' ? 'rgba(40, 167, 69, 0.2)' : dados.questionarios?.status_p1 === 'em_andamento' ? 'rgba(255, 193, 7, 0.2)' : 'rgba(220, 53, 69, 0.2)'}; border-radius: 6px;">
                <small><strong>Status P1 (Crítica):</strong> <span style="color: #F1F1F1;">${getStatusPrioridadeText(dados.questionarios?.status_p1 || 'nao_iniciado')}</span></small>
            </div>
        </div>
        ` : ''}
        
        ${alertasHtml}
        
        <div style="background: #2D3142; padding: 15px; border-radius: 8px; margin: 15px 0;">
            <h6 style="color: #F1F1F1; margin-bottom: 10px;">Informações Gerais</h6>
            <p><strong>Status:</strong> <span class="status-${dados.status}">${getStatusText(dados.status)}</span></p>
            <p><strong>Progresso:</strong> ${dados.resumo?.percentual_conclusao || 0}%</p>
            ${entidadesHtml}
            ${dados.timing?.dias_sem_atividade ? `<p><strong>Última atividade:</strong> ${dados.timing.dias_sem_atividade} dias atrás</p>` : ''}
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
            <button class="btn-task btn-primary" onclick="agendarVisita('${nome}')">
                <i class="fas fa-calendar-plus"></i> Agendar Visita
            </button>
            <button class="btn-task btn-success" onclick="enviarWhatsApp('${nome}')">
                <i class="fas fa-whatsapp"></i> WhatsApp
            </button>
            <button class="btn-task btn-warning" onclick="verRelatorio('${nome}')">
                <i class="fas fa-chart-bar"></i> Relatório
            </button>
            <button class="btn-task btn-primary" onclick="gerenciarQuestionarios('${nome}')" style="background: #5F5CFF;">
                <i class="fas fa-clipboard-list"></i> Questionários
            </button>
            ${dados.questionarios?.entidades_pendentes > 0 ? `
            <button class="btn-task btn-warning" onclick="acompanharEntidades('${nome}')">
                <i class="fas fa-exclamation-triangle"></i> ${dados.questionarios.entidades_pendentes} Pendente(s)
            </button>
            ` : ''}
        </div>
    `;
    
    modal.style.display = 'flex';
}

// Fechar modal
function fecharModal() {
    document.getElementById('modal-municipio').style.display = 'none';
}

// Toggle sidebar
function toggleSidebar() {
    const sidebar = document.getElementById('dashboard-sidebar');
    sidebarAberta = !sidebarAberta;
    sidebar.classList.toggle('open', sidebarAberta);
}

// Atualizar estatísticas
function atualizarEstatisticas() {
    console.log('📈 Atualizando estatísticas principais...');
    
    if (!dadosProgresso || !dadosProgresso.municipios) {
        console.warn('⚠️ Dados de progresso não disponíveis');
        return;
    }
    
    const municipios = Object.values(dadosProgresso.municipios);
    
    // Calcular estatísticas dos municípios
    let finalizados = 0;
    let emAndamento = 0;
    let agendados = 0;
    let semVisita = 0;
    
    municipios.forEach(municipio => {
        switch (municipio.status) {
            case 'finalizado':
                finalizados++;
                break;
            case 'em_execucao':
            case 'em_andamento':
                emAndamento++;
                break;
            case 'agendado':
                agendados++;
                break;
            default:
                semVisita++;
        }
    });
    
    // Atualizar elementos com verificação de existência
    const estatisticas = [
        { id: 'stat-finalizados', value: finalizados },
        { id: 'stat-followup', value: emAndamento },
        { id: 'stat-agendados', value: agendados },
        { id: 'stat-sem-visita', value: semVisita }
    ];
    
    estatisticas.forEach(stat => {
        const elemento = document.getElementById(stat.id);
        if (elemento) {
            elemento.textContent = stat.value;
        }
    });
    
    // Calcular médias de progresso dos questionários
    if (municipios.length > 0) {
        const progressoMedio = municipios.reduce((acc, m) => acc + (m.questionarios?.percentual_questionarios || 0), 0) / municipios.length;
        const progressoP1Medio = municipios.reduce((acc, m) => acc + (m.questionarios?.percentual_p1 || 0), 0) / municipios.length;
        const progressoP2Medio = municipios.reduce((acc, m) => acc + (m.questionarios?.percentual_p2 || 0), 0) / municipios.length;
        
        const progressos = [
            { id: 'stat-questionarios', value: `${Math.round(progressoMedio)}%` },
            { id: 'stat-p1', value: `${Math.round(progressoP1Medio)}%` },
            { id: 'stat-p2', value: `${Math.round(progressoP2Medio)}%` }
        ];
        
        progressos.forEach(prog => {
            const elemento = document.getElementById(prog.id);
            if (elemento) {
                elemento.textContent = prog.value;
            }
        });
        
        console.log(`✅ Estatísticas: ${finalizados} finalizados, ${emAndamento} em andamento, Progresso médio: ${Math.round(progressoMedio)}%`);
    }
}

// Atualizar tarefas urgentes
function atualizarTarefas() {
    const container = document.getElementById('tarefas-container');
    if (!dadosProgresso.municipios) {
        container.innerHTML = '<div class="error">Nenhuma tarefa encontrada</div>';
        return;
    }
    
    const tarefas = [];
    
    // Gerar tarefas baseadas nos dados
    Object.entries(dadosProgresso.municipios).forEach(([nome, dados]) => {
        // Follow-up atrasado
        if (dados.timing?.precisa_followup) {
            tarefas.push({
                tipo: 'urgent',
                titulo: `Follow-up atrasado: ${nome}`,
                detalhes: `${dados.timing.dias_sem_atividade} dias sem atividade`,
                acao: `enviarWhatsApp('${nome}')`
            });
        }
        
        // Questionários pendentes
        if (dados.resumo?.em_followup > 0) {
            tarefas.push({
                tipo: 'warning',
                titulo: `Questionários pendentes: ${nome}`,
                detalhes: `${dados.resumo.em_followup} questionário(s) em follow-up`,
                acao: `verRelatorio('${nome}')`
            });
        }
        
        // Municípios sem visita
        if (dados.status === 'sem_visita') {
            tarefas.push({
                tipo: 'urgent',
                titulo: `Sem visitas: ${nome}`,
                detalhes: 'Nenhuma visita agendada',
                acao: `agendarVisita('${nome}')`
            });
        }
        
        // Questionários pendentes - MRS/MAP
        if (dados.questionarios?.entidades_pendentes > 0) {
            tarefas.push({
                tipo: 'warning',
                titulo: `Questionários pendentes: ${nome}`,
                detalhes: `${dados.questionarios.entidades_pendentes} entidade(s) com questionários pendentes`,
                acao: `acompanharEntidades('${nome}')`
            });
        }
        
        // MRS atrasado
        if ((dados.questionarios?.percentual_mrs || 0) < 50 && dados.resumo?.executadas > 0) {
            const percentualMrs = dados.questionarios?.percentual_mrs || 0;
            tarefas.push({
                tipo: 'warning',
                titulo: `MRS atrasado: ${nome}`,
                detalhes: `Apenas ${percentualMrs}% dos questionários MRS concluídos`,
                acao: `gerenciarQuestionarios('${nome}')`
            });
        }
        
        // MAP atrasado
        if ((dados.questionarios?.percentual_map || 0) < 50 && dados.resumo?.executadas > 0) {
            const percentualMap = dados.questionarios?.percentual_map || 0;
            tarefas.push({
                tipo: 'warning',
                titulo: `MAP atrasado: ${nome}`,
                detalhes: `Apenas ${percentualMap}% dos questionários MAP concluídos`,
                acao: `gerenciarQuestionarios('${nome}')`
            });
        }
    });
    
    // Limitar a 5 tarefas mais urgentes
    const tarefasLimitadas = tarefas.slice(0, 5);
    
    if (tarefasLimitadas.length === 0) {
        container.innerHTML = '<div class="success">🎉 Todas as tarefas em dia!</div>';
        return;
    }
    
    container.innerHTML = tarefasLimitadas.map(tarefa => `
        <div class="task-card ${tarefa.tipo}">
            <div class="task-title">${tarefa.titulo}</div>
            <div class="task-details">${tarefa.detalhes}</div>
            <div class="task-actions">
                <button class="btn-task btn-primary" onclick="${tarefa.acao}">
                    Ação
                </button>
            </div>
        </div>
    `).join('');
}

// Aplicar filtros
function aplicarFiltros() {
    const statusFiltro = document.getElementById('filtro-status').value;
    const questionariosFiltro = document.getElementById('filtro-questionarios').value;
    const prioridadesFiltro = document.getElementById('filtro-prioridades').value;
    
    filtroAtivo = { 
        status: statusFiltro, 
        questionarios: questionariosFiltro,
        prioridades: prioridadesFiltro 
    };
    
    // Recriar marcadores com filtros aplicados
    adicionarMarcadores();
    
    // Aplicar filtros específicos se necessário
    if (questionariosFiltro) {
        aplicarFiltrosQuestionarios();
    }
    
    if (prioridadesFiltro) {
        aplicarFiltrosPrioridades();
    }
    
    showToast('Filtros aplicados', 'info');
}

// Filtrar por status específico
function filtrarPorStatus(status) {
    document.getElementById('filtro-status').value = status;
    aplicarFiltros();
}

// Funções de ação
function agendarVisita(municipio) {
    showToast(`Redirecionando para agendamento em ${municipio}...`, 'info');
    // Passar o município e a data selecionada (se houver)
    let url = `/visitas?municipio=${encodeURIComponent(municipio)}`;
    if (diaSelecionado) {
        const dataFormatada = diaSelecionado.toISOString().split('T')[0];
        url += `&data=${dataFormatada}`;
    }
    window.location.href = url;
}

function enviarWhatsApp(municipio) {
    showToast(`Preparando WhatsApp para ${municipio}...`, 'info');
    // Implementar integração WhatsApp
}

function verRelatorio(municipio) {
    showToast(`Abrindo relatório de ${municipio}...`, 'info');
    window.open(`/relatorios?municipio=${encodeURIComponent(municipio)}`, '_blank');
}

function exportarRelatorio() {
    showToast('Preparando exportação...', 'info');
    // Implementar exportação
}

// Gerenciar questionários do município
function gerenciarQuestionarios(municipio) {
    showToast(`Abrindo gestão de questionários para ${municipio}...`, 'info');
    window.open(`/questionarios-obrigatorios?municipio=${encodeURIComponent(municipio)}`, '_blank');
}

// Acompanhar entidades pendentes
function acompanharEntidades(municipio) {
    showToast(`Visualizando entidades pendentes em ${municipio}...`, 'info');
    window.open(`/questionarios-obrigatorios?municipio=${encodeURIComponent(municipio)}&tab=entidades`, '_blank');
}

// Toggle modo de visualização
function toggleVisualizacao() {
    modoQuestionarios = !modoQuestionarios;
    const btn = document.getElementById('btn-toggle-view');
    
    if (modoQuestionarios) {
        btn.innerHTML = '<i class="fas fa-map-marker-alt"></i> Modo Visitas';
        btn.className = 'btn-task btn-success';
        showToast('Modo Questionários ativado', 'info');
    } else {
        btn.innerHTML = '<i class="fas fa-layer-group"></i> Modo Questionários';
        btn.className = 'btn-task btn-warning';
        showToast('Modo Visitas ativado', 'info');
    }
    
    // Recriar marcadores com nova visualização
    adicionarMarcadores();
}

// Mostrar dados específicos de questionários
function mostrarQuestionarios() {
    if (!modoQuestionarios) {
        toggleVisualizacao();
    }
    showToast('Visualizando progresso de questionários MRS/MAP', 'info');
}

// Aplicar filtros específicos de questionários
function aplicarFiltrosQuestionarios() {
    const filtroQuestionarios = document.getElementById('filtro-questionarios').value;
    
    if (!filtroQuestionarios) return;
    
    // Esconder/mostrar marcadores baseado no filtro
    Object.entries(marcadores).forEach(([nome, marker]) => {
        const dados = dadosProgresso.municipios[nome];
        let mostrar = true;
        
        switch (filtroQuestionarios) {
            case 'mrs_pendente':
                mostrar = (dados.questionarios?.percentual_mrs || 0) < 100;
                break;
            case 'map_pendente':
                mostrar = (dados.questionarios?.percentual_map || 0) < 100;
                break;
            case 'ambos_completos':
                mostrar = (dados.questionarios?.percentual_mrs || 0) >= 100 && 
                         (dados.questionarios?.percentual_map || 0) >= 100;
                break;
            case 'p1_pendente':
                mostrar = (dados.questionarios?.percentual_p1 || 0) < 100 && 
                         (dados.questionarios?.prioridades?.p1?.total_entidades || 0) > 0;
                break;
            case 'p2_pendente':
                mostrar = (dados.questionarios?.percentual_p2 || 0) < 100 && 
                         (dados.questionarios?.prioridades?.p2?.total_entidades || 0) > 0;
                break;
        }
        
        if (mostrar) {
            marker.addTo(mapa);
        } else {
            mapa.removeLayer(marker);
        }
    });
    
    showToast(`Filtro aplicado: ${filtroQuestionarios}`, 'info');
}

// Aplicar filtros específicos de prioridades
function aplicarFiltrosPrioridades() {
    const filtroPrioridades = document.getElementById('filtro-prioridades').value;
    
    if (!filtroPrioridades) return;
    
    // Esconder/mostrar marcadores baseado no filtro de prioridades
    Object.entries(marcadores).forEach(([nome, marker]) => {
        const dados = dadosProgresso.municipios[nome];
        let mostrar = true;
        
        switch (filtroPrioridades) {
            case 'p1':
                mostrar = (dados.questionarios?.prioridades?.p1?.total_entidades || 0) > 0;
                break;
            case 'p2':
                mostrar = (dados.questionarios?.prioridades?.p2?.total_entidades || 0) > 0;
                break;
            case 'p3':
                mostrar = (dados.questionarios?.prioridades?.p3?.total_entidades || 0) > 0;
                break;
            case 'p1_p2':
                mostrar = (dados.questionarios?.prioridades?.p1?.total_entidades || 0) > 0 || 
                         (dados.questionarios?.prioridades?.p2?.total_entidades || 0) > 0;
                break;
        }
        
        if (mostrar) {
            marker.addTo(mapa);
        } else {
            mapa.removeLayer(marker);
        }
    });
    
    showToast(`Filtro de prioridades aplicado: ${filtroPrioridades}`, 'info');
}

// Toggle modo de prioridades
function toggleModoPrioridades() {
    modoPrioridades = !modoPrioridades;
    const btn = document.getElementById('btn-toggle-priorities');
    
    if (modoPrioridades) {
        btn.innerHTML = '<i class="fas fa-map-marker-alt"></i> Modo Normal';
        btn.className = 'btn-task btn-warning';
        showToast('Modo Prioridades P1/P2/P3 ativado', 'info');
        
        // Desativar modo questionários se estiver ativo
        if (modoQuestionarios) {
            modoQuestionarios = false;
            document.getElementById('btn-toggle-view').innerHTML = '<i class="fas fa-layer-group"></i> Modo Questionários';
            document.getElementById('btn-toggle-view').className = 'btn-task btn-warning';
        }
    } else {
        btn.innerHTML = '<i class="fas fa-sort-amount-up"></i> Modo Prioridades';
        btn.className = 'btn-task btn-success';
        showToast('Modo Normal ativado', 'info');
    }
    
    // Recriar marcadores com nova visualização
    adicionarMarcadores();
}

// Mostrar prioridades específicas
function mostrarPrioridades(prioridade) {
    if (!modoPrioridades) {
        toggleModoPrioridades();
    }
    
    // Aplicar filtro de prioridade
    document.getElementById('filtro-prioridades').value = prioridade;
    aplicarFiltros();
    
    const prioridadeNomes = {
        'p1': 'P1 - Crítica (Prefeituras + Lista UF)',
        'p2': 'P2 - Importante (Identificadas em campo)',
        'p3': 'P3 - Opcional (Recursos disponíveis)'
    };
    
    showToast(`Visualizando ${prioridadeNomes[prioridade]}`, 'info');
}

// Função auxiliar para textos de status
function getStatusText(status) {
    const textos = {
        'finalizado': 'Finalizado',
        'em_followup': 'Em Follow-up',
        'executado': 'Executado',
        'agendado': 'Agendado',
        'sem_visita': 'Sem Visita'
    };
    return textos[status] || status;
}

// Função auxiliar para textos de status de prioridade
function getStatusPrioridadeText(status) {
    const textos = {
        'nao_iniciado': 'Não Iniciado',
        'em_andamento': 'Em Andamento',
        'concluido': 'Concluído'
    };
    return textos[status] || status;
}

// Click fora do modal para fechar
document.getElementById('modal-municipio').addEventListener('click', function(e) {
    if (e.target === this) {
        fecharModal();
    }
});

// Inicialização principal
document.addEventListener('DOMContentLoaded', async function() {
    console.log('🚀 Iniciando Mapa de Progresso PNSB 2024 com Dashboard de Produtividade...');
    
    try {
        // Verificar saúde do sistema
        verificarSaudeDoSistema();
        
        // Inicializar componentes com tratamento de erro individual
        await inicializarComponentesSafe();
        
        // Carregar dados primeiro
        await carregarDadosProgresso();
        
        // Carregar alertas críticos (se função existir)
        if (typeof atualizarAlertas === 'function') {
            await atualizarAlertas();
        }
        
        // Aguardar um pouco para o DOM estar pronto
        setTimeout(() => {
            if (typeof L !== 'undefined') {
                inicializarMapa();
            } else {
                console.error('❌ Leaflet não carregado');
                showToast('Aviso: Mapa não disponível (biblioteca não carregada)', 'warning');
            }
        }, 100);
        
        // Atualizar contador regressivo imediatamente
        atualizarContadorRegressivo();
        
        console.log('✅ Sistema PNSB 2024 inicializado com sucesso');
        showToast('Sistema PNSB 2024 carregado com sucesso!', 'success');
        
    } catch (error) {
        console.error('❌ Erro na inicialização:', error);
        showToast('Erro na inicialização: ' + error.message, 'error');
    }
});

// Verificar saúde básica do sistema
function verificarSaudeDoSistema() {
    console.log('🔍 Verificando saúde do sistema...');
    
    const elementosEssenciais = [
        'mapa-progresso',
        'countdown-visits-days',
        'countdown-questionnaires-days'
    ];
    
    let elementosEncontrados = 0;
    elementosEssenciais.forEach(id => {
        const elemento = document.getElementById(id);
        if (elemento) {
            elementosEncontrados++;
            console.log(`✅ Elemento ${id} encontrado`);
        } else {
            console.warn(`⚠️ Elemento ${id} não encontrado`);
        }
    });
    
    console.log(`📊 Saúde do sistema: ${elementosEncontrados}/${elementosEssenciais.length} elementos essenciais encontrados`);
    
    return elementosEncontrados / elementosEssenciais.length;
}

// Inicializar componentes com tratamento de erro seguro
async function inicializarComponentesSafe() {
    const componentes = [
        { nome: 'Dashboard de Produtividade', funcao: inicializarDashboardProdutividade },
        { nome: 'Controles do Heatmap', funcao: inicializarHeatmap },
        { nome: 'Calendário Visual', funcao: inicializarCalendario },
        { nome: 'Relatórios Executivos', funcao: inicializarRelatorios },
        { nome: 'Assistente de Estratégia', funcao: inicializarAssistente }
    ];
    
    for (const componente of componentes) {
        try {
            if (typeof componente.funcao === 'function') {
                componente.funcao();
                console.log(`✅ ${componente.nome} inicializado`);
            } else {
                console.warn(`⚠️ Função ${componente.nome} não encontrada`);
            }
        } catch (error) {
            console.warn(`⚠️ Erro ao inicializar ${componente.nome}:`, error);
        }
    }
}

// =============================================================================
// CENTRAL DE PLANEJAMENTO COM CALENDÁRIO VISUAL
// =============================================================================

let calendarioAtual = new Date();
let diaSelecionado = null;
let visitasCalendario = {};
let calendarioView = 'mensal'; // 'mensal' ou 'semanal'

// Inicializar calendário
function inicializarCalendario() {
    console.log('📅 Inicializando calendário visual...');
    
    // Definir data atual (iniciar no contexto da pesquisa PNSB 2025)
    calendarioAtual = new Date();
    // Se estivermos antes do início da pesquisa, mostrar junho de 2025
    if (calendarioAtual < new Date('2025-06-09')) {
        calendarioAtual = new Date('2025-06-09');
    }
    diaSelecionado = new Date(calendarioAtual);
    
    // Carregar dados de visitas
    carregarVisitasCalendario();
    
    // Renderizar calendário
    renderizarCalendario();
    
    // Atualizar agenda
    atualizarAgenda();
    
    console.log('✅ Calendário inicializado!');
}

// Carregar visitas do calendário
function carregarVisitasCalendario() {
    // Simular dados de visitas (integrar com API real)
    visitasCalendario = {
        '2025-07-15': [
            {id: 1, municipio: 'Itajaí', hora: '09:00', prioridade: 'p1', status: 'agendado'},
            {id: 2, municipio: 'Balneário Camboriú', hora: '14:00', prioridade: 'p2', status: 'agendado'}
        ],
        '2025-08-20': [
            {id: 3, municipio: 'Navegantes', hora: '10:00', prioridade: 'p1', status: 'agendado'}
        ],
        '2025-09-10': [
            {id: 4, municipio: 'Bombinhas', hora: '08:30', prioridade: 'p3', status: 'agendado'},
            {id: 5, municipio: 'Penha', hora: '15:00', prioridade: 'p2', status: 'agendado'}
        ]
    };
}

// Renderizar calendário
function renderizarCalendario() {
    const container = document.getElementById('calendar-days');
    const monthElement = document.getElementById('calendar-month');
    const yearElement = document.getElementById('calendar-year');
    
    if (!container || !monthElement || !yearElement) return;
    
    // Atualizar título do mês
    const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                   'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
    monthElement.textContent = meses[calendarioAtual.getMonth()];
    yearElement.textContent = calendarioAtual.getFullYear();
    
    // Calcular dias do mês
    const primeiroDia = new Date(calendarioAtual.getFullYear(), calendarioAtual.getMonth(), 1);
    const ultimoDia = new Date(calendarioAtual.getFullYear(), calendarioAtual.getMonth() + 1, 0);
    const diasMesAnterior = primeiroDia.getDay();
    
    // Limpar container
    container.innerHTML = '';
    
    // Adicionar dias do mês anterior
    for (let i = diasMesAnterior - 1; i >= 0; i--) {
        const diaAnterior = new Date(primeiroDia);
        diaAnterior.setDate(diaAnterior.getDate() - i - 1);
        const dayElement = criarElementoDia(diaAnterior, true);
        container.appendChild(dayElement);
    }
    
    // Adicionar dias do mês atual
    for (let dia = 1; dia <= ultimoDia.getDate(); dia++) {
        const dataAtual = new Date(calendarioAtual.getFullYear(), calendarioAtual.getMonth(), dia);
        const dayElement = criarElementoDia(dataAtual, false);
        container.appendChild(dayElement);
    }
    
    // Completar com dias do próximo mês
    const totalCelulas = container.children.length;
    const celulasFaltantes = 42 - totalCelulas; // 6 semanas x 7 dias
    
    for (let i = 1; i <= celulasFaltantes; i++) {
        const proximoDia = new Date(ultimoDia);
        proximoDia.setDate(ultimoDia.getDate() + i);
        const dayElement = criarElementoDia(proximoDia, true);
        container.appendChild(dayElement);
    }
}

// Criar elemento do dia
function criarElementoDia(data, outroMes) {
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day';
    
    if (outroMes) {
        dayElement.className += ' other-month';
    }
    
    // Verificar se é hoje
    const hoje = new Date();
    if (data.toDateString() === hoje.toDateString()) {
        dayElement.className += ' today';
    }
    
    // Verificar se está selecionado
    if (diaSelecionado && data.toDateString() === diaSelecionado.toDateString()) {
        dayElement.className += ' selected';
    }
    
    // Verificar se tem visitas
    const dataKey = data.toISOString().split('T')[0];
    const visitasDia = visitasCalendario[dataKey] || [];
    if (visitasDia.length > 0) {
        dayElement.className += ' has-visits';
    }
    
    // Número do dia
    const dayNumber = document.createElement('div');
    dayNumber.className = 'day-number';
    dayNumber.textContent = data.getDate();
    dayElement.appendChild(dayNumber);
    
    // Visitas do dia
    if (visitasDia.length > 0) {
        const visitsContainer = document.createElement('div');
        visitsContainer.className = 'day-visits';
        
        visitasDia.forEach(visita => {
            const visitDot = document.createElement('div');
            visitDot.className = `visit-dot ${visita.prioridade}`;
            visitDot.title = `${visita.municipio} - ${visita.hora}`;
            visitsContainer.appendChild(visitDot);
        });
        
        dayElement.appendChild(visitsContainer);
    }
    
    // Event listener para seleção
    dayElement.addEventListener('click', () => {
        // Remover seleção anterior
        document.querySelectorAll('.calendar-day.selected').forEach(el => {
            el.classList.remove('selected');
        });
        
        // Adicionar seleção atual
        dayElement.classList.add('selected');
        diaSelecionado = new Date(data);
        
        // Atualizar agenda
        atualizarAgenda();
    });
    
    return dayElement;
}

// Navegar entre meses
function navegarCalendario(direcao) {
    calendarioAtual.setMonth(calendarioAtual.getMonth() + direcao);
    renderizarCalendario();
}

// Atualizar agenda do dia
function atualizarAgenda() {
    const agendaContent = document.getElementById('agenda-content');
    const agendaDate = document.getElementById('agenda-date');
    
    if (!diaSelecionado || !agendaContent || !agendaDate) return;
    
    // Atualizar data da agenda
    const dataFormatada = diaSelecionado.toLocaleDateString('pt-BR', {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
    });
    agendaDate.textContent = dataFormatada;
    
    // Buscar visitas do dia
    const dataKey = diaSelecionado.toISOString().split('T')[0];
    const visitasDia = visitasCalendario[dataKey] || [];
    
    // Limpar agenda
    agendaContent.innerHTML = '';
    
    if (visitasDia.length === 0) {
        const emptyItem = document.createElement('div');
        emptyItem.className = 'agenda-item empty';
        emptyItem.innerHTML = `
            <div class="agenda-time">--:--</div>
            <div class="agenda-details">
                <div class="agenda-title">Nenhuma visita agendada</div>
                <div class="agenda-subtitle">Clique para agendar uma visita</div>
            </div>
        `;
        agendaContent.appendChild(emptyItem);
    } else {
        visitasDia.forEach(visita => {
            const agendaItem = document.createElement('div');
            agendaItem.className = `agenda-item ${visita.prioridade}`;
            agendaItem.innerHTML = `
                <div class="agenda-time">${visita.hora}</div>
                <div class="agenda-details">
                    <div class="agenda-title">${visita.municipio}</div>
                    <div class="agenda-subtitle">${getPrioridadeText(visita.prioridade)} - ${getStatusText(visita.status)}</div>
                </div>
            `;
            agendaContent.appendChild(agendaItem);
        });
    }
}

// Obter texto da prioridade
function getPrioridadeText(prioridade) {
    const prioridades = {
        'p1': 'P1 - Crítica',
        'p2': 'P2 - Importante', 
        'p3': 'P3 - Opcional'
    };
    return prioridades[prioridade] || prioridade;
}

// Toggle visualização do calendário
function toggleCalendarioView() {
    calendarioView = calendarioView === 'mensal' ? 'semanal' : 'mensal';
    
    const btn = document.getElementById('btn-calendario-view');
    if (btn) {
        if (calendarioView === 'mensal') {
            btn.innerHTML = '<i class="fas fa-calendar-alt"></i> Mensal';
        } else {
            btn.innerHTML = '<i class="fas fa-calendar-week"></i> Semanal';
        }
    }
    
    // Recarregar calendário
    renderizarCalendario();
    
    showToast(`Visualização alterada para ${calendarioView}`, 'info');
}

// Carregar visitas reais do banco de dados para o calendário
async function carregarVisitasReaisCalendario() {
    try {
        console.log('📅 Carregando visitas reais para o calendário...');
        
        const response = await fetch('/api/visitas');
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        const resultado = await response.json();
        
        // Limpar calendário atual
        visitasCalendario = {};
        
        // A API /api/visitas retorna formato {data: [...], pagination: {...}}
        const visitas = resultado.data || [];
        
        // Processar visitas reais
        visitas.forEach(visita => {
            // Função para converter data brasileira (DD/MM/AAAA) para formato ISO
            function parseDateBR(dataBR) {
                if (!dataBR) return null;
                
                // Se já está no formato ISO (AAAA-MM-DD), usar diretamente
                if (dataBR.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    return new Date(dataBR);
                }
                
                // Se está no formato brasileiro (DD/MM/AAAA), converter
                if (dataBR.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                    const [dia, mes, ano] = dataBR.split('/');
                    return new Date(ano, mes - 1, dia);
                }
                
                // Tentar outros formatos
                try {
                    return new Date(dataBR);
                } catch (e) {
                    console.warn('Data inválida:', dataBR);
                    return null;
                }
            }
            
            const dataVisita = parseDateBR(visita.data);
            if (!dataVisita || isNaN(dataVisita.getTime())) {
                console.warn('Visita com data inválida ignorada:', visita);
                return;
            }
            
            const dataKey = dataVisita.toISOString().split('T')[0];
            
            if (!visitasCalendario[dataKey]) {
                visitasCalendario[dataKey] = [];
            }
            
            // Determinar prioridade baseada no tipo de informante
            let prioridade = 'p2'; // padrão
            if (visita.tipo_informante === 'prefeitura') {
                prioridade = 'p1';
            } else if (visita.tipo_informante === 'empresa_publica') {
                prioridade = 'p1';
            } else if (visita.tipo_informante === 'empresa_privada') {
                prioridade = 'p2';
            }
            
            visitasCalendario[dataKey].push({
                id: visita.id,
                municipio: visita.municipio,
                hora: visita.hora_inicio,
                prioridade: prioridade,
                status: visita.status,
                local: visita.local, // Campo correto é 'local', não 'informante'
                tipo_pesquisa: visita.tipo_pesquisa,
                real: true // Flag para indicar que é uma visita real do banco
            });
        });
        
        // Atualizar visualização do calendário
        renderizarCalendario();
        atualizarAgenda();
        
        console.log('✅ Visitas reais carregadas no calendário:', Object.keys(visitasCalendario).length + ' dias com visitas');
        
    } catch (error) {
        console.error('❌ Erro ao carregar visitas reais:', error);
        showToast('Erro ao carregar visitas do banco de dados', 'warning');
    }
}

// Nova visita rápida
async function novaVisitaRapida() {
    // Redirecionar para a página de visitas para criar uma nova visita
    showToast('Redirecionando para criar nova visita...', 'info');
    window.location.href = '/visitas';
}

// Otimizar rotas
function otimizarRotas() {
    const dataKey = diaSelecionado ? diaSelecionado.toISOString().split('T')[0] : null;
    const visitasDia = dataKey ? visitasCalendario[dataKey] || [] : [];
    
    if (visitasDia.length < 2) {
        showToast('Adicione pelo menos 2 visitas para otimizar rotas', 'warning');
        return;
    }
    
    // Simular otimização de rotas
    visitasDia.sort((a, b) => {
        // Ordenar por prioridade e depois por proximidade geográfica
        const prioridadeOrder = {'p1': 1, 'p2': 2, 'p3': 3};
        return prioridadeOrder[a.prioridade] - prioridadeOrder[b.prioridade];
    });
    
    // Atualizar agenda
    atualizarAgenda();
    
    showToast('Rotas otimizadas por prioridade', 'success');
}

// Adicionar visita ao dia
function adicionarVisitaDia() {
    novaVisitaRapida();
}

// =============================================================================
// RELATÓRIOS EXECUTIVOS AUTOMATIZADOS
// =============================================================================

let relatoriosAtivos = false;
let ultimaAtualizacaoRelatorios = new Date();

// Inicializar relatórios executivos
function inicializarRelatorios() {
    console.log('📊 Inicializando relatórios executivos...');
    
    // Carregar dados dos relatórios
    carregarDadosRelatorios();
    
    // Atualizar status dos relatórios
    atualizarStatusRelatorios();
    
    // Configurar auto-update
    setInterval(atualizarDadosRelatorios, 2 * 60 * 1000); // A cada 2 minutos
    
    console.log('✅ Relatórios executivos inicializados!');
}

// Carregar dados dos relatórios
function carregarDadosRelatorios() {
    // Simular dados dos relatórios baseados no progresso atual
    if (dadosProgresso && dadosProgresso.municipios) {
        const municipios = Object.values(dadosProgresso.municipios);
        
        // Performance Geral
        let totalQuestionarios = 0;
        let questionariosConcluidos = 0;
        let municipiosFinalizados = 0;
        let alertasCriticos = 0;
        
        municipios.forEach(municipio => {
            if (municipio.questionarios) {
                totalQuestionarios += (municipio.questionarios.total_mrs_obrigatorios || 0) + (municipio.questionarios.total_map_obrigatorios || 0);
                questionariosConcluidos += (municipio.questionarios.mrs_concluidos || 0) + (municipio.questionarios.map_concluidos || 0);
            }
            
            if (municipio.status === 'finalizado') {
                municipiosFinalizados++;
            }
            
            // Simular alertas críticos
            if (municipio.questionarios && municipio.questionarios.percentual_questionarios < 50) {
                alertasCriticos++;
            }
        });
        
        const progressoGeral = totalQuestionarios > 0 ? Math.round((questionariosConcluidos / totalQuestionarios) * 100) : 0;
        
        // Atualizar métricas dos cards
        document.getElementById('performance-progress').textContent = `${progressoGeral}%`;
        document.getElementById('municipalities-completed').textContent = municipiosFinalizados;
        document.getElementById('alerts-critical-count').textContent = alertasCriticos;
        document.getElementById('questionnaires-completion').textContent = `${progressoGeral}%`;
        
        // Calcular prioridades P1 pendentes
        const p1Pendentes = municipios.filter(m => 
            m.questionarios && m.questionarios.prioridades && 
            m.questionarios.prioridades.p1 && 
            m.questionarios.prioridades.p1.total_entidades > (m.questionarios.prioridades.p1.concluidas || 0)
        ).length;
        
        document.getElementById('priorities-critical').textContent = p1Pendentes;
        
        // Calcular data de conclusão projetada
        const hoje = new Date();
        const dataProjetada = new Date(hoje.getTime() + (30 - progressoGeral) * 24 * 60 * 60 * 1000);
        document.getElementById('projections-completion-date').textContent = 
            dataProjetada.toLocaleDateString('pt-BR', {day: 'numeric', month: 'short'});
    }
}

// Atualizar status dos relatórios
function atualizarStatusRelatorios() {
    const agora = new Date();
    const tempoDecorrido = Math.floor((agora - ultimaAtualizacaoRelatorios) / (1000 * 60)); // em minutos
    
    // Atualizar timestamps
    document.getElementById('performance-last-update').textContent = `${Math.max(1, tempoDecorrido)} min`;
    document.getElementById('priorities-last-update').textContent = `${Math.max(2, tempoDecorrido + 1)} min`;
    document.getElementById('questionnaires-last-update').textContent = `${Math.max(5, tempoDecorrido + 3)} min`;
    document.getElementById('municipalities-last-update').textContent = `${Math.max(1, tempoDecorrido)} min`;
    document.getElementById('alerts-last-update').textContent = 'agora';
    document.getElementById('projections-last-update').textContent = `${Math.max(3, tempoDecorrido + 2)} min`;
}

// Atualizar dados dos relatórios
function atualizarDadosRelatorios() {
    console.log('📊 Atualizando dados dos relatórios...');
    carregarDadosRelatorios();
    atualizarStatusRelatorios();
    ultimaAtualizacaoRelatorios = new Date();
}

// Visualizar relatório específico
function visualizarRelatorio(tipo) {
    const modal = document.getElementById('modal-relatorio');
    const title = document.getElementById('report-modal-title');
    const content = document.getElementById('report-content-area');
    
    // Definir título baseado no tipo
    const titulos = {
        'performance': '📈 Relatório de Performance Geral',
        'priorities': '🎯 Análise de Prioridades P1/P2/P3',
        'questionnaires': '📋 Relatório de Questionários MRS/MAP',
        'municipalities': '🏘️ Status por Município',
        'alerts': '🚨 Alertas e Riscos Críticos',
        'projections': '🔮 Projeções e Tendências'
    };
    
    title.textContent = titulos[tipo] || 'Relatório';
    
    // Gerar conteúdo do relatório
    content.innerHTML = gerarConteudoRelatorio(tipo);
    
    // Mostrar modal
    modal.style.display = 'flex';
    
    showToast(`Relatório ${tipo} carregado`, 'info');
}

// Gerar conteúdo do relatório
function gerarConteudoRelatorio(tipo) {
    const hoje = new Date().toLocaleDateString('pt-BR');
    
    switch (tipo) {
        case 'performance':
            const deadlines = window.PNSB_DEADLINES || { visits: 0, questionnaires: 0 };
            const statusCritico = deadlines.visits <= 30 ? 'CRÍTICO' : 'Em andamento';
            const corStatus = deadlines.visits <= 30 ? '#dc3545' : '#28a745';
            
            return `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #28a745; margin-bottom: 15px;">📊 Resumo Executivo</h3>
                    <p><strong>Data:</strong> ${hoje}</p>
                    <p><strong>Período:</strong> PNSB 2024 - Pesquisa Nacional de Saneamento Básico</p>
                    <div style="background: ${deadlines.visits <= 30 ? 'rgba(220, 53, 69, 0.1)' : 'rgba(40, 167, 69, 0.1)'}; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid ${corStatus};">
                        <h4 style="color: ${corStatus}; margin: 0;">🎯 NOVOS DEADLINES CRÍTICOS</h4>
                        <p style="color: #F1F1F1; margin: 10px 0 0 0;"><strong>Visitas P1+P2:</strong> 19/09/2025 (${deadlines.visits} dias) | <strong>Questionários:</strong> 17/10/2025 (${deadlines.questionnaires} dias)</p>
                    </div>
                </div>
                
                <div style="background: #2D3142; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="color: #F1F1F1; margin-bottom: 15px;">🎯 Indicadores Principais</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="text-align: center; padding: 15px; background: #23263B; border-radius: 6px;">
                            <div style="font-size: 24px; font-weight: bold; color: #28a745;">78%</div>
                            <div style="color: #B8BCC8; font-size: 12px;">Progresso Geral</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #23263B; border-radius: 6px;">
                            <div style="font-size: 24px; font-weight: bold; color: #17a2b8;">3/11</div>
                            <div style="color: #B8BCC8; font-size: 12px;">Municípios Finalizados</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #23263B; border-radius: 6px;">
                            <div style="font-size: 20px; font-weight: bold; color: ${corStatus};">${statusCritico}</div>
                            <div style="color: #B8BCC8; font-size: 12px;">Status do Projeto</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #23263B; border-radius: 6px;">
                            <div style="font-size: 24px; font-weight: bold; color: #ffc107;">${deadlines.visits}d</div>
                            <div style="color: #B8BCC8; font-size: 12px;">Dias p/ Deadline Visitas</div>
                        </div>
                    </div>
                </div>
                
                <div style="background: #2D3142; padding: 20px; border-radius: 8px;">
                    <h4 style="color: #F1F1F1; margin-bottom: 15px;">📈 Análise de Tendências com Novos Prazos</h4>
                    <ul style="color: #F1F1F1; line-height: 1.8;">
                        <li><strong>Velocidade:</strong> 12 questionários/dia ${deadlines.questionnaires <= 60 ? '(ACELERAR para deadline)' : '(acima da meta)'}</li>
                        <li><strong>Qualidade:</strong> 95% de aprovação nos questionários</li>
                        <li><strong>Cobertura P1+P2:</strong> 85% das entidades críticas ${deadlines.visits <= 30 ? '(URGENTE até 19/09)' : '(meta: 19/09/2025)'}</li>
                        <li><strong>Risco:</strong> ${deadlines.visits <= 30 ? 'ALTO - deadline visitas crítico' : 'Médio - monitorar prazos'}</li>
                        <li><strong>Foco:</strong> ${deadlines.visits <= 30 ? 'VISITAS P1+P2 IMEDIATO' : 'Balanceamento visitas/questionários'}</li>
                    </ul>
                </div>
            `;
            
        case 'priorities':
            const deadlinesPriorities = window.PNSB_DEADLINES || { visits: 0, questionnaires: 0 };
            return `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #dc3545; margin-bottom: 15px;">🎯 Análise de Prioridades</h3>
                    <p><strong>Sistema de Priorização PNSB 2024 - DEADLINES ATUALIZADOS</strong></p>
                    <div style="background: rgba(220, 53, 69, 0.1); padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #dc3545;">
                        <h4 style="color: #dc3545; margin: 0;">⚠️ DEADLINE CRÍTICO</h4>
                        <p style="color: #F1F1F1; margin: 10px 0 0 0;">P1 e P2: TODAS as visitas devem estar concluídas até <strong>19/09/2025</strong> (${deadlinesPriorities.visits} dias restantes)</p>
                    </div>
                </div>
                
                <div style="display: grid; gap: 20px;">
                    <div style="background: #2D3142; padding: 20px; border-radius: 8px; border-left: 6px solid #dc3545;">
                        <h4 style="color: #dc3545; margin-bottom: 15px;">🔴 P1 - Crítica ${deadlinesPriorities.visits <= 30 ? '(URGENTE!)' : ''}</h4>
                        <p style="color: #F1F1F1;"><strong>Descrição:</strong> Prefeituras + Lista UF</p>
                        <div style="margin-top: 15px;">
                            <div style="background: #23263B; padding: 15px; border-radius: 6px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span style="color: #F1F1F1;">Progresso:</span>
                                    <span style="color: #dc3545; font-weight: bold;">85%</span>
                                </div>
                                <div style="background: #343751; height: 8px; border-radius: 4px;">
                                    <div style="background: #dc3545; height: 100%; width: 85%; border-radius: 4px;"></div>
                                </div>
                            </div>
                        </div>
                        <ul style="color: #F1F1F1; margin-top: 15px;">
                            <li>Total de entidades: 45</li>
                            <li>Concluídas: 38</li>
                            <li>Pendentes: 7</li>
                            <li style="color: ${deadlinesPriorities.visits <= 30 ? '#dc3545' : '#ffc107'}; font-weight: bold;">Meta: 100% até 19/09/2025 (VISITAS)</li>
                        </ul>
                    </div>
                    
                    <div style="background: #2D3142; padding: 20px; border-radius: 8px; border-left: 6px solid #ffc107;">
                        <h4 style="color: #ffc107; margin-bottom: 15px;">🟡 P2 - Importante ${deadlinesPriorities.visits <= 30 ? '(URGENTE!)' : ''}</h4>
                        <p style="color: #F1F1F1;"><strong>Descrição:</strong> Identificadas em Campo</p>
                        <div style="margin-top: 15px;">
                            <div style="background: #23263B; padding: 15px; border-radius: 6px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span style="color: #F1F1F1;">Progresso:</span>
                                    <span style="color: #ffc107; font-weight: bold;">72%</span>
                                </div>
                                <div style="background: #343751; height: 8px; border-radius: 4px;">
                                    <div style="background: #ffc107; height: 100%; width: 72%; border-radius: 4px;"></div>
                                </div>
                            </div>
                        </div>
                        <ul style="color: #F1F1F1; margin-top: 15px;">
                            <li>Total de entidades: 28</li>
                            <li>Concluídas: 20</li>
                            <li>Pendentes: 8</li>
                            <li style="color: ${deadlinesPriorities.visits <= 30 ? '#dc3545' : '#ffc107'}; font-weight: bold;">Meta: 100% até 19/09/2025 (VISITAS)</li>
                        </ul>
                    </div>
                    
                    <div style="background: #2D3142; padding: 20px; border-radius: 8px; border-left: 6px solid #28a745;">
                        <h4 style="color: #28a745; margin-bottom: 15px;">🟢 P3 - Opcional</h4>
                        <p style="color: #F1F1F1;"><strong>Descrição:</strong> Recursos Disponíveis</p>
                        <div style="margin-top: 15px;">
                            <div style="background: #23263B; padding: 15px; border-radius: 6px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span style="color: #F1F1F1;">Progresso:</span>
                                    <span style="color: #28a745; font-weight: bold;">45%</span>
                                </div>
                                <div style="background: #343751; height: 8px; border-radius: 4px;">
                                    <div style="background: #28a745; height: 100%; width: 45%; border-radius: 4px;"></div>
                                </div>
                            </div>
                        </div>
                        <ul style="color: #F1F1F1; margin-top: 15px;">
                            <li>Total de entidades: 15</li>
                            <li>Concluídas: 7</li>
                            <li>Pendentes: 8</li>
                            <li>Meta: Questionários até 17/10/2025 conforme disponibilidade</li>
                        </ul>
                    </div>
                </div>
                
                <div style="background: rgba(255, 193, 7, 0.1); padding: 20px; border-radius: 8px; margin-top: 20px; border: 1px solid #ffc107;">
                    <h4 style="color: #ffc107; margin-bottom: 15px;">📋 ESTRATÉGIA NOVA COM DEADLINES</h4>
                    <ol style="color: #F1F1F1; line-height: 1.8;">
                        <li><strong>FOCO IMEDIATO:</strong> Concluir TODAS as visitas P1 e P2 até 19/09/2025</li>
                        <li><strong>SEGUNDA FASE:</strong> Preenchimento de questionários até 17/10/2025</li>
                        <li><strong>P3:</strong> Questionários conforme recursos disponíveis (deadline 17/10)</li>
                        <li><strong>MONITORAMENTO:</strong> Acompanhamento diário dos prazos críticos</li>
                    </ol>
                </div>
            `;
            
        case 'alerts':
            // Usar alertas reais do sistema baseados nos dados da API
            if (!dadosProgresso || !dadosProgresso.municipios) {
                return `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #dc3545; margin-bottom: 15px;">🚨 Alertas do Sistema</h3>
                        <p style="color: #B8BCC8;">Carregando alertas reais do sistema...</p>
                    </div>
                `;
            }
            
            let alertasReais = [];
            Object.values(dadosProgresso.municipios).forEach(municipio => {
                if (municipio.alertas && municipio.alertas.length > 0) {
                    municipio.alertas.forEach(alerta => {
                        alertasReais.push({
                            municipio: municipio.municipio,
                            alerta: alerta,
                            detalhes: municipio.alertas_detalhes
                        });
                    });
                }
            });
            
            if (alertasReais.length === 0) {
                return `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #28a745; margin-bottom: 15px;">✅ Sistema Operacional</h3>
                        <p style="color: #F1F1F1;">Nenhum alerta crítico no momento.</p>
                        <p style="color: #B8BCC8;">Todos os municípios estão dentro dos parâmetros normais de operação.</p>
                    </div>
                `;
            }
            
            let alertasHtml = alertasReais.map(item => `
                <div style="background: rgba(255, 193, 7, 0.1); border: 1px solid #ffc107; padding: 15px; border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="color: #ffc107; font-size: 18px;">⚠️</span>
                        <strong style="color: #ffc107;">ALERTA</strong>
                    </div>
                    <p style="color: #F1F1F1;"><strong>Município:</strong> ${item.municipio}</p>
                    <p style="color: #F1F1F1;"><strong>Situação:</strong> ${item.alerta}</p>
                </div>
            `).join('');
            
            return `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #dc3545; margin-bottom: 15px;">🚨 Alertas do Sistema</h3>
                    <p><strong>Situações identificadas pelo sistema de monitoramento</strong></p>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    ${alertasHtml}
                </div>
            `;
            
        default:
            return `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">📊</div>
                    <h3 style="color: #F1F1F1;">Relatório em Desenvolvimento</h3>
                    <p style="color: #B8BCC8;">Este relatório será disponibilizado em breve.</p>
                </div>
            `;
    }
}

// Fechar modal de relatório
function fecharModalRelatorio() {
    document.getElementById('modal-relatorio').style.display = 'none';
}

// Gerar relatório instantâneo
function gerarRelatorioInstantaneo() {
    showToast('Gerando relatório instantâneo...', 'info');
    
    setTimeout(() => {
        const blob = new Blob([gerarRelatorioTexto()], {type: 'text/plain'});
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `relatorio_pnsb_${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        showToast('Relatório instantâneo gerado e baixado!', 'success');
    }, 1500);
}

// Gerar texto do relatório
function gerarRelatorioTexto() {
    const hoje = new Date().toLocaleDateString('pt-BR');
    const deadlines = window.PNSB_DEADLINES || { visits: 0, questionnaires: 0 };
    
    return `
RELATÓRIO EXECUTIVO PNSB 2024
Data: ${hoje}
========================================

🎯 DEADLINES CRÍTICOS
- Deadline Visitas P1+P2: 19/09/2025 (${deadlines.visits} dias restantes)
- Deadline Questionários: 17/10/2025 (${deadlines.questionnaires} dias restantes)

RESUMO EXECUTIVO
- Progresso Geral: 78%
- Municípios Finalizados: 3 de 11
- Status: ${deadlines.visits <= 30 ? 'CRÍTICO - Acelerar visitas' : 'Em andamento'}

PRIORIDADES COM NOVA URGÊNCIA
- P1 (Crítica): 85% concluído - FOCO: Visitas até 19/09
- P2 (Importante): 72% concluído - FOCO: Visitas até 19/09
- P3 (Opcional): 45% concluído - FOCO: Questionários até 17/10

ALERTAS CRÍTICOS
${deadlines.visits <= 30 ? '🚨 DEADLINE VISITAS EM RISCO - Menos de 30 dias!' : ''}
${deadlines.questionnaires <= 60 ? '⚠️ DEADLINE QUESTIONÁRIOS - Acelerar preenchimento' : ''}
- Balneário Piçarras: 15 dias sem contato
- Luiz Alves: Qualidade dos questionários baixa
- 3 municípios com velocidade abaixo da meta

RECOMENDAÇÕES URGENTES
${deadlines.visits <= 30 ? '1. PRIORIDADE MÁXIMA: Concluir TODAS as visitas P1+P2 até 19/09/2025' : '1. Intensificar agenda de visitas P1+P2'}
2. Acelerar preenchimento de questionários para deadline 17/10/2025
3. Realocação de recursos para deadlines críticos
4. Monitoramento diário intensificado com foco em prazos

========================================
Relatório gerado automaticamente pelo Sistema PNSB 2024
NOVA CONFIGURAÇÃO DE DEADLINES: Visitas 19/09/25 | Questionários 17/10/25
    `;
}

// Agendar relatório
function agendarRelatorio() {
    const horario = prompt('Digite o horário para envio (HH:MM):');
    if (horario) {
        const tipo = prompt('Tipo de relatório (diario/semanal/mensal):') || 'diario';
        showToast(`Relatório ${tipo} agendado para ${horario}`, 'success');
    }
}

// Exportar todos os relatórios
function exportarRelatorios() {
    showToast('Preparando exportação de todos os relatórios...', 'info');
    
    setTimeout(() => {
        const zip = gerarZipRelatorios();
        showToast('Todos os relatórios exportados!', 'success');
    }, 2000);
}

// Toggle automação de relatórios
function toggleAutoReports() {
    relatoriosAtivos = !relatoriosAtivos;
    const btn = document.getElementById('btn-auto-reports');
    
    if (relatoriosAtivos) {
        btn.innerHTML = '<i class="fas fa-stop"></i> Parar';
        btn.classList.add('active');
        showToast('Relatórios automáticos ativados', 'success');
    } else {
        btn.innerHTML = '<i class="fas fa-play"></i> Ativar';
        btn.classList.remove('active');
        showToast('Relatórios automáticos desativados', 'warning');
    }
}

// Gerar ZIP dos relatórios (simulação)
function gerarZipRelatorios() {
    // Simulação de geração de ZIP
    console.log('📦 Gerando ZIP com todos os relatórios...');
    return 'relatorios_pnsb_2024.zip';
}

// =============================================================================
// ASSISTENTE DE ESTRATÉGIA LOCAL
// =============================================================================

let estrategiasDatabase = {};
let configuracaoAssistente = {
    autoAnalysis: true,
    successPrediction: true,
    localInsights: true,
    confidenceThreshold: 80
};

// Inicializar assistente de estratégia
function inicializarAssistente() {
    console.log('🧠 Inicializando assistente de estratégia local...');
    
    // Carregar base de conhecimento
    carregarBaseConhecimento();
    
    // Configurar eventos
    configurarEventosAssistente();
    
    console.log('✅ Assistente de estratégia inicializado!');
}

// Carregar base de conhecimento
function carregarBaseConhecimento() {
    // Base de dados simulada com estratégias por município
    estrategiasDatabase = {
        'itajai': {
            profile: {
                size: 'grande',
                type: 'portuario',
                cooperation: 'alta',
                priority: 'p1',
                challenges: ['burocracia', 'multiplos-setores']
            },
            strategies: {
                contact: {
                    channel: 'oficial',
                    timing: 'manha',
                    approach: 'formal',
                    confidence: 95
                },
                approach: {
                    style: 'institucional',
                    focus: 'beneficios-municipio',
                    tone: 'profissional',
                    confidence: 92
                }
            }
        },
        'balneario-camboriu': {
            profile: {
                size: 'medio',
                type: 'turistico',
                cooperation: 'media',
                priority: 'p1',
                challenges: ['sazonalidade', 'alta-demanda']
            },
            strategies: {
                contact: {
                    channel: 'multiplo',
                    timing: 'tarde',
                    approach: 'flexivel',
                    confidence: 88
                },
                approach: {
                    style: 'adaptativo',
                    focus: 'gestao-turistica',
                    tone: 'colaborativo',
                    confidence: 85
                }
            }
        },
        'bombinhas': {
            profile: {
                size: 'pequeno',
                type: 'turistico',
                cooperation: 'alta',
                priority: 'p3',
                challenges: ['recursos-limitados', 'sazonalidade']
            },
            strategies: {
                contact: {
                    channel: 'direto',
                    timing: 'flexivel',
                    approach: 'pessoal',
                    confidence: 93
                },
                approach: {
                    style: 'consultivo',
                    focus: 'apoio-tecnico',
                    tone: 'amigavel',
                    confidence: 90
                }
            }
        }
    };
}

// Configurar eventos do assistente
function configurarEventosAssistente() {
    // Event listener para o slider de confiança
    const slider = document.getElementById('config-confidence-threshold');
    if (slider) {
        slider.addEventListener('input', function() {
            document.getElementById('confidence-value').textContent = this.value + '%';
            configuracaoAssistente.confidenceThreshold = parseInt(this.value);
        });
    }
}

// Analisar município específico
function analisarMunicipio() {
    const select = document.getElementById('municipality-select');
    const municipio = select.value;
    
    if (!municipio) {
        showToast('Selecione um município para análise', 'warning');
        return;
    }
    
    showToast('🧠 Analisando estratégias para o município...', 'info');
    
    // Simular processamento IA
    setTimeout(() => {
        exibirAnaliseCompleta(municipio);
        showToast('Análise de estratégia concluída!', 'success');
    }, 2000);
}

// Exibir análise completa
function exibirAnaliseCompleta(municipioKey) {
    const panel = document.getElementById('analysis-panel');
    const nomesMunicipios = {
        'itajai': 'Itajaí',
        'balneario-camboriu': 'Balneário Camboriú',
        'navegantes': 'Navegantes',
        'bombinhas': 'Bombinhas',
        'balneario-picarras': 'Balneário Piçarras',
        'camboriu': 'Camboriú',
        'itapema': 'Itapema',
        'penha': 'Penha',
        'porto-belo': 'Porto Belo',
        'luiz-alves': 'Luiz Alves',
        'ilhota': 'Ilhota'
    };
    
    const municipio = nomesMunicipios[municipioKey] || municipioKey;
    const dados = estrategiasDatabase[municipioKey] || gerarEstrategiaGenerica(municipioKey);
    
    // Atualizar informações do município
    document.getElementById('analyzed-municipality').textContent = municipio;
    document.getElementById('municipality-priority').textContent = 
        dados.profile?.priority?.toUpperCase() || 'P2' + ' - ' + getPrioridadeDescricao(dados.profile?.priority || 'p2');
    document.getElementById('municipality-progress').textContent = 
        Math.floor(Math.random() * 40 + 60) + '% concluído';
    document.getElementById('municipality-risk').textContent = 
        getRiscoNivel(dados.profile?.cooperation || 'media');
    
    // Atualizar estratégias
    atualizarEstrategiaContato(dados);
    atualizarEstrategiaAbordagem(dados);
    atualizarEstrategiaTiming(dados);
    atualizarEstrategiaFollowup(dados);
    
    // Atualizar insights
    atualizarInsights(municipio, dados);
    
    // Atualizar histórico de sucesso
    atualizarHistoricoSucesso(dados);
    
    // Mostrar painel
    panel.style.display = 'block';
}

// Atualizar estratégia de contato
function atualizarEstrategiaContato(dados) {
    const confidence = dados.strategies?.contact?.confidence || Math.floor(Math.random() * 20 + 80);
    const channel = dados.strategies?.contact?.channel || 'oficial';
    
    document.getElementById('contact-confidence').textContent = confidence + '%';
    document.getElementById('contact-strategy').innerHTML = `
        <div style="margin-bottom: 15px;">
            <strong style="color: #17a2b8;">Canal Recomendado:</strong> ${getChannelDescription(channel)}
        </div>
        <div style="margin-bottom: 15px;">
            <strong style="color: #17a2b8;">Horário Ideal:</strong> ${getTimingDescription(dados.strategies?.contact?.timing || 'manha')}
        </div>
        <div style="margin-bottom: 15px;">
            <strong style="color: #17a2b8;">Abordagem:</strong> ${getApproachDescription(dados.strategies?.contact?.approach || 'formal')}
        </div>
        <div style="background: #2D3142; padding: 10px; border-radius: 6px; margin-top: 10px;">
            <strong style="color: #F1F1F1;">💡 Dica:</strong> 
            <span style="color: #B8BCC8;">Baseado no perfil do município, esta estratégia tem ${confidence}% de chance de sucesso.</span>
        </div>
    `;
}

// Atualizar estratégia de abordagem
function atualizarEstrategiaAbordagem(dados) {
    const confidence = dados.strategies?.approach?.confidence || Math.floor(Math.random() * 20 + 80);
    const style = dados.strategies?.approach?.style || 'institucional';
    
    document.getElementById('approach-confidence').textContent = confidence + '%';
    document.getElementById('approach-strategy').innerHTML = `
        <div style="margin-bottom: 15px;">
            <strong style="color: #28a745;">Estilo:</strong> ${getStyleDescription(style)}
        </div>
        <div style="margin-bottom: 15px;">
            <strong style="color: #28a745;">Foco Principal:</strong> ${getFocusDescription(dados.strategies?.approach?.focus || 'beneficios-municipio')}
        </div>
        <div style="margin-bottom: 15px;">
            <strong style="color: #28a745;">Tom:</strong> ${getToneDescription(dados.strategies?.approach?.tone || 'profissional')}
        </div>
        <div style="background: #2D3142; padding: 10px; border-radius: 6px; margin-top: 10px;">
            <strong style="color: #F1F1F1;">🎯 Estratégia:</strong> 
            <span style="color: #B8BCC8;">Adapte o discurso às características locais para maximizar a receptividade.</span>
        </div>
    `;
}

// Atualizar estratégia de timing
function atualizarEstrategiaTiming(dados) {
    const confidence = Math.floor(Math.random() * 15 + 85);
    const deadlines = window.PNSB_DEADLINES || { visits: 0, questionnaires: 0 };
    const urgenciaVisitas = deadlines.visits <= 30;
    const urgenciaQuestionarios = deadlines.questionnaires <= 60;
    
    document.getElementById('timing-confidence').textContent = confidence + '%';
    
    let estrategiaUrgencia = '';
    let corUrgencia = '#ffc107';
    
    if (urgenciaVisitas) {
        estrategiaUrgencia = `
            <div style="background: rgba(220, 53, 69, 0.1); padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #dc3545;">
                <strong style="color: #dc3545;">🚨 URGÊNCIA MÁXIMA - DEADLINE VISITAS</strong>
                <div style="margin-top: 10px; color: #F1F1F1;">
                    Apenas <strong>${deadlines.visits} dias</strong> para concluir TODAS as visitas P1+P2 (19/09/2025).<br>
                    <strong>AÇÃO IMEDIATA:</strong> Contato diário, qualquer horário, todos os canais.
                </div>
            </div>
        `;
        corUrgencia = '#dc3545';
    } else if (urgenciaQuestionarios) {
        estrategiaUrgencia = `
            <div style="background: rgba(255, 193, 7, 0.1); padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #ffc107;">
                <strong style="color: #ffc107;">⚠️ ATENÇÃO - DEADLINE QUESTIONÁRIOS</strong>
                <div style="margin-top: 10px; color: #F1F1F1;">
                    ${deadlines.questionnaires} dias para deadline questionários (17/10/2025).<br>
                    <strong>ACELERAR:</strong> Intensificar contatos para preenchimento.
                </div>
            </div>
        `;
    }
    
    document.getElementById('timing-strategy').innerHTML = `
        ${estrategiaUrgencia}
        <div style="margin-bottom: 15px;">
            <strong style="color: ${corUrgencia};">Melhor Período:</strong> ${urgenciaVisitas ? 'IMEDIATO - Qualquer horário disponível' : 'Terça a Quinta-feira, 9h-11h'}
        </div>
        <div style="margin-bottom: 15px;">
            <strong style="color: ${corUrgencia};">Evitar:</strong> ${urgenciaVisitas ? 'Nenhum horário pode ser evitado - URGÊNCIA!' : 'Segunda-feira manhã e Sexta-feira tarde'}
        </div>
        <div style="margin-bottom: 15px;">
            <strong style="color: ${corUrgencia};">Duração Ideal:</strong> ${urgenciaVisitas ? '30+ min (focar em agendamento rápido)' : '45-60 minutos'}
        </div>
        <div style="background: #2D3142; padding: 10px; border-radius: 6px; margin-top: 10px;">
            <strong style="color: #F1F1F1;">⏰ Insight com Deadlines:</strong> 
            <span style="color: #B8BCC8;">${urgenciaVisitas ? 
                'CRÍTICO: Priorizar agendamento imediato. Usar múltiplos canais simultaneamente.' : 
                urgenciaQuestionarios ? 
                'Acelerar processo de contato considerando deadline questionários em ' + deadlines.questionnaires + ' dias.' :
                'Timing otimizado para disponibilidade dos gestores, considerando deadlines do projeto.'
            }</span>
        </div>
    `;
}

// Atualizar estratégia de follow-up
function atualizarEstrategiaFollowup(dados) {
    const confidence = Math.floor(Math.random() * 10 + 88);
    const deadlines = window.PNSB_DEADLINES || { visits: 0, questionnaires: 0 };
    const urgenciaVisitas = deadlines.visits <= 30;
    const urgenciaQuestionarios = deadlines.questionnaires <= 60;
    
    document.getElementById('followup-confidence').textContent = confidence + '%';
    
    let estrategiaUrgencia = '';
    let corUrgencia = '#6f42c1';
    let frequencia = 'Contato semanal nos primeiros 15 dias';
    let escalacao = 'Após 3 tentativas, acionar supervisor';
    
    if (urgenciaVisitas) {
        estrategiaUrgencia = `
            <div style="background: rgba(220, 53, 69, 0.1); padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #dc3545;">
                <strong style="color: #dc3545;">🚨 PROTOCOLO DE URGÊNCIA - ${deadlines.visits} DIAS</strong>
                <div style="margin-top: 10px; color: #F1F1F1;">
                    Deadline crítico: 19/09/2025 para TODAS as visitas P1+P2<br>
                    <strong>FOLLOW-UP INTENSIVO:</strong> Contato a cada 48h até agendamento
                </div>
            </div>
        `;
        corUrgencia = '#dc3545';
        frequencia = 'Contato a cada 48h - MÁXIMA PRIORIDADE';
        escalacao = 'Após 2 tentativas, acionar supervisor IMEDIATAMENTE';
    } else if (urgenciaQuestionarios) {
        estrategiaUrgencia = `
            <div style="background: rgba(255, 193, 7, 0.1); padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #ffc107;">
                <strong style="color: #ffc107;">⚠️ ACELERAÇÃO NECESSÁRIA - ${deadlines.questionnaires} DIAS</strong>
                <div style="margin-top: 10px; color: #F1F1F1;">
                    Deadline questionários: 17/10/2025<br>
                    <strong>INTENSIFICAR:</strong> Follow-up focado em preenchimento
                </div>
            </div>
        `;
        corUrgencia = '#ffc107';
        frequencia = 'Contato a cada 3-4 dias para acelerar questionários';
        escalacao = 'Após 3 tentativas em 7 dias, acionar supervisor';
    }
    
    document.getElementById('followup-strategy').innerHTML = `
        ${estrategiaUrgencia}
        <div style="margin-bottom: 15px;">
            <strong style="color: ${corUrgencia};">Frequência:</strong> ${frequencia}
        </div>
        <div style="margin-bottom: 15px;">
            <strong style="color: ${corUrgencia};">Canais Alternativos:</strong> ${urgenciaVisitas ? 'TODOS - WhatsApp, e-mail, telefone, presencial' : 'WhatsApp, e-mail, telefone'}
        </div>
        <div style="margin-bottom: 15px;">
            <strong style="color: ${corUrgencia};">Escalação:</strong> ${escalacao}
        </div>
        <div style="background: #2D3142; padding: 10px; border-radius: 6px; margin-top: 10px;">
            <strong style="color: #F1F1F1;">🔄 Plano B com Deadlines:</strong> 
            <span style="color: #B8BCC8;">${urgenciaVisitas ? 
                'CRÍTICO: Sem margem para atrasos. Usar todos os recursos disponíveis para contato imediato.' : 
                urgenciaQuestionarios ? 
                'Acelerar processo mantendo qualidade. Priorizar eficiência no follow-up.' :
                'Manter persistência respeitosa com intervalos crescentes entre contatos.'
            }</span>
        </div>
    `;
}

// Atualizar insights personalizados
function atualizarInsights(municipio, dados) {
    const insights = gerarInsightsMunicipio(municipio, dados);
    document.getElementById('insights-content').innerHTML = insights;
}

// Gerar insights específicos do município
function gerarInsightsMunicipio(municipio, dados) {
    const type = dados.profile?.type || 'urbano';
    const size = dados.profile?.size || 'medio';
    const challenges = dados.profile?.challenges || ['recursos-limitados'];
    const deadlines = window.PNSB_DEADLINES || { visits: 0, questionnaires: 0 };
    const urgenciaVisitas = deadlines.visits <= 30;
    const urgenciaQuestionarios = deadlines.questionnaires <= 60;
    
    let insightDeadline = '';
    
    if (urgenciaVisitas) {
        insightDeadline = `
            <div style="background: rgba(220, 53, 69, 0.1); padding: 15px; border-radius: 8px; border: 2px solid #dc3545; margin-bottom: 15px;">
                <strong style="color: #dc3545;">🚨 INSIGHT CRÍTICO - DEADLINE VISITAS</strong>
                <p style="color: #F1F1F1; margin: 10px 0;">
                    <strong>APENAS ${deadlines.visits} DIAS</strong> para concluir visitas em ${municipio}!<br>
                    <strong>AÇÃO URGENTE:</strong> Implementar estratégia imediatamente. Zero tolerância a atrasos.
                    Considerar realocação de recursos se necessário.
                </p>
            </div>
        `;
    } else if (urgenciaQuestionarios) {
        insightDeadline = `
            <div style="background: rgba(255, 193, 7, 0.1); padding: 15px; border-radius: 8px; border: 2px solid #ffc107; margin-bottom: 15px;">
                <strong style="color: #ffc107;">⚠️ INSIGHT IMPORTANTE - DEADLINE QUESTIONÁRIOS</strong>
                <p style="color: #F1F1F1; margin: 10px 0;">
                    ${deadlines.questionnaires} dias para deadline questionários em ${municipio}.<br>
                    <strong>ACELERAR:</strong> Priorizar preenchimento após conclusão das visitas.
                </p>
            </div>
        `;
    }
    
    return `
        <div style="display: grid; gap: 15px;">
            ${insightDeadline}
            
            <div style="background: #23263B; padding: 15px; border-radius: 8px; border-left: 4px solid #17a2b8;">
                <strong style="color: #17a2b8;">📊 Perfil Municipal</strong>
                <p style="color: #F1F1F1; margin: 10px 0;">
                    ${municipio} é um município de porte ${size} com características ${type}s. 
                    ${getPerfilDescription(type, size)}
                </p>
            </div>
            
            <div style="background: #23263B; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                <strong style="color: #ffc107;">⚠️ Desafios Identificados</strong>
                <ul style="color: #F1F1F1; margin: 10px 0;">
                    ${challenges.map(challenge => `<li>${getChallengeDescription(challenge)}</li>`).join('')}
                    ${urgenciaVisitas ? '<li style="color: #dc3545; font-weight: bold;">DEADLINE CRÍTICO: Visitas P1+P2 até 19/09/2025</li>' : ''}
                    ${urgenciaQuestionarios ? '<li style="color: #ffc107; font-weight: bold;">PRAZO APERTADO: Questionários até 17/10/2025</li>' : ''}
                </ul>
            </div>
            
            <div style="background: #23263B; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
                <strong style="color: #28a745;">💡 Recomendações Estratégicas com Deadlines</strong>
                <p style="color: #F1F1F1; margin: 10px 0;">
                    ${urgenciaVisitas ? 
                        `<strong style="color: #dc3545;">URGÊNCIA MÁXIMA:</strong> Implementar estratégia imediatamente para ${municipio}. Usar múltiplos canais, contato intensivo, escalação rápida. ${getRecomendacoes(type, challenges)}` :
                        urgenciaQuestionarios ?
                        `<strong style="color: #ffc107;">ACELERAR PROCESSO:</strong> Intensificar abordagem para ${municipio} considerando deadline questionários. ${getRecomendacoes(type, challenges)}` :
                        getRecomendacoes(type, challenges)
                    }
                </p>
            </div>
        </div>
    `;
}

// Atualizar histórico de sucesso
function atualizarHistoricoSucesso(dados) {
    const type = dados.profile?.type || 'urbano';
    const successItems = getSuccessExamples(type);
    
    document.getElementById('success-history').innerHTML = successItems.map(item => `
        <div class="success-item">
            <div class="success-item-title">${item.title}</div>
            <div class="success-item-description">${item.description}</div>
        </div>
    `).join('');
}

// Implementar estratégia
function implementarEstrategia() {
    showToast('🚀 Implementando estratégia recomendada...', 'info');
    
    setTimeout(() => {
        showToast('Estratégia implementada! Acompanhe o progresso no painel.', 'success');
    }, 1500);
}

// Salvar estratégia
function salvarEstrategia() {
    const municipio = document.getElementById('analyzed-municipality').textContent;
    showToast(`💾 Estratégia para ${municipio} salva com sucesso!`, 'success');
}

// Analisar todos os municípios
function analisarTodosMunicipios() {
    showToast('🔍 Analisando estratégias para todos os municípios...', 'info');
    
    setTimeout(() => {
        showToast('Análise completa finalizada! 11 estratégias geradas.', 'success');
    }, 3000);
}

// Gerar relatório de estratégias
function gerarRelatorioEstrategias() {
    showToast('📋 Gerando relatório de estratégias IA...', 'info');
    
    setTimeout(() => {
        visualizarRelatorio('strategies');
        showToast('Relatório de estratégias gerado!', 'success');
    }, 2000);
}

// Configurar assistente
function configurarAssistente() {
    const panel = document.getElementById('config-panel');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

// Fechar configurações
function fecharConfiguracoes() {
    document.getElementById('config-panel').style.display = 'none';
}

// Funções auxiliares
function gerarEstrategiaGenerica(municipio) {
    return {
        profile: {
            size: 'medio',
            type: 'urbano',
            cooperation: 'media',
            priority: 'p2',
            challenges: ['recursos-limitados', 'burocracia']
        },
        strategies: {
            contact: {
                channel: 'oficial',
                timing: 'manha',
                approach: 'formal',
                confidence: Math.floor(Math.random() * 20 + 75)
            },
            approach: {
                style: 'institucional',
                focus: 'beneficios-municipio',
                tone: 'profissional',
                confidence: Math.floor(Math.random() * 20 + 75)
            }
        }
    };
}

function getPrioridadeDescricao(prioridade) {
    const prioridades = {
        'p1': 'Crítica',
        'p2': 'Importante',
        'p3': 'Opcional'
    };
    return prioridades[prioridade] || 'Importante';
}

function getRiscoNivel(cooperation) {
    const riscos = {
        'alta': 'Risco Baixo',
        'media': 'Risco Médio',
        'baixa': 'Risco Alto'
    };
    return riscos[cooperation] || 'Risco Médio';
}

function getChannelDescription(channel) {
    const channels = {
        'oficial': 'E-mail oficial + ligação telefônica',
        'multiplo': 'Múltiplos canais (e-mail, telefone, WhatsApp)',
        'direto': 'Contato direto presencial ou telefônico'
    };
    return channels[channel] || 'Contato oficial padrão';
}

function getTimingDescription(timing) {
    const timings = {
        'manha': 'Manhã (9h-11h) - maior disponibilidade',
        'tarde': 'Tarde (14h-16h) - após reuniões matinais',
        'flexivel': 'Horário flexível conforme disponibilidade'
    };
    return timings[timing] || 'Manhã (9h-11h)';
}

function getApproachDescription(approach) {
    const approaches = {
        'formal': 'Abordagem institucional formal',
        'flexivel': 'Adaptável ao contexto e resposta',
        'pessoal': 'Contato direto e personalizado'
    };
    return approaches[approach] || 'Abordagem profissional padrão';
}

function getStyleDescription(style) {
    const styles = {
        'institucional': 'Foco na representação oficial IBGE',
        'adaptativo': 'Flexível às características locais',
        'consultivo': 'Posicionamento de apoio técnico'
    };
    return styles[style] || 'Abordagem institucional';
}

function getFocusDescription(focus) {
    const focuses = {
        'beneficios-municipio': 'Benefícios diretos para o município',
        'gestao-turistica': 'Apoio à gestão do turismo',
        'apoio-tecnico': 'Suporte técnico e orientação'
    };
    return focuses[focus] || 'Benefícios para gestão municipal';
}

function getToneDescription(tone) {
    const tones = {
        'profissional': 'Tom formal e institucional',
        'colaborativo': 'Abordagem de parceria',
        'amigavel': 'Tom acessível e próximo'
    };
    return tones[tone] || 'Tom profissional';
}

function getPerfilDescription(type, size) {
    const descriptions = {
        'portuario': 'Economia baseada em atividades portuárias e logística.',
        'turistico': 'Forte vocação turística com sazonalidade.',
        'urbano': 'Características urbanas típicas.'
    };
    return descriptions[type] || 'Características urbanas padrão.';
}

function getChallengeDescription(challenge) {
    const challenges = {
        'burocracia': 'Processos burocráticos complexos',
        'multiplos-setores': 'Coordenação entre múltiplos setores',
        'sazonalidade': 'Variação sazonal de demanda',
        'alta-demanda': 'Alta demanda de serviços',
        'recursos-limitados': 'Limitações de recursos humanos/financeiros'
    };
    return challenges[challenge] || challenge;
}

function getRecomendacoes(type, challenges) {
    if (type === 'turistico') {
        return 'Enfatize como a pesquisa pode auxiliar no planejamento turístico e gestão sazonal dos resíduos.';
    } else if (type === 'portuario') {
        return 'Destaque a importância dos dados para gestão logística e impactos ambientais portuários.';
    }
    return 'Foque nos benefícios práticos para a gestão municipal e melhorias dos serviços públicos.';
}

function getSuccessExamples(type) {
    const examples = {
        'turistico': [
            {
                title: 'Município Turístico Similar - 95% Sucesso',
                description: 'Abordagem focada em gestão sazonal resultou em cooperação total'
            },
            {
                title: 'Estratégia de Timing Flexível',
                description: 'Adaptação aos períodos de baixa temporada aumentou disponibilidade'
            }
        ],
        'portuario': [
            {
                title: 'Porto Grande - 92% Sucesso',
                description: 'Ênfase em benefícios logísticos conquistou apoio das secretarias'
            },
            {
                title: 'Abordagem Multi-setorial',
                description: 'Coordenação entre porto e prefeitura facilitou processo'
            }
        ],
        'urbano': [
            {
                title: 'Município Médio - 88% Sucesso',
                description: 'Estratégia institucional padrão com bons resultados'
            },
            {
                title: 'Follow-up Estruturado',
                description: 'Persistência respeitosa superou resistências iniciais'
            }
        ]
    };
    
    return examples[type] || examples['urbano'];
}

// Auto-refresh a cada 5 minutos
setInterval(async () => {
    console.log('🔄 Atualizando dados automaticamente...');
    await carregarDadosProgresso();
    adicionarMarcadores();
}, 5 * 60 * 1000);

</script>

<!-- CSS para animações -->
<style>
@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}

@keyframes fadeIn {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.marker-custom {
    background: none !important;
    border: none !important;
}

/* Melhorias de responsividade */
@media (max-width: 768px) {
    .toast-notification {
        max-width: 90vw !important;
        right: 5px !important;
        top: 10px !important;
        font-size: 13px !important;
    }
    
    .dashboard-sidebar {
        width: 100vw !important;
        right: 0 !important;
        top: 0 !important;
        max-height: 100vh !important;
        border-radius: 0 !important;
    }
    
    .map-container {
        margin: 10px !important;
        border-radius: 8px !important;
    }
    
    #mapa-progresso {
        height: 400px !important;
    }
}

/* Estados de loading melhorados */
.loading {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    color: #495057 !important;
    font-style: italic;
}

.loading i {
    margin-right: 8px;
    animation: pulse 1.5s ease-in-out infinite;
}

/* Elementos destacados para debug */
.debug-highlight {
    border: 2px solid #ff0000 !important;
    background: rgba(255, 0, 0, 0.1) !important;
}

/* Estilos para alertas críticos */
.alert-badge {
    background: #28a745;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
}

.alert-badge.critical {
    background: #dc3545;
    animation: pulse 1s infinite;
}

.alert-badge.warning {
    background: #ffc107;
    color: #000;
}

.deadline-badge {
    background: #17a2b8;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
    margin-left: 5px;
}

.deadline-badge.critical {
    background: #dc3545;
    animation: pulse 1s infinite;
}

.deadline-badge.warning {
    background: #ffc107;
    color: #000;
}

.alert-card {
    background: #2D3142;
    border-radius: 12px;
    padding: 15px;
    border-left: 4px solid #5F5CFF;
    transition: all 0.3s ease;
}

.alert-card.critical {
    border-left-color: #dc3545;
    background: rgba(220, 53, 69, 0.1);
}

.alert-card.warning {
    border-left-color: #ffc107;
    background: rgba(255, 193, 7, 0.1);
}

.alert-card.info {
    border-left-color: #17a2b8;
    background: rgba(23, 162, 184, 0.1);
}

.alert-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 10px;
}

.btn-small {
    background: rgba(255, 255, 255, 0.1);
    border: none;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #F1F1F1;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-small:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: scale(1.1);
}
</style>

<script>
// =============================================================================
// SISTEMA DE ALERTAS CRÍTICOS PNSB 2024
// =============================================================================

let alertasCriticos = [];

async function atualizarAlertas() {
    try {
        showToast('Atualizando alertas críticos...', 'info');
        
        const response = await fetch('/api/alertas/criticos');
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        const resultado = await response.json();
        if (!resultado.success) {
            throw new Error(resultado.message || 'Erro ao carregar alertas');
        }
        
        alertasCriticos = resultado.data.alertas;
        const resumo = resultado.data.resumo;
        
        // Atualizar contador de alertas
        const alertCount = document.getElementById('alert-count');
        if (alertCount) {
            alertCount.textContent = resumo.total_alertas;
            alertCount.className = `alert-badge ${resumo.criticos > 0 ? 'critical' : resumo.urgentes > 0 ? 'warning' : 'normal'}`;
        }
        
        // Atualizar badge de deadline
        const diasVisitas = resumo.dias_ate_deadline_visitas;
        const diasQuestionarios = resumo.dias_ate_deadline_questionarios;
        const menorPrazo = Math.min(diasVisitas, diasQuestionarios);
        
        const deadlineBadge = document.getElementById('deadline-badge');
        if (deadlineBadge) {
            deadlineBadge.textContent = `${menorPrazo}d`;
            deadlineBadge.className = `deadline-badge ${menorPrazo < 7 ? 'critical' : menorPrazo < 14 ? 'warning' : 'normal'}`;
        }
        
        // Atualizar resumo de prazos
        const deadlineVisitas = document.getElementById('deadline-visitas');
        if (deadlineVisitas) {
            deadlineVisitas.innerHTML = `19/09/2025 <span style="color: ${diasVisitas < 7 ? '#dc3545' : diasVisitas < 14 ? '#ffc107' : '#28a745'}">(${diasVisitas} dias)</span>`;
        }
        
        const deadlineQuestionarios = document.getElementById('deadline-questionarios');
        if (deadlineQuestionarios) {
            deadlineQuestionarios.innerHTML = `17/10/2025 <span style="color: ${diasQuestionarios < 7 ? '#dc3545' : diasQuestionarios < 14 ? '#ffc107' : '#28a745'}">(${diasQuestionarios} dias)</span>`;
        }
        
        // Exibir alertas
        exibirAlertas();
        
        console.log('✅ Alertas atualizados:', resumo);
        showToast(`${resumo.total_alertas} alertas atualizados`, 'success');
        
    } catch (error) {
        console.error('❌ Erro ao atualizar alertas:', error);
        showToast('Erro ao atualizar alertas', 'error');
        
        // Fallback - mostrar indicação de erro
        const container = document.getElementById('alerts-container');
        if (container) {
            container.innerHTML = `
                <div class="alert-error" style="padding: 20px; text-align: center; color: #dc3545;">
                    <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                    <h4>Erro ao Carregar Alertas</h4>
                    <p>Não foi possível carregar os alertas críticos. Verifique a conexão.</p>
                    <button class="btn btn-outline-danger" onclick="atualizarAlertas()">
                        <i class="fas fa-retry"></i> Tentar Novamente
                    </button>
                </div>
            `;
        }
    }
}

function exibirAlertas() {
    const container = document.getElementById('alerts-container');
    if (!container) return;
    
    if (alertasCriticos.length === 0) {
        container.innerHTML = `
            <div class="no-alerts" style="padding: 30px; text-align: center; color: #28a745;">
                <i class="fas fa-check-circle fa-3x mb-3"></i>
                <h4>✅ Nenhum Alerta Crítico</h4>
                <p>Todos os prazos estão sob controle!</p>
            </div>
        `;
        return;
    }
    
    // Mostrar apenas os 3 mais críticos ou todos se solicitado
    const alertasParaExibir = (typeof window.alertasVisiveisCompletos !== 'undefined' && window.alertasVisiveisCompletos) ? alertasCriticos : alertasCriticos.slice(0, 3);
    
    let alertasHtml = alertasParaExibir.map(alerta => {
        const nivelClass = alerta.nivel === 'critico' ? 'critical' : 
                          alerta.nivel === 'urgente' ? 'warning' : 
                          alerta.nivel === 'atencao' ? 'info' : 'normal';
        
        const nivelIcon = alerta.nivel === 'critico' ? '🚨' : 
                         alerta.nivel === 'urgente' ? '⚠️' : 
                         alerta.nivel === 'atencao' ? '📊' : 'ℹ️';
        
        const nivelTexto = alerta.nivel === 'critico' ? 'CRÍTICO' : 
                          alerta.nivel === 'urgente' ? 'URGENTE' : 
                          alerta.nivel === 'atencao' ? 'ATENÇÃO' : 'NORMAL';
        
        return `
            <div class="alert-card ${nivelClass}" style="margin-bottom: 15px;">
                <div class="alert-header">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 20px;">${nivelIcon}</span>
                        <span class="alert-level" style="font-weight: bold; color: ${nivelClass === 'critical' ? '#dc3545' : nivelClass === 'warning' ? '#ffc107' : '#17a2b8'};">
                            ${nivelTexto}
                        </span>
                        ${alerta.dias_restantes > 0 ? `<span class="days-remaining" style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 12px; font-size: 12px;">${alerta.dias_restantes}d</span>` : ''}
                    </div>
                    <div class="alert-actions">
                        <button class="btn-small" onclick="marcarAlertaComoVisto('${alerta.id}')" title="Marcar como visto">
                            <i class="fas fa-check"></i>
                        </button>
                    </div>
                </div>
                <div class="alert-content">
                    <h4 style="margin: 0 0 8px 0; color: #F1F1F1;">${alerta.titulo}</h4>
                    <p style="margin: 0 0 12px 0; color: #B8BCC8; line-height: 1.4;">${alerta.descricao}</p>
                    ${alerta.acao_recomendada ? `
                        <div class="recommended-action" style="background: rgba(95, 92, 255, 0.1); padding: 10px; border-radius: 6px; border-left: 3px solid #5F5CFF;">
                            <strong style="color: #5F5CFF;">💡 Ação Recomendada:</strong><br>
                            <span style="color: #F1F1F1;">${alerta.acao_recomendada}</span>
                        </div>
                    ` : ''}
                    ${alerta.entidade ? `<div style="margin-top: 8px; font-size: 12px; color: #B0B3C7;">📍 ${alerta.municipio} - ${alerta.entidade}</div>` : alerta.municipio !== 'TODOS' && alerta.municipio !== 'GERAL' ? `<div style="margin-top: 8px; font-size: 12px; color: #B0B3C7;">📍 ${alerta.municipio}</div>` : ''}
                </div>
            </div>
        `;
    }).join('');
    
    // Adicionar botão para mostrar mais/menos
    if (alertasCriticos.length > 3) {
        alertasHtml += `
            <div class="show-more-alerts" style="text-align: center; padding: 15px;">
                <button class="btn-task btn-secondary" onclick="toggleAlertasCompletos()">
                    <i class="fas fa-${(typeof window.alertasVisiveisCompletos !== 'undefined' && window.alertasVisiveisCompletos) ? 'eye-slash' : 'eye'}"></i> 
                    ${(typeof window.alertasVisiveisCompletos !== 'undefined' && window.alertasVisiveisCompletos) ? 'Mostrar Menos' : `Mostrar Todos (${alertasCriticos.length})`}
                </button>
            </div>
        `;
    }
    
    container.innerHTML = alertasHtml;
}

function toggleAlertasCompletos() {
    if (typeof alertasVisiveisCompletos === 'undefined') {
        window.alertasVisiveisCompletos = false;
    }
    window.alertasVisiveisCompletos = !window.alertasVisiveisCompletos;
    exibirAlertas();
}

function marcarAlertaComoVisto(alertaId) {
    // Remover alerta da lista local (simula marcação como visto)
    alertasCriticos = alertasCriticos.filter(alerta => alerta.id !== alertaId);
    exibirAlertas();
    
    // Atualizar contador
    const alertCount = document.getElementById('alert-count');
    if (alertCount) {
        alertCount.textContent = alertasCriticos.length;
    }
    
    showToast('Alerta marcado como visto', 'success');
}

function toggleAlertas() {
    const container = document.getElementById('alerts-container');
    const btn = document.getElementById('btn-toggle-alerts');
    
    if (!container || !btn) return;
    
    if (container.style.display === 'none') {
        container.style.display = 'block';
        btn.innerHTML = '<i class="fas fa-eye-slash"></i> Ocultar';
    } else {
        container.style.display = 'none';
        btn.innerHTML = '<i class="fas fa-eye"></i> Mostrar';
    }
}

// Adicionar ao DOMContentLoaded existente
document.addEventListener('DOMContentLoaded', async function() {
    // Aguardar um pouco e então carregar alertas
    setTimeout(atualizarAlertas, 2000);
    
    // Atualizar alertas a cada 2 minutos
    setInterval(atualizarAlertas, 120000);
});
</script>

</body>
</html> 